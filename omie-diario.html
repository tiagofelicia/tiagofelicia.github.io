<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Preços OMIE Diário - Mercado de Eletricidade em Portugal | Tiago Felícia</title>
    <meta name="description" content="Consulte os preços diários e horários do mercado de eletricidade (OMIE) para Portugal. Selecione o dia e veja a média simples, bi-horária e tri-horária." />
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    
    <link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96" />
    <link rel="stylesheet" href="style.css" />
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J4NWP00S4F"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-J4NWP00S4F');
    </script>
    
    <style>
        /* ... (O seu CSS completo e validado permanece aqui) ... */
        .painel-header { text-align: center; margin-bottom: 20px; }
        .painel-header h2 { margin: 0; font-size: 1.5em; }
        .painel-header p { margin: 5px 0 0; font-size: 0.9em; color: #666; }
        .date-selector { margin-bottom: 20px; text-align: center; }
        .date-selector label { font-weight: bold; margin-right: 10px; }
        .date-selector input { padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; width: 95%; max-width: 1200px; margin: auto; }
        .coluna { display: flex; flex-direction: column; gap: 20px; }
        .card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-title-bd { background-color: #A9D08E; color: black; padding: 5px 10px; margin: -10px -10px 10px -10px; border-radius: 8px 8px 0 0; font-size: 1em; text-align: center; }
        .card-title-bs { background-color: #8EA9DB; color: black; padding: 5px 10px; margin: -10px -10px 10px -10px; border-radius: 8px 8px 0 0; font-size: 1em; text-align: center; }
        .card-title-td { background-color: #BF8F00; color: white; padding: 5px 10px; margin: -10px -10px 10px -10px; border-radius: 8px 8px 0 0; font-size: 1em; text-align: center; }
        .card-title-ts { background-color: #C65911; color: white; padding: 5px 10px; margin: -10px -10px 10px -10px; border-radius: 8px 8px 0 0; font-size: 1em; text-align: center; }
        .data-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #f0f0f0; }
        .data-item:last-child { border-bottom: none; }
        .label { font-weight: 600; }
        .valor { font-weight: bold; font-size: 0.95em; }
        .card-principal { text-align: center; border-style: solid; }
        .valor-principal { font-size: 1.8em; font-weight: bold; color: #333; }
        .futuros-info { font-size: 0.9em; margin-top: 8px; min-height: 1.2em; padding: 5px 0; border-top: 1px solid #f0f0f0; margin-top: 10px; } 
        .card-title-futuros { background-color: #495057; color: white; padding: 8px 10px; margin: -10px -10px 10px -10px; border-radius: 8px 8px 0 0; font-size: 1em; text-align: center; }
        .card-futuros ul { margin: 0; padding: 0; list-style: none; font-size: 0.95em; }
        .card-futuros ul li { display: flex; justify-content: space-between; padding: 3px 0; }
        .card-portugal { border-color: #007bff; border-width: 5px; }
        .card-title-media-pt { font-size: 1em; text-align: center; margin: -10px -10px 10px -10px; padding: 8px 10px; background-color: #007bff; color: white; border-radius: 2px 2px 0 0; }
        .card-espanha { border-color: #28a745; border-width: 5px; }
        .card-title-media-es { font-size: 1em; text-align: center; margin: -10px -10px 10px -10px; padding: 8px 10px; background-color: #28a745; color: white; border-radius: 2px 2px 0 0; }
        .label-vazio, .label-fora-vazio, .label-cheias, .label-ponta { padding: 3px 8px; border-radius: 12px; color: white; font-size: 0.95em; font-weight: 600; }
        .card:has(.card-title-bd) .label-vazio { background-color: #C6E0B4; color: #000000; }
        .card:has(.card-title-bd) .label-fora-vazio { background-color: #E2EFDA; color: #000000; }
        .card:has(.card-title-bs) .label-vazio { background-color: #B4C6E7; color: #000000; }
        .card:has(.card-title-bs) .label-fora-vazio { background-color: #D9E1F2; color: #000000; }
        .card:has(.card-title-td) .label-vazio { background-color: #FFD966; color: #000000; }
        .card:has(.card-title-td) .label-cheias { background-color: #FFE699; color: #000000; }
        .card:has(.card-title-td) .label-ponta { background-color: #FFF2CC; color: #000000; }
        .card:has(.card-title-ts) .label-vazio { background-color: #F4B084; color: #000000; }
        .card:has(.card-title-ts) .label-cheias { background-color: #F8CBAD; color: #000000; }
        .card:has(.card-title-ts) .label-ponta { background-color: #FCE4D6; color: #000000; }
        
        .grafico-tabela-grid {
            display: grid;
            grid-template-columns: 3fr 8fr; 
            gap: 20px;
            width: 95%;
            max-width: 1200px;
            margin: 40px auto 20px auto;
            align-items: flex-start;
        }
        @media (max-width: 900px) {
            .grafico-tabela-grid { grid-template-columns: 1fr; }
        }

        .tabela-wrapper { border: 1px solid #ddd; border-radius: 8px; background-color: white; overflow-x: auto; /* Garante scroll horizontal se necessário */ }
        .tabela-precos { width: 100%; border-collapse: collapse; font-size: 0.8em; /* table-layout: fixed; */ /* Removido para permitir ajuste natural das colunas */ }
        .tabela-precos th, .tabela-precos td { padding: 8px 12px; text-align: center; border-bottom: 1px solid #eee; white-space: nowrap; /* Evita quebra de linha no cabeçalho */ }
        .tabela-precos thead th { background-color: #343a40; color: white; position: sticky; top: 0; z-index: 1; }
        .tabela-precos thead tr:last-child th { top: 30px; /* Ajustar se a altura da primeira linha for diferente */ }
        .tabela-precos tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .tabela-precos th:nth-child(1), .tabela-precos td:nth-child(1) { width: 34%; }
        .tabela-precos th:nth-child(2), .tabela-precos td:nth-child(2) { width: 33%; }
        .tabela-precos th:nth-child(3), .tabela-precos td:nth-child(3) { width: 33%; }
        
    </style>
</head>
<body>
<header>
    <div class="header-content"> <div class="header-title-container"> <a href="index.html"> <img src="images/Logo_Tiago_Felicia.png" alt="Logótipo Tiago Felícia - Página Inicial" class="logo"> </a> <h1>Tiago Felícia</h1> </div> <p>Simuladores de tarifários de Eletricidade, Gás Natural e Autoconsumo</p> </div>
</header>

<div id="menu-placeholder"></div>

<main>
    <div class="painel-header" id="painel-header-main"> 
        <div class="date-selector"> <label for="seletor-data">Selecione o dia:</label> <input type="date" id="seletor-data"> </div>
        <h2>Preços médios OMIE para <span id="data-titulo-painel">--/--/----</span></h2> 
        <p>Valores OMIE corrigidos para a hora de Portugal</p>
    </div>

    <div class="dashboard-grid">
         <div class="coluna">
            <div class="card card-principal card-portugal"> <h3 class="card-title-media-pt">Portugal - Simples</h3> <div class="valor-principal" id="media-pt">--,-- €</div> <div class="futuros-info" id="futuros-container-pt"> Futuro do dia: <strong id="futuros-anterior-pt">--,-- €</strong> em <strong id="futuros-pt-data">--/--/----</strong> </div> <div class="data-item"><span class="label">Máximo quarto-horário PT</span><span class="valor" id="max-pt">--,-- €</span></div> <div class="data-item"><span class="label">Mínimo quarto-horário PT</span><span class="valor" id="min-pt">--,-- €</span></div> </div>
             <div class="card card-principal card-espanha"> <h3 class="card-title-media-es">Espanha <small>(às 24h de ES)</small></h3> <div class="valor-principal" id="media-es">--,-- €</div> <div class="futuros-info" id="futuros-container-es"> Futuro do dia: <strong id="futuros-anterior-es">--,-- €</strong> em <strong id="futuros-es-data">--/--/----</strong> </div> <div class="data-item"><span class="label">Máximo quarto-horário ES</span><span class="valor" id="max-es">--,-- €</span></div> <div class="data-item"><span class="label">Mínimo quarto-horário ES</span><span class="valor" id="min-es">--,-- €</span></div> </div>
             <div class="card card-futuros"> <h3 class="card-title-futuros">Futuros Diários OMIP (PT)</h3> <ul> <li id="futuro-1-item" style="display: none;"> <span id="futuros-1-label"></span> <strong id="futuros-1-valor"></strong> </li> <li id="futuro-2-item" style="display: none;"> <span id="futuros-2-label"></span> <strong id="futuros-2-valor"></strong> </li> <li id="futuro-3-item" style="display: none;"> <span id="futuros-3-label"></span> <strong id="futuros-3-valor"></strong> </li> </ul> </div>
        </div>
        <div class="coluna">
            <div class="card"> <h3 class="card-title-bd">Bi-horário Diário</h3> <div class="data-item"><span class="label label-vazio">Vazio</span><span class="valor" id="bh-diario-vazio">--,-- €</span></div> <div class="data-item"><span class="label label-fora-vazio">Fora Vazio</span><span class="valor" id="bh-diario-fora-vazio">--,-- €</span></div> </div>
             <div class="card"> <h3 class="card-title-bs">Bi-horário Semanal</h3> <div class="data-item"><span class="label label-vazio">Vazio</span><span class="valor" id="bh-semanal-vazio">--,-- €</span></div> <div class="data-item"><span class="label label-fora-vazio">Fora Vazio</span><span class="valor" id="bh-semanal-fora-vazio">--,-- €</span></div> </div>
             <div class="card"> <h3 class="card-title-td">Tri-horário Diário</h3> <div class="data-item"><span class="label label-vazio">Vazio</span><span class="valor" id="th-diario-vazio">--,-- €</span></div> <div class="data-item"><span class="label label-cheias">Cheias</span><span class="valor" id="th-diario-cheias">--,-- €</span></div> <div class="data-item"><span class="label label-ponta">Ponta</span><span class="valor" id="th-diario-ponta">--,-- €</span></div> </div>
             <div class="card"> <h3 class="card-title-ts">Tri-horário Semanal</h3> <div class="data-item"><span class="label label-vazio">Vazio</span><span class="valor" id="th-semanal-vazio">--,-- €</span></div> <div class="data-item"><span class="label label-cheias">Cheias</span><span class="valor" id="th-semanal-cheias">--,-- €</span></div> <div class="data-item"><span class="label label-ponta">Ponta</span><span class="valor" id="th-semanal-ponta">--,-- €</span></div> </div>
        </div>
    </div>
    
    <div class="link-section"> <p>https://www.tiagofelicia.pt/omie-diario.html</p> </div>

    <div class="grafico-tabela-grid">
        <div id="tabela-container" class="tabela-wrapper"></div>
        <div id="grafico-container"></div>
    </div>
    
    <article class="content-support">
        <h2>Compreender os Preços do OMIE</h2>
        <p>O OMIE (Operador do Mercado Ibérico de Energia) é a entidade que gere o mercado grossista de eletricidade para Portugal e Espanha. Os preços aqui apresentados são o resultado dos "leilões" diários onde produtores vendem e comercializadores compram a energia para o dia seguinte.</p>
        
        <details class="faq-item">
            <summary><strong>O que significam os diferentes ciclos horários?</strong></summary>
            <div class="faq-content">
                <p>Os preços são agregados em diferentes períodos para corresponderem aos tarifários de eletricidade:</p>
                <ul>
                    <li><strong>Simples:</strong> A média de todas as 24 horas do dia.</li>
                    <li><strong>Bi-Horário (Diário/Semanal):</strong> Divide o dia em Vazio e Fora de Vazio. O ciclo semanal tem mais horas de Vazio ao fim de semana.</li>
                    <li><strong>Tri-Horário (Diário/Semanal):</strong> Divide o dia em Ponta, Cheias e Vazio.</li>
                </ul>
            </div>
        </details>

        <details class="faq-item">
            <summary><strong>O que são os Futuros OMIP?</strong></summary>
            <div class="faq-content">
                <p>OMIP é o mercado onde se negoceiam os preços de eletricidade para o futuro (próximo dia, mês, trimestre, ano). Os valores apresentados representam a expectativa do mercado para os preços futuros.</p>
            </div>
        </details>
    </article>
</main>

<div id="footer-placeholder"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const csvUrl = "https://raw.githubusercontent.com/tiagofelicia/tiagofelicia.github.io/main/data/omie_diario.csv"; 
    const seletorData = document.getElementById('seletor-data');

    // Variáveis globais
    let dadosPrecos = [];
    let dadosAtualizacao = {};
    let dadosFuturosPT = [];
    let dadosFuturosES = [];

    // --- Funções Auxiliares (parseCSV, formatarData, formatarValor, etc.) ---
    function formatarDataParaInput(dataStr) { if (!dataStr || typeof dataStr !== 'string' || !dataStr.includes('/')) { return null; } const [dia, mes, ano] = dataStr.split('/'); if (!dia || !mes || !ano || dia.length !== 2 || mes.length !== 2 || ano.length !== 4) { return null; } return `${ano}-${mes}-${dia}`; }
    function formatarDataParaCSV(dataStr) { if (!dataStr || typeof dataStr !== 'string' || !dataStr.includes('-')) { return null; } const [ano, mes, dia] = dataStr.split('-'); if (!dia || !mes || !ano || dia.length !== 2 || mes.length !== 2 || ano.length !== 4) { return null; } return `${dia}/${mes}/${ano}`; }
    function getDataAnteriorCSV(dataStrYYYYMMDD) { try { const dataAtual = new Date(dataStrYYYYMMDD + "T12:00:00Z"); dataAtual.setDate(dataAtual.getDate() - 1); const dia = String(dataAtual.getDate()).padStart(2, '0'); const mes = String(dataAtual.getMonth() + 1).padStart(2, '0'); const ano = dataAtual.getFullYear(); return `${dia}/${mes}/${ano}`; } catch(e) { console.error("Erro ao calcular data anterior:", e); return null; } }
    
    function parseCSV(text) {
        const tabelas = text.split('\nTABELA_');
        const precosLines = tabelas[0].trim().split('\n');
        const precosHeaders = precosLines.shift().split(',').map(h => h.trim().replace(/^\uFEFF/, ''));
        const precos = precosLines.map(line => {
            const values = line.split(','); const row = {};
            precosHeaders.forEach((header, index) => {
                const value = (values.length > index && values[index]) ? values[index].trim() : '';
                if (header === 'preco_pt' || header === 'preco_es') { row[header] = (value && value !== "") ? parseFloat(value) : null; } 
                else { row[header] = value; }
            });
            try { const [dia, mes, ano] = row.dia.split('/'); const [hora, min] = row.hora.split(':'); let horaInt = parseInt(hora); let minInt = parseInt(min); if(horaInt === 23 && minInt === 59){ const [horaInicio] = row.intervalo.substring(1).split('-'); row.timestamp = new Date(`${ano}-${mes}-${dia}T${horaInicio}:00`); } else if (minInt === 0) { const tsTemp = new Date(`${ano}-${mes}-${dia}T${hora}:${min}:00`); tsTemp.setMinutes(tsTemp.getMinutes() - 1); row.timestamp = tsTemp; } else { row.timestamp = new Date(`${ano}-${mes}-${dia}T${hora}:${min}:00`); } } 
            catch(e) { row.timestamp = null; console.warn("Erro ao criar timestamp para linha:", row, e); }
            return row;
        });

        function parseTabelaSimples(raw, tipo) { /* ... (Função parse robusta anterior) ... */ 
             if (!raw) return tipo === 'obj' ? {} : []; const lines = raw.trim().split('\n'); lines.shift(); 
             if (lines.length < 1) return tipo === 'obj' ? {} : []; const headerLine = lines.shift();
             if (!headerLine) return tipo === 'obj' ? {} : []; const headers = headerLine.split(',').map(h => h.trim().replace(/^\uFEFF/, '')); 
             if (tipo === 'obj') {
                 const obj = {}; const keyHeaderIndex = headers.findIndex(h => h.toLowerCase() === 'chave');
                 const valueHeaderIndex = headers.findIndex(h => h.toLowerCase() === 'valor');
                 if (keyHeaderIndex === -1 || valueHeaderIndex === -1) { return {}; }
                 lines.forEach(line => {
                     const values = line.split(',');
                     if (values.length > Math.max(keyHeaderIndex, valueHeaderIndex)) {
                         const key = values[keyHeaderIndex] ? values[keyHeaderIndex].trim() : null;
                         const value = values[valueHeaderIndex] ? values[valueHeaderIndex].trim() : null;
                         if (key) { obj[key] = value; }
                     }
                 });
                 return obj;
             } else { 
                 const data = lines.map(line => {
                     const values = line.split(','); const row = {};
                     headers.forEach((header, index) => {
                         const value = (values.length > index && values[index]) ? values[index].trim() : ''; 
                         if (header.toLowerCase() === 'valor' && value !== "") { row[header] = parseFloat(value); } 
                         else { row[header] = value; }
                     });
                     return row;
                 });
                 return data;
             }
        }
        const atualizacoes = parseTabelaSimples(tabelas.find(t => t.startsWith("ATUALIZACOES")), 'obj');
        const futurosPT = parseTabelaSimples(tabelas.find(t => t.startsWith("FUTUROS_PT")), 'array');
        const futurosES = parseTabelaSimples(tabelas.find(t => t.startsWith("FUTUROS_ES")), 'array');
        return { precos, atualizacoes, futurosPT, futurosES };
    }

    function formatarValor(valor, casasDecimais = 2) {
        if (valor === null || typeof valor === 'undefined' || isNaN(valor)) { return '--,-- €'; }
        const textoFormatado = valor.toFixed(casasDecimais).replace('.', ',') + ' €';
        return valor < 0 ? `<span style="color: red;">${textoFormatado}</span>` : textoFormatado;
    }

    function calcularMedia(arr) {
        if (!Array.isArray(arr)) return null; // Adiciona verificação
        const numerosValidos = arr.filter(v => v !== null && !isNaN(v));
        return numerosValidos.length > 0 ? numerosValidos.reduce((a, b) => a + b, 0) / numerosValidos.length : null;
    }

    // --- Função Principal ---
    function atualizarDashboard(dataSelecionada) { 
        const dataFormatadaCSV = formatarDataParaCSV(dataSelecionada); 
        if (!dataFormatadaCSV) { return; }
        
        const dataOMIE = dadosAtualizacao.Data_Valores_OMIE;
        const dataOMIP = dadosAtualizacao.Data_Valores_OMIP;
        const isUltimoDiaOMIE = (dataFormatadaCSV === dataOMIE);

        // --- PONTO 1: Atualizar Título Principal ---
        const tituloH2 = document.querySelector("#painel-header-main h2");
        if (tituloH2) { tituloH2.innerHTML = `Preços médios OMIE para <span id="data-titulo-painel">${dataFormatadaCSV}</span> ${isUltimoDiaOMIE ? '(até às 23h de PT)' : ''}`; }

        const dadosDoDia = dadosPrecos.filter(d => d.dia === dataFormatadaCSV);
        if (dadosDoDia.length === 0) { return; };

        let dadosReaisDoDia;
        if (isUltimoDiaOMIE && dadosDoDia.length > 4) { dadosReaisDoDia = dadosDoDia.slice(0, -4); } 
        else { dadosReaisDoDia = dadosDoDia; }
       
        const precosReaisPT = dadosReaisDoDia.map(d => d.preco_pt).filter(p => p !== null);
        document.getElementById('media-pt').innerHTML = formatarValor(calcularMedia(precosReaisPT));
        document.getElementById('max-pt').innerHTML = formatarValor(precosReaisPT.length > 0 ? Math.max(...precosReaisPT) : null);
        document.getElementById('min-pt').innerHTML = formatarValor(precosReaisPT.length > 0 ? Math.min(...precosReaisPT) : null);

        // --- Cálculos Espanha (inclui última hora dia anterior) ---
        const dataAnteriorCSV = getDataAnteriorCSV(dataSelecionada);
        let precosESCompletos = dadosDoDia.map(d => d.preco_es).filter(p => p !== null); 
        if (dataAnteriorCSV) {
             const dadosDiaAnterior = dadosPrecos.filter(d => d.dia === dataAnteriorCSV);
             const ultimos4ESAnterior = dadosDiaAnterior.slice(-4).map(d => d.preco_es).filter(p => p !== null);
             precosESCompletos = ultimos4ESAnterior.concat(precosESCompletos);
        }
        document.getElementById('media-es').innerHTML = formatarValor(calcularMedia(precosESCompletos));
        document.getElementById('max-es').innerHTML = formatarValor(precosESCompletos.length > 0 ? Math.max(...precosESCompletos) : null);
        document.getElementById('min-es').innerHTML = formatarValor(precosESCompletos.length > 0 ? Math.min(...precosESCompletos) : null);
        
        // --- Futuros do Dia (PT e ES) ---
        const containerFuturosPT = document.getElementById('futuros-container-pt');
        const futuroDiarioPT = dadosFuturosPT.find(f => f.Contrato && f.Contrato.includes(" D ") && f.Descricao === dataFormatadaCSV);
        if (futuroDiarioPT) { document.getElementById('futuros-anterior-pt').innerHTML = formatarValor(futuroDiarioPT.Valor); document.getElementById('futuros-pt-data').textContent = dataOMIP; containerFuturosPT.style.display = 'block'; } 
        else { containerFuturosPT.style.display = 'none'; }
        const containerFuturosES = document.getElementById('futuros-container-es');
        const futuroDiarioES = dadosFuturosES.find(f => f.Contrato && f.Contrato.includes(" D ") && f.Descricao === dataFormatadaCSV);
        if (futuroDiarioES) { document.getElementById('futuros-anterior-es').innerHTML = formatarValor(futuroDiarioES.Valor); document.getElementById('futuros-es-data').textContent = dataOMIP; containerFuturosES.style.display = 'block'; } 
        else { containerFuturosES.style.display = 'none'; }
        
        // --- Cálculos de Ciclos ---
        const ciclos = { bd: {}, bs: {}, td: {}, ts: {} };
        for (const ciclo in ciclos) {
            ciclos[ciclo] = dadosReaisDoDia.reduce((acc, row) => {
                const periodo = row[ciclo.toUpperCase()]; 
                if (!periodo) return acc; 
                if (!acc[periodo]) acc[periodo] = [];
                if(row.preco_pt !== null && !isNaN(row.preco_pt)) { acc[periodo].push(row.preco_pt); }
                return acc;
            }, {});
        }
        
        // --- PONTO 5: Apresentar Ciclos ---
        document.getElementById('bh-diario-vazio').innerHTML = formatarValor(calcularMedia(ciclos.bd?.['V'])); // Usar optional chaining ?.
        document.getElementById('bh-diario-fora-vazio').innerHTML = formatarValor(calcularMedia(ciclos.bd?.['F']));
        document.getElementById('bh-semanal-vazio').innerHTML = formatarValor(calcularMedia(ciclos.bs?.['V']));
        document.getElementById('bh-semanal-fora-vazio').innerHTML = formatarValor(calcularMedia(ciclos.bs?.['F']));
        document.getElementById('th-diario-vazio').innerHTML = formatarValor(calcularMedia(ciclos.td?.['V']));
        document.getElementById('th-diario-cheias').innerHTML = formatarValor(calcularMedia(ciclos.td?.['C']));
        document.getElementById('th-diario-ponta').innerHTML = formatarValor(calcularMedia(ciclos.td?.['P']));
        document.getElementById('th-semanal-vazio').innerHTML = formatarValor(calcularMedia(ciclos.ts?.['V']));
        document.getElementById('th-semanal-cheias').innerHTML = formatarValor(calcularMedia(ciclos.ts?.['C']));
        document.getElementById('th-semanal-ponta').innerHTML = formatarValor(calcularMedia(ciclos.ts?.['P']));
        
        atualizarTabela(dadosDoDia, dadosReaisDoDia); 
        atualizarGrafico(dadosDoDia, dadosReaisDoDia, dataFormatadaCSV, isUltimoDiaOMIE); 
    }
    
    // --- PONTO 2: Função para mostrar futuros diários seguintes com dia da semana ---
    function atualizarFuturosProximos() {
        if (!dadosFuturosPT || dadosFuturosPT.length === 0) { return; }
        const futurosDiariosPT = dadosFuturosPT.filter(f => f.Contrato && f.Contrato.includes(" D "))
            .sort((a, b) => { /* ... (lógica de ordenação anterior) ... */ 
                const descA = a.Descricao; const descB = b.Descricao;
                const isDescAValid = typeof descA === 'string' && descA.includes('/');
                const isDescBValid = typeof descB === 'string' && descB.includes('/');
                if (!isDescAValid && !isDescBValid) return 0; if (!isDescAValid) return 1; if (!isDescBValid) return -1;
                try { 
                     const dataA = formatarDataParaInput(descA); const dataB = formatarDataParaInput(descB);
                     if (!dataA && !dataB) return 0; if (!dataA) return 1; if (!dataB) return -1;
                     return dataA.localeCompare(dataB); 
                } catch (e) { console.error("Erro ao ordenar futuros:", e, a, b); return 0; }
            });
            
        let diasEncontrados = 0;
        const dataMaximaRealStr = seletorData.max; 

        for (const futuro of futurosDiariosPT) {
             if (!futuro.Descricao || typeof futuro.Descricao !== 'string' || !futuro.Descricao.includes('/')) continue;
            try {
                const dataFuturoStr = formatarDataParaInput(futuro.Descricao);
                if (!dataFuturoStr) continue; 

                if (dataFuturoStr > dataMaximaRealStr && diasEncontrados < 3) {
                    diasEncontrados++;
                    const labelEl = document.getElementById(`futuros-${diasEncontrados}-label`);
                    const valorEl = document.getElementById(`futuros-${diasEncontrados}-valor`);
                    const itemEl = document.getElementById(`futuro-${diasEncontrados}-item`);
                    if (labelEl && valorEl && itemEl) {
                        const dataObj = new Date(dataFuturoStr + "T12:00:00Z"); 
                        const diaSemana = dataObj.toLocaleDateString('pt-PT', { weekday: 'short', timeZone: 'UTC' }); 
                        labelEl.textContent = `Futuros para ${futuro.Descricao} - ${diaSemana}`; 
                        valorEl.innerHTML = formatarValor(futuro.Valor);
                        itemEl.style.display = 'flex';
                    }
                }
                if (diasEncontrados >= 3) break; 
            } catch(e) { console.error("Erro ao processar futuro em atualizarFuturosProximos:", e, futuro); continue; }
        }
        for (let i = diasEncontrados + 1; i <= 3; i++) { 
             const item = document.getElementById(`futuro-${i}-item`);
             if(item) item.style.display = 'none'; 
        }
    }

    // --- PONTO 2 (Tabela): Função Tabela Horária com cabeçalho corrigido ---
    function atualizarTabela(dadosDoDiaCompleto, dadosReaisDoDia) {
        const container = document.getElementById('tabela-container');
        let tableHTML = '<table class="tabela-precos">';
        // --- CABEÇALHO CORRIGIDO ---
        tableHTML += '<thead>';
        tableHTML += '<tr>';
        tableHTML += '<th rowspan="2">Hora PT</th>'; // rowspan para ocupar 2 linhas
        tableHTML += '<th colspan="2">Preço médio horário</th>'; // colspan para abranger PT e ES
        tableHTML += '</tr>';
        tableHTML += '<tr>';
        tableHTML += '<th>Preço PT</th>'; // Sem unidades
        tableHTML += '<th>Preço ES</th>'; // Sem unidades
        tableHTML += '</tr>';
        tableHTML += '</thead>';
        // --- FIM CABEÇALHO CORRIGIDO ---
        tableHTML += '<tbody>';
        const dadosHorarios = []; let qh_index_compl = 0;
        for (let h = 0; h < 24; h++) {
            let num_q_nesta_hora = 4;
            let horaFimStr = String(h + 1).padStart(2,'0'); if (horaFimStr === '24') horaFimStr = '00';
            const horaLabel = `[${String(h).padStart(2, '0')}:00-${horaFimStr}:00[`;
            if (dadosDoDiaCompleto.length === 100 && h === 1) num_q_nesta_hora = 8;
            if (dadosDoDiaCompleto.length === 92 && h === 1) { dadosHorarios.push({ hora: horaLabel, precoPT: null, precoES: null }); continue; }
            const quartosDaHoraCompleto = dadosDoDiaCompleto.slice(qh_index_compl, qh_index_compl + num_q_nesta_hora);
            const quartosDaHoraReal = [];
            for (let i = 0; i < num_q_nesta_hora; i++) { if (qh_index_compl + i < dadosReaisDoDia.length) { quartosDaHoraReal.push(dadosReaisDoDia[qh_index_compl + i]); } }
            if(quartosDaHoraCompleto.length > 0){
                 dadosHorarios.push({ hora: horaLabel, precoPT: calcularMedia(quartosDaHoraReal.map(d => d.preco_pt)), precoES: calcularMedia(quartosDaHoraCompleto.map(d => d.preco_es)) });
                 qh_index_compl += num_q_nesta_hora;
            } else if (dadosDoDiaCompleto.length >= 92) { dadosHorarios.push({ hora: horaLabel, precoPT: null, precoES: null }); }
        }
        dadosHorarios.forEach(item => { tableHTML += `<tr><td>${item.hora}</td><td>${formatarValor(item.precoPT)}</td><td>${formatarValor(item.precoES)}</td></tr>`; });
        tableHTML += '</tbody></table>'; container.innerHTML = tableHTML;
    }

    // --- Função Gráfico (com exportação) ---
    function atualizarGrafico(dadosDoDiaCompleto, dadosReaisDoDia, dataTitulo, isUltimoDiaOMIE) {
        let seriesDataPT = dadosDoDiaCompleto.map(d => d.preco_pt);
        const seriesDataES = dadosDoDiaCompleto.map(d => d.preco_es); 
        if (isUltimoDiaOMIE && dadosDoDiaCompleto.length > 4) {
            const numFuturos = dadosDoDiaCompleto.length - dadosReaisDoDia.length;
            if (numFuturos > 0) { for (let i = 0; i < numFuturos; i++) { seriesDataPT[dadosReaisDoDia.length + i] = null; } }
        }
        const precosPTGrafico = seriesDataPT.filter(p => p !== null && !isNaN(p)); 
        const precosESGrafico = seriesDataES.filter(p => p !== null && !isNaN(p));
        const minPT = precosPTGrafico.length > 0 ? Math.min(...precosPTGrafico) : null;
        const maxPT = precosPTGrafico.length > 0 ? Math.max(...precosPTGrafico) : null;
        const minES = precosESGrafico.length > 0 ? Math.min(...precosESGrafico) : null;
        const maxES = precosESGrafico.length > 0 ? Math.max(...precosESGrafico) : null;
        const plotLines = [];
        const formatLabelMinMax = (val) => formatarValor(val, 2); 
        if (minPT !== null || minES !== null) { 
             const minValPT = minPT ?? Infinity; const minValES = minES ?? Infinity;
             if (Math.abs(minValPT - minValES) < 0.01 && minPT !== null) { plotLines.push({ value: minValPT, color: 'green', width: 1.5, dashStyle: 'shortdash', zIndex: 4, label: { text: `Mínimo: ${formatLabelMinMax(minValPT)}`, align: 'right', style: { color: 'green', fontWeight: 'bold' } } }); } 
             else {
                 if (minPT !== null) plotLines.push({ value: minValPT, color: '#007bff', width: 1.5, dashStyle: 'shortdash', zIndex: 4, label: { text: `Mínimo PT: ${formatLabelMinMax(minValPT)}`, align: 'right', style: { color: '#007bff', fontWeight: 'bold' } } });
                 if (minES !== null) plotLines.push({ value: minValES, color: '#28a745', width: 1.5, dashStyle: 'shortdash', zIndex: 4, label: { text: `Mínimo ES: ${formatLabelMinMax(minValES)}`, align: 'right', y: 15, style: { color: '#28a745', fontWeight: 'bold' } } });
             }
        }
         if (maxPT !== null || maxES !== null) {
             const maxValPT = maxPT ?? -Infinity; const maxValES = maxES ?? -Infinity;
             if (Math.abs(maxValPT - maxValES) < 0.01 && maxPT !== null) { plotLines.push({ value: maxValPT, color: 'red', width: 1.5, dashStyle: 'shortdash', zIndex: 4, label: { text: `Máximo: ${formatLabelMinMax(maxValPT)}`, align: 'right', style: { color: 'red', fontWeight: 'bold' } } }); } 
             else {
                 if (maxPT !== null) plotLines.push({ value: maxValPT, color: '#007bff', width: 1.5, dashStyle: 'shortdash', zIndex: 4, label: { text: `Máximo PT: ${formatLabelMinMax(maxValPT)}`, align: 'right', style: { color: '#007bff', fontWeight: 'bold' } } });
                 if (maxES !== null) plotLines.push({ value: maxValES, color: '#28a745', width: 1.5, dashStyle: 'shortdash', zIndex: 4, label: { text: `Máximo ES: ${formatLabelMinMax(maxValES)}`, align: 'right', y: 15, style: { color: '#28a745', fontWeight: 'bold' } } });
             }
        }
        // --- PONTO 1: Título Condicional do Gráfico ---
        const tituloGrafico = `Valores quarto-horários de ${dataTitulo} ${isUltimoDiaOMIE ? '(até às 23h de PT)' : ''}`;

        // --- NOME DE FICHEIRO DINÂMICO ---
        // Cria um nome base usando a data, substituindo '/' por '-' para ser seguro
        const nomeFicheiroBase = `precos-omie-${dataTitulo.replace(/\//g, '-')}`; 
        // Exemplo: "precos-omie-21-10-2025"

        Highcharts.chart('grafico-container', {
            chart: { type: 'line', height: 770 },
            title: { text: tituloGrafico }, 
            xAxis: { 
                categories: dadosDoDiaCompleto.map(d => d.intervalo), 
                title: { text: 'Hora PT' }, crosshair: true, 
                labels: { rotation: -45, step: 4, align: 'right' } 
            },
            yAxis: { 
                title: { text: 'Preço (€/MWh)' }, 
                labels: { format: '{value:,.0f} €' }, 
                plotLines: plotLines 
            },
            tooltip: { shared: true, valueSuffix: ' €/MWh', valueDecimals: 2 },
            legend: { layout: 'horizontal', align: 'center', verticalAlign: 'bottom' },
             // --- Opções de exportação ---
            exporting: {
                filename: nomeFicheiroBase, // Define o nome base dinâmico
                enabled: true, // Garante que está ativo
                buttons: {
                    contextButton: {
                        menuItems: [
                            'viewFullscreen', 'printChart', 'separator', 
                            'downloadPNG', 'downloadJPEG', 'downloadPDF', 'downloadSVG', 'separator', 
                            'downloadCSV', 'downloadXLS', 
                            'viewData' // Habilita "View data table"
                        ]
                    }
                }
            },
            // --- FIM PONTO 3 ---
            series: [ 
                { name: 'Espanha', color: '#28a745', data: seriesDataES, connectNulls: false }, 
                { name: 'Portugal', color: '#007bff', data: seriesDataPT, connectNulls: false } 
            ]
        });
    }

    // --- Processo de Inicialização ---
    fetch(csvUrl)
        .then(response => { if (!response.ok) throw new Error(`Erro de rede: ${response.statusText}`); return response.text(); })
        .then(data => {
            const parsedData = parseCSV(data);
            dadosPrecos = parsedData.precos;
            dadosAtualizacao = parsedData.atualizacoes;
            dadosFuturosPT = parsedData.futurosPT;
            dadosFuturosES = parsedData.futurosES;

            if (!dadosAtualizacao.Data_Valores_OMIE) { throw new Error("Data_Valores_OMIE não encontrada."); }
            const dataMaximaValida = formatarDataParaInput(dadosAtualizacao.Data_Valores_OMIE);
            if (!dataMaximaValida) { throw new Error("Data_Valores_OMIE inválida."); }
            
            const todasDatasValidas = [...new Set(dadosPrecos.map(d => formatarDataParaInput(d.dia)))].filter(d => d !== null).sort();
            if (todasDatasValidas.length === 0) { throw new Error("Não foram encontradas datas válidas."); }
            
            seletorData.min = todasDatasValidas[0]; 
            seletorData.max = dataMaximaValida; 
            seletorData.value = dataMaximaValida; 

            seletorData.addEventListener('change', (e) => atualizarDashboard(e.target.value));
            
            atualizarDashboard(seletorData.value);
            atualizarFuturosProximos();
        })
        .catch(error => {
            console.error('Falha ao carregar ou processar os dados:', error, error.stack);
            document.querySelector('main').innerHTML = `<p style="color: red; text-align: center; font-size: 1.2em; padding: 20px;">Ocorreu um erro ao carregar os dados. Verifique se o ficheiro <strong>omie_diario.csv</strong> está acessível e verifique a consola para detalhes.</p>`;
        });
        
    // Carregar menu e footer
    fetch('menu.html').then(response => response.text()).then(data => { document.getElementById('menu-placeholder').innerHTML = data; }).catch(error => console.error('Erro ao carregar o menu:', error));
    fetch('footer.html').then(response => response.text()).then(data => { document.getElementById('footer-placeholder').innerHTML = data; }).catch(error => console.error('Erro ao carregar o footer:', error));
});
</script>
  
</body>
</html>