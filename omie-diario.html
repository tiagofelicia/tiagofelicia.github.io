<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pre√ßos OMIE Di√°rio - Mercado de Eletricidade em Portugal | Tiago Fel√≠cia</title>
    <meta name="description" content="Consulte os pre√ßos di√°rios e hor√°rios do mercado de eletricidade (OMIE) para Portugal. Selecione o dia e veja a m√©dia simples, bi-hor√°ria e tri-hor√°ria." />
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96" />
    <link rel="stylesheet" href="style.css" />

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J4NWP00S4F"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-J4NWP00S4F');
    </script>

    <style>
        .painel-header { text-align: center; margin-bottom: 20px; }
        .painel-header h2 { margin: 0; font-size: 1.5em; }
        .painel-header p { margin: 5px 0 0; font-size: 0.9em; color: #666; }
        .date-selector { margin-bottom: 20px; text-align: center; }
        .date-selector label { font-weight: bold; margin-right: 10px; }
        .date-selector input { padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; width: 95%; max-width: 1200px; margin: auto; }
        .coluna { display: flex; flex-direction: column; gap: 20px; }
        .card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-title-bd { background-color: #A9D08E; color: black; padding: 5px 10px; margin: -10px -10px 10px -10px; border-radius: 8px 8px 0 0; font-size: 1em; text-align: center; }
        .card-title-bs { background-color: #8EA9DB; color: black; padding: 5px 10px; margin: -10px -10px 10px -10px; border-radius: 8px 8px 0 0; font-size: 1em; text-align: center; }
        .card-title-td { background-color: #BF8F00; color: white; padding: 5px 10px; margin: -10px -10px 10px -10px; border-radius: 8px 8px 0 0; font-size: 1em; text-align: center; }
        .card-title-ts { background-color: #C65911; color: white; padding: 5px 10px; margin: -10px -10px 10px -10px; border-radius: 8px 8px 0 0; font-size: 1em; text-align: center; }
        .data-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #f0f0f0; }
        .data-item:last-child { border-bottom: none; }
        .label { font-weight: 600; }
        .valor { font-weight: bold; font-size: 0.95em; }
        .card-principal { text-align: center; border-style: solid; }
        .valor-principal { font-size: 1.8em; font-weight: bold; color: #333; }
        .futuros-info { font-size: 0.9em; margin-top: 8px; min-height: 1.2em; padding: 5px 0; border-top: 1px solid #f0f0f0; margin-top: 10px; }
        .card-title-futuros { background-color: #495057; color: white; padding: 8px 10px; margin: -10px -10px 10px -10px; border-radius: 8px 8px 0 0; font-size: 1em; text-align: center; }
        .card-futuros ul { margin: 0; padding: 0; list-style: none; font-size: 0.95em; }
        .card-futuros ul li { display: flex; justify-content: space-between; padding: 3px 0; }
        .card-portugal { border-color: #007bff; border-width: 5px; }
        .card-title-media-pt { font-size: 1em; text-align: center; margin: -10px -10px 10px -10px; padding: 8px 10px; background-color: #007bff; color: white; border-radius: 2px 2px 0 0; }
        .card-espanha { border-color: #28a745; border-width: 5px; }
        .card-title-media-es { font-size: 1em; text-align: center; margin: -10px -10px 10px -10px; padding: 8px 10px; background-color: #28a745; color: white; border-radius: 2px 2px 0 0; }
        .label-vazio, .label-fora-vazio, .label-cheias, .label-ponta { padding: 3px 8px; border-radius: 12px; color: white; font-size: 0.95em; font-weight: 600; }
        .card:has(.card-title-bd) .label-vazio { background-color: #C6E0B4; color: #000000; }
        .card:has(.card-title-bd) .label-fora-vazio { background-color: #E2EFDA; color: #000000; }
        .card:has(.card-title-bs) .label-vazio { background-color: #B4C6E7; color: #000000; }
        .card:has(.card-title-bs) .label-fora-vazio { background-color: #D9E1F2; color: #000000; }
        .card:has(.card-title-td) .label-vazio { background-color: #FFD966; color: #000000; }
        .card:has(.card-title-td) .label-cheias { background-color: #FFE699; color: #000000; }
        .card:has(.card-title-td) .label-ponta { background-color: #FFF2CC; color: #000000; }
        .card:has(.card-title-ts) .label-vazio { background-color: #F4B084; color: #000000; }
        .card:has(.card-title-ts) .label-cheias { background-color: #F8CBAD; color: #000000; }
        .card:has(.card-title-ts) .label-ponta { background-color: #FCE4D6; color: #000000; }

        .grafico-tabela-grid { display: grid; grid-template-columns: 3fr 8fr; gap: 20px; width: 95%; max-width: 1200px; margin: 40px auto 20px auto; align-items: flex-start; }
        @media (max-width: 900px) { .grafico-tabela-grid { grid-template-columns: 1fr; } }
        .tabela-wrapper { border: 1px solid #ddd; border-radius: 8px; background-color: white; overflow-x: auto; }
        .tabela-precos { width: 100%; border-collapse: collapse; font-size: 0.8em; }
        .tabela-precos th, .tabela-precos td { padding: 8px 12px; text-align: center; border-bottom: 1px solid #eee; white-space: nowrap; }
        .tabela-precos thead th { background-color: #343a40; color: white; position: sticky; top: 0; z-index: 1; }
        .tabela-precos thead tr:last-child th { top: 30px; }
        .tabela-precos tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .tabela-precos th:nth-child(1), .tabela-precos td:nth-child(1) { width: 34%; }
        .tabela-precos th:nth-child(2), .tabela-precos td:nth-child(2) { width: 33%; }
        .tabela-precos th:nth-child(3), .tabela-precos td:nth-child(3) { width: 33%; }
        .link-section { text-align: center; margin: 30px auto; }
        .link-section p { font-family: monospace; font-size: 0.9em; color: #555; background-color: #e9ecef; padding: 8px 12px; border-radius: 4px; display: inline-block; margin: 0; }
        .content-support { max-width: 1200px; margin: 40px auto; padding: 0 15px; }
         /* Estilo para Loading Indicator */
        #loading-indicator { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 15px 25px; border-radius: 8px; z-index: 1000; font-size: 1.1em; }
    </style>
</head>
<body>
<header>
    <div class="header-content"> <div class="header-title-container"> <a href="index.html"> <img src="images/Logo_Tiago_Felicia.png" alt="Log√≥tipo Tiago Fel√≠cia - P√°gina Inicial" class="logo"> </a> <h1>Tiago Fel√≠cia</h1> </div> <p>Simuladores de tarif√°rios de Eletricidade, G√°s Natural e Autoconsumo</p> </div>
</header>

<div id="menu-placeholder"></div>

<main>
    <div class="painel-header" id="painel-header-main">
        <div class="date-selector"> <label for="seletor-data">Selecione o dia:</label> <input type="date" id="seletor-data"> </div>
        <p style="font-size: 0.70em; color: #555; margin-top: 0; margin-bottom: 15px;">
            Dados dispon√≠veis desde 01/01/2010
        </p>
        <h2>Eletricidade - Pre√ßos m√©dios OMIE para <span id="data-titulo-painel">--/--/----</span></h2>
        <p>Valores OMIE (‚Ç¨/MWh) corrigidos para a hora de Portugal</p>
    </div>

    <div id="loading-indicator">A carregar dados hist√≥ricos...</div>

    <div class="dashboard-grid">
         <div class="coluna">
            <div class="card card-principal card-portugal"> <h3 class="card-title-media-pt">Portugal - Simples</h3> <div class="valor-principal" id="media-pt">--,-- ‚Ç¨</div> <div class="futuros-info" id="futuros-container-pt"> Futuro do dia: <strong id="futuros-anterior-pt">--,-- ‚Ç¨</strong> em <strong id="futuros-pt-data">--/--/----</strong> </div> <div class="data-item"><span class="label">M√°ximo quarto-hor√°rio PT</span><span class="valor" id="max-pt">--,-- ‚Ç¨</span></div> <div class="data-item"><span class="label">M√≠nimo quarto-hor√°rio PT</span><span class="valor" id="min-pt">--,-- ‚Ç¨</span></div> </div>
             <div class="card card-principal card-espanha"> <h3 class="card-title-media-es">Espanha <small>(√†s 24h de ES)</small></h3> <div class="valor-principal" id="media-es">--,-- ‚Ç¨</div> <div class="futuros-info" id="futuros-container-es"> Futuro do dia: <strong id="futuros-anterior-es">--,-- ‚Ç¨</strong> em <strong id="futuros-es-data">--/--/----</strong> </div> <div class="data-item"><span class="label">M√°ximo quarto-hor√°rio ES</span><span class="valor" id="max-es">--,-- ‚Ç¨</span></div> <div class="data-item"><span class="label">M√≠nimo quarto-hor√°rio ES</span><span class="valor" id="min-es">--,-- ‚Ç¨</span></div> </div>
             <div class="card card-futuros"> <h3 class="card-title-futuros">Futuros Di√°rios OMIP (PT)</h3> <ul> <li id="futuro-1-item" style="display: none;"> <span id="futuros-1-label"></span> <strong id="futuros-1-valor"></strong> </li> <li id="futuro-2-item" style="display: none;"> <span id="futuros-2-label"></span> <strong id="futuros-2-valor"></strong> </li> <li id="futuro-3-item" style="display: none;"> <span id="futuros-3-label"></span> <strong id="futuros-3-valor"></strong> </li> </ul> </div>
        </div>
        <div class="coluna">
            <div class="card"> <h3 class="card-title-bd">Bi-hor√°rio Di√°rio</h3> <div class="data-item"><span class="label label-vazio">Vazio</span><span class="valor" id="bh-diario-vazio">--,-- ‚Ç¨</span></div> <div class="data-item"><span class="label label-fora-vazio">Fora Vazio</span><span class="valor" id="bh-diario-fora-vazio">--,-- ‚Ç¨</span></div> </div>
             <div class="card"> <h3 class="card-title-bs">Bi-hor√°rio Semanal</h3> <div class="data-item"><span class="label label-vazio">Vazio</span><span class="valor" id="bh-semanal-vazio">--,-- ‚Ç¨</span></div> <div class="data-item"><span class="label label-fora-vazio">Fora Vazio</span><span class="valor" id="bh-semanal-fora-vazio">--,-- ‚Ç¨</span></div> </div>
             <div class="card"> <h3 class="card-title-td">Tri-hor√°rio Di√°rio</h3> <div class="data-item"><span class="label label-vazio">Vazio</span><span class="valor" id="th-diario-vazio">--,-- ‚Ç¨</span></div> <div class="data-item"><span class="label label-cheias">Cheias</span><span class="valor" id="th-diario-cheias">--,-- ‚Ç¨</span></div> <div class="data-item"><span class="label label-ponta">Ponta</span><span class="valor" id="th-diario-ponta">--,-- ‚Ç¨</span></div> </div>
             <div class="card"> <h3 class="card-title-ts">Tri-hor√°rio Semanal</h3> <div class="data-item"><span class="label label-vazio">Vazio</span><span class="valor" id="th-semanal-vazio">--,-- ‚Ç¨</span></div> <div class="data-item"><span class="label label-cheias">Cheias</span><span class="valor" id="th-semanal-cheias">--,-- ‚Ç¨</span></div> <div class="data-item"><span class="label label-ponta">Ponta</span><span class="valor" id="th-semanal-ponta">--,-- ‚Ç¨</span></div> </div>
        </div>
    </div>

    <div class="link-section"> <p>https://www.tiagofelicia.pt/omie-diario.html</p> </div>

    <div class="grafico-tabela-grid">
        <div id="tabela-container" class="tabela-wrapper"></div>
        <div id="grafico-container"></div>
    </div>

    <article class="content-support">
        <h2>Compreender os Pre√ßos do OMIE Di√°rio</h2>

            <details class="faq-item">
                <summary><strong>O que √© o OMIE e que pre√ßos s√£o mostrados aqui?</strong></summary>
                <div class="faq-content">
                    <p>O <strong>OMIE (Operador do Mercado Ib√©rico de Energia)</strong> gere o mercado grossista di√°rio e intradi√°rio de eletricidade para Portugal e Espanha (MIBEL). Os pre√ßos resultam de leil√µes onde a energia √© comprada e vendida para o dia seguinte.</p>
                    <p>Esta p√°gina mostra esses pre√ßos (‚Ç¨/MWh) para cada <strong>intervalo de 15 minutos (quarto-hor√°rio)</strong>, j√° corrigidos para a <strong>hora de Portugal Continental (PT)</strong>. Tamb√©m s√£o apresentados os pre√ßos originais para Espanha (ES) para compara√ß√£o.</p>
                </div>
            </details>

            <details class="faq-item">
                <summary><strong>O que significam as m√©dias Simples, Bi-Hor√°ria e Tri-Hor√°ria?</strong></summary>
                <div class="faq-content">
                    <p>S√£o m√©dias dos pre√ßos quarto-hor√°rios de Portugal (‚Ç¨/MWh) durante diferentes per√≠odos do dia selecionado, calculadas com base nos ciclos standard definidos pela ERSE:</p>
                    <ul>
                        <li><strong>Simples:</strong> M√©dia de todos os pre√ßos *reais* do OMIE no dia selecionado (ver nota abaixo sobre o √∫ltimo dia).</li>
                        <li><strong>Bi-Hor√°rio (Di√°rio/Semanal):</strong> M√©dia dos pre√ßos durante os per√≠odos de <strong>Vazio</strong> e <strong>Fora de Vazio</strong>.</li>
                        <li><strong>Tri-Hor√°rio (Di√°rio/Semanal):</strong> M√©dia dos pre√ßos durante os per√≠odos de <strong>Ponta</strong>, <strong>Cheias</strong> e <strong>Vazio</strong>.</li>
                    </ul>
                    <p>Pode consultar as horas dos per√≠odos em <a href="https://www.tiagofelicia.pt/periodos-horarios.html" target="_blank" rel="noopener noreferrer">https://www.tiagofelicia.pt/periodos-horarios.html</a></p>

                    <p><strong>Nota Importante:</strong> No dia mais recente apresentado, os c√°lculos de m√©dias, m√°ximo e m√≠nimo para Portugal <strong>excluem</strong> os √∫ltimos quartos de hora (normalmente ap√≥s as 23h PT), pois os mesmos ainda n√£o s√£o conhecidos.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Como √© calculada a m√©dia de Espanha?</strong></summary>
                <div class="faq-content">
                    <p>A m√©dia, m√°ximo e m√≠nimo para Espanha apresentados referem-se √†s <strong>24 horas do dia espanhol</strong>. Como o dia espanhol come√ßa e acaba uma hora mais cedo que o portugu√™s, o c√°lculo inclui:</p>
                    <ul>
                        <li>Os pre√ßos de Espanha da √∫ltima hora (23:00-24:00) na hora de Portugal do <strong>dia anterior</strong>.</li>
                        <li>Os pre√ßos de Espanha das 23 horas (00:00-23:00) na hora de Portugal do <strong>dia selecionado</strong>.</li>
                    </ul>
                </div>
            </details>

            <details class="faq-item">
                <summary><strong>O que s√£o os Futuros OMIP?</strong></summary>
                <div class="faq-content">
                    <p>OMIP √© o mercado onde se negoceiam os pre√ßos de eletricidade para o futuro (pr√≥ximo dia, m√™s, trimestre, ano). Os valores apresentados representam a expectativa do mercado para os pre√ßos futuros.</p>
                </div>
            </details>

            <details class="faq-item">
                <summary><strong>O que significa o "Futuro do dia"?</strong></summary>
                <div class="faq-content">
                    <p>O valor "Futuro do dia" apresentado nos cart√µes de Portugal e Espanha √© o pre√ßo do <strong>contrato futuro di√°rio negociado no OMIP</strong> para o dia espec√≠fico que est√° a visualizar. Este valor representa a expectativa que o mercado tinha (na data de atualiza√ß√£o OMIP indicada) sobre qual seria o pre√ßo m√©dio nesse dia.</p>
                    <p>√â especialmente √∫til para comparar a expectativa (futuro) com a realidade (m√©dia OMIE calculada), particularmente no dia mais recente.</p>
                </div>
            </details>

            <details class="faq-item">
                <summary><strong>Os "Futuros Di√°rios OMIP (PT)" s√£o diferentes?</strong></summary>
                <div class="faq-content">
                    <p>Sim. O cart√£o "Futuros Di√°rios OMIP (PT)" mostra os pre√ßos dos contratos futuros di√°rios para os <strong>pr√≥ximos dias</strong> (at√© um m√°ximo de 3), tal como negociados no OMIP. Servem para dar uma indica√ß√£o das expectativas do mercado para o futuro pr√≥ximo, para al√©m do dia selecionado.</p>
                </div>
            </details>

            <details class="faq-item">
                <summary><strong>Estes pre√ßos OMIE s√£o os que pago na fatura?</strong></summary>
                <div class="faq-content">
                    <p><strong>N√£o diretamente, a menos que tenha uma tarifa indexada ao OMIE.</strong></p>
                    <ul>
                        <li>Se tem uma <strong>tarifa indexada</strong> (ou din√¢mica), o pre√ßo que paga pela energia varia hora a hora (ou quarto de hora) e est√° diretamente ligado a estes valores do OMIE, acrescido de uma margem do comercializador e outras taxas.</li>
                        <li>Se tem uma <strong>tarifa fixa</strong>, o pre√ßo por kWh √© constante, definido pelo seu comercializador. No entanto, os pre√ßos do OMIE influenciam o custo de aquisi√ß√£o de energia para o comercializador e, indiretamente, os pre√ßos das tarifas fixas que ele oferece.</li>
                    </ul>
                    <p>Lembre-se que a sua fatura final inclui sempre outras componentes como tarifas de acesso √†s redes, taxas e impostos.</p>
                </div>
            </details>

            <details class="faq-item">
                <summary><strong>De onde v√™m os dados e qual o per√≠odo dispon√≠vel?</strong></summary>
                <div class="faq-content">
                    <p>Os dados s√£o processados atrav√©s da recolha autom√°tica de informa√ß√£o p√∫blica dos websites do <strong>OMIE</strong> (para os pre√ßos di√°rios "reais") e do <strong>OMIP</strong> (para os futuros).</p>
                    <p>Esta p√°gina inclui o hist√≥rico de dados desde <strong>01/01/2010.</strong></p>

                </div>
            </details>
    </article></main>

<div id="footer-placeholder"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- CONFIGURA√á√ïES ---
    const URL_BASE = "https://raw.githubusercontent.com/tiagofelicia/tiagofelicia.github.io/main/data/";
    const URL_DADOS_ATUAIS = URL_BASE + "omie_dados_atuais.csv";
    const URL_HISTORICO_BASE = URL_BASE + "omie_historico_";
    const ANO_INICIO_HISTORICO = 2010;
    // --- FIM CONFIGURA√á√ïES ---

    const seletorData = document.getElementById('seletor-data');
    const loadingIndicator = document.getElementById('loading-indicator');

    // --- ARMAZENAMENTO DE DADOS ---
    let dadosAtuais = [];
    let dadosHistoricos = {};
    let dadosAtualizacao = {};
    let dadosFuturosPT = [];
    let dadosFuturosES = [];
    let anoMinimoAtual = null;

    // --- FUN√á√ïES AUXILIARES ---
    function formatarDataParaInput(dataStr) { if (!dataStr || typeof dataStr !== 'string' || !dataStr.includes('/')) { return null; } const [dia, mes, ano] = dataStr.split('/'); if (!dia || !mes || !ano || dia.length !== 2 || mes.length !== 2 || ano.length !== 4) { return null; } return `${ano}-${mes}-${dia}`; }
    function formatarDataParaCSV(dataStr) { if (!dataStr || typeof dataStr !== 'string' || !dataStr.includes('-')) { return null; } const [ano, mes, dia] = dataStr.split('-'); if (!dia || !mes || !ano || dia.length !== 2 || mes.length !== 2 || ano.length !== 4) { return null; } return `${dia}/${mes}/${ano}`; }
    function getDataAnteriorCSV(dataStrYYYYMMDD) { try { const dataAtual = new Date(dataStrYYYYMMDD + "T12:00:00Z"); dataAtual.setUTCDate(dataAtual.getUTCDate() - 1); const dia = String(dataAtual.getUTCDate()).padStart(2, '0'); const mes = String(dataAtual.getUTCMonth() + 1).padStart(2, '0'); const ano = dataAtual.getUTCFullYear(); return `${dia}/${mes}/${ano}`; } catch(e) { console.error("Erro data anterior:", e); return null; } }
    /**
     * Verifica se uma data (no formato YYYY-MM-DD) pertence √† semana atual.
     * @param {string} dataStrYYYYMMDD - A data a verificar (ex: "2025-10-25").
     * @returns {boolean} - True se for da semana atual, false caso contr√°rio.
     */
    function isDataNaSemanaAtual(dataStrYYYYMMDD) {
        try {
            // Obter a data selecionada como objeto Date (local)
            // O <input type="date"> devolve o valor no fuso hor√°rio local
            const [ano, mes, dia] = dataStrYYYYMMDD.split('-').map(Number);
            // new Date(ano, mes - 1, dia) -> Ex: 25 Out 2025 00:00:00 (Local)
            const dataSelecionada = new Date(ano, mes - 1, dia); 

            const dataAtual = new Date(); // Data e hora de hoje (Local)

            // Normalizar ambas para o in√≠cio do dia para evitar problemas de hora
            dataSelecionada.setHours(0, 0, 0, 0);
            dataAtual.setHours(0, 0, 0, 0);

            // Encontrar o in√≠cio da semana (Segunda-feira) para a data selecionada
            const dataSelClone = new Date(dataSelecionada.getTime());
            const diaSemanaSel = dataSelClone.getDay(); // Domingo=0, Segunda=1...
            // Ajusta para a Segunda-feira dessa semana
            const diffSel = dataSelClone.getDate() - diaSemanaSel + (diaSemanaSel === 0 ? -6 : 1); 
            dataSelClone.setDate(diffSel);

            // Encontrar o in√≠cio da semana (Segunda-feira) para a data atual
            const dataAtualClone = new Date(dataAtual.getTime());
            const diaSemanaAtual = dataAtualClone.getDay();
            // Ajusta para a Segunda-feira desta semana
            const diffAtual = dataAtualClone.getDate() - diaSemanaAtual + (diaSemanaAtual === 0 ? -6 : 1);
            dataAtualClone.setDate(diffAtual);

            // Comparar os timestamps (ambos est√£o normalizados para 00:00:00 Local da respetiva Segunda-feira)
            return dataSelClone.getTime() === dataAtualClone.getTime();
        } catch (e) {
            console.error("Erro ao verificar a semana:", e);
            return false; // Ser conservador e esconder o card em caso de erro
        }
    }

    // Parser para CSV hist√≥rico (simples)
    function parseCSVSimples(text) {
        const lines = text.trim().split('\n'); if (lines[0].charCodeAt(0) === 0xFEFF) { lines[0] = lines[0].substring(1); }
        const headers = lines.shift().split(',').map(h => h.trim());
        const precos = lines.map(line => {
            const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || []; const row = {};
            headers.forEach((header, index) => { let value = (values.length > index && values[index]) ? values[index].trim() : ''; if (value.startsWith('"') && value.endsWith('"')) { value = value.substring(1, value.length - 1); } if (header === 'preco_pt' || header === 'preco_es') { row[header] = (value && value !== "") ? parseFloat(value) : null; } else { row[header] = value; } });
             try { const [dia, mes, ano] = row.dia.split('/'); const [horaInicioStr] = row.intervalo.substring(1).split('-'); const [horaInicio, minInicio] = horaInicioStr.split(':'); row.timestamp = Date.UTC(parseInt(ano), parseInt(mes)-1, parseInt(dia), parseInt(horaInicio), parseInt(minInicio)); row.localTimestamp = new Date(row.timestamp); } catch(e) { row.timestamp = null; row.localTimestamp = null; }
            return row;
        });
        return precos;
    }
    // Parser para CSV atual (com m√∫ltiplas tabelas)
    function parseCSVAtual(text) {
        const tabelas = text.split('\nTABELA_');
        const precos = parseCSVSimples(tabelas[0]);
        function parseTabelaSimples(raw, tipo) { if (!raw) return tipo === 'obj' ? {} : []; const lines = raw.trim().split('\n'); lines.shift(); if (lines.length < 1) return tipo === 'obj' ? {} : []; const headerLine = lines.shift(); if (!headerLine) return tipo === 'obj' ? {} : []; const headers = headerLine.split(',').map(h => h.trim().replace(/^\uFEFF/, '')); if (tipo === 'obj') { const obj = {}; const keyHeaderIndex = headers.findIndex(h => h.toLowerCase() === 'chave'); const valueHeaderIndex = headers.findIndex(h => h.toLowerCase() === 'valor'); if (keyHeaderIndex === -1 || valueHeaderIndex === -1) { return {}; } lines.forEach(line => { const values = line.split(','); if (values.length > Math.max(keyHeaderIndex, valueHeaderIndex)) { const key = values[keyHeaderIndex]?.trim(); const value = values[valueHeaderIndex]?.trim(); if (key) { obj[key] = value; } } }); return obj; } else { const data = lines.map(line => { const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || []; const row = {}; headers.forEach((header, index) => { let value = (values.length > index && values[index]) ? values[index].trim() : ''; if (value.startsWith('"') && value.endsWith('"')) { value = value.substring(1, value.length - 1); } if (header.toLowerCase() === 'valor' && value !== "") { row[header] = parseFloat(value); } else { row[header] = value; } }); if (row['Contrato']) { if (row['Contrato'].includes(' D ')) row.Tipo = 'Di√°rios'; else if (row['Contrato'].includes(' Wk')) row.Tipo = 'Semanais'; else if (row['Contrato'].includes(' M ')) row.Tipo = 'Mensais'; else if (row['Contrato'].includes(' Q')) row.Tipo = 'Trimestrais'; else if (row['Contrato'].includes(' YR-')) row.Tipo = 'Anuais'; else row.Tipo = 'Outros'; } else { row.Tipo = 'Inv√°lido'; } return row; }); return data; } }
        const atualizacoes = parseTabelaSimples(tabelas.find(t => t.startsWith("ATUALIZACOES")), 'obj');
        const futurosPT = parseTabelaSimples(tabelas.find(t => t.startsWith("FUTUROS_PT")), 'array');
        const futurosES = parseTabelaSimples(tabelas.find(t => t.startsWith("FUTUROS_ES")), 'array');
        return { precos, atualizacoes, futurosPT, futurosES };
    }

    function formatarValor(valor, casasDecimais = 2) { if (valor === null || typeof valor === 'undefined' || isNaN(valor)) { return '--,-- ‚Ç¨'; } const textoFormatado = valor.toFixed(casasDecimais).replace('.', ',') + ' ‚Ç¨'; return valor < 0 ? `<span style="color: red;">${textoFormatado}</span>` : textoFormatado; }
    function calcularMedia(arr) { if (!Array.isArray(arr)) return null; const nums = arr.filter(v => v !== null && !isNaN(v)); return nums.length > 0 ? nums.reduce((a, b) => a + b, 0) / nums.length : null; }

    // --- FUN√á√ÉO PARA CARREGAR DADOS HIST√ìRICOS ---
    async function carregarDadosHistoricos(ano) {
        if (dadosHistoricos[ano] && !(dadosHistoricos[ano] instanceof Promise)) { return dadosHistoricos[ano]; }
        if (dadosHistoricos[ano] instanceof Promise) { return await dadosHistoricos[ano]; }
        const url = `${URL_HISTORICO_BASE}${ano}.csv`; console.log(`A carregar ${ano}...`); loadingIndicator.style.display = 'block';
        dadosHistoricos[ano] = fetch(url).then(response => { if (!response.ok) throw new Error(`Erro ${response.status}`); return response.text(); }) .then(csvText => { const dados = parseCSVSimples(csvText); dadosHistoricos[ano] = dados; return dados; }) .catch(error => { console.error(`Falha ${ano}:`, error); dadosHistoricos[ano] = []; return []; }) .finally(() => { const aCarregar = Object.values(dadosHistoricos).some(v => v instanceof Promise); if (!aCarregar) loadingIndicator.style.display = 'none'; });
        return await dadosHistoricos[ano];
    }

    // --- FUN√á√ÉO PRINCIPAL ---
    async function atualizarDashboard(dataSelecionada) {
        const cardFuturos = document.querySelector('.card-futuros');
        if (cardFuturos) {
            if (isDataNaSemanaAtual(dataSelecionada)) {
                cardFuturos.style.display = 'block';
            } else {
                cardFuturos.style.display = 'none';
            }
        }
        const dataFormatadaCSV = formatarDataParaCSV(dataSelecionada);
        if (!dataFormatadaCSV) { return; }
        const anoSelecionado = parseInt(dataSelecionada.substring(0, 4));
        const dataAnteriorCSV = getDataAnteriorCSV(dataSelecionada);
        const anoAnterior = dataAnteriorCSV ? parseInt(dataAnteriorCSV.substring(6, 10)) : null;

        const anosACarregar = [];
        if (anoSelecionado >= ANO_INICIO_HISTORICO && anoSelecionado < anoMinimoAtual && !(dadosHistoricos[anoSelecionado] && !(dadosHistoricos[anoSelecionado] instanceof Promise))) { anosACarregar.push(anoSelecionado); }
        if (anoAnterior && anoAnterior >= ANO_INICIO_HISTORICO && anoAnterior < anoMinimoAtual && !(dadosHistoricos[anoAnterior] && !(dadosHistoricos[anoAnterior] instanceof Promise))) { anosACarregar.push(anoAnterior); }
        if (anosACarregar.length > 0) { const promises = anosACarregar.map(ano => carregarDadosHistoricos(ano)); await Promise.all(promises); }

        // --- Obter os dados relevantes ---
        let dadosDoDia = [];
        if (anoSelecionado >= anoMinimoAtual) { dadosDoDia = dadosAtuais.filter(d => d.dia === dataFormatadaCSV); }
        else if (dadosHistoricos[anoSelecionado]) { dadosDoDia = dadosHistoricos[anoSelecionado].filter(d => d.dia === dataFormatadaCSV); }
        // Validar se conseguimos carregar os dados hist√≥ricos
        if (dadosDoDia.length === 0 && anoSelecionado < anoMinimoAtual) {
            console.error(`Dados hist√≥ricos para ${anoSelecionado} n√£o dispon√≠veis`);
            document.querySelector('main').innerHTML = 
                `<p style="color: orange; text-align: center; padding: 20px;">
                üìÖ Dados hist√≥ricos para ${dataFormatadaCSV} n√£o dispon√≠veis.<br>
                Por favor, selecione outra data.</p>`;
            return;
        }
        let dadosDiaAnterior = [];
        if(dataAnteriorCSV) { if (anoAnterior >= anoMinimoAtual) { dadosDiaAnterior = dadosAtuais.filter(d => d.dia === dataAnteriorCSV); } else if (dadosHistoricos[anoAnterior]) { dadosDiaAnterior = dadosHistoricos[anoAnterior].filter(d => d.dia === dataAnteriorCSV); } }

        if (dadosDoDia.length === 0) { console.warn(`Nenhum dado encontrado para ${dataFormatadaCSV}.`); /* Limpar UI? */ return; };

        // Obter a data/hora atual em Lisboa (independentemente do fuso do utilizador)
        // Usamos "en-US" como 'locale' seguro para o parsing de 'new Date()'
        const agoraLisboa = new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Lisbon" }));
        
        // Formatar a data de "hoje" (em Lisboa) para YYYY-MM-DD
        const hojeEmLisboaYYYYMMDD = agoraLisboa.toISOString().split('T')[0];
        
        // Obter a hora e minuto atuais de Lisboa
        const horaAtualLisboa = agoraLisboa.getHours(); // (0-23)
        const minutoAtualLisboa = agoraLisboa.getMinutes(); // (0-59)
        
        // Verificar se o dia selecionado no calend√°rio √© o dia de "hoje" (em Lisboa)
        const isHoje = (dataSelecionada === hojeEmLisboaYYYYMMDD);

        // --- L√≥gica de c√°lculo ---
        const dataOMIE = dadosAtualizacao.Data_Valores_OMIE; const dataOMIP = dadosAtualizacao.Data_Valores_OMIP; const isUltimoDiaOMIE = (dataFormatadaCSV === dataOMIE); let dadosReaisDoDia; if (isUltimoDiaOMIE && anoSelecionado >= anoMinimoAtual && dadosDoDia.length > 4) { dadosReaisDoDia = dadosDoDia.slice(0, -4); } else { dadosReaisDoDia = dadosDoDia; }

        // Atualizar T√≠tulo Principal
        const tituloH2 = document.querySelector("#painel-header-main h2"); if (tituloH2) { tituloH2.innerHTML = `Eletricidade - Pre√ßos m√©dios OMIE para <span id="data-titulo-painel">${dataFormatadaCSV}</span> ${isUltimoDiaOMIE ? '(at√© √†s 23h de PT)' : ''}`; }

        // C√°lculos PT
        const precosReaisPT = dadosReaisDoDia.map(d => d.preco_pt).filter(p => p !== null); document.getElementById('media-pt').innerHTML = formatarValor(calcularMedia(precosReaisPT)); document.getElementById('max-pt').innerHTML = formatarValor(precosReaisPT.length > 0 ? Math.max(...precosReaisPT) : null); document.getElementById('min-pt').innerHTML = formatarValor(precosReaisPT.length > 0 ? Math.min(...precosReaisPT) : null);

        // --- C√°lculos Espanha (Regra 24h ES) ---
        let precosDiaEspanhol = []; const ultimos4ESAnterior = dadosDiaAnterior.slice(-4).map(d => d.preco_es).filter(p => p !== null); const numQuartosDiaPT = dadosDoDia.length; const primeirosESAtual = dadosDoDia.slice(0, numQuartosDiaPT - 4).map(d => d.preco_es).filter(p => p !== null); precosDiaEspanhol = ultimos4ESAnterior.concat(primeirosESAtual);
        document.getElementById('media-es').innerHTML = formatarValor(calcularMedia(precosDiaEspanhol)); document.getElementById('max-es').innerHTML = formatarValor(precosDiaEspanhol.length > 0 ? Math.max(...precosDiaEspanhol) : null); document.getElementById('min-es').innerHTML = formatarValor(precosDiaEspanhol.length > 0 ? Math.min(...precosDiaEspanhol) : null);

        // Futuros do Dia
        const containerFuturosPT = document.getElementById('futuros-container-pt'); const futuroDiarioPT = dadosFuturosPT.find(f => f.Contrato?.includes(" D ") && f.Descricao === dataFormatadaCSV); if (futuroDiarioPT) { document.getElementById('futuros-anterior-pt').innerHTML = formatarValor(futuroDiarioPT.Valor); document.getElementById('futuros-pt-data').textContent = dataOMIP; containerFuturosPT.style.display = 'block'; } else { containerFuturosPT.style.display = 'none'; }
        const containerFuturosES = document.getElementById('futuros-container-es'); const futuroDiarioES = dadosFuturosES.find(f => f.Contrato?.includes(" D ") && f.Descricao === dataFormatadaCSV); if (futuroDiarioES) { document.getElementById('futuros-anterior-es').innerHTML = formatarValor(futuroDiarioES.Valor); document.getElementById('futuros-es-data').textContent = dataOMIP; containerFuturosES.style.display = 'block'; } else { containerFuturosES.style.display = 'none'; }

        // C√°lculos Ciclos
        const ciclos = { bd: {}, bs: {}, td: {}, ts: {} }; for (const ciclo in ciclos) { ciclos[ciclo] = dadosReaisDoDia.reduce((acc, row) => { const periodo = row[ciclo.toUpperCase()]; if (!periodo) return acc; if (!acc[periodo]) acc[periodo] = []; if(row.preco_pt !== null && !isNaN(row.preco_pt)) { acc[periodo].push(row.preco_pt); } return acc; }, {}); } document.getElementById('bh-diario-vazio').innerHTML = formatarValor(calcularMedia(ciclos.bd?.['V'])); document.getElementById('bh-diario-fora-vazio').innerHTML = formatarValor(calcularMedia(ciclos.bd?.['F'])); document.getElementById('bh-semanal-vazio').innerHTML = formatarValor(calcularMedia(ciclos.bs?.['V'])); document.getElementById('bh-semanal-fora-vazio').innerHTML = formatarValor(calcularMedia(ciclos.bs?.['F'])); document.getElementById('th-diario-vazio').innerHTML = formatarValor(calcularMedia(ciclos.td?.['V'])); document.getElementById('th-diario-cheias').innerHTML = formatarValor(calcularMedia(ciclos.td?.['C'])); document.getElementById('th-diario-ponta').innerHTML = formatarValor(calcularMedia(ciclos.td?.['P'])); document.getElementById('th-semanal-vazio').innerHTML = formatarValor(calcularMedia(ciclos.ts?.['V'])); document.getElementById('th-semanal-cheias').innerHTML = formatarValor(calcularMedia(ciclos.ts?.['C'])); document.getElementById('th-semanal-ponta').innerHTML = formatarValor(calcularMedia(ciclos.ts?.['P']));

        // Atualizar Tabela e Gr√°fico
    atualizarTabela(dadosDoDia, dadosReaisDoDia, isHoje, horaAtualLisboa);
    atualizarGrafico(dadosDoDia, dadosReaisDoDia, dataFormatadaCSV, isUltimoDiaOMIE, isHoje, horaAtualLisboa, minutoAtualLisboa);
    }

    // --- FUN√á√ïES DE ATUALIZA√á√ÉO ---
    function atualizarFuturosProximos() {
        if (!dadosFuturosPT || dadosFuturosPT.length === 0) { return; }
        const futurosDiariosPT = dadosFuturosPT.filter(f => f.Contrato?.includes(" D "))
            .sort((a, b) => { const descA = a.Descricao; const descB = b.Descricao; const isAValid = typeof descA === 'string' && descA.includes('/'); const isBValid = typeof descB === 'string' && descB.includes('/'); if (!isAValid && !isBValid) return 0; if (!isAValid) return 1; if (!isBValid) return -1; try { const dA = formatarDataParaInput(descA); const dB = formatarDataParaInput(descB); if(!dA && !dB) return 0; if(!dA) return 1; if(!dB) return -1; return dA.localeCompare(dB); } catch(e){ return 0; } });
        let diasEnc = 0; const dataMaxReal = seletorData.max;
        for (const f of futurosDiariosPT) { if (!f.Descricao || typeof f.Descricao !== 'string' || !f.Descricao.includes('/')) continue; try { const dataF = formatarDataParaInput(f.Descricao); if (!dataF) continue; if (dataF > dataMaxReal && diasEnc < 3) { diasEnc++; const lbl = document.getElementById(`futuros-${diasEnc}-label`); const val = document.getElementById(`futuros-${diasEnc}-valor`); const itm = document.getElementById(`futuro-${diasEnc}-item`); if (lbl && val && itm) { const dO = new Date(dataF + "T12:00:00Z"); const dS = dO.toLocaleDateString('pt-PT', { weekday: 'short', timeZone: 'UTC' }); lbl.textContent = `Futuros para ${f.Descricao} - ${dS}`; val.innerHTML = formatarValor(f.Valor); itm.style.display = 'flex'; } } if (diasEnc >= 3) break; } catch(e){ console.error("Erro Futuros Pr√≥ximos:", e, f); continue; } }
        for (let i = diasEnc + 1; i <= 3; i++) { const itm = document.getElementById(`futuro-${i}-item`); if(itm) itm.style.display = 'none'; }
    }
    function atualizarTabela(dadosDoDiaCompleto, dadosReaisDoDia, isHoje, horaAtualLisboa) {
        const container = document.getElementById('tabela-container'); if (!container) return;
        let tableHTML = '<table class="tabela-precos">'; tableHTML += '<thead><tr><th rowspan="2">Hora PT</th><th colspan="2">Pre√ßo m√©dio hor√°rio</th></tr><tr><th>Pre√ßo PT</th><th>Pre√ßo ES</th></tr></thead>'; tableHTML += '<tbody>'; 
        
        const dadosHorarios = []; 
        let qh_idx = 0; 
        const numHoras = Math.ceil(dadosDoDiaCompleto.length / 4);

        for (let h = 0; h < numHoras; h++) { 
            let nq = 4; 
            let hFim = String(h + 1).padStart(2,'0'); 
            if (hFim === '24') hFim = '00'; 
            const hLbl = `[${String(h).padStart(2, '0')}:00-${hFim}:00[`; 
            if (dadosDoDiaCompleto.length === 100 && h === 1) nq = 8; 
            
            const qComp = dadosDoDiaCompleto.slice(qh_idx, qh_idx + nq); 
            const qReal = []; 
            for (let i = 0; i < nq; i++) { 
                if (dadosReaisDoDia && qh_idx + i < dadosReaisDoDia.length) { 
                    qReal.push(dadosReaisDoDia[qh_idx + i]); 
                } 
            } 
            
            if (dadosDoDiaCompleto.length === 92 && h === 1) { 
                dadosHorarios.push({ hora: hLbl, precoPT: null, precoES: null, isHoraAtual: false }); 
                continue; 
            } 
            
            // L√≥gica de Destaque: Verifica se √© hoje E se o 'h' do loop √© a hora atual
            const isHoraAtual = (isHoje && h === horaAtualLisboa);

            if(qComp.length > 0){ 
                dadosHorarios.push({ 
                    hora: hLbl, 
                    precoPT: calcularMedia(qReal.map(d => d.preco_pt)), 
                    precoES: calcularMedia(qComp.map(d => d.preco_es)),
                    isHoraAtual: isHoraAtual // Guarda a informa√ß√£o de destaque
                }); 
                qh_idx += nq; 
            } else if (h < 24) { 
                dadosHorarios.push({ hora: hLbl, precoPT: null, precoES: null, isHoraAtual: false }); 
            } 
        }

        // Criar o HTML da Tabela
        dadosHorarios.forEach(item => { 
            // Adiciona o estilo inline se 'isHoraAtual' for verdadeiro
            const estiloLinha = item.isHoraAtual ? ' style="background-color: #FFF3E0; font-weight: bold;"' : '';
            tableHTML += `<tr${estiloLinha}><td>${item.hora}</td><td>${formatarValor(item.precoPT)}</td><td>${formatarValor(item.precoES)}</td></tr>`; 
        }); 
        
        tableHTML += '</tbody></table>'; 
        container.innerHTML = tableHTML;
    }
    function atualizarGrafico(dadosDoDiaCompleto, dadosReaisDoDia, dataTitulo, isUltimoDiaOMIE, isHoje, horaAtualLisboa, minutoAtualLisboa) {
        const container = document.getElementById('grafico-container'); if (!container) return;
        
        let seriesDataPT = dadosDoDiaCompleto.map(d => d.preco_pt); const seriesDataES = dadosDoDiaCompleto.map(d => d.preco_es);
        if (isUltimoDiaOMIE && dadosDoDiaCompleto.length > 4) { const nf = dadosDoDiaCompleto.length - dadosReaisDoDia.length; if (nf > 0) { for (let i = 0; i < nf; i++) { seriesDataPT[dadosReaisDoDia.length + i] = null; } } }
        const precosPTGrafico = seriesDataPT.filter(p => p !== null && !isNaN(p)); const precosESGrafico = seriesDataES.filter(p => p !== null && !isNaN(p)); const minPT = precosPTGrafico.length > 0 ? Math.min(...precosPTGrafico) : null; const maxPT = precosPTGrafico.length > 0 ? Math.max(...precosPTGrafico) : null; const minES = precosESGrafico.length > 0 ? Math.min(...precosESGrafico) : null; const maxES = precosESGrafico.length > 0 ? Math.max(...precosESGrafico) : null;
        
        const plotLines = [];
        const formatLabelMinMax = (val) => formatarValor(val, 2);
        if (minPT !== null || minES !== null) { const minValPT = minPT ?? Infinity; const minValES = minES ?? Infinity; if (Math.abs(minValPT - minValES) < 0.01 && minPT !== null) { plotLines.push({ value: minValPT, color: 'green', width: 1.5, dashStyle: 'shortdash', zIndex: 4, label: { text: `M√≠nimo: ${formatLabelMinMax(minValPT)}`, align: 'right', style: { color: 'green', fontWeight: 'bold' } } }); } else { if (minPT !== null) plotLines.push({ value: minValPT, color: '#007bff', width: 1.5, dashStyle: 'shortdash', zIndex: 4, label: { text: `M√≠nimo PT: ${formatLabelMinMax(minValPT)}`, align: 'right', style: { color: '#007bff', fontWeight: 'bold' } } }); if (minES !== null) plotLines.push({ value: minValES, color: '#28a745', width: 1.5, dashStyle: 'shortdash', zIndex: 4, label: { text: `M√≠nimo ES: ${formatLabelMinMax(minValES)}`, align: 'right', y: 15, style: { color: '#28a745', fontWeight: 'bold' } } }); } }
        if (maxPT !== null || maxES !== null) { const maxValPT = maxPT ?? -Infinity; const maxValES = maxES ?? -Infinity; if (Math.abs(maxValPT - maxValES) < 0.01 && maxPT !== null) { plotLines.push({ value: maxValPT, color: 'red', width: 1.5, dashStyle: 'shortdash', zIndex: 4, label: { text: `M√°ximo: ${formatLabelMinMax(maxValPT)}`, align: 'right', style: { color: 'red', fontWeight: 'bold' } } }); } else { if (maxPT !== null) plotLines.push({ value: maxValPT, color: '#007bff', width: 1.5, dashStyle: 'shortdash', zIndex: 4, label: { text: `M√°ximo PT: ${formatLabelMinMax(maxValPT)}`, align: 'right', style: { color: '#007bff', fontWeight: 'bold' } } }); if (maxES !== null) plotLines.push({ value: maxValES, color: '#28a745', width: 1.5, dashStyle: 'shortdash', zIndex: 4, label: { text: `M√°ximo ES: ${formatLabelMinMax(maxValES)}`, align: 'right', y: 15, style: { color: '#28a745', fontWeight: 'bold' } } }); } }
        
        const tituloGrafico = `Valores quarto-hor√°rios de ${dataTitulo} ${isUltimoDiaOMIE ? '(at√© √†s 23h de PT)' : ''}`; 
        const nomeFicheiroBase = `precos-omie-${dataTitulo.replace(/\//g, '-')}`;

        let xAxisConfig = {
            categories: dadosDoDiaCompleto.map(d => d.intervalo),
            title: { text: 'Hora PT' },
            crosshair: true,
            labels: { rotation: -45, step: 4, align: 'right' },
            plotBands: [] 
        };

        if (isHoje) {
            const qhIndex = (horaAtualLisboa * 4) + Math.floor(minutoAtualLisboa / 15);
            if (qhIndex >= 0 && qhIndex < dadosDoDiaCompleto.length) {
                xAxisConfig.plotBands.push({
                    from: qhIndex - 0.5,
                    to: qhIndex + 0.5,
                    color: 'rgba(255, 165, 0, 0.3)', 
                    label: {
                        text: 'Agora',
                        style: { color: '#D98A00', fontWeight: 'bold' },
                        align: 'center',
                        verticalAlign: 'top',
                        y: 15
                    },
                    zIndex: 3
                });
            }
        }

        try { 
            const chart = Highcharts.chart('grafico-container', { 
                chart: { type: 'line', height: 770 }, 
                title: { text: tituloGrafico }, 
                xAxis: xAxisConfig, 
                yAxis: { 
                    title: { text: 'Pre√ßo (‚Ç¨/MWh)' }, 
                    labels: { format: '{value:,.0f} ‚Ç¨' }, 
                    plotLines: plotLines 
                }, 
                tooltip: { 
                    shared: true, 
                    valueSuffix: ' ‚Ç¨/MWh', 
                    valueDecimals: 2 
                }, 
                legend: { 
                    layout: 'horizontal', 
                    align: 'center', 
                    verticalAlign: 'bottom' 
                }, 
                exporting: { 
                    filename: nomeFicheiroBase, 
                    enabled: true, 
                    buttons: { 
                        contextButton: { 
                            menuItems: [ 
                                'viewFullscreen', 'printChart', 'separator', 
                                'downloadPNG', 'downloadJPEG', 'downloadPDF', 'downloadSVG', 'separator', 
                                'downloadCSV', 'downloadXLS', 'viewData' 
                            ] 
                        } 
                    } 
                }, 
                series: [ 
                    { name: 'Espanha', color: '#28a745', data: seriesDataES, connectNulls: false }, 
                    { name: 'Portugal', color: '#007bff', data: seriesDataPT, connectNulls: false } 
                ] 
            }); 
                        
            // L√≥gica para mostrar o tooltip no carregamento
            if (isHoje) {
                // 1. Calcular o √≠ndice do quarto-hora (0-95)
                const qhIndex = (horaAtualLisboa * 4) + Math.floor(minutoAtualLisboa / 15);

                // 2. Validar o √≠ndice
                if (qhIndex >= 0 && qhIndex < dadosDoDiaCompleto.length) {
                    
                    // 3. Obter os pontos das duas s√©ries nesse √≠ndice
                    // A s√©rie 'Espanha' √© a 0, 'Portugal' √© a 1
                    const pointES = chart.series[0].points[qhIndex];
                    const pointPT = chart.series[1].points[qhIndex];

                    // 4. Verificar se os pontos existem (n√£o s√£o 'null')
                    if (pointPT && pointES) {
                        
                        // 5. Desenhar o crosshair (linha vertical) e o tooltip
                        // Passamos 'null' como primeiro argumento (evento do rato)
                        chart.xAxis[0].drawCrosshair(null, pointPT); 
                        chart.tooltip.refresh([pointES, pointPT]);
                    }
                }
            }
        }
        catch (e) { console.error("Erro ao criar gr√°fico Highcharts:", e, e.stack); }
    }

    // --- PROCESSO DE INICIALIZA√á√ÉO ---
    console.log("A iniciar carregamento dos dados atuais...");
    fetch(URL_DADOS_ATUAIS)
        .then(response => { if (!response.ok) throw new Error(`Erro de rede: ${response.statusText}`); return response.text(); })
        .then(data => {
            console.log("Dados atuais recebidos. A processar...");
            const parsedData = parseCSVAtual(data);
            dadosAtuais = parsedData.precos; dadosAtualizacao = parsedData.atualizacoes; dadosFuturosPT = parsedData.futurosPT; dadosFuturosES = parsedData.futurosES;
            if (dadosAtuais.length === 0) throw new Error("Ficheiro atual vazio."); if (!dadosAtualizacao.Data_Valores_OMIE) { throw new Error("Data_Valores_OMIE n√£o encontrada."); }
            const anosAtuais = dadosAtuais.map(d => d.dia ? parseInt(d.dia.substring(6, 10)) : NaN).filter(ano => !isNaN(ano)); // Adicionado check d.dia
            if (anosAtuais.length > 0) { anoMinimoAtual = Math.min(...anosAtuais); } else { anoMinimoAtual = new Date().getFullYear(); console.warn("N√£o foi poss√≠vel det. ano min atual."); }
            console.log("Ano m√≠nimo atual:", anoMinimoAtual);
            const dataMaximaValida = formatarDataParaInput(dadosAtualizacao.Data_Valores_OMIE); if (!dataMaximaValida) { throw new Error("Data_Valores_OMIE inv√°lida."); }
            seletorData.min = `${ANO_INICIO_HISTORICO}-01-01`; seletorData.max = dataMaximaValida; seletorData.value = dataMaximaValida;
            seletorData.addEventListener('change', (e) => atualizarDashboard(e.target.value));
            atualizarDashboard(seletorData.value); // Chamar UMA VEZ
            atualizarFuturosProximos();
            console.log("P√°gina pronta.");
        })
        .catch(error => { console.error('Falha CR√çTICA:', error, error.stack); document.querySelector('main').innerHTML = `<p style="color: red; text-align: center; font-size: 1.2em; padding: 20px;">Ocorreu um erro cr√≠tico ao carregar os dados. Verifique a consola.</p>`; });

    // Carregar menu e footer
    fetch('menu.html').then(response => response.text()).then(data => { document.getElementById('menu-placeholder').innerHTML = data; }).catch(error => console.error('Erro menu:', error));
    fetch('footer.html').then(response => response.text()).then(data => { document.getElementById('footer-placeholder').innerHTML = data; }).catch(error => console.error('Erro footer:', error));
});
</script>

</body>
</html>