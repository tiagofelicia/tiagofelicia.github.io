<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Repartição da Produção e Preços OMIE | Tiago Felícia</title>
    <meta name="description" content="Repartição da Produção e preços do mercado de eletricidade (OMIE) para Portugal num dia selecionado." />    
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96" />
    <link rel="stylesheet" href="style.css" />

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J4NWP00S4F"></script>
    <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-J4NWP00S4F'); </script>


    <style>
        .grafico-wrapper {
            width: 95%;
            max-width: 1800px; 
            margin: 40px auto 20px auto;
        }

        /* Indicador de Loading*/
        #loading-indicator { 
            display: none; 
            text-align: center; 
            padding: 20px; 
            font-size: 1.2em;
        }

    </style>
</head>
<body>

<header>
</header>
<div id="menu-placeholder"></div>

<main>
    <div class="painel-header" id="painel-header-main">
        <div class="date-selector">
            <label for="seletor-data">Selecione o dia:</label>
            <input type="date" id="seletor-data">
        </div>
        <p style="font-size: 0.70em; color: #555; margin-top: 0; margin-bottom: 15px;">
            Dados históricos disponíveis desde 01/01/2010
        </p>
        <h2>Repartição da Produção vs. Preços OMIE para <span id="data-titulo-painel">--/--/----</span></h2>
        </div>

    <div id="loading-indicator">A carregar dados...</div>

    <div class="grafico-wrapper">
        <div id="grafico-container"></div>
    </div>

</main>

<div id="footer-placeholder"></div>


<script>
// Define o formato de números PT (sem separador de milhares)
Highcharts.setOptions({
    lang: {
        decimalPoint: ',',
        thousandsSep: ''
    }
});

document.addEventListener('DOMContentLoaded', function() {

    // --- 1. VERIFICAÇÃO DE ELEMENTOS HTML ---
    const seletorData = document.getElementById('seletor-data');
    const dataTituloPainel = document.getElementById('data-titulo-painel');
    const loadingIndicator = document.getElementById('loading-indicator');
    const graficoContainer = document.getElementById('grafico-container');

    if (!seletorData || !dataTituloPainel || !loadingIndicator || !graficoContainer) {
        console.error("ERRO CRÍTICO: Um ou mais IDs HTML necessários não foram encontrados.");
        return; 
    }
    // --- FIM DA VERIFICAÇÃO ---
    
    // --- 2. CONFIGURAÇÕES ---
    const ANO_INICIO_HISTORICO = 2010;
    const URL_BASE = "https://raw.githubusercontent.com/tiagofelicia/tiagofelicia.github.io/main/data/";
    const URL_OMIE_ATUAIS = URL_BASE + "omie_dados_atuais.csv";
    const URL_OMIE_HISTORICO_BASE = URL_BASE + "omie_historico_";
    const URL_PRODUCAO_ATUAIS = URL_BASE + "producao_dados_atuais.csv";
    const URL_PRODUCAO_HISTORICO_BASE = URL_BASE + "producao_historico_";
    
    // --- 3. ARMAZENAMENTO DE DADOS ---
    let dadosOmieAtuais = [];
    let dadosProducaoAtuais = [];
    let dadosOmieHistoricos = {};
    let dadosProducaoHistoricos = {};
    let anoMinimoAtual = null;

    // --- 4. FUNÇÕES AUXILIARES ---
    function formatarDataParaInput(dataStr) { if (!dataStr || typeof dataStr !== 'string' || !dataStr.includes('/')) { return null; } const [dia, mes, ano] = dataStr.split('/'); if (!dia || !mes || !ano || dia.length !== 2 || mes.length !== 2 || ano.length !== 4) { return null; } return `${ano}-${mes}-${dia}`; }
    function formatarDataParaCSV(dataStr) { if (!dataStr || typeof dataStr !== 'string' || !dataStr.includes('-')) { return null; } const [ano, mes, dia] = dataStr.split('-'); if (!dia || !mes || !ano || dia.length !== 2 || mes.length !== 2 || ano.length !== 4) { return null; } return `${dia}/${mes}/${ano}`; }
    function getLisboaDateString() { const agora = new Date(); return new Date(agora.toLocaleString("en-US", { timeZone: "Europe/Lisbon" })).toLocaleDateString('en-CA'); }
    
    function parseCSV(text) {
        if (text.charCodeAt(0) === 0xFEFF) { text = text.substring(1); }
        const lines = text.trim().split('\n');
        if (lines.length < 2) return [];
        const headers = lines.shift().split(',').map(h => h.trim());
        
        return lines
            .filter(line => line.trim() !== '')
            .map(line => {
                const values = line.split(',');
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] ? values[index].trim() : '';
                });
                return obj;
            });
    }

    // --- 5. CARREGAMENTO DE DADOS HISTÓRICOS ---
    async function carregarDadosCombinados(ano) {
        if (dadosOmieHistoricos[ano] && dadosProducaoHistoricos[ano]) {
            return; 
        }
        loadingIndicator.style.display = 'block';
        const urlOmie = `${URL_OMIE_HISTORICO_BASE}${ano}.csv`;
        const urlProducao = `${URL_PRODUCAO_HISTORICO_BASE}${ano}.csv`;

        try {
            const [respostaOmie, respostaProducao] = await Promise.all([
                fetch(urlOmie),
                fetch(urlProducao)
            ]);
            if (!respostaOmie.ok) throw new Error(`Falha ao carregar OMIE ${ano}`);
            if (!respostaProducao.ok) throw new Error(`Falha ao carregar Produção ${ano}`);
            const textoOmie = await respostaOmie.text();
            const textoProducao = await respostaProducao.text();
            dadosOmieHistoricos[ano] = parseCSV(textoOmie);
            dadosProducaoHistoricos[ano] = parseCSV(textoProducao);
        } catch (error) {
            console.error(`Falha ao carregar dados de ${ano}:`, error);
            dadosOmieHistoricos[ano] = [];
            dadosProducaoHistoricos[ano] = [];
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }

    // --- 6. FUNÇÃO PRINCIPAL (ATUALIZAR DASHBOARD) ---
    async function atualizarDashboard(dataSelecionada) {
        const dataFormatadaCSV = formatarDataParaCSV(dataSelecionada);
        if (!dataFormatadaCSV) return;

        dataTituloPainel.textContent = dataFormatadaCSV;
        loadingIndicator.style.display = 'block';

        const anoSelecionado = parseInt(dataSelecionada.substring(0, 4));

        let fonteDadosOmie, fonteDadosProducao;

        if (anoSelecionado >= anoMinimoAtual) {
            fonteDadosOmie = dadosOmieAtuais;
            fonteDadosProducao = dadosProducaoAtuais;
        } else {
            await carregarDadosCombinados(anoSelecionado);
            fonteDadosOmie = dadosOmieHistoricos[anoSelecionado];
            fonteDadosProducao = dadosProducaoHistoricos[anoSelecionado];
        }

        if (!fonteDadosOmie || !fonteDadosProducao || fonteDadosOmie.length === 0 || fonteDadosProducao.length === 0) {
            loadingIndicator.style.display = 'none';
            graficoContainer.innerHTML = `<p style="color:red; text-align:center;">Dados não disponíveis para ${dataFormatadaCSV}.</p>`;
            return;
        }

        const dadosOmieDoDia = fonteDadosOmie.filter(d => d.dia === dataFormatadaCSV);
        const dadosProducaoDoDia = fonteDadosProducao.filter(d => d.dia === dataFormatadaCSV);

        if (dadosOmieDoDia.length === 0 && dadosProducaoDoDia.length === 0) {
            loadingIndicator.style.display = 'none';
            graficoContainer.innerHTML = `<p style="color:orange; text-align:center;">Não existem dados de produção ou OMIE para ${dataFormatadaCSV}.</p>`;
            return;
        }

        const dadosConjugados = [];
        for (const prodReg of dadosProducaoDoDia) {
            const omieReg = dadosOmieDoDia.find(d => d.intervalo === prodReg.intervalo);
            if (omieReg) {
                dadosConjugados.push({ ...omieReg, ...prodReg });
            } else {
                dadosConjugados.push({ ...prodReg });
            }
        }
        if (dadosConjugados.length === 0 && dadosOmieDoDia.length > 0) {
            dadosOmieDoDia.forEach(reg => dadosConjugados.push(reg));
        }

        atualizarGrafico(dadosConjugados, dataFormatadaCSV);
        loadingIndicator.style.display = 'none';
    }


    // --- 7. O GRÁFICO (HIGHCHARTS) ---
    function atualizarGrafico(dadosConjugados, dataTitulo) {
        
        // Lógica de corte baseada na BIOMASSA
        let firstNullIndex = dadosConjugados.findIndex(d => (parseFloat(d.Biomassa) || 0) === 0);
        if (firstNullIndex === -1) {
            firstNullIndex = 96; // 96 significa dia completo (0-95 slots)
        }
        console.log(`Corte de dados no índice: ${firstNullIndex} (baseado na Biomassa)`);


        const paraNumeroComCorte = (val, index) => {
            if (index >= firstNullIndex) { return null; }
            const num = parseFloat(val);
            return isNaN(num) ? null : num;
        };
        
        const paraNumeroOMIE = (val, index) => { 
            if (index >= firstNullIndex) { return null; }
            const num = parseFloat(val); 
            return isNaN(num) ? null : num; 
        };

        const categoriasX = dadosConjugados.map(d => d.intervalo);

        const gasNaturalSerie = dadosConjugados.map((d, i) => {
            const cc = paraNumeroComCorte(d['Gás Natural - Ciclo Combinado'], i) || 0;
            const cog = paraNumeroComCorte(d['Gás natural - Cogeração'], i) || 0;
            if (i >= firstNullIndex && cc === 0 && cog === 0) { return null; }
            return cc + cog;
        });
        
        const precosOmieValidos = dadosConjugados
            .map((d, i) => paraNumeroOMIE(d.preco_pt, i))
            .filter(p => p !== null);

        const maxOmie = precosOmieValidos.length > 0 ? Math.max(...precosOmieValidos) : null;
        const minOmie = precosOmieValidos.length > 0 ? Math.min(...precosOmieValidos) : null;

        const plotLinesOMIE = [];
        const formatarPlotLine = (val) => Highcharts.numberFormat(val, 2, ',', '');
        
        if (maxOmie !== null) {
            plotLinesOMIE.push({
                value: maxOmie, color: 'red', width: 2, dashStyle: 'ShortDash', zIndex: 4,
                label: { text: 'Máx: ' + formatarPlotLine(maxOmie) + ' €', align: 'right', style: { color: 'red', fontWeight: 'bold' }, x: -5 }
            });
        }
        if (minOmie !== null) {
            plotLinesOMIE.push({
                value: minOmie, color: 'green', width: 2, dashStyle: 'ShortDash', zIndex: 4,
                label: { text: 'Mín: ' + formatarPlotLine(minOmie) + ' €', align: 'right', style: { color: 'green', fontWeight: 'bold' }, x: -5 }
            });
        }
        
        
        // ---  Calcular hhmm e formatar nome do ficheiro ---
        
        // 1. Calcular o 'hhmm' do limite
        let hhmmLimite;
        if (firstNullIndex >= 96) {
            hhmmLimite = '2400'; // Dia completo
        } else {
            const totalMinutos = firstNullIndex * 15;
            const horas = Math.floor(totalMinutos / 60);
            const minutos = totalMinutos % 60;
            
            // Formatar com padding (ex: 9 -> 09, 0 -> 00)
            const hh = String(horas).padStart(2, '0');
            const mm = String(minutos).padStart(2, '0');
            hhmmLimite = hh + mm;
        }

        // 2. Formatar a data (ex: "11/11/2025" -> "11112025")
        const dataFormatadaFicheiro = dataTitulo.replace(/\//g, '');
        
        // 3. Criar o nome final
        const nomeFicheiroBase = `Repartição Produção vs OMIE_${dataFormatadaFicheiro}_${hhmmLimite}`;
        // --- FIM ---


        try {
            Highcharts.chart('grafico-container', {
                
                chart: { type: 'area', zoomType: 'x', height: 800 },
                title: { text: `Repartição da Produção vs Preço OMIE para ${dataTitulo}` },
                subtitle: { text: 'Pode arrastar horizontalmente no gráfico para fazer zoom.' },
                xAxis: { categories: categoriasX, labels: { rotation: -45, step: 4, align: 'right' } },
                
                yAxis: [
                    { 
                        title: { text: 'Produção (MW)' }, 
                        labels: { format: '{value:.0f} MW' }, 
                        opposite: false 
                    }, 
                    { 
                        title: { text: 'Preço OMIE (€/MWh)' }, 
                        labels: { format: '{value:.0f} €' }, 
                        opposite: true,
                        plotLines: plotLinesOMIE
                    }
                ],
                
                tooltip: {
                    shared: true,
                    formatter: function () {
                        let s = '<b>' + this.points[0].key + '</b>';
                        
                        this.points.reverse().forEach((point) => {
                            s += '<br/>';
                            s += '<span style="color:' + point.series.color + '">\u25CF</span> ';
                            s += point.series.name + ': ';
                            
                            if (point.series.yAxis.index === 0) {
                                s += '<b>' + Highcharts.numberFormat(point.y, 0, ',', '') + ' MW</b>';
                            } else {
                                s += '<b>' + Highcharts.numberFormat(point.y, 2, ',', '') + ' €/MWh</b>';
                            }
                        });
                        return s;
                    }
                },

                // --- Nome do ficheiro ---
                exporting: {
                    filename: nomeFicheiroBase,
                    csv: {
                        columnHeaderFormatter: function(item, key) {
                            if (item) {
                                return item.name;
                            } else {
                                return 'Intervalo';
                            }
                        }
                    }
                },
                // --- FIM ---

                plotOptions: { 
                    area: { stacking: 'normal', lineColor: '#666666', lineWidth: 1, marker: { enabled: false }, connectNulls: false },
                    line: { connectNulls: false }
                },
                
                series: [
                    // (Ordem e cores)
                    { name: 'Solar', type: 'area', yAxis: 0, stack: 'producao', color: '#FFC000', data: dadosConjugados.map((d, i) => paraNumeroComCorte(d.Solar, i)) },
                    { name: 'Hídrica', type: 'area', yAxis: 0, stack: 'producao', color: '#9DC3E6', data: dadosConjugados.map((d, i) => paraNumeroComCorte(d.Hídrica, i)) },
                    { name: 'Importação', type: 'area', yAxis: 0, stack: 'producao', color: '#ED7D31', data: dadosConjugados.map((d, i) => paraNumeroComCorte(d.Importação, i)) },
                    { name: 'Eólica', type: 'area', yAxis: 0, stack: 'producao', color: '#C6E0B4', data: dadosConjugados.map((d, i) => paraNumeroComCorte(d.Eólica, i)) },
                    { name: 'Gás Natural', type: 'area', yAxis: 0, stack: 'producao', color: '#808080', data: gasNaturalSerie },
                    { name: 'Outra Térmica', type: 'area', yAxis: 0, stack: 'producao', color: '#C0C0C0', data: dadosConjugados.map((d, i) => paraNumeroComCorte(d['Outra Térmica'], i)) },
                    { name: 'Carvão', type: 'area', yAxis: 0, stack: 'producao', color: '#C00000', data: dadosConjugados.map((d, i) => paraNumeroComCorte(d.Carvão, i)) },
                    { name: 'Biomassa', type: 'area', yAxis: 0, stack: 'producao', color: '#70AD47', data: dadosConjugados.map((d, i) => paraNumeroComCorte(d.Biomassa, i)) },
                    { name: 'Ondas', type: 'area', yAxis: 0, stack: 'producao', color: '#00B0F0', data: dadosConjugados.map((d, i) => paraNumeroComCorte(d.Ondas, i)) },
                    { name: 'Injeção de Baterias', type: 'area', yAxis: 0, stack: 'producao', color: '#38578C', data: dadosConjugados.map((d, i) => paraNumeroComCorte(d['Injeção de Baterias'], i)) },
                    { 
                        name: 'Preço OMIE (PT)', 
                        type: 'line', yAxis: 1, 
                        color: '#FF0000',
                        lineWidth: 4, 
                        data: dadosConjugados.map((d, i) => paraNumeroOMIE(d.preco_pt, i)), 
                        zIndex: 5, marker: { enabled: false } 
                    }
                ]
            });
        } catch (e) {
            console.error("Erro ao criar gráfico Highcharts:", e);
        }
    }


    // --- 8. PROCESSO DE INICIALIZAÇÃO ---
    console.log("A iniciar carregamento dos dados atuais (OMIE e Produção)...");
    
    const dataDeHoje = getLisboaDateString();

    Promise.all([
        fetch(URL_OMIE_ATUAIS),
        fetch(URL_PRODUCAO_ATUAIS)
    ])
    .then(async ([respostaOmie, respostaProducao]) => {
        if (!respostaOmie.ok) throw new Error("Falha ao carregar OMIE atuais");
        if (!respostaProducao.ok) throw new Error("Falha ao carregar Produção atuais");

        const textoOmie = await respostaOmie.text();
        const textoProducao = await respostaProducao.text();

        const tabelasOmie = textoOmie.split('\nTABELA_');
        const precosOmieCSV = tabelasOmie[0];
        
        dadosOmieAtuais = parseCSV(precosOmieCSV);
        dadosProducaoAtuais = parseCSV(textoProducao);
        
        console.log("Dados atuais de OMIE e Produção carregados.");
        
        if (!dadosOmieAtuais || dadosOmieAtuais.length === 0) {
             throw new Error("Ficheiro OMIE atual está vazio ou é inválido após 'parse'.");
        }
        
        const anosNoFicheiroAtual = [...new Set(dadosOmieAtuais.map(d => d.dia ? d.dia.substring(6, 10) : null))];
        const anosAtuaisValidos = anosNoFicheiroAtual
            .filter(ano => ano && !isNaN(parseInt(ano)))
            .map(ano => parseInt(ano));

        if (anosAtuaisValidos.length === 0) {
            throw new Error("Não foi possível encontrar nenhum ano válido no ficheiro OMIE atual.");
        }
        
        anoMinimoAtual = Math.min(...anosAtuaisValidos);
        console.log("Ano mínimo detetado no ficheiro 'atuais':", anoMinimoAtual);

        
        const ultimoRegisto = dadosOmieAtuais[dadosOmieAtuais.length - 1];
        if (!ultimoRegisto || !ultimoRegisto.dia) {
             throw new Error("Último registo do OMIE é inválido ou não tem 'dia'.");
        }
        
        const dataMaxDoFicheiro = formatarDataParaInput(ultimoRegisto.dia);
        if (!dataMaxDoFicheiro) {
            console.error("Valor que falhou no 'formatarDataParaInput':", ultimoRegisto.dia);
            throw new Error("Data máxima inválida no ficheiro OMIE.");
        }

        seletorData.min = `${ANO_INICIO_HISTORICO}-01-01`;
        seletorData.max = dataDeHoje; 
        
        let dataParaSelecionar = dataDeHoje;
        if (dataDeHoje > dataMaxDoFicheiro) {
            dataParaSelecionar = dataMaxDoFicheiro;
        }
        
        seletorData.value = dataParaSelecionar;
        
        seletorData.addEventListener('change', (e) => atualizarDashboard(e.target.value));
        
        atualizarDashboard(dataParaSelecionar);

    })
    .catch(error => {
        console.error('Falha CRÍTICA na inicialização:', error);
        const mainElement = document.querySelector('main');
        if (mainElement) {
            mainElement.innerHTML = `<p style="color: red; text-align: center; font-size: 1.2em; padding: 20px;">Ocorreu um erro crítico ao carregar os dados. Verifique a consola.<br><small>${error.message}</small></p>`;
        }
    });

    // Carregar menu e footer
    fetch('menu.html').then(response => response.text()).then(data => { document.getElementById('menu-placeholder').innerHTML = data; }).catch(error => console.error('Erro ao carregar o menu:', error));
    fetch('footer.html').then(response => response.text()).then(data => { document.getElementById('footer-placeholder').innerHTML = data; }).catch(error => console.error('Erro ao carregar o footer:', error));
});
</script>

</body>
</html>

</body>
</html>