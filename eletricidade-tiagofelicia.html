<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Simulador de Tarifários Eletricidade 2026: Poupe na Fatura | Tiago Felícia</title>
    <meta name="description" content="Compare tarifários de eletricidade em Portugal para 2026. Use o simulador gratuito, com ou sem ficheiro da E-Redes, e descubra quanto pode poupar na sua fatura da luz." />
    <link rel="canonical" href="https://www.tiagofelicia.pt/eletricidade-tiagofelicia.html" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Simulador Eletricidade 2026: Qual o mais barato?" />
    <meta property="og:description" content="Pare de pagar demais. Compare tarifários fixos e indexados com o seu consumo real." />
    <meta property="og:url" content="https://www.tiagofelicia.pt/eletricidade-tiagofelicia.html" />
    <meta property="og:image" content="https://www.tiagofelicia.pt/images/social-share.jpg" />
    <meta property="og:locale" content="pt_PT" />

    <link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg" />
    <link rel="shortcut icon" href="/images/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" />
    <link rel="manifest" href="/images/site.webmanifest" />

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css" />

    <!-- Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J4NWP00S4F"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-J4NWP00S4F');
    </script>
    
    <style>
        :root { 
            --primary: #0066cc; --bg: #f8fafc; --surface: #ffffff; 
            --text-main: #0f172a; --text-light: #64748b; --border: #e2e8f0;
            --success: #16a34a; --warning: #d97706; --danger: #dc2626;
        }
        /* Site integration: content padding */
        #loader { margin: 0 20px; }
        .tabs-container { margin-left: 20px; margin-right: 20px; }
        .grid-container { padding: 0 20px; }
        #eredes-upload-central { margin-left: 20px; margin-right: 20px; }
        #tab-quick { padding: 0 20px; }
        #tab-faq > div { margin-left: auto; margin-right: auto; padding-left: 20px; padding-right: 20px; }
        #menu-placeholder { margin-bottom: 0; }
        #footer-placeholder { margin-top: 40px; }
        
        * { box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 0; font-size: 0.92rem; line-height: 1.5; }
        .hidden { display: none !important; }
        
        .grid-container { display: grid; grid-template-columns: 360px 1fr; gap: 20px; max-width: 1900px; margin: 0 auto; align-items: start; }
        @media (max-width: 1200px) { .grid-container { grid-template-columns: 1fr; } }

        .sidebar { background: var(--surface); padding: 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto; z-index: 10; }
        
        .section-title { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: var(--text-light); margin: 16px 0 8px 0; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); padding-bottom: 4px; cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center; }
        .section-title:hover { color: var(--primary); }
        .section-content { margin-bottom: 12px; }
        .section-content.collapsed { display: none; }

        /* === CORES POR SECÇÃO DA SIDEBAR (Paleta Suave/Terra) === */

        /* 1. Contrato - Azul Acinzentado */
        .section-title[onclick*="contrato"] { 
            background: #adc5d7 !important; 
            color: #1e3a8a !important;      /* Azul escuro profundo */
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="contrato"]:hover { 
            background: #8daec4 !important; /* Ligeiramente mais escuro */
            color: #172554 !important; 
        }
        #content-contrato { 
            background: #f0f4f8; 
            border-left: 4px solid #adc5d7; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* 2. Consumo - Pêssego */
        .section-title[onclick*="consumo"] { 
            background: #F6C9B0 !important; 
            color: #5f370e !important;      /* Castanho/Laranja escuro */
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="consumo"]:hover { 
            background: #eebb9e !important; /* Pêssego mais denso */
            color: #431407 !important; 
        }
        #content-consumo { 
            background: #fff8f5; 
            border-left: 4px solid #F6C9B0; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* 3. E-Redes - Laranja Pastel */
        .section-title[onclick*="eredes"] { 
            background: #fed7aa !important; 
            color: #7c2d12 !important;      /* Ferrugem */
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="eredes"]:hover { 
            background: #fdba74 !important; /* Laranja um pouco mais forte */
            color: #431407 !important; 
        }
        #content-eredes { 
            background: #fff7ed; 
            border-left: 4px solid #fed7aa; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* 4. Meu Tarifário - Vermelho Suave */
        .section-title[onclick*="meu"] { 
            background: #FF9F9F !important; 
            color: #7f1d1d !important;      /* Vermelho sangue escuro */
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="meu"]:hover { 
            background: #f87171 !important; /* Vermelho médio */
            color: #450a0a !important; 
        }
        #content-meu { 
            background: #fef2f2; 
            border-left: 4px solid #FF9F9F; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* 5. Personalizado - Verde Menta Suave */
        .section-title[onclick*="personalizado"] { 
            background: #A3D1C2 !important; 
            color: #134e4a !important;      /* Verde cerceta escuro */
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="personalizado"]:hover { 
            background: #84c2ae !important; /* Menta mais escura */
            color: #042f2e !important; 
        }
        #content-personalizado { 
            background: #f0fdf9; 
            border-left: 4px solid #A3D1C2; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* 6. Comparação - Azul Claro/Ciano */
        .section-title[onclick*="comparacao"] { 
            background: #8FBBD1 !important; 
            color: #164e63 !important;      /* Azul petróleo escuro */
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="comparacao"]:hover { 
            background: #6facc7 !important; 
            color: #083344 !important; 
        }
        #content-comparacao { 
            background: #ecfeff; 
            border-left: 4px solid #8FBBD1; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* 7. Benefícios Sociais - Verde Oliva/Dourado */
        .section-title[onclick*="beneficios"] { 
            background: #C6CBAD !important; 
            color: #3f422e !important;      /* Verde tropa escuro */
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="beneficios"]:hover { 
            background: #b1b88e !important; 
            color: #1a1c0d !important; 
        }
        #content-beneficios { 
            background: #f7fee7; 
            border-left: 4px solid #C6CBAD; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* 8. Opções - Bege  */
        .section-title[onclick*="opcoes"] { 
            background: #EADCB8 !important; 
            color: #5f4e24 !important;      /* Castanho dourado escuro */
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="opcoes"]:hover { 
            background: #dec690 !important; 
            color: #3a2d0d !important; 
        }
        #content-opcoes { 
            background: #fffbeb; 
            border-left: 4px solid #EADCB8; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* 9. Datas - Violeta/Rosa Velho */
        .section-title[onclick*="datas"] { 
            background: #C9ABAB !important; 
            color: #4a2c2c !important;      /* Cor de vinho/terra */
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="datas"]:hover { 
            background: #b89292 !important; 
            color: #2b1212 !important; 
        }
        #content-datas { 
            background: #fdf2f2; 
            border-left: 4px solid #C9ABAB; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        .input-group { margin-bottom: 10px; }
        label { display: block; font-weight: 500; margin-bottom: 4px; font-size: 0.85rem; }
        .label-units { font-family: 'Roboto Mono', monospace; font-weight: 400; color: var(--text-light); font-size: 0.8em; }
        
        input[type="number"], input[type="date"], select {
            width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px;
            font-size: 0.9rem; transition: 0.2s; background: #fff; font-family: 'Roboto Mono', monospace;
        }
        input:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(0,102,204,0.1); }
        
        .omie-box { background: #fff7ed; border: 1px solid #fed7aa; padding: 10px; border-radius: 6px; margin-bottom: 12px; }
        .omie-editable { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
        .omie-input { padding: 4px 6px; font-size: 0.8rem; font-family: 'Roboto Mono', monospace; }
        
        .custom-tariff { background: #f0f9ff; border: 1px solid #bae6fd; padding: 10px; border-radius: 8px; margin-top: 10px; }
        
        .main-content { min-width: 0; }
        
        .filters-bar { 
            background: var(--surface); padding: 12px 16px; border-radius: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px;
            display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end;
        }
        .filter-item { flex: 1; min-width: 130px; }
        .checkbox-group { display: flex; gap: 12px; margin-top: 4px; flex-wrap: wrap; }
        .checkbox-label { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; cursor: pointer; user-select: none; font-weight: 400; }
        .checkbox-label input { accent-color: var(--primary); width: 16px; height: 16px; }

        .table-wrap { background: var(--surface); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow-x: auto; border: 1px solid var(--border); }
        table { 
            width: 100%; 
            border-collapse: separate;
            border-spacing: 2px 2px; /* Espaçamento horizontal (2px) e vertical (2px) entre células */
            table-layout: fixed;
            min-width: 800px; 
        }
        
        th { 
            background: #f8fafc; padding: 10px 12px; text-align: center; font-weight: 600; font-size: 0.85rem;
            color: var(--text-light); border-bottom: 1px solid var(--border);
            cursor: pointer; white-space: nowrap; user-select: none; position: sticky; top: 0; z-index: 10;
            position: relative; 
        }
        td:first-child {
            text-align: left;
        }
        th:hover { background: #f1f5f9; color: var(--primary); }
        
        /* Cores do cabeçalho por tipo de ciclo */
        th.ciclo-simples { background: #A6A6A6; color: #000; }
        th.ciclo-bi-diario { background: #A9D08E; color: #000; }
        th.ciclo-bi-semanal { background: #8EA9DB; color: #000; }
        th.ciclo-tri-diario { background: #BF8F00; color: #fff; }
        th.ciclo-tri-semanal { background: #C65911; color: #fff; }
        
        th.ciclo-simples:hover, 
        th.ciclo-bi-diario:hover, 
        th.ciclo-bi-semanal:hover { background: #8c8c8c; }
        th.ciclo-tri-diario:hover,
        th.ciclo-tri-semanal:hover { background: #a07600; }
        
        /* Larguras mínimas uniformizadas */
        th:nth-child(2), td:nth-child(2) { min-width: 110px; } /* Total */
        th:nth-child(3), td:nth-child(3) { min-width: 140px; } /* Primeira energia */
        th:nth-child(4), td:nth-child(4) { min-width: 140px; } /* Segunda energia/Potência */
        th:nth-child(5), td:nth-child(5) { min-width: 140px; } /* Terceira energia/Potência */
        th:nth-child(6), td:nth-child(6) { min-width: 140px; } /* Quarta energia/Potência */
        th:last-child, td:last-child { width: 85px; min-width: 85px; max-width: 85px; text-align: center; } /* Detalhes */
        
        .resizer {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 5px;
            background: rgba(0,0,0,0.05);
            cursor: col-resize;
            user-select: none;
        }
        
        .resizer:hover {
            background: var(--primary);
        }
        
        td { padding: 8px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; font-size: 0.88rem; }
        tr:hover { background: #f8fafc; }
        
        /* Largura inicial da coluna Tarifário */
        th:first-child, td:first-child { 
            width: 28%; 
        }
        
        /* Molduras coloridas para células de tarifário */
        .cell-qh-diagrama { border: 2px solid #BDD7EE !important; background-color: #f0f7ff; border-radius: 10px; }
        .cell-qh-perfil   { border: 2px solid #4D79BC !important; background-color: #dce8f5; border-radius: 10px; } /* Azul ainda mais escuro para contraste */
        .cell-index-media { border: 2px solid #FFE699 !important; background-color: #fffdf5; border-radius: 10px; }
        .cell-fixo        { border: 2px solid #d0d0d0 !important; background-color: #ffffff; border-radius: 10px; } /* Branco puro */
        .cell-meu-tarif   { border: 2px solid #FF0000 !important; background-color: #fff5f5; border-radius: 10px; }
        .cell-perso       { border: 2px solid #92D050 !important; background-color: #f9fff2; border-radius: 10px; }
        
        .price-main { font-family: 'Roboto Mono', monospace; font-weight: 700; color: var(--success); font-size: 0.95rem; cursor: help; text-align: center; vertical-align: middle; }
        .price-sub { font-family: 'Roboto Mono', monospace; color: var(--text-light); font-size: 0.82rem; cursor: help; text-align: center; vertical-align: middle; }
        .tariff-name { cursor: help; color: var(--primary); font-weight: 600; }
        
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; display: inline-block; margin-right: 4px; letter-spacing: 0.05em; }
        .tag.qh-diagrama { background: #BDD7EE; color: #000; }
        .tag.qh-perfil   { background: #4D79BC; color: #fff; }
        .tag.index-media { background: #FFE699; color: #000; }
        .tag.fixo        { background: #d0d0d0; color: #000; }
        .tag.meu-tarif   { background: #FF0000; color: #fff; }
        .tag.perso       { background: #92D050; color: #fff; }
        
        .tooltip { 
            position: absolute; background: #1e293b; color: white; padding: 12px; border-radius: 8px; 
            font-size: 0.8rem; z-index: 1000; box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            max-width: 380px; pointer-events: none; line-height: 1.4;
        }
        .tooltip-line { display: flex; justify-content: space-between; margin: 3px 0; gap: 16px; }
        .tooltip-line.subtotal { border-top: 1px solid rgba(255,255,255,0.2); margin-top: 6px; padding-top: 6px; font-weight: 600; }
        .tooltip-line.total { border-top: 2px solid rgba(255,255,255,0.4); margin-top: 8px; padding-top: 8px; font-weight: 700; font-size: 0.9rem; }
        .tooltip-section { margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.15); }

        /* === DROPDOWN EXPORTAÇÃO === */
        .export-wrapper { position: relative; display: inline-block; }
        .export-dropdown {
            display: none; position: absolute; right: 0; top: 100%; margin-top: 4px;
            background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 100; min-width: 180px;
            overflow: hidden;
        }
        .export-dropdown.open { display: block; }
        .export-dropdown button {
            display: flex; align-items: center; gap: 8px; width: 100%; padding: 10px 14px;
            border: none; background: none; cursor: pointer; font-size: 0.82rem;
            color: var(--text-main); text-align: left; transition: background 0.15s;
        }
        .export-dropdown button:hover { background: #f0fdf4; }
        .export-dropdown button i { color: #16a34a; width: 16px; text-align: center; }
        .export-dropdown .sep { height: 1px; background: var(--border); margin: 2px 0; }

        /* === BOTÃO CENÁRIOS NA SIDEBAR === */
        .btn-cenarios {
            background: none; border: 1px solid var(--border); border-radius: 6px;
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-light); font-size: 0.85rem; transition: all 0.2s;
            margin-left: auto;
        }
        .btn-cenarios:hover { background: var(--primary); color: white; border-color: var(--primary); }

        /* === MODAL GUARDAR SIMULAÇÃO === */
        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            z-index: 2000; align-items: center; justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .modal-box {
            background: var(--surface); border-radius: 12px; padding: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 420px; width: 90%;
            max-height: 80vh; overflow-y: auto;
        }
        .modal-box h3 { margin: 0 0 16px 0; font-size: 1.1rem; color: var(--text-main); }
        .modal-box .saved-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px;
            margin-bottom: 8px; transition: background 0.15s;
        }
        .modal-box .saved-item:hover { background: rgba(0,102,204,0.05); }
        .modal-box .saved-item .saved-info { flex: 1; cursor: pointer; }
        .modal-box .saved-item .saved-name { font-weight: 600; font-size: 0.9rem; color: var(--text-main); }
        .modal-box .saved-item .saved-meta { font-size: 0.75rem; color: var(--text-light); margin-top: 2px; }
        .modal-box .saved-item .saved-actions { display: flex; gap: 6px; }
        .modal-box .saved-item .saved-actions button {
            background: none; border: none; cursor: pointer; padding: 4px 6px;
            border-radius: 4px; font-size: 0.8rem; transition: all 0.15s;
        }
        .modal-box .saved-item .saved-actions .btn-load { color: var(--primary); }
        .modal-box .saved-item .saved-actions .btn-load:hover { background: rgba(0,102,204,0.1); }
        .modal-box .saved-item .saved-actions .btn-del { color: var(--danger); }
        .modal-box .saved-item .saved-actions .btn-del:hover { background: rgba(220,38,38,0.1); }
        .save-input-row {
            display: flex; gap: 8px; margin-bottom: 16px;
        }
        .save-input-row input[type="text"] {
            flex: 1; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px;
            font-size: 0.9rem; background: var(--bg); color: var(--text-main); font-family: 'Roboto', sans-serif;
        }
        .save-input-row .btn-save {
            padding: 8px 16px; border: none; background: var(--primary); color: white;
            border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.85rem; white-space: nowrap;
        }
        .save-input-row .btn-save:hover { opacity: 0.9; }
        .modal-close {
            display: block; width: 100%; margin-top: 12px; padding: 10px;
            border: 1px solid var(--border); background: none; border-radius: 8px;
            cursor: pointer; color: var(--text-light); font-size: 0.85rem;
        }
        .modal-close:hover { background: var(--bg); }

        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        @media (max-width: 1200px) {
            body { padding: 0; font-size: 0.85rem; }
            .grid-container { grid-template-columns: 1fr; padding: 0 10px; }
            .sidebar { 
                position: fixed; top: 0; left: 0; width: 85vw; max-width: 360px; height: 100vh; max-height: 100vh;
                border-radius: 0; z-index: 1000; transform: translateX(-100%); 
                transition: transform 0.3s ease; box-shadow: none;
                overflow-y: auto;
            }
            .sidebar.open { transform: translateX(0); box-shadow: 4px 0 20px rgba(0,0,0,0.3); }
            .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 999; }
            .sidebar-overlay.active { display: block; }
            .sidebar-toggle { 
                display: flex; align-items: center; gap: 8px; background: var(--primary); color: white; 
                border: none; padding: 10px 16px; border-radius: 8px; font-size: 0.9rem; font-weight: 600;
                cursor: pointer; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            }
            .sidebar-toggle:active { transform: scale(0.97); }
            .sidebar-close { 
                display: flex; position: absolute; top: 12px; right: 12px; background: none; border: none; 
                font-size: 1.4rem; color: var(--text-light); cursor: pointer; padding: 4px 8px; z-index: 1001;
            }
            .filters-bar { padding: 10px; }
            .filter-item { min-width: 100%; }
            th, td { padding: 6px 8px; font-size: 0.8rem; }
            .tabs-container { margin-left: 10px; margin-right: 10px; }
            #tab-quick { padding: 0 10px; }
        }
        @media (min-width: 1201px) {
            .sidebar-toggle { display: none; }
            .sidebar-close { display: none; }
            .sidebar-overlay { display: none !important; }
        }
        
        /* === TABS CSS === */
        .tabs-container {
            max-width: 1900px;
            margin: 0 auto 20px auto;
        }
        
        .tabs-header {
            display: flex;
            gap: 0;
            background: var(--surface);
            border-radius: 12px 12px 0 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tab-button {
            flex: 1;
            padding: 16px 24px;
            background: #f1f5f9;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-button:hover {
            background: #e2e8f0;
            color: var(--text-main);
        }
        
        .tab-button.active {
            background: var(--surface);
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* === ABA 1 - SIMULAÇÃO RÁPIDA === */                
        .power-button:hover {
            border-color: var(--primary);
            background: #f0f9ff;
        }

        .quick-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 12px;
        }
        
        .quick-option:hover {
            border-color: var(--primary);
            background: #f0f9ff;
        }
        
        .quick-option input[type="radio"] {
            accent-color: white;
        }
        
        .collapsible-header {
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .collapsible-header:hover {
            background: #f1f5f9;
        }
        
        .collapsible-content {
            padding: 16px;
            background: #fafafa;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .collapsible-content.collapsed {
            display: none;
        }
        
        /* Regra genérica para qualquer elemento com classe collapsed */
        .collapsed {
            display: none !important;
        }
        
        .provider-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }
        
        .provider-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }
        
        .provider-checkbox:hover {
            background: #f8fafc;
        }
        
        .simulate-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
        }
        
        .simulate-btn:hover {
            background: #0052a3;
            box-shadow: 0 4px 12px rgba(0,102,204,0.3);
        }
        
        .update-notice {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 8px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .podium-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin: 24px 0;
        }
        
        .podium-item {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .podium-item.first {
            order: 2;
            border: 3px solid #ffd700;
        }
        
        .podium-item.second {
            order: 1;
        }
        
        .podium-item.third {
            order: 3;
        }
        
        .podium-medal {
            font-size: 3rem;
            margin-bottom: 12px;
        }
        
        .podium-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        
        .podium-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Roboto Mono', monospace;
        }
        
        .podium-savings {
            color: var(--success);
            font-weight: 600;
            margin-top: 8px;
        }
        
        @media (max-width: 1200px) {
            .podium-container {
                grid-template-columns: 1fr;
            }
            .podium-item.first,
            .podium-item.second,
            .podium-item.third {
                order: initial;
            }
        }
        /* === TABS CSS === */
        .tabs-container {
            max-width: 1900px;
            margin: 0 auto 20px auto;
        }

        .tabs-header {
            display: flex;
            gap: 0;
            background: var(--surface);
            border-radius: 12px 12px 0 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab-button {
            flex: 1;
            padding: 12px 20px;
            background: #f1f5f9;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s;
        }

        .tab-button:hover {
            background: #e2e8f0;
            color: var(--text-main);
        }

        .tab-button.active {
            background: var(--surface);
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* === ABA 1 - SIMULAÇÃO RÁPIDA (COMPACTA) === */
        .quick-sim-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .quick-card {
            background: var(--surface);
            padding: 12px 16px; /* Compacto */
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 10px; /* Compacto */
        }

        .quick-title {
            font-size: 0.9rem; /* Compacto */
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .price-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .price-button, .power-button {
            padding: 8px; /* Compacto */
            background: #f8fafc;
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Roboto Mono', monospace;
            transition: all 0.2s;
            text-align: center;
            font-size: 0.85rem; /* Compacto */
        }

        .price-button.selected, .power-button.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .power-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(65px, 1fr)); /* Compacto */
            gap: 6px; /* Compacto */
        }

        .quick-option {
            padding: 10px 12px; /* Compacto */
            background: #f8fafc;
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem; /* Compacto */
        }

        .quick-option.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Pódio */
        .podium-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 16px 0;
        }

        .podium-item {
            background: var(--surface);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .podium-item.first {
            order: 2;
            border: 3px solid #ffd700;
        }

        .podium-item.second { order: 1; }
        .podium-item.third { order: 3; }

        .podium-medal {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .podium-name {
            font-weight: 700;
            font-size: 0.95rem;
            margin-bottom: 6px;
        }

        .podium-price {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Roboto Mono', monospace;
        }

        @media (max-width: 1200px) {
            .podium-container {
                grid-template-columns: 1fr;
            }
            .podium-item.first,
            .podium-item.second,
            .podium-item.third {
                order: initial;
            }
        }
        /* Estilo específico para os inputs da Aba 2 (Consumo Manual) */
        #content-consumo input {
            padding: 8px;           /* Aumenta o espaço interno (altura visual) */
            font-size: 0.85rem;       /* Aumenta o tamanho dos números */
            font-family: 'Roboto Mono', monospace; /* Fonte monoespaçada */
            height: auto;            /* Deixa a altura ajustar-se ao padding */
            border-radius: 4px;      /* (Opcional) Arredonda os cantos */
            width: 100%;             /* Garante que ocupa a largura disponível */
            box-sizing: border-box;  /* Evita que o padding estrague a largura */
            border: 1px solid #e2e2e2;  
            background-color: #fff;  /* Garante fundo branco */
            color: #333;             /* Garante texto escuro */
        }

        /* Mudar a cor quando o utilizador clica (Fica azul, como definiu) */
        #content-consumo input:focus {
            border-color: #0066cc;
            outline: none;
            background-color: #f0f7ff;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1); /* Opcional: um brilho suave */
        }
    </style>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [{
        "@type": "Question",
        "name": "De onde vêm os dados dos tarifários e dos preços de mercado (OMIE)?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Todos os dados dos tarifários são recolhidos a partir das informações públicas disponibilizadas pelos comercializadores nos seus websites. Os preços do mercado ibérico (OMIE) e os perfis de consumo da ERSE são obtidos de fontes oficiais para garantir a máxima precisão nos cálculos dos tarifários indexados. Os dados são atualizados regularmente para refletir as condições atuais do mercado."
        }
      },{
        "@type": "Question",
        "name": "Alguns tarifários têm custo na energia diferentes do que têm no seu site institucional, porquê?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Alguns comercializadores não incluem o valor do financiamento da Tarifa Social de Eletricidade (TSE) no custo base da energia. Para que se possa comparar entre todos de forma igual, nesses casos junto o custo de financiamento da TSE ao custo base. Para confirmar, passe o rato por cima do valor da energia na tabela para ver a decomposição detalhada do preço."
        }
      },{
        "@type": "Question",
        "name": "Tenho um tarifário com o mesmo nome que o do simulador, mas tem valores diferentes na energia e/ou potência, porquê?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Muitos comercializadores alteram os valores nos seus tarifários mas mantêm as denominações dos mesmos. Este simulador só tem os valores para a última versão do tarifário."
        }
      },{
        "@type": "Question",
        "name": "O simulador é 100% preciso?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "O objetivo é ser o mais preciso possível. Para tarifários fixos, a precisão é muito elevada. Para tarifários indexados, o custo final é uma estimativa baseada em médias e perfis de consumo. A forma mais rigorosa de simulação é sempre através do carregamento do seu diagrama de carga da E-Redes, pois utiliza o seu perfil de consumo real (neste caso, apenas dados históricos)."
        }
      },{
        "@type": "Question",
        "name": "Porque é que o modo 'Análise Detalhada' com o ficheiro da E-Redes é recomendado?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Este modo utiliza o seu consumo real registado a cada 15 minutos. Isto permite um cálculo exato do custo para qualquer tipo de tarifário, incluindo os indexados quarto-horários (dinâmicos). Além disso, só neste modo é possível fazer uma análise precisa da sua potência contratada e simular o impacto do autoconsumo com painéis solares fotovoltaicos."
        }
      },{
        "@type": "Question",
        "name": "Porque é que a simulação só está disponível a partir de 01/01/2026?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "A simulação está focada no ano de 2026 para garantir que os cálculos utilizam as Tarifas de Acesso às Redes (TAR) e outras taxas e impostos que estão em vigor. Utilizar dados de consumo de anos anteriores com as tarifas atuais poderia levar a resultados imprecisos, uma vez que as condições do mercado e a regulação mudam anualmente. O simulador ignora automaticamente quaisquer dados anteriores a esta data para garantir a relevância dos resultados."
        }
      },{
        "@type": "Question",
        "name": "Qual a diferença entre escolher um Mês e um Período de Datas manual?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Escolher um Mês: É a forma mais simples e rápida. O simulador seleciona automaticamente o primeiro e o último dia desse mês e usa o número de dias correto. Selecionar Datas: Oferece total flexibilidade para analisar um período específico (ex: uma semana, uma quinzena). O número de dias é calculado com base no intervalo que definir."
        }
      },{
        "@type": "Question",
        "name": "Como são tratados os fins de semana e feriados nos ciclos Bi e Tri-Horário?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "O simulador utiliza os ciclos horários oficiais definidos pela ERSE. Nos Ciclos Semanais (ex: Bi-Horário Semanal), os fins de semana têm um tratamento específico, geralmente com mais horas a contar como 'Vazio'. Nos Ciclos Diários, a contagem das horas é a mesma para todos os dias da semana. Os feriados não têm regras especificas em BTN, sendo tratados como dias 'normais'. O simulador aplica estas regras automaticamente com base nos dados oficiais."
        }
      },{
        "@type": "Question",
        "name": "O que significa a opção 'Comparar custos entre diferentes Opções Horárias'?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Ao ativar esta opção, o simulador recalcula o custo de cada tarifário para diferentes ciclos horários (Simples, Bi-Horário, etc.), assumindo os mesmos consumos totais que inseriu. Isto é útil para perceber se, com o seu padrão de consumo atual, compensaria mudar de opção horária."
        }
      },{
        "@type": "Question",
        "name": "Como funciona a secção 'O Meu Tarifário'?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Esta secção permite-lhe introduzir os preços da sua fatura atual (energia em €/kWh e potência em €/dia) para comparar diretamente com todas as outras ofertas do mercado. É fundamental verificar na sua fatura se os preços que insere já incluem as TAR (Tarifas de Acesso às Redes) para que a comparação seja correta."
        }
      },{
        "@type": "Question",
        "name": "Para que serve a secção 'Comparar outro Tarifário Personalizado?'",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Esta funcionalidade é uma ferramenta poderosa para criar cenários hipotéticos. Permite-lhe construir até três estruturas tarifárias com os seus próprios preços. É ideal para simular uma oferta que recebeu, perceber qual seria o custo se o seu comercializador oferecesse uma opção horária diferente, ou testar o impacto de futuras subidas ou descidas de preços."
        }
      },{
        "@type": "Question",
        "name": "Como funciona a simulação de Autoconsumo com painéis solares fotovoltaicos?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Ao ativar esta opção (disponível no modo de diagrama de carga), o simulador estima a produção de energia de um sistema fotovoltaico com base na potência, localização e orientação que definir. Essa produção é depois subtraída do seu consumo a cada 15 minutos. O resultado é um novo perfil de 'consumo da rede', que mostra quanta energia realmente precisou de comprar. Os cálculos dos tarifários podem então ser feitos com base neste novo consumo, mostrando a poupança real que o autoconsumo pode gerar."
        }
      },{
        "@type": "Question",
        "name": "A simulação de autoconsumo tem em conta os dias de chuva ou de sol?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "A simulação utiliza perfis de produção solar médios mensais para cada distrito, baseados em dados históricos do PVGIS. Isto significa que a produção estimada para um dia de Julho, por exemplo, representa um 'dia médio' de Julho, já tendo em conta a média de horas de sol e de nebulosidade para esse mês nessa região. Não simula a produção para um dia específico com as suas condições meteorológicas reais, mas oferece uma estimativa muito realista para um período de análise mais longo."
        }
      },{
        "@type": "Question",
        "name": "Os valores OMIE para datas futuras são reais?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Não. Os valores OMIE apresentados para datas futuras baseiam-se nos preços do mercado de futuros (OMIP). Estes valores representam a expectativa do mercado para os preços da eletricidade, mas não são uma garantia. Servem como a melhor estimativa disponível para simular custos em tarifários indexados para períodos que ainda não ocorreram. A data de atualização destes valores está indicada no final da página."
        }
      },{
        "@type": "Question",
        "name": "Como são tratados descontos especiais como os do ACP ou Continente?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "O simulador tenta replicar as condições comerciais o mais fielmente possível. Para a parceria Goldenergy/ACP, pode optar por incluir o valor da quota mensal no custo final. Para os tarifários Galp/Continente, o simulador calcula o valor do desconto em Cartão Continente e subtrai-o ao custo total, refletindo a poupança real na sua carteira. Pode ativar ou desativar estas opções na secção 'Opções Adicionais de Simulação'."
        }
      },{
        "@type": "Question",
        "name": "O que são as colunas 'Custo com o seu Perfil Real (€)' e 'Custo com Perfil Padrão ERSE (€)'?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Esta análise, disponível no modo de diagrama de carga, compara duas coisas: o custo exato do seu consumo (Perfil Real) e o custo que teria se o seu consumo seguisse um perfil médio definido pela ERSE (Perfil Padrão). Uma diferença negativa (a verde) significa que o seu padrão de consumo pessoal é mais económico que a média, o que é ótimo!"
        }
      },{
        "@type": "Question",
        "name": "O que está incluído no 'Total (€)'? É o valor final da fatura?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Sim, o valor 'Total (€)' representa a sua fatura final estimada. Ele inclui o Custo da Energia, Custo da Potência, Taxas e Impostos (CAV, DGEG, IEC), IVA aplicado conforme as regras, e quaisquer Descontos ou Acréscimos. Pode ver a decomposição detalhada de todos estes custos passando o rato por cima do valor na coluna 'Total (€)'."
        }
      },{
        "@type": "Question",
        "name": "A tabela de resultados tem muitas opções. Como posso encontrar rapidamente o que procuro?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "A tabela é interativa! Pode: Ordenar (clique no cabeçalho de qualquer coluna), Filtrar (use os filtros no topo da tabela para refinar a sua pesquisa), e Pesquisar (na vista detalhada, pode usar a pesquisa dentro das colunas 'Comercializador' e 'Tarifário')."
        }
      },{
        "@type": "Question",
        "name": "O que é um tarifário indexado? É uma boa opção para mim?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Um tarifário indexado tem um preço de energia que varia de acordo com o preço do mercado grossista (OMIE). Este tipo de tarifário pode oferecer uma poupança significativa quando os preços de mercado estão baixos, mas também implica um risco maior se os preços subirem. Pode ser 'Indexado à Média' ou 'Indexado Quarto-Horário (Dinâmico)'. São ideais para quem consegue adaptar o seu consumo às horas mais baratas do dia."
        }
      },{
        "@type": "Question",
        "name": "O que são as TAR (Tarifas de Acesso às Redes)?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "As TAR são tarifas reguladas pela ERSE que pagam pelo uso das infraestruturas elétricas (transporte e distribuição). Todos os consumidores as pagam, independentemente do comercializador. O simulador lida com ambas as situações para garantir uma comparação justa."
        }
      },{
        "@type": "Question",
        "name": "O que significa 'Perfil de Consumo' (ex: Perfil A, B, C)?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "A ERSE agrupa os consumidores em perfis (A, B ou C) com base no seu consumo anual e potência, representando um padrão de consumo médio. No Modo Manual, o simulador usa estes perfis para estimar o custo dos tarifários indexados. No Modo Diagrama, este perfil não é necessário, pois o simulador usa os seus dados de consumo reais."
        }
      },{
        "@type": "Question",
        "name": "Porque é que o simulador pergunta se a minha instalação é trifásica?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "O ficheiro da E-Redes regista a potência total da sua casa em médias de 15 minutos. Numa instalação trifásica, o consumo total pode distribuir-se pelas três fases. É possível que uma única fase tenha um pico de consumo muito elevado num curto espaço de tempo, fazendo o disjuntor disparar, mesmo que a potência total média nesses 15 minutos não ultrapasse o valor contratado."
        }
      },{
        "@type": "Question",
        "name": "Como sei se a minha instalação é monofásica ou trifásica?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Geralmente, instalações domésticas com potências contratadas até 6.9 kVA são monofásicas. Potências superiores são quase sempre trifásicas. Esta informação está disponível no seu contador ou no balcão digital da E-Redes. A análise de potência máxima no simulador tem em conta esta diferença."
        }
      }]
    }
    </script>
</head>
<body>
<header>
    <div class="header-content">
        <div class="header-title-container">
            <a href="index.html">
                <img src="images/Logo_Tiago_Felicia.png" alt="Logótipo Tiago Felícia - Página Inicial" class="logo">
            </a>
            <div class="brand-name">Tiago Felícia</div>
        </div>
        <p>Simuladores de tarifários de Eletricidade, Gás Natural e Autoconsumo</p>
    </div>
</header>

<div id="menu-placeholder"></div>

<main style="max-width: 1900px; margin: 0 auto;">

    <div id="loader" style="text-align:center; padding:60px 20px;">
        <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 2.5rem; color: var(--primary); margin-bottom: 16px;"></i>
        <p id="loader-msg" style="color: var(--text-light); font-size: 0.95rem; margin-top: 12px;"></p> <!-- === A carregar tarifários... === -->
    </div>

    <!-- === LOGO E TÍTULO DO SIMULADOR === -->
    <div id="simulador-header" style="padding: 30px 20px 20px 20px;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 16px;">
            <img src="https://huggingface.co/spaces/tiagofelicia/simulador-tarifarios-eletricidade/resolve/main/Logo_Tiago_Felicia.png" 
                 alt="Logo Tiago Felícia" 
                 style="width: 120px; height: auto; flex-shrink: 0;">
            <h1>
                🔌 Simulador de Tarifários de Eletricidade 2026 em Portugal | Tiago Felícia
            </h1>
        </div>
        <p>
            Bem-vindo ao simulador de eletricidade mais completo de Portugal 😊. Com esta ferramenta pode comparar tarifários de eletricidade, fixos e indexados, para encontrar a opção mais económica para si. Descubra quanto pode poupar na sua fatura da luz, quer use a Simulação Completa ou carregue o seu ficheiro de consumo da E-Redes para uma Análise Avançada.
        </p>
    </div>

    <!-- === TABS === -->
    <div id="tabs-wrapper" class="tabs-container hidden">
        <div class="tabs-header">
            <button class="tab-button active" onclick="switchTab('quick')">
                ⚡ Simulação Rápida
            </button>
            <button class="tab-button" onclick="switchTab('complete')">
                📝 Simulação Completa
            </button>
            <button class="tab-button" onclick="switchTab('advanced')">
                📊 Análise Avançada (E-Redes)
            </button>
            <button class="tab-button" onclick="switchTab('faq')">
                ❓ FAQ
            </button>
        </div>
    </div>

    <!-- === ÁREA DE UPLOAD CENTRAL ABA 3 (E-REDES) === -->
    <div id="eredes-upload-central" class="hidden" style="max-width: 800px; margin: 40px auto; padding: 20px;">
        <div style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); padding: 32px; border-radius: 16px; box-shadow: 0 8px 32px rgba(14, 165, 233, 0.3); text-align: center; color: white;">
            <div style="margin-bottom: 24px;">
                <i class="fa-solid fa-chart-line" style="font-size: 4rem; opacity: 0.9;"></i>
            </div>
            <h1 style="margin: 0 0 12px 0; font-size: 2rem;">📊 Análise Avançada</h1>
            <p style="margin: 0 0 24px 0; opacity: 0.9; font-size: 1.1rem;">
                Carregue o(s) seu(s) ficheiro(s) de consumo da E-Redes para uma análise detalhada hora-a-hora
            </p>
        </div>
        
        <div style="background: white; padding: 32px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: -20px; border: 2px dashed #0ea5e9;">
            <div style="text-align: center;">
                <label style="display: block; cursor: pointer; padding: 40px 20px; border-radius: 12px; background: #f0f9ff; transition: all 0.3s;" 
                       onmouseover="this.style.background='#e0f2fe'" onmouseout="this.style.background='#f0f9ff'">
                    <i class="fa-solid fa-cloud-arrow-up" style="font-size: 3rem; color: #0ea5e9; margin-bottom: 16px; display: block;"></i>
                    <span style="font-size: 1.2rem; font-weight: 600; color: #0369a1; display: block; margin-bottom: 8px;">
                        Clique para selecionar ficheiro(s)
                    </span>
                    <span style="font-size: 0.9rem; color: #64748b;">
                        Formato Excel (.xlsx ou .xls) exportado da E-Redes
                    </span>
                    <input type="file" id="file-eredes-central" accept=".xlsx,.xls" multiple style="display: none;" onchange="processarFicheirosERedesCentral()">
                </label>
                
                <div id="eredes-status-central" style="margin-top: 16px; font-size: 0.9rem; color: #64748b;"></div>
            </div>
            
            <div style="margin-top: 24px; padding: 16px; background: #fef3c7; border: 1px solid #fde047; border-radius: 8px;">
                <h4 style="margin: 0 0 8px 0; color: #92400e; font-size: 0.95rem;">
                    <i class="fa-solid fa-lightbulb"></i> Como obter o ficheiro da E-Redes?
                </h4>
                <ol style="margin: 0; padding-left: 20px; color: #78350f; font-size: 0.85rem; line-height: 1.6;">
                    <li>Aceda a <a href="https://balcaodigital.e-redes.pt/consumptions/history" target="_blank" style="color: #0369a1;">balcaodigital.e-redes.pt</a></li>
                    <li>Vá a "Consumos" → "Consultar consumos detalhados"</li>
                    <li>Selecione o período desejado e exporte para Excel</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- === ABA 1: SIMULAÇÃO RÁPIDA === -->
    <div id="tab-quick" class="tab-content active hidden">
        <div class="quick-sim-container">
            
            <!-- Cabeçalho -->
            <div class="quick-card" style="background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%); color: white; text-align: center; padding: 16px;">
                <h1 style="margin: 0 0 4px 0; font-size: 1.5rem; color: white !important;">⚡ Simulação Rápida</h1>
                <p style="margin: 0; opacity: 0.9; font-size: 0.85rem;">Descubra quanto pode poupar em segundos</p>
            </div>

            <!-- 1. PREÇO -->
            <div class="quick-card">
                <div class="quick-title">💶 Quanto paga por mês?</div>
                <div class="price-grid">
                    <div class="price-button selected" onclick="selectPrice(40)" id="price-40">
                        <div style="font-size: 1.2rem;">40€</div>
                        <div style="font-size: 0.65rem; opacity: 0.7;">~158 kWh | 3.45 kVA</div>
                    </div>
                    <div class="price-button" onclick="selectPrice(100)" id="price-100">
                        <div style="font-size: 1.2rem;">100€</div>
                        <div style="font-size: 0.65rem; opacity: 0.7;">~333 kWh | 6.90 kVA</div>
                    </div>
                    <div class="price-button" onclick="selectPrice(200)" id="price-200">
                        <div style="font-size: 1.2rem;">200€</div>
                        <div style="font-size: 0.65rem; opacity: 0.7;">~908 kWh | 13.80 kVA</div>
                    </div>
                </div>
                
                <p style="text-align: center; color: var(--text-light); margin: 10px 0 8px 0; font-size: 0.85rem;">ou</p>
                
                <div class="quick-title">⚡ Quanto consome por mês?</div>
                <input type="number" id="quick-kwh" placeholder="158" value="158" 
                       oninput="autoCalculate()" 
                       style="width: 100%; font-size: 1rem; text-align: center; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                <div style="text-align: center; margin-top: 4px; color: var(--text-light); font-size: 0.75rem;">kWh/mês</div>
            </div>

            <!-- 2. POTÊNCIA -->
            <div class="quick-card">
                <div class="quick-title">⚡ Qual é a sua potência contratada?</div>
                <div class="power-grid">
                    <div class="power-button" onclick="selectPower(1.15)">1.15</div>
                    <div class="power-button" onclick="selectPower(2.30)">2.30</div>
                    <div class="power-button selected" onclick="selectPower(3.45)" id="power-default">3.45</div>
                    <div class="power-button" onclick="selectPower(4.60)">4.60</div>
                    <div class="power-button" onclick="selectPower(5.75)">5.75</div>
                    <div class="power-button" onclick="selectPower(6.90)">6.90</div>
                    <div class="power-button" onclick="selectPower(10.35)">10.35</div>
                    <div class="power-button" onclick="selectPower(13.80)">13.80</div>
                    <div class="power-button" onclick="selectPower(17.25)">17.25</div>
                    <div class="power-button" onclick="selectPower(20.70)">20.70</div>
                </div>
                <div style="text-align: center; margin-top: 4px; color: var(--text-light); font-size: 0.75rem;">kVA</div>
            </div>

            <!-- 3. PERFIL -->
            <div class="quick-card">
                <div class="quick-title">🕐 Como utiliza mais eletricidade?</div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div class="quick-option selected" onclick="selectUsagePattern('balanced')" id="usage-balanced">
                        <input type="radio" name="usage" checked> Não adapto o consumo aos horários
                    </div>
                    <div class="quick-option" onclick="selectUsagePattern('night')" id="usage-night">
                        <input type="radio" name="usage"> Maior consumo à noite (após as 22h)
                    </div>
                </div>
            </div>

            <!-- 4. TIPO -->
            <div class="quick-card">
                <div class="quick-title">🎯 O que procura?</div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div class="quick-option selected" onclick="selectTariffType('all')" id="tariff-all">
                        <input type="radio" name="tariff-type" checked> A mais barata agora (Todas as opções)
                    </div>
                    <div class="quick-option" onclick="selectTariffType('fixed')" id="tariff-fixed">
                        <input type="radio" name="tariff-type"> Só Preço Fixo (Sem oscilações)
                    </div>
                </div>
            </div>

            <!-- 5. AJUSTES -->
            <div class="quick-card">
                <div style="cursor: pointer; padding: 8px; background: #f1f5f9; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;" onclick="toggleQuickSettings()">
                    <span style="font-weight: 600; font-size: 0.9rem;">⚙️ Ajustes rápidos</span>
                    <i class="fa-solid fa-chevron-down" id="quick-settings-icon"></i>
                </div>
                <div class="hidden" id="quick-settings-content" style="margin-top: 10px;">
                    <div style="margin-bottom: 12px;">
                        <label style="font-weight: 600; margin-bottom: 6px; display: block; font-size: 0.85rem;">Prefere:</label>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <div class="quick-option selected" onclick="selectCycle('simples')" id="cycle-simples">
                                <input type="radio" name="cycle" checked> Tarifa simples
                            </div>
                            <div class="quick-option" onclick="selectCycle('bi')" id="cycle-bi">
                                <input type="radio" name="cycle"> Bi-horário
                            </div>
                            <div class="quick-option" onclick="selectCycle('tri')" id="cycle-tri">
                                <input type="radio" name="cycle"> Tri-horário
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label style="font-weight: 600; margin-bottom: 6px; display: block; font-size: 0.85rem;">Não mostrar estes comercializadores:</label>
                        <div id="provider-filters" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; font-size: 0.8rem;">
                            <!-- Preenchido dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- RESULTADOS - PÓDIO -->
            <div id="quick-results" style="display: block;">
                <div class="quick-card">
                    <h2 style="text-align: center; margin-bottom: 16px; font-size: 1.2rem;">
                        🏆 Melhores Soluções
                    </h2>
                    <div class="podium-container" id="podium">
                        <div class="podium-item" style="opacity: 0.3;">
                            <div class="podium-medal">🥇</div>
                            <div class="podium-name">...</div>
                            <div class="podium-price">-</div>
                        </div>
                        <div class="podium-item" style="opacity: 0.3;">
                            <div class="podium-medal">🥈</div>
                            <div class="podium-name">...</div>
                            <div class="podium-price">-</div>
                        </div>
                        <div class="podium-item" style="opacity: 0.3;">
                            <div class="podium-medal">🥉</div>
                            <div class="podium-name">...</div>
                            <div class="podium-price">-</div>
                        </div>
                    </div>
                    
                    <p style="text-align: center; color: var(--text-light); margin: 12px 0 8px 0; font-size: 0.85rem;">
                        Quer ver mais detalhes ou todos os comercializadores?
                    </p>
                    <button style="width: 100%; padding: 12px; background: white; border: 2px solid var(--primary); color: var(--primary); border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem;" onclick="switchTab('complete')">
                        📋 Ver Tabela Completa
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- === ABA 2 & 3: SIMULAÇÃO COMPLETA E ANÁLISE AVANÇADA === -->
    <div id="app" class="grid-container hidden">
        
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
        <div class="sidebar" id="sidebar-panel">
            <button class="sidebar-close" onclick="toggleSidebar()" aria-label="Fechar">&times;</button>
            <h2 style="color:var(--primary); margin-top:0; font-size:1.2rem; display:flex; align-items:center; gap:10px;">
                <i class="fa-solid fa-bolt"></i> Simulador Tiago Felícia <span style="font-size:0.4em; background:var(--text-main); color:white; padding:2px 4px; border-radius:4px;">v2</span>
                <button class="btn-cenarios" onclick="abrirModalCenarios()" title="Cenários Guardados"><i class="fa-solid fa-floppy-disk"></i></button>
            </h2>
            
            <div class="section-title" onclick="toggleSection('contrato')">Contrato <i class="fa-solid fa-chevron-down" id="icon-contrato"></i></div>
            <div class="section-content" id="content-contrato">
                <div class="input-group">
                    <label>
                        Potência Contratada
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Potência Contratada', 'Potências BTN (1.15 kVA a 41.4 kVA)')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                    <select id="potencia" onchange="atualizarMenusCiclo(); autoCollapse('contrato')">
                        <option value="1.15">1.15 kVA</option><option value="2.3">2.30 kVA</option>
                        <option value="3.45" selected>3.45 kVA</option><option value="4.6">4.60 kVA</option>
                        <option value="5.75">5.75 kVA</option><option value="6.9">6.90 kVA</option>
                        <option value="10.35">10.35 kVA</option><option value="13.8">13.80 kVA</option>
                        <option value="17.25">17.25 kVA</option><option value="20.7">20.70 kVA</option>
                        <option value="27.6">27.60 kVA</option><option value="34.5">34.50 kVA</option>
                        <option value="41.4">41.40 kVA</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>
                            Opção Horária
                            <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                            onmouseenter="showTooltipNome(event, 'Opção Horária', 'Opção horária contratada')" 
                            onmouseleave="hideTooltip()"></i>
                    </label>
                    <select id="ciclo" onchange="construirInputsConsumo(); autoCollapse('contrato')"></select>
                </div>
            </div>

            <div class="section-title" onclick="toggleSection('consumo')">Consumo <i class="fa-solid fa-chevron-down" id="icon-consumo"></i></div>
            <div class="section-content" id="content-consumo"></div>

            <div id="eredes-section-wrapper">
                <div class="section-title" onclick="toggleSection('eredes')">Diagrama de Cargas E-Redes <i class="fa-solid fa-chevron-right" id="icon-eredes"></i></div>
                <div class="section-content collapsed" id="content-eredes">
                <!-- Área de Upload (visível inicialmente) -->
                <div id="eredes-upload" style="background:#e0f2fe; border:1px solid #0ea5e9; padding:12px; border-radius:8px; margin-bottom:12px;">
                    <div style="font-size:0.85rem; margin-bottom:8px; font-weight:600; color:#0369a1;">
                        <i class="fa-solid fa-file-excel"></i> Upload Ficheiro(s) Excel
                    </div>
                    <input type="file" id="file-eredes" accept=".xlsx,.xls" multiple style="font-size:0.8rem; padding:6px;" onchange="processarFicheirosERedes()">
                    <div id="eredes-status" style="margin-top:8px; font-size:0.75rem; color:#64748b;"></div>
                    <div id="eredes-info" style="margin-top:8px; font-size:0.75rem; background:#fef3c7; border:1px solid #fde047; padding:6px; border-radius:4px; display:none;"></div>
                </div>
                
                <!-- Área de Limpar (oculta inicialmente) -->
                <div id="eredes-limpar" style="display:none; background:#d1fae5; border:1px solid #10b981; padding:12px; border-radius:8px; margin-bottom:12px;">
                    <div style="font-size:0.85rem; margin-bottom:8px; font-weight:600; color:#059669;">
                        <i class="fa-solid fa-check-circle"></i> Ficheiro(s) Processado(s)
                    </div>
                    <div id="eredes-resumo" style="font-size:0.75rem; margin-bottom:8px; color:#064e3b;"></div>
                    <button onclick="limparDadosERedes()" style="width:100%; padding:8px; background:#dc2626; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">
                        <i class="fa-solid fa-trash"></i> Limpar Dados e Reiniciar
                    </button>
                </div>
                
                <div style="font-size:0.7rem; color:var(--text-light); line-height:1.4;">
                    ℹ️ Carregue ficheiros de consumos da E-Redes (formato Excel). Os consumos serão calculados automaticamente hora-a-hora.
                </div>
            </div>
            </div> <!-- Fim eredes-section-wrapper -->

            <div class="section-title" onclick="toggleSection('meu')">O Meu Tarifário <i class="fa-solid fa-chevron-right" id="icon-meu"></i></div>
            <div class="section-content collapsed" id="content-meu">
                <div class="custom-tariff">
                    <div class="input-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="meu_ativo" onchange="toggleMeuTarifario()"> Ativar comparação
                            <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                            onmouseenter="showTooltipNome(event, 'O Meu Tarifário', 'Para preencher os valores de acordo com o seu tarifário, ou com outro qualquer que queira comparar. Atenção às notas sobre as TAR e TSE.')" 
                            onmouseleave="hideTooltip()"></i>
                        </label>
                    </div>
                    <div id="meu-inputs" class="hidden" style="margin-top:8px;"></div>
                </div>
            </div>

            <div class="section-title" onclick="toggleSection('personalizado')">Tarifário Personalizado <i class="fa-solid fa-chevron-right" id="icon-personalizado"></i></div>
            <div class="section-content collapsed" id="content-personalizado">
                <div class="custom-tariff">
                    <div class="input-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="pers_ativo" onchange="toggleTarifarioPersonalizado()"> Ativar comparação
                            <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                            onmouseenter="showTooltipNome(event, 'Tarifário Personalizado', 'Crie tarifário personalizado para comparar com os seus consumos. Ideal para comparar diferentes opções tarifárias/horárias. Não permite descontos e acréscimos que existem em O Meu Tarifário.')" 
                            onmouseleave="hideTooltip()"></i>
                        </label>
                    </div>
                    <small style="color:var(--text-light); display:block; margin-top:4px; font-size:0.7rem;">
                        Ideal para comparar diferentes opções tarifárias/horárias. Não permite descontos e acréscimos.
                    </small>
                    <div id="pers-inputs" class="hidden" style="margin-top:12px;">
                    </div>
                </div>
            </div>

            <div class="section-title" onclick="toggleSection('comparacao')">Modo de Comparação <i class="fa-solid fa-chevron-right" id="icon-comparacao"></i></div>
            <div class="section-content collapsed" id="content-comparacao">
                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="modo_comparacao" onchange="calcular()"> Comparar Opções Horárias
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Modo Comparação', 'Ative para ver uma tabela que compara o custo de cada tarifário em diferentes opções horárias (Simples, Bi-Horário, Tri-Horário), usando os seus consumos inseridos. Irá desativar a tabela detalhada.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                </div>
                <small style="color:var(--text-light); display:block; margin-top:4px; font-size:0.7rem;">
                    Compare o custo de cada tarifário em diferentes opções horárias (Simples, Bi-Horário, Tri-Horário) usando os seus consumos.
                </small>
            </div>

            <div class="section-title" onclick="toggleSection('beneficios')">Benefícios Sociais <i class="fa-solid fa-chevron-right" id="icon-beneficios"></i></div>
            <div class="section-content collapsed" id="content-beneficios">
                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="familia_numerosa" onchange="calcular()"> Família Numerosa
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Família Numerosa', '300 kWh com IVA a 6% (em vez dos normais 200 kWh) para potências até 6.9 kVA.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                    <small style="color:var(--text-light); margin-left:22px; display:block; font-size:0.75rem;">Limite IVA 6%: 300 <span class="label-units">kWh</span> (≤6.9 <span class="label-units">kVA</span>)</small>
                </div>
                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="tarifa_social" onchange="calcular()"> Tarifa Social
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Tarifa Social', 'Só pode ter Tarifa Social para potências até 6.9 kVA.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                    <small style="color:var(--text-light); margin-left:22px; display:block; font-size:0.75rem;">Descontos TAR (≤6.9 <span class="label-units">kVA</span>)</small>
                </div>
            </div>

            <div class="section-title" onclick="toggleSection('opcoes')">Opções Adicionais <i class="fa-solid fa-chevron-right" id="icon-opcoes"></i></div>
            <div class="section-content collapsed" id="content-opcoes">
                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="ocultar_edp_h" checked onchange="calcular()"> Ocultar EDP Horária
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Ocultar EDP Horária', 'Este tarifário não é calculado por perfil. Quando contratado e a EDP não recebe os diagramas de carga da E-Redes, é aplicado o cálculo pelo EDP Média.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                </div>
                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="quota_acp" checked onchange="calcular()"> Incluir Quota ACP
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Incluir Quota ACP', 'Incluir o valor da quota do ACP (4,90 €/mês) no valor do tarifário da parceria GE/ACP.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="input-group">
                        <label>
                            CAV <span class="label-units">(€/mês)</span>
                            <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                                    onmouseenter="showTooltipNome(event, 'Contribuição Audiovisual', 'Contribuição Audiovisual (CAV) - Verifique qual o valor cobrado na sua fatura. O valor normal é de 2,85 €/mês. Será 1 €/mês, para alguns casos de Tarifa Social (1º escalão de abono...) Será 0 €/mês, para consumo inferior a 400 kWh/ano.')" 
                                    onmouseleave="hideTooltip()"></i>
                            </label>
                        <input type="number" id="cav_valor" value="2.85" step="0.01" oninput="calcular()">
                    </div>
                    <div class="input-group">
                        <label>
                            DGEG<span class="label-units">(€/mês)</span>
                            <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                            onmouseenter="showTooltipNome(event, 'DGEG', 'Taxa de Exploração da Direção-Geral de Energia e Geologia - Verifique qual o valor cobrado na sua fatura. Em condições normais, para contratos domésticos o valor é de 0,07 €/mês e os não domésticos têm o valor de 0,35 €/mês.')" 
                            onmouseleave="hideTooltip()"></i>
                        </label>
                        <input type="number" id="dgeg_valor" value="0.07" step="0.01" oninput="calcular()">
                    </div>
                </div>
            </div>

            <div class="section-title" onclick="toggleSection('datas')">Datas de Faturação <i class="fa-solid fa-chevron-right" id="icon-datas"></i></div>
            <div class="section-content collapsed" id="content-datas">
                <div class="input-group">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                        <div>
                            <label>
                                Início
                                <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                                onmouseenter="showTooltipNome(event, 'Data Inicial', 'A partir de 01/01/2025. Se não modificar a data, será calculado a partir do dia seguinte ao atual.')" 
                                onmouseleave="hideTooltip()"></i>
                            </label><input type="date" id="d_inicio" value="2025-01-01" min="2025-01-01" max="2026-12-31" onchange="atualizarDias()"></div>
                        <div>
                            <label>
                                Fim
                                <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                                onmouseenter="showTooltipNome(event, 'Data Final', 'De Data Inicial a 31/12/2026. Se não modificar as datas, será calculado até um mês após a data inicial.')" 
                                onmouseleave="hideTooltip()"></i>
                            </label><input type="date" id="d_fim" value="2025-12-31" min="2025-01-01" max="2026-12-31" onchange="atualizarDias()"></div>
                    </div>
                </div>
                <div class="input-group">
                    <label>Dias de Faturação</label>
                    <input type="number" id="num_dias" readonly style="background:#f1f5f9; font-weight:bold;">
                </div>
            </div>

            <div id="omie-panel" class="omie-box hidden">
                <div style="font-size:0.75rem; text-transform:uppercase; font-weight:700; color:#9a3412; margin-bottom:6px;">
                    <i class="fa-solid fa-chart-line"></i> <span id="omie-label-titulo">Média OMIE / OMIP</span><span class="label-units">(€/MWh)</span>
                    <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                    onmouseenter="showTooltipNome(event, 'Média OMIE / OMIP', 'Se escolher datas passadas, serão médias finais do OMIE. Se escolher datas futuras, serão médias dos futuros OMIP, que podem não concretizar-se no OMIE. Estas médias são atualizadas diariamente e são usadas para calcular os tarifários indexados.')" 
                    onmouseleave="hideTooltip()"></i></label></div>
                <div id="omie-display" style="font-size:0.85rem; margin-bottom:8px; font-family: 'Roboto Mono', monospace;"></div>
                <div id="omie-inputs" class="omie-editable"></div>
                <div style="font-size:0.7rem; color:var(--text-light); margin-top:4px;">*Edição manual fixa o valor para todo o cálculo.</div>
            </div>
        </div>

        <div class="main-content">
            <button class="sidebar-toggle" id="sidebar-toggle-btn" onclick="toggleSidebar()"><i class="fa-solid fa-sliders"></i> Parâmetros</button>
            
            <div class="filters-bar">
                <div class="filter-item">
                    <label>Segmento
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Segmento', 'Escolha o segmento para a simulação.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                    <select id="f_segmento" onchange="calcular()">
                        <option value="Ambos">Ambos</option>
                        <option value="Residencial" selected>Residencial</option>
                        <option value="Empresarial">Empresarial</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>Faturação
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Faturação', 'Escolha o tipo de faturação pretendido.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                    <select id="f_fatura" onchange="calcular()">
                        <option value="Todas">Todas</option>
                        <option value="Fatura eletrónica">Eletrónica</option>
                        <option value="Fatura em papel">Papel</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>Pagamento
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Pagamento', 'Escolha o método de pagamento.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                    <select id="f_pagamento" onchange="calcular()">
                        <option value="Todos">Todos</option>
                        <option value="Débito Direto">Débito Direto</option>
                        <option value="Multibanco">Multibanco</option>
                        <option value="Numerário/Payshop/CTT">Outros (Num/CTT)</option>
                    </select>
                </div>
                <div class="filter-item" style="flex: 2;">
                    <label>Tipo Tarifário
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Tipos de Tarifário', 'Fixo: Preço constante. Indexado Média: Baseado na média OMIE. Indexado Dinâmico: Baseado no consumo e OMIE quarto-horário.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                    <div class="checkbox-group">
                        <label class="checkbox-label"><input type="checkbox" class="chk-tipo" value="Fixo" checked onchange="calcular()"> Fixo</label>
                        <label class="checkbox-label"><input type="checkbox" class="chk-tipo" value="Indexado Média" checked onchange="calcular()"> Indexado Média</label>
                        <label class="checkbox-label"><input type="checkbox" class="chk-tipo" value="Indexado quarto-horário" checked onchange="calcular()"> Dinâmico/Indexado QH</label>
                    </div>
                </div>
                <div class="filter-item" style="flex: 2;">
                    <label>Pesquisar Comercializador/Tarifário
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Pesquisar Comercializador/Tarifário', 'Digite o nome do comercializador ou tarifário que deseja filtrar.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                    <input type="text" id="f_procura" placeholder="Ex: Coopérnico, EDP, BTN..." oninput="calcular()" style="width:100%;">
                </div>
            </div>
            
            <!-- Filtro de Comercializadores Aba 2 -->
            <div id="filter-providers-aba2" style="background: var(--surface); padding: 12px 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px;">
                <div style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleProviderFilterAba2()">
                    <label style="font-weight: 600; cursor: pointer;"><i class="fa-solid fa-filter"></i> Não mostrar estes comercializadores:</label>
                    <i class="fa-solid fa-chevron-down" id="icon-filter-providers-aba2"></i>
                </div>
                <div id="content-filter-providers-aba2" class="collapsed" style="margin-top: 12px;">
                    <div id="provider-filters-aba2" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px;">
                    </div>
                </div>
            </div>
            
            <!-- Filtro de Comercializadores Aba 3 -->
            <div id="filter-providers-aba3" style="background: var(--surface); padding: 12px 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px; display: none;">
                <div style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleProviderFilterAba3()">
                    <label style="font-weight: 600; cursor: pointer;"><i class="fa-solid fa-filter"></i> Não mostrar estes comercializadores:</label>
                    <i class="fa-solid fa-chevron-down" id="icon-filter-providers-aba3"></i>
                </div>
                <div id="content-filter-providers-aba3" class="collapsed" style="margin-top: 12px;">
                    <div id="provider-filters-aba3" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px;">
                    </div>
                </div>
            </div>
            
            <!-- Gráfico Evolução OMIE (Aba 2) -->
            <div id="grafico-omie-container" style="margin-bottom: 16px;">
                <div style="cursor: pointer; padding: 15px; background: #fff7ed; border: 1px solid #fed7aa; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;" onclick="toggleGraficoOmie()">
                    <h5 style="margin: 0; color: #9a3412; font-size: 0.95rem;">
                        <i class="fa-solid fa-chart-line"></i> Gráfico de Evolução dos Preços Médios Diários OMIE PT no Período
                    </h5>
                    <i id="grafico-omie-icon" class="fa-solid fa-chevron-down" style="color: #9a3412;"></i>
                </div>
                <div id="grafico-omie-content" class="collapsed" style="margin-top: 15px;">
                    <div id="chart-omie-diario" style="height: 350px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
                </div>
            </div>

            <!-- Tabela de Análise de Consumos (só aparece com ficheiros E-Redes) -->
            <div id="analise-consumos" style="display:none; margin-bottom:25px;">
                <div style="cursor:pointer; padding:15px; background:#f0f9ff; border:1px solid #0ea5e9; border-radius:10px; display:flex; justify-content:space-between; align-items:center;" onclick="toggleAnalise()">
                    <h5 style="margin:0; color:#0369a1; font-size:0.95rem;">
                        <i class="fa-solid fa-chart-pie"></i> Análise de Consumos e Médias OMIE (do(s) ficheiro(s))
                    </h5>
                    <i id="analise-icon" class="fa-solid fa-chevron-down" style="color:#0369a1;"></i>
                </div>
                <div id="analise-content" style="margin-top:15px; overflow-x:auto;">
                </div>
            </div>
            
            <!-- Gráficos de Análise E-Redes (Aba 3) -->
            <div id="graficos-analise-eredes" style="display:none; margin-bottom:25px;">
                <div style="cursor:pointer; padding:15px; background:#f0fdf4; border:1px solid #22c55e; border-radius:10px; display:flex; justify-content:space-between; align-items:center;" onclick="toggleGraficosAnalise()">
                    <h5 style="margin:0; color:#15803d; font-size:0.95rem;">
                        <i class="fa-solid fa-chart-area"></i> Gráficos de Análise (Consumo vs. OMIE)
                    </h5>
                    <i id="graficos-analise-icon" class="fa-solid fa-chevron-down" style="color:#15803d;"></i>
                </div>
                <div id="graficos-analise-content" class="collapsed" style="margin-top:15px;">
                    <!-- Gráfico Horário -->
                    <div style="margin-bottom: 20px;">
                        <h6 style="margin: 0 0 10px 0; color: #374151;">Consumo e Preço Médio OMIE por Hora</h6>
                        <div id="chart-horario" style="height: 400px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
                    </div>
                    <!-- Gráfico Diário -->
                    <div style="margin-bottom: 20px;">
                        <h6 style="margin: 0 0 10px 0; color: #374151;">Consumo e Preço Médio OMIE Diário</h6>
                        <div id="chart-diario" style="height: 400px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
                    </div>
                    <!-- Gráfico por Dia da Semana -->
                    <div style="margin-bottom: 20px;">
                        <h6 style="margin: 0 0 10px 0; color: #374151;">Consumo e Preço Médio OMIE por Dia da Semana</h6>
                        <div id="chart-semana" style="height: 400px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
                    </div>
                    <!-- Gráfico Mensal -->
                    <div style="margin-bottom: 20px;">
                        <h6 style="margin: 0 0 10px 0; color: #374151;">Consumo e Preço Médio OMIE Mensal</h6>
                        <div id="chart-mensal" style="height: 400px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Análise da Potência Contratada (Aba 3) -->
            <div id="analise-potencia" style="display:none; margin-bottom:25px;">
                <div style="cursor:pointer; padding:15px; background:#fef3c7; border:1px solid #fde047; border-radius:10px; display:flex; justify-content:space-between; align-items:center;" onclick="toggleAnalisePotencia()">
                    <h5 style="margin:0; color:#92400e; font-size:0.95rem;">
                        <i class="fa-solid fa-bolt"></i> Análise da Potência Contratada
                    </h5>
                    <i id="analise-potencia-icon" class="fa-solid fa-chevron-down" style="color:#92400e;"></i>
                </div>
                <div id="analise-potencia-content" style="margin-top:15px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
                        <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 4px;">Potência Contratada</div>
                            <div id="potencia-contratada-display" style="font-size: 1.5rem; font-weight: 700; color: #0f172a;">-- kVA</div>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 4px;">Potência Máxima Registada</div>
                            <div id="potencia-maxima-display" style="font-size: 1.5rem; font-weight: 700; color: #0f172a;">-- kW</div>
                            <div id="potencia-maxima-legenda" style="font-size: 0.75rem; color: #94a3b8;">
                                (Médias de 15 min)
                            </div>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 4px;">Utilização da Potência</div>
                            <div id="potencia-utilizacao-display" style="font-size: 1.5rem; font-weight: 700; color: #0f172a;">-- %</div>
                        </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" id="chk-trifasico" onchange="atualizarAnalisePotencia()">
                            <span>A minha instalação é Trifásica</span>
                            
                            <i class="fa-solid fa-circle-question" 
                            style="color: var(--text-light); cursor: help; font-size: 0.9em;"
                            onmouseenter="showTooltipNome(event, 'Instalação Trifásica', 'Selecione esta opção se a sua instalação for trifásica. Neste caso o valor de potência será estimado.')" 
                            onmouseleave="hideTooltip()">
                            </i>
                        </label>
                    </div>
                    <div id="potencia-recomendacao" style="padding: 12px; border-radius: 8px; background: #f1f5f9;">
                    </div>
                </div>
            </div>

            <!-- Resumo da Simulação -->
            <div id="resumo-simulacao" style="background-color:#f9f9f9; border:1px solid #ddd; border-radius:10px; margin-bottom:25px; color:#333; display:none;">
                <div style="cursor:pointer; padding:15px; display:flex; justify-content:space-between; align-items:center;" onclick="toggleResumo()">
                    <h5 style="margin:0; color:#333; font-size: 0.95rem;">Resumo da Simulação</h5>
                    <i id="resumo-icon" class="fa-solid fa-chevron-down" style="color:#333;"></i>
                </div>
                <div id="resumo-content" style="padding:0 15px 15px 15px;">
                    <ul style="list-style-type:none; padding-left:0;" id="resumo-list"></ul>
                </div>
            </div>

            <!-- Subtítulo e Descrições -->
            <div style="margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
                    <h4 id="titulo-tabela" style="margin-bottom:0; color:var(--text-main);">Tiago Felícia - Tarifários de Eletricidade - Detalhado</h4>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button id="btn-partilhar" onclick="gerarLinkPartilha()" style="display:none; padding:6px 14px; border:1px solid var(--primary); background:white; color:var(--primary); border-radius:8px; cursor:pointer; font-size:0.8rem; font-weight:600; transition:all 0.2s;" onmouseover="this.style.background='var(--primary)';this.style.color='white'" onmouseout="this.style.background='white';this.style.color='var(--primary)'">
                            <i class="fa-solid fa-link"></i> Partilhar Simulação
                        </button>
                        <div class="export-wrapper">
                            <button id="btn-exportar" onclick="toggleExportMenu()" style="display:none; padding:6px 14px; border:1px solid #16a34a; background:white; color:#16a34a; border-radius:8px; cursor:pointer; font-size:0.8rem; font-weight:600; transition:all 0.2s;" onmouseover="this.style.background='#16a34a';this.style.color='white'" onmouseout="if(!document.querySelector('.export-dropdown.open')){this.style.background='white';this.style.color='#16a34a'}">
                                <i class="fa-solid fa-file-excel"></i> Exportar Excel <i class="fa-solid fa-caret-down" style="margin-left:4px;"></i>
                            </button>
                            <div class="export-dropdown" id="export-dropdown">
                                <button onclick="exportarExcel(null); fecharExportMenu()"><i class="fa-solid fa-list"></i> <span id="exp-all">Todos</span></button>
                                <div class="sep"></div>
                                <button id="exp-opt-20" onclick="exportarExcel(20); fecharExportMenu()" style="display:none"><i class="fa-solid fa-arrow-up-1-9"></i> Primeiros 20</button>
                                <button id="exp-opt-40" onclick="exportarExcel(40); fecharExportMenu()" style="display:none"><i class="fa-solid fa-arrow-up-1-9"></i> Primeiros 40</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="font-size:0.9rem; color:var(--text-light); line-height:1.5;">
                </div>
            </div>

            <!-- Mensagem de Poupança -->
            <div id="mensagem-poupanca" style="margin-bottom:15px; display:none;"></div>

            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:10px;">
                <div id="res-count" style="font-weight:600; color:var(--text-light);">0 tarifas</div>
                <div style="font-size:0.75rem; color:var(--text-light)">Total com Valores Finais (todos os componentes, taxas e impostos). Valores unitários de Energia e Potência sem IVA.</div>
            </div>

            <div class="table-wrap">
                <table id="tabela">
                    <thead id="thead"></thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
            <div id="support-section" style="margin-top: 40px; margin-bottom: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                <h3 style="color: var(--text-main); margin-bottom: 12px;">💖 Apoie este Projeto</h3>

                <p style="color: var(--text-main); margin-bottom: 16px; line-height: 1.6;">
                    Se quiser apoiar a manutenção do site e o desenvolvimento contínuo deste simulador, 
                    pode fazê-lo através de uma das seguintes formas:
                </p>

                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="font-size: 1rem;">
                        ☕ <a href="https://buymeacoffee.com/tiagofelicia" target="_blank" style="color: var(--primary); font-weight: 600; text-decoration: none;">
                            Compre-me um café em BuyMeACoffee
                        </a>
                    </div>

                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <span style="color: var(--text-main);">ou através do botão PayPal:</span>
                        
                        <form action="https://www.paypal.com/donate" method="post" target="_blank" style="display: inline-block; margin: 0;">
                            <input type="hidden" name="hosted_button_id" value="W6KZHVL53VFJC">
                            <input type="image" src="https://www.paypalobjects.com/pt_PT/PT/i/btn/btn_donate_SM.gif" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Faça donativos com o botão PayPal" style="vertical-align: middle;">
                            <img alt="" border="0" src="https://www.paypal.com/pt_PT/i/scr/pixel.gif" width="1" height="1">
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tooltip" class="tooltip hidden"></div>

    <script>

        !function(){const e="file:"===window.location.protocol,t=["www.tiagofelicia.pt","tiagofelicia.pt","127.0.0.1","localhost"].includes(window.location.hostname);e||t||(document.body.innerHTML="<h1 style='text-align:center; margin-top:50px;'>⚠️ Cópia não autorizada.<br>Aceda à versão oficial em <a href='https://www.tiagofelicia.pt'>www.tiagofelicia.pt</a></h1>",window.location.href="https://www.tiagofelicia.pt")}();const FILENAME="https://huggingface.co/spaces/tiagofelicia/simulador-tarifarios-eletricidade/resolve/main/Tarifarios_%F0%9F%94%8C_Eletricidade_Tiago_Felicia.xlsx",CSV_BASE="https://huggingface.co/spaces/tiagofelicia/simulador-tarifarios-eletricidade/resolve/main/data/csv",CSV_FILES=["Constantes","Tarifarios_fixos","Indexados","OMIE_PERDAS_CICLOS"];let DATA={fixos:[],indexados:[],omie:[],constantes:{},perdas:{}},SORT={col:"total",asc:!0},OMIE_VALUES={S:0,V:0,F:0,P:0,C:0},OMIE_MANUAL=!1,CURRENT_TAB="quick",LAST_EXPORT_DATA=null,QUICK_PARAMS={kwh:158,power:3.45,usagePattern:"balanced",tariffType:"all",cycle:"simples",excludedProviders:[]},SNAPSHOT_ABA2={hasData:!1,consumos:{},periodo:{},origem:"manual"},STATE_ABA2={potencia:3.45,ciclo:"Simples",dataInicio:null,dataFim:null,consumos:{S:158,V:63,F:95,C:68,P:27},omieValues:{S:0,V:0,F:0,P:0,C:0},omieManual:!1,excludedProviders:[],meuTarifario:{ativo:!1,collapsed:!0},tarifarioPersonalizado:{ativo:!1,collapsed:!0,valores:{}},modoComparacao:!1},STATE_ABA3={potencia:3.45,ciclo:"Simples",dataInicio:null,dataFim:null,consumos:{S:0,V:0,F:0,C:0,P:0},omieValues:{S:0,V:0,F:0,P:0,C:0},omieManual:!1,excludedProviders:[],dadosERedes:null,ficheiroProcessado:!1,meuTarifario:{ativo:!1,collapsed:!0},tarifarioPersonalizado:{ativo:!1,collapsed:!0,valores:{}},modoComparacao:!1};const CAV_FIXO_COMERCIALIZADORES=["CUR","EDP","Galp","Goldenergy","Ibelectra","Iberdrola","Luzigás","Plenitude","YesEnergy"];function getDataReferencia(e){const t=DATA.constantes[e];if(!t)return null;if("number"==typeof t&&"undefined"!=typeof XLSX&&XLSX.SSF){const e=XLSX.SSF.parse_date_code(t);return new Date(e.y,e.m-1,e.d)}if("string"==typeof t){const e=parseDateFromDB(t);if(e)return new Date(e)}return null}function atualizarDatasReferencia(){const e=getDataReferencia("Data_Valores_OMIE"),t=getDataReferencia("Data_Valores_OMIP"),o=document.getElementById("datas-ref-faq");if(!o)return;const a=e=>e?e.toLocaleDateString("pt-PT"):'<span style="color:#d9534f;">(Não encontrado)</span>',n=`\n            <div style="background-color: #d9edf7; padding: 15px; border-left: 5px solid #31708f; border-radius: 4px; color: #31708f; font-size: 0.95rem; margin-top: 20px; margin-bottom: 20px;">\n                <div style="font-weight:bold; margin-bottom:8px; font-size: 0.95rem;">\n                    <i class="fa-solid fa-calendar-days"></i> Datas de Referência dos Valores de Mercado\n                </div>\n                <div style="margin-bottom: 4px;">• Valores OMIE (SPOT) reais até: <b>${a(e)}</b></div>\n                <div>• Valores OMIP (Futuros) atualizados em: <b>${a(t)}</b></div>\n            </div>\n        `;o.innerHTML=n}function verificarIncluiFuturosOMIP(){const e=document.getElementById("d_inicio"),t=document.getElementById("d_fim");if(!(e&&t&&e.value&&t.value))return!1;const o=getDataReferencia("Data_Valores_OMIE");if(!o)return!1;const a=t.value.split("-");return new Date(parseInt(a[0]),parseInt(a[1])-1,parseInt(a[2]))>o}function atualizarLabelsOMIE(){const e=verificarIncluiFuturosOMIP(),t=document.getElementById("omie-label-titulo");t&&(t.textContent=e?"Média OMIE / OMIP (com Futuros)":"Média OMIE (valor Final)")}function switchTab(e){const t=CURRENT_TAB;"complete"===t&&guardarEstadoAba2(),"advanced"===t&&guardarEstadoAba3(),CURRENT_TAB=e,document.getElementById("tab-quick").classList.remove("active"),document.getElementById("app").classList.add("hidden"),document.getElementById("tab-faq").classList.add("hidden");const o=document.getElementById("eredes-upload-central");if(o&&o.classList.add("hidden"),document.querySelectorAll(".tab-button").forEach(e=>e.classList.remove("active")),"quick"===e)document.getElementById("tab-quick").classList.add("active"),document.querySelectorAll(".tab-button")[0].classList.add("active");else if("complete"===e){if("quick"===t){STATE_ABA2.potencia=QUICK_PARAMS.power,"simples"===QUICK_PARAMS.cycle?STATE_ABA2.ciclo="Simples":"bi"===QUICK_PARAMS.cycle?STATE_ABA2.ciclo="Bi-horário - Ciclo Diário":"tri"===QUICK_PARAMS.cycle&&(STATE_ABA2.ciclo="Tri-horário - Ciclo Diário"),STATE_ABA2.dataInicio=document.getElementById("d_inicio").value,STATE_ABA2.dataFim=document.getElementById("d_fim").value,STATE_ABA2.omieValues={...OMIE_VALUES},STATE_ABA2.omieManual=OMIE_MANUAL;const e=QUICK_PARAMS.kwh;if("simples"===QUICK_PARAMS.cycle)STATE_ABA2.consumos={S:e,V:0,F:0,C:0,P:0};else if("bi"===QUICK_PARAMS.cycle){const t="night"===QUICK_PARAMS.usagePattern?.6:.4;STATE_ABA2.consumos={S:0,V:Math.round(e*t),F:Math.round(e*(1-t)),C:0,P:0}}else if("tri"===QUICK_PARAMS.cycle){const t="night"===QUICK_PARAMS.usagePattern?.6:.25,o=.15,a=1-t-o;STATE_ABA2.consumos={S:0,V:Math.round(e*t),F:0,C:Math.round(e*a),P:Math.round(e*o)}}}document.getElementById("app").classList.remove("hidden"),document.querySelectorAll(".tab-button")[1].classList.add("active");const e=document.getElementById("analise-consumos");e&&(e.style.display="none");const o=document.getElementById("graficos-analise-eredes");o&&(o.style.display="none");const a=document.getElementById("analise-potencia");a&&(a.style.display="none");const n=document.getElementById("grafico-omie-container");n&&(n.style.display="block");const i=document.getElementById("eredes-section-wrapper");i&&(i.style.display="none");const l=document.getElementById("content-consumo");if(l){l.classList.remove("hidden");const e=document.querySelector("[onclick=\"toggleSection('consumo')\"]");e&&(e.style.display="")}document.getElementById("d_inicio").disabled=!1,document.getElementById("d_fim").disabled=!1,document.getElementById("d_inicio").min="2025-01-01",document.getElementById("d_inicio").max="2026-12-31",document.getElementById("d_fim").min="2025-01-01",document.getElementById("d_fim").max="2026-12-31",["kwh_S","kwh_V","kwh_F","kwh_C","kwh_P"].forEach(e=>{const t=document.getElementById(e);t&&(t.disabled=!1)});const s=document.getElementById("filter-providers-aba2");s&&(s.style.display="block");const r=document.getElementById("filter-providers-aba3");r&&(r.style.display="none"),restaurarMeuTarifarioAba(2),restaurarTarifarioPersonalizadoAba(2),restaurarModoComparacaoAba(2),restaurarEstadoAba2()}else if("advanced"===e)if(document.querySelectorAll(".tab-button")[2].classList.add("active"),STATE_ABA3.ficheiroProcessado){document.getElementById("app").classList.remove("hidden");const e=document.getElementById("analise-consumos");e&&DADOS_EREDES&&(e.style.display="block");const t=document.getElementById("graficos-analise-eredes");t&&(t.style.display="block");const o=document.getElementById("analise-potencia");o&&(o.style.display="block");const a=document.getElementById("grafico-omie-container");a&&(a.style.display="none");const n=document.getElementById("eredes-section-wrapper");n&&(n.style.display="block");const i=document.querySelector("[onclick=\"toggleSection('consumo')\"]");i&&(i.style.display="none");const l=document.getElementById("content-consumo");l&&l.classList.add("hidden");const s=document.getElementById("filter-providers-aba2");s&&(s.style.display="none");const r=document.getElementById("filter-providers-aba3");r&&(r.style.display="block"),restaurarMeuTarifarioAba(3),restaurarTarifarioPersonalizadoAba(3),restaurarModoComparacaoAba(3),restaurarEstadoAba3()}else{const e=document.getElementById("eredes-upload-central");e&&e.classList.remove("hidden"),document.getElementById("app").classList.add("hidden")}else if("faq"===e){const e=document.getElementById("tab-faq");e.classList.remove("hidden"),e.classList.add("active"),document.querySelectorAll(".tab-button")[3].classList.add("active")}}function guardarEstadoAba2(){STATE_ABA2.potencia=parseFloat(document.getElementById("potencia").value),STATE_ABA2.ciclo=document.getElementById("ciclo").value,STATE_ABA2.dataInicio=document.getElementById("d_inicio").value,STATE_ABA2.dataFim=document.getElementById("d_fim").value,STATE_ABA2.omieValues={...OMIE_VALUES},STATE_ABA2.omieManual=OMIE_MANUAL,["S","V","F","C","P"].forEach(e=>{const t=document.getElementById("kwh_"+e);t&&(STATE_ABA2.consumos[e]=parseFloat(t.value)||0)});const e=document.getElementById("meu_ativo");if(e){STATE_ABA2.meuTarifario.ativo=e.checked;const t=document.getElementById("meu-inputs");t&&(STATE_ABA2.meuTarifario.html=t.innerHTML),STATE_ABA2.meuTarifario.collapsed=document.getElementById("content-meu").classList.contains("collapsed")}const t=document.getElementById("pers_ativo");if(t){STATE_ABA2.tarifarioPersonalizado.ativo=t.checked,STATE_ABA2.tarifarioPersonalizado.collapsed=document.getElementById("content-personalizado").classList.contains("collapsed"),STATE_ABA2.tarifarioPersonalizado.valores={};const e=document.getElementById("pers_energia_s"),o=document.getElementById("pers_potencia_s");e&&(STATE_ABA2.tarifarioPersonalizado.valores.energia_s=parseFloat(e.value)||0),o&&(STATE_ABA2.tarifarioPersonalizado.valores.potencia_s=parseFloat(o.value)||0);const a=document.getElementById("pers_energia_v_bi"),n=document.getElementById("pers_energia_f_bi"),i=document.getElementById("pers_potencia_bi");a&&(STATE_ABA2.tarifarioPersonalizado.valores.energia_v_bi=parseFloat(a.value)||0),n&&(STATE_ABA2.tarifarioPersonalizado.valores.energia_f_bi=parseFloat(n.value)||0),i&&(STATE_ABA2.tarifarioPersonalizado.valores.potencia_bi=parseFloat(i.value)||0);const l=document.getElementById("pers_energia_v_tri"),s=document.getElementById("pers_energia_c_tri"),r=document.getElementById("pers_energia_p_tri"),c=document.getElementById("pers_potencia_tri");l&&(STATE_ABA2.tarifarioPersonalizado.valores.energia_v_tri=parseFloat(l.value)||0),s&&(STATE_ABA2.tarifarioPersonalizado.valores.energia_c_tri=parseFloat(s.value)||0),r&&(STATE_ABA2.tarifarioPersonalizado.valores.energia_p_tri=parseFloat(r.value)||0),c&&(STATE_ABA2.tarifarioPersonalizado.valores.potencia_tri=parseFloat(c.value)||0);const d=document.getElementById("pers_tar_energia"),u=document.getElementById("pers_tar_potencia"),m=document.getElementById("pers_tse_incluido");d&&(STATE_ABA2.tarifarioPersonalizado.valores.tar_energia=d.checked),u&&(STATE_ABA2.tarifarioPersonalizado.valores.tar_potencia=u.checked),m&&(STATE_ABA2.tarifarioPersonalizado.valores.tse_incluido=m.checked)}const o=document.getElementById("modo_comparacao");o&&(STATE_ABA2.modoComparacao=o.checked)}function restaurarEstadoAba2(){if(STATE_ABA2.dataInicio){document.getElementById("potencia").value=STATE_ABA2.potencia,document.getElementById("ciclo").value=STATE_ABA2.ciclo,document.getElementById("d_inicio").value=STATE_ABA2.dataInicio,document.getElementById("d_fim").value=STATE_ABA2.dataFim,OMIE_VALUES={...STATE_ABA2.omieValues},OMIE_MANUAL=STATE_ABA2.omieManual,atualizarDias(),construirInputsConsumo();const e=STATE_ABA2.ciclo;if(e.includes("Simples")){const e=document.getElementById("kwh_S");e&&STATE_ABA2.consumos.S&&(e.value=STATE_ABA2.consumos.S)}else if(e.includes("Bi")){const e=document.getElementById("kwh_V"),t=document.getElementById("kwh_F");e&&STATE_ABA2.consumos.V&&(e.value=STATE_ABA2.consumos.V),t&&STATE_ABA2.consumos.F&&(t.value=STATE_ABA2.consumos.F)}else{const e=document.getElementById("kwh_V"),t=document.getElementById("kwh_P"),o=document.getElementById("kwh_C");e&&STATE_ABA2.consumos.V&&(e.value=STATE_ABA2.consumos.V),t&&STATE_ABA2.consumos.P&&(t.value=STATE_ABA2.consumos.P),o&&STATE_ABA2.consumos.C&&(o.value=STATE_ABA2.consumos.C)}calcular()}}function guardarEstadoAba3(){STATE_ABA3.potencia=parseFloat(document.getElementById("potencia").value),STATE_ABA3.ciclo=document.getElementById("ciclo").value,STATE_ABA3.dataInicio=document.getElementById("d_inicio").value,STATE_ABA3.dataFim=document.getElementById("d_fim").value,STATE_ABA3.omieValues={...OMIE_VALUES},STATE_ABA3.omieManual=OMIE_MANUAL;const e=document.getElementById("meu_ativo");if(e){STATE_ABA3.meuTarifario.ativo=e.checked;const t=document.getElementById("meu-inputs");t&&(STATE_ABA3.meuTarifario.html=t.innerHTML),STATE_ABA3.meuTarifario.collapsed=document.getElementById("content-meu").classList.contains("collapsed")}const t=document.getElementById("pers_ativo");if(t){STATE_ABA3.tarifarioPersonalizado.ativo=t.checked,STATE_ABA3.tarifarioPersonalizado.collapsed=document.getElementById("content-personalizado").classList.contains("collapsed"),STATE_ABA3.tarifarioPersonalizado.valores={};const e=document.getElementById("pers_energia_s"),o=document.getElementById("pers_potencia_s");e&&(STATE_ABA3.tarifarioPersonalizado.valores.energia_s=parseFloat(e.value)||0),o&&(STATE_ABA3.tarifarioPersonalizado.valores.potencia_s=parseFloat(o.value)||0);const a=document.getElementById("pers_energia_v_bi"),n=document.getElementById("pers_energia_f_bi"),i=document.getElementById("pers_potencia_bi");a&&(STATE_ABA3.tarifarioPersonalizado.valores.energia_v_bi=parseFloat(a.value)||0),n&&(STATE_ABA3.tarifarioPersonalizado.valores.energia_f_bi=parseFloat(n.value)||0),i&&(STATE_ABA3.tarifarioPersonalizado.valores.potencia_bi=parseFloat(i.value)||0);const l=document.getElementById("pers_energia_v_tri"),s=document.getElementById("pers_energia_c_tri"),r=document.getElementById("pers_energia_p_tri"),c=document.getElementById("pers_potencia_tri");l&&(STATE_ABA3.tarifarioPersonalizado.valores.energia_v_tri=parseFloat(l.value)||0),s&&(STATE_ABA3.tarifarioPersonalizado.valores.energia_c_tri=parseFloat(s.value)||0),r&&(STATE_ABA3.tarifarioPersonalizado.valores.energia_p_tri=parseFloat(r.value)||0),c&&(STATE_ABA3.tarifarioPersonalizado.valores.potencia_tri=parseFloat(c.value)||0);const d=document.getElementById("pers_tar_energia"),u=document.getElementById("pers_tar_potencia"),m=document.getElementById("pers_tse_incluido");d&&(STATE_ABA3.tarifarioPersonalizado.valores.tar_energia=d.checked),u&&(STATE_ABA3.tarifarioPersonalizado.valores.tar_potencia=u.checked),m&&(STATE_ABA3.tarifarioPersonalizado.valores.tse_incluido=m.checked)}const o=document.getElementById("modo_comparacao");o&&(STATE_ABA3.modoComparacao=o.checked)}function restaurarEstadoAba3(){if(STATE_ABA3.dataInicio){if(document.getElementById("potencia").value=STATE_ABA3.potencia,document.getElementById("ciclo").value=STATE_ABA3.ciclo,DADOS_EREDES&&DADOS_EREDES.periodo){const e=DADOS_EREDES.periodo.inicio,t=DADOS_EREDES.periodo.fim,o=document.getElementById("d_inicio"),a=document.getElementById("d_fim");o.min=e,o.max=t,a.min=e,a.max=t,o.value=STATE_ABA3.dataInicio<e||STATE_ABA3.dataInicio>t?e:STATE_ABA3.dataInicio,a.value=STATE_ABA3.dataFim>t||STATE_ABA3.dataFim<e?t:STATE_ABA3.dataFim}else document.getElementById("d_inicio").value=STATE_ABA3.dataInicio,document.getElementById("d_fim").value=STATE_ABA3.dataFim;OMIE_VALUES={...STATE_ABA3.omieValues},OMIE_MANUAL=STATE_ABA3.omieManual,atualizarDias(),construirInputsConsumo()}}function restaurarMeuTarifarioAba(e){const t=2===e?STATE_ABA2:STATE_ABA3,o=document.getElementById("meu_ativo"),a=document.getElementById("meu-inputs"),n=document.getElementById("content-meu");o&&(o.checked=t.meuTarifario.ativo,t.meuTarifario.ativo&&t.meuTarifario.html?(a.innerHTML=t.meuTarifario.html,a.classList.remove("hidden")):a.classList.add("hidden")),n&&(t.meuTarifario.collapsed?n.classList.add("collapsed"):n.classList.remove("collapsed"))}function restaurarTarifarioPersonalizadoAba(e){const t=2===e?STATE_ABA2:STATE_ABA3,o=document.getElementById("pers_ativo"),a=document.getElementById("content-personalizado");if(o&&(o.checked=t.tarifarioPersonalizado.ativo,t.tarifarioPersonalizado.ativo)){toggleTarifarioPersonalizado();const e=t.tarifarioPersonalizado.valores;if(e){const t=document.getElementById("pers_energia_s"),o=document.getElementById("pers_potencia_s");t&&void 0!==e.energia_s&&(t.value=e.energia_s),o&&void 0!==e.potencia_s&&(o.value=e.potencia_s);const a=document.getElementById("pers_energia_v_bi"),n=document.getElementById("pers_energia_f_bi"),i=document.getElementById("pers_potencia_bi");a&&void 0!==e.energia_v_bi&&(a.value=e.energia_v_bi),n&&void 0!==e.energia_f_bi&&(n.value=e.energia_f_bi),i&&void 0!==e.potencia_bi&&(i.value=e.potencia_bi);const l=document.getElementById("pers_energia_v_tri"),s=document.getElementById("pers_energia_c_tri"),r=document.getElementById("pers_energia_p_tri"),c=document.getElementById("pers_potencia_tri");l&&void 0!==e.energia_v_tri&&(l.value=e.energia_v_tri),s&&void 0!==e.energia_c_tri&&(s.value=e.energia_c_tri),r&&void 0!==e.energia_p_tri&&(r.value=e.energia_p_tri),c&&void 0!==e.potencia_tri&&(c.value=e.potencia_tri);const d=document.getElementById("pers_tar_energia"),u=document.getElementById("pers_tar_potencia"),m=document.getElementById("pers_tse_incluido");d&&void 0!==e.tar_energia&&(d.checked=e.tar_energia),u&&void 0!==e.tar_potencia&&(u.checked=e.tar_potencia),m&&void 0!==e.tse_incluido&&(m.checked=e.tse_incluido)}}a&&(t.tarifarioPersonalizado.collapsed?a.classList.add("collapsed"):a.classList.remove("collapsed"))}function restaurarModoComparacaoAba(e){const t=2===e?STATE_ABA2:STATE_ABA3,o=document.getElementById("modo_comparacao");o&&(o.checked=t.modoComparacao)}function autoCalculate(){QUICK_PARAMS.kwh=parseFloat(document.getElementById("quick-kwh").value)||158,document.querySelectorAll(".price-button").forEach(e=>e.classList.remove("selected")),runQuickSimulation()}function selectPrice(e){let t,o;document.querySelectorAll(".price-button").forEach(e=>e.classList.remove("selected")),document.getElementById(`price-${e}`).classList.add("selected"),40===e?(t=158,o=3.45):100===e?(t=333,o=6.9):200===e&&(t=908,o=13.8),QUICK_PARAMS.kwh=t,QUICK_PARAMS.power=o,document.getElementById("quick-kwh").value=t,document.querySelectorAll(".power-button").forEach(e=>e.classList.remove("selected"));const a=Array.from(document.querySelectorAll(".power-button")).find(e=>parseFloat(e.textContent)===o);a&&a.classList.add("selected"),runQuickSimulation()}function selectPower(e){document.querySelectorAll(".power-button").forEach(e=>e.classList.remove("selected")),event.target.classList.add("selected"),QUICK_PARAMS.power=e,document.querySelectorAll(".price-button").forEach(e=>e.classList.remove("selected")),runQuickSimulation()}function selectUsagePattern(e){document.querySelectorAll("#usage-balanced, #usage-night").forEach(e=>e.classList.remove("selected")),document.getElementById(`usage-${e}`).classList.add("selected"),QUICK_PARAMS.usagePattern=e,"simples"!==QUICK_PARAMS.cycle&&"bi"!==QUICK_PARAMS.cycle||(QUICK_PARAMS.cycle="balanced"===e?"simples":"bi",updateCycleButtons()),runQuickSimulation()}function selectTariffType(e){document.querySelectorAll("#tariff-all, #tariff-fixed").forEach(e=>e.classList.remove("selected")),document.getElementById(`tariff-${e}`).classList.add("selected"),QUICK_PARAMS.tariffType=e,runQuickSimulation()}function selectCycle(e){QUICK_PARAMS.cycle=e,updateCycleButtons(),runQuickSimulation()}function updateCycleButtons(){document.querySelectorAll("#cycle-simples, #cycle-bi, #cycle-tri").forEach(e=>e.classList.remove("selected")),document.getElementById(`cycle-${QUICK_PARAMS.cycle}`).classList.add("selected")}function toggleQuickSettings(){const e=document.getElementById("quick-settings-content"),t=document.getElementById("quick-settings-icon");e.classList.contains("hidden")?(e.classList.remove("hidden"),t.className="fa-solid fa-chevron-up"):(e.classList.add("hidden"),t.className="fa-solid fa-chevron-down")}function showUpdateNotice(){const e=document.createElement("div");e.className="update-notice",e.innerHTML='<i class="fa-solid fa-check"></i> Parâmetros atualizados',e.style.display="flex",document.body.appendChild(e),setTimeout(()=>{e.style.opacity="0",setTimeout(()=>e.remove(),300)},1500)}function runQuickSimulation(){document.getElementById("potencia").value=QUICK_PARAMS.power;const e=document.getElementById("ciclo");"simples"===QUICK_PARAMS.cycle?e.value="Simples":"bi"===QUICK_PARAMS.cycle?e.value="Bi-horário - Ciclo Diário":"tri"===QUICK_PARAMS.cycle&&(e.value="Tri-horário - Ciclo Diário"),construirInputsConsumo(),"simples"===QUICK_PARAMS.cycle?document.getElementById("kwh_S").value=QUICK_PARAMS.kwh:"bi"===QUICK_PARAMS.cycle?(document.getElementById("kwh_V").value=Math.round(.6*QUICK_PARAMS.kwh),document.getElementById("kwh_F").value=Math.round(.4*QUICK_PARAMS.kwh)):"tri"===QUICK_PARAMS.cycle&&(document.getElementById("kwh_V").value=Math.round(.6*QUICK_PARAMS.kwh),document.getElementById("kwh_C").value=Math.round(.25*QUICK_PARAMS.kwh),document.getElementById("kwh_P").value=Math.round(.15*QUICK_PARAMS.kwh)),calcular(),setTimeout(()=>{displayPodium()},200)}function displayPodium(){if(!window.GLOBAL_RESULTS||0===window.GLOBAL_RESULTS.length)return void renderEmptyPodium();let e=window.GLOBAL_RESULTS.filter(e=>!("Utilizador"===e.tipo||"Personalizado"===e.com||"fixed"===QUICK_PARAMS.tariffType&&e.tipo.toLowerCase().includes("indexado")||QUICK_PARAMS.excludedProviders.some(t=>e.com===t)));if(0===e.length)return void renderEmptyPodium();e.sort((e,t)=>e.total-t.total);const t=e.slice(0,3),o=["🥇","🥈","🥉"],a=["first","second","third"];let n="";for(let e=0;e<3;e++)if(e<t.length){const i=t[e],l=0===e?0:i.total-t[0].total,s=i.tipo.toLowerCase().includes("indexado")?'<span style="font-size:0.65rem; background:#dbeafe; color:#1e40af; padding:2px 6px; border-radius:4px;">Indexado</span>':'<span style="font-size:0.65rem; background:#dcfce7; color:#166534; padding:2px 6px; border-radius:4px;">Fixo</span>';n+=`\n                        <div class="podium-item ${a[e]}">\n                            <div class="podium-medal">${o[e]}</div>\n                            <div class="podium-name">${i.com}</div>\n                            <div style="font-size:0.8rem; color:#64748b; margin-bottom:5px; height:34px; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">${i.nome}</div>\n                            ${s}\n                            <div class="podium-price">${i.total.toFixed(2)}€<span style="font-size: 0.5em; color:#64748b; font-weight:400;">/mês</span></div>\n                            ${0===e?'<div style="color: var(--success); font-size: 0.75rem; margin-top: 4px; font-weight:600;">✓ Melhor oferta</div>':`<div style="color: #dc2626; font-size: 0.75rem; margin-top: 4px;">+${l.toFixed(0)}€ / mês</div>`}\n                        </div>\n                    `}else n+=`\n                        <div class="podium-item ${a[e]}" style="opacity: 0.5; background:#f1f5f9;">\n                            <div class="podium-medal" style="filter:grayscale(1);">${o[e]}</div>\n                            <div class="podium-name" style="color:#94a3b8;">---</div>\n                            <div class="podium-price" style="color:#cbd5e1;">-</div>\n                        </div>\n                    `;document.getElementById("podium").innerHTML=n}function renderEmptyPodium(){document.getElementById("podium").innerHTML='\n                <div class="podium-item second" style="opacity: 0.3;"><div class="podium-medal">🥈</div><div class="podium-name">...</div><div class="podium-price">-</div></div>\n                <div class="podium-item first" style="opacity: 0.3;"><div class="podium-medal">🥇</div><div class="podium-name">...</div><div class="podium-price">-</div></div>\n                <div class="podium-item third" style="opacity: 0.3;"><div class="podium-medal">🥉</div><div class="podium-name">...</div><div class="podium-price">-</div></div>\n            '}function populateProviderFilters(){try{const e=document.getElementById("provider-filters");if(!e)return;if(void 0===DATA||!DATA.fixos||!DATA.indexados)return void console.warn("Aguardando dados para filtros...");"undefined"==typeof excludedProviders&&(window.excludedProviders=[]);const t=DATA.fixos||[],o=DATA.indexados||[],a=t.concat(o),n=[...new Set(a.filter(e=>e&&e.comercializador).map(e=>e.comercializador))].sort();e.innerHTML="",n.forEach(t=>{const o=document.createElement("label");o.style.cssText="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; transition: background 0.2s;";const a=document.createElement("input");a.type="checkbox",a.style.width="14px",a.style.height="14px",a.checked=-1!==excludedProviders.indexOf(t),a.onchange=function(){if(this.checked)-1===excludedProviders.indexOf(t)&&excludedProviders.push(t);else{const e=excludedProviders.indexOf(t);e>-1&&excludedProviders.splice(e,1)}const e=document.getElementById("provider-filters_ALL");e&&(e.checked=n.length>0&&excludedProviders.length===n.length),calcular()};const i=document.createElement("span");i.textContent=t,o.appendChild(a),o.appendChild(i),o.onmouseenter=function(){this.style.background="#f1f5f9"},o.onmouseleave=function(){this.style.background="white"},e.appendChild(o)});const i=document.createElement("label");i.style.cssText="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: #fff5f5; border: 1px solid #fecaca; border-radius: 6px; font-size: 0.85rem; color: #dc2626; font-weight: bold; transition: background 0.2s;";const l=document.createElement("input");l.type="checkbox",l.id="provider-filters_ALL",l.style.width="14px",l.style.height="14px",l.style.accentColor="#dc2626",l.checked=n.length>0&&excludedProviders.length===n.length,l.onchange=function(){if(this.checked)n.forEach(e=>{-1===excludedProviders.indexOf(e)&&excludedProviders.push(e)});else for(;excludedProviders.length>0;)excludedProviders.pop();populateProviderFilters(),calcular()};const s=document.createElement("span");s.textContent="Selecionar Todos",i.appendChild(l),i.appendChild(s),i.onmouseenter=function(){this.style.background="#fee2e2"},i.onmouseleave=function(){this.style.background="#fff5f5"},e.appendChild(i)}catch(e){console.error("Erro ao gerar filtros:",e)}}function toggleProvider(e){const t=QUICK_PARAMS.excludedProviders.indexOf(e);t>-1?QUICK_PARAMS.excludedProviders.splice(t,1):QUICK_PARAMS.excludedProviders.push(e),runQuickSimulation()}function copyToSnapshotAba2(){DADOS_EREDES&&(SNAPSHOT_ABA2={hasData:!0,consumos:{...DADOS_EREDES.consumosAgregados},periodo:{...DADOS_EREDES.periodo},origem:"eredes"})}const COLS_FIXO={pot:"potencia_kva",ciclo:"opcao_horaria_e_ciclo",tipo:"tipo",fixo:"preco_potencia_dia",pS:"preco_energia_simples",pV_bi:"preco_energia_vazio_bi",pF:"preco_energia_fora_vazio",pV_tri:"preco_energia_vazio_tri",pP:"preco_energia_ponta",pC:"preco_energia_cheias",tar_e_incl:"tar_incluida_energia",tar_p_incl:"tar_incluida_potencia",tse_incl:"financiamento_tse_incluido",desc_fat:"desconto_fatura_mes",desc_limit:"desconto_meses_limite",seg:"segmento",fat:"faturacao",pag:"pagamento",site:"site_adesao",notas:"notas"},COLS_INDEX={pot:"potencia_kva",ciclo:"opcao_horaria_e_ciclo",tipo:"tipo",fixo:"preco_potencia_dia",tar_e_incl:"tar_incluida_energia",tar_p_incl:"tar_incluida_potencia",tse_incl:"financiamento_tse_incluido",desc_fat:"desconto_fatura_mes",desc_limit:"desconto_meses_limite",seg:"segmento",fat:"faturacao",pag:"pagamento",site:"site_adesao",notas:"notas"};function parseDateFromDB(e){if(null==e)return null;if("number"==typeof e&&"undefined"!=typeof XLSX&&XLSX.SSF){const t=XLSX.SSF.parse_date_code(e);return`${t.y}-${String(t.m).padStart(2,"0")}-${String(t.d).padStart(2,"0")}`}let t=String(e).trim().split(" ")[0];if(t.includes("/")){const e=t.split("/");if(3===e.length){if(4===e[2].length){const t=e[0].padStart(2,"0"),o=e[1].padStart(2,"0");return`${e[2]}-${t}-${o}`}if(4===e[0].length)return`${e[0]}-${e[1].padStart(2,"0")}-${e[2].padStart(2,"0")}`}}return null}function getYMD(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function toggleSection(e){const t=document.getElementById("content-"+e),o=document.getElementById("icon-"+e),a=t.classList.contains("collapsed");t.classList.toggle("collapsed"),o.className=a?"fa-solid fa-chevron-down":"fa-solid fa-chevron-right"}function toggleSidebar(){const e=document.getElementById("sidebar-panel"),t=document.getElementById("sidebar-overlay");e&&t&&(e.classList.toggle("open"),t.classList.toggle("active"),document.body.style.overflow=e.classList.contains("open")?"hidden":"")}function toggleProviderFilterAba2(){const e=document.getElementById("content-filter-providers-aba2"),t=document.getElementById("icon-filter-providers-aba2");e.classList.toggle("collapsed"),t.className=e.classList.contains("collapsed")?"fa-solid fa-chevron-down":"fa-solid fa-chevron-up"}function toggleProviderFilterAba3(){const e=document.getElementById("content-filter-providers-aba3"),t=document.getElementById("icon-filter-providers-aba3");e.classList.toggle("collapsed"),t.className=e.classList.contains("collapsed")?"fa-solid fa-chevron-down":"fa-solid fa-chevron-up"}function toggleGraficoOmie(){const e=document.getElementById("grafico-omie-content"),t=document.getElementById("grafico-omie-icon"),o=e.classList.contains("collapsed");e.classList.toggle("collapsed"),t.className=e.classList.contains("collapsed")?"fa-solid fa-chevron-down":"fa-solid fa-chevron-up",o&&gerarGraficoOMIEDiario()}function toggleGraficosAnalise(){const e=document.getElementById("graficos-analise-content"),t=document.getElementById("graficos-analise-icon"),o=e.classList.contains("collapsed");e.classList.toggle("collapsed"),t.className=e.classList.contains("collapsed")?"fa-solid fa-chevron-down":"fa-solid fa-chevron-up",o&&DADOS_EREDES&&gerarGraficosAnaliseERedes()}function toggleAnalisePotencia(){const e=document.getElementById("analise-potencia-content"),t=document.getElementById("analise-potencia-icon");e.classList.toggle("collapsed"),t.className=e.classList.contains("collapsed")?"fa-solid fa-chevron-down":"fa-solid fa-chevron-up"}function populateProviderFiltersAbas(){const e=new Set;DATA.fixos.forEach(t=>{t.comercializador&&e.add(t.comercializador)}),DATA.indexados.forEach(t=>{t.comercializador&&e.add(t.comercializador)});const t=Array.from(e).sort(),o=(e,a,n)=>{const i=document.getElementById(e);if(!i)return;i.innerHTML="",t.forEach(o=>{const l=document.createElement("label");l.style.cssText="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; transition: background 0.2s;";const s=document.createElement("input");s.type="checkbox",s.style.width="14px",s.style.height="14px",s.checked=a.excludedProviders.includes(o),s.onchange=()=>{s.checked?a.excludedProviders.includes(o)||a.excludedProviders.push(o):a.excludedProviders=a.excludedProviders.filter(e=>e!==o);const i=document.getElementById(e+"_ALL");i&&(i.checked=a.excludedProviders.length===t.length),CURRENT_TAB===n&&calcular()};const r=document.createElement("span");r.textContent=o,l.appendChild(s),l.appendChild(r),l.onmouseover=()=>l.style.background="#f1f5f9",l.onmouseout=()=>l.style.background="white",i.appendChild(l)});const l=document.createElement("label");l.style.cssText="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: #fff5f5; border: 1px solid #fecaca; border-radius: 6px; font-size: 0.85rem; color: #dc2626; font-weight: bold; transition: background 0.2s;";const s=document.createElement("input");s.type="checkbox",s.id=e+"_ALL",s.style.width="14px",s.style.height="14px",s.style.accentColor="#dc2626",s.checked=t.length>0&&a.excludedProviders.length===t.length,s.onchange=()=>{s.checked?a.excludedProviders=[...t]:a.excludedProviders=[],o(e,a,n),CURRENT_TAB===n&&calcular()};const r=document.createElement("span");r.textContent="Selecionar Todos",l.appendChild(s),l.appendChild(r),l.onmouseover=()=>l.style.background="#fee2e2",l.onmouseout=()=>l.style.background="#fff5f5",i.appendChild(l)};o("provider-filters-aba2",STATE_ABA2,"complete"),o("provider-filters-aba3",STATE_ABA3,"advanced")}function toggleProviderAba2(e){const t=STATE_ABA2.excludedProviders.indexOf(e);t>-1?STATE_ABA2.excludedProviders.splice(t,1):STATE_ABA2.excludedProviders.push(e),"complete"===CURRENT_TAB&&calcular()}function toggleProviderAba3(e){const t=STATE_ABA3.excludedProviders.indexOf(e);t>-1?STATE_ABA3.excludedProviders.splice(t,1):STATE_ABA3.excludedProviders.push(e),"advanced"===CURRENT_TAB&&calcular()}async function processarFicheirosERedesCentral(){const e=document.getElementById("file-eredes-central"),t=document.getElementById("eredes-status-central");if(e.files&&0!==e.files.length){t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> A processar ficheiros...';try{const o=[];for(let a=0;a<e.files.length;a++){const n=e.files[a];t.innerHTML=`<i class="fa-solid fa-spinner fa-spin"></i> A processar ${n.name} (${a+1}/${e.files.length})...`;const i=await processarFicheiroERedes(n);if(i.erro)return void(t.innerHTML=`<span style="color:red;">❌ Erro: ${i.erro}</span>`);o.push(i.dados)}const a=validarEJuntarFicheiros(o);if(a.erro)return void(t.innerHTML=`<span style="color:red;">❌ ${a.erro}</span>`);const n=agregarConsumosPorPeriodo(a.dados),i=calcularMediasOMIE(a.dados),l=a.dados[0],s=a.dados[a.dados.length-1],r=l.DataHora.split("T")[0],c=s.DataHora.split("T")[0],d=new Date(r),u=new Date(c),m=Math.floor((u-d)/864e5)+1;let p=a.avisoAntigos?"⚠️ Dados anteriores a 2025 foram descartados (sem dados OMIE)":"";DADOS_EREDES={dadosBrutos:a.dados,consumosAgregados:n,mediasOMIE:i,periodo:{inicio:r,fim:c,dias:m}},STATE_ABA3.ficheiroProcessado=!0,STATE_ABA3.dataInicio=r,STATE_ABA3.dataFim=c,STATE_ABA3.dadosERedes=DADOS_EREDES,calcularPotenciaMaxima(),document.getElementById("eredes-upload-central").classList.add("hidden"),document.getElementById("app").classList.remove("hidden"),switchTab("advanced"),aplicarDadosERedes(),document.getElementById("eredes-upload").style.display="none",document.getElementById("eredes-limpar").style.display="block";const g=e=>e.split("-").reverse().join("/");document.getElementById("eredes-resumo").innerHTML=`\n                    <b>${e.files.length} ficheiro(s):</b> ${g(r)} a ${g(c)} (${m} dias)\n                    ${p?`<br><span style="color:#d97706;">${p}</span>`:""}\n                `,mostrarTabelaAnaliseERedes(),calcular()}catch(e){console.error("Erro ao processar ficheiros:",e),t.innerHTML=`<span style="color:red;">❌ Erro: ${e.message}</span>`}}else t.innerHTML='<span style="color:red;">⚠️ Selecione pelo menos um ficheiro Excel</span>'}function calcularPotenciaMaxima(){if(!DADOS_EREDES||!DADOS_EREDES.dadosBrutos)return;let e=0;DADOS_EREDES.dadosBrutos.forEach(t=>{t.Potencia_kW&&t.Potencia_kW>e&&(e=t.Potencia_kW)}),DADOS_EREDES.potenciaMaxima=e}function atualizarAnalisePotencia(){if(!DADOS_EREDES||!DADOS_EREDES.potenciaMaxima)return;const e=parseFloat(document.getElementById("potencia").value)||3.45;let t=DADOS_EREDES.potenciaMaxima;const o=document.getElementById("chk-trifasico")?.checked||!1;let a="";o&&(a=" (trifásico)");const n=e>0?t/e*100:0;document.getElementById("potencia-contratada-display").textContent=`${e} kVA`,document.getElementById("potencia-maxima-display").innerHTML=`${t.toFixed(3)} kW<span style="font-size: 0.75rem; color: #94a3b8;">${a}</span>`,document.getElementById("potencia-utilizacao-display").textContent=`${n.toFixed(1)} %`;const i=document.getElementById("potencia-maxima-legenda");i&&(i.innerHTML=o?'(Médias de 15 min) (estimativa para 3 fases)\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'Instalação Trifásica\', \'Dado que é uma instalação trifásica, a potência elétrica é distribuída por três fases, sendo o valor da potência máxima tomada a soma das três fases.\')" \n                        onmouseleave="hideTooltip()">\n                        </i>':"(Médias de 15 min)");let l="",s="#f1f5f9";n>100?(l=`🔴 <strong>Atenção:</strong> A sua Potência Máxima Registada (${t.toFixed(2)} kW) ultrapassa a sua potência contratada. Considere aumentar a potência.`,s="#fef2f2"):n>85?(l="✅ <strong>Adequado:</strong> A sua potência contratada parece bem dimensionada.",s="#f0fdf4"):n>60?(l="💡 <strong>Oportunidade de Poupança:</strong> A sua Potência Máxima Registada utiliza entre 60% e 85% da potência contratada. Pode ser possível reduzir a potência.",s="#fffbeb"):(l="💰 <strong>Forte Oportunidade de Poupança:</strong> A sua Potência Máxima Registada utiliza menos de 60% da sua potência contratada. É muito provável que possa reduzir a potência e poupar na fatura.",s="#fef3c7"),document.getElementById("potencia-recomendacao").style.background=s,document.getElementById("potencia-recomendacao").innerHTML=l}async function gerarGraficoOMIEDiario(){await loadHighcharts();const e=document.getElementById("d_inicio").value,t=document.getElementById("d_fim").value,o=document.getElementById("ciclo").value;if(!DATA.omie||0===DATA.omie.length)return;let a=getDataReferencia("Data_Valores_OMIE");a||(a=new Date),a.setHours(0,0,0,0);const n={S:"#FF0000",V:"#000000",F:"#FFC000",C:"#2F5597",P:"#00B050"},i={S:"circle",V:"diamond",F:"square",C:"triangle",P:"triangle-down"};let l="Simp",s=["S"],r={S:"Simples"};o.includes("Bi")?(l=o.includes("Diário")?"BD":"BS",s=["V","F"],r={V:"Vazio",F:"Fora Vazio"}):o.includes("Tri")&&(l=o.includes("Diário")?"TD":"TS",s=["V","C","P"],r={V:"Vazio",C:"Cheias",P:"Ponta"});const c={};DATA.omie.forEach(o=>{const a=parseDateFromDB(o.Data);if(!a||a<e||a>t)return;const n=parseFloat(String(o.OMIE).replace(",","."))||0;if(c[a]||(c[a]={S:{sum:0,count:0}},s.forEach(e=>{c[a][e]={sum:0,count:0}})),c[a].S.sum+=n,c[a].S.count++,"Simp"!==l){const e=o[l];e&&c[a][e]&&(c[a][e].sum+=n,c[a][e].count++)}});const d=Object.keys(c).sort(),u=d.map(e=>e.split("-").reverse().slice(0,2).join("/"));let m=[];("Simp"===l?["S"]:s).forEach(e=>{const t=[],o=[];d.forEach(n=>{const i=new Date(n);i.setHours(0,0,0,0);const l=c[n][e],s=l&&l.count>0?Math.round(l.sum/l.count*100)/100:null;i<=a?(t.push(s),o.push(null)):(t.push(null),o.push(s))});const l=n[e]||"#333",s=i[e]||"circle";m.push({name:r[e]+" Spot",data:t,color:l,type:"line",lineWidth:2,marker:{enabled:!0,symbol:s,radius:4,lineWidth:1,lineColor:l,fillColor:l},connectNulls:!1}),m.push({name:r[e]+" Futuros",data:o,color:l,dashStyle:"Dot",type:"line",lineWidth:2,marker:{enabled:!0,symbol:s,radius:4,lineWidth:2,lineColor:l,fillColor:"white"},connectNulls:!1,showInLegend:!0})}),"undefined"!=typeof Highcharts&&Highcharts.chart("chart-omie-diario",{chart:{zoomType:"x",height:350},title:{text:`Evolução Diária OMIE/OMIP - ${o}`,align:"center"},subtitle:{text:"Linha contínua: Spot (OMIE) | Linha tracejada: Futuros (OMIP)",align:"center",style:{fontSize:"0.85rem",color:"#666"}},xAxis:{categories:u,crosshair:!0},yAxis:{title:{text:"Preço Médio (€/MWh)"},plotLines:[{value:0,width:1,color:"#cccccc"}]},legend:{enabled:!0,layout:"horizontal",align:"center",verticalAlign:"bottom",symbolRadius:0},tooltip:{shared:!0,valueSuffix:" €/MWh",crosshairs:!0},plotOptions:{line:{connectNulls:!1,states:{hover:{lineWidthPlus:0}}}},series:m})}function getCicloInfo(e){const t=e.toLowerCase();let o=null,a=[],n="Simples",i=!0;return t.includes("bi")?(i=t.includes("diário"),o=i?"BD":"BS",a=["V","F"],n=i?"Bi-Horário - Ciclo Diário":"Bi-Horário - Ciclo Semanal"):t.includes("tri")&&(i=t.includes("diário"),o=i?"TD":"TS",a=["V","C","P"],n=i?"Tri-Horário - Ciclo Diário":"Tri-Horário - Ciclo Semanal"),{colCiclo:o,periodos:a,tituloCiclo:n,nomesPeriodos:{V:"Vazio",F:"Fora Vazio",C:"Cheias",P:"Ponta"},coresConsumo:i?{V_bi:"#A9D18E",V_tri:"#BF9000",F:"#E2EFDA",C:"#FFE699",P:"#FFF2CC"}:{V_bi:"#8FAADC",V_tri:"#C55A11",F:"#DAE3F3",C:"#F4B183",P:"#FBE5D6"},coresOmie:{S:"#FF0000",V:"#000000",F:"#FFC000",C:"#2F5597",P:"#00B050"},isDiario:i,ohLower:t}}function classificarPeriodo(e,t){if(!t||!DATA.omieMap)return null;const o=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),l=String(e.getMinutes()).padStart(2,"0");let s=DATA.omieMap.get(`${o}-${a}-${n}_${i}:${l}`);return s||"00"===l||(s=DATA.omieMap.get(`${o}-${a}-${n}_${i}:00`)),s&&s[t]?s[t]:null}async function gerarGraficosAnaliseERedes(){if(await loadHighcharts(),!DADOS_EREDES||!DADOS_EREDES.dadosBrutos)return;const e=document.getElementById("ciclo").value,t=document.getElementById("d_inicio").value,o=document.getElementById("d_fim").value,a=DADOS_EREDES.dadosBrutos.filter(e=>{const a=e.DataHora.split("T")[0];return a>=t&&a<=o});0!==a.length&&(gerarGraficoHorario(a,e),gerarGraficoDiario(a,e),gerarGraficoSemana(a,e),gerarGraficoMensal(a,e))}function gerarGraficoHorario(e,t){const o=getCicloInfo(t),a={};for(let e=0;e<24;e++)a[e]={consumo:0,omieSum:0,omieCount:0},o.colCiclo&&o.periodos.forEach(t=>{a[e][t]={consumo:0,omieSum:0,omieCount:0}});e.forEach(e=>{const t=new Date(e.DataHora);let n=t.getHours();0===t.getMinutes()&&(n-=1),n<0&&(n=23);const i=e["Consumo (kWh)"];a[n].consumo+=i;const l=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0"),c=String(t.getHours()).padStart(2,"0"),d=String(t.getMinutes()).padStart(2,"0");let u=`${l}-${s}-${r}_${c}:${d}`,m=DATA.omieMap?.get(u);if(!m&&"00"===c&&"00"===d){const e=new Date(t);e.setMinutes(e.getMinutes()-1);const o=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}_23:59`;m=DATA.omieMap?.get(o)}const p=m&&parseFloat(String(m.OMIE).replace(",","."))||0;if(m&&(a[n].omieSum+=p,a[n].omieCount++),o.colCiclo&&m){const e=m[o.colCiclo];e&&a[n][e]&&(a[n][e].consumo+=i,a[n][e].omieSum+=p,a[n][e].omieCount++)}});const n=Array.from({length:24},(e,t)=>`${t}h-${t+1}h`),i=[];if(o.colCiclo)[...o.periodos].reverse().forEach(e=>{const t="V"===e&&o.ohLower.startsWith("tri")?"V_tri":"V"===e?"V_bi":e,n=Object.values(a).map(t=>{const o=t[e]?Math.round(100*t[e].consumo)/100:0,a=t[e]&&t[e].omieCount>0?t[e].omieCount:1;return{y:o,media:Math.round(o/a*100)/100}});i.push({name:`Consumo ${o.nomesPeriodos[e]} (kWh)`,type:"column",data:n,yAxis:0,color:o.coresConsumo[t]})});else{const t=e.length>0?new Set(e.map(e=>e.DataHora.split("T")[0])).size:1,o=Object.values(a).map(e=>({y:Math.round(100*e.consumo)/100,media:Math.round(e.consumo/Math.max(t,1)*100)/100}));i.push({name:"Consumo Total (kWh)",type:"column",data:o,yAxis:0,color:"#BFBFBF"})}i.push({name:"Média OMIE (€/MWh)",type:"line",data:Object.values(a).map(e=>e.omieCount>0?Math.round(e.omieSum/e.omieCount*100)/100:null),yAxis:1,color:o.coresOmie.S,tooltip:{valueSuffix:" €/MWh"}}),o.colCiclo&&o.periodos.forEach(e=>{i.push({name:`Média OMIE ${o.nomesPeriodos[e]} (€/MWh)`,type:"line",data:Object.values(a).map(t=>t[e]&&t[e].omieCount>0?Math.round(t[e].omieSum/t[e].omieCount*100)/100:null),yAxis:1,color:o.coresOmie[e],visible:!1,tooltip:{valueSuffix:" €/MWh"}})}),"undefined"!=typeof Highcharts&&Highcharts.chart("chart-horario",{chart:{zoomType:"xy"},title:{text:`Consumo e Preço Médio OMIE por Hora (${o.tituloCiclo})`,align:"left"},xAxis:[{categories:n,crosshair:!0}],yAxis:[{labels:{format:"{value} kWh"},title:{text:"Consumo (kWh)"}},{title:{text:"Preço OMIE (€/MWh)"},labels:{format:"{value} €/MWh"},opposite:!0}],legend:{align:"left",verticalAlign:"top",y:40,floating:!0,backgroundColor:"white"},plotOptions:{column:{stacking:"normal"}},tooltip:{shared:!0,formatter:function(){let e="<b>"+this.x+"</b>",t=!1;return this.points.forEach(function(o){o.y>0&&(e+="<br/>"+o.series.name+": <b>"+o.y.toFixed(2)+"</b>",void 0!==o.point.options.media&&(e+=' <span style="font-size:0.9em">(Média: '+o.point.options.media.toFixed(2)+")</span>")),"column"===o.series.type&&"normal"===o.series.options.stacking&&(t=!0)}),t&&void 0!==this.total&&this.total>0&&(e+="<br/>--------------------",e+="<br/><b>Total Consumo: "+this.total.toFixed(2)+" kWh</b>"),e}},series:i})}function gerarGraficoDiario(e,t){const o=getCicloInfo(t),a={};e.forEach(e=>{const t=e.DataHora.split("T")[0];a[t]||(a[t]={consumo:0,omieSum:0,omieCount:0},o.colCiclo&&o.periodos.forEach(e=>{a[t][e]={consumo:0,omieSum:0,omieCount:0}}));const n=e["Consumo (kWh)"];a[t].consumo+=n;const i=new Date(e.DataHora),l=String(i.getHours()).padStart(2,"0"),s=String(i.getMinutes()).padStart(2,"0"),r=DATA.omieMap?.get(`${t}_${l}:${s}`)||DATA.omieMap?.get(`${t}_${l}:00`);if(r){const e=parseFloat(String(r.OMIE).replace(",","."))||0;if(a[t].omieSum+=e,a[t].omieCount++,o.colCiclo){const i=r[o.colCiclo];i&&a[t][i]&&(a[t][i].consumo+=n,a[t][i].omieSum+=e,a[t][i].omieCount++)}}});const n=Object.keys(a).sort(),i=n.map(e=>e.split("-").reverse().slice(0,2).join("/")),l=[];o.colCiclo?[...o.periodos].reverse().forEach(e=>{const t="V"===e&&o.ohLower.startsWith("tri")?"V_tri":"V"===e?"V_bi":e,i=n.map(t=>{const o=a[t][e]?Math.round(100*a[t][e].consumo)/100:0;return{y:o,media:o}});l.push({name:`Consumo ${o.nomesPeriodos[e]} (kWh)`,type:"column",data:i,yAxis:0,color:o.coresConsumo[t]})}):l.push({name:"Consumo Total (kWh)",type:"column",data:n.map(e=>({y:Math.round(100*a[e].consumo)/100,media:Math.round(100*a[e].consumo)/100})),yAxis:0,color:"#BFBFBF"}),l.push({name:"Média OMIE (€/MWh)",type:"line",data:n.map(e=>a[e].omieCount>0?Math.round(a[e].omieSum/a[e].omieCount*100)/100:null),yAxis:1,color:o.coresOmie.S,tooltip:{valueSuffix:" €/MWh"}}),o.colCiclo&&o.periodos.forEach(e=>{l.push({name:`Média OMIE ${o.nomesPeriodos[e]} (€/MWh)`,type:"line",data:n.map(t=>a[t][e]&&a[t][e].omieCount>0?Math.round(a[t][e].omieSum/a[t][e].omieCount*100)/100:null),yAxis:1,color:o.coresOmie[e],visible:!1,tooltip:{valueSuffix:" €/MWh"}})}),"undefined"!=typeof Highcharts&&Highcharts.chart("chart-diario",{chart:{zoomType:"xy"},title:{text:`Consumo e Preço Médio OMIE Diário (${o.tituloCiclo})`,align:"left"},xAxis:[{categories:i,crosshair:!0}],yAxis:[{labels:{format:"{value} kWh"},title:{text:"Consumo (kWh)"}},{title:{text:"Média OMIE (€/MWh)"},labels:{format:"{value} €/MWh"},opposite:!0}],legend:{align:"left",verticalAlign:"top",y:40,floating:!0,backgroundColor:"white"},plotOptions:{column:{stacking:"normal"}},tooltip:{shared:!0,formatter:function(){let e="<b>"+this.x+"</b>",t=!1;return this.points.forEach(function(o){o.y>0&&(e+="<br/>"+o.series.name+": <b>"+o.y.toFixed(2)+"</b>",void 0!==o.point.options.media&&(e+=' <span style="font-size:0.9em">(Média: '+o.point.options.media.toFixed(2)+")</span>")),"column"===o.series.type&&"normal"===o.series.options.stacking&&(t=!0)}),t&&void 0!==this.total&&this.total>0&&(e+="<br/>--------------------",e+="<br/><b>Total Consumo: "+this.total.toFixed(2)+" kWh</b>"),e}},series:l})}function gerarGraficoSemana(e,t){const o=getCicloInfo(t),a={};for(let e=0;e<7;e++)a[e]={consumo:0,omieSum:0,omieCount:0,dias:new Set},o.colCiclo&&o.periodos.forEach(t=>{a[e][t]={consumo:0,omieSum:0,omieCount:0}});e.forEach(e=>{const t=new Date(e.DataHora),n=(t.getDay()+6)%7,i=e.DataHora.split("T")[0],l=e["Consumo (kWh)"];a[n].consumo+=l,a[n].dias.add(i);const s=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0"),c=DATA.omieMap?.get(`${i}_${s}:${r}`)||DATA.omieMap?.get(`${i}_${s}:00`);if(c){const e=parseFloat(String(c.OMIE).replace(",","."))||0;if(a[n].omieSum+=e,a[n].omieCount++,o.colCiclo){const t=c[o.colCiclo];t&&a[n][t]&&(a[n][t].consumo+=l,a[n][t].omieSum+=e,a[n][t].omieCount++)}}});const n=[];if(o.colCiclo)[...o.periodos].reverse().forEach(e=>{const t="V"===e&&o.ohLower.startsWith("tri")?"V_tri":"V"===e?"V_bi":e,i=[];for(let t=0;t<7;t++){const o=a[t][e]?Math.round(100*a[t][e].consumo)/100:0,n=a[t].dias.size||1;i.push({y:o,media:Math.round(o/n*100)/100})}n.push({name:`Consumo ${o.nomesPeriodos[e]} (kWh)`,type:"column",data:i,yAxis:0,color:o.coresConsumo[t]})});else{const e=[];for(let t=0;t<7;t++){const o=Math.round(100*a[t].consumo)/100,n=a[t].dias.size||1;e.push({y:o,media:Math.round(o/n*100)/100})}n.push({name:"Consumo Total (kWh)",type:"column",data:e,yAxis:0,color:"#BFBFBF"})}n.push({name:"Média OMIE (€/MWh)",type:"line",data:Array.from({length:7},(e,t)=>a[t].omieCount>0?Math.round(a[t].omieSum/a[t].omieCount*100)/100:null),yAxis:1,color:o.coresOmie.S,tooltip:{valueSuffix:" €/MWh"}}),o.colCiclo&&o.periodos.forEach(e=>{n.push({name:`Média OMIE ${o.nomesPeriodos[e]} (€/MWh)`,type:"line",data:Array.from({length:7},(t,o)=>a[o][e]&&a[o][e].omieCount>0?Math.round(a[o][e].omieSum/a[o][e].omieCount*100)/100:null),yAxis:1,color:o.coresOmie[e],visible:!1,tooltip:{valueSuffix:" €/MWh"}})}),"undefined"!=typeof Highcharts&&Highcharts.chart("chart-semana",{chart:{zoomType:"xy"},title:{text:`Consumo e Preço Médio OMIE por Dia da Semana (${o.tituloCiclo})`,align:"left"},xAxis:[{categories:["Segunda","Terça","Quarta","Quinta","Sexta","Sábado","Domingo"],crosshair:!0}],yAxis:[{labels:{format:"{value} kWh"},title:{text:"Consumo Total (kWh)"}},{title:{text:"Média OMIE (€/MWh)"},labels:{format:"{value} €/MWh"},opposite:!0}],legend:{align:"left",verticalAlign:"top",y:40,floating:!0,backgroundColor:"white"},plotOptions:{column:{stacking:"normal"}},tooltip:{shared:!0,formatter:function(){let e="<b>"+this.x+"</b>",t=!1;return this.points.forEach(function(o){o.y>0&&(e+="<br/>"+o.series.name+": <b>"+o.y.toFixed(2)+"</b>",void 0!==o.point.options.media&&(e+=' <span style="font-size:0.9em">(Média: '+o.point.options.media.toFixed(2)+")</span>")),"column"===o.series.type&&"normal"===o.series.options.stacking&&(t=!0)}),t&&void 0!==this.total&&this.total>0&&(e+="<br/>--------------------",e+="<br/><b>Total Consumo: "+this.total.toFixed(2)+" kWh</b>"),e}},series:n})}function gerarGraficoMensal(e,t){const o=getCicloInfo(t),a={};e.forEach(e=>{const t=e.DataHora.split("T")[0].split("-"),n=`${t[0]}-${t[1]}`;a[n]||(a[n]={consumo:0,omieSum:0,omieCount:0},o.colCiclo&&o.periodos.forEach(e=>{a[n][e]={consumo:0,omieSum:0,omieCount:0}}));const i=e["Consumo (kWh)"];a[n].consumo+=i;const l=new Date(e.DataHora),s=String(l.getHours()).padStart(2,"0"),r=String(l.getMinutes()).padStart(2,"0"),c=e.DataHora.split("T")[0],d=DATA.omieMap?.get(`${c}_${s}:${r}`)||DATA.omieMap?.get(`${c}_${s}:00`);if(d){const e=parseFloat(String(d.OMIE).replace(",","."))||0;if(a[n].omieSum+=e,a[n].omieCount++,o.colCiclo){const t=d[o.colCiclo];t&&a[n][t]&&(a[n][t].consumo+=i,a[n][t].omieSum+=e,a[n][t].omieCount++)}}});const n=Object.keys(a).sort(),i=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"],l=n.map(e=>{const t=e.split("-"),o=t[0],a=parseInt(t[1])-1;return`${i[a]} ${o}`}),s=[];o.colCiclo?[...o.periodos].reverse().forEach(e=>{const t="V"===e&&o.ohLower.startsWith("tri")?"V_tri":"V"===e?"V_bi":e,i=n.map(t=>{const o=a[t][e]?Math.round(100*a[t][e].consumo)/100:0;return{y:o,media:o}});s.push({name:`Consumo ${o.nomesPeriodos[e]} (kWh)`,type:"column",data:i,yAxis:0,color:o.coresConsumo[t]})}):s.push({name:"Consumo Total (kWh)",type:"column",data:n.map(e=>({y:Math.round(100*a[e].consumo)/100,media:Math.round(100*a[e].consumo)/100})),yAxis:0,color:"#BFBFBF"}),s.push({name:"Média OMIE (€/MWh)",type:"line",data:n.map(e=>a[e].omieCount>0?Math.round(a[e].omieSum/a[e].omieCount*100)/100:null),yAxis:1,color:o.coresOmie.S,tooltip:{valueSuffix:" €/MWh"}}),o.colCiclo&&o.periodos.forEach(e=>{s.push({name:`Média OMIE ${o.nomesPeriodos[e]} (€/MWh)`,type:"line",data:n.map(t=>a[t][e]&&a[t][e].omieCount>0?Math.round(a[t][e].omieSum/a[t][e].omieCount*100)/100:null),yAxis:1,color:o.coresOmie[e],visible:!1,tooltip:{valueSuffix:" €/MWh"}})}),"undefined"!=typeof Highcharts&&Highcharts.chart("chart-mensal",{chart:{zoomType:"xy"},title:{text:`Consumo Mensal vs. Preço Médio OMIE (${o.tituloCiclo})`,align:"left"},xAxis:[{categories:l,crosshair:!0}],yAxis:[{labels:{format:"{value} kWh"},title:{text:"Consumo Total (kWh)"}},{title:{text:"Média Mensal OMIE (€/MWh)"},labels:{format:"{value} €/MWh"},opposite:!0}],legend:{align:"left",verticalAlign:"top",y:40,floating:!0,backgroundColor:"white"},plotOptions:{column:{stacking:"normal"}},tooltip:{shared:!0,formatter:function(){let e="<b>"+this.x+"</b>",t=!1;return this.points.forEach(function(o){o.y>0&&(e+="<br/>"+o.series.name+": <b>"+o.y.toFixed(2)+"</b>"),"column"===o.series.type&&"normal"===o.series.options.stacking&&(t=!0)}),t&&void 0!==this.total&&this.total>0&&(e+="<br/>--------------------",e+="<br/><b>Total Consumo: "+this.total.toFixed(2)+" kWh</b>"),e}},series:s})}function mostrarTabelaAnaliseERedes(){if(!DADOS_EREDES)return;const e=document.getElementById("analise-content"),t=document.getElementById("analise-consumos");if(!e||!t)return;t.style.display="block";const o=DADOS_EREDES.consumosAgregados,a=DADOS_EREDES.mediasOMIE||{};let n='\n            <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">\n                <thead>\n                    <tr style="background: #f8fafc;">\n                        <th style="padding: 10px; border: 1px solid #e2e8f0; text-align: left;">Período</th>\n                        <th style="padding: 10px; border: 1px solid #e2e8f0; text-align: right;">Consumo (kWh)</th>\n                        <th style="padding: 10px; border: 1px solid #e2e8f0; text-align: right;">% Total</th>\n                        <th style="padding: 10px; border: 1px solid #e2e8f0; text-align: right;">Média OMIE (€/MWh)</th>\n                    </tr>\n                </thead>\n                <tbody>\n            ';const i=o.Simples||0;if(n+=`<tr style="background: #f9f9f9; font-weight: 600;">\n                <td style="padding: 8px; border: 1px solid #e2e8f0;">Total (Simples)</td>\n                <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${i.toFixed(2)}</td>\n                <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">100%</td>\n                <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${(a.S||0).toFixed(2)}</td>\n            </tr>`,o.BD&&(o.BD.V||o.BD.F)){const e=o.BD.V||0,t=o.BD.F||0;n+=`\n                <tr><td colspan="4" style="padding: 8px; border: 1px solid #e2e8f0; background: #A9D08E; font-weight: 600;">Bi-Horário Diário</td></tr>\n                <tr>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; padding-left: 20px;">Vazio</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${e.toFixed(2)}</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${i>0?(e/i*100).toFixed(1):0}%</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${(a.BD_V||0).toFixed(2)}</td>\n                </tr>\n                <tr>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; padding-left: 20px;">Fora Vazio</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${t.toFixed(2)}</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${i>0?(t/i*100).toFixed(1):0}%</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${(a.BD_F||0).toFixed(2)}</td>\n                </tr>`}if(o.TD&&(o.TD.V||o.TD.C||o.TD.P)){const e=o.TD.V||0,t=o.TD.C||0,l=o.TD.P||0;n+=`\n                <tr><td colspan="4" style="padding: 8px; border: 1px solid #e2e8f0; background: #BF8F00; color: white; font-weight: 600;">Tri-Horário Diário</td></tr>\n                <tr>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; padding-left: 20px;">Vazio</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${e.toFixed(2)}</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${i>0?(e/i*100).toFixed(1):0}%</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${(a.TD_V||0).toFixed(2)}</td>\n                </tr>\n                <tr>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; padding-left: 20px;">Cheias</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${t.toFixed(2)}</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${i>0?(t/i*100).toFixed(1):0}%</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${(a.TD_C||0).toFixed(2)}</td>\n                </tr>\n                <tr>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; padding-left: 20px;">Ponta</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${l.toFixed(2)}</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${i>0?(l/i*100).toFixed(1):0}%</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${(a.TD_P||0).toFixed(2)}</td>\n                </tr>`}n+="</tbody></table>",e.innerHTML=n}function autoCollapse(e){setTimeout(()=>{const t=document.getElementById("content-"+e),o=document.getElementById("icon-"+e);t.classList.contains("collapsed")||(t.classList.add("collapsed"),o.className="fa-solid fa-chevron-right")},800)}function getDefaultDates(){const e=new Date,t=new Date(e);t.setDate(e.getDate()+1);const o=new Date(t),a=t.getDate();return o.setMonth(o.getMonth()+1),o.getDate()!==a&&o.setDate(0),o.setDate(o.getDate()-1),{start:getYMD(t),end:getYMD(o)}}const DB_NAME="SimuladorTarifarios",DB_STORE="cache",CACHE_KEY="tarifarios_csv_v2",CACHE_DURATION=432e5,MANIFEST_URL=`${CSV_BASE}/manifest.json`;function openCacheDB(){return new Promise((e,t)=>{const o=indexedDB.open(DB_NAME,2);o.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("cache")||t.createObjectStore("cache")},o.onsuccess=t=>e(t.target.result),o.onerror=()=>t()})}async function getCacheEntry(){try{const e=await openCacheDB();return new Promise(t=>{const o=e.transaction("cache","readonly").objectStore("cache").get(CACHE_KEY);o.onsuccess=()=>t(o.result||null),o.onerror=()=>t(null)})}catch(e){return null}}async function saveCacheEntry(e){try{(await openCacheDB()).transaction("cache","readwrite").objectStore("cache").put(e,CACHE_KEY)}catch(e){}}async function fetchManifest(){const e=await fetch(MANIFEST_URL,{cache:"no-store"});if(!e.ok)throw new Error(`Manifest: ${e.status}`);return e.json()}async function loadPapaParse(){if("undefined"!=typeof Papa)return;const e=["https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js","https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js","https://unpkg.com/papaparse@5.4.1/papaparse.min.js"];for(const t of e)try{if(await new Promise((e,o)=>{const a=document.createElement("script");a.src=t,a.crossOrigin="anonymous",a.onload=e,a.onerror=()=>o(new Error(`Falha CDN: ${t}`)),document.head.appendChild(a)}),"undefined"!=typeof Papa)return}catch(e){console.warn(e.message)}throw new Error("PapaParse indisponivel em todos os CDNs")}async function fetchCSV(e){await loadPapaParse();const t=await fetch(`${CSV_BASE}/${e}.csv`);if(!t.ok)throw new Error(`CSV ${e}: ${t.status}`);const o=await t.text();return Papa.parse(o,{header:!0,skipEmptyLines:!0,dynamicTyping:"OMIE_PERDAS_CICLOS"!==e}).data}async function loadSheetJS(){if("undefined"==typeof XLSX)return new Promise((e,t)=>{const o=document.createElement("script");o.src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js",o.onload=e,o.onerror=()=>t(new Error("Falha ao carregar SheetJS")),document.head.appendChild(o)})}async function loadExcelJS(){if("undefined"==typeof ExcelJS)return new Promise((e,t)=>{const o=document.createElement("script");o.src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js",o.onload=e,o.onerror=()=>t(new Error("Falha ao carregar ExcelJS")),document.head.appendChild(o)})}async function loadHighcharts(){if("undefined"==typeof Highcharts)return new Promise((e,t)=>{const o=document.createElement("script");o.src="https://code.highcharts.com/highcharts.js",o.onload=e,o.onerror=()=>t(new Error("Falha ao carregar Highcharts")),document.head.appendChild(o)})}function setLoaderMsg(e){const t=document.getElementById("loader-msg");t&&(t.textContent=e)}function lerArquivoManual(e){const t=e.files[0];if(t){const e=new FileReader;e.onload=e=>loadData(e.target.result),e.readAsArrayBuffer(t)}}function getKeyDate(e){return parseDateFromDB(e)||"INVALID"}function getKeyTime(e){if(null==e)return"00:00";if("number"==typeof e){const t=Math.round(24*e*60),o=Math.floor(t/60),a=t%60;return`${String(o).padStart(2,"0")}:${String(a).padStart(2,"0")}`}const t=String(e).trim().split(":");return t.length>=2?`${t[0].padStart(2,"0")}:${t[1].padStart(2,"0")}`:"00:00"}function applyParsedData(e){e.Constantes&&e.Constantes.forEach(e=>{DATA.constantes[e.constante]=e["valor_unitário"]}),DATA.fixos=e.Tarifarios_fixos||[],DATA.indexados=e.Indexados||[],e.OMIE_PERDAS_CICLOS&&(DATA.omie=e.OMIE_PERDAS_CICLOS,buildOmieMap())}function buildOmieMap(){DATA.omieMap=new Map,DATA.omie.forEach(e=>{const t=parseDateFromDB(e.Data);let o="00:00";if("number"==typeof e.Hora){const t=Math.round(1440*e.Hora);o=`${Math.floor(t/60).toString().padStart(2,"0")}:${(t%60).toString().padStart(2,"0")}`}else if(e.Hora){const t=String(e.Hora).trim().split(":");t.length>=2&&(o=`${t[0].padStart(2,"0")}:${t[1].padStart(2,"0")}`)}t&&DATA.omieMap.set(`${t}_${o}`,e)})}function loadData(e){const t=XLSX.read(e,{type:"array"});t.Sheets.Constantes&&XLSX.utils.sheet_to_json(t.Sheets.Constantes).forEach(e=>{DATA.constantes[e.constante]=e.valor_unitário}),DATA.fixos=XLSX.utils.sheet_to_json(t.Sheets.Tarifarios_fixos||t.Sheets[t.SheetNames[0]]),t.Sheets.Indexados&&(DATA.indexados=XLSX.utils.sheet_to_json(t.Sheets.Indexados)),t.Sheets.OMIE_PERDAS_CICLOS&&(DATA.omie=XLSX.utils.sheet_to_json(t.Sheets.OMIE_PERDAS_CICLOS,{raw:!1}),buildOmieMap()),afterDataLoaded()}function afterDataLoaded(){document.getElementById("loader").classList.add("hidden"),document.getElementById("tabs-wrapper").classList.remove("hidden"),document.getElementById("tab-quick").classList.remove("hidden"),atualizarMenusCiclo(),populateProviderFilters(),populateProviderFiltersAbas();const e=getDefaultDates();STATE_ABA2.dataInicio=e.start,STATE_ABA2.dataFim=e.end,runQuickSimulation(),atualizarDatasReferencia(),aplicarParametrosPartilha()&&setTimeout(()=>aplicarSharedParamsDepoisDeCarregar(),500)}function atualizarDias(){const e=new Date(document.getElementById("d_inicio").value),t=new Date(document.getElementById("d_fim").value);if(e&&t){const o=Math.floor((t-e)/864e5)+1;document.getElementById("num_dias").value=o>0?o:0,DATA.fixos.length>0&&calcular()}}function getOmieAvg(e,t){const o=document.getElementById("d_inicio").value,a=document.getElementById("d_fim").value;let n=0,i=0;return DATA.omie.forEach(l=>{const s=parseDateFromDB(l.Data);if(s&&s>=o&&s<=a&&l[e]==t){const e=parseFloat(String(l.OMIE).replace(",","."));isNaN(e)||(n+=e,i++)}}),i?n/i:0}function atualizarMenusCiclo(){const e=parseFloat(document.getElementById("potencia").value),t=document.getElementById("ciclo");t.innerHTML="",(e<=20.7?["Simples","Bi-horário - Ciclo Diário","Bi-horário - Ciclo Semanal","Tri-horário - Ciclo Diário","Tri-horário - Ciclo Semanal"]:["Tri-horário > 20.7 kVA - Ciclo Diário","Tri-horário > 20.7 kVA - Ciclo Semanal"]).forEach(e=>t.add(new Option(e,e))),construirInputsConsumo()}function resolverExpressao(e){let t=e.value;if(t&&(t=t.replace(",","."),/^[0-9+\-*/.()\s]+$/.test(t)))try{const o=Function('"use strict";return ('+t+")")();e.value=Math.round(o),calcular()}catch(e){console.log("Erro no cálculo: "+e)}}function construirInputsConsumo(){const e=document.getElementById("ciclo").value,t=document.getElementById("content-consumo"),o='onchange="resolverExpressao(this)" onkeypress="if(event.key===\'Enter\') resolverExpressao(this)"';if(e.includes("Simples")?t.innerHTML=`<div class="input-group"><label>Simples <span class="label-units">(kWh)</span> \n                    <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                    onmouseenter="showTooltipNome(event, 'Simples', 'Introduza o consumo total ou um cálculo (ex: 80+20+58 ou 200+58-100)')" \n                    onmouseleave="hideTooltip()"></i>\n                    </label>\n                    <input type="text" id="kwh_S" value="158" ${o} inputmode="numeric"></div>`:e.includes("Bi")?t.innerHTML=`<div class="input-group"><label>Vazio <span class="label-units">(kWh)</span> \n                    <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                    onmouseenter="showTooltipNome(event, 'Vazio', 'Introduza o consumo total ou um cálculo (ex: 80+20+58 ou 200+58-100)')" \n                    onmouseleave="hideTooltip()"></i>                    \n                    </label>\n                    <input type="text" id="kwh_V" value="63" ${o} inputmode="numeric"></div>\n                    <div class="input-group"><label>Fora Vazio <span class="label-units">(kWh)</span> \n                    <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                    onmouseenter="showTooltipNome(event, 'Fora Vazio', 'Introduza o consumo total ou um cálculo (ex: 80+20+58 ou 200+58-100)')" \n                    onmouseleave="hideTooltip()"></i>                     \n                    </label>\n                    <input type="text" id="kwh_F" value="95" ${o} inputmode="numeric"></div>`:t.innerHTML=`<div class="input-group"><label>Vazio <span class="label-units">(kWh)</span> \n                    <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                    onmouseenter="showTooltipNome(event, 'Vazio', 'Introduza o consumo total ou um cálculo (ex: 80+20+58 ou 200+58-100)')" \n                    onmouseleave="hideTooltip()"></i>                    \n                    </label>\n                    <input type="text" id="kwh_V" value="63" ${o} inputmode="numeric"></div>\n                    <div class="input-group"><label>Ponta <span class="label-units">(kWh)</span> \n                    <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                    onmouseenter="showTooltipNome(event, 'Ponta', 'Introduza o consumo total ou um cálculo (ex: 80+20+58 ou 200+58-100)')" \n                    onmouseleave="hideTooltip()"></i>                     \n                    </label>\n                    <input type="text" id="kwh_P" value="27" ${o} inputmode="numeric"></div>\n                    <div class="input-group"><label>Cheias <span class="label-units">(kWh)</span> \n                    <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                    onmouseenter="showTooltipNome(event, 'Cheias', 'Introduza o consumo total ou um cálculo (ex: 80+20+58 ou 200+58-100)')" \n                    onmouseleave="hideTooltip()"></i>                     \n                    </label>\n                    <input type="text" id="kwh_C" value="68" ${o} inputmode="numeric"></div>`,"advanced"===CURRENT_TAB&&DADOS_EREDES&&DADOS_EREDES.consumosAgregados){aplicarDadosERedes();const t=DADOS_EREDES.mediasOMIE;e.includes("Bi-horário")&&e.includes("Diário")?(OMIE_VALUES.V=t.BD_V||t.S,OMIE_VALUES.F=t.BD_F||t.S):e.includes("Bi-horário")&&e.includes("Semanal")?(OMIE_VALUES.V=t.BS_V||t.S,OMIE_VALUES.F=t.BS_F||t.S):e.includes("Tri-horário")&&e.includes("Diário")?(OMIE_VALUES.V=t.TD_V||t.S,OMIE_VALUES.C=t.TD_C||t.S,OMIE_VALUES.P=t.TD_P||t.S):e.includes("Tri-horário")&&e.includes("Semanal")&&(OMIE_VALUES.V=t.TS_V||t.S,OMIE_VALUES.C=t.TS_C||t.S,OMIE_VALUES.P=t.TS_P||t.S)}toggleMeuTarifario();const a=document.getElementById("pers_ativo");a&&a.checked&&toggleTarifarioPersonalizado(),controlarVisibilidadeModoComparacao(),calcular()}function controlarVisibilidadeModoComparacao(){const e=document.getElementById("ciclo").value,t=document.getElementById("content-comparacao"),o=t?t.previousElementSibling:null;if("advanced"===CURRENT_TAB)return t&&(t.style.display="block"),void(o&&(o.style.display="block"));if(e.includes("Simples")){t&&(t.style.display="none"),o&&(o.style.display="none");const e=document.getElementById("modo_comparacao");e&&(e.checked=!1)}else t&&(t.style.display="block"),o&&(o.style.display="block")}function calcularPerdasDinamicas(e,t,o){if(DATA.perdas={},!DATA.omie||0===DATA.omie.length)return;const a=e=>`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`,n=a(e),i=a(t);let l=DATA.omie.filter(e=>{const t=String(e.Data),o=t.includes("/")?t.split("/"):null;if(!o||3!==o.length)return!1;const a=`${o[2]}-${o[0].padStart(2,"0")}-${o[1].padStart(2,"0")}`;return a>=n&&a<=i});const s=e.getFullYear(),r=t.getFullYear();let c=DATA.omie.filter(e=>{const t=String(e.Data),o=t.includes("/")?t.split("/"):null;if(!o||3!==o.length)return!1;const a=parseInt(o[2]);return a>=s&&a<=r});if(l.length>0){let e=0,t=0;l.forEach(o=>{let a=parseFloat(String(o.Perdas||"0").replace(",","."));!isNaN(a)&&a>0&&(e+=a,t++)}),t>0&&(DATA.perdas.Perdas_M_S=e/t),["BD","BS","TD","TS"].forEach(e=>{("BD"===e||"BS"===e?["V","F"]:["V","C","P"]).forEach(t=>{let o=0,a=0;l.forEach(n=>{if(n[e]===t){let e=parseFloat(String(n.Perdas||"0").replace(",","."));!isNaN(e)&&e>0&&(o+=e,a++)}}),DATA.perdas[`Perdas_M_${e}_${t}`]=a>0?o/a:DATA.perdas.Perdas_M_S||1.16})})}if(c.length>0){let e=0,t=0;c.forEach(o=>{let a=parseFloat(String(o.Perdas||"0").replace(",","."));!isNaN(a)&&a>0&&(e+=a,t++)}),t>0&&(DATA.perdas.Perdas_Anual_S=e/t),["BD","BS","TD","TS"].forEach(e=>{("BD"===e||"BS"===e?["V","F"]:["V","C","P"]).forEach(t=>{let o=0,a=0;c.forEach(n=>{if(n[e]===t){let e=parseFloat(String(n.Perdas||"0").replace(",","."));!isNaN(e)&&e>0&&(o+=e,a++)}}),DATA.perdas[`Perdas_Anual_${e}_${t}`]=a>0?o/a:DATA.perdas.Perdas_Anual_S||1})})}}function construirInputsOMIE(e){const t=document.getElementById("omie-inputs");let o="";o=e.includes("Simples")?`<div><label style="font-size:0.7rem;">Simples</label><input type="number" class="omie-input" id="omie_S" value="${OMIE_VALUES.S.toFixed(2)}" step="0.01" oninput="atualizarOMIE()"></div>`:e.includes("Bi")?`<div><label style="font-size:0.7rem;">Vazio</label><input type="number" class="omie-input" id="omie_V" value="${OMIE_VALUES.V.toFixed(2)}" step="0.01" oninput="atualizarOMIE()"></div>\n                        <div><label style="font-size:0.7rem;">F. Vazio</label><input type="number" class="omie-input" id="omie_F" value="${OMIE_VALUES.F.toFixed(2)}" step="0.01" oninput="atualizarOMIE()"></div>`:`<div><label style="font-size:0.7rem;">Vazio</label><input type="number" class="omie-input" id="omie_V" value="${OMIE_VALUES.V.toFixed(2)}" step="0.01" oninput="atualizarOMIE()"></div>\n                        <div><label style="font-size:0.7rem;">Ponta</label><input type="number" class="omie-input" id="omie_P" value="${OMIE_VALUES.P.toFixed(2)}" step="0.01" oninput="atualizarOMIE()"></div>\n                        <div><label style="font-size:0.7rem;">Cheias</label><input type="number" class="omie-input" id="omie_C" value="${OMIE_VALUES.C.toFixed(2)}" step="0.01" oninput="atualizarOMIE()"></div>`,t.innerHTML=o}function atualizarOMIE(){OMIE_MANUAL=!0,document.getElementById("omie_S")&&(OMIE_VALUES.S=parseFloat(document.getElementById("omie_S").value)||0),document.getElementById("omie_V")&&(OMIE_VALUES.V=parseFloat(document.getElementById("omie_V").value)||0),document.getElementById("omie_F")&&(OMIE_VALUES.F=parseFloat(document.getElementById("omie_F").value)||0),document.getElementById("omie_P")&&(OMIE_VALUES.P=parseFloat(document.getElementById("omie_P").value)||0),document.getElementById("omie_C")&&(OMIE_VALUES.C=parseFloat(document.getElementById("omie_C").value)||0);let e=document.getElementById("ciclo").value,t="";t=e.includes("Simples")?`S: ${OMIE_VALUES.S.toFixed(2)}`:e.includes("Bi")?`V: ${OMIE_VALUES.V.toFixed(2)} | F: ${OMIE_VALUES.F.toFixed(2)}`:`V: ${OMIE_VALUES.V.toFixed(2)} | P: ${OMIE_VALUES.P.toFixed(2)} | C: ${OMIE_VALUES.C.toFixed(2)}`,document.getElementById("omie-display").innerText=t,calcular()}function toggleMeuTarifario(){const e=document.getElementById("meu_ativo").checked,t=document.getElementById("meu-inputs"),o=document.getElementById("ciclo").value;if(!e)return t.classList.add("hidden"),void calcular();t.classList.remove("hidden");let a="";a=o.includes("Simples")?'<div class="input-group"><label>Preço Simples <span class="label-units">(€/kWh)</span></label><input type="number" id="meu_S" value="0.1654" step="0.0001" oninput="calcular()"></div>':o.includes("Bi")?'<div class="input-group"><label>Vazio <span class="label-units">(€/kWh)</span></label><input type="number" id="meu_V" value="0.1087" step="0.0001" oninput="calcular()"></div>\n                        <div class="input-group"><label>Fora Vazio <span class="label-units">(€/kWh)</span></label><input type="number" id="meu_F" value="0.1988" step="0.0001" oninput="calcular()"></div>':'<div class="input-group"><label>Vazio <span class="label-units">(€/kWh)</span></label><input type="number" id="meu_V" value="0.1087" step="0.0001" oninput="calcular()"></div>\n                        <div class="input-group"><label>Cheias <span class="label-units">(€/kWh)</span></label><input type="number" id="meu_C" value="0.1690" step="0.0001" oninput="calcular()"></div>\n                        <div class="input-group"><label>Ponta <span class="label-units">(€/kWh)</span></label><input type="number" id="meu_P" value="0.2495" step="0.0001" oninput="calcular()"></div>',a+='<div class="input-group"><label>Potência <span class="label-units">(€/dia)</span></label><input type="number" id="meu_pot" value="0.1917" step="0.0001" oninput="calcular()"></div>\n                     <div class="input-group"><label class="checkbox-label"><input type="checkbox" id="meu_tar_en_incl" checked onchange="calcular()"> TAR incluída na Energia\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'TAR incluída na Energia\', \'É muito importante saber se os valores têm ou não as TAR (Tarifas de Acesso às Redes). Alguns comercializadores separam na fatura, outros não. Verifique se há alguma referência a Acesso às Redes na fatura em (€/kWh)\')" \n                        onmouseleave="hideTooltip()"></i></label></div>\n                     <div class="input-group"><label class="checkbox-label"><input type="checkbox" id="meu_tar_pot_incl" checked onchange="calcular()"> TAR incluída na Potência\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'TAR incluída na Potência\', \'É muito importante saber se os valores têm ou não as TAR (Tarifas de Acesso às Redes). Alguns comercializadores separam na fatura, outros não. Verifique se há alguma referência a Acesso às Redes na fatura em (€/dia)\')" \n                        onmouseleave="hideTooltip()"></i></label></div>\n                     <div class="input-group"><label class="checkbox-label"><input type="checkbox" id="meu_tse_incl" checked onchange="calcular()"> Inclui Financiamento TSE\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'Inclui Financiamento TSE\', \'É importante saber se os valores têm ou não incluido o financiamento da Tarifa Social de Eletricidade (TSE). Alguns comercializadores separam na fatura, outros não. Verifique se há alguma referência a Financiamento Tarifa Social na fatura em (€/kWh)\')" \n                        onmouseleave="hideTooltip()"></i></label></div>\n                     <div class="input-group"><label>Desc. Energia (%)\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'Desconto Energia\', \'O desconto é aplicado a Energia+TAR. Alguns tarifários não aplicam o desconto nas TAR (por exemplo os da Plenitude), pelo que o desconto não pode ser aqui aplicado. Se não tiver, não necessita preencher!\')" \n                        onmouseleave="hideTooltip()"></i></label><input type="number" id="meu_desc_en" value="0" step="0.1" oninput="calcular()"></div>\n                     <div class="input-group"><label>Desc. Potência (%)\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'Desconto Potência\', \'O desconto é aplicado a Potência+TAR. Alguns tarifários não aplicam o desconto nas TAR, pelo que se assim for, o desconto não pode ser aqui aplicado. Se não tiver, não necessita preencher!\')" \n                        onmouseleave="hideTooltip()"></i></label><input type="number" id="meu_desc_pot" value="0" step="0.1" oninput="calcular()"></div>\n                     <div class="input-group"><label>Desc. Fatura (€)\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'Desconto Fatura\', \'Se não tiver, não necessita preencher!\')" \n                        onmouseleave="hideTooltip()"></i></label><input type="number" id="meu_desc_fat" value="0" step="0.01" oninput="calcular()"></div>\n                     <div class="input-group"><label>Acrés. Fatura (€)\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'Acréscimo Fatura\', \'Para outros custos fixos na fatura. Se não tiver, não necessita preencher!\')" \n                        onmouseleave="hideTooltip()"></i></label><input type="number" id="meu_acres_fat" value="0" step="0.01" oninput="calcular()"></div>',t.innerHTML=a,calcular()}function toggleTarifarioPersonalizado(){const e=document.getElementById("pers_ativo").checked,t=document.getElementById("pers-inputs"),o=document.getElementById("ciclo").value,a=parseFloat(document.getElementById("potencia").value);if(!e)return t.classList.add("hidden"),void calcular();t.classList.remove("hidden");let n="";(o.includes("Simples")||o.includes("Bi")||o.includes("Tri")&&a<=20.7)&&(n+='\n                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #dee2e6;">\n                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.85rem; color: #495057;">Estrutura Simples Personalizada</div>\n                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">\n                        <div class="input-group" style="margin-bottom: 0;">\n                            <label style="font-size: 0.75rem;">Preço Energia Simples <span class="label-units">(€/kWh)</span></label>\n                            <input type="number" id="pers_energia_s" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">\n                        </div>\n                        <div class="input-group" style="margin-bottom: 0;">\n                            <label style="font-size: 0.75rem;">Preço Potência Simples <span class="label-units">(€/dia)</span></label>\n                            <input type="number" id="pers_potencia_s" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">\n                        </div>\n                    </div>\n                </div>'),(o.includes("Bi")||o.includes("Tri")&&a<=20.7)&&(n+='\n                <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #a5d6a7;">\n                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.85rem; color: #2e7d32;">Estrutura Bi-Horária Personalizada</div>\n                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">\n                        <div class="input-group" style="margin-bottom: 0;">\n                            <label style="font-size: 0.75rem;">Preço Vazio Bi-Horário <span class="label-units">(€/kWh)</span></label>\n                            <input type="number" id="pers_energia_v_bi" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">\n                        </div>\n                        <div class="input-group" style="margin-bottom: 0;">\n                            <label style="font-size: 0.75rem;">Preço Fora Vazio Bi-Horário <span class="label-units">(€/kWh)</span></label>\n                            <input type="number" id="pers_energia_f_bi" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">\n                        </div>\n                        <div class="input-group" style="margin-bottom: 0;">\n                            <label style="font-size: 0.75rem;">Preço Potência Bi-Horário <span class="label-units">(€/dia)</span></label>\n                            <input type="number" id="pers_potencia_bi" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">\n                        </div>\n                    </div>\n                </div>'),o.includes("Tri")&&(n+='\n                <div style="background: #fff3e0; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ffb74d;">\n                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.85rem; color: #e65100;">Estrutura Tri-Horária Personalizada</div>\n                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">\n                        <div class="input-group" style="margin-bottom: 0;">\n                            <label style="font-size: 0.75rem;">Preço Vazio Tri-Horário <span class="label-units">(€/kWh)</span></label>\n                            <input type="number" id="pers_energia_v_tri" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">\n                        </div>\n                        <div class="input-group" style="margin-bottom: 0;">\n                            <label style="font-size: 0.75rem;">Preço Cheias Tri-Horário <span class="label-units">(€/kWh)</span></label>\n                            <input type="number" id="pers_energia_c_tri" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">\n                        </div>\n                        <div class="input-group" style="margin-bottom: 0;">\n                            <label style="font-size: 0.75rem;">Preço Ponta Tri-Horário <span class="label-units">(€/kWh)</span></label>\n                            <input type="number" id="pers_energia_p_tri" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">\n                        </div>\n                        <div class="input-group" style="margin-bottom: 0;">\n                            <label style="font-size: 0.75rem;">Preço Potência Tri-Horário <span class="label-units">(€/dia)</span></label>\n                            <input type="number" id="pers_potencia_tri" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">\n                        </div>\n                    </div>\n                </div>'),n+='\n            <div style="background: #f0f4ff; padding: 10px; border-radius: 8px; border: 1px solid #c5d9f7;">\n                <div style="font-weight: 600; margin-bottom: 6px; font-size: 0.8rem; color: #1e40af;">Opções Comuns</div>\n                <div class="input-group" style="margin-bottom: 4px;">\n                    <label class="checkbox-label" style="font-size: 0.75rem;">\n                        <input type="checkbox" id="pers_tar_energia" checked onchange="calcular()"> TAR incluída na Energia?\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'TAR incluída na Energia?\', \'É muito importante saber se os valores têm ou não as TAR (Tarifas de Acesso às Redes). Alguns comercializadores separam na fatura, outros não. Verifique se há alguma referência a Acesso às Redes na fatura em (€/kWh)\')" \n                        onmouseleave="hideTooltip()"></i></label></div>\n                <div class="input-group" style="margin-bottom: 4px;">\n                    <label class="checkbox-label" style="font-size: 0.75rem;">\n                        <input type="checkbox" id="pers_tar_potencia" checked onchange="calcular()"> TAR incluída na Potência?\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'TAR incluída na Potência\', \'É muito importante saber se os valores têm ou não as TAR (Tarifas de Acesso às Redes). Alguns comercializadores separam na fatura, outros não. Verifique se há alguma referência a Acesso às Redes na fatura em (€/dia)\')" \n                        onmouseleave="hideTooltip()"></i></label></div>\n                <div class="input-group" style="margin-bottom: 0;">\n                    <label class="checkbox-label" style="font-size: 0.75rem;">\n                        <input type="checkbox" id="pers_tse_incluido" checked onchange="calcular()"> Inclui Financiamento TSE?\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'Inclui Financiamento TSE\', \'É importante saber se os valores têm ou não incluido o financiamento da Tarifa Social de Eletricidade (TSE). Alguns comercializadores separam na fatura, outros não. Verifique se há alguma referência a Financiamento Tarifa Social na fatura em (€/kWh)\')" \n                        onmouseleave="hideTooltip()"></i></label></div>\n                </div>\n            </div>',t.innerHTML=n,calcular()}function getVal(e,t,o){if(Array.isArray(t)){for(let o of t)if(void 0!==e[o])return parse(e[o]);return 0}return parse(e[o[t]]||e[t])}function parse(e){return null==e?0:"string"==typeof e?parseFloat(e.replace(",",".").replace("€","").trim())||0:"number"==typeof e?e:0}function parseBool(e){if(null!=e){if("boolean"==typeof e)return e;if("string"==typeof e){const t=e.toLowerCase().trim();if("true"===t||"sim"===t||"yes"===t||"1"===t)return!0;if("false"===t||"não"===t||"nao"===t||"no"===t||"0"===t)return!1}}}function getConst(e){return parseFloat(DATA.constantes[e])||0}function getPerdas(e){return parseFloat(DATA.perdas[e])||1}function obter_perfil(e,t,o){return t<=0?"BTN_C":o>13.8?"BTN_A":365*e/t>7140?"BTN_B":"BTN_C"}function calculateDetailedQH(e,t,o,a){let n="Simp";a.includes("Bi")&&(n=a.includes("Diário")?"BD":"BS"),a.includes("Tri")&&(n=a.includes("Diário")?"TD":"TS");let i={},l={};if(!DATA.indexados||0===DATA.indexados.length)return{perfil:{},diagrama:null};DATA.indexados.filter(e=>"Indexado quarto-horário"===e.tipo||e.nome&&e.nome.includes("BTN SPOTDEF")).forEach(e=>{i[e.nome]={S:{c:0,w:0},V:{c:0,w:0},F:{c:0,w:0},P:{c:0,w:0},C:{c:0,w:0}},l[e.nome]={S:{c:0,w:0},V:{c:0,w:0},F:{c:0,w:0},P:{c:0,w:0},C:{c:0,w:0}}});const s=(e,t,o)=>e.includes("Coopérnico Base 2.0")?(t+getConst("Coop_CS_CR")+getConst("Coop_K"))*o:e.includes("Repsol - Leve Sem Mais")?t*o*getConst("Repsol_FA")+getConst("Repsol_Q_Tarifa"):e.includes("Repsol - Leve PRO Sem Mais")?t*o*getConst("Repsol_FA")+getConst("Repsol_Q_Tarifa_Pro"):e.includes("Galp - Plano Flexível")?(t+getConst("Galp_Ci"))*o:e.includes("Alfa Energia - ALFA POWER")?(t+getConst("Alfa_CGS"))*o+getConst("Alfa_K"):e.includes("Plenitude - Tendência")?(t+getConst("Plenitude_CGS")+getConst("Plenitude_GDOs"))*o+getConst("Plenitude_Fee"):e.includes("Meo Energia - Tarifa Variável")?(t+getConst("Meo_K"))*o:e.includes("EDP - Eletricidade Indexada Horária")?t*o*getConst("EDP_H_K1")+getConst("EDP_H_K2"):e.includes("EZU - Indexada")?(t+getConst("EZU_K")+getConst("EZU_CGS"))*o:e.includes("G9 - Smart Dynamic")?t*getConst("G9_FA")*o+getConst("G9_CGS")+getConst("G9_AC"):e.includes("Iberdrola - Simples Indexado Dinâmico")?t*o+getConst("Iberdrola_Dinamico_Q")+getConst("Iberdrola_mFRR"):e.includes("BTN SPOTDEF")?(t+getConst("Luzboa_CGS"))*o*getConst("Luzboa_FA")+getConst("Luzboa_Kp"):t*o+.01,r=DADOS_EREDES&&DADOS_EREDES.dadosBrutos&&DATA.omieMap&&"advanced"===CURRENT_TAB;if(r){const o=new Date(e).getTime(),a=new Date(t).getTime()+86399999;for(const e of DADOS_EREDES.dadosBrutos){if(e.Ts<o||e.Ts>a)continue;const t=new Date(e.DataHora),i=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),c=String(t.getDate()).padStart(2,"0"),d=String(t.getHours()).padStart(2,"0"),u=String(t.getMinutes()).padStart(2,"0");let m=DATA.omieMap.get(`${i}-${r}-${c}_${d}:${u}`);if(m||"00"===u||(m=DATA.omieMap.get(`${i}-${r}-${c}_${d}:00`)),!m)continue;let p=parseFloat(String(m.OMIE).replace(",","."))/1e3,g=parseFloat(String(m.Perdas).replace(",",".")),f=e["Consumo (kWh)"],_=m[n];if(_||"Simp"===n)for(let e in l){let t=s(e,p,g);l[e].S.c+=t*f,l[e].S.w+=f,"Simp"!==n&&_&&(l[e][_].c+=t*f,l[e][_].w+=f)}}}DATA.omie&&DATA.omie.forEach(a=>{const l=parseDateFromDB(a.Data);if(!l||l<e||l>t)return;let r=parseFloat(String(a.OMIE).replace(",","."))/1e3,c=parseFloat(String(a.Perdas).replace(",",".")),d=parseFloat(String(a[o]||0).replace(",",".")),u=a[n];if(u||"Simp"===n)for(let e in i){let t=s(e,r,c);e.includes("BTN SPOTDEF")?"Simp"===n?(i[e].S.c+=t,i[e].S.w+=1):u&&(i[e][u].c+=t,i[e][u].w+=1):e.includes("Repsol")||"Simp"===n?(i[e].S.c+=t*d,i[e].S.w+=d):u&&(i[e][u].c+=t*d,i[e][u].w+=d)}});const c=e=>{let t={};for(let o in e)if(t[o]={},o.includes("Repsol")){let a=e[o].S.w>0?e[o].S.c/e[o].S.w:0;["S","V","F","P","C"].forEach(e=>t[o][e]=a)}else["S","V","F","P","C"].forEach(a=>{let n=e[o][a];t[o][a]=n.w>0?n.c/n.w:0});return t};return{perfil:c(i),diagrama:r?c(l):null}}function calculateManualQH(e,t){let o="Simp";t.includes("Bi")&&(o=t.includes("Diário")?"BD":"BS"),t.includes("Tri")&&(o=t.includes("Diário")?"TD":"TS");let a={};DATA.indexados.forEach(e=>{("Indexado quarto-horário"===e.tipo||e.nome&&e.nome.includes("BTN SPOTDEF"))&&(a[e.nome]={S:{c:0,w:0},V:{c:0,w:0},F:{c:0,w:0},P:{c:0,w:0},C:{c:0,w:0}})});const n=document.getElementById("d_inicio").value,i=document.getElementById("d_fim").value,l=parseInt(document.getElementById("num_dias").value),s=parseFloat(document.getElementById("potencia").value),r=obter_perfil((parseFloat(document.getElementById("kwh_S")?document.getElementById("kwh_S").value:0)||0)+(parseFloat(document.getElementById("kwh_V")?document.getElementById("kwh_V").value:0)||0)+(parseFloat(document.getElementById("kwh_F")?document.getElementById("kwh_F").value:0)||0)+(parseFloat(document.getElementById("kwh_P")?document.getElementById("kwh_P").value:0)||0)+(parseFloat(document.getElementById("kwh_C")?document.getElementById("kwh_C").value:0)||0),l,s);DATA.omie.forEach(l=>{const s=parseDateFromDB(l.Data);if(!s)return;if(s<n||s>i)return;let c=null;if("Simp"!==o&&(c=l[o],!c))return;let d=0;d=t.includes("Simples")?e.S||0:"V"===c?e.V||0:"F"===c?e.F||0:"C"===c?e.C||0:"P"===c?e.P||0:e.S||0;let u=d/1e3,m=parseFloat(String(l.Perdas).replace(",",".")),p=parseFloat(String(l[r]||0).replace(",","."));for(let e in a){let t=0;t=e.includes("Coopérnico Base 2.0")?(u+getConst("Coop_CS_CR")+getConst("Coop_K"))*m:e.includes("Repsol - Leve Sem Mais")?u*m*getConst("Repsol_FA")+getConst("Repsol_Q_Tarifa"):e.includes("Repsol - Leve PRO Sem Mais")?u*m*getConst("Repsol_FA")+getConst("Repsol_Q_Tarifa_Pro"):e.includes("Galp - Plano Flexível")?(u+getConst("Galp_Ci"))*m:e.includes("Alfa Energia - ALFA POWER")?(u+getConst("Alfa_CGS"))*m+getConst("Alfa_K"):e.includes("Plenitude - Tendência")?(u+getConst("Plenitude_CGS")+getConst("Plenitude_GDOs"))*m+getConst("Plenitude_Fee"):e.includes("Meo Energia - Tarifa Variável")?(u+getConst("Meo_K"))*m:e.includes("EDP - Eletricidade Indexada Horária")?u*m*getConst("EDP_H_K1")+getConst("EDP_H_K2"):e.includes("EZU - Indexada")?(u+getConst("EZU_K")+getConst("EZU_CGS"))*m:e.includes("G9 - Smart Dynamic")?u*getConst("G9_FA")*m+getConst("G9_CGS")+getConst("G9_AC"):e.includes("Iberdrola - Simples Indexado Dinâmico")?u*m+getConst("Iberdrola_Dinamico_Q")+getConst("Iberdrola_mFRR"):e.includes("BTN SPOTDEF")?(u+getConst("Luzboa_CGS"))*m*getConst("Luzboa_FA")+getConst("Luzboa_Kp"):u*m+.01,e.includes("BTN SPOTDEF")?"Simp"===o?(a[e].S.c+=t,a[e].S.w+=1):c&&(a[e][c].c+=t,a[e][c].w+=1):e.includes("Repsol")||"Simp"===o?(a[e].S.c+=t*p,a[e].S.w+=p):c&&(a[e][c].c+=t*p,a[e][c].w+=p)}});let c={};for(let e in a)if(c[e]={},e.includes("Repsol")){let t=a[e].S.w>0?a[e].S.c/a[e].S.w:0;["S","V","F","P","C"].forEach(o=>c[e][o]=t)}else["S","V","F","P","C"].forEach(t=>{let o=a[e][t];c[e][t]=o.w>0?o.c/o.w:0});return c}function calcular(){if(!DATA.fixos.length)return;if("advanced"===CURRENT_TAB&&DADOS_EREDES&&DADOS_EREDES.dadosBrutos){const e=new Date(document.getElementById("d_inicio").value),t=new Date(document.getElementById("d_fim").value),o=e.getTime(),a=t.getTime()+86399999,n=DADOS_EREDES.dadosBrutos.filter(e=>e.Ts>=o&&e.Ts<=a);if(n.length>0){const e=agregarConsumosPorPeriodo(n),t=calcularMediasOMIE(null),o=document.getElementById("ciclo").value;if(o.includes("Simples")){const t=document.getElementById("kwh_S");t&&(t.value=Math.round(100*e.Simples)/100)}else if(o.includes("Bi")){const t=o.includes("Diário")?e.BD:e.BS,a=document.getElementById("kwh_V"),n=document.getElementById("kwh_F");a&&(a.value=Math.round(100*t.V)/100),n&&(n.value=Math.round(100*t.F)/100)}else{const t=o.includes("Diário")?e.TD:e.TS,a=document.getElementById("kwh_V"),n=document.getElementById("kwh_P"),i=document.getElementById("kwh_C");a&&(a.value=Math.round(100*t.V)/100),n&&(n.value=Math.round(100*t.P)/100),i&&(i.value=Math.round(100*t.C)/100)}if(t.S){OMIE_VALUES.S=t.S,OMIE_VALUES.BD_V=t.BD_V||t.S,OMIE_VALUES.BD_F=t.BD_F||t.S,OMIE_VALUES.BS_V=t.BS_V||t.S,OMIE_VALUES.BS_F=t.BS_F||t.S,OMIE_VALUES.TD_V=t.TD_V||t.S,OMIE_VALUES.TD_C=t.TD_C||t.S,OMIE_VALUES.TD_P=t.TD_P||t.S,OMIE_VALUES.TS_V=t.TS_V||t.S,OMIE_VALUES.TS_C=t.TS_C||t.S,OMIE_VALUES.TS_P=t.TS_P||t.S,OMIE_MANUAL=!1;const e=document.getElementById("omie-panel");e&&e.classList.add("hidden")}const a=criarTabelaAnalise(e,t),i=document.getElementById("analise-content");i&&(i.innerHTML=a)}}else if(!OMIE_MANUAL){let e="Simp";const t=document.getElementById("ciclo").value;t.includes("Bi")&&(e=t.includes("Diário")?"BD":"BS"),t.includes("Tri")&&(e=t.includes("Diário")?"TD":"TS"),OMIE_VALUES.S=getOmieAvg("Simp","S"),t.includes("Bi")?(OMIE_VALUES.V=getOmieAvg(e,"V"),OMIE_VALUES.F=getOmieAvg(e,"F")):t.includes("Tri")&&(OMIE_VALUES.V=getOmieAvg(e,"V"),OMIE_VALUES.P=getOmieAvg(e,"P"),OMIE_VALUES.C=getOmieAvg(e,"C"));let o="";o=t.includes("Simples")?`S: ${OMIE_VALUES.S.toFixed(2)}`:t.includes("Bi")?`V: ${OMIE_VALUES.V.toFixed(2)} | F: ${OMIE_VALUES.F.toFixed(2)}`:`V: ${OMIE_VALUES.V.toFixed(2)} | P: ${OMIE_VALUES.P.toFixed(2)} | C: ${OMIE_VALUES.C.toFixed(2)}`;const a=document.getElementById("omie-display");a&&(a.innerText=o)}const e=document.getElementById("d_inicio").value,t=document.getElementById("d_fim").value;calcularPerdasDinamicas(new Date(e),new Date(t),document.getElementById("ciclo").value);const o=parseFloat(document.getElementById("potencia").value),a=document.getElementById("ciclo").value,n=parseInt(document.getElementById("num_dias").value),i=document.getElementById("familia_numerosa").checked,l=document.getElementById("tarifa_social").checked,s=document.getElementById("quota_acp").checked,r=document.getElementById("ocultar_edp_h").checked,c=parseFloat(document.getElementById("cav_valor").value)||2.85,d=parseFloat(document.getElementById("dgeg_valor").value)||.07,u={S:parseFloat(document.getElementById("kwh_S")?.value)||0,V:parseFloat(document.getElementById("kwh_V")?.value)||0,F:parseFloat(document.getElementById("kwh_F")?.value)||0,P:parseFloat(document.getElementById("kwh_P")?.value)||0,C:parseFloat(document.getElementById("kwh_C")?.value)||0},m=u.S+u.V+u.F+u.P+u.C;let p="Simp";if(a.includes("Bi")&&(p=a.includes("Diário")?"BD":"BS"),a.includes("Tri")&&(p=a.includes("Diário")?"TD":"TS"),!OMIE_MANUAL){OMIE_VALUES.S=getOmieAvg("Simp","S"),a.includes("Simples")||(a.includes("Bi")?(OMIE_VALUES.V=getOmieAvg(p,"V"),OMIE_VALUES.F=getOmieAvg(p,"F")):(OMIE_VALUES.V=getOmieAvg(p,"V"),OMIE_VALUES.P=getOmieAvg(p,"P"),OMIE_VALUES.C=getOmieAvg(p,"C")));let e="";e=a.includes("Simples")?`S: ${OMIE_VALUES.S.toFixed(2)}`:a.includes("Bi")?`V: ${OMIE_VALUES.V.toFixed(2)} | F: ${OMIE_VALUES.F.toFixed(2)}`:`V: ${OMIE_VALUES.V.toFixed(2)} | P: ${OMIE_VALUES.P.toFixed(2)} | C: ${OMIE_VALUES.C.toFixed(2)}`,document.getElementById("omie-display").innerText=e;const t=document.getElementById("omie-panel");t&&"advanced"!==CURRENT_TAB?t.classList.remove("hidden"):t&&t.classList.add("hidden"),construirInputsOMIE(a)}let g={};if(OMIE_MANUAL)g=calculateManualQH(OMIE_VALUES,a);else{const i=obter_perfil(m,n,o);g=calculateDetailedQH(e,t,i,a)}const f=getConst(`TAR_Potencia ${o}`),_=getConst("Financiamento_TSE");let h=getConst("IEC");const E=getConst("Quota_ACP");let S=0,y=0;l&&o<=6.9&&(S=getConst("Desconto TS Energia"),y=getConst(`Desconto TS Potencia ${o}`),h=0);let A={S:0,V:0,F:0,P:0,C:0};if(a.includes("Simples"))A.S=getConst("TAR_Energia_Simples");else if(a.includes("Bi"))A.V=getConst("TAR_Energia_Bi_Vazio"),A.F=getConst("TAR_Energia_Bi_ForaVazio");else{let e=o>20.7?"TAR_Energia_Tri_27.6_":"TAR_Energia_Tri_";A.V=getConst(e+"Vazio"),A.P=getConst(e+"Ponta"),A.C=getConst(e+"Cheias")}let v={S:A.S-S,V:A.V-S,F:A.F-S,P:A.P-S,C:A.C-S};const T=f-y,I=document.getElementById("f_segmento").value,C=document.getElementById("f_fatura").value,b=document.getElementById("f_pagamento").value,B=Array.from(document.querySelectorAll(".chk-tipo:checked")).map(e=>e.value);let x=[];const F=(e,t,l)=>{e.forEach(e=>{if(Math.abs(getVal(e,"pot",l)-o)>.1)return;if(!(e[l.ciclo]||"").toLowerCase().includes(a.toLowerCase()))return;let p=e.nome||"";if(r&&p.includes("EDP - Eletricidade Indexada Horária"))return;const S=e[l.seg]||"";if("Residencial"===I&&"Doméstico"!==S&&"Doméstico e Não Doméstico"!==S)return;if("Empresarial"===I&&"Não Doméstico"!==S&&"Doméstico e Não Doméstico"!==S)return;const y=e[l.fat]||"";if("Fatura eletrónica"===C&&!y.includes("Fatura eletrónica"))return;if("Fatura em papel"===C&&!y.includes("Fatura em papel"))return;const F=e[l.pag]||"";if("Débito Direto"===b&&!F.includes("Débito Direto"))return;if("Multibanco"===b&&!F.includes("Multibanco"))return;if("Numerário/Payshop/CTT"===b&&!F.includes("Numerário")&&!F.includes("Payshop")&&!F.includes("CTT"))return;let D=e[l.tipo]||(t?"Indexado Média":"Fixo");if(D=D.trim(),!B.includes(D))return;const P=e.comercializador||"";if("complete"===CURRENT_TAB&&STATE_ABA2.excludedProviders.includes(P))return;if("advanced"===CURRENT_TAB&&STATE_ABA3.excludedProviders.includes(P))return;let M=[];if(t&&"Indexado quarto-horário"===D&&g.perfil)M.push({suffix:" - Perfil",source:g.perfil,tipoExtra:" - Perfil"}),g.diagrama&&M.push({suffix:" - Diagrama",source:g.diagrama,tipoExtra:" - Diagrama"});else{let e=g.perfil?g.perfil:g;M.push({suffix:"",source:e,tipoExtra:""})}M.forEach(r=>{let g=p+r.suffix,S=D+r.tipoExtra;const y=e.comercializador||"";let I=getVal(e,"fixo",l),C=parseBool(e[l.tar_p_incl]);void 0===C&&(C=!t);let b=C?I-f:I,B=b+T,F=parseBool(e[l.tar_e_incl]);void 0===F&&(F=!t);let P=parseBool(e[l.tse_incl]);void 0===P&&(P=!0);let M=0,V=0,w=0,k=0,$=0,O={S:{},V:{},F:{},P:{},C:{}},L={S:OMIE_VALUES.S/1e3,V:OMIE_VALUES.V/1e3,F:OMIE_VALUES.F/1e3,P:OMIE_VALUES.P/1e3,C:OMIE_VALUES.C/1e3};const z=(e,o,n,i)=>{let l=e;if(t)if("Indexado quarto-horário"===D)r.source[p]&&(l=r.source[p][i]||0);else{let e=L[i],t=L.S,o="S";a.includes("Bi")?o=a.includes("Diário")?"BD":"BS":a.includes("Tri")&&(o=a.includes("Diário")?"TD":"TS");let n=1,s=1.16;a.includes("Simples")?(n=getPerdas("Perdas_Anual_S")||1,s=getPerdas("Perdas_M_S")||1.16):(n=getPerdas(`Perdas_Anual_${o}_${i}`)||1,s=getPerdas(`Perdas_M_${o}_${i}`)||1.16),l=p.includes("BTN SPOTDEF")?r.source[p]&&void 0!==r.source[p][i]?r.source[p][i]:(e+getConst("Luzboa_CGS"))*n*getConst("Luzboa_FA")+getConst("Luzboa_Kp"):p.includes("Iberdrola")?e*getConst("Iberdrola_Perdas")+getConst("Iberdrola_Media_Q")+getConst("Iberdrola_mFRR"):p.includes("Goldenergy")?e*({1:1.29,2:1.18,3:1.18,4:1.15,5:1.11,6:1.1,7:1.15,8:1.13,9:1.1,10:1.1,11:1.16,12:1.25}[new Date(document.getElementById("d_inicio").value).getMonth()+1]||1.16)+getConst("GE_Q_Tarifa")+getConst("GE_CG"):p.includes("Endesa")?e+getConst(`Endesa_A_${"F"===i?"FV":i}`):p.includes("LUZiGÁS - Energy 8.8")?(t+getConst("Luzigas_8_8_K")+getConst("Luzigas_CGS"))*n:p.includes("LUZiGÁS - Super Lig Index")?(t+getConst("Luzigas_K")+getConst("Luzigas_CGS"))*n:p.includes("Ibelectra - Solução Família")?(e+getConst("Ibelectra_CS"))*getConst("Ibelectra_Perdas")+getConst("Ibelectra_K"):p.includes("Ibelectra - Solução Amigo")?(e+getConst("Ibelectra_CS"))*getConst("Ibelectra_Perdas")+getConst("Ibelectra_K_a"):p.includes("G9 - Smart Index")?e*getConst("G9_FA")*s+getConst("G9_CGS")+getConst("G9_AC"):p.includes("EDP - Eletricidade Indexada Média")?e*getConst("EDP_M_Perdas")*getConst("EDP_M_K1")+getConst("EDP_M_K2"):e+.02}let s=F?l-o:l,c=n,d=P?0:_,u=s+c+d;return O[i]={comercialSemTar:s,tarValue:c,tse:d,tarIncluded:F,tseIncluded:P},u};if(a.includes("Simples"))M=z(t?0:getVal(e,"pS",l),A.S,v.S,"S");else if(a.includes("Bi")){let o=t?0:getVal(e,"pV_bi",l)||getVal(e,"pS",l),a=t?0:getVal(e,"pF",l)||getVal(e,"pS",l);V=z(o,A.V,v.V,"V"),w=z(a,A.F,v.F,"F")}else{let o=t?0:getVal(e,"pV_tri",l)||getVal(e,"pS",l),a=t?0:getVal(e,"pP",l)||getVal(e,"pF",l)||getVal(e,"pS",l),n=t?0:getVal(e,"pC",l)||getVal(e,"pF",l)||getVal(e,"pS",l);V=z(o,A.V,v.V,"V"),k=z(a,A.P,v.P,"P"),$=z(n,A.C,v.C,"C")}let R=b*n,U=T*n,N=0,H=0;o<=3.45?(N=U,H=R):H=R+U;let q=.06*N,W=.23*H,G=0;G=a.includes("Simples")?M*u.S:a.includes("Bi")?V*u.V+w*u.F:V*u.V+k*u.P+$*u.C;let K,Q=(i?300:200)/30*n,j=0,X=0,Y=0,J=0;if(o<=6.9){if(a.includes("Simples")){let e=Math.min(m,Q),t=Math.max(0,m-Q),o=m?G/m:0;j=e*o,X=t*o}else{let e=a.includes("Bi")?{V:u.V,F:u.F}:{V:u.V,P:u.P,C:u.C},t=a.includes("Bi")?{V:V*u.V,F:w*u.F}:{V:V*u.V,P:k*u.P,C:$*u.C},o=0,n=0;for(let a in e){let i=Q*(m>0?e[a]/m:0),l=Math.min(e[a],i),s=Math.max(0,e[a]-i),r=e[a]>0?t[a]/e[a]:0;o+=l*r,n+=s*r}j=o,X=n}Y=.06*j,J=.23*X}else X=G,J=.23*X;K=CAV_FIXO_COMERCIALIZADORES.some(e=>y.includes(e))&&n>=28&&n<=32?c:12*c/365.25*n;let Z=m*h,ee=n>=28&&n<=32?d:d*n/30,te=.23*Z,oe=.23*ee,ae=.06*K,ne=N+H+q+W+(j+X+Y+J)+(Z+te+ee+oe+K+ae),ie=getVal(e,"desc_fat",l),le=getVal(e,"desc_limit",l),se=0;if(ie>0){let e=n>=28&&n<=32?ie:ie*n/30,t="";le&&le>0?(se=(n>=28&&n<=32?1:n/30)>le?ie*le:e,t=` nos 1ºs ${le} meses`):se=e;let o=ne;ne-=se,g+=` (INCLUI desc.${ie.toFixed(2)}€/mês${t}, s/ desc.=${o.toFixed(2)}€)`}let re=0;s&&p.startsWith("Goldenergy - ACP")&&(re=n>=28&&n<=32?E:E*n/30,ne+=re,g+=" (INCLUI Quota ACP)"),x.push({com:y,nome:g,tipo:S,total:ne,uS:M,uV:V,uF:w,uP:k,uC:$,uPot:B,breakdown:O,potDetails:{comercial:b,tarPotValue:T,tarIncluded:C},details:{costPot6:N,costPot23:H,costEn6:j,costEn23:X,taxPot6:q,taxPot23:W,taxEn6:Y,taxEn23:J,iec:Z,dgeg:ee,cav:K,taxIEC:te,taxDGEG:oe,taxCAV:ae,desc:se,quotaACP:re,site:e[l.site],notas:e[l.notas]}})})})};if(F(DATA.fixos,!1,COLS_FIXO),DATA.indexados&&DATA.indexados.length>0&&F(DATA.indexados,!0,COLS_INDEX),document.getElementById("meu_ativo")&&document.getElementById("meu_ativo").checked){const e=criarMeuTarifario(o,a,n,u,m,A,f,_,i,c,h,d,v,T);e&&x.push(e)}if(document.getElementById("pers_ativo")&&document.getElementById("pers_ativo").checked){const e=criarTarifarioPersonalizado(o,a,n,u,m,A,f,_,i,c,h,d,v,T);e&&x.push(e)}const D=document.getElementById("f_procura")?document.getElementById("f_procura").value.toLowerCase():"";D&&(x=x.filter(e=>{if("Utilizador"===e.tipo||"Personalizado"===e.tipo)return!0;const t=e.com?e.com.toLowerCase():"",o=e.nome?e.nome.toLowerCase():"";return t.includes(D)||o.includes(D)})),x.sort((e,t)=>SORT.asc?e[SORT.col]-t[SORT.col]:t[SORT.col]-e[SORT.col]),window.GLOBAL_RESULTS=x,document.getElementById("res-count").innerText=`${x.length} tarifas`,x.length>0&&(atualizarResumoSimulacao(),calcularMensagemPoupanca(x));const P=document.getElementById("modo_comparacao"),M=document.getElementById("titulo-tabela"),V=document.getElementById("btn-exportar"),w=document.getElementById("btn-partilhar");if(P&&P.checked){M&&(M.textContent="Tiago Felícia - Comparação de Custos entre Opções Tarifárias");const e=calcularModoComparacao(x,o,a,n,u,m,A,f,_,i,c,h,d,v,T);renderTableComparacao(e,a),LAST_EXPORT_DATA={mode:"comparacao",data:e,results:x,ciclo:a}}else{M&&(M.textContent="Tiago Felícia - Tarifários de Eletricidade - Detalhado"),renderTable(x,a),LAST_EXPORT_DATA={mode:"detalhe",results:x,ciclo:a};const e=document.getElementById("comparacao-summary");e&&(e.innerHTML="")}if(V&&(V.style.display=x.length>0?"inline-block":"none"),w&&(w.style.display=x.length>0&&"complete"===CURRENT_TAB?"inline-block":"none"),"advanced"===CURRENT_TAB&&DADOS_EREDES){atualizarAnalisePotencia();const e=document.getElementById("graficos-analise-content");e&&!e.classList.contains("collapsed")&&gerarGraficosAnaliseERedes()}if("complete"===CURRENT_TAB){const e=document.getElementById("grafico-omie-content");e&&!e.classList.contains("collapsed")&&gerarGraficoOMIEDiario()}atualizarLabelsOMIE()}function criarMeuTarifario(e,t,o,a,n,i,l,s,r,c,d,u,m,p){if(!document.getElementById("meu_pot"))return null;const g=parseFloat(document.getElementById("meu_pot").value)||0,f=document.getElementById("meu_tar_en_incl").checked,_=document.getElementById("meu_tar_pot_incl").checked,h=document.getElementById("meu_tse_incl").checked,E=parseFloat(document.getElementById("meu_desc_en").value)||0,S=parseFloat(document.getElementById("meu_desc_pot").value)||0,y=parseFloat(document.getElementById("meu_desc_fat").value)||0,A=parseFloat(document.getElementById("meu_acres_fat").value)||0;let v=0,T=0,I=0,C=0,b=0,B={S:{},V:{},F:{},P:{},C:{}};const x=(e,t,o,a)=>{let n=(f?e:e+t)*(1-E/100)-t,i=n+o+(h?0:s);return B[a]={comercialSemTar:n,tarValue:o,tse:h?0:s,tarIncluded:f,tseIncluded:h},i};t.includes("Simples")?v=x(parseFloat(document.getElementById("meu_S").value)||0,i.S,m.S,"S"):t.includes("Bi")?(T=x(parseFloat(document.getElementById("meu_V").value)||0,i.V,m.V,"V"),I=x(parseFloat(document.getElementById("meu_F").value)||0,i.F,m.F,"F")):(T=x(parseFloat(document.getElementById("meu_V").value)||0,i.V,m.V,"V"),C=x(parseFloat(document.getElementById("meu_P").value)||0,i.P,m.P,"P"),b=x(parseFloat(document.getElementById("meu_C").value)||0,i.C,m.C,"C"));let F=(_?g:g+l)*(1-S/100)-l,D=F+p,P=F*o,M=p*o,V=0,w=0,k=0,$=0;e<=3.45?(V=M,w=P):w=P+M,k=.06*V,$=.23*w;let O=0;O=t.includes("Simples")?v*a.S:t.includes("Bi")?T*a.V+I*a.F:T*a.V+C*a.P+b*a.C;let L=(r?300:200)/30*o,z=0,R=0,U=0,N=0;if(e<=6.9){let e=n?O/n:0;z=Math.min(n,L)*e,R=Math.max(0,n-L)*e,U=.06*z,N=.23*R}else R=O,N=.23*R;let H=12*c/365.25*o,q=n*d,W=o>=28&&o<=32?u:u*o/30,G=.23*q,K=.23*W,Q=.06*H,j=V+w+k+$+(z+R+U+N)+q+G+W+K+H+Q-y+A,X="O Meu Tarifário",Y="",J=parseFloat(y)||0,Z=parseFloat(A)||0;if(J>0&&Z>0){let e=J-Z;if(e>0){let t=j+e;Y=` (Inclui desconto líquido de ${e.toFixed(2)}€ no período, s/ desc.=${t.toFixed(2)}€)`}else if(e<0){let t=Math.abs(e),o=j-t;Y=` (Inclui acréscimo líquido de ${t.toFixed(2)}€ no período, s/ acrésc.=${o.toFixed(2)}€)`}}else if(J>0){let e=j+J;Y=` (Inclui desconto de ${J.toFixed(2)}€ no período, s/ desc.=${e.toFixed(2)}€)`}else if(Z>0){let e=j-Z;Y=` (Inclui acréscimo de ${Z.toFixed(2)}€ no período, s/ acrésc.=${e.toFixed(2)}€)`}return X+=Y,{com:"Utilizador",nome:X,tipo:"Utilizador",total:j,uS:v,uV:T,uF:I,uP:C,uC:b,uPot:D,breakdown:B,potDetails:{comercial:F,tarPotValue:p,tarIncluded:_},details:{costPot6:V,costPot23:w,costEn6:z,costEn23:R,taxPot6:k,taxPot23:$,taxEn6:U,taxEn23:N,iec:q,dgeg:W,cav:H,taxIEC:G,taxDGEG:K,taxCAV:Q,desc:y,quotaACP:0,acrescimo:A,site:"",notas:""}}}function criarTarifarioPersonalizado(e,t,o,a,n,i,l,s,r,c,d,u,m,p){if(!document.getElementById("pers_ativo")||!document.getElementById("pers_ativo").checked)return null;const g=!document.getElementById("pers_tar_energia")||document.getElementById("pers_tar_energia").checked,f=!document.getElementById("pers_tar_potencia")||document.getElementById("pers_tar_potencia").checked,_=!document.getElementById("pers_tse_incluido")||document.getElementById("pers_tse_incluido").checked;let h=0,E=0,S=0,y=0,A=0,v={S:{},V:{},F:{},P:{},C:{}},T=0;const I=(e,t,o,a)=>{let n=g?e-t:e,i=n+o+(_?0:s);return v[a]={comercialSemTar:n,tarValue:o,tse:_?0:s,tarIncluded:g,tseIncluded:_},i};if(t.includes("Simples")){const e=document.getElementById("pers_energia_s");e&&(h=I(parseFloat(e.value)||0,i.S,m.S,"S"));const t=document.getElementById("pers_potencia_s");t&&(T=parseFloat(t.value)||0)}else if(t.includes("Bi")){const e=document.getElementById("pers_energia_v_bi"),t=document.getElementById("pers_energia_f_bi");e&&(E=I(parseFloat(e.value)||0,i.V,m.V,"V")),t&&(S=I(parseFloat(t.value)||0,i.F,m.F,"F"));const o=document.getElementById("pers_potencia_bi");o&&(T=parseFloat(o.value)||0)}else{const e=document.getElementById("pers_energia_v_tri"),t=document.getElementById("pers_energia_c_tri"),o=document.getElementById("pers_energia_p_tri");e&&(E=I(parseFloat(e.value)||0,i.V,m.V,"V")),t&&(A=I(parseFloat(t.value)||0,i.C,m.C,"C")),o&&(y=I(parseFloat(o.value)||0,i.P,m.P,"P"));const a=document.getElementById("pers_potencia_tri");a&&(T=parseFloat(a.value)||0)}let C=f?T-l:T,b=C+p,B=C*o,x=p*o,F=0,D=0,P=0,M=0;e<=3.45?(F=x,D=B):D=B+x,P=.06*F,M=.23*D;let V=0;V=t.includes("Simples")?h*a.S:t.includes("Bi")?E*a.V+S*a.F:E*a.V+y*a.P+A*a.C;let w=(r?300:200)/30*o,k=0,$=0,O=0,L=0;if(e<=6.9){let e=n?V/n:0;k=Math.min(n,w)*e,$=Math.max(0,n-w)*e,O=.06*k,L=.23*$}else $=V,L=.23*$;let z=12*c/365.25*o,R=n*d,U=o>=28&&o<=32?u:u*o/30,N=.23*R,H=.23*U,q=.06*z;return{com:"Personalizado",nome:"Tarifário Personalizado",tipo:"Personalizado",total:F+D+P+M+(k+$+O+L)+R+N+U+H+z+q,uS:h,uV:E,uF:S,uP:y,uC:A,uPot:b,breakdown:v,potDetails:{comercial:C,tarPotValue:p,tarIncluded:f},details:{costPot6:F,costPot23:D,costEn6:k,costEn23:$,taxPot6:P,taxPot23:M,taxEn6:O,taxEn23:L,iec:R,dgeg:U,cav:z,taxIEC:N,taxDGEG:H,taxCAV:q,desc:0,quotaACP:0,acrescimo:0,site:"",notas:"Tarifário configurado pelo utilizador."}}}function calcularModoComparacao(e,t,o,a,n,i,l,s,r,c,d,u,m,p,g){const f="advanced"===CURRENT_TAB&&DADOS_EREDES&&DADOS_EREDES.consumosAgregados,_=document.getElementById("tarifa_social").checked,h=document.getElementById("quota_acp").checked,E=document.getElementById("ocultar_edp_h").checked,S=document.getElementById("d_inicio").value,y=document.getElementById("d_fim").value,A=document.getElementById("f_segmento").value,v=document.getElementById("f_fatura").value,T=document.getElementById("f_pagamento").value,I=Array.from(document.querySelectorAll(".chk-tipo:checked")).map(e=>e.value);let C=[];if(f)C=t<=20.7?[{display:"Simples",dbName:"Simples"},{display:"Bi Diário",dbName:"Bi-horário - Ciclo Diário"},{display:"Bi Semanal",dbName:"Bi-horário - Ciclo Semanal"},{display:"Tri Diário",dbName:"Tri-horário - Ciclo Diário"},{display:"Tri Semanal",dbName:"Tri-horário - Ciclo Semanal"}]:[{display:"Simples",dbName:"Simples"},{display:"Tri Diário >20.7",dbName:"Tri-horário > 20.7 kVA - Ciclo Diário"},{display:"Tri Semanal >20.7",dbName:"Tri-horário > 20.7 kVA - Ciclo Semanal"}];else{const e=o.includes("Semanal")?"Semanal":"Diário";t<=20.7?o.includes("Tri")?C=[{display:"Simples",dbName:"Simples"},{display:"Bi-horário",dbName:`Bi-horário - Ciclo ${e}`},{display:"Tri-horário",dbName:`Tri-horário - Ciclo ${e}`}]:o.includes("Bi")&&(C=[{display:"Simples",dbName:"Simples"},{display:"Bi-horário",dbName:`Bi-horário - Ciclo ${e}`}]):C=[{display:"Simples",dbName:"Simples"},{display:"Tri-horário >20.7",dbName:"Tri-horário > 20.7 kVA - Ciclo "+(o.includes("Semanal")?"Semanal":"Diário")}]}if(C.length<=1)return{opcoes:C,resultados:[]};const b={};for(const e of C){const l=e.dbName;let r={S:0,V:0,F:0,P:0,C:0};if(l.includes("Simples"))r.S=getConst("TAR_Energia_Simples");else if(l.includes("Bi"))r.V=getConst("TAR_Energia_Bi_Vazio"),r.F=getConst("TAR_Energia_Bi_ForaVazio");else{let e=t>20.7?"TAR_Energia_Tri_27.6_":"TAR_Energia_Tri_";r.V=getConst(e+"Vazio"),r.P=getConst(e+"Ponta"),r.C=getConst(e+"Cheias")}let c=0,d=0;_&&t<=6.9&&(c=getConst("Desconto TS Energia"),d=getConst(`Desconto TS Potencia ${t}`));let u={S:r.S-c,V:r.V-c,F:r.F-c,P:r.P-c,C:r.C-c},m=s-d,p=_&&t<=6.9?0:getConst("IEC"),g={S:0,V:0,F:0,P:0,C:0};if(f){const e=DADOS_EREDES.consumosAgregados;if(l.includes("Simples"))g.S=e.Simples||0;else if(l.includes("Bi")){const t=l.includes("Diário")?"BD":"BS";g.V=e[t]?.V||0,g.F=e[t]?.F||0}else{const t=l.includes("Diário")?"TD":"TS";g.V=e[t]?.V||0,g.C=e[t]?.C||0,g.P=e[t]?.P||0}}else l.includes("Simples")?g.S=i:l.includes("Bi")?o.includes("Tri")?(g.V=n.V,g.F=n.C+n.P):o.includes("Bi")&&(g.V=n.V,g.F=n.F):l.includes("Tri")&&o.includes("Tri")&&(g.V=n.V,g.C=n.C,g.P=n.P);let h=g.S+g.V+g.F+g.P+g.C,E={S:0,V:0,F:0,P:0,C:0};{let e="Simp";l.includes("Bi")&&(e=l.includes("Diário")?"BD":"BS"),l.includes("Tri")&&(e=l.includes("Diário")?"TD":"TS"),E.S=getOmieAvg("Simp","S"),l.includes("Bi")?(E.V=getOmieAvg(e,"V"),E.F=getOmieAvg(e,"F")):l.includes("Tri")&&(E.V=getOmieAvg(e,"V"),E.P=getOmieAvg(e,"P"),E.C=getOmieAvg(e,"C"))}let A={},v={};if(DATA.indexados&&DATA.indexados.length>0){const e=obter_perfil(h,a,t),o=calculateDetailedQH(S,y,e,l);A=o.perfil||{},f&&o.diagrama&&(v=o.diagrama)}b[e.display]={dbName:l,tarEnBase:r,tarEnFinal:u,tarPotRegFinal:m,consumos:g,totalKwh:h,omie:E,qhResults:A,qhDiagramaResults:v,iecVal:p}}const B=(e,o,n,i,l)=>{const u=b[i];if(!u||0===u.totalKwh)return null;const p=u.dbName,g=e.nome||"",f=e.comercializador||"";let _=getVal(e,"fixo",n),E=parseBool(e[n.tar_p_incl]);void 0===E&&(E=!o);let y=E?_-s:_,A=y+u.tarPotRegFinal,v=parseBool(e[n.tar_e_incl]);void 0===v&&(v=!o);let T=parseBool(e[n.tse_incl]);void 0===T&&(T=!0);let I=(e[n.tipo]||(o?"Indexado Média":"Fixo")).trim(),C={S:u.omie.S/1e3,V:u.omie.V/1e3,F:u.omie.F/1e3,P:u.omie.P/1e3,C:u.omie.C/1e3};const B=l||u.qhResults;let x={S:{},V:{},F:{},P:{},C:{}};const F=(e,t,a,n)=>{let i=e;if(o)if("Indexado quarto-horário"===I)B[g]&&(i=B[g][n]||0);else{let e=C[n],t=C.S,o="S";p.includes("Bi")?o=p.includes("Diário")?"BD":"BS":p.includes("Tri")&&(o=p.includes("Diário")?"TD":"TS");let a=1,l=1.16;p.includes("Simples")?(a=getPerdas("Perdas_Anual_S")||1,l=getPerdas("Perdas_M_S")||1.16):(a=getPerdas(`Perdas_Anual_${o}_${n}`)||1,l=getPerdas(`Perdas_M_${o}_${n}`)||1.16),i=g.includes("BTN SPOTDEF")?B[g]&&void 0!==B[g][n]?B[g][n]:(e+getConst("Luzboa_CGS"))*a*getConst("Luzboa_FA")+getConst("Luzboa_Kp"):g.includes("Iberdrola")?e*getConst("Iberdrola_Perdas")+getConst("Iberdrola_Media_Q")+getConst("Iberdrola_mFRR"):g.includes("Goldenergy")?e*({1:1.29,2:1.18,3:1.18,4:1.15,5:1.11,6:1.1,7:1.15,8:1.13,9:1.1,10:1.1,11:1.16,12:1.25}[new Date(S).getMonth()+1]||1.16)+getConst("GE_Q_Tarifa")+getConst("GE_CG"):g.includes("Endesa")?e+getConst(`Endesa_A_${"F"===n?"FV":n}`):g.includes("LUZiGÁS - Energy 8.8")?(t+getConst("Luzigas_8_8_K")+getConst("Luzigas_CGS"))*a:g.includes("LUZiGÁS - Super Lig Index")?(t+getConst("Luzigas_K")+getConst("Luzigas_CGS"))*a:g.includes("Ibelectra - Solução Família")?(e+getConst("Ibelectra_CS"))*getConst("Ibelectra_Perdas")+getConst("Ibelectra_K"):g.includes("Ibelectra - Solução Amigo")?(e+getConst("Ibelectra_CS"))*getConst("Ibelectra_Perdas")+getConst("Ibelectra_K_a"):g.includes("G9 - Smart Index")?e*getConst("G9_FA")*l+getConst("G9_CGS")+getConst("G9_AC"):g.includes("EDP - Eletricidade Indexada Média")?e*getConst("EDP_M_Perdas")*getConst("EDP_M_K1")+getConst("EDP_M_K2"):e+.02}let l=v?i-t:i,s=l+a+(T?0:r);return x[n]={comercialSemTar:l,tarValue:a,tse:T?0:r,tarIncluded:v,tseIncluded:T},s};let D=0,P=0,M=0,V=0,w=0;if(p.includes("Simples"))D=F(o?0:getVal(e,"pS",n),u.tarEnBase.S,u.tarEnFinal.S,"S");else if(p.includes("Bi")){let t=o?0:getVal(e,"pV_bi",n)||getVal(e,"pS",n),a=o?0:getVal(e,"pF",n)||getVal(e,"pS",n);P=F(t,u.tarEnBase.V,u.tarEnFinal.V,"V"),M=F(a,u.tarEnBase.F,u.tarEnFinal.F,"F")}else{let t=o?0:getVal(e,"pV_tri",n)||getVal(e,"pS",n),a=o?0:getVal(e,"pP",n)||getVal(e,"pF",n)||getVal(e,"pS",n),i=o?0:getVal(e,"pC",n)||getVal(e,"pF",n)||getVal(e,"pS",n);P=F(t,u.tarEnBase.V,u.tarEnFinal.V,"V"),V=F(a,u.tarEnBase.P,u.tarEnFinal.P,"P"),w=F(i,u.tarEnBase.C,u.tarEnFinal.C,"C")}let k=y*a,$=u.tarPotRegFinal*a,O=0,L=0;t<=3.45?(O=$,L=k):L=k+$;let z=.06*O,R=.23*L;const U=u.consumos;let N=0;N=p.includes("Simples")?D*U.S:p.includes("Bi")?P*U.V+M*U.F:P*U.V+V*U.P+w*U.C;let H,q=(c?300:200)/30*a,W=0,G=0,K=0,Q=0;if(t<=6.9){if(p.includes("Simples")){let e=Math.min(u.totalKwh,q),t=Math.max(0,u.totalKwh-q),o=u.totalKwh?N/u.totalKwh:0;W=e*o,G=t*o}else{let e=p.includes("Bi")?{V:U.V,F:U.F}:{V:U.V,P:U.P,C:U.C},t=p.includes("Bi")?{V:P*U.V,F:M*U.F}:{V:P*U.V,P:V*U.P,C:w*U.C},o=0,a=0;for(let n in e){let i=q*(u.totalKwh>0?e[n]/u.totalKwh:0),l=Math.min(e[n],i),s=Math.max(0,e[n]-i),r=e[n]>0?t[n]/e[n]:0;o+=l*r,a+=s*r}W=o,G=a}K=.06*W,Q=.23*G}else G=N,Q=.23*G;H=CAV_FIXO_COMERCIALIZADORES.some(e=>f.includes(e))&&a>=28&&a<=32?d:12*d/365.25*a;let j=u.totalKwh*u.iecVal,X=a>=28&&a<=32?m:m*a/30,Y=.23*j,J=.23*X,Z=.06*H,ee=O+L+z+R+(W+G+K+Q)+(j+Y+X+J+H+Z),te=getVal(e,"desc_fat",n),oe=getVal(e,"desc_limit",n),ae=0;if(te>0){let e=a>=28&&a<=32?te:te*a/30;ae=oe&&oe>0&&(a>=28&&a<=32?1:a/30)>oe?te*oe:e,ee-=ae}let ne=0;return h&&g.startsWith("Goldenergy - ACP")&&(ne=a>=28&&a<=32?getConst("Quota_ACP"):getConst("Quota_ACP")*a/30,ee+=ne),{total:ee,uS:D,uV:P,uF:M,uP:V,uC:w,uPot:A,breakdown:x,potDetails:{comercial:y,tarPotValue:u.tarPotRegFinal,tarIncluded:E},details:{costPot6:O,costPot23:L,costEn6:W,costEn23:G,taxPot6:z,taxPot23:R,taxEn6:K,taxEn23:Q,iec:j,dgeg:X,cav:H,taxIEC:Y,taxDGEG:J,taxCAV:Z,desc:ae,quotaACP:ne,acrescimo:0,site:e[n.site],notas:e[n.notas]}}},x=new Map,F=(e,o,a)=>{e.forEach(e=>{const n=e.nome||"",i=e.comercializador||"",l=(e[a.tipo]||(o?"Indexado Média":"Fixo")).trim();if((!E||!n.includes("EDP - Eletricidade Indexada Horária"))&&I.includes(l)&&((e,t)=>{const o=e[t.seg]||"";if("Residencial"===A&&"Doméstico"!==o&&"Doméstico e Não Doméstico"!==o)return!1;if("Empresarial"===A&&"Não Doméstico"!==o&&"Doméstico e Não Doméstico"!==o)return!1;const a=e[t.fat]||"";if("Fatura eletrónica"===v&&!a.includes("Fatura eletrónica"))return!1;if("Fatura em papel"===v&&!a.includes("Fatura em papel"))return!1;const n=e[t.pag]||"";if("Débito Direto"===T&&!n.includes("Débito Direto"))return!1;if("Multibanco"===T&&!n.includes("Multibanco"))return!1;if("Numerário/Payshop/CTT"===T&&!n.includes("Numerário")&&!n.includes("Payshop")&&!n.includes("CTT"))return!1;const i=e.comercializador||"";if("complete"===CURRENT_TAB&&STATE_ABA2.excludedProviders.includes(i))return!1;if("advanced"===CURRENT_TAB&&STATE_ABA3.excludedProviders.includes(i))return!1;const l=document.getElementById("f_procura")?document.getElementById("f_procura").value.toLowerCase():"";if(l){const t=(e.nome||"").toLowerCase(),o=(e.comercializador||"").toLowerCase();if(!t.includes(l)&&!o.includes(l))return!1}return!0})(e,a)&&!(Math.abs(getVal(e,"pot",a)-t)>.1))if(o&&"Indexado quarto-horário"===l&&f){const t=`${n} - Perfil|${i}`;if(x.has(t)||x.set(t,{nome:n,nomeDisplay:n+" - Perfil",com:i,tipo:"Indexado quarto-horário - Perfil",isIndexado:o,site:e[a.site],notas:e[a.notas],cols:a,qhVariant:"perfil"}),C.some(e=>{const t=b[e.display];return t&&t.qhDiagramaResults&&Object.keys(t.qhDiagramaResults).length>0})){const t=`${n} - Diagrama|${i}`;x.has(t)||x.set(t,{nome:n,nomeDisplay:n+" - Diagrama",com:i,tipo:"Indexado quarto-horário - Diagrama",isIndexado:o,site:e[a.site],notas:e[a.notas],cols:a,qhVariant:"diagrama"})}}else{const t=`${n}|${i}`;x.has(t)||x.set(t,{nome:n,nomeDisplay:n,com:i,tipo:l,isIndexado:o,site:e[a.site],notas:e[a.notas],cols:a,qhVariant:null})}})};F(DATA.fixos,!1,COLS_FIXO),DATA.indexados&&DATA.indexados.length>0&&F(DATA.indexados,!0,COLS_INDEX);const D=[];for(const[e,o]of x){const e={nome:o.nomeDisplay,com:o.com,tipo:o.tipo,site:o.site,notas:o.notas,custos:{},detalhes:{},melhorOpcao:"",menorCusto:1/0};let a=!1;for(const n of C){const i=(o.isIndexado?DATA.indexados:DATA.fixos).find(e=>e.nome===o.nome&&e.comercializador===o.com&&Math.abs(getVal(e,"pot",o.cols)-t)<.1&&(e[o.cols.ciclo]||"").toLowerCase()===n.dbName.toLowerCase());if(i){const t="diagrama"===o.qhVariant?b[n.display]?.qhDiagramaResults:"perfil"===o.qhVariant?b[n.display]?.qhResults:null,l=B(i,o.isIndexado,o.cols,n.display,t);null===l||isNaN(l.total)||(e.custos[n.display]=l.total,e.detalhes[n.display]=l,a=!0,l.total<e.menorCusto&&(e.menorCusto=l.total,e.melhorOpcao=n.display))}}a&&D.push(e)}if(document.getElementById("meu_ativo")&&document.getElementById("meu_ativo").checked){const t=e.find(e=>e.nome&&e.nome.includes("O Meu Tarifário"));if(t){const e={nome:t.nome,com:t.com||"Utilizador",tipo:"Utilizador",site:"",notas:"",custos:{},detalhes:{},melhorOpcao:"",menorCusto:1/0},a=C.find(e=>e.dbName.toLowerCase()===o.toLowerCase());a&&(e.custos[a.display]=t.total,e.menorCusto=t.total,e.melhorOpcao=a.display,e.detalhes[a.display]={total:t.total,uS:t.uS,uV:t.uV,uF:t.uF,uP:t.uP,uC:t.uC,uPot:t.uPot,breakdown:t.breakdown,potDetails:t.potDetails,details:t.details}),D.push(e)}}if(document.getElementById("pers_ativo")&&document.getElementById("pers_ativo").checked){const e={nome:"Tarifário Personalizado",com:"Personalizado",tipo:"Personalizado",site:"",notas:"Tarifário configurado pelo utilizador.",custos:{},detalhes:{},melhorOpcao:"",menorCusto:1/0};for(const o of C){const n=b[o.display];if(!n||0===n.totalKwh)continue;const i=calcularPersParaOpcaoComp(o.dbName,n,t,a,c,d,m,r,s);null===i||isNaN(i.total)||(e.custos[o.display]=i.total,e.detalhes[o.display]=i,i.total<e.menorCusto&&(e.menorCusto=i.total,e.melhorOpcao=o.display))}Object.keys(e.custos).length>0&&D.push(e)}if(SORT_COMPARACAO.col&&"nome"!==SORT_COMPARACAO.col)D.sort((e,t)=>{const o=e.custos[SORT_COMPARACAO.col]??1/0,a=t.custos[SORT_COMPARACAO.col]??1/0;return SORT_COMPARACAO.asc?o-a:a-o});else if("nome"===SORT_COMPARACAO.col)D.sort((e,t)=>SORT_COMPARACAO.asc?e.nome.localeCompare(t.nome):t.nome.localeCompare(e.nome));else{const e=C[0]?.display;e&&D.sort((t,o)=>(t.custos[e]??1/0)-(o.custos[e]??1/0))}return{opcoes:C,resultados:D}}function calcularPersParaOpcaoComp(e,t,o,a,n,i,l,s,r){const c=document.getElementById("pers_tar_potencia")?.checked??!0,d=document.getElementById("pers_tar_energia")?.checked??!0,u=document.getElementById("pers_tse_incluido")?.checked??!0;let m=0,p=0,g=0,f=0,_=0,h=0,E={S:{},V:{},F:{},P:{},C:{}};if(e.includes("Simples")){const e=document.getElementById("pers_energia_s");if(!e)return null;m=parseFloat(e.value)||0,h=parseFloat(document.getElementById("pers_potencia_s")?.value)||0}else if(e.includes("Bi")){const e=document.getElementById("pers_energia_v_bi"),t=document.getElementById("pers_energia_f_bi");if(!e||!t)return null;p=parseFloat(e.value)||0,g=parseFloat(t.value)||0,h=parseFloat(document.getElementById("pers_potencia_bi")?.value)||0}else{const e=document.getElementById("pers_energia_v_tri"),t=document.getElementById("pers_energia_c_tri"),o=document.getElementById("pers_energia_p_tri");if(!e||!t||!o)return null;p=parseFloat(e.value)||0,_=parseFloat(t.value)||0,f=parseFloat(o.value)||0,h=parseFloat(document.getElementById("pers_potencia_tri")?.value)||0}if(0===h&&0===m&&0===p&&0===g&&0===f&&0===_)return null;const S=(e,t,o,a)=>{let n=d?e-t:e,i=n+o+(u?0:s);return E[a]={comercialSemTar:n,tarValue:o,tse:u?0:s,tarIncluded:d,tseIncluded:u},i};e.includes("Simples")?m=S(m,t.tarEnBase.S,t.tarEnFinal.S,"S"):e.includes("Bi")?(p=S(p,t.tarEnBase.V,t.tarEnFinal.V,"V"),g=S(g,t.tarEnBase.F,t.tarEnFinal.F,"F")):(p=S(p,t.tarEnBase.V,t.tarEnFinal.V,"V"),f=S(f,t.tarEnBase.P,t.tarEnFinal.P,"P"),_=S(_,t.tarEnBase.C,t.tarEnFinal.C,"C"));let y=c?h-r:h,A=y+t.tarPotRegFinal,v=y*a,T=t.tarPotRegFinal*a,I=0,C=0;o<=3.45?(I=T,C=v):C=v+T;let b=.06*I,B=.23*C;const x=t.consumos;let F=0;F=e.includes("Simples")?m*x.S:e.includes("Bi")?p*x.V+g*x.F:p*x.V+f*x.P+_*x.C;let D=(n?300:200)/30*a,P=0,M=0,V=0,w=0;if(o<=6.9){let e=Math.min(t.totalKwh,D),o=Math.max(0,t.totalKwh-D),a=t.totalKwh?F/t.totalKwh:0;P=e*a,M=o*a,V=.06*P,w=.23*M}else M=F,w=.23*M;let k=12*i/365.25*a,$=t.totalKwh*t.iecVal,O=a>=28&&a<=32?l:l*a/30,L=.23*$,z=.23*O,R=.06*k;return{total:I+C+b+B+(P+M+V+w)+$+L+O+z+k+R,uS:m,uV:p,uF:g,uP:f,uC:_,uPot:A,breakdown:E,potDetails:{comercial:y,tarPotValue:t.tarPotRegFinal,tarIncluded:c},details:{costPot6:I,costPot23:C,costEn6:P,costEn23:M,taxPot6:b,taxPot23:B,taxEn6:V,taxEn23:w,iec:$,dgeg:O,cav:k,taxIEC:L,taxDGEG:z,taxCAV:R,desc:0,quotaACP:0,acrescimo:0,site:"",notas:"Tarifário configurado pelo utilizador."}}}function toggleResumo(){const e=document.getElementById("resumo-content"),t=document.getElementById("resumo-icon");"none"===e.style.display?(e.style.display="block",t.className="fa-solid fa-chevron-down"):(e.style.display="none",t.className="fa-solid fa-chevron-right")}function toggleAnalise(){const e=document.getElementById("analise-content"),t=document.getElementById("analise-icon");"none"===e.style.display?(e.style.display="block",t.className="fa-solid fa-chevron-down"):(e.style.display="none",t.className="fa-solid fa-chevron-right")}function criarTabelaAnalise(e,t){const o={},a=e.Simples||0,n={S:["S"],BD:["V","F"],BS:["V","F"],TD:["V","C","P"],TS:["V","C","P"]};for(const[i,l]of Object.entries(n)){const n="S"===i?a:Object.values(e[i]||{}).reduce((e,t)=>e+t,0);for(const s of l){const l="S"===i?"S":`${i}_${s}`,r="S"===i?a:e[i]?.[s]||0,c=n>0?r/n*100:"S"===i?100:0;o[`${i}_${s}`]={omie:t[l]||0,kwh:r,perc:c}}}const i=(e,t,o=0,a="")=>`<td class="cell-${t}">${((e,t=0,o="")=>{try{return e.toLocaleString("pt-PT",{minimumFractionDigits:t,maximumFractionDigits:t})+o}catch{return"-"}})(e,o,a)}</td>`;return`\n            <style>\n                .analise-table { width: 100%; border-collapse: collapse; font-size: 11px; text-align: center; table-layout: fixed; margin-top:10px; }\n                .analise-table th, .analise-table td { padding: 4px 2px; border: 1px solid #ccc; word-wrap: break-word; overflow: hidden; }\n                .analise-table thead th { font-weight: bold; vertical-align: middle; height: 30px; }\n                \n                /* Estilo da primeira coluna (Rótulos) */\n                .row-label { font-weight: 600; text-align: left; padding-left: 8px !important; background-color: #f8fafc; }\n\n                /* Cores Cabeçalhos */\n                .header-S { background-color: #A6A6A6; color: #000; }\n                .header-BD { background-color: #A9D08E; color: #000; }\n                .header-BS { background-color: #8EA9DB; color: #000; }\n                .header-TD { background-color: #BF8F00; color: #FFF; }\n                .header-TS { background-color: #C65911; color: #FFF; }\n                \n                /* Cores Células */\n                .cell-S { background-color: #D9D9D9; } .cell-BD_V { background-color: #C6E0B4; } .cell-BD_F { background-color: #E2EFDA; }\n                .cell-BS_V { background-color: #B4C6E7; } .cell-BS_F { background-color: #D9E1F2; } .cell-TD_V { background-color: #FFD966; }\n                .cell-TD_C { background-color: #FFE699; } .cell-TD_P { background-color: #FFF2CC; } .cell-TS_V { background-color: #F4B084; }\n                .cell-TS_C { background-color: #F8CBAD; } .cell-TS_P { background-color: #FCE4D6; }\n            </style>\n            \n            <table class="analise-table">\n                <colgroup>\n                    <col style="width: 12%;"> <col style="width: 8%;">  <col style="width: 8%;"><col style="width: 8%;"> <col style="width: 8%;"><col style="width: 8%;"> <col style="width: 8%;"><col style="width: 8%;"><col style="width: 8%;"> <col style="width: 8%;"><col style="width: 8%;"><col style="width: 8%;"> </colgroup>\n                <thead>\n                    <tr>\n                        <th rowspan="2"></th>\n                        <th rowspan="2" class="header-S">Simples</th>\n                        <th colspan="2" class="header-BD">Bi-horário Diário</th>\n                        <th colspan="2" class="header-BS">Bi-horário Semanal</th>\n                        <th colspan="3" class="header-TD">Tri-horário Diário</th>\n                        <th colspan="3" class="header-TS">Tri-horário Semanal</th>\n                    </tr>\n                    <tr>\n                        <th class="cell-BD_V">Vazio</th><th class="cell-BD_F">F.Vazio</th>\n                        <th class="cell-BS_V">Vazio</th><th class="cell-BS_F">F.Vazio</th>\n                        <th class="cell-TD_V">Vazio</th><th class="cell-TD_C">Cheias</th><th class="cell-TD_P">Ponta</th>\n                        <th class="cell-TS_V">Vazio</th><th class="cell-TS_C">Cheias</th><th class="cell-TS_P">Ponta</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    <tr>\n                        <td class="row-label">Média OMIE (€/MWh)</td>\n                        ${i(o.S_S.omie,"S",2)}\n                        ${i(o.BD_V.omie,"BD_V",2)}${i(o.BD_F.omie,"BD_F",2)}\n                        ${i(o.BS_V.omie,"BS_V",2)}${i(o.BS_F.omie,"BS_F",2)}\n                        ${i(o.TD_V.omie,"TD_V",2)}${i(o.TD_C.omie,"TD_C",2)}${i(o.TD_P.omie,"TD_P",2)}\n                        ${i(o.TS_V.omie,"TS_V",2)}${i(o.TS_C.omie,"TS_C",2)}${i(o.TS_P.omie,"TS_P",2)}\n                    </tr>\n                    <tr>\n                        <td class="row-label">Consumo (kWh)</td>\n                        ${i(o.S_S.kwh,"S",0)}\n                        ${i(o.BD_V.kwh,"BD_V",0)}${i(o.BD_F.kwh,"BD_F",0)}\n                        ${i(o.BS_V.kwh,"BS_V",0)}${i(o.BS_F.kwh,"BS_F",0)}\n                        ${i(o.TD_V.kwh,"TD_V",0)}${i(o.TD_C.kwh,"TD_C",0)}${i(o.TD_P.kwh,"TD_P",0)}\n                        ${i(o.TS_V.kwh,"TS_V",0)}${i(o.TS_C.kwh,"TS_C",0)}${i(o.TS_P.kwh,"TS_P",0)}\n                    </tr>\n                    <tr>\n                        <td class="row-label">Peso (%)</td>\n                        ${i(o.S_S.perc,"S",1,"%")}\n                        ${i(o.BD_V.perc,"BD_V",1,"%")}${i(o.BD_F.perc,"BD_F",1,"%")}\n                        ${i(o.BS_V.perc,"BS_V",1,"%")}${i(o.BS_F.perc,"BS_F",1,"%")}\n                        ${i(o.TD_V.perc,"TD_V",1,"%")}${i(o.TD_C.perc,"TD_C",1,"%")}${i(o.TD_P.perc,"TD_P",1,"%")}\n                        ${i(o.TS_V.perc,"TS_V",1,"%")}${i(o.TS_C.perc,"TS_C",1,"%")}${i(o.TS_P.perc,"TS_P",1,"%")}\n                    </tr>\n                </tbody>\n            </table>`}function getTarifarioStyle(e,t){if(t&&t.includes("O Meu Tarifário"))return{cellClass:"cell-meu-tarif",tagClass:"meu-tarif",label:"O Meu Tarifário"};if(t&&t.includes("Tarifário Personalizado"))return{cellClass:"cell-perso",tagClass:"perso",label:"Personalizado"};switch(e){case"Indexado quarto-horário - Diagrama":return{cellClass:"cell-qh-diagrama",tagClass:"qh-diagrama",label:"Indexado quarto-horário - Diagrama"};case"Indexado quarto-horário":case"Indexado quarto-horário - Perfil":return{cellClass:"cell-qh-perfil",tagClass:"qh-perfil",label:"Indexado quarto-horário - Perfil"};case"Indexado Média":return{cellClass:"cell-index-media",tagClass:"index-media",label:"Indexado Média"};default:return{cellClass:"cell-fixo",tagClass:"fixo",label:"Fixo"}}}function atualizarResumoSimulacao(){try{const e=document.getElementById("potencia"),t=document.getElementById("ciclo"),o=document.getElementById("d_inicio"),a=document.getElementById("d_fim"),n=document.getElementById("num_dias");if(!(e&&t&&o&&a&&n))return console.log("Elementos do resumo ainda não disponíveis"),void(document.getElementById("resumo-simulacao").style.display="none");const i=parseFloat(e.value),l=t.value,s=o.value.split("-"),r=new Date(parseInt(s[0]),parseInt(s[1])-1,parseInt(s[2])),c=a.value.split("-"),d=new Date(parseInt(c[0]),parseInt(c[1])-1,parseInt(c[2])),u=parseInt(n.value);if(isNaN(r.getTime())||isNaN(d.getTime())||isNaN(u))return void(document.getElementById("resumo-simulacao").style.display="none");const m={S:0,V:0,F:0,P:0,C:0};document.getElementById("kwh_S")&&(m.S=parseFloat(document.getElementById("kwh_S").value)||0),document.getElementById("kwh_V")&&(m.V=parseFloat(document.getElementById("kwh_V").value)||0),document.getElementById("kwh_F")&&(m.F=parseFloat(document.getElementById("kwh_F").value)||0),document.getElementById("kwh_P")&&(m.P=parseFloat(document.getElementById("kwh_P").value)||0),document.getElementById("kwh_C")&&(m.C=parseFloat(document.getElementById("kwh_C").value)||0);const p=m.S+m.V+m.F+m.P+m.C,g=OMIE_VALUES.S,f=OMIE_VALUES.V,_=OMIE_VALUES.F,h=OMIE_VALUES.C,E=OMIE_VALUES.P,S=obter_perfil(p,u,i).replace(/^(perfil_|BTN_)/i,"Perfil ").toUpperCase(),y=document.getElementById("f_segmento"),A=document.getElementById("f_fatura"),v=document.getElementById("f_pagamento"),T=y?y.value:"Todos",I=A?A.value:"Todas",C=v?v.value:"Todos";let b=T;"Todos"===T&&(b="Residencial e Empresarial");const B=!!document.getElementById("familia_numerosa")&&document.getElementById("familia_numerosa").checked,x=!!document.getElementById("tarifa_social")&&document.getElementById("tarifa_social").checked;let F=`\n                    <li style="margin-bottom:5px;"><b>Segmento:</b> ${b} &nbsp;&nbsp;|&nbsp;&nbsp; <b>Faturação:</b> ${I} &nbsp;&nbsp;|&nbsp;&nbsp; <b>Pagamento:</b> ${C}</li>\n                    <li style="margin-bottom:5px;"><b>${i} kVA</b> em <b>${l}</b></li>\n                `,D="";D=l.includes("Simples")?`Simples: ${m.S.toFixed(0)} kWh`:l.includes("Bi")?`Vazio: ${m.V.toFixed(0)} kWh, Fora Vazio: ${m.F.toFixed(0)} kWh`:`Vazio: ${m.V.toFixed(0)} kWh, Cheias: ${m.C.toFixed(0)} kWh, Ponta: ${m.P.toFixed(0)} kWh`,F+=`<li style="margin-bottom:5px;"><b>Consumos (${p.toFixed(0)} kWh Total):</b> ${D}</li>`;const P=e=>`${e.getDate().toString().padStart(2,"0")}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getFullYear()}`;F+=`<li style="margin-bottom:5px;"><b>Período:</b> De ${P(r)} a ${P(d)} (${u} dias)</li>`;let M="";M=l.includes("Simples")?`Simples: ${g.toFixed(2)} €/MWh`:l.includes("Bi")?`Vazio: ${f.toFixed(2)} €/MWh, Fora Vazio: ${_.toFixed(2)} €/MWh`:`Vazio: ${f.toFixed(2)} €/MWh, Cheias: ${h.toFixed(2)} €/MWh, Ponta: ${E.toFixed(2)} €/MWh`;let V="OMIE (Média Final)";V=OMIE_MANUAL?"OMIE (manual)":verificarIncluiFuturosOMIP()?"OMIE / OMIP (Média com Futuros)":"OMIE (Média Final)",F+=`<li style="margin-bottom:5px;"><b>${V}:</b> ${M}</li>`,F+=`<li style="margin-bottom:5px;"><b>Perfil de Consumo:</b> ${S}</li>`;let w=[];B&&w.push('<span style="color:#16a34a; font-weight:600;">Família Numerosa</span>'),x&&w.push('<span style="color:#16a34a; font-weight:600;">Tarifa Social</span>'),w.length>0&&(F+=`<li style="margin-top:8px; padding-top:4px; border-top:1px dashed #ccc;"><b>Benefícios Ativos:</b> ${w.join(" + ")}</li>`);const k=document.getElementById("resumo-list"),$=document.getElementById("resumo-simulacao");k&&$&&(k.innerHTML=F,$.style.display="block")}catch(e){console.error("Erro ao atualizar resumo:",e),document.getElementById("resumo-simulacao").style.display="none"}}function calcularMensagemPoupanca(e){try{const t=document.getElementById("mensagem-poupanca");if(!t)return void console.log("Elemento mensagem-poupanca não encontrado");const o=e.find(e=>e.nome&&e.nome.includes("O Meu Tarifário"));if(!o||!o.total||o.total<=0)return void(t.style.display="none");const a=e.filter(e=>"Utilizador"!==e.tipo&&e.total>0&&!e.nome.includes("O Meu Tarifário"));if(0===a.length)return t.innerHTML=`<span style="color:black; font-weight:normal;">Não há outros tarifários com custos válidos para comparar com '${o.nome}' (${o.total.toFixed(2)}€).</span>`,void(t.style.display="block");const n=a.reduce((e,t)=>t.total<e.total?t:e),i=o.total,l=n.total;if(i>l){const e=i-l,a=e/i*100;t.innerHTML=`\n                        <span style="color:red; font-weight:bold;">\n                            Poupança entre '${o.nome}' (${i.toFixed(2)} €) e o mais económico da lista, \n                            ${n.nome} (${l.toFixed(2)} €): \n                        </span>\n                        <span style="color:red; font-weight:bold;">${e.toFixed(2)} €</span>\n                        <span style="color:red; font-weight:bold;"> (${a.toFixed(2)} %).</span>\n                    `}else t.innerHTML=`<span style="color:green; font-weight:bold;">Parabéns! O seu tarifário ('${o.nome}' - ${i.toFixed(2)}€) já é o mais económico ou está entre os mais económicos da lista!</span>`;t.style.display="block"}catch(e){console.error("Erro ao calcular mensagem de poupança:",e);const t=document.getElementById("mensagem-poupanca");t&&(t.style.display="none")}}function gerarCorGradiente(e,t,o){try{if(isNaN(e)||null===t||null===o||void 0===t||void 0===o||o===t)return{bg:"#FFFFFF",text:"#000000"};const a=(t+o)/2;let n=255,i=255,l=255;const s=[90,138,198],r=[255,255,255],c=[247,150,70];if(e<=a){const o=(e-t)/(a-t);n=Math.round(s[0]*(1-o)+r[0]*o),i=Math.round(s[1]*(1-o)+r[1]*o),l=Math.round(s[2]*(1-o)+r[2]*o)}else{const t=(e-a)/(o-a);n=Math.round(r[0]*(1-t)+c[0]*t),i=Math.round(r[1]*(1-t)+c[1]*t),l=Math.round(r[2]*(1-t)+c[2]*t)}const d=.299*n+.587*i+.114*l>140?"#000000":"#FFFFFF";return{bg:"#"+[n,i,l].map(e=>e.toString(16).padStart(2,"0")).join("").toUpperCase(),text:d}}catch(e){return console.error("Erro ao gerar cor gradiente:",e),{bg:"#FFFFFF",text:"#000000"}}}function renderTable(e,t){const o=document.getElementById("thead"),a=document.getElementById("tbody");a.innerHTML="";let n="";t.includes("Simples")?n="ciclo-simples":t.includes("Bi-horário")&&t.includes("Diário")?n="ciclo-bi-diario":t.includes("Bi-horário")&&t.includes("Semanal")?n="ciclo-bi-semanal":t.includes("Tri-horário")&&t.includes("Diário")?n="ciclo-tri-diario":t.includes("Tri-horário")&&t.includes("Semanal")&&(n="ciclo-tri-semanal");let i=`<th class="${n}" onclick="setSort('nome')">Tarifário <i class="fa-solid fa-sort"></i></th>\n                     <th class="${n}" onclick="setSort('total')">Total (€) <i class="fa-solid fa-sort"></i></th>`;const l=(e,t)=>`<th class="${n}" onclick="setSort('${t}')">${e} <i class="fa-solid fa-sort"></i></th>`;t.includes("Simples")?i+=l("Simples (€/kWh)","uS")+l("Potência (€/dia)","uPot"):t.includes("Bi")?i+=l("Vazio (€/kWh)","uV")+l("Fora Vazio (€/kWh)","uF")+l("Potência (€/dia)","uPot"):i+=l("Vazio (€/kWh)","uV")+l("Cheias (€/kWh)","uC")+l("Ponta (€/kWh)","uP")+l("Potência (€/dia)","uPot"),i+=`<th class="${n}">Detalhes</th>`,o.innerHTML=`<tr>${i}</tr>`;const s=(e,t)=>{const o=e.map(e=>e[t]).filter(e=>null!=e&&!isNaN(e));return 0===o.length?{min:null,max:null}:{min:Math.min(...o),max:Math.max(...o)}},r=s(e,"total"),c=s(e,"uS"),d=s(e,"uV"),u=s(e,"uF"),m=s(e,"uP"),p=s(e,"uC"),g=s(e,"uPot"),f=e=>e.toFixed(4),_=e=>JSON.stringify(e).replace(/"/g,"&quot;");e.slice(0,150).forEach(e=>{const o=getTarifarioStyle(e.tipo,e.nome),n=gerarCorGradiente(e.total,r.min,r.max);let i=`\n                    <td class="${o.cellClass}">\n                        <div class="tariff-name" onclick="window.open('${e.details.site||"#"}', '_blank')" onmouseenter="showTooltipNome(event, ${_(e.nome)}, ${_(e.details.notas||"")})" onmouseleave="hideTooltip()">${e.com}</div>\n                        <div style="font-size:0.78rem; color:var(--text-light); margin-bottom:4px;">${e.nome}</div>\n                        <span class="tag ${o.tagClass}">${o.label}</span>\n                    </td>\n                    <td class="price-main" style="background-color:${n.bg}; color:${n.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipTotal(event, ${_(e.details)}, ${_(e.nome)})" onmouseleave="hideTooltip()">${e.total.toFixed(2)} €</td>`;if(t.includes("Simples")){const t=gerarCorGradiente(e.uS,c.min,c.max),o=gerarCorGradiente(e.uPot,g.min,g.max);i+=`<td class="price-sub" style="background-color:${t.bg}; color:${t.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipEnergy(event, ${_(e.breakdown.S)}, 'S')" onmouseleave="hideTooltip()">${f(e.uS)}</td>`,i+=`<td class="price-sub" style="background-color:${o.bg}; color:${o.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipPot(event, ${_(e.potDetails)})" onmouseleave="hideTooltip()">${f(e.uPot)}</td>`}else if(t.includes("Bi")){const t=gerarCorGradiente(e.uV,d.min,d.max),o=gerarCorGradiente(e.uF,u.min,u.max),a=gerarCorGradiente(e.uPot,g.min,g.max);i+=`<td class="price-sub" style="background-color:${t.bg}; color:${t.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipEnergy(event, ${_(e.breakdown.V)}, 'V')" onmouseleave="hideTooltip()">${f(e.uV)}</td>`,i+=`<td class="price-sub" style="background-color:${o.bg}; color:${o.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipEnergy(event, ${_(e.breakdown.F)}, 'F')" onmouseleave="hideTooltip()">${f(e.uF)}</td>`,i+=`<td class="price-sub" style="background-color:${a.bg}; color:${a.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipPot(event, ${_(e.potDetails)})" onmouseleave="hideTooltip()">${f(e.uPot)}</td>`}else{const t=gerarCorGradiente(e.uV,d.min,d.max),o=gerarCorGradiente(e.uP,m.min,m.max),a=gerarCorGradiente(e.uC,p.min,p.max),n=gerarCorGradiente(e.uPot,g.min,g.max);i+=`<td class="price-sub" style="background-color:${t.bg}; color:${t.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipEnergy(event, ${_(e.breakdown.V)}, 'V')" onmouseleave="hideTooltip()">${f(e.uV)}</td>`,i+=`<td class="price-sub" style="background-color:${a.bg}; color:${a.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipEnergy(event, ${_(e.breakdown.C)}, 'C')" onmouseleave="hideTooltip()">${f(e.uC)}</td>`,i+=`<td class="price-sub" style="background-color:${o.bg}; color:${o.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipEnergy(event, ${_(e.breakdown.P)}, 'P')" onmouseleave="hideTooltip()">${f(e.uP)}</td>`,i+=`<td class="price-sub" style="background-color:${n.bg}; color:${n.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipPot(event, ${_(e.potDetails)})" onmouseleave="hideTooltip()">${f(e.uPot)}</td>`}let l="";e.details.site&&(l+=`<a href="${e.details.site}" target="_blank" title="Aderir" style="color:var(--primary); margin-right:8px;"><i class="fa-solid fa-link"></i></a>`),e.details.notas&&(l+=`<i class="fa-solid fa-circle-info" title="${e.details.notas}" style="color:var(--text-light); cursor:help"></i>`),i+=`<td style="font-size:1.1em">${l}</td>`,a.innerHTML+=`<tr>${i}</tr>`}),makeColumnsResizable()}function renderTableComparacao(e,t){const o=document.getElementById("thead"),a=document.getElementById("tbody");a.innerHTML="";const n=e.opcoes||[],i=e.resultados||[];if(n.length<=1||0===i.length)return void renderTable(i,t);const l=e=>e.includes("Simples")?"ciclo-simples":e.includes("Bi")&&e.includes("Semanal")?"ciclo-bi-semanal":e.includes("Bi")?"ciclo-bi-diario":e.includes("Tri")&&e.includes("Semanal")?"ciclo-tri-semanal":e.includes("Tri")?"ciclo-tri-diario":"";l(t);let s={};n.forEach(e=>{let t="",o=1/0;i.forEach(a=>{const n=a.custos[e.display];void 0!==n&&!isNaN(n)&&n<o&&"Utilizador"!==a.tipo&&(o=n,t=a.com+" - "+a.nome)}),t&&(s[e.display]={nome:t,custo:o})});const r=i.find(e=>"Utilizador"===e.tipo),c=r?Object.keys(r.custos)[0]:null,d=r&&c?r.custos[c]:null;let u='<div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #bae6fd; border-radius: 10px; padding: 14px 18px; margin-bottom: 14px; font-size: 0.85rem; line-height: 1.6;">';u+='<div style="font-weight: 700; margin-bottom: 6px; color: #0369a1;"><i class="fa-solid fa-trophy" style="margin-right:6px;"></i>Melhores Opções por Ciclo</div>',n.forEach(e=>{const t=s[e.display];if(!t)return;let o=l(e.display),a="#e5e7eb";o.includes("simples")?a="#A6A6A6":o.includes("bi-semanal")?a="#8EA9DB":o.includes("bi-diario")?a="#A9D08E":o.includes("tri-semanal")?a="#C65911":o.includes("tri-diario")&&(a="#BF8F00");let n=o.includes("tri")?"#fff":"#000";if(u+='<div style="margin: 4px 0;">',u+=`<span style="display:inline-block; background:${a}; color:${n}; padding:2px 8px; border-radius:4px; font-weight:600; font-size:0.78rem; min-width:90px; text-align:center;">${e.display}</span> `,u+=`<strong>${t.nome}</strong> com <strong style="color:#16a34a;">${t.custo.toFixed(2)} €</strong>`,null!==d){const e=d-t.custo;u+=e>.01?` <span style="color:#16a34a; font-size:0.8rem;">(poupa ${e.toFixed(2)} € vs O Meu Tarifário)</span>`:e<-.01?` <span style="color:#dc2626; font-size:0.8rem;">(+${Math.abs(e).toFixed(2)} € vs O Meu Tarifário)</span>`:' <span style="color:#6b7280; font-size:0.8rem;">(≈ O Meu Tarifário)</span>'}u+="</div>"}),u+="</div>";let m=document.getElementById("comparacao-summary");if(!m){m=document.createElement("div"),m.id="comparacao-summary";const e=document.getElementById("tabela");e.parentNode.insertBefore(m,e)}m.innerHTML=u;let p='<th onclick="setSortComparacao(\'nome\')">Tarifário <i class="fa-solid fa-sort"></i></th>';n.forEach(e=>{let t=l(e.display);p+=`<th class="${t}" onclick="setSortComparacao('${e.display}')">${e.display} (€) <i class="fa-solid fa-sort"></i></th>`}),p+="<th>Detalhes</th>",o.innerHTML=`<tr>${p}</tr>`;const g={};n.forEach(e=>{const t=i.map(t=>t.custos[e.display]).filter(e=>null!=e&&!isNaN(e));t.length>0?g[e.display]={min:Math.min(...t),max:Math.max(...t)}:g[e.display]={min:null,max:null}});const f=e=>JSON.stringify(e).replace(/\"/g,"&quot;");i.slice(0,150).forEach(e=>{const t=getTarifarioStyle(e.tipo,e.nome);let o=`\n                    <td class="${t.cellClass}">\n                        <div class="tariff-name" ${e.site?`onclick="window.open('${e.site}', '_blank')"`:""}>${e.com}</div>\n                        <div style="font-size:0.78rem; color:var(--text-light); margin-bottom:4px;">${e.nome}</div>\n                        <span class="tag ${t.tagClass}">${t.label}</span>\n                    </td>`;n.forEach(t=>{const a=e.custos[t.display],n=e.detalhes?e.detalhes[t.display]:null;if(null==a||isNaN(a))o+='<td style="text-align:center; color:var(--text-light);">—</td>';else{const i=g[t.display],l=gerarCorGradiente(a,i.min,i.max),s=e.melhorOpcao===t.display&&Object.keys(e.custos).length>1,r=n?`onmouseenter="showTooltipComparacao(event, ${f(n)}, ${f(e.nome)}, ${f(t.display)})" onmouseleave="hideTooltip()"`:"";o+=`<td class="price-main" style="background-color:${l.bg}; color:${l.text}; text-align:center; border-radius:10px; cursor:default; ${s?"font-weight:bold; border:2px solid #16a34a;":""}" ${r}>${a.toFixed(2)} €</td>`}});let i="";e.site&&(i+=`<a href="${e.site}" target="_blank" title="Aderir" style="color:var(--primary); margin-right:8px;"><i class="fa-solid fa-link"></i></a>`),e.notas&&(i+=`<i class="fa-solid fa-circle-info" title="${e.notas}" style="color:var(--text-light); cursor:help"></i>`),o+=`<td style="font-size:1.1em; text-align:center;">${i}</td>`,a.innerHTML+=`<tr>${o}</tr>`}),makeColumnsResizable()}window.onload=async()=>{const e=new Date,t=new Date(e);t.setDate(e.getDate()+1);const o=new Date(t),a=t.getDate();o.setMonth(o.getMonth()+1),o.getDate()!==a&&o.setDate(0),o.setDate(o.getDate()-1);const n=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,i=document.getElementById("d_inicio"),l=document.getElementById("d_fim"),s=e.getFullYear();i.min=`${s}-01-01`,i.max=`${s+2}-12-31`,l.min=`${s}-01-01`,l.max=`${s+2}-12-31`,i.value=n(t),l.value=n(o),atualizarDias();try{setLoaderMsg("");const e=await getCacheEntry();if(e&&e.data&&e.timestamp&&Date.now()-e.timestamp<432e5)return setLoaderMsg("A carregar dados em cache..."),applyParsedData(e.data),void afterDataLoaded();setLoaderMsg("A verificar atualizações...");try{const t=await fetchManifest(),o=e&&e.manifest||{},a=e&&e.data||{},n=CSV_FILES.filter(e=>!o[e]||o[e]!==t[e]);if(0===n.length&&e&&e.data)return setLoaderMsg("Dados atualizados, a carregar..."),e.timestamp=Date.now(),saveCacheEntry(e),applyParsedData(e.data),void afterDataLoaded();setLoaderMsg(n.length===CSV_FILES.length?"A atualizar...":`A atualizar ${n.length} ficheiro(s)...`);const i={};await Promise.all(n.map(async e=>{i[e]=await fetchCSV(e)}));const l={};CSV_FILES.forEach(e=>{l[e]=i[e]||a[e]||[]}),await saveCacheEntry({manifest:t,data:l,timestamp:Date.now()}),setLoaderMsg("A processar dados..."),applyParsedData(l),afterDataLoaded()}catch(t){if(console.warn("CSVs indisponíveis, a tentar Excel...",t),e&&e.data)return setLoaderMsg("A usar dados em cache (offline)..."),e.timestamp=Date.now(),saveCacheEntry(e),applyParsedData(e.data),void afterDataLoaded();setLoaderMsg("A tentar fonte alternativa...");const o=await fetch(FILENAME);if(!o.ok)throw new Error("Fetch falhou");const a=await o.arrayBuffer();setLoaderMsg("A processar dados..."),await loadSheetJS(),loadData(a)}}catch(e){document.getElementById("loader").innerHTML='\n                    <div style="color:#d97706; margin-bottom:15px; font-family:sans-serif;">\n                        <i class="fa-solid fa-triangle-exclamation fa-2x"></i>\n                        <p style="margin:5px 0">Não foi possível carregar automaticamente.</p>\n                        <p style="font-size:0.85rem; color:var(--text-light);">Verifique a ligação ou carregue manualmente.</p>\n                    </div>\n                    <label style="background:#0066cc; color:white; padding:10px 20px; border-radius:5px; cursor:pointer; font-family:sans-serif; display:inline-block;">\n                        <i class="fa-solid fa-upload"></i> Carregar "Tarifarios.xlsx"\n                        <input type="file" style="display:none" accept=".xlsx" onchange="lerBaseDadosManual(this)">\n                    </label>\n                '}};let SORT_COMPARACAO={col:"",asc:!0};function setSortComparacao(e){SORT_COMPARACAO.col===e?SORT_COMPARACAO.asc=!SORT_COMPARACAO.asc:(SORT_COMPARACAO.col=e,SORT_COMPARACAO.asc=!0),calcular()}function makeColumnsResizable(){document.getElementById("tabela").querySelectorAll("th").forEach(e=>{if(e.querySelector(".resizer"))return;const t=document.createElement("div");let o,a;t.classList.add("resizer"),e.appendChild(t),t.addEventListener("mousedown",t=>{o=t.pageX,a=e.offsetWidth;const n=t=>{const n=a+(t.pageX-o);e.style.width=n+"px"},i=()=>{document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",i)})})}function setSort(e){SORT.col===e?SORT.asc=!SORT.asc:(SORT.col=e,SORT.asc=!0),calcular()}function showTooltipTotal(e,t,o){const a=document.getElementById("tooltip");let n='<div style="font-weight:700; margin-bottom:8px; font-size:0.9rem;">Decomposição Custo Total</div>';n+=`<div style="font-size:0.8rem; color:#cbd5e1; margin-bottom:8px;">${o||""}</div>`;let i=t.costPot6>0||t.taxPot6>0,l=t.costPot23>0||t.taxPot23>0;(i||l)&&(n+='<div style="font-weight:600; margin-top:8px; color:#cbd5e1; font-size:0.75rem;">POTÊNCIA</div>',i&&(n+=`<div class="tooltip-line"><span>Potência (base s/ IVA 6%):</span><span>${t.costPot6.toFixed(2)} €</span></div>`),l&&(n+=`<div class="tooltip-line"><span>Potência (base s/ IVA 23%):</span><span>${t.costPot23.toFixed(2)} €</span></div>`));let s=t.costEn6>0||t.taxEn6>0,r=t.costEn23>0||t.taxEn23>0;(s||r)&&(n+='<div style="font-weight:600; margin-top:8px; color:#cbd5e1; font-size:0.75rem;">ENERGIA</div>',s&&(n+=`<div class="tooltip-line"><span>Energia (base s/ IVA 6%):</span><span>${t.costEn6.toFixed(2)} €</span></div>`),r&&(n+=`<div class="tooltip-line"><span>Energia (base s/ IVA 23%):</span><span>${t.costEn23.toFixed(2)} €</span></div>`));let c=(t.costPot6||0)+(t.costPot23||0)+(t.costEn6||0)+(t.costEn23||0);n+=`<div class="tooltip-line subtotal"><span>Subtotal Potência + Energia:</span><span>${c.toFixed(2)} €</span></div>`,n+='<div style="font-weight:600; margin-top:8px; color:#cbd5e1; font-size:0.75rem;">TAXAS E CONTRIBUIÇÕES</div>',n+=`<div class="tooltip-line"><span>CAV s/ IVA:</span><span>${t.cav.toFixed(2)} €</span></div>`,n+=`<div class="tooltip-line"><span>DGEG s/ IVA:</span><span>${t.dgeg.toFixed(2)} €</span></div>`,n+=`<div class="tooltip-line"><span>IEC s/ IVA:</span><span>${t.iec.toFixed(4)} €</span></div>`;let d=t.cav+t.dgeg+t.iec;n+=`<div class="tooltip-line subtotal"><span>Subtotal Taxas:</span><span>${d.toFixed(2)} €</span></div>`;let u=c+d;n+=`<div class="tooltip-line subtotal"><span><strong>Total s/ IVA:</strong></span><span><strong>${u.toFixed(2)} €</strong></span></div>`,n+='<div class="tooltip-section"></div>',n+='<div style="font-weight:600; margin-top:6px; color:#cbd5e1; font-size:0.75rem;">IVA</div>';let m=(t.taxPot6||0)+(t.taxEn6||0)+(t.taxCAV||0),p=(t.taxPot23||0)+(t.taxEn23||0)+(t.taxIEC||0)+(t.taxDGEG||0);m>0&&(n+=`<div class="tooltip-line"><span>IVA 6%:</span><span>${m.toFixed(2)} €</span></div>`),n+=`<div class="tooltip-line"><span>IVA 23%:</span><span>${p.toFixed(2)} €</span></div>`;let g=u+m+p;(t.desc>0||t.quotaACP>0||t.acrescimo>0)&&(n+='<div class="tooltip-section"></div>',t.desc>0&&(n+=`<div class="tooltip-line"><span>Desconto Fatura:</span><span style="color:#4ade80">-${t.desc.toFixed(2)} €</span></div>`),t.quotaACP>0&&(n+=`<div class="tooltip-line"><span>Quota ACP:</span><span style="color:#f87171">+${t.quotaACP.toFixed(2)} €</span></div>`),t.acrescimo>0&&(n+=`<div class="tooltip-line"><span>Acréscimo Fatura:</span><span style="color:#f87171">+${t.acrescimo.toFixed(2)} €</span></div>`)),n+=`<div class="tooltip-line total"><span>CUSTO TOTAL:</span><span>${(g-(t.desc||0)+(t.quotaACP||0)+(t.acrescimo||0)).toFixed(2)} €</span></div>`,a.innerHTML=n,a.classList.remove("hidden"),positionTooltip(e,a)}function showTooltipComparacao(e,t,o,a){const n=document.getElementById("tooltip"),i=t.details;if(!i)return;let l='<div style="font-weight:700; margin-bottom:4px; font-size:0.9rem;">Decomposição Custo Total</div>';l+=`<div style="font-size:0.8rem; color:#cbd5e1; margin-bottom:6px;">${o||""}</div>`,l+=`<div style="font-size:0.78rem; color:#93c5fd; margin-bottom:8px; font-style:italic;">${a||""}</div>`,l+='<div style="font-weight:600; color:#fbbf24; font-size:0.75rem; margin-bottom:2px;">PREÇOS UNITÁRIOS (s/ IVA)</div>';const s=e=>void 0!==e&&0!==e?e.toFixed(4):null;let r=!1;s(t.uS)&&(l+=`<div class="tooltip-line"><span>Energia Simples:</span><span>${s(t.uS)} €/kWh</span></div>`,r=!0),s(t.uV)&&(l+=`<div class="tooltip-line"><span>Energia Vazio:</span><span>${s(t.uV)} €/kWh</span></div>`,r=!0),s(t.uF)&&(l+=`<div class="tooltip-line"><span>Energia Fora Vazio:</span><span>${s(t.uF)} €/kWh</span></div>`,r=!0),s(t.uC)&&(l+=`<div class="tooltip-line"><span>Energia Cheias:</span><span>${s(t.uC)} €/kWh</span></div>`,r=!0),s(t.uP)&&(l+=`<div class="tooltip-line"><span>Energia Ponta:</span><span>${s(t.uP)} €/kWh</span></div>`,r=!0),s(t.uPot)&&(l+=`<div class="tooltip-line"><span>Potência:</span><span>${s(t.uPot)} €/dia</span></div>`,r=!0),r||(l+='<div class="tooltip-line" style="color:#94a3b8;"><span>—</span></div>'),l+='<div class="tooltip-section"></div>';let c=i.costPot6>0||i.taxPot6>0,d=i.costPot23>0||i.taxPot23>0;(c||d)&&(l+='<div style="font-weight:600; margin-top:4px; color:#cbd5e1; font-size:0.75rem;">POTÊNCIA</div>',c&&(l+=`<div class="tooltip-line"><span>Potência (base s/ IVA 6%):</span><span>${i.costPot6.toFixed(2)} €</span></div>`),d&&(l+=`<div class="tooltip-line"><span>Potência (base s/ IVA 23%):</span><span>${i.costPot23.toFixed(2)} €</span></div>`));let u=i.costEn6>0||i.taxEn6>0,m=i.costEn23>0||i.taxEn23>0;(u||m)&&(l+='<div style="font-weight:600; margin-top:4px; color:#cbd5e1; font-size:0.75rem;">ENERGIA</div>',u&&(l+=`<div class="tooltip-line"><span>Energia (base s/ IVA 6%):</span><span>${i.costEn6.toFixed(2)} €</span></div>`),m&&(l+=`<div class="tooltip-line"><span>Energia (base s/ IVA 23%):</span><span>${i.costEn23.toFixed(2)} €</span></div>`));let p=(i.costPot6||0)+(i.costPot23||0)+(i.costEn6||0)+(i.costEn23||0);l+=`<div class="tooltip-line subtotal"><span>Subtotal Potência + Energia:</span><span>${p.toFixed(2)} €</span></div>`,l+='<div style="font-weight:600; margin-top:4px; color:#cbd5e1; font-size:0.75rem;">TAXAS E CONTRIBUIÇÕES</div>',l+=`<div class="tooltip-line"><span>CAV s/ IVA:</span><span>${i.cav.toFixed(2)} €</span></div>`,l+=`<div class="tooltip-line"><span>DGEG s/ IVA:</span><span>${i.dgeg.toFixed(2)} €</span></div>`,l+=`<div class="tooltip-line"><span>IEC s/ IVA:</span><span>${i.iec.toFixed(4)} €</span></div>`;let g=i.cav+i.dgeg+i.iec;l+=`<div class="tooltip-line subtotal"><span>Subtotal Taxas:</span><span>${g.toFixed(2)} €</span></div>`;let f=p+g;l+=`<div class="tooltip-line subtotal"><span><strong>Total s/ IVA:</strong></span><span><strong>${f.toFixed(2)} €</strong></span></div>`,l+='<div class="tooltip-section"></div>',l+='<div style="font-weight:600; margin-top:4px; color:#cbd5e1; font-size:0.75rem;">IVA</div>';let _=(i.taxPot6||0)+(i.taxEn6||0)+(i.taxCAV||0),h=(i.taxPot23||0)+(i.taxEn23||0)+(i.taxIEC||0)+(i.taxDGEG||0);_>0&&(l+=`<div class="tooltip-line"><span>IVA 6%:</span><span>${_.toFixed(2)} €</span></div>`),l+=`<div class="tooltip-line"><span>IVA 23%:</span><span>${h.toFixed(2)} €</span></div>`;let E=f+_+h;(i.desc>0||i.quotaACP>0||i.acrescimo>0)&&(l+='<div class="tooltip-section"></div>',i.desc>0&&(l+=`<div class="tooltip-line"><span>Desconto Fatura:</span><span style="color:#4ade80">-${i.desc.toFixed(2)} €</span></div>`),i.quotaACP>0&&(l+=`<div class="tooltip-line"><span>Quota ACP:</span><span style="color:#f87171">+${i.quotaACP.toFixed(2)} €</span></div>`),i.acrescimo>0&&(l+=`<div class="tooltip-line"><span>Acréscimo Fatura:</span><span style="color:#f87171">+${i.acrescimo.toFixed(2)} €</span></div>`)),l+=`<div class="tooltip-line total"><span>CUSTO TOTAL:</span><span>${(E-(i.desc||0)+(i.quotaACP||0)+(i.acrescimo||0)).toFixed(2)} €</span></div>`,n.innerHTML=l,n.classList.remove("hidden"),positionTooltip(e,n)}function showTooltipEnergy(e,t,o){const a=document.getElementById("tooltip");let n=`<div style="font-weight:700; margin-bottom:6px; font-size:0.85rem;">Decomposição Preço ${{S:"Simples",V:"Vazio",F:"Fora Vazio",C:"Cheias",P:"Ponta"}[o]||"Energia"} s/IVA</div>`;n+=`<div class="tooltip-line"><span>Comercial (s/ TAR):</span><span>${t.comercialSemTar.toFixed(4)} €</span></div>`,n+=`<div class="tooltip-line"><span>TAR (Acesso Redes):</span><span>${t.tarValue.toFixed(4)} €</span></div>`,t.tseIncluded?n+='<div class="tooltip-line" style="background-color:#78350f20; padding:4px; border-radius:4px; color:#fbbf24;"><span>ℹ️ Financiamento TSE incluído no preço</span></div>':n+=`<div class="tooltip-line"><span>Financ. TSE:</span><span>${t.tse.toFixed(4)} €</span></div>`,n+=`<div class="tooltip-line total"><span>TOTAL UNITÁRIO:</span><span>${(t.comercialSemTar+t.tarValue+t.tse).toFixed(4)} €</span></div>`,a.innerHTML=n,a.classList.remove("hidden"),positionTooltip(e,a)}function showTooltipNome(e,t,o){const a=document.getElementById("tooltip");let n=`<div style="font-weight:700; margin-bottom:8px; font-size:0.9rem;">${t}</div>`;o&&o.trim()&&(n+=`<div style="font-size:0.85rem; line-height:1.4;">${o}</div>`),a.innerHTML=n,a.classList.remove("hidden"),positionTooltip(e,a)}function showTooltipPot(e,t){const o=document.getElementById("tooltip");let a='<div style="font-weight:700; margin-bottom:6px; font-size:0.85rem;">Decomposição Potência s/IVA</div>',n=parseFloat(document.getElementById("potencia").value)<=3.45?"IVA 6%":"IVA 23%";a+=`<div class="tooltip-line"><span>Comercial (IVA 23%):</span><span>${t.comercial.toFixed(4)} €</span></div>`,a+=`<div class="tooltip-line"><span>TAR (${n}):</span><span>${t.tarPotValue.toFixed(4)} €</span></div>`,a+=`<div class="tooltip-line total"><span>TOTAL UNITÁRIO:</span><span>${(t.comercial+t.tarPotValue).toFixed(4)} €</span></div>`,o.innerHTML=a,o.classList.remove("hidden"),positionTooltip(e,o)}function positionTooltip(e,t){let o=e.pageX+15,a=e.pageY+15;setTimeout(()=>{o+t.offsetWidth>window.innerWidth&&(o=e.pageX-t.offsetWidth-15),a+t.offsetHeight>window.innerHeight+window.scrollY&&(a=e.pageY-t.offsetHeight-15),t.style.left=o+"px",t.style.top=a+"px"},0)}function limparDadosERedes(){DADOS_EREDES=null,STATE_ABA3.ficheiroProcessado=!1,STATE_ABA3.dadosERedes=null,STATE_ABA3.dataInicio=null,STATE_ABA3.dataFim=null,STATE_ABA3.consumos={S:0,V:0,F:0,C:0,P:0},document.getElementById("d_inicio").disabled=!1,document.getElementById("d_fim").disabled=!1,["kwh_S","kwh_V","kwh_F","kwh_C","kwh_P"].forEach(e=>{const t=document.getElementById(e);t&&(t.disabled=!1)});const e=getDefaultDates(),t=(new Date).getFullYear();document.getElementById("d_inicio").min=`${t}-01-01`,document.getElementById("d_inicio").max=`${t+2}-12-31`,document.getElementById("d_fim").min=`${t}-01-01`,document.getElementById("d_fim").max=`${t+2}-12-31`,document.getElementById("d_inicio").value=e.start,document.getElementById("d_fim").value=e.end,document.getElementById("analise-consumos").style.display="none",document.getElementById("analise-content").innerHTML="";const o=document.getElementById("graficos-analise-eredes");o&&(o.style.display="none");const a=document.getElementById("analise-potencia");a&&(a.style.display="none"),document.getElementById("eredes-upload").style.display="block",document.getElementById("eredes-limpar").style.display="none",document.getElementById("eredes-status").innerHTML="",document.getElementById("eredes-info").innerHTML="",document.getElementById("file-eredes").value="";const n=document.getElementById("file-eredes-central");n&&(n.value="");const i=document.getElementById("eredes-status-central");i&&(i.innerHTML="");const l=document.getElementById("omie-panel");l&&l.classList.remove("hidden"),OMIE_MANUAL=!1,"advanced"===CURRENT_TAB?(document.getElementById("app").classList.add("hidden"),document.getElementById("eredes-upload-central").classList.remove("hidden")):construirInputsConsumo(),atualizarDias()}function hideTooltip(){document.getElementById("tooltip").classList.add("hidden")}async function lerBaseDadosManual(e){const t=e.files[0];if(t){try{await loadSheetJS()}catch(e){return void alert("Sem ligação à internet. Não é possível carregar a biblioteca necessária para ler ficheiros Excel.")}const e=new FileReader;e.onload=e=>loadData(e.target.result),e.readAsArrayBuffer(t)}}let DADOS_EREDES=null;async function processarFicheirosERedes(){const e=document.getElementById("file-eredes"),t=document.getElementById("eredes-status"),o=document.getElementById("eredes-info");if(e.files&&0!==e.files.length){await loadSheetJS(),t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> A processar ficheiros...',o.style.display="none";try{const o=[];for(let a=0;a<e.files.length;a++){const n=e.files[a];t.innerHTML=`<i class="fa-solid fa-spinner fa-spin"></i> A processar ${n.name} (${a+1}/${e.files.length})...`;const i=await processarFicheiroERedes(n);if(i.erro)return void(t.innerHTML=`<span style="color:red;">❌ Erro: ${i.erro}</span>`);o.push(i.dados)}const a=validarEJuntarFicheiros(o);if(a.erro)return void(t.innerHTML=`<span style="color:red;">❌ ${a.erro}</span>`);const n=agregarConsumosPorPeriodo(a.dados),i=calcularMediasOMIE(a.dados),l=a.dados[0],s=a.dados[a.dados.length-1],r=l.DataHora.split("T")[0],c=s.DataHora.split("T")[0],d=new Date(r),u=new Date(c),m=Math.abs(u-d),p=Math.ceil(m/864e5)+1;DADOS_EREDES={dadosBrutos:a.dados,consumosAgregados:n,mediasOMIE:i,periodo:{inicio:r,fim:c,dias:p}},aplicarDadosERedes(),i.S&&(OMIE_VALUES.S=i.S,i.BD_V&&(OMIE_VALUES.V=i.BD_V));const g=document.getElementById("ciclo").value;if(g.includes("Simples")){const e=document.getElementById("kwh_S");e&&(e.value=Math.round(n.Simples))}else if(g.includes("Bi")){const e=g.includes("Diário")?"BD":"BS",t=document.getElementById("kwh_V"),o=document.getElementById("kwh_F");t&&(t.value=Math.round(n[e].V)),o&&(o.value=Math.round(n[e].F))}else{const e=g.includes("Diário")?"TD":"TS",t=document.getElementById("kwh_V"),o=document.getElementById("kwh_P"),a=document.getElementById("kwh_C");t&&(t.value=Math.round(n[e].V)),o&&(o.value=Math.round(n[e].P)),a&&(a.value=Math.round(n[e].C))}const f=criarTabelaAnalise(n,i);document.getElementById("analise-content").innerHTML=f,document.getElementById("analise-consumos").style.display="block";const _=a.aviso||"";document.getElementById("eredes-upload").style.display="none",document.getElementById("eredes-limpar").style.display="block";const h=e.files.length,E=e=>e.split("-").reverse().join("/");document.getElementById("eredes-resumo").innerHTML=`\n                    <b>${h} ficheiro(s):</b> ${E(r)} a ${E(c)} (${p} dias)\n                    ${_?`<br><span style="color:#d97706;">${_}</span>`:""}\n                `,calcular()}catch(e){console.error("Erro ao processar ficheiros:",e),t.innerHTML=`<span style="color:red;">❌ Erro: ${e.message}</span>`}}else t.innerHTML='<span style="color:red;">⚠️ Selecione pelo menos um ficheiro Excel</span>'}async function processarFicheiroERedes(e){return new Promise((t,o)=>{const a=new FileReader;a.onload=function(o){try{const a=new Uint8Array(o.target.result),n=XLSX.read(a,{type:"array"}),i=n.SheetNames[0],l=n.Sheets[i],s=XLSX.utils.sheet_to_json(l,{header:1,defval:null}),r=detectarCabecalho(s);if(r.erro)return void t({erro:`${e.name}: ${r.erro}`});const c=processarDadosConsumo(s,r.headerRow,r.colunaConsumo);if(c.erro)return void t({erro:`${e.name}: ${c.erro}`});t({dados:c.registos})}catch(o){t({erro:`${e.name}: ${o.message}`})}},a.onerror=()=>t({erro:`${e.name}: Erro ao ler ficheiro`}),a.readAsArrayBuffer(e)})}function detectarCabecalho(e){const t=["Consumo Simulado (kW)","Consumo medido na IC, Ativa (kW)","Consumo registado (kW)","Consumo registado, Ativa (kW)"];for(let o=0;o<Math.min(20,e.length);o++){const a=e[o];if(a)for(const e of t){const t=a.indexOf(e);if(-1!==t)return{headerRow:o,colunaConsumo:e,colIndex:t}}}return{erro:"Não foi encontrada coluna de consumo conhecida"}}function processarDadosConsumo(e,t,o){try{const a=e[t].map(e=>e?e.toString().trim():""),n=a.indexOf(o),i=a.indexOf("Data"),l=a.indexOf("Hora");if(-1===n||-1===i||-1===l)return{erro:"Colunas Data, Hora ou Consumo em falta"};const s=[];for(let o=t+1;o<e.length;o++){const t=e[o];if(!t||0===t.length)continue;const a=parseFloat(t[n]);if(isNaN(a))continue;let r,c,d,u=0,m=0,p=t[i];if("number"==typeof p){const e=XLSX.SSF.parse_date_code(p);r=e.y,c=e.m,d=e.d}else if(p=String(p).trim(),p.includes("/")){const e=p.split("/");4===e[0].length?(r=parseInt(e[0]),c=parseInt(e[1]),d=parseInt(e[2])):(d=parseInt(e[0]),c=parseInt(e[1]),r=parseInt(e[2]))}else if(p.includes("-")){const e=p.split("-");4===e[0].length?(r=parseInt(e[0]),c=parseInt(e[1]),d=parseInt(e[2])):(d=parseInt(e[0]),c=parseInt(e[1]),r=parseInt(e[2]))}let g=t[l];if("number"==typeof g){const e=Math.round(1440*g);u=Math.floor(e/60),m=e%60}else if("string"==typeof g){const e=g.split(":");u=parseInt(e[0]),m=parseInt(e[1])}if(!r||!c||!d)continue;const f=new Date(r,c-1,d,u,m,0),_=new Date(f);0===u&&0===m&&_.setMinutes(_.getMinutes()-1);const h=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}T${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}:00`;s.push({DataHoraOriginal:h(f),DataHora:h(_),Ts:_.getTime(),"Consumo (kWh)":a/4,Potencia_kW:a})}return{registos:s}}catch(e){return{erro:e.message}}}function validarEJuntarFicheiros(e){if(!e||0===e.length)return{erro:"Nenhum ficheiro processado"};const t=new Date("2025-01-01");let o=!1,a=[];const n=[];for(const i of e){const e=i.length,l=i.filter(e=>new Date(e.DataHora)>=t);if(e>l.length&&(o=!0),0===l.length)continue;a=a.concat(l);const s=new Date(Math.min(...l.map(e=>new Date(e.DataHora)))),r=new Date(Math.max(...l.map(e=>new Date(e.DataHora))));n.push({min:s,max:r})}if(0===a.length)return{erro:"Nenhum dos ficheiros continha dados válidos a partir de 01/01/2025"};if(n.length>1){const e=n.sort((e,t)=>e.min-t.min);for(let t=1;t<e.length;t++)if(e[t].min<e[t-1].max)return{erro:"Sobreposição de datas detetada entre ficheiros"}}a.sort((e,t)=>new Date(e.DataHora)-new Date(t.DataHora));const i=[],l=new Set;for(const e of a)l.has(e.DataHora)||(l.add(e.DataHora),i.push(e));return{dados:i,aviso:o?"Foram encontrados e ignorados dados anteriores a 01/01/2025":null}}function agregarConsumosPorPeriodo(e){const t={Simples:0,BD:{V:0,F:0},BS:{V:0,F:0},TD:{V:0,C:0,P:0},TS:{V:0,C:0,P:0}};if(!DATA.omieMap)return t;for(let o=0;o<e.length;o++){const a=e[o];t.Simples+=a["Consumo (kWh)"];const n=a.DataHora.split("T"),i=n[1].split(":"),l=`${n[0]}_${i[0]}:${i[1]}`;let s=DATA.omieMap.get(l);if(s||"00"===i[1]||(s=DATA.omieMap.get(`${n[0]}_${i[0]}:00`)),s){const e=a["Consumo (kWh)"];s.BD&&(t.BD[s.BD]+=e),s.BS&&(t.BS[s.BS]+=e),s.TD&&(t.TD[s.TD]+=e),s.TS&&(t.TS[s.TS]+=e)}}return t}function calcularMediasOMIE(e){const t=document.getElementById("d_inicio").value,o=document.getElementById("d_fim").value;if(!t||!o||!DATA.omie)return{};const a={S:{sum:0,n:0},BD:{V:{sum:0,n:0},F:{sum:0,n:0}},BS:{V:{sum:0,n:0},F:{sum:0,n:0}},TD:{V:{sum:0,n:0},P:{sum:0,n:0},C:{sum:0,n:0}},TS:{V:{sum:0,n:0},P:{sum:0,n:0},C:{sum:0,n:0}}};DATA.omie.forEach(e=>{const n=parseDateFromDB(e.Data);if(!n||n<t||n>o)return;const i=parseFloat(String(e.OMIE).replace(",","."))||0;a.S.sum+=i,a.S.n++,["BD","BS","TD","TS"].forEach(t=>{const o=e[t];o&&a[t][o]&&(a[t][o].sum+=i,a[t][o].n++)})});const n={};return a.S.n&&(n.S=a.S.sum/a.S.n),["BD","BS","TD","TS"].forEach(e=>{for(const[t,o]of Object.entries(a[e]))n[`${e}_${t}`]=o.n?o.sum/o.n:0}),n}function aplicarDadosERedes(){if(!DADOS_EREDES)return;const e=document.getElementById("d_inicio"),t=document.getElementById("d_fim"),o=document.getElementById("num_dias"),a=DADOS_EREDES.periodo.inicio,n=DADOS_EREDES.periodo.fim;e.min=a,e.max=n,t.min=a,t.max=n,(e.value<a||e.value>n)&&(e.value=a),(t.value<a||t.value>n)&&(t.value=n);const i=new Date(e.value),l=new Date(t.value);if(i&&l){const e=Math.floor((l-i)/864e5)+1;o.value=e>0?e:0}const s=document.getElementById("omie-panel");s&&s.classList.add("hidden")}async function exportarExcel(e){await loadExcelJS();try{const t=window.ExcelJS;if(!t)return void alert("Biblioteca ExcelJS não carregada. Verifique a ligação à internet.");const o=document.getElementById("modo_comparacao")?.checked,a=document.getElementById("potencia")?.value||"",n=document.getElementById("ciclo")?.value||"",i=document.getElementById("num_dias")?.value||"",l=document.getElementById("d_inicio")?.value||"",s=document.getElementById("d_fim")?.value||"",r=e=>{const t=e.split("-");return 3===t.length?`${t[2]}/${t[1]}/${t[0]}`:e},c=r(l),d=r(s),u={S:parseFloat(document.getElementById("kwh_S")?.value)||0,V:parseFloat(document.getElementById("kwh_V")?.value)||0,F:parseFloat(document.getElementById("kwh_F")?.value)||0,P:parseFloat(document.getElementById("kwh_P")?.value)||0,C:parseFloat(document.getElementById("kwh_C")?.value)||0},m=u.S+u.V+u.F+u.P+u.C,p=document.getElementById("familia_numerosa")?.checked,g=document.getElementById("tarifa_social")?.checked,f=document.getElementById("f_segmento")?.value||"Todos",_=document.getElementById("f_fatura")?.value||"Todas",h=document.getElementById("f_pagamento")?.value||"Todos",E="Todos"===f?"Residencial":f;let S="";S=n.includes("Simples")?`Simples: ${OMIE_VALUES.S.toFixed(2)} €/MWh`:n.includes("Bi")?`Vazio: ${OMIE_VALUES.V.toFixed(2)}, Fora Vazio: ${OMIE_VALUES.F.toFixed(2)} €/MWh`:`Vazio: ${OMIE_VALUES.V.toFixed(2)}, Cheias: ${OMIE_VALUES.C.toFixed(2)}, Ponta: ${OMIE_VALUES.P.toFixed(2)} €/MWh`;let y="";y=n.includes("Simples")?`Simples: ${u.S.toFixed(0)} kWh`:n.includes("Bi")?`Vazio: ${u.V.toFixed(0)}, Fora Vazio: ${u.F.toFixed(0)} kWh`:`Vazio: ${u.V.toFixed(0)}, Cheias: ${u.C.toFixed(0)}, Ponta: ${u.P.toFixed(0)} kWh`;const A="function"==typeof obter_perfil?obter_perfil(m,parseInt(i),parseFloat(a)).replace(/^(perfil_|BTN_)/i,"PERFIL ").toUpperCase():"N/A",v={Fixo:{bg:"F0F0F0",fg:"000000"},"Indexado Média":{bg:"FFE699",fg:"000000"},"Indexado quarto-horário - Perfil":{bg:"90ABDC",fg:"000000"},"Indexado quarto-horário - Diagrama":{bg:"D6E4F0",fg:"000000"},Utilizador:{bg:"FF0000",fg:"FFFFFF"},Personalizado:{bg:"92D050",fg:"000000"}},T={Simples:{bg:"A6A6A6",fg:"000000"},"Bi-horário - Ciclo Diário":{bg:"A9D08E",fg:"000000"},"Bi Diário":{bg:"A9D08E",fg:"000000"},"Bi-horário":{bg:"A9D08E",fg:"000000"},"Bi-horário - Ciclo Semanal":{bg:"8EA9DB",fg:"000000"},"Bi Semanal":{bg:"8EA9DB",fg:"000000"},"Tri-horário - Ciclo Diário":{bg:"BF8F00",fg:"FFFFFF"},"Tri Diário":{bg:"BF8F00",fg:"FFFFFF"},"Tri-horário":{bg:"BF8F00",fg:"FFFFFF"},"Tri-horário - Ciclo Semanal":{bg:"C65911",fg:"FFFFFF"},"Tri Semanal":{bg:"C65911",fg:"FFFFFF"},"Tri Diário >20.7":{bg:"BF8F00",fg:"FFFFFF"},"Tri-horário >20.7":{bg:"BF8F00",fg:"FFFFFF"},"Tri Semanal >20.7":{bg:"C65911",fg:"FFFFFF"},default:{bg:"A6A6A6",fg:"000000"}},I=(e,t)=>t&&t.includes("O Meu Tarifário")?v.Utilizador:t&&t.includes("Tarifário Personalizado")?v.Personalizado:e&&e.includes("Diagrama")?v["Indexado quarto-horário - Diagrama"]:e&&e.includes("quarto-horário")?v["Indexado quarto-horário - Perfil"]:e&&e.includes("Média")?v["Indexado Média"]:v.Fixo,C=e=>{if(T[e])return T[e];for(const t of Object.keys(T))if(e.includes(t)||t.includes(e))return T[t];return T.default},b=(e,t,o)=>{if(isNaN(e)||null===t||null===o||t===o)return{bg:"FFFFFF",fg:"000000"};const a=(t+o)/2,n=[90,138,198],i=[255,255,255],l=[247,150,70];let s,r,c;if(e<=a){const o=(e-t)/(a-t);s=Math.round(n[0]*(1-o)+i[0]*o),r=Math.round(n[1]*(1-o)+i[1]*o),c=Math.round(n[2]*(1-o)+i[2]*o)}else{const t=(e-a)/(o-a);s=Math.round(i[0]*(1-t)+l[0]*t),r=Math.round(i[1]*(1-t)+l[1]*t),c=Math.round(i[2]*(1-t)+l[2]*t)}const d=.299*s+.587*r+.114*c;return{bg:[s,r,c].map(e=>e.toString(16).padStart(2,"0")).join("").toUpperCase(),fg:d>140?"000000":"FFFFFF"}},B=new t.Workbook,x=B.addWorksheet("Simulação"),F={type:"pattern",pattern:"solid",fgColor:{argb:"FFFFFF"}},D={top:{style:"thin",color:{argb:"000000"}},left:{style:"thin",color:{argb:"000000"}},bottom:{style:"thin",color:{argb:"000000"}},right:{style:"thin",color:{argb:"000000"}}};let P=1;const M=LAST_EXPORT_DATA;let V;V=o&&M&&"comparacao"===M.mode?1+(M.data.opcoes||[]).length:n.includes("Simples")?4:n.includes("Bi")?5:6;const w=Math.max(V,4),k=(e,t)=>{for(let o=1;o<=t;o++)x.getCell(e,o).fill=F};x.mergeCells(P,1,P,w),x.getCell(P,1).value="Resumo da Simulação:",x.getCell(P,1).font={bold:!0,size:12},x.getCell(P,1).fill=F,P++;const $=(e,t)=>{const o=Math.max(2,Math.floor(w/2));x.mergeCells(P,1,P,o),x.getCell(P,1).value=e,x.getCell(P,1).font={bold:!0,size:11},x.getCell(P,1).fill=F,x.mergeCells(P,o+1,P,w),x.getCell(P,o+1).value=t,x.getCell(P,o+1).font={bold:!0,size:11},x.getCell(P,o+1).fill=F,P++};$(`Segmento: ${E}   |  Faturação: ${_}   |  Pagamento: ${h}`,`${a} kVA em ${n.replace("- Ciclo ","").replace("Bi-horário","Bi-Horário").replace("Tri-horário","Tri-Horário")}`),$(`Consumos (${m.toFixed(0)} kWh Total):`,y),$("Período:",`De ${c} a ${d} (${i} dias)`);let O="OMIE (Média Final)";if(O=OMIE_MANUAL?"OMIE (Manual)":verificarIncluiFuturosOMIP()?"OMIE / OMIP (Média com Futuros)":"OMIE (Média Final)",$(`${O}:`,S),$("Perfil de Consumo:",A),p||g){let e=[];p&&e.push("Família Numerosa"),g&&e.push("Tarifa Social"),$("Benefícios:",e.join(", "))}k(P,w),P++;const L=document.getElementById("mensagem-poupanca");if(L&&"none"!==L.style.display&&L.innerText.trim()){x.mergeCells(P,1,P,Math.max(w,4));const e=x.getCell(P,1);e.value=L.innerText.trim(),e.font={bold:!0,color:{argb:"FF0000"},size:11},e.alignment={wrapText:!0},e.fill=F,P++}const z=document.getElementById("comparacao-summary");if(o&&z&&z.innerText.trim()){x.mergeCells(P,1,P,Math.max(w,4));const e=x.getCell(P,1);e.value=z.innerText.trim().replace(/\n+/g," | "),e.font={bold:!0,color:{argb:"0369A1"},size:11},e.alignment={wrapText:!0},e.fill=F,P++}k(P,w),P++;const R=new Date,U=`          Simulação em ${R.getDate().toString().padStart(2,"0")}/${(R.getMonth()+1).toString().padStart(2,"0")}/${R.getFullYear()}                                                                      https://www.tiagofelicia.pt                                                                      Tiago Felícia`;x.mergeCells(P,1,P,Math.max(w,4));const N=x.getCell(P,1);if(N.value=U,N.font={bold:!0,size:11},N.alignment={horizontal:"center",vertical:"middle"},N.fill=F,P++,k(P,w),P++,!o&&M&&"detalhe"===M.mode){let t=M.results||[];e&&e<t.length&&(t=t.slice(0,e));let o=["Tarifário","Total (€)"];n.includes("Simples")?o.push("Simples (€/kWh)","Potência (€/dia)"):n.includes("Bi")?o.push("Vazio (€/kWh)","Fora Vazio (€/kWh)","Potência (€/dia)"):o.push("Vazio (€/kWh)","Cheias (€/kWh)","Ponta (€/kWh)","Potência (€/dia)");const a=o.length,i=C(n);o.forEach((e,t)=>{const o=x.getCell(P,t+1);o.value=e,o.font={bold:!0,color:{argb:i.fg},size:11},o.fill={type:"pattern",pattern:"solid",fgColor:{argb:i.bg}},o.alignment={horizontal:"center",vertical:"middle"},o.border=D}),P++;const l=(e,t)=>{const o=e.map(e=>e[t]).filter(e=>!isNaN(e)&&null!=e);return o.length?{min:Math.min(...o),max:Math.max(...o)}:{min:null,max:null}},s=l(t,"total"),r=l(t,"uS"),c=l(t,"uV"),d=l(t,"uF"),u=l(t,"uP"),m=l(t,"uC"),p=l(t,"uPot"),g=new Set;t.forEach(e=>{const t=I(e.tipo,e.nome);g.add(getTarifarioStyle(e.tipo,e.nome).label);const o=x.getCell(P,1);o.value=e.nome,o.fill={type:"pattern",pattern:"solid",fgColor:{argb:t.bg}},o.font={color:{argb:t.fg},size:11,bold:e.nome.includes("O Meu Tarifário")||e.nome.includes("Tarifário Personalizado")},o.alignment={horizontal:"center"};const a=x.getCell(P,2),i=b(e.total,s.min,s.max);a.value=e.total,a.numFmt="#,##0.00",a.fill={type:"pattern",pattern:"solid",fgColor:{argb:i.bg}},a.font={color:{argb:i.fg},size:11},a.alignment={horizontal:"center"};let l=3;const f=(e,t)=>{const o=x.getCell(P,l),a=b(e,t.min,t.max);o.value=e,o.numFmt="#,##0.0000",o.fill={type:"pattern",pattern:"solid",fgColor:{argb:a.bg}},o.font={color:{argb:a.fg},size:11},o.alignment={horizontal:"center"},l++};n.includes("Simples")?(f(e.uS,r),f(e.uPot,p)):n.includes("Bi")?(f(e.uV,c),f(e.uF,d),f(e.uPot,p)):(f(e.uV,c),f(e.uC,m),f(e.uP,u),f(e.uPot,p)),P++}),k(P,a),P++,k(P,a),P++,x.mergeCells(P,1,P,Math.min(a,3)),x.getCell(P,1).value="Tipos de Tarifário:",x.getCell(P,1).font={bold:!0,size:11,underline:!0},x.getCell(P,1).alignment={horizontal:"center"},x.getCell(P,1).fill=F,P++;const f={"O Meu Tarifário":"Tarifário configurado pelo utilizador.",Personalizado:"Tarifário personalizado pelo utilizador.","Indexado Média":"Preço de energia baseado na média OMIE do período.","Indexado quarto-horário - Perfil":"Preço de energia baseado nos valores OMIE horários/quarto-horários e perfil.","Indexado quarto-horário - Diagrama":"Preço baseado nos dados reais do diagrama de cargas E-REDES.",Fixo:"Preços de energia constantes."};["O Meu Tarifário","Personalizado","Indexado Média","Indexado quarto-horário - Perfil","Indexado quarto-horário - Diagrama","Fixo"].forEach(e=>{if(!g.has(e))return;let t;t="O Meu Tarifário"===e?v.Utilizador:"Personalizado"===e?v.Personalizado:v[e]||v.Fixo;const o=x.getCell(P,1);o.value=e,o.fill={type:"pattern",pattern:"solid",fgColor:{argb:t.bg}},o.font={color:{argb:t.fg},size:11,bold:!0},o.alignment={horizontal:"center"},x.mergeCells(P,2,P,Math.min(a,4)),x.getCell(P,2).value=f[e]||"",x.getCell(P,2).font={size:11},x.getCell(P,2).fill=F,P++}),x.getColumn(1).width=95;for(let e=2;e<=a;e++)x.getColumn(e).width=25}else if(o&&M&&"comparacao"===M.mode){const t=M.data.opcoes||[];let o=M.data.resultados||[];e&&e<o.length&&(o=o.slice(0,e));const a=1+t.length,n=x.getCell(P,1);n.value="Tarifário";const i=C("Simples");n.font={bold:!0,color:{argb:i.fg},size:11},n.fill={type:"pattern",pattern:"solid",fgColor:{argb:i.bg}},n.alignment={horizontal:"center"},n.border=D,t.forEach((e,t)=>{const o=C(e.display),a=x.getCell(P,t+2);a.value=`${e.display} (€)`,a.font={bold:!0,color:{argb:o.fg},size:11},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:o.bg}},a.alignment={horizontal:"center"},a.border=D}),P++;const l={};t.forEach(e=>{const t=o.map(t=>t.custos[e.display]).filter(e=>!isNaN(e)&&null!=e);l[e.display]=t.length?{min:Math.min(...t),max:Math.max(...t)}:{min:null,max:null}});const s=new Set;o.forEach(e=>{const o=I(e.tipo,e.nome);s.add(getTarifarioStyle(e.tipo,e.nome).label);const a=x.getCell(P,1);a.value=e.nome,a.fill={type:"pattern",pattern:"solid",fgColor:{argb:o.bg}},a.font={color:{argb:o.fg},size:11,bold:e.nome.includes("O Meu Tarifário")||e.nome.includes("Tarifário Personalizado")},a.alignment={horizontal:"center"},t.forEach((t,o)=>{const a=x.getCell(P,o+2),n=e.custos[t.display];if(null==n||isNaN(n))a.value="—",a.font={color:{argb:"AAAAAA"},size:11},a.fill=F;else{const e=b(n,l[t.display].min,l[t.display].max);a.value=n,a.numFmt="#,##0.00",a.fill={type:"pattern",pattern:"solid",fgColor:{argb:e.bg}},a.font={color:{argb:e.fg},size:11}}a.alignment={horizontal:"center"}}),P++}),k(P,a),P++,k(P,a),P++,x.mergeCells(P,1,P,Math.min(a,3)),x.getCell(P,1).value="Tipos de Tarifário:",x.getCell(P,1).font={bold:!0,size:11,underline:!0},x.getCell(P,1).alignment={horizontal:"center"},x.getCell(P,1).fill=F,P++;const r={"O Meu Tarifário":"Tarifário configurado pelo utilizador.",Personalizado:"Tarifário personalizado pelo utilizador.","Indexado Média":"Preço de energia baseado na média OMIE do período.","Indexado quarto-horário - Perfil":"Preço de energia baseado nos valores OMIE horários/quarto-horários e perfil.","Indexado quarto-horário - Diagrama":"Preço baseado nos dados reais do diagrama de cargas E-REDES.",Fixo:"Preços de energia constantes."};["O Meu Tarifário","Personalizado","Indexado Média","Indexado quarto-horário - Perfil","Indexado quarto-horário - Diagrama","Fixo"].forEach(e=>{if(!s.has(e))return;let t;t="O Meu Tarifário"===e?v.Utilizador:"Personalizado"===e?v.Personalizado:v[e]||v.Fixo;const o=x.getCell(P,1);o.value=e,o.fill={type:"pattern",pattern:"solid",fgColor:{argb:t.bg}},o.font={color:{argb:t.fg},size:11,bold:!0},o.alignment={horizontal:"center"},x.mergeCells(P,2,P,Math.min(a,4)),x.getCell(P,2).value=r[e]||"",x.getCell(P,2).font={size:11},x.getCell(P,2).fill=F,P++}),x.getColumn(1).width=95;for(let e=2;e<=a;e++)x.getColumn(e).width=25}else{const e=document.getElementById("thead"),t=document.getElementById("tbody");if(e){const t=[];e.querySelectorAll("th").forEach(e=>{const o=e.innerText.replace(/▼|▲/g,"").trim();o.toLowerCase().includes("detalhe")||t.push(o)}),t.forEach((e,t)=>{const o=x.getCell(P,t+1);o.value=e,o.font={bold:!0,size:11},o.fill=F}),P++}t&&t.querySelectorAll("tr").forEach(e=>{let t=0;e.querySelectorAll("td").forEach((o,a)=>{if(a===e.querySelectorAll("td").length-1)return;const n=x.getCell(P,t+1);n.value=o.innerText.trim(),n.font={size:11},n.fill=F,t++}),P++})}const H=new Date,q=`${H.getFullYear()}${(H.getMonth()+1).toString().padStart(2,"0")}${H.getDate().toString().padStart(2,"0")}_${H.getHours().toString().padStart(2,"0")}${H.getMinutes().toString().padStart(2,"0")}${H.getSeconds().toString().padStart(2,"0")}`,W=e?`_Top${e}`:"",G=o?`Tiago_Felicia_Eletricidade_Comparacao${W}_${q}.xlsx`:`Tiago_Felicia_Eletricidade_detalhe${W}_${q}.xlsx`,K=await B.xlsx.writeBuffer(),Q=new Blob([K],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),j=URL.createObjectURL(Q),X=document.createElement("a");X.href=j,X.download=G,X.click(),URL.revokeObjectURL(j)}catch(e){console.error("Erro ao exportar:",e),alert("Erro ao exportar para Excel: "+e.message)}}function toggleExportMenu(){const e=document.getElementById("export-dropdown");if(e.classList.contains("open"))return void fecharExportMenu();const t=LAST_EXPORT_DATA,o="comparacao"===t?.mode?t?.data?.resultados?.length||0:t?.results?.length||0;document.getElementById("exp-all").textContent=`Todos (${o})`,document.getElementById("exp-opt-20").style.display=o>20?"":"none",document.getElementById("exp-opt-40").style.display=o>40?"":"none",e.classList.add("open"),setTimeout(()=>document.addEventListener("click",fecharExportMenuFora,{once:!0}),10)}function fecharExportMenu(){const e=document.getElementById("export-dropdown");e&&e.classList.remove("open");const t=document.getElementById("btn-exportar");t&&(t.style.background="white",t.style.color="#16a34a")}function fecharExportMenuFora(e){const t=document.querySelector(".export-wrapper");t&&!t.contains(e.target)?fecharExportMenu():document.querySelector(".export-dropdown.open")&&setTimeout(()=>document.addEventListener("click",fecharExportMenuFora,{once:!0}),10)}const STORAGE_KEY="tf_cenarios_v1";function obterCenarios(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]")}catch(e){return[]}}function guardarCenariosLS(e){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(e))}catch(e){}}function capturarEstado(){const e={};return e.potencia=document.getElementById("potencia")?.value||"",e.ciclo=document.getElementById("ciclo")?.value||"",["kwh_S","kwh_V","kwh_F","kwh_C","kwh_P"].forEach(t=>{const o=document.getElementById(t);o&&(e[t]=o.value)}),["familia_numerosa","tarifa_social","modo_comparacao","ocultar_edp_h","quota_acp"].forEach(t=>{const o=document.getElementById(t);o&&(e[t]=o.checked)}),["f_segmento","f_fatura","f_pagamento"].forEach(t=>{const o=document.getElementById(t);o&&(e[t]=o.value)}),["cav_valor","dgeg_valor"].forEach(t=>{const o=document.getElementById(t);o&&(e[t]=o.value)}),["meu_S","meu_V","meu_F","meu_C","meu_P","meu_pot"].forEach(t=>{const o=document.getElementById(t);o&&(e[t]=o.value)}),["meu_tar_incluido"].forEach(t=>{const o=document.getElementById(t);o&&(e[t]=o.checked)}),e}function aplicarEstado(e){if(!e)return;const t=document.getElementById("potencia");t&&e.potencia&&(t.value=e.potencia),"function"==typeof atualizarMenusCiclo&&atualizarMenusCiclo();const o=document.getElementById("ciclo");o&&e.ciclo&&(o.value=e.ciclo),"function"==typeof construirInputsConsumo&&construirInputsConsumo(),setTimeout(()=>{["kwh_S","kwh_V","kwh_F","kwh_C","kwh_P"].forEach(t=>{const o=document.getElementById(t);o&&void 0!==e[t]&&(o.value=e[t])}),["familia_numerosa","tarifa_social","modo_comparacao","ocultar_edp_h","quota_acp"].forEach(t=>{const o=document.getElementById(t);o&&void 0!==e[t]&&(o.checked=e[t])}),["f_segmento","f_fatura","f_pagamento"].forEach(t=>{const o=document.getElementById(t);o&&void 0!==e[t]&&(o.value=e[t])}),["cav_valor","dgeg_valor"].forEach(t=>{const o=document.getElementById(t);o&&void 0!==e[t]&&(o.value=e[t])}),["meu_S","meu_V","meu_F","meu_C","meu_P","meu_pot"].forEach(t=>{const o=document.getElementById(t);o&&void 0!==e[t]&&(o.value=e[t])}),["meu_tar_incluido"].forEach(t=>{const o=document.getElementById(t);o&&void 0!==e[t]&&(o.checked=e[t])}),"function"==typeof calcular&&calcular()},100)}function guardarCenario(){const e=document.getElementById("input-nome-cenario")?.value?.trim();if(!e)return void alert("Introduza um nome para o cenário.");const t=obterCenarios(),o=document.getElementById("ciclo"),a=document.getElementById("potencia"),n=`${a?.value||"?"} kVA · ${o?.value||"?"}`;t.unshift({nome:e,estado:capturarEstado(),resumo:n,data:(new Date).toLocaleDateString("pt-PT")}),t.length>10&&(t.length=10),guardarCenariosLS(t),document.getElementById("input-nome-cenario").value="",renderizarListaCenarios()}function carregarCenario(e){const t=obterCenarios();t[e]&&(aplicarEstado(t[e].estado),fecharModalCenarios())}function apagarCenario(e){const t=obterCenarios();t.splice(e,1),guardarCenariosLS(t),renderizarListaCenarios()}function renderizarListaCenarios(){const e=document.getElementById("lista-cenarios"),t=obterCenarios();t.length?e.innerHTML=t.map((e,t)=>`\n                <div class="saved-item">\n                    <div class="saved-info" onclick="carregarCenario(${t})" title="Clique para carregar">\n                        <div class="saved-name">${e.nome}</div>\n                        <div class="saved-meta">${e.resumo||""} · ${e.data||""}</div>\n                    </div>\n                    <div class="saved-actions">\n                        <button class="btn-load" onclick="carregarCenario(${t})" title="Carregar"><i class="fa-solid fa-upload"></i></button>\n                        <button class="btn-del" onclick="apagarCenario(${t})" title="Apagar"><i class="fa-solid fa-trash"></i></button>\n                    </div>\n                </div>\n            `).join(""):e.innerHTML='<p style="text-align:center; color:var(--text-light); font-size:0.85rem; padding:20px 0;">Nenhum cenário guardado</p>'}function abrirModalCenarios(){renderizarListaCenarios(),document.getElementById("modal-cenarios").classList.add("open")}function fecharModalCenarios(){document.getElementById("modal-cenarios").classList.remove("open")}document.addEventListener("keydown",e=>{"Escape"===e.key&&fecharModalCenarios()});const CICLO_CODES={Simples:"S","Bi-horário - Ciclo Diário":"BD","Bi-horário - Ciclo Semanal":"BS","Tri-horário - Ciclo Diário":"TD","Tri-horário - Ciclo Semanal":"TS","Tri-horário > 20.7 kVA - Ciclo Diário":"XD","Tri-horário > 20.7 kVA - Ciclo Semanal":"XS"},CICLO_DECODE=Object.fromEntries(Object.entries(CICLO_CODES).map(([e,t])=>[t,e]));function gerarLinkPartilha(){document.querySelectorAll('#content-consumo input[type="text"]').forEach(e=>{resolverExpressao(e)});try{const e=new URLSearchParams;e.set("p",document.getElementById("potencia")?.value||"");const t=document.getElementById("ciclo")?.value||"";e.set("c",CICLO_CODES[t]||t);const o=(document.getElementById("d_inicio")?.value||"").replace(/-/g,""),a=(document.getElementById("d_fim")?.value||"").replace(/-/g,"");o&&e.set("a",o),a&&e.set("b",a),[["kwh_S","s"],["kwh_V","v"],["kwh_F","f"],["kwh_P","t"],["kwh_C","k"]].forEach(([t,o])=>{const a=document.getElementById(t);a&&parseFloat(a.value)&&e.set(o,a.value)});let n="";document.getElementById("familia_numerosa")?.checked&&(n+="F"),document.getElementById("tarifa_social")?.checked&&(n+="T"),document.getElementById("ocultar_edp_h")?.checked&&(n+="E"),document.getElementById("quota_acp")?.checked&&(n+="A"),document.getElementById("modo_comparacao")?.checked&&(n+="C"),n&&e.set("fl",n);const i=document.getElementById("f_segmento")?.value;i&&"Todos"!==i&&e.set("sg",i.charAt(0));const l=document.getElementById("f_fatura")?.value;l&&"Todas"!==l&&e.set("ft",l.charAt(0));const s=document.getElementById("f_pagamento")?.value;s&&"Todos"!==s&&e.set("pg",s.charAt(0));const r=document.getElementById("cav_valor")?.value;r&&"2.85"!==r&&e.set("cv",r);const c=document.getElementById("dgeg_valor")?.value;c&&"0.07"!==c&&e.set("dg",c);const d=Array.from(document.querySelectorAll(".chk-tipo")).map(e=>e.checked?"1":"0").join("");if(d&&!d.match(/^1+$/)&&e.set("tp",parseInt(d,2).toString(36)),OMIE_MANUAL){const t=[];document.querySelectorAll('#omie-inputs input[type="number"]').forEach(e=>t.push(e.value)),e.set("om",t.join(","))}if(document.getElementById("meu_ativo")?.checked){const t=["meu_energia_s","meu_energia_v","meu_energia_f","meu_energia_p","meu_energia_c","meu_potencia","meu_desc_fat","meu_acres_fat"].map(e=>document.getElementById(e)?.value||"0").join(",");e.set("m",t);let o="";document.getElementById("meu_tar_energia")?.checked&&(o+="e"),document.getElementById("meu_tar_potencia")?.checked&&(o+="p"),document.getElementById("meu_tse_incluido")?.checked&&(o+="t"),o&&e.set("mf",o)}if(document.getElementById("pers_ativo")?.checked){const t=["pers_energia_s","pers_potencia_s","pers_energia_v_bi","pers_energia_f_bi","pers_potencia_bi","pers_energia_v_tri","pers_energia_c_tri","pers_energia_p_tri","pers_potencia_tri"].map(e=>document.getElementById(e)?.value||"0").join(",");e.set("x",t);let o="";document.getElementById("pers_tar_energia")?.checked&&(o+="e"),document.getElementById("pers_tar_potencia")?.checked&&(o+="p"),document.getElementById("pers_tse_incluido")?.checked&&(o+="t"),o&&e.set("xf",o)}const u=window.location.origin+window.location.pathname+"?z=2&"+e.toString();navigator.clipboard.writeText(u).then(()=>{const e=document.getElementById("btn-partilhar"),t=e.innerHTML;e.innerHTML='<i class="fa-solid fa-check"></i> Link Copiado!',e.style.background="#16a34a",e.style.color="white",e.style.borderColor="#16a34a",setTimeout(()=>{e.innerHTML=t,e.style.background="white",e.style.color="var(--primary)",e.style.borderColor="var(--primary)"},2500)}).catch(()=>{prompt("Copie o link abaixo:",u)})}catch(e){console.error("Erro ao gerar link:",e),alert("Erro ao gerar link de partilha.")}}function aplicarParametrosPartilha(){const e=new URLSearchParams(window.location.search);return!!(e.has("z")||e.has("pot")&&"complete"===e.get("tab"))&&(window._SHARED_PARAMS=e,!0)}function aplicarSharedParamsDepoisDeCarregar(){const e=window._SHARED_PARAMS;if(e){delete window._SHARED_PARAMS;try{"complete"!==CURRENT_TAB?(document.querySelector('[onclick*="switchTab"][onclick*="complete"]')?.click(),setTimeout(()=>aplicarSharedParamsAosInputs(e),300)):aplicarSharedParamsAosInputs(e)}catch(e){console.error("Erro ao aplicar params:",e)}}}function aplicarSharedParamsAosInputs(e){try{const t=(e,t)=>{const o=document.getElementById(e);o&&null!=t&&(o.value=t)},o=(e,t)=>{const o=document.getElementById(e);o&&(o.checked=!!t)};if(e.has("z")){t("potencia",e.get("p")),atualizarMenusCiclo();const a=e.get("c")||"";t("ciclo",CICLO_DECODE[a]||a),construirInputsConsumo();const n=e.get("a")||"",i=e.get("b")||"";8===n.length&&t("d_inicio",n.slice(0,4)+"-"+n.slice(4,6)+"-"+n.slice(6,8)),8===i.length&&t("d_fim",i.slice(0,4)+"-"+i.slice(4,6)+"-"+i.slice(6,8)),atualizarDias(),setTimeout(()=>{e.get("s")&&t("kwh_S",e.get("s")),e.get("v")&&t("kwh_V",e.get("v")),e.get("f")&&t("kwh_F",e.get("f")),e.get("t")&&t("kwh_P",e.get("t")),e.get("k")&&t("kwh_C",e.get("k"));const a=e.get("fl")||"";if(o("familia_numerosa",a.includes("F")),o("tarifa_social",a.includes("T")),o("ocultar_edp_h",a.includes("E")),o("quota_acp",a.includes("A")),o("modo_comparacao",a.includes("C")),e.get("sg")&&t("f_segmento",{R:"Residencial",E:"Empresarial"}[e.get("sg")]||e.get("sg")),e.get("ft")&&t("f_fatura",{E:"Eletrónica",P:"Papel"}[e.get("ft")]||e.get("ft")),e.get("pg")&&t("f_pagamento",{D:"Débito Direto",M:"Multibanco",O:"Outros"}[e.get("pg")]||e.get("pg")),e.get("cv")&&t("cav_valor",e.get("cv")),e.get("dg")&&t("dgeg_valor",e.get("dg")),e.get("tp")){const t=parseInt(e.get("tp"),36).toString(2),o=document.querySelectorAll(".chk-tipo"),a=t.padStart(o.length,"0");o.forEach((e,t)=>{e.checked="1"===a[t]})}if(e.get("om")){OMIE_MANUAL=!0,construirInputsOMIE(CICLO_DECODE[e.get("c")]||e.get("c"));const t=e.get("om").split(",");document.querySelectorAll('#omie-inputs input[type="number"]').forEach((e,o)=>{t[o]&&(e.value=t[o])})}if(e.get("m")){o("meu_ativo",!0),toggleMeuTarifario();const a=e.get("m").split(",");["meu_energia_s","meu_energia_v","meu_energia_f","meu_energia_p","meu_energia_c","meu_potencia","meu_desc_fat","meu_acres_fat"].forEach((e,o)=>t(e,a[o]||"0"));const n=e.get("mf")||"";o("meu_tar_energia",n.includes("e")),o("meu_tar_potencia",n.includes("p")),o("meu_tse_incluido",n.includes("t"))}if(e.get("x")){o("pers_ativo",!0),toggleTarifarioPersonalizado();const a=e.get("x").split(",");["pers_energia_s","pers_potencia_s","pers_energia_v_bi","pers_energia_f_bi","pers_potencia_bi","pers_energia_v_tri","pers_energia_c_tri","pers_energia_p_tri","pers_potencia_tri"].forEach((e,o)=>t(e,a[o]||"0"));const n=e.get("xf")||"";o("pers_tar_energia",n.includes("e")),o("pers_tar_potencia",n.includes("p")),o("pers_tse_incluido",n.includes("t"))}calcular(),setTimeout(()=>{document.getElementById("titulo-tabela")?.scrollIntoView({behavior:"smooth",block:"start"})},500)},200)}else t("potencia",e.get("pot")),atualizarMenusCiclo(),t("ciclo",e.get("ciclo")),construirInputsConsumo(),t("d_inicio",e.get("d1")),t("d_fim",e.get("d2")),atualizarDias(),setTimeout(()=>{if(["kwh_S","kwh_V","kwh_F","kwh_P","kwh_C"].forEach(o=>{e.get(o)&&t(o,e.get(o))}),o("familia_numerosa","1"===e.get("fam")),o("tarifa_social","1"===e.get("ts")),e.get("seg")&&t("f_segmento",e.get("seg")),e.get("fat")&&t("f_fatura",e.get("fat")),e.get("pag")&&t("f_pagamento",e.get("pag")),e.get("cav")&&t("cav_valor",e.get("cav")),e.get("dgeg")&&t("dgeg_valor",e.get("dgeg")),o("ocultar_edp_h","1"===e.get("edp")),o("quota_acp","1"===e.get("acp")),o("modo_comparacao","1"===e.get("comp")),e.get("tipos")){const t=e.get("tipos");document.querySelectorAll(".chk-tipo").forEach((e,o)=>{e.checked="1"===t[o]})}"1"===e.get("meu")&&(o("meu_ativo",!0),toggleMeuTarifario(),["meu_energia_s","meu_energia_v","meu_energia_f","meu_energia_p","meu_energia_c","meu_potencia","meu_desc_fat","meu_acres_fat"].forEach(o=>{e.get(o)&&t(o,e.get(o))}),o("meu_tar_energia","1"===e.get("meu_te")),o("meu_tar_potencia","1"===e.get("meu_tp")),o("meu_tse_incluido","1"===e.get("meu_tse"))),"1"===e.get("pers")&&(o("pers_ativo",!0),toggleTarifarioPersonalizado(),["pers_energia_s","pers_potencia_s","pers_energia_v_bi","pers_energia_f_bi","pers_potencia_bi","pers_energia_v_tri","pers_energia_c_tri","pers_energia_p_tri","pers_potencia_tri"].forEach(o=>{e.get(o)&&t(o,e.get(o))}),o("pers_tar_energia","1"===e.get("pers_te")),o("pers_tar_potencia","1"===e.get("pers_tp")),o("pers_tse_incluido","1"===e.get("pers_tse"))),calcular(),setTimeout(()=>{document.getElementById("titulo-tabela")?.scrollIntoView({behavior:"smooth",block:"start"})},500)},200)}catch(e){console.error("Erro ao aplicar inputs:",e)}}    
    
    </script>
    
    <!-- === ABA 4: FAQ === -->
    <div id="tab-faq" class="tab-content hidden">
        <div style="max-width: 900px; margin: 40px auto; padding: 20px;">
            <!-- FAQ original -->
            <div id="datas-ref-faq"></div>
            <article class="content-support">

                    <h2>📊 Sobre o Simulador</h2>

                    <p><strong>O que é este simulador?</strong></p>
                    <p>É uma ferramenta gratuita que compara tarifários de eletricidade em Portugal.</p>
                    
                    <h2>⚡ Simulação Rápida</h2>
                    <p><strong>Para quem é?</strong></p>
                    <p>Para quem quer uma resposta rápida. Basta indicar quanto paga ou consome.</p>
                    
                    <h2>📝 Simulação Completa</h2>
                    <p><strong>Para quem é?</strong></p>
                    <p>Para quem quer controlo total sobre os parâmetros.</p>
                    
                    <h2>📊 Análise Avançada</h2>
                    <p><strong>Para quem é?</strong></p>
                    <p>Para quem tem o ficheiro de consumos da E-Redes. Atenção que o ficheiro deve ser do tipo "Consumos/Diagrama de Carga" e não do tipo "Leituras". Esta análise permite comparar tarifários com base nos seus dados reais de consumo passados e com os valores OMIE passados. Se quiser com dados OMIE/OMIP Futuros, terá de colocar os consumos em Simulação Completa</p>



                <h2>Como Usar o Simulador de Tarifários</h2>
                <details class="faq-item">
                    <summary><strong>Guia Rápido</strong></summary>
                    <div class="faq-content">
                        <p>Bem-vindo! Esta ferramenta ajuda-o a descobrir o tarifário de eletricidade mais económico para si. Siga os passos abaixo para começar a poupar.</p>

                        <h3><strong>Passo 1: Escolha o seu Ponto de Partida</strong></h3>
                        <ul>
                            <li style="margin-bottom: 15px;">
                                <p><strong><em>✍️ Simulação Rápida</em></strong></p>
                                <ol>
                                    <li><strong>Defina algumas opções:</strong> Escolha <strong>"Quanto paga por mês?"</strong> ou <strong>"Quanto consome por mês"</strong>.</li>
                                    <li><strong>Altere o Consumo:</strong> Preencha o seu consumo mensal estimado (kWh) no campo que aparece.</li>
                                    <li><strong>Altere a Potência:</strong> Selecione uma das potências disponíveis.</li>
                                    <li><strong>Vantagem:</strong> Ideal para simulações imediatas e previsões de custos sem precisar de muito tempo.</li>
                                </ol>
                            </li>

                            <li style="margin-bottom: 15px;">
                                <p><strong><em>📝 Simulação Completa</em></strong></p>
                                <p style="margin-top: 5px; margin-bottom: 5px;">Primeiro, defina a sua <strong>Potência Contratada</strong> e <strong>Opção Horária</strong>.</p>
                                <ol>
                                    <li><strong>Insira os Consumos:</strong> Preencha os seus consumos mensais estimados (kWh) nos campos (ex: Vazio, Fora de Vazio).</li>
                                    <li><strong>Defina o Período:</strong> Escolha as <strong>datas</strong> para a simulação.</li>
                                    <li><strong>Vantagem:</strong> Ideal para simulações mais rigorosas e previsões de custos futuros.</li>
                                </ol>
                            </li>

                            <li>
                                <p><strong><em>📊 Análise Avançada (com Ficheiro E-Redes)</em></strong></p>
                                <ol>
                                    <li><strong>Carregue o Ficheiro:</strong> Em "Clique para selecionar ficheiro(s)", envie o seu ficheiro <code>.xlsx</code> da E-Redes. Pode obtê-lo em <a href="https://balcaodigital.e-redes.pt/consumptions/history" target="_blank" rel="noopener noreferrer">balcaodigital.e-redes.pt</a>.</li>
                                    <li><strong>Configure:</strong> Defina a sua <strong>Potência Contratada</strong> e <strong>Opção Horária</strong>.</li>
                                    <li><strong>Selecione o Período:</strong> Escolha as datas que pretende analisar.</li>
                                    <li><strong>Vantagem:</strong> Esta é a forma mais precisa. O simulador usa os seus consumos a cada 15 minutos para uma análise exata, incluindo <strong>gráficos detalhados</strong>.</li>
                                    <li><strong>Nota Importante:</strong> A análise é feita com os consumos e valores OMIE do passado. Se pretender verificar estimativas para o futuro, deve transpor os dados obtidos aqui para a <strong>📝 Simulação Completa</strong>.</li>
                                </ol>
                            </li>
                        </ul>

                        <h3><strong>Passo 2: 🏆 Encontre a Melhor Tarifa</strong></h3>
                        <p>A tabela de resultados no final da página é a sua ferramenta principal.</p>
                        <ul>
                            <li><strong>Ordenar por Custo:</strong> Clique no cabeçalho da coluna <strong>"Total (€)"</strong> para ordenar os tarifários do mais barato para o mais caro.</li>
                            <li><strong>Explorar Detalhes:</strong> Passe o rato sobre os preços ou sobre o custo total para ver um <strong>resumo detalhado</strong> dos cálculos, incluindo todas as taxas e impostos.</li>
                            <li><strong>Filtrar Resultados:</strong> Use os filtros no topo da tabela para refinar a sua pesquisa por tipo de tarifário (Fixo, Indexado), segmento, etc.</li>
                            <li><strong>Comparar Opções Horárias:</strong> Ative a opção "<strong>Modo de Comparação</strong>" para ver uma tabela especial que mostra quanto pagaria em cada tarifário se tivesse um ciclo diferente (Simples, Bi-Horário, etc.).</li>
                        </ul>

                        <blockquote>
                            <p><strong>Dica Pro:</strong> Use a secção <strong>"🧾 O Meu Tarifário"</strong> para introduzir os preços da sua fatura atual e compará-la diretamente com todas as ofertas do mercado. Assim, saberá exatamente quanto pode poupar!</p>
                        </blockquote>
                    </div>
                </details>
            
            <h2>Perguntas Frequentes (FAQ)</h2>
            
            <details class="faq-item">
                <summary><strong>De onde vêm os dados dos tarifários e dos preços de mercado (OMIE)?</strong></summary>
                <div class="faq-content">
                    <p>Todos os dados dos tarifários são recolhidos a partir das informações públicas disponibilizadas pelos comercializadores nos seus websites. Os preços do mercado ibérico (OMIE) e os perfis de consumo da E-Redes são obtidos de fontes oficiais para garantir a máxima precisão nos cálculos dos tarifários indexados. Os dados são atualizados regularmente para refletir as condições atuais do mercado.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Alguns tarifários têm um custo de energia diferente do site institucional, porquê?</strong></summary>
                <div class="faq-content">
                    <p>Alguns comercializadores não incluem o valor do financiamento da Tarifa Social de Eletricidade (TSE) no custo base da energia. Para que se possa comparar todos de forma igual, nesses casos, o custo da TSE é adicionado ao custo base. Para confirmar, passe o rato por cima do valor da energia na tabela para ver a decomposição detalhada do preço.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>O meu tarifário tem o mesmo nome, mas valores diferentes. Porquê?</strong></summary>
                <div class="faq-content">
                    <p>Muitos comercializadores alteram os valores nos seus tarifários, mas mantêm as mesmas denominações comerciais. Este simulador utiliza sempre os valores da versão mais recente do tarifário disponibilizada pelo comercializador.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>O simulador é 100% preciso?</strong></summary>
                <div class="faq-content">
                    <p>O objetivo é ser o mais preciso possível. Para tarifários <strong>fixos</strong>, a precisão é muito elevada. Para tarifários <strong>indexados</strong>, o custo final é uma estimativa baseada em médias e perfis de consumo (no caso de dados históricos). A forma mais rigorosa de simulação é sempre através do carregamento do seu <strong>diagrama de carga da E-Redes</strong>, pois utiliza o seu perfil de consumo real.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Porque é que o modo "Análise Avançada" (com ficheiro E-Redes) é recomendado?</strong></summary>
                <div class="faq-content">
                    <p>Este modo utiliza o seu consumo real registado a cada 15 minutos. Isto permite um cálculo exato do custo para qualquer tipo de tarifário, incluindo os <strong>indexados quarto-horários (dinâmicos)</strong>. Além disso, só neste modo é possível fazer uma análise precisa da sua <strong>potência contratada</strong>.</p>
                </div>
            </details>
            
            <h3 class="faq-section-title">Dados e Períodos</h3>
            
            <details class="faq-item">
                <summary><strong>Porque é que a simulação só está disponível a partir de 01/01/2026?</strong></summary>
                <div class="faq-content">
                    <p>A simulação está focada no ano de 2026 para garantir que os cálculos utilizam as Tarifas de Acesso às Redes (TAR) e outras taxas e impostos em vigor. O simulador ignora automaticamente quaisquer dados de consumo anteriores a esta data para garantir a relevância dos resultados.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Como são tratados os fins de semana e feriados nos ciclos horários?</strong></summary>
                <div class="faq-content">
                    <p>O simulador utiliza os ciclos horários oficiais definidos pela ERSE. Nos <strong>Ciclos Semanais</strong>, os fins de semana têm um tratamento específico (geralmente com mais horas em "Vazio"). Nos <strong>Ciclos Diários</strong>, a contagem das horas é a mesma para todos os dias. Os feriados não têm regras especificas em BTN, sendo tratados como dias 'normais'. O simulador aplica estas regras automaticamente com base nos dados oficiais.</p>
                </div>
            </details>
            
            <h3 class="faq-section-title">Funcionalidades do Simulador</h3>
            
            <details class="faq-item">
                <summary><strong>O que significa a opção "Modo Comparação"?</strong></summary>
                <div class="faq-content">
                    <p>Ao ativar esta opção, o simulador recalcula o custo de cada tarifário para diferentes ciclos horários (Simples, Bi-Horário, etc.), usando os seus consumos. É útil para perceber se compensaria mudar de opção horária.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Como funciona a secção "O Meu Tarifário"?</strong></summary>
                <div class="faq-content">
                    <p>Esta secção permite-lhe introduzir os preços da sua fatura atual para comparar diretamente com todas as outras ofertas. É fundamental verificar na sua fatura se os preços que insere já incluem as <strong>TAR (Tarifas de Acesso às Redes)</strong>.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Para que serve a secção "Tarifário Personalizado?"</strong></summary>
                <div class="faq-content">
                    <p>Esta funcionalidade permite-lhe construir cenários hipotéticos com os seus próprios preços. É ideal para simular uma oferta que recebeu, testar o impacto de alterações de preços ou perceber qual seria o custo se o seu comercializador oferecesse uma opção horária diferente.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Os valores OMIE para datas futuras são reais?</strong></summary>
                <div class="faq-content">
                    <p>Não. Os valores para datas futuras baseiam-se nos preços do mercado de futuros (OMIP), que representam a expectativa do mercado. Servem como a melhor estimativa disponível, mas não são uma garantia. A data de atualização destes valores está indicada no final da página.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Como são tratados descontos especiais como os do ACP?</strong></summary>
                <div class="faq-content">
                    <p>Para a parceria <strong>Goldenergy/ACP</strong>, pode incluir a quota mensal no custo final. Pode gerir estas opções em "Opções Adicionais".</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>O que está incluído no "Total (€)"?</strong></summary>
                <div class="faq-content">
                    <p>Sim, o "Total (€)" é a sua fatura final estimada. Inclui o custo da energia e da potência, todas as taxas (CAV, DGEG, IEC), o IVA aplicado corretamente e quaisquer descontos ou acréscimos. Lembre-se que pode ver a decomposição detalhada de todos estes custos <strong>passando o rato por cima do valor na coluna 'Total (€)'</strong>.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Como posso encontrar rapidamente o que procuro na tabela?</strong></summary>
                <div class="faq-content">
                    <p>A tabela é interativa! Pode:</p>
                    <ul>
                        <li><strong>Ordenar:</strong> Clique no cabeçalho de qualquer coluna (ex: "Total (€)") para ordenar os resultados.</li>
                        <li><strong>Filtrar:</strong> Use os filtros no topo da tabela para refinar a sua pesquisa.</li>
                        <li><strong>Pesquisar:</strong> Use a pesquisa dentro das colunas "Comercializador" e "Tarifário" para encontrar uma oferta específica.</li>
                    </ul>
                </div>
            </details>
            
            <h3 class="faq-section-title">Termos e Conceitos</h3>
            
            <details class="faq-item">
                <summary><strong>O que é um tarifário indexado? É uma boa opção?</strong></summary>
                <div class="faq-content">
                    <p>Um tarifário indexado tem um preço de energia que varia com o mercado grossista (OMIE). Este tipo de tarifário pode oferecer uma poupança significativa quando os preços de mercado estão baixos, mas também implica um risco maior se os preços subirem. Pode ser:</p>
                    <ul>
                        <li><strong>Indexado à Média:</strong> O preço baseia-se na média do período de faturação (ex. mensal) dos preços OMIE para os períodos horários (Vazio, Fora de Vazio, etc.).</li>
                        <li><strong>Indexado Quarto-Horário (Dinâmico):</strong> O preço varia a cada hora (ou 15 minutos). São ideais para quem consegue adaptar o consumo às horas mais baratas.</li>
                    </ul>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>O que são as TAR (Tarifas de Acesso às Redes)?</strong></summary>
                <div class="faq-content">
                    <p>As TAR são tarifas reguladas pela ERSE que pagam pelo uso das infraestruturas elétricas. Todos os consumidores as pagam, independentemente do comercializador. O simulador lida com os casos em que as TAR estão incluídas ou separadas do preço da energia para garantir uma comparação justa.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>O que significa "Perfil de Consumo" (ex: Perfil A, B, C)?</strong></summary>
                <div class="faq-content">
                    <p>A ERSE agrupa os consumidores em perfis (A, B, C) que representam um padrão de consumo médio. No <strong>Modo Manual</strong>, o simulador usa estes perfis para estimar o custo dos tarifários indexados. No <strong>Modo Diagrama</strong>, este perfil não é necessário para o cálculo principal, pois são usados os seus dados reais.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Porque é que o simulador pergunta se a minha instalação é trifásica?</strong></summary>
                <div class="faq-content">
                    <p>O ficheiro da E-Redes regista a potência total da sua casa em médias de 15 minutos. Numa instalação <strong>trifásica</strong>, é possível que uma única fase tenha um pico de consumo muito elevado num curto espaço de tempo, fazendo o disjuntor disparar, mesmo que a potência total <em>média</em> nesses 15 minutos não ultrapasse o valor contratado. Assinalar que a sua instalação é trifásica permite que a análise de potência o alerte para este risco.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Como sei se a minha instalação é monofásica ou trifásica?</strong></summary>
                <div class="faq-content">
                    <p>Geralmente, instalações domésticas com potências contratadas até 6.9 kVA são monofásicas. Potências superiores são quase sempre trifásicas. Esta informação está disponível na sua fatura, no seu contador ou no balcão digital da E-Redes.</p>
                </div>
            </details>
            
            </article>
        </div>
    </div>

</main>

<!-- MODAL CENÁRIOS GUARDADOS -->
<div class="modal-overlay" id="modal-cenarios">
    <div class="modal-box">
        <h3><i class="fa-solid fa-floppy-disk" style="color:var(--primary); margin-right:8px;"></i>Cenários Guardados</h3>
        <div class="save-input-row">
            <input type="text" id="input-nome-cenario" placeholder="Nome do cenário..." maxlength="40">
            <button class="btn-save" onclick="guardarCenario()"><i class="fa-solid fa-plus" style="margin-right:4px;"></i> Guardar</button>
        </div>
        <div id="lista-cenarios"></div>
        <button class="modal-close" onclick="fecharModalCenarios()">Fechar</button>
    </div>
</div>

<!-- WATERMARK INFERIOR - INÍCIO -->
<div style="margin-top: 40px; padding: 20px; background: #f8fafc; 
            border-top: 3px solid #0066cc; text-align: center;">
    <div style="max-width: 800px; margin: 0 auto;">
        <p style="font-size: 0.95rem; color: #0f172a; margin-bottom: 10px;">
            <strong>Simulador de Tarifários de Eletricidade | Tiago Felícia</strong>
        </p>
        <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 8px;">
            Desenvolvido por <a href="https://www.tiagofelicia.pt" style="color: #0066cc; font-weight: 500;">Tiago Felícia</a>
        </p>
        <p style="font-size: 0.75rem; color: #94a3b8;">
            © 2024-2026 Tiago Felícia. Todos os direitos reservados.<br>
            <i class="fa-solid fa-shield-halved"></i>
            Versão oficial disponível apenas em 
            <strong style="color: #0066cc;">www.tiagofelicia.pt</strong>
        </p>
    </div>
</div>
<!-- WATERMARK INFERIOR - FIM -->

<div id="footer-placeholder"></div>

<script>
// === Carregar menu.html e footer.html do site ===
(function() {
    fetch('menu.html')
        .then(r => r.ok ? r.text() : '')
        .then(html => { if(html) document.getElementById('menu-placeholder').innerHTML = html; })
        .catch(() => {});
    fetch('footer.html')
        .then(r => r.ok ? r.text() : '')
        .then(html => { if(html) document.getElementById('footer-placeholder').innerHTML = html; })
        .catch(() => {});
})();
</script>
<script src="script.js"></script>
</body>
</html>