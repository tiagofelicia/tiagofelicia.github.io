<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Simulador de Tarif√°rios Eletricidade 2026: Poupe na Fatura | Tiago Fel√≠cia</title>
    <meta name="description" content="Compare tarif√°rios de eletricidade em Portugal para 2026. Use o simulador gratuito, com ou sem ficheiro da E-Redes, e descubra quanto pode poupar na sua fatura da luz." />
    <link rel="canonical" href="https://www.tiagofelicia.pt/eletricidade-tiagofelicia.html" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Simulador Eletricidade 2026: Qual o mais barato?" />
    <meta property="og:description" content="Pare de pagar demais. Compare tarif√°rios fixos e indexados com o seu consumo real." />
    <meta property="og:url" content="https://www.tiagofelicia.pt/eletricidade-tiagofelicia.html" />
    <meta property="og:image" content="https://www.tiagofelicia.pt/images/social-share.jpg" />
    <meta property="og:locale" content="pt_PT" />

    <link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg" />
    <link rel="shortcut icon" href="/images/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" />
    <link rel="manifest" href="/images/site.webmanifest" />

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css" />

    <!-- Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J4NWP00S4F"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-J4NWP00S4F');
    </script>
    
    <style>
        :root { 
            --primary: #0066cc; --bg: #f8fafc; --surface: #ffffff; 
            --text-main: #0f172a; --text-light: #64748b; --border: #e2e8f0;
            --success: #16a34a; --warning: #d97706; --danger: #dc2626;
        }
        /* Site integration: content padding */
        #loader { margin: 0 20px; }
        .tabs-container { margin-left: 20px; margin-right: 20px; }
        .grid-container { padding: 0 20px; }
        #eredes-upload-central { margin-left: 20px; margin-right: 20px; }
        #tab-quick { padding: 0 20px; }
        #tab-faq > div { margin-left: auto; margin-right: auto; padding-left: 20px; padding-right: 20px; }
        #menu-placeholder { margin-bottom: 0; }
        #footer-placeholder { margin-top: 40px; }
        
        * { box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 0; font-size: 0.92rem; line-height: 1.5; }
        .hidden { display: none !important; }
        
        .grid-container { display: grid; grid-template-columns: 360px 1fr; gap: 20px; max-width: 1900px; margin: 0 auto; align-items: start; }
        @media (max-width: 1200px) { .grid-container { grid-template-columns: 1fr; } }

        .sidebar { background: var(--surface); padding: 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto; z-index: 10; }
        
        .section-title { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: var(--text-light); margin: 16px 0 8px 0; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); padding-bottom: 4px; cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center; }
        .section-title:hover { color: var(--primary); }
        .section-content { margin-bottom: 12px; }
        .section-content.collapsed { display: none; }

        /* === CORES POR SEC√á√ÉO DA SIDEBAR (Paleta Suave/Terra) === */

        /* 1. Contrato - Azul Acinzentado */
        .section-title[onclick*="contrato"] { 
            background: #adc5d7 !important; 
            color: #1e3a8a !important;      /* Azul escuro profundo */
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="contrato"]:hover { 
            background: #8daec4 !important; /* Ligeiramente mais escuro */
            color: #172554 !important; 
        }
        #content-contrato { 
            background: #f0f4f8; 
            border-left: 4px solid #adc5d7; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* 2. Consumo - P√™ssego */
        .section-title[onclick*="consumo"] { 
            background: #F6C9B0 !important; 
            color: #5f370e !important;      /* Castanho/Laranja escuro */
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="consumo"]:hover { 
            background: #eebb9e !important; /* P√™ssego mais denso */
            color: #431407 !important; 
        }
        #content-consumo { 
            background: #fff8f5; 
            border-left: 4px solid #F6C9B0; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* 3. E-Redes - Laranja Pastel */
        .section-title[onclick*="eredes"] { 
            background: #fed7aa !important; 
            color: #7c2d12 !important;      /* Ferrugem */
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="eredes"]:hover { 
            background: #fdba74 !important; /* Laranja um pouco mais forte */
            color: #431407 !important; 
        }
        #content-eredes { 
            background: #fff7ed; 
            border-left: 4px solid #fed7aa; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* 4. Meu Tarif√°rio - Vermelho Suave */
        .section-title[onclick*="meu"] { 
            background: #FF9F9F !important; 
            color: #7f1d1d !important;      /* Vermelho sangue escuro */
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="meu"]:hover { 
            background: #f87171 !important; /* Vermelho m√©dio */
            color: #450a0a !important; 
        }
        #content-meu { 
            background: #fef2f2; 
            border-left: 4px solid #FF9F9F; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* 5. Personalizado - Verde Menta Suave */
        .section-title[onclick*="personalizado"] { 
            background: #A3D1C2 !important; 
            color: #134e4a !important;      /* Verde cerceta escuro */
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="personalizado"]:hover { 
            background: #84c2ae !important; /* Menta mais escura */
            color: #042f2e !important; 
        }
        #content-personalizado { 
            background: #f0fdf9; 
            border-left: 4px solid #A3D1C2; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* 6. Compara√ß√£o - Azul Claro/Ciano */
        .section-title[onclick*="comparacao"] { 
            background: #8FBBD1 !important; 
            color: #164e63 !important;      /* Azul petr√≥leo escuro */
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="comparacao"]:hover { 
            background: #6facc7 !important; 
            color: #083344 !important; 
        }
        #content-comparacao { 
            background: #ecfeff; 
            border-left: 4px solid #8FBBD1; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* 7. Benef√≠cios Sociais - Verde Oliva/Dourado */
        .section-title[onclick*="beneficios"] { 
            background: #C6CBAD !important; 
            color: #3f422e !important;      /* Verde tropa escuro */
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="beneficios"]:hover { 
            background: #b1b88e !important; 
            color: #1a1c0d !important; 
        }
        #content-beneficios { 
            background: #f7fee7; 
            border-left: 4px solid #C6CBAD; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* 8. Op√ß√µes - Bege  */
        .section-title[onclick*="opcoes"] { 
            background: #EADCB8 !important; 
            color: #5f4e24 !important;      /* Castanho dourado escuro */
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="opcoes"]:hover { 
            background: #dec690 !important; 
            color: #3a2d0d !important; 
        }
        #content-opcoes { 
            background: #fffbeb; 
            border-left: 4px solid #EADCB8; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* 9. Datas - Violeta/Rosa Velho */
        .section-title[onclick*="datas"] { 
            background: #C9ABAB !important; 
            color: #4a2c2c !important;      /* Cor de vinho/terra */
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="datas"]:hover { 
            background: #b89292 !important; 
            color: #2b1212 !important; 
        }
        #content-datas { 
            background: #fdf2f2; 
            border-left: 4px solid #C9ABAB; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        .input-group { margin-bottom: 10px; }
        label { display: block; font-weight: 500; margin-bottom: 4px; font-size: 0.85rem; }
        .label-units { font-family: 'Roboto Mono', monospace; font-weight: 400; color: var(--text-light); font-size: 0.8em; }
        
        input[type="number"], input[type="date"], select {
            width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px;
            font-size: 0.9rem; transition: 0.2s; background: #fff; font-family: 'Roboto Mono', monospace;
        }
        input:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(0,102,204,0.1); }
        
        .omie-box { background: #fff7ed; border: 1px solid #fed7aa; padding: 10px; border-radius: 6px; margin-bottom: 12px; }
        .omie-editable { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
        .omie-input { padding: 4px 6px; font-size: 0.8rem; font-family: 'Roboto Mono', monospace; }
        
        .custom-tariff { background: #f0f9ff; border: 1px solid #bae6fd; padding: 10px; border-radius: 8px; margin-top: 10px; }
        
        .main-content { min-width: 0; }
        
        .filters-bar { 
            background: var(--surface); padding: 12px 16px; border-radius: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px;
            display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end;
        }
        .filter-item { flex: 1; min-width: 130px; }
        .checkbox-group { display: flex; gap: 12px; margin-top: 4px; flex-wrap: wrap; }
        .checkbox-label { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; cursor: pointer; user-select: none; font-weight: 400; }
        .checkbox-label input { accent-color: var(--primary); width: 16px; height: 16px; }

        .table-wrap { background: var(--surface); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow-x: auto; border: 1px solid var(--border); }
        table { 
            width: 100%; 
            border-collapse: separate;
            border-spacing: 2px 2px; /* Espa√ßamento horizontal (2px) e vertical (2px) entre c√©lulas */
            table-layout: fixed;
            min-width: 800px; 
        }
        
        th { 
            background: #f8fafc; padding: 10px 12px; text-align: center; font-weight: 600; font-size: 0.85rem;
            color: var(--text-light); border-bottom: 1px solid var(--border);
            cursor: pointer; white-space: nowrap; user-select: none; position: sticky; top: 0; z-index: 10;
            position: relative; 
        }
        td:first-child {
            text-align: left;
        }
        th:hover { background: #f1f5f9; color: var(--primary); }
        
        /* Cores do cabe√ßalho por tipo de ciclo */
        th.ciclo-simples { background: #A6A6A6; color: #000; }
        th.ciclo-bi-diario { background: #A9D08E; color: #000; }
        th.ciclo-bi-semanal { background: #8EA9DB; color: #000; }
        th.ciclo-tri-diario { background: #BF8F00; color: #fff; }
        th.ciclo-tri-semanal { background: #C65911; color: #fff; }
        
        th.ciclo-simples:hover, 
        th.ciclo-bi-diario:hover, 
        th.ciclo-bi-semanal:hover { background: #8c8c8c; }
        th.ciclo-tri-diario:hover,
        th.ciclo-tri-semanal:hover { background: #a07600; }
        
        /* Larguras m√≠nimas uniformizadas */
        th:nth-child(2), td:nth-child(2) { min-width: 110px; } /* Total */
        th:nth-child(3), td:nth-child(3) { min-width: 140px; } /* Primeira energia */
        th:nth-child(4), td:nth-child(4) { min-width: 140px; } /* Segunda energia/Pot√™ncia */
        th:nth-child(5), td:nth-child(5) { min-width: 140px; } /* Terceira energia/Pot√™ncia */
        th:nth-child(6), td:nth-child(6) { min-width: 140px; } /* Quarta energia/Pot√™ncia */
        th:last-child, td:last-child { width: 85px; min-width: 85px; max-width: 85px; text-align: center; } /* Detalhes */
        
        .resizer {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 5px;
            background: rgba(0,0,0,0.05);
            cursor: col-resize;
            user-select: none;
        }
        
        .resizer:hover {
            background: var(--primary);
        }
        
        td { padding: 8px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; font-size: 0.88rem; }
        tr:hover { background: #f8fafc; }
        
        /* Largura inicial da coluna Tarif√°rio */
        th:first-child, td:first-child { 
            width: 28%; 
        }
        
        /* Molduras coloridas para c√©lulas de tarif√°rio */
        .cell-qh-diagrama { border: 2px solid #BDD7EE !important; background-color: #f0f7ff; border-radius: 10px; }
        .cell-qh-perfil   { border: 2px solid #4D79BC !important; background-color: #dce8f5; border-radius: 10px; } /* Azul ainda mais escuro para contraste */
        .cell-index-media { border: 2px solid #FFE699 !important; background-color: #fffdf5; border-radius: 10px; }
        .cell-fixo        { border: 2px solid #d0d0d0 !important; background-color: #ffffff; border-radius: 10px; } /* Branco puro */
        .cell-meu-tarif   { border: 2px solid #FF0000 !important; background-color: #fff5f5; border-radius: 10px; }
        .cell-perso       { border: 2px solid #92D050 !important; background-color: #f9fff2; border-radius: 10px; }
        
        .price-main { font-family: 'Roboto Mono', monospace; font-weight: 700; color: var(--success); font-size: 0.95rem; cursor: help; text-align: center; vertical-align: middle; }
        .price-sub { font-family: 'Roboto Mono', monospace; color: var(--text-light); font-size: 0.82rem; cursor: help; text-align: center; vertical-align: middle; }
        .tariff-name { cursor: help; color: var(--primary); font-weight: 600; }
        
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; display: inline-block; margin-right: 4px; letter-spacing: 0.05em; }
        .tag.qh-diagrama { background: #BDD7EE; color: #000; }
        .tag.qh-perfil   { background: #4D79BC; color: #fff; }
        .tag.index-media { background: #FFE699; color: #000; }
        .tag.fixo        { background: #d0d0d0; color: #000; }
        .tag.meu-tarif   { background: #FF0000; color: #fff; }
        .tag.perso       { background: #92D050; color: #fff; }
        
        .tooltip { 
            position: absolute; background: #1e293b; color: white; padding: 12px; border-radius: 8px; 
            font-size: 0.8rem; z-index: 1000; box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            max-width: 380px; pointer-events: none; line-height: 1.4;
        }
        .tooltip-line { display: flex; justify-content: space-between; margin: 3px 0; gap: 16px; }
        .tooltip-line.subtotal { border-top: 1px solid rgba(255,255,255,0.2); margin-top: 6px; padding-top: 6px; font-weight: 600; }
        .tooltip-line.total { border-top: 2px solid rgba(255,255,255,0.4); margin-top: 8px; padding-top: 8px; font-weight: 700; font-size: 0.9rem; }
        .tooltip-section { margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.15); }

        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        @media (max-width: 1200px) {
            body { padding: 0; font-size: 0.85rem; }
            .grid-container { grid-template-columns: 1fr; padding: 0 10px; }
            .sidebar { 
                position: fixed; top: 0; left: 0; width: 85vw; max-width: 360px; height: 100vh; max-height: 100vh;
                border-radius: 0; z-index: 1000; transform: translateX(-100%); 
                transition: transform 0.3s ease; box-shadow: none;
                overflow-y: auto;
            }
            .sidebar.open { transform: translateX(0); box-shadow: 4px 0 20px rgba(0,0,0,0.3); }
            .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 999; }
            .sidebar-overlay.active { display: block; }
            .sidebar-toggle { 
                display: flex; align-items: center; gap: 8px; background: var(--primary); color: white; 
                border: none; padding: 10px 16px; border-radius: 8px; font-size: 0.9rem; font-weight: 600;
                cursor: pointer; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            }
            .sidebar-toggle:active { transform: scale(0.97); }
            .sidebar-close { 
                display: flex; position: absolute; top: 12px; right: 12px; background: none; border: none; 
                font-size: 1.4rem; color: var(--text-light); cursor: pointer; padding: 4px 8px; z-index: 1001;
            }
            .filters-bar { padding: 10px; }
            .filter-item { min-width: 100%; }
            th, td { padding: 6px 8px; font-size: 0.8rem; }
            .tabs-container { margin-left: 10px; margin-right: 10px; }
            #tab-quick { padding: 0 10px; }
        }
        @media (min-width: 1201px) {
            .sidebar-toggle { display: none; }
            .sidebar-close { display: none; }
            .sidebar-overlay { display: none !important; }
        }
        
        /* === TABS CSS === */
        .tabs-container {
            max-width: 1900px;
            margin: 0 auto 20px auto;
        }
        
        .tabs-header {
            display: flex;
            gap: 0;
            background: var(--surface);
            border-radius: 12px 12px 0 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tab-button {
            flex: 1;
            padding: 16px 24px;
            background: #f1f5f9;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-button:hover {
            background: #e2e8f0;
            color: var(--text-main);
        }
        
        .tab-button.active {
            background: var(--surface);
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* === ABA 1 - SIMULA√á√ÉO R√ÅPIDA === */                
        .power-button:hover {
            border-color: var(--primary);
            background: #f0f9ff;
        }

        .quick-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 12px;
        }
        
        .quick-option:hover {
            border-color: var(--primary);
            background: #f0f9ff;
        }
        
        .quick-option input[type="radio"] {
            accent-color: white;
        }
        
        .collapsible-header {
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .collapsible-header:hover {
            background: #f1f5f9;
        }
        
        .collapsible-content {
            padding: 16px;
            background: #fafafa;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .collapsible-content.collapsed {
            display: none;
        }
        
        /* Regra gen√©rica para qualquer elemento com classe collapsed */
        .collapsed {
            display: none !important;
        }
        
        .provider-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }
        
        .provider-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }
        
        .provider-checkbox:hover {
            background: #f8fafc;
        }
        
        .simulate-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
        }
        
        .simulate-btn:hover {
            background: #0052a3;
            box-shadow: 0 4px 12px rgba(0,102,204,0.3);
        }
        
        .update-notice {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 8px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .podium-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin: 24px 0;
        }
        
        .podium-item {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .podium-item.first {
            order: 2;
            border: 3px solid #ffd700;
        }
        
        .podium-item.second {
            order: 1;
        }
        
        .podium-item.third {
            order: 3;
        }
        
        .podium-medal {
            font-size: 3rem;
            margin-bottom: 12px;
        }
        
        .podium-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        
        .podium-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Roboto Mono', monospace;
        }
        
        .podium-savings {
            color: var(--success);
            font-weight: 600;
            margin-top: 8px;
        }
        
        @media (max-width: 1200px) {
            .podium-container {
                grid-template-columns: 1fr;
            }
            .podium-item.first,
            .podium-item.second,
            .podium-item.third {
                order: initial;
            }
        }
        /* === TABS CSS === */
        .tabs-container {
            max-width: 1900px;
            margin: 0 auto 20px auto;
        }

        .tabs-header {
            display: flex;
            gap: 0;
            background: var(--surface);
            border-radius: 12px 12px 0 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab-button {
            flex: 1;
            padding: 12px 20px;
            background: #f1f5f9;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s;
        }

        .tab-button:hover {
            background: #e2e8f0;
            color: var(--text-main);
        }

        .tab-button.active {
            background: var(--surface);
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* === ABA 1 - SIMULA√á√ÉO R√ÅPIDA (COMPACTA) === */
        .quick-sim-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .quick-card {
            background: var(--surface);
            padding: 12px 16px; /* Compacto */
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 10px; /* Compacto */
        }

        .quick-title {
            font-size: 0.9rem; /* Compacto */
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .price-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .price-button, .power-button {
            padding: 8px; /* Compacto */
            background: #f8fafc;
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Roboto Mono', monospace;
            transition: all 0.2s;
            text-align: center;
            font-size: 0.85rem; /* Compacto */
        }

        .price-button.selected, .power-button.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .power-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(65px, 1fr)); /* Compacto */
            gap: 6px; /* Compacto */
        }

        .quick-option {
            padding: 10px 12px; /* Compacto */
            background: #f8fafc;
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem; /* Compacto */
        }

        .quick-option.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* P√≥dio */
        .podium-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 16px 0;
        }

        .podium-item {
            background: var(--surface);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .podium-item.first {
            order: 2;
            border: 3px solid #ffd700;
        }

        .podium-item.second { order: 1; }
        .podium-item.third { order: 3; }

        .podium-medal {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .podium-name {
            font-weight: 700;
            font-size: 0.95rem;
            margin-bottom: 6px;
        }

        .podium-price {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Roboto Mono', monospace;
        }

        @media (max-width: 1200px) {
            .podium-container {
                grid-template-columns: 1fr;
            }
            .podium-item.first,
            .podium-item.second,
            .podium-item.third {
                order: initial;
            }
        }
    </style>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [{
        "@type": "Question",
        "name": "De onde v√™m os dados dos tarif√°rios e dos pre√ßos de mercado (OMIE)?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Todos os dados dos tarif√°rios s√£o recolhidos a partir das informa√ß√µes p√∫blicas disponibilizadas pelos comercializadores nos seus websites. Os pre√ßos do mercado ib√©rico (OMIE) e os perfis de consumo da ERSE s√£o obtidos de fontes oficiais para garantir a m√°xima precis√£o nos c√°lculos dos tarif√°rios indexados. Os dados s√£o atualizados regularmente para refletir as condi√ß√µes atuais do mercado."
        }
      },{
        "@type": "Question",
        "name": "Alguns tarif√°rios t√™m custo na energia diferentes do que t√™m no seu site institucional, porqu√™?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Alguns comercializadores n√£o incluem o valor do financiamento da Tarifa Social de Eletricidade (TSE) no custo base da energia. Para que se possa comparar entre todos de forma igual, nesses casos junto o custo de financiamento da TSE ao custo base. Para confirmar, passe o rato por cima do valor da energia na tabela para ver a decomposi√ß√£o detalhada do pre√ßo."
        }
      },{
        "@type": "Question",
        "name": "Tenho um tarif√°rio com o mesmo nome que o do simulador, mas tem valores diferentes na energia e/ou pot√™ncia, porqu√™?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Muitos comercializadores alteram os valores nos seus tarif√°rios mas mant√™m as denomina√ß√µes dos mesmos. Este simulador s√≥ tem os valores para a √∫ltima vers√£o do tarif√°rio."
        }
      },{
        "@type": "Question",
        "name": "O simulador √© 100% preciso?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "O objetivo √© ser o mais preciso poss√≠vel. Para tarif√°rios fixos, a precis√£o √© muito elevada. Para tarif√°rios indexados, o custo final √© uma estimativa baseada em m√©dias e perfis de consumo. A forma mais rigorosa de simula√ß√£o √© sempre atrav√©s do carregamento do seu diagrama de carga da E-Redes, pois utiliza o seu perfil de consumo real (neste caso, apenas dados hist√≥ricos)."
        }
      },{
        "@type": "Question",
        "name": "Porque √© que o modo 'An√°lise Detalhada' com o ficheiro da E-Redes √© recomendado?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Este modo utiliza o seu consumo real registado a cada 15 minutos. Isto permite um c√°lculo exato do custo para qualquer tipo de tarif√°rio, incluindo os indexados quarto-hor√°rios (din√¢micos). Al√©m disso, s√≥ neste modo √© poss√≠vel fazer uma an√°lise precisa da sua pot√™ncia contratada e simular o impacto do autoconsumo com pain√©is solares fotovoltaicos."
        }
      },{
        "@type": "Question",
        "name": "Porque √© que a simula√ß√£o s√≥ est√° dispon√≠vel a partir de 01/01/2026?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "A simula√ß√£o est√° focada no ano de 2026 para garantir que os c√°lculos utilizam as Tarifas de Acesso √†s Redes (TAR) e outras taxas e impostos que est√£o em vigor. Utilizar dados de consumo de anos anteriores com as tarifas atuais poderia levar a resultados imprecisos, uma vez que as condi√ß√µes do mercado e a regula√ß√£o mudam anualmente. O simulador ignora automaticamente quaisquer dados anteriores a esta data para garantir a relev√¢ncia dos resultados."
        }
      },{
        "@type": "Question",
        "name": "Qual a diferen√ßa entre escolher um M√™s e um Per√≠odo de Datas manual?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Escolher um M√™s: √â a forma mais simples e r√°pida. O simulador seleciona automaticamente o primeiro e o √∫ltimo dia desse m√™s e usa o n√∫mero de dias correto. Selecionar Datas: Oferece total flexibilidade para analisar um per√≠odo espec√≠fico (ex: uma semana, uma quinzena). O n√∫mero de dias √© calculado com base no intervalo que definir."
        }
      },{
        "@type": "Question",
        "name": "Como s√£o tratados os fins de semana e feriados nos ciclos Bi e Tri-Hor√°rio?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "O simulador utiliza os ciclos hor√°rios oficiais definidos pela ERSE. Nos Ciclos Semanais (ex: Bi-Hor√°rio Semanal), os fins de semana t√™m um tratamento espec√≠fico, geralmente com mais horas a contar como 'Vazio'. Nos Ciclos Di√°rios, a contagem das horas √© a mesma para todos os dias da semana. Os feriados n√£o t√™m regras especificas em BTN, sendo tratados como dias 'normais'. O simulador aplica estas regras automaticamente com base nos dados oficiais."
        }
      },{
        "@type": "Question",
        "name": "O que significa a op√ß√£o 'Comparar custos entre diferentes Op√ß√µes Hor√°rias'?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Ao ativar esta op√ß√£o, o simulador recalcula o custo de cada tarif√°rio para diferentes ciclos hor√°rios (Simples, Bi-Hor√°rio, etc.), assumindo os mesmos consumos totais que inseriu. Isto √© √∫til para perceber se, com o seu padr√£o de consumo atual, compensaria mudar de op√ß√£o hor√°ria."
        }
      },{
        "@type": "Question",
        "name": "Como funciona a sec√ß√£o 'O Meu Tarif√°rio'?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Esta sec√ß√£o permite-lhe introduzir os pre√ßos da sua fatura atual (energia em ‚Ç¨/kWh e pot√™ncia em ‚Ç¨/dia) para comparar diretamente com todas as outras ofertas do mercado. √â fundamental verificar na sua fatura se os pre√ßos que insere j√° incluem as TAR (Tarifas de Acesso √†s Redes) para que a compara√ß√£o seja correta."
        }
      },{
        "@type": "Question",
        "name": "Para que serve a sec√ß√£o 'Comparar outro Tarif√°rio Personalizado?'",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Esta funcionalidade √© uma ferramenta poderosa para criar cen√°rios hipot√©ticos. Permite-lhe construir at√© tr√™s estruturas tarif√°rias com os seus pr√≥prios pre√ßos. √â ideal para simular uma oferta que recebeu, perceber qual seria o custo se o seu comercializador oferecesse uma op√ß√£o hor√°ria diferente, ou testar o impacto de futuras subidas ou descidas de pre√ßos."
        }
      },{
        "@type": "Question",
        "name": "Como funciona a simula√ß√£o de Autoconsumo com pain√©is solares fotovoltaicos?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Ao ativar esta op√ß√£o (dispon√≠vel no modo de diagrama de carga), o simulador estima a produ√ß√£o de energia de um sistema fotovoltaico com base na pot√™ncia, localiza√ß√£o e orienta√ß√£o que definir. Essa produ√ß√£o √© depois subtra√≠da do seu consumo a cada 15 minutos. O resultado √© um novo perfil de 'consumo da rede', que mostra quanta energia realmente precisou de comprar. Os c√°lculos dos tarif√°rios podem ent√£o ser feitos com base neste novo consumo, mostrando a poupan√ßa real que o autoconsumo pode gerar."
        }
      },{
        "@type": "Question",
        "name": "A simula√ß√£o de autoconsumo tem em conta os dias de chuva ou de sol?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "A simula√ß√£o utiliza perfis de produ√ß√£o solar m√©dios mensais para cada distrito, baseados em dados hist√≥ricos do PVGIS. Isto significa que a produ√ß√£o estimada para um dia de Julho, por exemplo, representa um 'dia m√©dio' de Julho, j√° tendo em conta a m√©dia de horas de sol e de nebulosidade para esse m√™s nessa regi√£o. N√£o simula a produ√ß√£o para um dia espec√≠fico com as suas condi√ß√µes meteorol√≥gicas reais, mas oferece uma estimativa muito realista para um per√≠odo de an√°lise mais longo."
        }
      },{
        "@type": "Question",
        "name": "Os valores OMIE para datas futuras s√£o reais?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "N√£o. Os valores OMIE apresentados para datas futuras baseiam-se nos pre√ßos do mercado de futuros (OMIP). Estes valores representam a expectativa do mercado para os pre√ßos da eletricidade, mas n√£o s√£o uma garantia. Servem como a melhor estimativa dispon√≠vel para simular custos em tarif√°rios indexados para per√≠odos que ainda n√£o ocorreram. A data de atualiza√ß√£o destes valores est√° indicada no final da p√°gina."
        }
      },{
        "@type": "Question",
        "name": "Como s√£o tratados descontos especiais como os do ACP ou Continente?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "O simulador tenta replicar as condi√ß√µes comerciais o mais fielmente poss√≠vel. Para a parceria Goldenergy/ACP, pode optar por incluir o valor da quota mensal no custo final. Para os tarif√°rios Galp/Continente, o simulador calcula o valor do desconto em Cart√£o Continente e subtrai-o ao custo total, refletindo a poupan√ßa real na sua carteira. Pode ativar ou desativar estas op√ß√µes na sec√ß√£o 'Op√ß√µes Adicionais de Simula√ß√£o'."
        }
      },{
        "@type": "Question",
        "name": "O que s√£o as colunas 'Custo com o seu Perfil Real (‚Ç¨)' e 'Custo com Perfil Padr√£o ERSE (‚Ç¨)'?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Esta an√°lise, dispon√≠vel no modo de diagrama de carga, compara duas coisas: o custo exato do seu consumo (Perfil Real) e o custo que teria se o seu consumo seguisse um perfil m√©dio definido pela ERSE (Perfil Padr√£o). Uma diferen√ßa negativa (a verde) significa que o seu padr√£o de consumo pessoal √© mais econ√≥mico que a m√©dia, o que √© √≥timo!"
        }
      },{
        "@type": "Question",
        "name": "O que est√° inclu√≠do no 'Total (‚Ç¨)'? √â o valor final da fatura?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Sim, o valor 'Total (‚Ç¨)' representa a sua fatura final estimada. Ele inclui o Custo da Energia, Custo da Pot√™ncia, Taxas e Impostos (CAV, DGEG, IEC), IVA aplicado conforme as regras, e quaisquer Descontos ou Acr√©scimos. Pode ver a decomposi√ß√£o detalhada de todos estes custos passando o rato por cima do valor na coluna 'Total (‚Ç¨)'."
        }
      },{
        "@type": "Question",
        "name": "A tabela de resultados tem muitas op√ß√µes. Como posso encontrar rapidamente o que procuro?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "A tabela √© interativa! Pode: Ordenar (clique no cabe√ßalho de qualquer coluna), Filtrar (use os filtros no topo da tabela para refinar a sua pesquisa), e Pesquisar (na vista detalhada, pode usar a pesquisa dentro das colunas 'Comercializador' e 'Tarif√°rio')."
        }
      },{
        "@type": "Question",
        "name": "O que √© um tarif√°rio indexado? √â uma boa op√ß√£o para mim?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Um tarif√°rio indexado tem um pre√ßo de energia que varia de acordo com o pre√ßo do mercado grossista (OMIE). Este tipo de tarif√°rio pode oferecer uma poupan√ßa significativa quando os pre√ßos de mercado est√£o baixos, mas tamb√©m implica um risco maior se os pre√ßos subirem. Pode ser 'Indexado √† M√©dia' ou 'Indexado Quarto-Hor√°rio (Din√¢mico)'. S√£o ideais para quem consegue adaptar o seu consumo √†s horas mais baratas do dia."
        }
      },{
        "@type": "Question",
        "name": "O que s√£o as TAR (Tarifas de Acesso √†s Redes)?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "As TAR s√£o tarifas reguladas pela ERSE que pagam pelo uso das infraestruturas el√©tricas (transporte e distribui√ß√£o). Todos os consumidores as pagam, independentemente do comercializador. O simulador lida com ambas as situa√ß√µes para garantir uma compara√ß√£o justa."
        }
      },{
        "@type": "Question",
        "name": "O que significa 'Perfil de Consumo' (ex: Perfil A, B, C)?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "A ERSE agrupa os consumidores em perfis (A, B ou C) com base no seu consumo anual e pot√™ncia, representando um padr√£o de consumo m√©dio. No Modo Manual, o simulador usa estes perfis para estimar o custo dos tarif√°rios indexados. No Modo Diagrama, este perfil n√£o √© necess√°rio, pois o simulador usa os seus dados de consumo reais."
        }
      },{
        "@type": "Question",
        "name": "Porque √© que o simulador pergunta se a minha instala√ß√£o √© trif√°sica?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "O ficheiro da E-Redes regista a pot√™ncia total da sua casa em m√©dias de 15 minutos. Numa instala√ß√£o trif√°sica, o consumo total pode distribuir-se pelas tr√™s fases. √â poss√≠vel que uma √∫nica fase tenha um pico de consumo muito elevado num curto espa√ßo de tempo, fazendo o disjuntor disparar, mesmo que a pot√™ncia total m√©dia nesses 15 minutos n√£o ultrapasse o valor contratado."
        }
      },{
        "@type": "Question",
        "name": "Como sei se a minha instala√ß√£o √© monof√°sica ou trif√°sica?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Geralmente, instala√ß√µes dom√©sticas com pot√™ncias contratadas at√© 6.9 kVA s√£o monof√°sicas. Pot√™ncias superiores s√£o quase sempre trif√°sicas. Esta informa√ß√£o est√° dispon√≠vel no seu contador ou no balc√£o digital da E-Redes. A an√°lise de pot√™ncia m√°xima no simulador tem em conta esta diferen√ßa."
        }
      }]
    }
    </script>
</head>
<body>
<header>
    <div class="header-content">
        <div class="header-title-container">
            <a href="index.html">
                <img src="images/Logo_Tiago_Felicia.png" alt="Log√≥tipo Tiago Fel√≠cia - P√°gina Inicial" class="logo">
            </a>
            <div class="brand-name">Tiago Fel√≠cia</div>
        </div>
        <p>Simuladores de tarif√°rios de Eletricidade, G√°s Natural e Autoconsumo</p>
    </div>
</header>

<div id="menu-placeholder"></div>

<main style="max-width: 1900px; margin: 0 auto;">

    <div id="loader" style="text-align:center; padding:60px 20px;">
        <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 2.5rem; color: var(--primary); margin-bottom: 16px;"></i>
        <p id="loader-msg" style="color: var(--text-light); font-size: 0.95rem; margin-top: 12px;"></p> <!-- === A carregar tarif√°rios... === -->
    </div>

    <!-- === LOGO E T√çTULO DO SIMULADOR === -->
    <div id="simulador-header" style="padding: 30px 20px 20px 20px;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 16px;">
            <img src="https://huggingface.co/spaces/tiagofelicia/simulador-tarifarios-eletricidade/resolve/main/Logo_Tiago_Felicia.png" 
                 alt="Logo Tiago Fel√≠cia" 
                 style="width: 120px; height: auto; flex-shrink: 0;">
            <h1>
                üîå Simulador de Tarif√°rios de Eletricidade 2026 em Portugal | Tiago Fel√≠cia
            </h1>
        </div>
        <p>
            Bem-vindo ao simulador de eletricidade mais completo de Portugal üòä. Com esta ferramenta pode comparar tarif√°rios de eletricidade, fixos e indexados, para encontrar a op√ß√£o mais econ√≥mica para si. Descubra quanto pode poupar na sua fatura da luz, quer use a Simula√ß√£o Completa ou carregue o seu ficheiro de consumo da E-Redes para uma An√°lise Avan√ßada.
        </p>
    </div>

    <!-- === TABS === -->
    <div id="tabs-wrapper" class="tabs-container hidden">
        <div class="tabs-header">
            <button class="tab-button active" onclick="switchTab('quick')">
                ‚ö° Simula√ß√£o R√°pida
            </button>
            <button class="tab-button" onclick="switchTab('complete')">
                üìù Simula√ß√£o Completa
            </button>
            <button class="tab-button" onclick="switchTab('advanced')">
                üìä An√°lise Avan√ßada (E-Redes)
            </button>
            <button class="tab-button" onclick="switchTab('faq')">
                ‚ùì FAQ
            </button>
        </div>
    </div>

    <!-- === √ÅREA DE UPLOAD CENTRAL ABA 3 (E-REDES) === -->
    <div id="eredes-upload-central" class="hidden" style="max-width: 800px; margin: 40px auto; padding: 20px;">
        <div style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); padding: 32px; border-radius: 16px; box-shadow: 0 8px 32px rgba(14, 165, 233, 0.3); text-align: center; color: white;">
            <div style="margin-bottom: 24px;">
                <i class="fa-solid fa-chart-line" style="font-size: 4rem; opacity: 0.9;"></i>
            </div>
            <h1 style="margin: 0 0 12px 0; font-size: 2rem;">üìä An√°lise Avan√ßada</h1>
            <p style="margin: 0 0 24px 0; opacity: 0.9; font-size: 1.1rem;">
                Carregue o(s) seu(s) ficheiro(s) de consumo da E-Redes para uma an√°lise detalhada hora-a-hora
            </p>
        </div>
        
        <div style="background: white; padding: 32px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: -20px; border: 2px dashed #0ea5e9;">
            <div style="text-align: center;">
                <label style="display: block; cursor: pointer; padding: 40px 20px; border-radius: 12px; background: #f0f9ff; transition: all 0.3s;" 
                       onmouseover="this.style.background='#e0f2fe'" onmouseout="this.style.background='#f0f9ff'">
                    <i class="fa-solid fa-cloud-arrow-up" style="font-size: 3rem; color: #0ea5e9; margin-bottom: 16px; display: block;"></i>
                    <span style="font-size: 1.2rem; font-weight: 600; color: #0369a1; display: block; margin-bottom: 8px;">
                        Clique para selecionar ficheiro(s)
                    </span>
                    <span style="font-size: 0.9rem; color: #64748b;">
                        Formato Excel (.xlsx ou .xls) exportado da E-Redes
                    </span>
                    <input type="file" id="file-eredes-central" accept=".xlsx,.xls" multiple style="display: none;" onchange="processarFicheirosERedesCentral()">
                </label>
                
                <div id="eredes-status-central" style="margin-top: 16px; font-size: 0.9rem; color: #64748b;"></div>
            </div>
            
            <div style="margin-top: 24px; padding: 16px; background: #fef3c7; border: 1px solid #fde047; border-radius: 8px;">
                <h4 style="margin: 0 0 8px 0; color: #92400e; font-size: 0.95rem;">
                    <i class="fa-solid fa-lightbulb"></i> Como obter o ficheiro da E-Redes?
                </h4>
                <ol style="margin: 0; padding-left: 20px; color: #78350f; font-size: 0.85rem; line-height: 1.6;">
                    <li>Aceda a <a href="https://balcaodigital.e-redes.pt/consumptions/history" target="_blank" style="color: #0369a1;">balcaodigital.e-redes.pt</a></li>
                    <li>V√° a "Consumos" ‚Üí "Consultar consumos detalhados"</li>
                    <li>Selecione o per√≠odo desejado e exporte para Excel</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- === ABA 1: SIMULA√á√ÉO R√ÅPIDA === -->
    <div id="tab-quick" class="tab-content active hidden">
        <div class="quick-sim-container">
            
            <!-- Cabe√ßalho -->
            <div class="quick-card" style="background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%); color: white; text-align: center; padding: 16px;">
                <h1 style="margin: 0 0 4px 0; font-size: 1.5rem; color: white !important;">‚ö° Simula√ß√£o R√°pida</h1>
                <p style="margin: 0; opacity: 0.9; font-size: 0.85rem;">Descubra quanto pode poupar em segundos</p>
            </div>

            <!-- 1. PRE√áO -->
            <div class="quick-card">
                <div class="quick-title">üí∂ Quanto paga por m√™s?</div>
                <div class="price-grid">
                    <div class="price-button selected" onclick="selectPrice(40)" id="price-40">
                        <div style="font-size: 1.2rem;">40‚Ç¨</div>
                        <div style="font-size: 0.65rem; opacity: 0.7;">~158 kWh | 3.45 kVA</div>
                    </div>
                    <div class="price-button" onclick="selectPrice(100)" id="price-100">
                        <div style="font-size: 1.2rem;">100‚Ç¨</div>
                        <div style="font-size: 0.65rem; opacity: 0.7;">~333 kWh | 6.90 kVA</div>
                    </div>
                    <div class="price-button" onclick="selectPrice(200)" id="price-200">
                        <div style="font-size: 1.2rem;">200‚Ç¨</div>
                        <div style="font-size: 0.65rem; opacity: 0.7;">~908 kWh | 13.80 kVA</div>
                    </div>
                </div>
                
                <p style="text-align: center; color: var(--text-light); margin: 10px 0 8px 0; font-size: 0.85rem;">ou</p>
                
                <div class="quick-title">‚ö° Quanto consome por m√™s?</div>
                <input type="number" id="quick-kwh" placeholder="158" value="158" 
                       oninput="autoCalculate()" 
                       style="width: 100%; font-size: 1rem; text-align: center; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                <div style="text-align: center; margin-top: 4px; color: var(--text-light); font-size: 0.75rem;">kWh/m√™s</div>
            </div>

            <!-- 2. POT√äNCIA -->
            <div class="quick-card">
                <div class="quick-title">‚ö° Qual √© a sua pot√™ncia contratada?</div>
                <div class="power-grid">
                    <div class="power-button" onclick="selectPower(1.15)">1.15</div>
                    <div class="power-button" onclick="selectPower(2.30)">2.30</div>
                    <div class="power-button selected" onclick="selectPower(3.45)" id="power-default">3.45</div>
                    <div class="power-button" onclick="selectPower(4.60)">4.60</div>
                    <div class="power-button" onclick="selectPower(5.75)">5.75</div>
                    <div class="power-button" onclick="selectPower(6.90)">6.90</div>
                    <div class="power-button" onclick="selectPower(10.35)">10.35</div>
                    <div class="power-button" onclick="selectPower(13.80)">13.80</div>
                    <div class="power-button" onclick="selectPower(17.25)">17.25</div>
                    <div class="power-button" onclick="selectPower(20.70)">20.70</div>
                </div>
                <div style="text-align: center; margin-top: 4px; color: var(--text-light); font-size: 0.75rem;">kVA</div>
            </div>

            <!-- 3. PERFIL -->
            <div class="quick-card">
                <div class="quick-title">üïê Como utiliza mais eletricidade?</div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div class="quick-option selected" onclick="selectUsagePattern('balanced')" id="usage-balanced">
                        <input type="radio" name="usage" checked> N√£o adapto o consumo aos hor√°rios
                    </div>
                    <div class="quick-option" onclick="selectUsagePattern('night')" id="usage-night">
                        <input type="radio" name="usage"> Maior consumo √† noite (ap√≥s as 22h)
                    </div>
                </div>
            </div>

            <!-- 4. TIPO -->
            <div class="quick-card">
                <div class="quick-title">üéØ O que procura?</div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div class="quick-option selected" onclick="selectTariffType('all')" id="tariff-all">
                        <input type="radio" name="tariff-type" checked> A mais barata agora (Todas as op√ß√µes)
                    </div>
                    <div class="quick-option" onclick="selectTariffType('fixed')" id="tariff-fixed">
                        <input type="radio" name="tariff-type"> S√≥ Pre√ßo Fixo (Sem oscila√ß√µes)
                    </div>
                </div>
            </div>

            <!-- 5. AJUSTES -->
            <div class="quick-card">
                <div style="cursor: pointer; padding: 8px; background: #f1f5f9; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;" onclick="toggleQuickSettings()">
                    <span style="font-weight: 600; font-size: 0.9rem;">‚öôÔ∏è Ajustes r√°pidos</span>
                    <i class="fa-solid fa-chevron-down" id="quick-settings-icon"></i>
                </div>
                <div class="hidden" id="quick-settings-content" style="margin-top: 10px;">
                    <div style="margin-bottom: 12px;">
                        <label style="font-weight: 600; margin-bottom: 6px; display: block; font-size: 0.85rem;">Prefere:</label>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <div class="quick-option selected" onclick="selectCycle('simples')" id="cycle-simples">
                                <input type="radio" name="cycle" checked> Tarifa simples
                            </div>
                            <div class="quick-option" onclick="selectCycle('bi')" id="cycle-bi">
                                <input type="radio" name="cycle"> Bi-hor√°rio
                            </div>
                            <div class="quick-option" onclick="selectCycle('tri')" id="cycle-tri">
                                <input type="radio" name="cycle"> Tri-hor√°rio
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label style="font-weight: 600; margin-bottom: 6px; display: block; font-size: 0.85rem;">N√£o mostrar estes comercializadores:</label>
                        <div id="provider-filters" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; font-size: 0.8rem;">
                            <!-- Preenchido dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- RESULTADOS - P√ìDIO -->
            <div id="quick-results" style="display: block;">
                <div class="quick-card">
                    <h2 style="text-align: center; margin-bottom: 16px; font-size: 1.2rem;">
                        üèÜ Melhores Solu√ß√µes
                    </h2>
                    <div class="podium-container" id="podium">
                        <div class="podium-item" style="opacity: 0.3;">
                            <div class="podium-medal">ü•á</div>
                            <div class="podium-name">...</div>
                            <div class="podium-price">-</div>
                        </div>
                        <div class="podium-item" style="opacity: 0.3;">
                            <div class="podium-medal">ü•à</div>
                            <div class="podium-name">...</div>
                            <div class="podium-price">-</div>
                        </div>
                        <div class="podium-item" style="opacity: 0.3;">
                            <div class="podium-medal">ü•â</div>
                            <div class="podium-name">...</div>
                            <div class="podium-price">-</div>
                        </div>
                    </div>
                    
                    <p style="text-align: center; color: var(--text-light); margin: 12px 0 8px 0; font-size: 0.85rem;">
                        Quer ver mais detalhes ou todos os comercializadores?
                    </p>
                    <button style="width: 100%; padding: 12px; background: white; border: 2px solid var(--primary); color: var(--primary); border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem;" onclick="switchTab('complete')">
                        üìã Ver Tabela Completa
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- === ABA 2 & 3: SIMULA√á√ÉO COMPLETA E AN√ÅLISE AVAN√áADA === -->
    <div id="app" class="grid-container hidden">
        
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
        <div class="sidebar" id="sidebar-panel">
            <button class="sidebar-close" onclick="toggleSidebar()" aria-label="Fechar">&times;</button>
            <h2 style="color:var(--primary); margin-top:0; font-size:1.4rem; display:flex; align-items:center; gap:10px;">
                <i class="fa-solid fa-bolt"></i> Simulador Tiago Fel√≠cia <span style="font-size:0.4em; background:var(--text-main); color:white; padding:2px 4px; border-radius:4px;">v2</span>
            </h2>
            
            <div class="section-title" onclick="toggleSection('contrato')">Contrato <i class="fa-solid fa-chevron-down" id="icon-contrato"></i></div>
            <div class="section-content" id="content-contrato">
                <div class="input-group">
                    <label>
                        Pot√™ncia Contratada
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Pot√™ncia Contratada', 'Pot√™ncias BTN (1.15 kVA a 41.4 kVA)')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                    <select id="potencia" onchange="atualizarMenusCiclo(); autoCollapse('contrato')">
                        <option value="1.15">1.15 kVA</option><option value="2.3">2.30 kVA</option>
                        <option value="3.45" selected>3.45 kVA</option><option value="4.6">4.60 kVA</option>
                        <option value="5.75">5.75 kVA</option><option value="6.9">6.90 kVA</option>
                        <option value="10.35">10.35 kVA</option><option value="13.8">13.80 kVA</option>
                        <option value="17.25">17.25 kVA</option><option value="20.7">20.70 kVA</option>
                        <option value="27.6">27.60 kVA</option><option value="34.5">34.50 kVA</option>
                        <option value="41.4">41.40 kVA</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>
                            Op√ß√£o Hor√°ria
                            <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                            onmouseenter="showTooltipNome(event, 'Op√ß√£o Hor√°ria', 'Op√ß√£o hor√°ria contratada')" 
                            onmouseleave="hideTooltip()"></i>
                    </label>
                    <select id="ciclo" onchange="construirInputsConsumo(); autoCollapse('contrato')"></select>
                </div>
            </div>

            <div class="section-title" onclick="toggleSection('consumo')">Consumo <span class="label-units">(kWh)</span> <i class="fa-solid fa-chevron-down" id="icon-consumo"></i></div>
            <div class="section-content" id="content-consumo"></div>

            <div id="eredes-section-wrapper">
                <div class="section-title" onclick="toggleSection('eredes')">Diagrama de Cargas E-Redes <i class="fa-solid fa-chevron-right" id="icon-eredes"></i></div>
                <div class="section-content collapsed" id="content-eredes">
                <!-- √Årea de Upload (vis√≠vel inicialmente) -->
                <div id="eredes-upload" style="background:#e0f2fe; border:1px solid #0ea5e9; padding:12px; border-radius:8px; margin-bottom:12px;">
                    <div style="font-size:0.85rem; margin-bottom:8px; font-weight:600; color:#0369a1;">
                        <i class="fa-solid fa-file-excel"></i> Upload Ficheiro(s) Excel
                    </div>
                    <input type="file" id="file-eredes" accept=".xlsx,.xls" multiple style="font-size:0.8rem; padding:6px;" onchange="processarFicheirosERedes()">
                    <div id="eredes-status" style="margin-top:8px; font-size:0.75rem; color:#64748b;"></div>
                    <div id="eredes-info" style="margin-top:8px; font-size:0.75rem; background:#fef3c7; border:1px solid #fde047; padding:6px; border-radius:4px; display:none;"></div>
                </div>
                
                <!-- √Årea de Limpar (oculta inicialmente) -->
                <div id="eredes-limpar" style="display:none; background:#d1fae5; border:1px solid #10b981; padding:12px; border-radius:8px; margin-bottom:12px;">
                    <div style="font-size:0.85rem; margin-bottom:8px; font-weight:600; color:#059669;">
                        <i class="fa-solid fa-check-circle"></i> Ficheiro(s) Processado(s)
                    </div>
                    <div id="eredes-resumo" style="font-size:0.75rem; margin-bottom:8px; color:#064e3b;"></div>
                    <button onclick="limparDadosERedes()" style="width:100%; padding:8px; background:#dc2626; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">
                        <i class="fa-solid fa-trash"></i> Limpar Dados e Reiniciar
                    </button>
                </div>
                
                <div style="font-size:0.7rem; color:var(--text-light); line-height:1.4;">
                    ‚ÑπÔ∏è Carregue ficheiros de consumos da E-Redes (formato Excel). Os consumos ser√£o calculados automaticamente hora-a-hora.
                </div>
            </div>
            </div> <!-- Fim eredes-section-wrapper -->

            <div class="section-title" onclick="toggleSection('meu')">O Meu Tarif√°rio <i class="fa-solid fa-chevron-right" id="icon-meu"></i></div>
            <div class="section-content collapsed" id="content-meu">
                <div class="custom-tariff">
                    <div class="input-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="meu_ativo" onchange="toggleMeuTarifario()"> Ativar compara√ß√£o
                            <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                            onmouseenter="showTooltipNome(event, 'O Meu Tarif√°rio', 'Para preencher os valores de acordo com o seu tarif√°rio, ou com outro qualquer que queira comparar. Aten√ß√£o √†s notas sobre as TAR e TSE.')" 
                            onmouseleave="hideTooltip()"></i>
                        </label>
                    </div>
                    <div id="meu-inputs" class="hidden" style="margin-top:8px;"></div>
                </div>
            </div>

            <div class="section-title" onclick="toggleSection('personalizado')">Tarif√°rio Personalizado <i class="fa-solid fa-chevron-right" id="icon-personalizado"></i></div>
            <div class="section-content collapsed" id="content-personalizado">
                <div class="custom-tariff">
                    <div class="input-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="pers_ativo" onchange="toggleTarifarioPersonalizado()"> Ativar compara√ß√£o
                            <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                            onmouseenter="showTooltipNome(event, 'Tarif√°rio Personalizado', 'Crie tarif√°rio personalizado para comparar com os seus consumos. Ideal para comparar diferentes op√ß√µes tarif√°rias/hor√°rias. N√£o permite descontos e acr√©scimos que existem em O Meu Tarif√°rio.')" 
                            onmouseleave="hideTooltip()"></i>
                        </label>
                    </div>
                    <small style="color:var(--text-light); display:block; margin-top:4px; font-size:0.7rem;">
                        Ideal para comparar diferentes op√ß√µes tarif√°rias/hor√°rias. N√£o permite descontos e acr√©scimos.
                    </small>
                    <div id="pers-inputs" class="hidden" style="margin-top:12px;">
                    </div>
                </div>
            </div>

            <div class="section-title" onclick="toggleSection('comparacao')">Modo de Compara√ß√£o <i class="fa-solid fa-chevron-right" id="icon-comparacao"></i></div>
            <div class="section-content collapsed" id="content-comparacao">
                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="modo_comparacao" onchange="calcular()"> Comparar Op√ß√µes Hor√°rias
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Modo Compara√ß√£o', 'Ative para ver uma tabela que compara o custo de cada tarif√°rio em diferentes op√ß√µes hor√°rias (Simples, Bi-Hor√°rio, Tri-Hor√°rio), usando os seus consumos inseridos. Ir√° desativar a tabela detalhada.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                </div>
                <small style="color:var(--text-light); display:block; margin-top:4px; font-size:0.7rem;">
                    Compare o custo de cada tarif√°rio em diferentes op√ß√µes hor√°rias (Simples, Bi-Hor√°rio, Tri-Hor√°rio) usando os seus consumos.
                </small>
            </div>

            <div class="section-title" onclick="toggleSection('beneficios')">Benef√≠cios Sociais <i class="fa-solid fa-chevron-right" id="icon-beneficios"></i></div>
            <div class="section-content collapsed" id="content-beneficios">
                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="familia_numerosa" onchange="calcular()"> Fam√≠lia Numerosa
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Fam√≠lia Numerosa', '300 kWh com IVA a 6% (em vez dos normais 200 kWh) para pot√™ncias at√© 6.9 kVA.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                    <small style="color:var(--text-light); margin-left:22px; display:block; font-size:0.75rem;">Limite IVA 6%: 300 <span class="label-units">kWh</span> (‚â§6.9 <span class="label-units">kVA</span>)</small>
                </div>
                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="tarifa_social" onchange="calcular()"> Tarifa Social
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Tarifa Social', 'S√≥ pode ter Tarifa Social para pot√™ncias at√© 6.9 kVA.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                    <small style="color:var(--text-light); margin-left:22px; display:block; font-size:0.75rem;">Descontos TAR (‚â§6.9 <span class="label-units">kVA</span>)</small>
                </div>
            </div>

            <div class="section-title" onclick="toggleSection('opcoes')">Op√ß√µes Adicionais <i class="fa-solid fa-chevron-right" id="icon-opcoes"></i></div>
            <div class="section-content collapsed" id="content-opcoes">
                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="ocultar_edp_h" checked onchange="calcular()"> Ocultar EDP Hor√°ria
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Ocultar EDP Hor√°ria', 'Este tarif√°rio n√£o √© calculado por perfil. Quando contratado e a EDP n√£o recebe os diagramas de carga da E-Redes, √© aplicado o c√°lculo pelo EDP M√©dia.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                </div>
                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="quota_acp" checked onchange="calcular()"> Incluir Quota ACP
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Incluir Quota ACP', 'Incluir o valor da quota do ACP (4,90 ‚Ç¨/m√™s) no valor do tarif√°rio da parceria GE/ACP.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="input-group">
                        <label>
                            CAV <span class="label-units">(‚Ç¨/m√™s)</span>
                            <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                                    onmouseenter="showTooltipNome(event, 'Contribui√ß√£o Audiovisual', 'Contribui√ß√£o Audiovisual (CAV) - Verifique qual o valor cobrado na sua fatura. O valor normal √© de 2,85 ‚Ç¨/m√™s. Ser√° 1 ‚Ç¨/m√™s, para alguns casos de Tarifa Social (1¬∫ escal√£o de abono...) Ser√° 0 ‚Ç¨/m√™s, para consumo inferior a 400 kWh/ano.')" 
                                    onmouseleave="hideTooltip()"></i>
                            </label>
                        <input type="number" id="cav_valor" value="2.85" step="0.01" oninput="calcular()">
                    </div>
                    <div class="input-group">
                        <label>
                            DGEG<span class="label-units">(‚Ç¨/m√™s)</span>
                            <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                            onmouseenter="showTooltipNome(event, 'DGEG', 'Taxa de Explora√ß√£o da Dire√ß√£o-Geral de Energia e Geologia - Verifique qual o valor cobrado na sua fatura. Em condi√ß√µes normais, para contratos dom√©sticos o valor √© de 0,07 ‚Ç¨/m√™s e os n√£o dom√©sticos t√™m o valor de 0,35 ‚Ç¨/m√™s.')" 
                            onmouseleave="hideTooltip()"></i>
                        </label>
                        <input type="number" id="dgeg_valor" value="0.07" step="0.01" oninput="calcular()">
                    </div>
                </div>
            </div>

            <div class="section-title" onclick="toggleSection('datas')">Datas de Fatura√ß√£o <i class="fa-solid fa-chevron-right" id="icon-datas"></i></div>
            <div class="section-content collapsed" id="content-datas">
                <div class="input-group">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                        <div>
                            <label>
                                In√≠cio
                                <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                                onmouseenter="showTooltipNome(event, 'Data Inicial', 'A partir de 01/01/2025. Se n√£o modificar a data, ser√° calculado a partir do dia seguinte ao atual.')" 
                                onmouseleave="hideTooltip()"></i>
                            </label><input type="date" id="d_inicio" value="2025-01-01" min="2025-01-01" max="2026-12-31" onchange="atualizarDias()"></div>
                        <div>
                            <label>
                                Fim
                                <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                                onmouseenter="showTooltipNome(event, 'Data Final', 'De Data Inicial a 31/12/2026. Se n√£o modificar as datas, ser√° calculado at√© um m√™s ap√≥s a data inicial.')" 
                                onmouseleave="hideTooltip()"></i>
                            </label><input type="date" id="d_fim" value="2025-12-31" min="2025-01-01" max="2026-12-31" onchange="atualizarDias()"></div>
                    </div>
                </div>
                <div class="input-group">
                    <label>Dias de Fatura√ß√£o</label>
                    <input type="number" id="num_dias" readonly style="background:#f1f5f9; font-weight:bold;">
                </div>
            </div>

            <div id="omie-panel" class="omie-box hidden">
                <div style="font-size:0.75rem; text-transform:uppercase; font-weight:700; color:#9a3412; margin-bottom:6px;">
                    <i class="fa-solid fa-chart-line"></i> <span id="omie-label-titulo">M√©dia OMIE / OMIP</span><span class="label-units">(‚Ç¨/MWh)</span>
                    <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                    onmouseenter="showTooltipNome(event, 'M√©dia OMIE / OMIP', 'Se escolher datas passadas, ser√£o m√©dias finais do OMIE. Se escolher datas futuras, ser√£o m√©dias dos futuros OMIP, que podem n√£o concretizar-se no OMIE. Estas m√©dias s√£o atualizadas diariamente e s√£o usadas para calcular os tarif√°rios indexados.')" 
                    onmouseleave="hideTooltip()"></i></label></div>
                <div id="omie-display" style="font-size:0.85rem; margin-bottom:8px; font-family: 'Roboto Mono', monospace;"></div>
                <div id="omie-inputs" class="omie-editable"></div>
                <div style="font-size:0.7rem; color:var(--text-light); margin-top:4px;">*Edi√ß√£o manual fixa o valor para todo o c√°lculo.</div>
            </div>
        </div>

        <div class="main-content">
            <button class="sidebar-toggle" id="sidebar-toggle-btn" onclick="toggleSidebar()"><i class="fa-solid fa-sliders"></i> Par√¢metros</button>
            
            <div class="filters-bar">
                <div class="filter-item">
                    <label>Segmento
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Segmento', 'Escolha o segmento para a simula√ß√£o.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                    <select id="f_segmento" onchange="calcular()">
                        <option value="Ambos">Ambos</option>
                        <option value="Residencial" selected>Residencial</option>
                        <option value="Empresarial">Empresarial</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>Fatura√ß√£o
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Fatura√ß√£o', 'Escolha o tipo de fatura√ß√£o pretendido.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                    <select id="f_fatura" onchange="calcular()">
                        <option value="Todas">Todas</option>
                        <option value="Fatura eletr√≥nica">Eletr√≥nica</option>
                        <option value="Fatura em papel">Papel</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>Pagamento
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Pagamento', 'Escolha o m√©todo de pagamento.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                    <select id="f_pagamento" onchange="calcular()">
                        <option value="Todos">Todos</option>
                        <option value="D√©bito Direto">D√©bito Direto</option>
                        <option value="Multibanco">Multibanco</option>
                        <option value="Numer√°rio/Payshop/CTT">Outros (Num/CTT)</option>
                    </select>
                </div>
                <div class="filter-item" style="flex: 2;">
                    <label>Tipo Tarif√°rio
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Tipos de Tarif√°rio', 'Fixo: Pre√ßo constante. Indexado M√©dia: Baseado na m√©dia OMIE. Indexado Din√¢mico: Baseado no consumo e OMIE quarto-hor√°rio.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                    <div class="checkbox-group">
                        <label class="checkbox-label"><input type="checkbox" class="chk-tipo" value="Fixo" checked onchange="calcular()"> Fixo</label>
                        <label class="checkbox-label"><input type="checkbox" class="chk-tipo" value="Indexado M√©dia" checked onchange="calcular()"> Indexado M√©dia</label>
                        <label class="checkbox-label"><input type="checkbox" class="chk-tipo" value="Indexado quarto-hor√°rio" checked onchange="calcular()"> Din√¢mico/Indexado QH</label>
                    </div>
                </div>
                <div class="filter-item" style="flex: 2;">
                    <label>Pesquisar Comercializador/Tarif√°rio
                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" 
                        onmouseenter="showTooltipNome(event, 'Pesquisar Comercializador/Tarif√°rio', 'Digite o nome do comercializador ou tarif√°rio que deseja filtrar.')" 
                        onmouseleave="hideTooltip()"></i>
                    </label>
                    <input type="text" id="f_procura" placeholder="Ex: Coop√©rnico, EDP, BTN..." oninput="calcular()" style="width:100%;">
                </div>
            </div>
            
            <!-- Filtro de Comercializadores Aba 2 -->
            <div id="filter-providers-aba2" style="background: var(--surface); padding: 12px 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px;">
                <div style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleProviderFilterAba2()">
                    <label style="font-weight: 600; cursor: pointer;"><i class="fa-solid fa-filter"></i> N√£o mostrar estes comercializadores:</label>
                    <i class="fa-solid fa-chevron-down" id="icon-filter-providers-aba2"></i>
                </div>
                <div id="content-filter-providers-aba2" class="collapsed" style="margin-top: 12px;">
                    <div id="provider-filters-aba2" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px;">
                    </div>
                </div>
            </div>
            
            <!-- Filtro de Comercializadores Aba 3 -->
            <div id="filter-providers-aba3" style="background: var(--surface); padding: 12px 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px; display: none;">
                <div style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleProviderFilterAba3()">
                    <label style="font-weight: 600; cursor: pointer;"><i class="fa-solid fa-filter"></i> N√£o mostrar estes comercializadores:</label>
                    <i class="fa-solid fa-chevron-down" id="icon-filter-providers-aba3"></i>
                </div>
                <div id="content-filter-providers-aba3" class="collapsed" style="margin-top: 12px;">
                    <div id="provider-filters-aba3" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px;">
                    </div>
                </div>
            </div>
            
            <!-- Gr√°fico Evolu√ß√£o OMIE (Aba 2) -->
            <div id="grafico-omie-container" style="margin-bottom: 16px;">
                <div style="cursor: pointer; padding: 15px; background: #fff7ed; border: 1px solid #fed7aa; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;" onclick="toggleGraficoOmie()">
                    <h5 style="margin: 0; color: #9a3412; font-size: 0.95rem;">
                        <i class="fa-solid fa-chart-line"></i> Gr√°fico de Evolu√ß√£o dos Pre√ßos M√©dios Di√°rios OMIE PT no Per√≠odo
                    </h5>
                    <i id="grafico-omie-icon" class="fa-solid fa-chevron-down" style="color: #9a3412;"></i>
                </div>
                <div id="grafico-omie-content" class="collapsed" style="margin-top: 15px;">
                    <div id="chart-omie-diario" style="height: 350px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
                </div>
            </div>

            <!-- Tabela de An√°lise de Consumos (s√≥ aparece com ficheiros E-Redes) -->
            <div id="analise-consumos" style="display:none; margin-bottom:25px;">
                <div style="cursor:pointer; padding:15px; background:#f0f9ff; border:1px solid #0ea5e9; border-radius:10px; display:flex; justify-content:space-between; align-items:center;" onclick="toggleAnalise()">
                    <h5 style="margin:0; color:#0369a1; font-size:0.95rem;">
                        <i class="fa-solid fa-chart-pie"></i> An√°lise de Consumos e M√©dias OMIE (do(s) ficheiro(s))
                    </h5>
                    <i id="analise-icon" class="fa-solid fa-chevron-down" style="color:#0369a1;"></i>
                </div>
                <div id="analise-content" style="margin-top:15px; overflow-x:auto;">
                </div>
            </div>
            
            <!-- Gr√°ficos de An√°lise E-Redes (Aba 3) -->
            <div id="graficos-analise-eredes" style="display:none; margin-bottom:25px;">
                <div style="cursor:pointer; padding:15px; background:#f0fdf4; border:1px solid #22c55e; border-radius:10px; display:flex; justify-content:space-between; align-items:center;" onclick="toggleGraficosAnalise()">
                    <h5 style="margin:0; color:#15803d; font-size:0.95rem;">
                        <i class="fa-solid fa-chart-area"></i> Gr√°ficos de An√°lise (Consumo vs. OMIE)
                    </h5>
                    <i id="graficos-analise-icon" class="fa-solid fa-chevron-down" style="color:#15803d;"></i>
                </div>
                <div id="graficos-analise-content" class="collapsed" style="margin-top:15px;">
                    <!-- Gr√°fico Hor√°rio -->
                    <div style="margin-bottom: 20px;">
                        <h6 style="margin: 0 0 10px 0; color: #374151;">Consumo e Pre√ßo M√©dio OMIE por Hora</h6>
                        <div id="chart-horario" style="height: 400px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
                    </div>
                    <!-- Gr√°fico Di√°rio -->
                    <div style="margin-bottom: 20px;">
                        <h6 style="margin: 0 0 10px 0; color: #374151;">Consumo e Pre√ßo M√©dio OMIE Di√°rio</h6>
                        <div id="chart-diario" style="height: 400px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
                    </div>
                    <!-- Gr√°fico por Dia da Semana -->
                    <div style="margin-bottom: 20px;">
                        <h6 style="margin: 0 0 10px 0; color: #374151;">Consumo e Pre√ßo M√©dio OMIE por Dia da Semana</h6>
                        <div id="chart-semana" style="height: 400px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
                    </div>
                    <!-- Gr√°fico Mensal -->
                    <div style="margin-bottom: 20px;">
                        <h6 style="margin: 0 0 10px 0; color: #374151;">Consumo e Pre√ßo M√©dio OMIE Mensal</h6>
                        <div id="chart-mensal" style="height: 400px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
                    </div>
                </div>
            </div>
            
            <!-- An√°lise da Pot√™ncia Contratada (Aba 3) -->
            <div id="analise-potencia" style="display:none; margin-bottom:25px;">
                <div style="cursor:pointer; padding:15px; background:#fef3c7; border:1px solid #fde047; border-radius:10px; display:flex; justify-content:space-between; align-items:center;" onclick="toggleAnalisePotencia()">
                    <h5 style="margin:0; color:#92400e; font-size:0.95rem;">
                        <i class="fa-solid fa-bolt"></i> An√°lise da Pot√™ncia Contratada
                    </h5>
                    <i id="analise-potencia-icon" class="fa-solid fa-chevron-down" style="color:#92400e;"></i>
                </div>
                <div id="analise-potencia-content" style="margin-top:15px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
                        <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 4px;">Pot√™ncia Contratada</div>
                            <div id="potencia-contratada-display" style="font-size: 1.5rem; font-weight: 700; color: #0f172a;">-- kVA</div>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 4px;">Pot√™ncia M√°xima Registada</div>
                            <div id="potencia-maxima-display" style="font-size: 1.5rem; font-weight: 700; color: #0f172a;">-- kW</div>
                            <div id="potencia-maxima-legenda" style="font-size: 0.75rem; color: #94a3b8;">
                                (M√©dias de 15 min)
                            </div>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 4px;">Utiliza√ß√£o da Pot√™ncia</div>
                            <div id="potencia-utilizacao-display" style="font-size: 1.5rem; font-weight: 700; color: #0f172a;">-- %</div>
                        </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" id="chk-trifasico" onchange="atualizarAnalisePotencia()">
                            <span>A minha instala√ß√£o √© Trif√°sica</span>
                            
                            <i class="fa-solid fa-circle-question" 
                            style="color: var(--text-light); cursor: help; font-size: 0.9em;"
                            onmouseenter="showTooltipNome(event, 'Instala√ß√£o Trif√°sica', 'Selecione esta op√ß√£o se a sua instala√ß√£o for trif√°sica. Neste caso o valor de pot√™ncia ser√° estimado.')" 
                            onmouseleave="hideTooltip()">
                            </i>
                        </label>
                    </div>
                    <div id="potencia-recomendacao" style="padding: 12px; border-radius: 8px; background: #f1f5f9;">
                    </div>
                </div>
            </div>

            <!-- Resumo da Simula√ß√£o -->
            <div id="resumo-simulacao" style="background-color:#f9f9f9; border:1px solid #ddd; border-radius:10px; margin-bottom:25px; color:#333; display:none;">
                <div style="cursor:pointer; padding:15px; display:flex; justify-content:space-between; align-items:center;" onclick="toggleResumo()">
                    <h5 style="margin:0; color:#333; font-size: 0.95rem;">Resumo da Simula√ß√£o</h5>
                    <i id="resumo-icon" class="fa-solid fa-chevron-down" style="color:#333;"></i>
                </div>
                <div id="resumo-content" style="padding:0 15px 15px 15px;">
                    <ul style="list-style-type:none; padding-left:0;" id="resumo-list"></ul>
                </div>
            </div>

            <!-- Subt√≠tulo e Descri√ß√µes -->
            <div style="margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
                    <h4 id="titulo-tabela" style="margin-bottom:0; color:var(--text-main);">Tiago Fel√≠cia - Tarif√°rios de Eletricidade - Detalhado</h4>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button id="btn-partilhar" onclick="gerarLinkPartilha()" style="display:none; padding:6px 14px; border:1px solid var(--primary); background:white; color:var(--primary); border-radius:8px; cursor:pointer; font-size:0.8rem; font-weight:600; transition:all 0.2s;" onmouseover="this.style.background='var(--primary)';this.style.color='white'" onmouseout="this.style.background='white';this.style.color='var(--primary)'">
                            <i class="fa-solid fa-link"></i> Partilhar Simula√ß√£o
                        </button>
                        <button id="btn-exportar" onclick="exportarExcel()" style="display:none; padding:6px 14px; border:1px solid #16a34a; background:white; color:#16a34a; border-radius:8px; cursor:pointer; font-size:0.8rem; font-weight:600; transition:all 0.2s;" onmouseover="this.style.background='#16a34a';this.style.color='white'" onmouseout="this.style.background='white';this.style.color='#16a34a'">
                            <i class="fa-solid fa-file-excel"></i> Exportar Excel
                        </button>
                    </div>
                </div>
                <div style="font-size:0.9rem; color:var(--text-light); line-height:1.5;">
                </div>
            </div>

            <!-- Mensagem de Poupan√ßa -->
            <div id="mensagem-poupanca" style="margin-bottom:15px; display:none;"></div>

            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:10px;">
                <div id="res-count" style="font-weight:600; color:var(--text-light);">0 tarifas</div>
                <div style="font-size:0.75rem; color:var(--text-light)">Total com Valores Finais (todos os componentes, taxas e impostos). Valores unit√°rios de Energia e Pot√™ncia sem IVA.</div>
            </div>

            <div class="table-wrap">
                <table id="tabela">
                    <thead id="thead"></thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
            <div id="support-section" style="margin-top: 40px; margin-bottom: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                <h3 style="color: var(--text-main); margin-bottom: 12px;">üíñ Apoie este Projeto</h3>

                <p style="color: var(--text-main); margin-bottom: 16px; line-height: 1.6;">
                    Se quiser apoiar a manuten√ß√£o do site e o desenvolvimento cont√≠nuo deste simulador, 
                    pode faz√™-lo atrav√©s de uma das seguintes formas:
                </p>

                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="font-size: 1rem;">
                        ‚òï <a href="https://buymeacoffee.com/tiagofelicia" target="_blank" style="color: var(--primary); font-weight: 600; text-decoration: none;">
                            Compre-me um caf√© em BuyMeACoffee
                        </a>
                    </div>

                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <span style="color: var(--text-main);">ou atrav√©s do bot√£o PayPal:</span>
                        
                        <form action="https://www.paypal.com/donate" method="post" target="_blank" style="display: inline-block; margin: 0;">
                            <input type="hidden" name="hosted_button_id" value="W6KZHVL53VFJC">
                            <input type="image" src="https://www.paypalobjects.com/pt_PT/PT/i/btn/btn_donate_SM.gif" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Fa√ßa donativos com o bot√£o PayPal" style="vertical-align: middle;">
                            <img alt="" border="0" src="https://www.paypal.com/pt_PT/i/scr/pixel.gif" width="1" height="1">
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tooltip" class="tooltip hidden"></div>

    <script>
!function(){const e="file:"===window.location.protocol,t=["www.tiagofelicia.pt","tiagofelicia.pt","127.0.0.1","localhost"].includes(window.location.hostname);e||t||(document.body.innerHTML="<h1 style='text-align:center; margin-top:50px;'>‚ö†Ô∏è C√≥pia n√£o autorizada.<br>Aceda √† vers√£o oficial em <a href='https://www.tiagofelicia.pt'>www.tiagofelicia.pt</a></h1>",window.location.href="https://www.tiagofelicia.pt")}();const FILENAME="https://huggingface.co/spaces/tiagofelicia/simulador-tarifarios-eletricidade/resolve/main/Tarifarios_%F0%9F%94%8C_Eletricidade_Tiago_Felicia.xlsx";let DATA={fixos:[],indexados:[],omie:[],constantes:{},perdas:{}},SORT={col:"total",asc:!0},OMIE_VALUES={S:0,V:0,F:0,P:0,C:0},OMIE_MANUAL=!1,CURRENT_TAB="quick",LAST_EXPORT_DATA=null,QUICK_PARAMS={kwh:158,power:3.45,usagePattern:"balanced",tariffType:"all",cycle:"simples",excludedProviders:[]},SNAPSHOT_ABA2={hasData:!1,consumos:{},periodo:{},origem:"manual"},STATE_ABA2={potencia:3.45,ciclo:"Simples",dataInicio:null,dataFim:null,consumos:{S:158,V:63,F:95,C:68,P:27},omieValues:{S:0,V:0,F:0,P:0,C:0},omieManual:!1,excludedProviders:[],meuTarifario:{ativo:!1,collapsed:!0},tarifarioPersonalizado:{ativo:!1,collapsed:!0,valores:{}},modoComparacao:!1},STATE_ABA3={potencia:3.45,ciclo:"Simples",dataInicio:null,dataFim:null,consumos:{S:0,V:0,F:0,C:0,P:0},omieValues:{S:0,V:0,F:0,P:0,C:0},omieManual:!1,excludedProviders:[],dadosERedes:null,ficheiroProcessado:!1,meuTarifario:{ativo:!1,collapsed:!0},tarifarioPersonalizado:{ativo:!1,collapsed:!0,valores:{}},modoComparacao:!1};const CAV_FIXO_COMERCIALIZADORES=["CUR","EDP","Galp","Goldenergy","Ibelectra","Iberdrola","Luzig√°s","Plenitude","YesEnergy"];function getDataReferencia(e){const t=DATA.constantes[e];if(!t)return null;if("number"==typeof t){const e=XLSX.SSF.parse_date_code(t);return new Date(e.y,e.m-1,e.d)}if("string"==typeof t){const e=parseDateFromDB(t);if(e)return new Date(e)}return null}function atualizarDatasReferencia(){const e=getDataReferencia("Data_Valores_OMIE"),t=getDataReferencia("Data_Valores_OMIP"),o=document.getElementById("datas-ref-faq");if(!o)return;const a=e=>e?e.toLocaleDateString("pt-PT"):'<span style="color:#d9534f;">(N√£o encontrado)</span>',i=`\n            <div style="background-color: #d9edf7; padding: 15px; border-left: 5px solid #31708f; border-radius: 4px; color: #31708f; font-size: 0.95rem; margin-top: 20px; margin-bottom: 20px;">\n                <div style="font-weight:bold; margin-bottom:8px; font-size: 0.95rem;">\n                    <i class="fa-solid fa-calendar-days"></i> Datas de Refer√™ncia dos Valores de Mercado\n                </div>\n                <div style="margin-bottom: 4px;">‚Ä¢ Valores OMIE (SPOT) reais at√©: <b>${a(e)}</b></div>\n                <div>‚Ä¢ Valores OMIP (Futuros) atualizados em: <b>${a(t)}</b></div>\n            </div>\n        `;o.innerHTML=i}function verificarIncluiFuturosOMIP(){const e=document.getElementById("d_inicio"),t=document.getElementById("d_fim");if(!(e&&t&&e.value&&t.value))return!1;const o=getDataReferencia("Data_Valores_OMIE");if(!o)return!1;const a=t.value.split("-");return new Date(parseInt(a[0]),parseInt(a[1])-1,parseInt(a[2]))>o}function atualizarLabelsOMIE(){const e=verificarIncluiFuturosOMIP(),t=document.getElementById("omie-label-titulo");t&&(t.textContent=e?"M√©dia OMIE / OMIP (com Futuros)":"M√©dia OMIE (valor Final)")}function switchTab(e){const t=CURRENT_TAB;"complete"===t&&guardarEstadoAba2(),"advanced"===t&&guardarEstadoAba3(),CURRENT_TAB=e,document.getElementById("tab-quick").classList.remove("active"),document.getElementById("app").classList.add("hidden"),document.getElementById("tab-faq").classList.add("hidden");const o=document.getElementById("eredes-upload-central");if(o&&o.classList.add("hidden"),document.querySelectorAll(".tab-button").forEach(e=>e.classList.remove("active")),"quick"===e)document.getElementById("tab-quick").classList.add("active"),document.querySelectorAll(".tab-button")[0].classList.add("active");else if("complete"===e){if("quick"===t){STATE_ABA2.potencia=QUICK_PARAMS.power,"simples"===QUICK_PARAMS.cycle?STATE_ABA2.ciclo="Simples":"bi"===QUICK_PARAMS.cycle?STATE_ABA2.ciclo="Bi-hor√°rio - Ciclo Di√°rio":"tri"===QUICK_PARAMS.cycle&&(STATE_ABA2.ciclo="Tri-hor√°rio - Ciclo Di√°rio"),STATE_ABA2.dataInicio=document.getElementById("d_inicio").value,STATE_ABA2.dataFim=document.getElementById("d_fim").value,STATE_ABA2.omieValues={...OMIE_VALUES},STATE_ABA2.omieManual=OMIE_MANUAL;const e=QUICK_PARAMS.kwh;if("simples"===QUICK_PARAMS.cycle)STATE_ABA2.consumos={S:e,V:0,F:0,C:0,P:0};else if("bi"===QUICK_PARAMS.cycle){const t="night"===QUICK_PARAMS.usagePattern?.6:.4;STATE_ABA2.consumos={S:0,V:Math.round(e*t),F:Math.round(e*(1-t)),C:0,P:0}}else if("tri"===QUICK_PARAMS.cycle){const t="night"===QUICK_PARAMS.usagePattern?.6:.25,o=.15,a=1-t-o;STATE_ABA2.consumos={S:0,V:Math.round(e*t),F:0,C:Math.round(e*a),P:Math.round(e*o)}}}document.getElementById("app").classList.remove("hidden"),document.querySelectorAll(".tab-button")[1].classList.add("active");const e=document.getElementById("analise-consumos");e&&(e.style.display="none");const o=document.getElementById("graficos-analise-eredes");o&&(o.style.display="none");const a=document.getElementById("analise-potencia");a&&(a.style.display="none");const i=document.getElementById("grafico-omie-container");i&&(i.style.display="block");const n=document.getElementById("eredes-section-wrapper");n&&(n.style.display="none");const l=document.getElementById("content-consumo");if(l){l.classList.remove("hidden");const e=document.querySelector("[onclick=\"toggleSection('consumo')\"]");e&&(e.style.display="block")}document.getElementById("d_inicio").disabled=!1,document.getElementById("d_fim").disabled=!1,document.getElementById("d_inicio").min="2025-01-01",document.getElementById("d_inicio").max="2026-12-31",document.getElementById("d_fim").min="2025-01-01",document.getElementById("d_fim").max="2026-12-31",["kwh_S","kwh_V","kwh_F","kwh_C","kwh_P"].forEach(e=>{const t=document.getElementById(e);t&&(t.disabled=!1)});const s=document.getElementById("filter-providers-aba2");s&&(s.style.display="block");const r=document.getElementById("filter-providers-aba3");r&&(r.style.display="none"),restaurarMeuTarifarioAba(2),restaurarTarifarioPersonalizadoAba(2),restaurarModoComparacaoAba(2),restaurarEstadoAba2()}else if("advanced"===e)if(document.querySelectorAll(".tab-button")[2].classList.add("active"),STATE_ABA3.ficheiroProcessado){document.getElementById("app").classList.remove("hidden");const e=document.getElementById("analise-consumos");e&&DADOS_EREDES&&(e.style.display="block");const t=document.getElementById("graficos-analise-eredes");t&&(t.style.display="block");const o=document.getElementById("analise-potencia");o&&(o.style.display="block");const a=document.getElementById("grafico-omie-container");a&&(a.style.display="none");const i=document.getElementById("eredes-section-wrapper");i&&(i.style.display="block");const n=document.querySelector("[onclick=\"toggleSection('consumo')\"]");n&&(n.style.display="none");const l=document.getElementById("content-consumo");l&&l.classList.add("hidden");const s=document.getElementById("filter-providers-aba2");s&&(s.style.display="none");const r=document.getElementById("filter-providers-aba3");r&&(r.style.display="block"),restaurarMeuTarifarioAba(3),restaurarTarifarioPersonalizadoAba(3),restaurarModoComparacaoAba(3),restaurarEstadoAba3()}else{const e=document.getElementById("eredes-upload-central");e&&e.classList.remove("hidden"),document.getElementById("app").classList.add("hidden")}else if("faq"===e){const e=document.getElementById("tab-faq");e.classList.remove("hidden"),e.classList.add("active"),document.querySelectorAll(".tab-button")[3].classList.add("active")}}function guardarEstadoAba2(){STATE_ABA2.potencia=parseFloat(document.getElementById("potencia").value),STATE_ABA2.ciclo=document.getElementById("ciclo").value,STATE_ABA2.dataInicio=document.getElementById("d_inicio").value,STATE_ABA2.dataFim=document.getElementById("d_fim").value,STATE_ABA2.omieValues={...OMIE_VALUES},STATE_ABA2.omieManual=OMIE_MANUAL,["S","V","F","C","P"].forEach(e=>{const t=document.getElementById("kwh_"+e);t&&(STATE_ABA2.consumos[e]=parseFloat(t.value)||0)});const e=document.getElementById("meu_ativo");if(e){STATE_ABA2.meuTarifario.ativo=e.checked;const t=document.getElementById("meu-inputs");t&&(STATE_ABA2.meuTarifario.html=t.innerHTML),STATE_ABA2.meuTarifario.collapsed=document.getElementById("content-meu").classList.contains("collapsed")}const t=document.getElementById("pers_ativo");if(t){STATE_ABA2.tarifarioPersonalizado.ativo=t.checked,STATE_ABA2.tarifarioPersonalizado.collapsed=document.getElementById("content-personalizado").classList.contains("collapsed"),STATE_ABA2.tarifarioPersonalizado.valores={};const e=document.getElementById("pers_energia_s"),o=document.getElementById("pers_potencia_s");e&&(STATE_ABA2.tarifarioPersonalizado.valores.energia_s=parseFloat(e.value)||0),o&&(STATE_ABA2.tarifarioPersonalizado.valores.potencia_s=parseFloat(o.value)||0);const a=document.getElementById("pers_energia_v_bi"),i=document.getElementById("pers_energia_f_bi"),n=document.getElementById("pers_potencia_bi");a&&(STATE_ABA2.tarifarioPersonalizado.valores.energia_v_bi=parseFloat(a.value)||0),i&&(STATE_ABA2.tarifarioPersonalizado.valores.energia_f_bi=parseFloat(i.value)||0),n&&(STATE_ABA2.tarifarioPersonalizado.valores.potencia_bi=parseFloat(n.value)||0);const l=document.getElementById("pers_energia_v_tri"),s=document.getElementById("pers_energia_c_tri"),r=document.getElementById("pers_energia_p_tri"),c=document.getElementById("pers_potencia_tri");l&&(STATE_ABA2.tarifarioPersonalizado.valores.energia_v_tri=parseFloat(l.value)||0),s&&(STATE_ABA2.tarifarioPersonalizado.valores.energia_c_tri=parseFloat(s.value)||0),r&&(STATE_ABA2.tarifarioPersonalizado.valores.energia_p_tri=parseFloat(r.value)||0),c&&(STATE_ABA2.tarifarioPersonalizado.valores.potencia_tri=parseFloat(c.value)||0);const d=document.getElementById("pers_tar_energia"),u=document.getElementById("pers_tar_potencia"),m=document.getElementById("pers_tse_incluido");d&&(STATE_ABA2.tarifarioPersonalizado.valores.tar_energia=d.checked),u&&(STATE_ABA2.tarifarioPersonalizado.valores.tar_potencia=u.checked),m&&(STATE_ABA2.tarifarioPersonalizado.valores.tse_incluido=m.checked)}const o=document.getElementById("modo_comparacao");o&&(STATE_ABA2.modoComparacao=o.checked)}function restaurarEstadoAba2(){if(STATE_ABA2.dataInicio){document.getElementById("potencia").value=STATE_ABA2.potencia,document.getElementById("ciclo").value=STATE_ABA2.ciclo,document.getElementById("d_inicio").value=STATE_ABA2.dataInicio,document.getElementById("d_fim").value=STATE_ABA2.dataFim,OMIE_VALUES={...STATE_ABA2.omieValues},OMIE_MANUAL=STATE_ABA2.omieManual,atualizarDias(),construirInputsConsumo();const e=STATE_ABA2.ciclo;if(e.includes("Simples")){const e=document.getElementById("kwh_S");e&&STATE_ABA2.consumos.S&&(e.value=STATE_ABA2.consumos.S)}else if(e.includes("Bi")){const e=document.getElementById("kwh_V"),t=document.getElementById("kwh_F");e&&STATE_ABA2.consumos.V&&(e.value=STATE_ABA2.consumos.V),t&&STATE_ABA2.consumos.F&&(t.value=STATE_ABA2.consumos.F)}else{const e=document.getElementById("kwh_V"),t=document.getElementById("kwh_P"),o=document.getElementById("kwh_C");e&&STATE_ABA2.consumos.V&&(e.value=STATE_ABA2.consumos.V),t&&STATE_ABA2.consumos.P&&(t.value=STATE_ABA2.consumos.P),o&&STATE_ABA2.consumos.C&&(o.value=STATE_ABA2.consumos.C)}calcular()}}function guardarEstadoAba3(){STATE_ABA3.potencia=parseFloat(document.getElementById("potencia").value),STATE_ABA3.ciclo=document.getElementById("ciclo").value,STATE_ABA3.dataInicio=document.getElementById("d_inicio").value,STATE_ABA3.dataFim=document.getElementById("d_fim").value,STATE_ABA3.omieValues={...OMIE_VALUES},STATE_ABA3.omieManual=OMIE_MANUAL;const e=document.getElementById("meu_ativo");if(e){STATE_ABA3.meuTarifario.ativo=e.checked;const t=document.getElementById("meu-inputs");t&&(STATE_ABA3.meuTarifario.html=t.innerHTML),STATE_ABA3.meuTarifario.collapsed=document.getElementById("content-meu").classList.contains("collapsed")}const t=document.getElementById("pers_ativo");if(t){STATE_ABA3.tarifarioPersonalizado.ativo=t.checked,STATE_ABA3.tarifarioPersonalizado.collapsed=document.getElementById("content-personalizado").classList.contains("collapsed"),STATE_ABA3.tarifarioPersonalizado.valores={};const e=document.getElementById("pers_energia_s"),o=document.getElementById("pers_potencia_s");e&&(STATE_ABA3.tarifarioPersonalizado.valores.energia_s=parseFloat(e.value)||0),o&&(STATE_ABA3.tarifarioPersonalizado.valores.potencia_s=parseFloat(o.value)||0);const a=document.getElementById("pers_energia_v_bi"),i=document.getElementById("pers_energia_f_bi"),n=document.getElementById("pers_potencia_bi");a&&(STATE_ABA3.tarifarioPersonalizado.valores.energia_v_bi=parseFloat(a.value)||0),i&&(STATE_ABA3.tarifarioPersonalizado.valores.energia_f_bi=parseFloat(i.value)||0),n&&(STATE_ABA3.tarifarioPersonalizado.valores.potencia_bi=parseFloat(n.value)||0);const l=document.getElementById("pers_energia_v_tri"),s=document.getElementById("pers_energia_c_tri"),r=document.getElementById("pers_energia_p_tri"),c=document.getElementById("pers_potencia_tri");l&&(STATE_ABA3.tarifarioPersonalizado.valores.energia_v_tri=parseFloat(l.value)||0),s&&(STATE_ABA3.tarifarioPersonalizado.valores.energia_c_tri=parseFloat(s.value)||0),r&&(STATE_ABA3.tarifarioPersonalizado.valores.energia_p_tri=parseFloat(r.value)||0),c&&(STATE_ABA3.tarifarioPersonalizado.valores.potencia_tri=parseFloat(c.value)||0);const d=document.getElementById("pers_tar_energia"),u=document.getElementById("pers_tar_potencia"),m=document.getElementById("pers_tse_incluido");d&&(STATE_ABA3.tarifarioPersonalizado.valores.tar_energia=d.checked),u&&(STATE_ABA3.tarifarioPersonalizado.valores.tar_potencia=u.checked),m&&(STATE_ABA3.tarifarioPersonalizado.valores.tse_incluido=m.checked)}const o=document.getElementById("modo_comparacao");o&&(STATE_ABA3.modoComparacao=o.checked)}function restaurarEstadoAba3(){if(STATE_ABA3.dataInicio){if(document.getElementById("potencia").value=STATE_ABA3.potencia,document.getElementById("ciclo").value=STATE_ABA3.ciclo,DADOS_EREDES&&DADOS_EREDES.periodo){const e=DADOS_EREDES.periodo.inicio,t=DADOS_EREDES.periodo.fim,o=document.getElementById("d_inicio"),a=document.getElementById("d_fim");o.min=e,o.max=t,a.min=e,a.max=t,o.value=STATE_ABA3.dataInicio<e||STATE_ABA3.dataInicio>t?e:STATE_ABA3.dataInicio,a.value=STATE_ABA3.dataFim>t||STATE_ABA3.dataFim<e?t:STATE_ABA3.dataFim}else document.getElementById("d_inicio").value=STATE_ABA3.dataInicio,document.getElementById("d_fim").value=STATE_ABA3.dataFim;OMIE_VALUES={...STATE_ABA3.omieValues},OMIE_MANUAL=STATE_ABA3.omieManual,atualizarDias(),construirInputsConsumo()}}function restaurarMeuTarifarioAba(e){const t=2===e?STATE_ABA2:STATE_ABA3,o=document.getElementById("meu_ativo"),a=document.getElementById("meu-inputs"),i=document.getElementById("content-meu");o&&(o.checked=t.meuTarifario.ativo,t.meuTarifario.ativo&&t.meuTarifario.html?(a.innerHTML=t.meuTarifario.html,a.classList.remove("hidden")):a.classList.add("hidden")),i&&(t.meuTarifario.collapsed?i.classList.add("collapsed"):i.classList.remove("collapsed"))}function restaurarTarifarioPersonalizadoAba(e){const t=2===e?STATE_ABA2:STATE_ABA3,o=document.getElementById("pers_ativo"),a=document.getElementById("content-personalizado");if(o&&(o.checked=t.tarifarioPersonalizado.ativo,t.tarifarioPersonalizado.ativo)){toggleTarifarioPersonalizado();const e=t.tarifarioPersonalizado.valores;if(e){const t=document.getElementById("pers_energia_s"),o=document.getElementById("pers_potencia_s");t&&void 0!==e.energia_s&&(t.value=e.energia_s),o&&void 0!==e.potencia_s&&(o.value=e.potencia_s);const a=document.getElementById("pers_energia_v_bi"),i=document.getElementById("pers_energia_f_bi"),n=document.getElementById("pers_potencia_bi");a&&void 0!==e.energia_v_bi&&(a.value=e.energia_v_bi),i&&void 0!==e.energia_f_bi&&(i.value=e.energia_f_bi),n&&void 0!==e.potencia_bi&&(n.value=e.potencia_bi);const l=document.getElementById("pers_energia_v_tri"),s=document.getElementById("pers_energia_c_tri"),r=document.getElementById("pers_energia_p_tri"),c=document.getElementById("pers_potencia_tri");l&&void 0!==e.energia_v_tri&&(l.value=e.energia_v_tri),s&&void 0!==e.energia_c_tri&&(s.value=e.energia_c_tri),r&&void 0!==e.energia_p_tri&&(r.value=e.energia_p_tri),c&&void 0!==e.potencia_tri&&(c.value=e.potencia_tri);const d=document.getElementById("pers_tar_energia"),u=document.getElementById("pers_tar_potencia"),m=document.getElementById("pers_tse_incluido");d&&void 0!==e.tar_energia&&(d.checked=e.tar_energia),u&&void 0!==e.tar_potencia&&(u.checked=e.tar_potencia),m&&void 0!==e.tse_incluido&&(m.checked=e.tse_incluido)}}a&&(t.tarifarioPersonalizado.collapsed?a.classList.add("collapsed"):a.classList.remove("collapsed"))}function restaurarModoComparacaoAba(e){const t=2===e?STATE_ABA2:STATE_ABA3,o=document.getElementById("modo_comparacao");o&&(o.checked=t.modoComparacao)}function autoCalculate(){QUICK_PARAMS.kwh=parseFloat(document.getElementById("quick-kwh").value)||158,document.querySelectorAll(".price-button").forEach(e=>e.classList.remove("selected")),runQuickSimulation()}function selectPrice(e){let t,o;document.querySelectorAll(".price-button").forEach(e=>e.classList.remove("selected")),document.getElementById(`price-${e}`).classList.add("selected"),40===e?(t=158,o=3.45):100===e?(t=333,o=6.9):200===e&&(t=908,o=13.8),QUICK_PARAMS.kwh=t,QUICK_PARAMS.power=o,document.getElementById("quick-kwh").value=t,document.querySelectorAll(".power-button").forEach(e=>e.classList.remove("selected"));const a=Array.from(document.querySelectorAll(".power-button")).find(e=>parseFloat(e.textContent)===o);a&&a.classList.add("selected"),runQuickSimulation()}function selectPower(e){document.querySelectorAll(".power-button").forEach(e=>e.classList.remove("selected")),event.target.classList.add("selected"),QUICK_PARAMS.power=e,document.querySelectorAll(".price-button").forEach(e=>e.classList.remove("selected")),runQuickSimulation()}function selectUsagePattern(e){document.querySelectorAll("#usage-balanced, #usage-night").forEach(e=>e.classList.remove("selected")),document.getElementById(`usage-${e}`).classList.add("selected"),QUICK_PARAMS.usagePattern=e,"simples"!==QUICK_PARAMS.cycle&&"bi"!==QUICK_PARAMS.cycle||(QUICK_PARAMS.cycle="balanced"===e?"simples":"bi",updateCycleButtons()),runQuickSimulation()}function selectTariffType(e){document.querySelectorAll("#tariff-all, #tariff-fixed").forEach(e=>e.classList.remove("selected")),document.getElementById(`tariff-${e}`).classList.add("selected"),QUICK_PARAMS.tariffType=e,runQuickSimulation()}function selectCycle(e){QUICK_PARAMS.cycle=e,updateCycleButtons(),runQuickSimulation()}function updateCycleButtons(){document.querySelectorAll("#cycle-simples, #cycle-bi, #cycle-tri").forEach(e=>e.classList.remove("selected")),document.getElementById(`cycle-${QUICK_PARAMS.cycle}`).classList.add("selected")}function toggleQuickSettings(){const e=document.getElementById("quick-settings-content"),t=document.getElementById("quick-settings-icon");e.classList.contains("hidden")?(e.classList.remove("hidden"),t.className="fa-solid fa-chevron-up"):(e.classList.add("hidden"),t.className="fa-solid fa-chevron-down")}function showUpdateNotice(){const e=document.createElement("div");e.className="update-notice",e.innerHTML='<i class="fa-solid fa-check"></i> Par√¢metros atualizados',e.style.display="flex",document.body.appendChild(e),setTimeout(()=>{e.style.opacity="0",setTimeout(()=>e.remove(),300)},1500)}function runQuickSimulation(){document.getElementById("potencia").value=QUICK_PARAMS.power;const e=document.getElementById("ciclo");"simples"===QUICK_PARAMS.cycle?e.value="Simples":"bi"===QUICK_PARAMS.cycle?e.value="Bi-hor√°rio - Ciclo Di√°rio":"tri"===QUICK_PARAMS.cycle&&(e.value="Tri-hor√°rio - Ciclo Di√°rio"),construirInputsConsumo(),"simples"===QUICK_PARAMS.cycle?document.getElementById("kwh_S").value=QUICK_PARAMS.kwh:"bi"===QUICK_PARAMS.cycle?(document.getElementById("kwh_V").value=Math.round(.6*QUICK_PARAMS.kwh),document.getElementById("kwh_F").value=Math.round(.4*QUICK_PARAMS.kwh)):"tri"===QUICK_PARAMS.cycle&&(document.getElementById("kwh_V").value=Math.round(.6*QUICK_PARAMS.kwh),document.getElementById("kwh_C").value=Math.round(.25*QUICK_PARAMS.kwh),document.getElementById("kwh_P").value=Math.round(.15*QUICK_PARAMS.kwh)),calcular(),setTimeout(()=>{displayPodium()},200)}function displayPodium(){if(!window.GLOBAL_RESULTS||0===window.GLOBAL_RESULTS.length)return void renderEmptyPodium();let e=window.GLOBAL_RESULTS.filter(e=>"Utilizador"!==e.tipo&&"Personalizado"!==e.com&&(("fixed"!==QUICK_PARAMS.tariffType||!e.tipo.toLowerCase().includes("indexado"))&&!QUICK_PARAMS.excludedProviders.some(t=>e.com===t)));if(0===e.length)return void renderEmptyPodium();e.sort((e,t)=>e.total-t.total);const t=e.slice(0,3),o=["ü•á","ü•à","ü•â"],a=["first","second","third"];let i="";for(let e=0;e<3;e++)if(e<t.length){const n=t[e],l=0===e?0:n.total-t[0].total,s=!n.tipo.toLowerCase().includes("indexado")?'<span style="font-size:0.65rem; background:#dcfce7; color:#166534; padding:2px 6px; border-radius:4px;">Fixo</span>':'<span style="font-size:0.65rem; background:#dbeafe; color:#1e40af; padding:2px 6px; border-radius:4px;">Indexado</span>';i+=`\n                        <div class="podium-item ${a[e]}">\n                            <div class="podium-medal">${o[e]}</div>\n                            <div class="podium-name">${n.com}</div>\n                            <div style="font-size:0.8rem; color:#64748b; margin-bottom:5px; height:34px; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">${n.nome}</div>\n                            ${s}\n                            <div class="podium-price">${n.total.toFixed(2)}‚Ç¨<span style="font-size: 0.5em; color:#64748b; font-weight:400;">/m√™s</span></div>\n                            ${0===e?'<div style="color: var(--success); font-size: 0.75rem; margin-top: 4px; font-weight:600;">‚úì Melhor oferta</div>':`<div style="color: #dc2626; font-size: 0.75rem; margin-top: 4px;">+${l.toFixed(0)}‚Ç¨ / m√™s</div>`}\n                        </div>\n                    `}else i+=`\n                        <div class="podium-item ${a[e]}" style="opacity: 0.5; background:#f1f5f9;">\n                            <div class="podium-medal" style="filter:grayscale(1);">${o[e]}</div>\n                            <div class="podium-name" style="color:#94a3b8;">---</div>\n                            <div class="podium-price" style="color:#cbd5e1;">-</div>\n                        </div>\n                    `;document.getElementById("podium").innerHTML=i}function renderEmptyPodium(){document.getElementById("podium").innerHTML='\n                <div class="podium-item second" style="opacity: 0.3;"><div class="podium-medal">ü•à</div><div class="podium-name">...</div><div class="podium-price">-</div></div>\n                <div class="podium-item first" style="opacity: 0.3;"><div class="podium-medal">ü•á</div><div class="podium-name">...</div><div class="podium-price">-</div></div>\n                <div class="podium-item third" style="opacity: 0.3;"><div class="podium-medal">ü•â</div><div class="podium-name">...</div><div class="podium-price">-</div></div>\n            '}function populateProviderFilters(){try{const e=document.getElementById("provider-filters");if(!e)return;if(void 0===DATA||!DATA.fixos||!DATA.indexados)return void console.warn("Aguardando dados para filtros...");"undefined"==typeof excludedProviders&&(window.excludedProviders=[]);const t=DATA.fixos||[],o=DATA.indexados||[],a=t.concat(o),i=[...new Set(a.filter(e=>e&&e.comercializador).map(e=>e.comercializador))].sort();e.innerHTML="",i.forEach(t=>{const o=document.createElement("label");o.style.cssText="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; transition: background 0.2s;";const a=document.createElement("input");a.type="checkbox",a.style.width="14px",a.style.height="14px",a.checked=-1!==excludedProviders.indexOf(t),a.onchange=function(){if(this.checked)-1===excludedProviders.indexOf(t)&&excludedProviders.push(t);else{const e=excludedProviders.indexOf(t);e>-1&&excludedProviders.splice(e,1)}const e=document.getElementById("provider-filters_ALL");e&&(e.checked=i.length>0&&excludedProviders.length===i.length),calcular()};const n=document.createElement("span");n.textContent=t,o.appendChild(a),o.appendChild(n),o.onmouseenter=function(){this.style.background="#f1f5f9"},o.onmouseleave=function(){this.style.background="white"},e.appendChild(o)});const n=document.createElement("label");n.style.cssText="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: #fff5f5; border: 1px solid #fecaca; border-radius: 6px; font-size: 0.85rem; color: #dc2626; font-weight: bold; transition: background 0.2s;";const l=document.createElement("input");l.type="checkbox",l.id="provider-filters_ALL",l.style.width="14px",l.style.height="14px",l.style.accentColor="#dc2626",l.checked=i.length>0&&excludedProviders.length===i.length,l.onchange=function(){if(this.checked)i.forEach(e=>{-1===excludedProviders.indexOf(e)&&excludedProviders.push(e)});else for(;excludedProviders.length>0;)excludedProviders.pop();populateProviderFilters(),calcular()};const s=document.createElement("span");s.textContent="Selecionar Todos",n.appendChild(l),n.appendChild(s),n.onmouseenter=function(){this.style.background="#fee2e2"},n.onmouseleave=function(){this.style.background="#fff5f5"},e.appendChild(n)}catch(e){console.error("Erro ao gerar filtros:",e)}}function toggleProvider(e){const t=QUICK_PARAMS.excludedProviders.indexOf(e);t>-1?QUICK_PARAMS.excludedProviders.splice(t,1):QUICK_PARAMS.excludedProviders.push(e),runQuickSimulation()}function copyToSnapshotAba2(){DADOS_EREDES&&(SNAPSHOT_ABA2={hasData:!0,consumos:{...DADOS_EREDES.consumosAgregados},periodo:{...DADOS_EREDES.periodo},origem:"eredes"})}const COLS_FIXO={pot:"potencia_kva",ciclo:"opcao_horaria_e_ciclo",tipo:"tipo",fixo:"preco_potencia_dia",pS:"preco_energia_simples",pV_bi:"preco_energia_vazio_bi",pF:"preco_energia_fora_vazio",pV_tri:"preco_energia_vazio_tri",pP:"preco_energia_ponta",pC:"preco_energia_cheias",tar_e_incl:"tar_incluida_energia",tar_p_incl:"tar_incluida_potencia",tse_incl:"financiamento_tse_incluido",desc_fat:"desconto_fatura_mes",desc_limit:"desconto_meses_limite",seg:"segmento",fat:"faturacao",pag:"pagamento",site:"site_adesao",notas:"notas"},COLS_INDEX={pot:"potencia_kva",ciclo:"opcao_horaria_e_ciclo",tipo:"tipo",fixo:"preco_potencia_dia",tar_e_incl:"tar_incluida_energia",tar_p_incl:"tar_incluida_potencia",tse_incl:"financiamento_tse_incluido",desc_fat:"desconto_fatura_mes",desc_limit:"desconto_meses_limite",seg:"segmento",fat:"faturacao",pag:"pagamento",site:"site_adesao",notas:"notas"};function parseDateFromDB(e){if(null==e)return null;if("number"==typeof e){const t=XLSX.SSF.parse_date_code(e);return`${t.y}-${String(t.m).padStart(2,"0")}-${String(t.d).padStart(2,"0")}`}let t=String(e).trim().split(" ")[0];if(t.includes("/")){const e=t.split("/");if(3===e.length){if(4===e[2].length){const t=e[0].padStart(2,"0"),o=e[1].padStart(2,"0");return`${e[2]}-${t}-${o}`}if(4===e[0].length)return`${e[0]}-${e[1].padStart(2,"0")}-${e[2].padStart(2,"0")}`}}return null}function getYMD(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function toggleSection(e){const t=document.getElementById("content-"+e),o=document.getElementById("icon-"+e),a=t.classList.contains("collapsed");t.classList.toggle("collapsed"),o.className=a?"fa-solid fa-chevron-down":"fa-solid fa-chevron-right"}function toggleSidebar(){const e=document.getElementById("sidebar-panel"),t=document.getElementById("sidebar-overlay");e&&t&&(e.classList.toggle("open"),t.classList.toggle("active"),document.body.style.overflow=e.classList.contains("open")?"hidden":"")}function toggleProviderFilterAba2(){const e=document.getElementById("content-filter-providers-aba2"),t=document.getElementById("icon-filter-providers-aba2");e.classList.toggle("collapsed"),t.className=e.classList.contains("collapsed")?"fa-solid fa-chevron-down":"fa-solid fa-chevron-up"}function toggleProviderFilterAba3(){const e=document.getElementById("content-filter-providers-aba3"),t=document.getElementById("icon-filter-providers-aba3");e.classList.toggle("collapsed"),t.className=e.classList.contains("collapsed")?"fa-solid fa-chevron-down":"fa-solid fa-chevron-up"}function toggleGraficoOmie(){const e=document.getElementById("grafico-omie-content"),t=document.getElementById("grafico-omie-icon"),o=e.classList.contains("collapsed");e.classList.toggle("collapsed"),t.className=e.classList.contains("collapsed")?"fa-solid fa-chevron-down":"fa-solid fa-chevron-up",o&&gerarGraficoOMIEDiario()}function toggleGraficosAnalise(){const e=document.getElementById("graficos-analise-content"),t=document.getElementById("graficos-analise-icon"),o=e.classList.contains("collapsed");e.classList.toggle("collapsed"),t.className=e.classList.contains("collapsed")?"fa-solid fa-chevron-down":"fa-solid fa-chevron-up",o&&DADOS_EREDES&&gerarGraficosAnaliseERedes()}function toggleAnalisePotencia(){const e=document.getElementById("analise-potencia-content"),t=document.getElementById("analise-potencia-icon");e.classList.toggle("collapsed"),t.className=e.classList.contains("collapsed")?"fa-solid fa-chevron-down":"fa-solid fa-chevron-up"}function populateProviderFiltersAbas(){const e=new Set;DATA.fixos.forEach(t=>{t.comercializador&&e.add(t.comercializador)}),DATA.indexados.forEach(t=>{t.comercializador&&e.add(t.comercializador)});const t=Array.from(e).sort(),o=(e,a,i)=>{const n=document.getElementById(e);if(!n)return;n.innerHTML="",t.forEach(o=>{const l=document.createElement("label");l.style.cssText="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; transition: background 0.2s;";const s=document.createElement("input");s.type="checkbox",s.style.width="14px",s.style.height="14px",s.checked=a.excludedProviders.includes(o),s.onchange=()=>{s.checked?a.excludedProviders.includes(o)||a.excludedProviders.push(o):a.excludedProviders=a.excludedProviders.filter(e=>e!==o);const n=document.getElementById(e+"_ALL");n&&(n.checked=a.excludedProviders.length===t.length),CURRENT_TAB===i&&calcular()};const r=document.createElement("span");r.textContent=o,l.appendChild(s),l.appendChild(r),l.onmouseover=()=>l.style.background="#f1f5f9",l.onmouseout=()=>l.style.background="white",n.appendChild(l)});const l=document.createElement("label");l.style.cssText="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: #fff5f5; border: 1px solid #fecaca; border-radius: 6px; font-size: 0.85rem; color: #dc2626; font-weight: bold; transition: background 0.2s;";const s=document.createElement("input");s.type="checkbox",s.id=e+"_ALL",s.style.width="14px",s.style.height="14px",s.style.accentColor="#dc2626",s.checked=t.length>0&&a.excludedProviders.length===t.length,s.onchange=()=>{s.checked?a.excludedProviders=[...t]:a.excludedProviders=[],o(e,a,i),CURRENT_TAB===i&&calcular()};const r=document.createElement("span");r.textContent="Selecionar Todos",l.appendChild(s),l.appendChild(r),l.onmouseover=()=>l.style.background="#fee2e2",l.onmouseout=()=>l.style.background="#fff5f5",n.appendChild(l)};o("provider-filters-aba2",STATE_ABA2,"complete"),o("provider-filters-aba3",STATE_ABA3,"advanced")}function toggleProviderAba2(e){const t=STATE_ABA2.excludedProviders.indexOf(e);t>-1?STATE_ABA2.excludedProviders.splice(t,1):STATE_ABA2.excludedProviders.push(e),"complete"===CURRENT_TAB&&calcular()}function toggleProviderAba3(e){const t=STATE_ABA3.excludedProviders.indexOf(e);t>-1?STATE_ABA3.excludedProviders.splice(t,1):STATE_ABA3.excludedProviders.push(e),"advanced"===CURRENT_TAB&&calcular()}async function processarFicheirosERedesCentral(){const e=document.getElementById("file-eredes-central"),t=document.getElementById("eredes-status-central");if(e.files&&0!==e.files.length){t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> A processar ficheiros...';try{const o=[];for(let a=0;a<e.files.length;a++){const i=e.files[a];t.innerHTML=`<i class="fa-solid fa-spinner fa-spin"></i> A processar ${i.name} (${a+1}/${e.files.length})...`;const n=await processarFicheiroERedes(i);if(n.erro)return void(t.innerHTML=`<span style="color:red;">‚ùå Erro: ${n.erro}</span>`);o.push(n.dados)}const a=validarEJuntarFicheiros(o);if(a.erro)return void(t.innerHTML=`<span style="color:red;">‚ùå ${a.erro}</span>`);const i=agregarConsumosPorPeriodo(a.dados),n=calcularMediasOMIE(a.dados),l=a.dados[0],s=a.dados[a.dados.length-1],r=l.DataHora.split("T")[0],c=s.DataHora.split("T")[0],d=new Date(r),u=new Date(c),m=Math.floor((u-d)/864e5)+1;let p=a.avisoAntigos?"‚ö†Ô∏è Dados anteriores a 2025 foram descartados (sem dados OMIE)":"";DADOS_EREDES={dadosBrutos:a.dados,consumosAgregados:i,mediasOMIE:n,periodo:{inicio:r,fim:c,dias:m}},STATE_ABA3.ficheiroProcessado=!0,STATE_ABA3.dataInicio=r,STATE_ABA3.dataFim=c,STATE_ABA3.dadosERedes=DADOS_EREDES,calcularPotenciaMaxima(),document.getElementById("eredes-upload-central").classList.add("hidden"),document.getElementById("app").classList.remove("hidden"),switchTab("advanced"),aplicarDadosERedes(),document.getElementById("eredes-upload").style.display="none",document.getElementById("eredes-limpar").style.display="block";const g=e=>e.split("-").reverse().join("/");document.getElementById("eredes-resumo").innerHTML=`\n                    <b>${e.files.length} ficheiro(s):</b> ${g(r)} a ${g(c)} (${m} dias)\n                    ${p?`<br><span style="color:#d97706;">${p}</span>`:""}\n                `,mostrarTabelaAnaliseERedes(),calcular()}catch(e){console.error("Erro ao processar ficheiros:",e),t.innerHTML=`<span style="color:red;">‚ùå Erro: ${e.message}</span>`}}else t.innerHTML='<span style="color:red;">‚ö†Ô∏è Selecione pelo menos um ficheiro Excel</span>'}function calcularPotenciaMaxima(){if(!DADOS_EREDES||!DADOS_EREDES.dadosBrutos)return;let e=0;DADOS_EREDES.dadosBrutos.forEach(t=>{t.Potencia_kW&&t.Potencia_kW>e&&(e=t.Potencia_kW)}),DADOS_EREDES.potenciaMaxima=e}function atualizarAnalisePotencia(){if(!DADOS_EREDES||!DADOS_EREDES.potenciaMaxima)return;const e=parseFloat(document.getElementById("potencia").value)||3.45;let t=DADOS_EREDES.potenciaMaxima;const o=document.getElementById("chk-trifasico")?.checked||!1;let a="";o&&(a=" (trif√°sico)");const i=e>0?t/e*100:0;document.getElementById("potencia-contratada-display").textContent=`${e} kVA`,document.getElementById("potencia-maxima-display").innerHTML=`${t.toFixed(3)} kW<span style="font-size: 0.75rem; color: #94a3b8;">${a}</span>`,document.getElementById("potencia-utilizacao-display").textContent=`${i.toFixed(1)} %`;const n=document.getElementById("potencia-maxima-legenda");n&&(n.innerHTML=o?'(M√©dias de 15 min) (estimativa para 3 fases)\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'Instala√ß√£o Trif√°sica\', \'Dado que √© uma instala√ß√£o trif√°sica, a pot√™ncia el√©trica √© distribu√≠da por tr√™s fases, sendo o valor da pot√™ncia m√°xima tomada a soma das tr√™s fases.\')" \n                        onmouseleave="hideTooltip()">\n                        </i>':"(M√©dias de 15 min)");let l="",s="#f1f5f9";i>100?(l=`üî¥ <strong>Aten√ß√£o:</strong> A sua Pot√™ncia M√°xima Registada (${t.toFixed(2)} kW) ultrapassa a sua pot√™ncia contratada. Considere aumentar a pot√™ncia.`,s="#fef2f2"):i>85?(l="‚úÖ <strong>Adequado:</strong> A sua pot√™ncia contratada parece bem dimensionada.",s="#f0fdf4"):i>60?(l="üí° <strong>Oportunidade de Poupan√ßa:</strong> A sua Pot√™ncia M√°xima Registada utiliza entre 60% e 85% da pot√™ncia contratada. Pode ser poss√≠vel reduzir a pot√™ncia.",s="#fffbeb"):(l="üí∞ <strong>Forte Oportunidade de Poupan√ßa:</strong> A sua Pot√™ncia M√°xima Registada utiliza menos de 60% da sua pot√™ncia contratada. √â muito prov√°vel que possa reduzir a pot√™ncia e poupar na fatura.",s="#fef3c7"),document.getElementById("potencia-recomendacao").style.background=s,document.getElementById("potencia-recomendacao").innerHTML=l}function gerarGraficoOMIEDiario(){const e=document.getElementById("d_inicio").value,t=document.getElementById("d_fim").value,o=document.getElementById("ciclo").value;if(!DATA.omie||0===DATA.omie.length)return;let a=getDataReferencia("Data_Valores_OMIE");a||(a=new Date),a.setHours(0,0,0,0);const i={S:"#FF0000",V:"#000000",F:"#FFC000",C:"#2F5597",P:"#00B050"},n={S:"circle",V:"diamond",F:"square",C:"triangle",P:"triangle-down"};let l="Simp",s=["S"],r={S:"Simples"};o.includes("Bi")?(l=o.includes("Di√°rio")?"BD":"BS",s=["V","F"],r={V:"Vazio",F:"Fora Vazio"}):o.includes("Tri")&&(l=o.includes("Di√°rio")?"TD":"TS",s=["V","C","P"],r={V:"Vazio",C:"Cheias",P:"Ponta"});const c={};DATA.omie.forEach(o=>{const a=parseDateFromDB(o.Data);if(!a||a<e||a>t)return;const i=parseFloat(String(o.OMIE).replace(",","."))||0;if(c[a]||(c[a]={S:{sum:0,count:0}},s.forEach(e=>{c[a][e]={sum:0,count:0}})),c[a].S.sum+=i,c[a].S.count++,"Simp"!==l){const e=o[l];e&&c[a][e]&&(c[a][e].sum+=i,c[a][e].count++)}});const d=Object.keys(c).sort(),u=d.map(e=>e.split("-").reverse().slice(0,2).join("/"));let m=[];("Simp"===l?["S"]:s).forEach(e=>{const t=[],o=[];d.forEach(i=>{const n=new Date(i);n.setHours(0,0,0,0);const l=c[i][e],s=l&&l.count>0?Math.round(l.sum/l.count*100)/100:null;n<=a?(t.push(s),o.push(null)):(t.push(null),o.push(s))});const l=i[e]||"#333",s=n[e]||"circle";m.push({name:r[e]+" Spot",data:t,color:l,type:"line",lineWidth:2,marker:{enabled:!0,symbol:s,radius:4,lineWidth:1,lineColor:l,fillColor:l},connectNulls:!1}),m.push({name:r[e]+" Futuros",data:o,color:l,dashStyle:"Dot",type:"line",lineWidth:2,marker:{enabled:!0,symbol:s,radius:4,lineWidth:2,lineColor:l,fillColor:"white"},connectNulls:!1,showInLegend:!0})}),"undefined"!=typeof Highcharts&&Highcharts.chart("chart-omie-diario",{chart:{zoomType:"x",height:350},title:{text:`Evolu√ß√£o Di√°ria OMIE/OMIP - ${o}`,align:"center"},subtitle:{text:"Linha cont√≠nua: Spot (OMIE) | Linha tracejada: Futuros (OMIP)",align:"center",style:{fontSize:"0.85rem",color:"#666"}},xAxis:{categories:u,crosshair:!0},yAxis:{title:{text:"Pre√ßo M√©dio (‚Ç¨/MWh)"},plotLines:[{value:0,width:1,color:"#cccccc"}]},legend:{enabled:!0,layout:"horizontal",align:"center",verticalAlign:"bottom",symbolRadius:0},tooltip:{shared:!0,valueSuffix:" ‚Ç¨/MWh",crosshairs:!0},plotOptions:{line:{connectNulls:!1,states:{hover:{lineWidthPlus:0}}}},series:m})}function getCicloInfo(e){const t=e.toLowerCase();let o=null,a=[],i="Simples",n=!0;t.includes("bi")?(n=t.includes("di√°rio"),o=n?"BD":"BS",a=["V","F"],i=n?"Bi-Hor√°rio - Ciclo Di√°rio":"Bi-Hor√°rio - Ciclo Semanal"):t.includes("tri")&&(n=t.includes("di√°rio"),o=n?"TD":"TS",a=["V","C","P"],i=n?"Tri-Hor√°rio - Ciclo Di√°rio":"Tri-Hor√°rio - Ciclo Semanal");return{colCiclo:o,periodos:a,tituloCiclo:i,nomesPeriodos:{V:"Vazio",F:"Fora Vazio",C:"Cheias",P:"Ponta"},coresConsumo:n?{V_bi:"#A9D18E",V_tri:"#BF9000",F:"#E2EFDA",C:"#FFE699",P:"#FFF2CC"}:{V_bi:"#8FAADC",V_tri:"#C55A11",F:"#DAE3F3",C:"#F4B183",P:"#FBE5D6"},coresOmie:{S:"#FF0000",V:"#000000",F:"#FFC000",C:"#2F5597",P:"#00B050"},isDiario:n,ohLower:t}}function classificarPeriodo(e,t){if(!t||!DATA.omieMap)return null;const o=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),n=String(e.getHours()).padStart(2,"0"),l=String(e.getMinutes()).padStart(2,"0");let s=DATA.omieMap.get(`${o}-${a}-${i}_${n}:${l}`);return s||"00"===l||(s=DATA.omieMap.get(`${o}-${a}-${i}_${n}:00`)),s&&s[t]?s[t]:null}function gerarGraficosAnaliseERedes(){if(!DADOS_EREDES||!DADOS_EREDES.dadosBrutos)return;const e=document.getElementById("ciclo").value,t=document.getElementById("d_inicio").value,o=document.getElementById("d_fim").value,a=DADOS_EREDES.dadosBrutos.filter(e=>{const a=e.DataHora.split("T")[0];return a>=t&&a<=o});0!==a.length&&(gerarGraficoHorario(a,e),gerarGraficoDiario(a,e),gerarGraficoSemana(a,e),gerarGraficoMensal(a,e))}function gerarGraficoHorario(e,t){const o=getCicloInfo(t),a={};for(let e=0;e<24;e++)a[e]={consumo:0,omieSum:0,omieCount:0},o.colCiclo&&o.periodos.forEach(t=>{a[e][t]={consumo:0,omieSum:0,omieCount:0}});e.forEach(e=>{const t=new Date(e.DataHora);let i=t.getHours();0===t.getMinutes()&&(i-=1),i<0&&(i=23);const n=e["Consumo (kWh)"];a[i].consumo+=n;const l=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0"),c=String(t.getHours()).padStart(2,"0"),d=String(t.getMinutes()).padStart(2,"0");let u=`${l}-${s}-${r}_${c}:${d}`,m=DATA.omieMap?.get(u);if(!m&&"00"===c&&"00"===d){const e=new Date(t);e.setMinutes(e.getMinutes()-1);const o=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}_23:59`;m=DATA.omieMap?.get(o)}const p=m&&parseFloat(String(m.OMIE).replace(",","."))||0;if(m&&(a[i].omieSum+=p,a[i].omieCount++),o.colCiclo&&m){const e=m[o.colCiclo];e&&a[i][e]&&(a[i][e].consumo+=n,a[i][e].omieSum+=p,a[i][e].omieCount++)}});const i=Array.from({length:24},(e,t)=>`${t}h-${t+1}h`),n=[];if(o.colCiclo)[...o.periodos].reverse().forEach(e=>{const t="V"===e&&o.ohLower.startsWith("tri")?"V_tri":"V"===e?"V_bi":e,i=Object.values(a).map(t=>{const o=t[e]?Math.round(100*t[e].consumo)/100:0,a=t[e]&&t[e].omieCount>0?t[e].omieCount:1;return{y:o,media:Math.round(o/a*100)/100}});n.push({name:`Consumo ${o.nomesPeriodos[e]} (kWh)`,type:"column",data:i,yAxis:0,color:o.coresConsumo[t]})});else{const t=e.length>0?new Set(e.map(e=>e.DataHora.split("T")[0])).size:1,o=Object.values(a).map(e=>({y:Math.round(100*e.consumo)/100,media:Math.round(e.consumo/Math.max(t,1)*100)/100}));n.push({name:"Consumo Total (kWh)",type:"column",data:o,yAxis:0,color:"#BFBFBF"})}n.push({name:"M√©dia OMIE (‚Ç¨/MWh)",type:"line",data:Object.values(a).map(e=>e.omieCount>0?Math.round(e.omieSum/e.omieCount*100)/100:null),yAxis:1,color:o.coresOmie.S,tooltip:{valueSuffix:" ‚Ç¨/MWh"}}),o.colCiclo&&o.periodos.forEach(e=>{n.push({name:`M√©dia OMIE ${o.nomesPeriodos[e]} (‚Ç¨/MWh)`,type:"line",data:Object.values(a).map(t=>t[e]&&t[e].omieCount>0?Math.round(t[e].omieSum/t[e].omieCount*100)/100:null),yAxis:1,color:o.coresOmie[e],visible:!1,tooltip:{valueSuffix:" ‚Ç¨/MWh"}})}),"undefined"!=typeof Highcharts&&Highcharts.chart("chart-horario",{chart:{zoomType:"xy"},title:{text:`Consumo e Pre√ßo M√©dio OMIE por Hora (${o.tituloCiclo})`,align:"left"},xAxis:[{categories:i,crosshair:!0}],yAxis:[{labels:{format:"{value} kWh"},title:{text:"Consumo (kWh)"}},{title:{text:"Pre√ßo OMIE (‚Ç¨/MWh)"},labels:{format:"{value} ‚Ç¨/MWh"},opposite:!0}],legend:{align:"left",verticalAlign:"top",y:40,floating:!0,backgroundColor:"white"},plotOptions:{column:{stacking:"normal"}},tooltip:{shared:!0,formatter:function(){let e="<b>"+this.x+"</b>",t=!1;return this.points.forEach(function(o){o.y>0&&(e+="<br/>"+o.series.name+": <b>"+o.y.toFixed(2)+"</b>",void 0!==o.point.options.media&&(e+=' <span style="font-size:0.9em">(M√©dia: '+o.point.options.media.toFixed(2)+")</span>")),"column"===o.series.type&&"normal"===o.series.options.stacking&&(t=!0)}),t&&void 0!==this.total&&this.total>0&&(e+="<br/>--------------------",e+="<br/><b>Total Consumo: "+this.total.toFixed(2)+" kWh</b>"),e}},series:n})}function gerarGraficoDiario(e,t){const o=getCicloInfo(t),a={};e.forEach(e=>{const t=e.DataHora.split("T")[0];a[t]||(a[t]={consumo:0,omieSum:0,omieCount:0},o.colCiclo&&o.periodos.forEach(e=>{a[t][e]={consumo:0,omieSum:0,omieCount:0}}));const i=e["Consumo (kWh)"];a[t].consumo+=i;const n=new Date(e.DataHora),l=String(n.getHours()).padStart(2,"0"),s=String(n.getMinutes()).padStart(2,"0"),r=DATA.omieMap?.get(`${t}_${l}:${s}`)||DATA.omieMap?.get(`${t}_${l}:00`);if(r){const e=parseFloat(String(r.OMIE).replace(",","."))||0;if(a[t].omieSum+=e,a[t].omieCount++,o.colCiclo){const n=r[o.colCiclo];n&&a[t][n]&&(a[t][n].consumo+=i,a[t][n].omieSum+=e,a[t][n].omieCount++)}}});const i=Object.keys(a).sort(),n=i.map(e=>e.split("-").reverse().slice(0,2).join("/")),l=[];o.colCiclo?[...o.periodos].reverse().forEach(e=>{const t="V"===e&&o.ohLower.startsWith("tri")?"V_tri":"V"===e?"V_bi":e,n=i.map(t=>{const o=a[t][e]?Math.round(100*a[t][e].consumo)/100:0;return{y:o,media:o}});l.push({name:`Consumo ${o.nomesPeriodos[e]} (kWh)`,type:"column",data:n,yAxis:0,color:o.coresConsumo[t]})}):l.push({name:"Consumo Total (kWh)",type:"column",data:i.map(e=>({y:Math.round(100*a[e].consumo)/100,media:Math.round(100*a[e].consumo)/100})),yAxis:0,color:"#BFBFBF"}),l.push({name:"M√©dia OMIE (‚Ç¨/MWh)",type:"line",data:i.map(e=>a[e].omieCount>0?Math.round(a[e].omieSum/a[e].omieCount*100)/100:null),yAxis:1,color:o.coresOmie.S,tooltip:{valueSuffix:" ‚Ç¨/MWh"}}),o.colCiclo&&o.periodos.forEach(e=>{l.push({name:`M√©dia OMIE ${o.nomesPeriodos[e]} (‚Ç¨/MWh)`,type:"line",data:i.map(t=>a[t][e]&&a[t][e].omieCount>0?Math.round(a[t][e].omieSum/a[t][e].omieCount*100)/100:null),yAxis:1,color:o.coresOmie[e],visible:!1,tooltip:{valueSuffix:" ‚Ç¨/MWh"}})}),"undefined"!=typeof Highcharts&&Highcharts.chart("chart-diario",{chart:{zoomType:"xy"},title:{text:`Consumo e Pre√ßo M√©dio OMIE Di√°rio (${o.tituloCiclo})`,align:"left"},xAxis:[{categories:n,crosshair:!0}],yAxis:[{labels:{format:"{value} kWh"},title:{text:"Consumo (kWh)"}},{title:{text:"M√©dia OMIE (‚Ç¨/MWh)"},labels:{format:"{value} ‚Ç¨/MWh"},opposite:!0}],legend:{align:"left",verticalAlign:"top",y:40,floating:!0,backgroundColor:"white"},plotOptions:{column:{stacking:"normal"}},tooltip:{shared:!0,formatter:function(){let e="<b>"+this.x+"</b>",t=!1;return this.points.forEach(function(o){o.y>0&&(e+="<br/>"+o.series.name+": <b>"+o.y.toFixed(2)+"</b>",void 0!==o.point.options.media&&(e+=' <span style="font-size:0.9em">(M√©dia: '+o.point.options.media.toFixed(2)+")</span>")),"column"===o.series.type&&"normal"===o.series.options.stacking&&(t=!0)}),t&&void 0!==this.total&&this.total>0&&(e+="<br/>--------------------",e+="<br/><b>Total Consumo: "+this.total.toFixed(2)+" kWh</b>"),e}},series:l})}function gerarGraficoSemana(e,t){const o=getCicloInfo(t),a={};for(let e=0;e<7;e++)a[e]={consumo:0,omieSum:0,omieCount:0,dias:new Set},o.colCiclo&&o.periodos.forEach(t=>{a[e][t]={consumo:0,omieSum:0,omieCount:0}});e.forEach(e=>{const t=new Date(e.DataHora),i=(t.getDay()+6)%7,n=e.DataHora.split("T")[0],l=e["Consumo (kWh)"];a[i].consumo+=l,a[i].dias.add(n);const s=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0"),c=DATA.omieMap?.get(`${n}_${s}:${r}`)||DATA.omieMap?.get(`${n}_${s}:00`);if(c){const e=parseFloat(String(c.OMIE).replace(",","."))||0;if(a[i].omieSum+=e,a[i].omieCount++,o.colCiclo){const t=c[o.colCiclo];t&&a[i][t]&&(a[i][t].consumo+=l,a[i][t].omieSum+=e,a[i][t].omieCount++)}}});const i=["Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado","Domingo"],n=[];if(o.colCiclo)[...o.periodos].reverse().forEach(e=>{const t="V"===e&&o.ohLower.startsWith("tri")?"V_tri":"V"===e?"V_bi":e,i=[];for(let t=0;t<7;t++){const o=a[t][e]?Math.round(100*a[t][e].consumo)/100:0,n=a[t].dias.size||1;i.push({y:o,media:Math.round(o/n*100)/100})}n.push({name:`Consumo ${o.nomesPeriodos[e]} (kWh)`,type:"column",data:i,yAxis:0,color:o.coresConsumo[t]})});else{const e=[];for(let t=0;t<7;t++){const o=Math.round(100*a[t].consumo)/100,i=a[t].dias.size||1;e.push({y:o,media:Math.round(o/i*100)/100})}n.push({name:"Consumo Total (kWh)",type:"column",data:e,yAxis:0,color:"#BFBFBF"})}n.push({name:"M√©dia OMIE (‚Ç¨/MWh)",type:"line",data:Array.from({length:7},(e,t)=>a[t].omieCount>0?Math.round(a[t].omieSum/a[t].omieCount*100)/100:null),yAxis:1,color:o.coresOmie.S,tooltip:{valueSuffix:" ‚Ç¨/MWh"}}),o.colCiclo&&o.periodos.forEach(e=>{n.push({name:`M√©dia OMIE ${o.nomesPeriodos[e]} (‚Ç¨/MWh)`,type:"line",data:Array.from({length:7},(t,o)=>a[o][e]&&a[o][e].omieCount>0?Math.round(a[o][e].omieSum/a[o][e].omieCount*100)/100:null),yAxis:1,color:o.coresOmie[e],visible:!1,tooltip:{valueSuffix:" ‚Ç¨/MWh"}})}),"undefined"!=typeof Highcharts&&Highcharts.chart("chart-semana",{chart:{zoomType:"xy"},title:{text:`Consumo e Pre√ßo M√©dio OMIE por Dia da Semana (${o.tituloCiclo})`,align:"left"},xAxis:[{categories:i,crosshair:!0}],yAxis:[{labels:{format:"{value} kWh"},title:{text:"Consumo Total (kWh)"}},{title:{text:"M√©dia OMIE (‚Ç¨/MWh)"},labels:{format:"{value} ‚Ç¨/MWh"},opposite:!0}],legend:{align:"left",verticalAlign:"top",y:40,floating:!0,backgroundColor:"white"},plotOptions:{column:{stacking:"normal"}},tooltip:{shared:!0,formatter:function(){let e="<b>"+this.x+"</b>",t=!1;return this.points.forEach(function(o){o.y>0&&(e+="<br/>"+o.series.name+": <b>"+o.y.toFixed(2)+"</b>",void 0!==o.point.options.media&&(e+=' <span style="font-size:0.9em">(M√©dia: '+o.point.options.media.toFixed(2)+")</span>")),"column"===o.series.type&&"normal"===o.series.options.stacking&&(t=!0)}),t&&void 0!==this.total&&this.total>0&&(e+="<br/>--------------------",e+="<br/><b>Total Consumo: "+this.total.toFixed(2)+" kWh</b>"),e}},series:n})}function gerarGraficoMensal(e,t){const o=getCicloInfo(t),a={};e.forEach(e=>{const t=e.DataHora.split("T")[0].split("-"),i=`${t[0]}-${t[1]}`;a[i]||(a[i]={consumo:0,omieSum:0,omieCount:0},o.colCiclo&&o.periodos.forEach(e=>{a[i][e]={consumo:0,omieSum:0,omieCount:0}}));const n=e["Consumo (kWh)"];a[i].consumo+=n;const l=new Date(e.DataHora),s=String(l.getHours()).padStart(2,"0"),r=String(l.getMinutes()).padStart(2,"0"),c=e.DataHora.split("T")[0],d=DATA.omieMap?.get(`${c}_${s}:${r}`)||DATA.omieMap?.get(`${c}_${s}:00`);if(d){const e=parseFloat(String(d.OMIE).replace(",","."))||0;if(a[i].omieSum+=e,a[i].omieCount++,o.colCiclo){const t=d[o.colCiclo];t&&a[i][t]&&(a[i][t].consumo+=n,a[i][t].omieSum+=e,a[i][t].omieCount++)}}});const i=Object.keys(a).sort(),n=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"],l=i.map(e=>{const t=e.split("-"),o=t[0],a=parseInt(t[1])-1;return`${n[a]} ${o}`}),s=[];o.colCiclo?[...o.periodos].reverse().forEach(e=>{const t="V"===e&&o.ohLower.startsWith("tri")?"V_tri":"V"===e?"V_bi":e,n=i.map(t=>{const o=a[t][e]?Math.round(100*a[t][e].consumo)/100:0;return{y:o,media:o}});s.push({name:`Consumo ${o.nomesPeriodos[e]} (kWh)`,type:"column",data:n,yAxis:0,color:o.coresConsumo[t]})}):s.push({name:"Consumo Total (kWh)",type:"column",data:i.map(e=>({y:Math.round(100*a[e].consumo)/100,media:Math.round(100*a[e].consumo)/100})),yAxis:0,color:"#BFBFBF"}),s.push({name:"M√©dia OMIE (‚Ç¨/MWh)",type:"line",data:i.map(e=>a[e].omieCount>0?Math.round(a[e].omieSum/a[e].omieCount*100)/100:null),yAxis:1,color:o.coresOmie.S,tooltip:{valueSuffix:" ‚Ç¨/MWh"}}),o.colCiclo&&o.periodos.forEach(e=>{s.push({name:`M√©dia OMIE ${o.nomesPeriodos[e]} (‚Ç¨/MWh)`,type:"line",data:i.map(t=>a[t][e]&&a[t][e].omieCount>0?Math.round(a[t][e].omieSum/a[t][e].omieCount*100)/100:null),yAxis:1,color:o.coresOmie[e],visible:!1,tooltip:{valueSuffix:" ‚Ç¨/MWh"}})}),"undefined"!=typeof Highcharts&&Highcharts.chart("chart-mensal",{chart:{zoomType:"xy"},title:{text:`Consumo Mensal vs. Pre√ßo M√©dio OMIE (${o.tituloCiclo})`,align:"left"},xAxis:[{categories:l,crosshair:!0}],yAxis:[{labels:{format:"{value} kWh"},title:{text:"Consumo Total (kWh)"}},{title:{text:"M√©dia Mensal OMIE (‚Ç¨/MWh)"},labels:{format:"{value} ‚Ç¨/MWh"},opposite:!0}],legend:{align:"left",verticalAlign:"top",y:40,floating:!0,backgroundColor:"white"},plotOptions:{column:{stacking:"normal"}},tooltip:{shared:!0,formatter:function(){let e="<b>"+this.x+"</b>",t=!1;return this.points.forEach(function(o){o.y>0&&(e+="<br/>"+o.series.name+": <b>"+o.y.toFixed(2)+"</b>"),"column"===o.series.type&&"normal"===o.series.options.stacking&&(t=!0)}),t&&void 0!==this.total&&this.total>0&&(e+="<br/>--------------------",e+="<br/><b>Total Consumo: "+this.total.toFixed(2)+" kWh</b>"),e}},series:s})}function mostrarTabelaAnaliseERedes(){if(!DADOS_EREDES)return;const e=document.getElementById("analise-content"),t=document.getElementById("analise-consumos");if(!e||!t)return;t.style.display="block";const o=DADOS_EREDES.consumosAgregados,a=DADOS_EREDES.mediasOMIE||{};let i='\n            <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">\n                <thead>\n                    <tr style="background: #f8fafc;">\n                        <th style="padding: 10px; border: 1px solid #e2e8f0; text-align: left;">Per√≠odo</th>\n                        <th style="padding: 10px; border: 1px solid #e2e8f0; text-align: right;">Consumo (kWh)</th>\n                        <th style="padding: 10px; border: 1px solid #e2e8f0; text-align: right;">% Total</th>\n                        <th style="padding: 10px; border: 1px solid #e2e8f0; text-align: right;">M√©dia OMIE (‚Ç¨/MWh)</th>\n                    </tr>\n                </thead>\n                <tbody>\n            ';const n=o.Simples||0;if(i+=`<tr style="background: #f9f9f9; font-weight: 600;">\n                <td style="padding: 8px; border: 1px solid #e2e8f0;">Total (Simples)</td>\n                <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${n.toFixed(2)}</td>\n                <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">100%</td>\n                <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${(a.S||0).toFixed(2)}</td>\n            </tr>`,o.BD&&(o.BD.V||o.BD.F)){const e=o.BD.V||0,t=o.BD.F||0;i+=`\n                <tr><td colspan="4" style="padding: 8px; border: 1px solid #e2e8f0; background: #A9D08E; font-weight: 600;">Bi-Hor√°rio Di√°rio</td></tr>\n                <tr>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; padding-left: 20px;">Vazio</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${e.toFixed(2)}</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${n>0?(e/n*100).toFixed(1):0}%</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${(a.BD_V||0).toFixed(2)}</td>\n                </tr>\n                <tr>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; padding-left: 20px;">Fora Vazio</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${t.toFixed(2)}</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${n>0?(t/n*100).toFixed(1):0}%</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${(a.BD_F||0).toFixed(2)}</td>\n                </tr>`}if(o.TD&&(o.TD.V||o.TD.C||o.TD.P)){const e=o.TD.V||0,t=o.TD.C||0,l=o.TD.P||0;i+=`\n                <tr><td colspan="4" style="padding: 8px; border: 1px solid #e2e8f0; background: #BF8F00; color: white; font-weight: 600;">Tri-Hor√°rio Di√°rio</td></tr>\n                <tr>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; padding-left: 20px;">Vazio</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${e.toFixed(2)}</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${n>0?(e/n*100).toFixed(1):0}%</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${(a.TD_V||0).toFixed(2)}</td>\n                </tr>\n                <tr>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; padding-left: 20px;">Cheias</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${t.toFixed(2)}</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${n>0?(t/n*100).toFixed(1):0}%</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${(a.TD_C||0).toFixed(2)}</td>\n                </tr>\n                <tr>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; padding-left: 20px;">Ponta</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${l.toFixed(2)}</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${n>0?(l/n*100).toFixed(1):0}%</td>\n                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${(a.TD_P||0).toFixed(2)}</td>\n                </tr>`}i+="</tbody></table>",e.innerHTML=i}function autoCollapse(e){setTimeout(()=>{const t=document.getElementById("content-"+e),o=document.getElementById("icon-"+e);t.classList.contains("collapsed")||(t.classList.add("collapsed"),o.className="fa-solid fa-chevron-right")},800)}function getDefaultDates(){const e=new Date,t=new Date(e);t.setDate(e.getDate()+1);const o=new Date(t),a=t.getDate();return o.setMonth(o.getMonth()+1),o.getDate()!==a&&o.setDate(0),o.setDate(o.getDate()-1),{start:getYMD(t),end:getYMD(o)}}const DB_NAME="SimuladorTarifarios",DB_STORE="cache",CACHE_KEY="tarifarios_xlsx",CACHE_DURATION=432e5;function openCacheDB(){return new Promise((e,t)=>{const o=indexedDB.open(DB_NAME,1);o.onupgradeneeded=e=>e.target.result.createObjectStore("cache"),o.onsuccess=t=>e(t.target.result),o.onerror=()=>t()})}async function getCachedData(){try{const e=await openCacheDB();return new Promise(t=>{const o=e.transaction("cache","readonly").objectStore("cache").get(CACHE_KEY);o.onsuccess=()=>{const e=o.result;e&&e.timestamp&&Date.now()-e.timestamp<432e5?t(e.data):t(null)},o.onerror=()=>t(null)})}catch(e){return null}}async function setCachedData(e){try{const t=await openCacheDB();t.transaction("cache","readwrite").objectStore("cache").put({data:e,timestamp:Date.now()},CACHE_KEY)}catch(e){}}function setLoaderMsg(e){const t=document.getElementById("loader-msg");t&&(t.textContent=e)}function lerArquivoManual(e){const t=e.files[0];if(t){const e=new FileReader;e.onload=e=>loadData(e.target.result),e.readAsArrayBuffer(t)}}function getKeyDate(e){return parseDateFromDB(e)||"INVALID"}function getKeyTime(e){if(null==e)return"00:00";if("number"==typeof e){const t=Math.round(24*e*60),o=Math.floor(t/60),a=t%60;return`${String(o).padStart(2,"0")}:${String(a).padStart(2,"0")}`}const t=String(e).trim().split(":");if(t.length>=2){return`${t[0].padStart(2,"0")}:${t[1].padStart(2,"0")}`}return"00:00"}function loadData(e){const t=XLSX.read(e,{type:"array"});t.Sheets.Constantes&&XLSX.utils.sheet_to_json(t.Sheets.Constantes).forEach(e=>{DATA.constantes[e.constante]=e.valor_unit√°rio}),DATA.fixos=XLSX.utils.sheet_to_json(t.Sheets.Tarifarios_Fixos||t.Sheets[t.SheetNames[0]]),t.Sheets.Indexados&&(DATA.indexados=XLSX.utils.sheet_to_json(t.Sheets.Indexados)),t.Sheets.OMIE_PERDAS_CICLOS&&(DATA.omie=XLSX.utils.sheet_to_json(t.Sheets.OMIE_PERDAS_CICLOS,{raw:!1}),DATA.omieMap=new Map,DATA.omie.forEach(e=>{const t=parseDateFromDB(e.Data);let o="00:00";if("number"==typeof e.Hora){const t=Math.round(1440*e.Hora);o=`${Math.floor(t/60).toString().padStart(2,"0")}:${(t%60).toString().padStart(2,"0")}`}else if(e.Hora){const t=String(e.Hora).trim().split(":");t.length>=2&&(o=`${t[0].padStart(2,"0")}:${t[1].padStart(2,"0")}`)}t&&DATA.omieMap.set(`${t}_${o}`,e)})),t.Sheets.Perdas&&XLSX.utils.sheet_to_json(t.Sheets.Perdas).forEach(e=>{DATA.perdas[e.coluna]=e.valor}),document.getElementById("loader").classList.add("hidden"),document.getElementById("tabs-wrapper").classList.remove("hidden"),document.getElementById("tab-quick").classList.remove("hidden"),atualizarMenusCiclo(),populateProviderFilters(),populateProviderFiltersAbas();const o=getDefaultDates();STATE_ABA2.dataInicio=o.start,STATE_ABA2.dataFim=o.end,runQuickSimulation(),atualizarDatasReferencia(),aplicarParametrosPartilha()&&setTimeout(()=>aplicarSharedParamsDepoisDeCarregar(),500)}function atualizarDias(){const e=new Date(document.getElementById("d_inicio").value),t=new Date(document.getElementById("d_fim").value);if(e&&t){const o=Math.floor((t-e)/864e5)+1;document.getElementById("num_dias").value=o>0?o:0,DATA.fixos.length>0&&calcular()}}function getOmieAvg(e,t){const o=document.getElementById("d_inicio").value,a=document.getElementById("d_fim").value;let i=0,n=0;return DATA.omie.forEach(l=>{const s=parseDateFromDB(l.Data);if(s&&s>=o&&s<=a&&l[e]==t){const e=parseFloat(String(l.OMIE).replace(",","."));isNaN(e)||(i+=e,n++)}}),n?i/n:0}function atualizarMenusCiclo(){const e=parseFloat(document.getElementById("potencia").value),t=document.getElementById("ciclo");t.innerHTML="";(e<=20.7?["Simples","Bi-hor√°rio - Ciclo Di√°rio","Bi-hor√°rio - Ciclo Semanal","Tri-hor√°rio - Ciclo Di√°rio","Tri-hor√°rio - Ciclo Semanal"]:["Tri-hor√°rio > 20.7 kVA - Ciclo Di√°rio","Tri-hor√°rio > 20.7 kVA - Ciclo Semanal"]).forEach(e=>t.add(new Option(e,e))),construirInputsConsumo()}function construirInputsConsumo(){const e=document.getElementById("ciclo").value,t=document.getElementById("content-consumo");if(e.includes("Simples")?t.innerHTML='<div class="input-group"><label>Simples</label><input type="number" id="kwh_S" value="158" oninput="calcular()"></div>':e.includes("Bi")?t.innerHTML='<div class="input-group"><label>Vazio</label><input type="number" id="kwh_V" value="63" oninput="calcular()"></div>\n                                 <div class="input-group"><label>Fora Vazio</label><input type="number" id="kwh_F" value="95" oninput="calcular()"></div>':t.innerHTML='<div class="input-group"><label>Vazio</label><input type="number" id="kwh_V" value="63" oninput="calcular()"></div>\n                                 <div class="input-group"><label>Ponta</label><input type="number" id="kwh_P" value="27" oninput="calcular()"></div>\n                                 <div class="input-group"><label>Cheias</label><input type="number" id="kwh_C" value="68" oninput="calcular()"></div>',"advanced"===CURRENT_TAB&&DADOS_EREDES&&DADOS_EREDES.consumosAgregados){aplicarDadosERedes();const t=DADOS_EREDES.mediasOMIE;e.includes("Bi-hor√°rio")&&e.includes("Di√°rio")?(OMIE_VALUES.V=t.BD_V||t.S,OMIE_VALUES.F=t.BD_F||t.S):e.includes("Bi-hor√°rio")&&e.includes("Semanal")?(OMIE_VALUES.V=t.BS_V||t.S,OMIE_VALUES.F=t.BS_F||t.S):e.includes("Tri-hor√°rio")&&e.includes("Di√°rio")?(OMIE_VALUES.V=t.TD_V||t.S,OMIE_VALUES.C=t.TD_C||t.S,OMIE_VALUES.P=t.TD_P||t.S):e.includes("Tri-hor√°rio")&&e.includes("Semanal")&&(OMIE_VALUES.V=t.TS_V||t.S,OMIE_VALUES.C=t.TS_C||t.S,OMIE_VALUES.P=t.TS_P||t.S)}toggleMeuTarifario();const o=document.getElementById("pers_ativo");o&&o.checked&&toggleTarifarioPersonalizado(),controlarVisibilidadeModoComparacao(),calcular()}function controlarVisibilidadeModoComparacao(){const e=document.getElementById("ciclo").value,t=document.getElementById("content-comparacao"),o=t?t.previousElementSibling:null;if("advanced"===CURRENT_TAB)return t&&(t.style.display="block"),void(o&&(o.style.display="block"));if(e.includes("Simples")){t&&(t.style.display="none"),o&&(o.style.display="none");const e=document.getElementById("modo_comparacao");e&&(e.checked=!1)}else t&&(t.style.display="block"),o&&(o.style.display="block")}function calcularPerdasDinamicas(e,t,o){if(DATA.perdas={},!DATA.omie||0===DATA.omie.length)return;const a=e=>`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`,i=a(e),n=a(t);let l=DATA.omie.filter(e=>{const t=String(e.Data),o=t.includes("/")?t.split("/"):null;if(!o||3!==o.length)return!1;const a=`${o[2]}-${o[0].padStart(2,"0")}-${o[1].padStart(2,"0")}`;return a>=i&&a<=n});const s=e.getFullYear(),r=t.getFullYear();let c=DATA.omie.filter(e=>{const t=String(e.Data),o=t.includes("/")?t.split("/"):null;if(!o||3!==o.length)return!1;const a=parseInt(o[2]);return a>=s&&a<=r});if(l.length>0){let e=0,t=0;l.forEach(o=>{let a=parseFloat(String(o.Perdas||"0").replace(",","."));!isNaN(a)&&a>0&&(e+=a,t++)}),t>0&&(DATA.perdas.Perdas_M_S=e/t),["BD","BS","TD","TS"].forEach(e=>{("BD"===e||"BS"===e?["V","F"]:["V","C","P"]).forEach(t=>{let o=0,a=0;l.forEach(i=>{if(i[e]===t){let e=parseFloat(String(i.Perdas||"0").replace(",","."));!isNaN(e)&&e>0&&(o+=e,a++)}}),DATA.perdas[`Perdas_M_${e}_${t}`]=a>0?o/a:DATA.perdas.Perdas_M_S||1.16})})}if(c.length>0){let e=0,t=0;c.forEach(o=>{let a=parseFloat(String(o.Perdas||"0").replace(",","."));!isNaN(a)&&a>0&&(e+=a,t++)}),t>0&&(DATA.perdas.Perdas_Anual_S=e/t),["BD","BS","TD","TS"].forEach(e=>{("BD"===e||"BS"===e?["V","F"]:["V","C","P"]).forEach(t=>{let o=0,a=0;c.forEach(i=>{if(i[e]===t){let e=parseFloat(String(i.Perdas||"0").replace(",","."));!isNaN(e)&&e>0&&(o+=e,a++)}}),DATA.perdas[`Perdas_Anual_${e}_${t}`]=a>0?o/a:DATA.perdas.Perdas_Anual_S||1})})}}function construirInputsOMIE(e){const t=document.getElementById("omie-inputs");let o="";o=e.includes("Simples")?`<div><label style="font-size:0.7rem;">Simples</label><input type="number" class="omie-input" id="omie_S" value="${OMIE_VALUES.S.toFixed(2)}" step="0.01" oninput="atualizarOMIE()"></div>`:e.includes("Bi")?`<div><label style="font-size:0.7rem;">Vazio</label><input type="number" class="omie-input" id="omie_V" value="${OMIE_VALUES.V.toFixed(2)}" step="0.01" oninput="atualizarOMIE()"></div>\n                        <div><label style="font-size:0.7rem;">F. Vazio</label><input type="number" class="omie-input" id="omie_F" value="${OMIE_VALUES.F.toFixed(2)}" step="0.01" oninput="atualizarOMIE()"></div>`:`<div><label style="font-size:0.7rem;">Vazio</label><input type="number" class="omie-input" id="omie_V" value="${OMIE_VALUES.V.toFixed(2)}" step="0.01" oninput="atualizarOMIE()"></div>\n                        <div><label style="font-size:0.7rem;">Ponta</label><input type="number" class="omie-input" id="omie_P" value="${OMIE_VALUES.P.toFixed(2)}" step="0.01" oninput="atualizarOMIE()"></div>\n                        <div><label style="font-size:0.7rem;">Cheias</label><input type="number" class="omie-input" id="omie_C" value="${OMIE_VALUES.C.toFixed(2)}" step="0.01" oninput="atualizarOMIE()"></div>`,t.innerHTML=o}function atualizarOMIE(){OMIE_MANUAL=!0,document.getElementById("omie_S")&&(OMIE_VALUES.S=parseFloat(document.getElementById("omie_S").value)||0),document.getElementById("omie_V")&&(OMIE_VALUES.V=parseFloat(document.getElementById("omie_V").value)||0),document.getElementById("omie_F")&&(OMIE_VALUES.F=parseFloat(document.getElementById("omie_F").value)||0),document.getElementById("omie_P")&&(OMIE_VALUES.P=parseFloat(document.getElementById("omie_P").value)||0),document.getElementById("omie_C")&&(OMIE_VALUES.C=parseFloat(document.getElementById("omie_C").value)||0);let e=document.getElementById("ciclo").value,t="";t=e.includes("Simples")?`S: ${OMIE_VALUES.S.toFixed(2)}`:e.includes("Bi")?`V: ${OMIE_VALUES.V.toFixed(2)} | F: ${OMIE_VALUES.F.toFixed(2)}`:`V: ${OMIE_VALUES.V.toFixed(2)} | P: ${OMIE_VALUES.P.toFixed(2)} | C: ${OMIE_VALUES.C.toFixed(2)}`,document.getElementById("omie-display").innerText=t,calcular()}function toggleMeuTarifario(){const e=document.getElementById("meu_ativo").checked,t=document.getElementById("meu-inputs"),o=document.getElementById("ciclo").value;if(!e)return t.classList.add("hidden"),void calcular();t.classList.remove("hidden");let a="";a=o.includes("Simples")?'<div class="input-group"><label>Pre√ßo Simples <span class="label-units">(‚Ç¨/kWh)</span></label><input type="number" id="meu_S" value="0.1654" step="0.0001" oninput="calcular()"></div>':o.includes("Bi")?'<div class="input-group"><label>Vazio <span class="label-units">(‚Ç¨/kWh)</span></label><input type="number" id="meu_V" value="0.1087" step="0.0001" oninput="calcular()"></div>\n                        <div class="input-group"><label>Fora Vazio <span class="label-units">(‚Ç¨/kWh)</span></label><input type="number" id="meu_F" value="0.1988" step="0.0001" oninput="calcular()"></div>':'<div class="input-group"><label>Vazio <span class="label-units">(‚Ç¨/kWh)</span></label><input type="number" id="meu_V" value="0.1087" step="0.0001" oninput="calcular()"></div>\n                        <div class="input-group"><label>Cheias <span class="label-units">(‚Ç¨/kWh)</span></label><input type="number" id="meu_C" value="0.1690" step="0.0001" oninput="calcular()"></div>\n                        <div class="input-group"><label>Ponta <span class="label-units">(‚Ç¨/kWh)</span></label><input type="number" id="meu_P" value="0.2495" step="0.0001" oninput="calcular()"></div>',a+='<div class="input-group"><label>Pot√™ncia <span class="label-units">(‚Ç¨/dia)</span></label><input type="number" id="meu_pot" value="0.1917" step="0.0001" oninput="calcular()"></div>\n                     <div class="input-group"><label class="checkbox-label"><input type="checkbox" id="meu_tar_en_incl" checked onchange="calcular()"> TAR inclu√≠da na Energia\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'TAR inclu√≠da na Energia\', \'√â muito importante saber se os valores t√™m ou n√£o as TAR (Tarifas de Acesso √†s Redes). Alguns comercializadores separam na fatura, outros n√£o. Verifique se h√° alguma refer√™ncia a Acesso √†s Redes na fatura em (‚Ç¨/kWh)\')" \n                        onmouseleave="hideTooltip()"></i></label></div>\n                     <div class="input-group"><label class="checkbox-label"><input type="checkbox" id="meu_tar_pot_incl" checked onchange="calcular()"> TAR inclu√≠da na Pot√™ncia\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'TAR inclu√≠da na Pot√™ncia\', \'√â muito importante saber se os valores t√™m ou n√£o as TAR (Tarifas de Acesso √†s Redes). Alguns comercializadores separam na fatura, outros n√£o. Verifique se h√° alguma refer√™ncia a Acesso √†s Redes na fatura em (‚Ç¨/dia)\')" \n                        onmouseleave="hideTooltip()"></i></label></div>\n                     <div class="input-group"><label class="checkbox-label"><input type="checkbox" id="meu_tse_incl" checked onchange="calcular()"> Inclui Financiamento TSE\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'Inclui Financiamento TSE\', \'√â importante saber se os valores t√™m ou n√£o incluido o financiamento da Tarifa Social de Eletricidade (TSE). Alguns comercializadores separam na fatura, outros n√£o. Verifique se h√° alguma refer√™ncia a Financiamento Tarifa Social na fatura em (‚Ç¨/kWh)\')" \n                        onmouseleave="hideTooltip()"></i></label></div>\n                     <div class="input-group"><label>Desc. Energia (%)\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'Desconto Energia\', \'O desconto √© aplicado a Energia+TAR. Alguns tarif√°rios n√£o aplicam o desconto nas TAR (por exemplo os da Plenitude), pelo que o desconto n√£o pode ser aqui aplicado. Se n√£o tiver, n√£o necessita preencher!\')" \n                        onmouseleave="hideTooltip()"></i></label><input type="number" id="meu_desc_en" value="0" step="0.1" oninput="calcular()"></div>\n                     <div class="input-group"><label>Desc. Pot√™ncia (%)\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'Desconto Pot√™ncia\', \'O desconto √© aplicado a Pot√™ncia+TAR. Alguns tarif√°rios n√£o aplicam o desconto nas TAR, pelo que se assim for, o desconto n√£o pode ser aqui aplicado. Se n√£o tiver, n√£o necessita preencher!\')" \n                        onmouseleave="hideTooltip()"></i></label><input type="number" id="meu_desc_pot" value="0" step="0.1" oninput="calcular()"></div>\n                     <div class="input-group"><label>Desc. Fatura (‚Ç¨)\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'Desconto Fatura\', \'Se n√£o tiver, n√£o necessita preencher!\')" \n                        onmouseleave="hideTooltip()"></i></label><input type="number" id="meu_desc_fat" value="0" step="0.01" oninput="calcular()"></div>\n                     <div class="input-group"><label>Acr√©s. Fatura (‚Ç¨)\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'Acr√©scimo Fatura\', \'Para outros custos fixos na fatura. Se n√£o tiver, n√£o necessita preencher!\')" \n                        onmouseleave="hideTooltip()"></i></label><input type="number" id="meu_acres_fat" value="0" step="0.01" oninput="calcular()"></div>',t.innerHTML=a,calcular()}function toggleTarifarioPersonalizado(){const e=document.getElementById("pers_ativo").checked,t=document.getElementById("pers-inputs"),o=document.getElementById("ciclo").value,a=parseFloat(document.getElementById("potencia").value);if(!e)return t.classList.add("hidden"),void calcular();t.classList.remove("hidden");let i="";(o.includes("Simples")||o.includes("Bi")||o.includes("Tri")&&a<=20.7)&&(i+='\n                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #dee2e6;">\n                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.85rem; color: #495057;">Estrutura Simples Personalizada</div>\n                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">\n                        <div class="input-group" style="margin-bottom: 0;">\n                            <label style="font-size: 0.75rem;">Pre√ßo Energia Simples <span class="label-units">(‚Ç¨/kWh)</span></label>\n                            <input type="number" id="pers_energia_s" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">\n                        </div>\n                        <div class="input-group" style="margin-bottom: 0;">\n                            <label style="font-size: 0.75rem;">Pre√ßo Pot√™ncia Simples <span class="label-units">(‚Ç¨/dia)</span></label>\n                            <input type="number" id="pers_potencia_s" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">\n                        </div>\n                    </div>\n                </div>'),(o.includes("Bi")||o.includes("Tri")&&a<=20.7)&&(i+='\n                <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #a5d6a7;">\n                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.85rem; color: #2e7d32;">Estrutura Bi-Hor√°ria Personalizada</div>\n                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">\n                        <div class="input-group" style="margin-bottom: 0;">\n                            <label style="font-size: 0.75rem;">Pre√ßo Vazio Bi-Hor√°rio <span class="label-units">(‚Ç¨/kWh)</span></label>\n                            <input type="number" id="pers_energia_v_bi" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">\n                        </div>\n                        <div class="input-group" style="margin-bottom: 0;">\n                            <label style="font-size: 0.75rem;">Pre√ßo Fora Vazio Bi-Hor√°rio <span class="label-units">(‚Ç¨/kWh)</span></label>\n                            <input type="number" id="pers_energia_f_bi" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">\n                        </div>\n                        <div class="input-group" style="margin-bottom: 0;">\n                            <label style="font-size: 0.75rem;">Pre√ßo Pot√™ncia Bi-Hor√°rio <span class="label-units">(‚Ç¨/dia)</span></label>\n                            <input type="number" id="pers_potencia_bi" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">\n                        </div>\n                    </div>\n                </div>'),o.includes("Tri")&&(i+='\n                <div style="background: #fff3e0; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ffb74d;">\n                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.85rem; color: #e65100;">Estrutura Tri-Hor√°ria Personalizada</div>\n                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">\n                        <div class="input-group" style="margin-bottom: 0;">\n                            <label style="font-size: 0.75rem;">Pre√ßo Vazio Tri-Hor√°rio <span class="label-units">(‚Ç¨/kWh)</span></label>\n                            <input type="number" id="pers_energia_v_tri" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">\n                        </div>\n                        <div class="input-group" style="margin-bottom: 0;">\n                            <label style="font-size: 0.75rem;">Pre√ßo Cheias Tri-Hor√°rio <span class="label-units">(‚Ç¨/kWh)</span></label>\n                            <input type="number" id="pers_energia_c_tri" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">\n                        </div>\n                        <div class="input-group" style="margin-bottom: 0;">\n                            <label style="font-size: 0.75rem;">Pre√ßo Ponta Tri-Hor√°rio <span class="label-units">(‚Ç¨/kWh)</span></label>\n                            <input type="number" id="pers_energia_p_tri" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">\n                        </div>\n                        <div class="input-group" style="margin-bottom: 0;">\n                            <label style="font-size: 0.75rem;">Pre√ßo Pot√™ncia Tri-Hor√°rio <span class="label-units">(‚Ç¨/dia)</span></label>\n                            <input type="number" id="pers_potencia_tri" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">\n                        </div>\n                    </div>\n                </div>'),i+='\n            <div style="background: #f0f4ff; padding: 10px; border-radius: 8px; border: 1px solid #c5d9f7;">\n                <div style="font-weight: 600; margin-bottom: 6px; font-size: 0.8rem; color: #1e40af;">Op√ß√µes Comuns</div>\n                <div class="input-group" style="margin-bottom: 4px;">\n                    <label class="checkbox-label" style="font-size: 0.75rem;">\n                        <input type="checkbox" id="pers_tar_energia" checked onchange="calcular()"> TAR inclu√≠da na Energia?\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'TAR inclu√≠da na Energia?\', \'√â muito importante saber se os valores t√™m ou n√£o as TAR (Tarifas de Acesso √†s Redes). Alguns comercializadores separam na fatura, outros n√£o. Verifique se h√° alguma refer√™ncia a Acesso √†s Redes na fatura em (‚Ç¨/kWh)\')" \n                        onmouseleave="hideTooltip()"></i></label></div>\n                <div class="input-group" style="margin-bottom: 4px;">\n                    <label class="checkbox-label" style="font-size: 0.75rem;">\n                        <input type="checkbox" id="pers_tar_potencia" checked onchange="calcular()"> TAR inclu√≠da na Pot√™ncia?\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'TAR inclu√≠da na Pot√™ncia\', \'√â muito importante saber se os valores t√™m ou n√£o as TAR (Tarifas de Acesso √†s Redes). Alguns comercializadores separam na fatura, outros n√£o. Verifique se h√° alguma refer√™ncia a Acesso √†s Redes na fatura em (‚Ç¨/dia)\')" \n                        onmouseleave="hideTooltip()"></i></label></div>\n                <div class="input-group" style="margin-bottom: 0;">\n                    <label class="checkbox-label" style="font-size: 0.75rem;">\n                        <input type="checkbox" id="pers_tse_incluido" checked onchange="calcular()"> Inclui Financiamento TSE?\n                        <i class="fa-solid fa-circle-question" style="color: var(--text-light); cursor: help; margin-left: 4px;" \n                        onmouseenter="showTooltipNome(event, \'Inclui Financiamento TSE\', \'√â importante saber se os valores t√™m ou n√£o incluido o financiamento da Tarifa Social de Eletricidade (TSE). Alguns comercializadores separam na fatura, outros n√£o. Verifique se h√° alguma refer√™ncia a Financiamento Tarifa Social na fatura em (‚Ç¨/kWh)\')" \n                        onmouseleave="hideTooltip()"></i></label></div>\n                </div>\n            </div>',t.innerHTML=i,calcular()}function getVal(e,t,o){if(Array.isArray(t)){for(let o of t)if(void 0!==e[o])return parse(e[o]);return 0}return parse(e[o[t]]||e[t])}function parse(e){return null==e?0:"string"==typeof e?parseFloat(e.replace(",",".").replace("‚Ç¨","").trim())||0:"number"==typeof e?e:0}function parseBool(e){if(null!=e){if("boolean"==typeof e)return e;if("string"==typeof e){const t=e.toLowerCase().trim();if("true"===t||"sim"===t||"yes"===t||"1"===t)return!0;if("false"===t||"n√£o"===t||"nao"===t||"no"===t||"0"===t)return!1}}}function getConst(e){return parseFloat(DATA.constantes[e])||0}function getPerdas(e){return parseFloat(DATA.perdas[e])||1}function obter_perfil(e,t,o){if(t<=0)return"BTN_C";return o>13.8?"BTN_A":365*e/t>7140?"BTN_B":"BTN_C"}function calculateDetailedQH(e,t,o,a){let i="Simp";a.includes("Bi")&&(i=a.includes("Di√°rio")?"BD":"BS"),a.includes("Tri")&&(i=a.includes("Di√°rio")?"TD":"TS");let n={},l={};if(!DATA.indexados||0===DATA.indexados.length)return{perfil:{},diagrama:null};DATA.indexados.filter(e=>"Indexado quarto-hor√°rio"===e.tipo||e.nome&&e.nome.includes("BTN SPOTDEF")).forEach(e=>{n[e.nome]={S:{c:0,w:0},V:{c:0,w:0},F:{c:0,w:0},P:{c:0,w:0},C:{c:0,w:0}},l[e.nome]={S:{c:0,w:0},V:{c:0,w:0},F:{c:0,w:0},P:{c:0,w:0},C:{c:0,w:0}}});const s=(e,t,o)=>{if(e.includes("Coop√©rnico Base 2.0"))return(t+getConst("Coop_CS_CR")+getConst("Coop_K"))*o;if(e.includes("Repsol - Leve Sem Mais"))return t*o*getConst("Repsol_FA")+getConst("Repsol_Q_Tarifa");if(e.includes("Repsol - Leve PRO Sem Mais"))return t*o*getConst("Repsol_FA")+getConst("Repsol_Q_Tarifa_Pro");if(e.includes("Galp - Plano Flex√≠vel"))return(t+getConst("Galp_Ci"))*o;if(e.includes("Alfa Energia - ALFA POWER"))return(t+getConst("Alfa_CGS"))*o+getConst("Alfa_K");if(e.includes("Plenitude - Tend√™ncia"))return(t+getConst("Plenitude_CGS")+getConst("Plenitude_GDOs"))*o+getConst("Plenitude_Fee");if(e.includes("Meo Energia - Tarifa Vari√°vel"))return(t+getConst("Meo_K"))*o;if(e.includes("EDP - Eletricidade Indexada Hor√°ria"))return t*o*getConst("EDP_H_K1")+getConst("EDP_H_K2");if(e.includes("EZU - Indexada"))return(t+getConst("EZU_K")+getConst("EZU_CGS"))*o;if(e.includes("G9 - Smart Dynamic"))return t*getConst("G9_FA")*o+getConst("G9_CGS")+getConst("G9_AC");if(e.includes("Iberdrola - Simples Indexado Din√¢mico"))return t*o+getConst("Iberdrola_Dinamico_Q")+getConst("Iberdrola_mFRR");if(e.includes("BTN SPOTDEF")){return(t+getConst("Luzboa_CGS"))*o*getConst("Luzboa_FA")+getConst("Luzboa_Kp")}return t*o+.01},r=DADOS_EREDES&&DADOS_EREDES.dadosBrutos&&DATA.omieMap&&"advanced"===CURRENT_TAB;if(r){const o=new Date(e).getTime(),a=new Date(t).getTime()+86399999;for(const e of DADOS_EREDES.dadosBrutos){if(e.Ts<o||e.Ts>a)continue;const t=new Date(e.DataHora),n=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),c=String(t.getDate()).padStart(2,"0"),d=String(t.getHours()).padStart(2,"0"),u=String(t.getMinutes()).padStart(2,"0");let m=DATA.omieMap.get(`${n}-${r}-${c}_${d}:${u}`);if(m||"00"===u||(m=DATA.omieMap.get(`${n}-${r}-${c}_${d}:00`)),!m)continue;let p=parseFloat(String(m.OMIE).replace(",","."))/1e3,g=parseFloat(String(m.Perdas).replace(",",".")),f=e["Consumo (kWh)"],_=m[i];if(_||"Simp"===i)for(let e in l){let t=s(e,p,g);l[e].S.c+=t*f,l[e].S.w+=f,"Simp"!==i&&_&&(l[e][_].c+=t*f,l[e][_].w+=f)}}}DATA.omie&&DATA.omie.forEach(a=>{const l=parseDateFromDB(a.Data);if(!l||l<e||l>t)return;let r=parseFloat(String(a.OMIE).replace(",","."))/1e3,c=parseFloat(String(a.Perdas).replace(",",".")),d=parseFloat(String(a[o]||0).replace(",",".")),u=a[i];if(u||"Simp"===i)for(let e in n){let t=s(e,r,c);e.includes("BTN SPOTDEF")?"Simp"===i?(n[e].S.c+=t,n[e].S.w+=1):u&&(n[e][u].c+=t,n[e][u].w+=1):e.includes("Repsol")||"Simp"===i?(n[e].S.c+=t*d,n[e].S.w+=d):u&&(n[e][u].c+=t*d,n[e][u].w+=d)}});const c=e=>{let t={};for(let o in e)if(t[o]={},o.includes("Repsol")){let a=e[o].S.w>0?e[o].S.c/e[o].S.w:0;["S","V","F","P","C"].forEach(e=>t[o][e]=a)}else["S","V","F","P","C"].forEach(a=>{let i=e[o][a];t[o][a]=i.w>0?i.c/i.w:0});return t};return{perfil:c(n),diagrama:r?c(l):null}}function calculateManualQH(e,t){let o="Simp";t.includes("Bi")&&(o=t.includes("Di√°rio")?"BD":"BS"),t.includes("Tri")&&(o=t.includes("Di√°rio")?"TD":"TS");let a={};DATA.indexados.forEach(e=>{("Indexado quarto-hor√°rio"===e.tipo||e.nome&&e.nome.includes("BTN SPOTDEF"))&&(a[e.nome]={S:{c:0,w:0},V:{c:0,w:0},F:{c:0,w:0},P:{c:0,w:0},C:{c:0,w:0}})});const i=document.getElementById("d_inicio").value,n=document.getElementById("d_fim").value,l=parseInt(document.getElementById("num_dias").value),s=parseFloat(document.getElementById("potencia").value),r=obter_perfil((parseFloat(document.getElementById("kwh_S")?document.getElementById("kwh_S").value:0)||0)+(parseFloat(document.getElementById("kwh_V")?document.getElementById("kwh_V").value:0)||0)+(parseFloat(document.getElementById("kwh_F")?document.getElementById("kwh_F").value:0)||0)+(parseFloat(document.getElementById("kwh_P")?document.getElementById("kwh_P").value:0)||0)+(parseFloat(document.getElementById("kwh_C")?document.getElementById("kwh_C").value:0)||0),l,s);DATA.omie.forEach(l=>{const s=parseDateFromDB(l.Data);if(!s)return;if(s<i||s>n)return;let c=null;if("Simp"!==o&&(c=l[o],!c))return;let d=0;d=t.includes("Simples")?e.S||0:"V"===c?e.V||0:"F"===c?e.F||0:"C"===c?e.C||0:"P"===c?e.P||0:e.S||0;let u=d/1e3,m=parseFloat(String(l.Perdas).replace(",",".")),p=parseFloat(String(l[r]||0).replace(",","."));for(let e in a){let t=0;if(e.includes("Coop√©rnico Base 2.0"))t=(u+getConst("Coop_CS_CR")+getConst("Coop_K"))*m;else if(e.includes("Repsol - Leve Sem Mais"))t=u*m*getConst("Repsol_FA")+getConst("Repsol_Q_Tarifa");else if(e.includes("Repsol - Leve PRO Sem Mais"))t=u*m*getConst("Repsol_FA")+getConst("Repsol_Q_Tarifa_Pro");else if(e.includes("Galp - Plano Flex√≠vel"))t=(u+getConst("Galp_Ci"))*m;else if(e.includes("Alfa Energia - ALFA POWER"))t=(u+getConst("Alfa_CGS"))*m+getConst("Alfa_K");else if(e.includes("Plenitude - Tend√™ncia"))t=(u+getConst("Plenitude_CGS")+getConst("Plenitude_GDOs"))*m+getConst("Plenitude_Fee");else if(e.includes("Meo Energia - Tarifa Vari√°vel"))t=(u+getConst("Meo_K"))*m;else if(e.includes("EDP - Eletricidade Indexada Hor√°ria"))t=u*m*getConst("EDP_H_K1")+getConst("EDP_H_K2");else if(e.includes("EZU - Indexada"))t=(u+getConst("EZU_K")+getConst("EZU_CGS"))*m;else if(e.includes("G9 - Smart Dynamic"))t=u*getConst("G9_FA")*m+getConst("G9_CGS")+getConst("G9_AC");else if(e.includes("Iberdrola - Simples Indexado Din√¢mico"))t=u*m+getConst("Iberdrola_Dinamico_Q")+getConst("Iberdrola_mFRR");else if(e.includes("BTN SPOTDEF")){t=(u+getConst("Luzboa_CGS"))*m*getConst("Luzboa_FA")+getConst("Luzboa_Kp")}else t=u*m+.01;e.includes("BTN SPOTDEF")?"Simp"===o?(a[e].S.c+=t,a[e].S.w+=1):c&&(a[e][c].c+=t,a[e][c].w+=1):e.includes("Repsol")||"Simp"===o?(a[e].S.c+=t*p,a[e].S.w+=p):c&&(a[e][c].c+=t*p,a[e][c].w+=p)}});let c={};for(let e in a)if(c[e]={},e.includes("Repsol")){let t=a[e].S.w>0?a[e].S.c/a[e].S.w:0;["S","V","F","P","C"].forEach(o=>c[e][o]=t)}else["S","V","F","P","C"].forEach(t=>{let o=a[e][t];c[e][t]=o.w>0?o.c/o.w:0});return c}function calcular(){if(!DATA.fixos.length)return;if("advanced"===CURRENT_TAB&&DADOS_EREDES&&DADOS_EREDES.dadosBrutos){const e=new Date(document.getElementById("d_inicio").value),t=new Date(document.getElementById("d_fim").value),o=e.getTime(),a=t.getTime()+86399999,i=DADOS_EREDES.dadosBrutos.filter(e=>e.Ts>=o&&e.Ts<=a);if(i.length>0){const e=agregarConsumosPorPeriodo(i),t=calcularMediasOMIE(null),o=document.getElementById("ciclo").value;if(o.includes("Simples")){const t=document.getElementById("kwh_S");t&&(t.value=Math.round(100*e.Simples)/100)}else if(o.includes("Bi")){const t=o.includes("Di√°rio")?e.BD:e.BS,a=document.getElementById("kwh_V"),i=document.getElementById("kwh_F");a&&(a.value=Math.round(100*t.V)/100),i&&(i.value=Math.round(100*t.F)/100)}else{const t=o.includes("Di√°rio")?e.TD:e.TS,a=document.getElementById("kwh_V"),i=document.getElementById("kwh_P"),n=document.getElementById("kwh_C");a&&(a.value=Math.round(100*t.V)/100),i&&(i.value=Math.round(100*t.P)/100),n&&(n.value=Math.round(100*t.C)/100)}if(t.S){OMIE_VALUES.S=t.S,OMIE_VALUES.BD_V=t.BD_V||t.S,OMIE_VALUES.BD_F=t.BD_F||t.S,OMIE_VALUES.BS_V=t.BS_V||t.S,OMIE_VALUES.BS_F=t.BS_F||t.S,OMIE_VALUES.TD_V=t.TD_V||t.S,OMIE_VALUES.TD_C=t.TD_C||t.S,OMIE_VALUES.TD_P=t.TD_P||t.S,OMIE_VALUES.TS_V=t.TS_V||t.S,OMIE_VALUES.TS_C=t.TS_C||t.S,OMIE_VALUES.TS_P=t.TS_P||t.S,OMIE_MANUAL=!1;const e=document.getElementById("omie-panel");e&&e.classList.add("hidden")}const a=criarTabelaAnalise(e,t),n=document.getElementById("analise-content");n&&(n.innerHTML=a)}}else if(!OMIE_MANUAL){let e="Simp";const t=document.getElementById("ciclo").value;t.includes("Bi")&&(e=t.includes("Di√°rio")?"BD":"BS"),t.includes("Tri")&&(e=t.includes("Di√°rio")?"TD":"TS"),OMIE_VALUES.S=getOmieAvg("Simp","S"),t.includes("Bi")?(OMIE_VALUES.V=getOmieAvg(e,"V"),OMIE_VALUES.F=getOmieAvg(e,"F")):t.includes("Tri")&&(OMIE_VALUES.V=getOmieAvg(e,"V"),OMIE_VALUES.P=getOmieAvg(e,"P"),OMIE_VALUES.C=getOmieAvg(e,"C"));let o="";o=t.includes("Simples")?`S: ${OMIE_VALUES.S.toFixed(2)}`:t.includes("Bi")?`V: ${OMIE_VALUES.V.toFixed(2)} | F: ${OMIE_VALUES.F.toFixed(2)}`:`V: ${OMIE_VALUES.V.toFixed(2)} | P: ${OMIE_VALUES.P.toFixed(2)} | C: ${OMIE_VALUES.C.toFixed(2)}`;const a=document.getElementById("omie-display");a&&(a.innerText=o)}const e=document.getElementById("d_inicio").value,t=document.getElementById("d_fim").value;calcularPerdasDinamicas(new Date(e),new Date(t),document.getElementById("ciclo").value);const o=parseFloat(document.getElementById("potencia").value),a=document.getElementById("ciclo").value,i=parseInt(document.getElementById("num_dias").value),n=document.getElementById("familia_numerosa").checked,l=document.getElementById("tarifa_social").checked,s=document.getElementById("quota_acp").checked,r=document.getElementById("ocultar_edp_h").checked,c=parseFloat(document.getElementById("cav_valor").value)||2.85,d=parseFloat(document.getElementById("dgeg_valor").value)||.07,u={S:parseFloat(document.getElementById("kwh_S")?.value)||0,V:parseFloat(document.getElementById("kwh_V")?.value)||0,F:parseFloat(document.getElementById("kwh_F")?.value)||0,P:parseFloat(document.getElementById("kwh_P")?.value)||0,C:parseFloat(document.getElementById("kwh_C")?.value)||0},m=u.S+u.V+u.F+u.P+u.C;let p="Simp";if(a.includes("Bi")&&(p=a.includes("Di√°rio")?"BD":"BS"),a.includes("Tri")&&(p=a.includes("Di√°rio")?"TD":"TS"),!OMIE_MANUAL){OMIE_VALUES.S=getOmieAvg("Simp","S"),a.includes("Simples")||(a.includes("Bi")?(OMIE_VALUES.V=getOmieAvg(p,"V"),OMIE_VALUES.F=getOmieAvg(p,"F")):(OMIE_VALUES.V=getOmieAvg(p,"V"),OMIE_VALUES.P=getOmieAvg(p,"P"),OMIE_VALUES.C=getOmieAvg(p,"C")));let e="";e=a.includes("Simples")?`S: ${OMIE_VALUES.S.toFixed(2)}`:a.includes("Bi")?`V: ${OMIE_VALUES.V.toFixed(2)} | F: ${OMIE_VALUES.F.toFixed(2)}`:`V: ${OMIE_VALUES.V.toFixed(2)} | P: ${OMIE_VALUES.P.toFixed(2)} | C: ${OMIE_VALUES.C.toFixed(2)}`,document.getElementById("omie-display").innerText=e;const t=document.getElementById("omie-panel");t&&"advanced"!==CURRENT_TAB?t.classList.remove("hidden"):t&&t.classList.add("hidden"),construirInputsOMIE(a)}let g={};if(OMIE_MANUAL)g=calculateManualQH(OMIE_VALUES,a);else{const n=obter_perfil(m,i,o);g=calculateDetailedQH(e,t,n,a)}const f=getConst(`TAR_Potencia ${o}`),_=getConst("Financiamento_TSE");let h=getConst("IEC");const E=getConst("Quota_ACP");let S=0,A=0;l&&o<=6.9&&(S=getConst("Desconto TS Energia"),A=getConst(`Desconto TS Potencia ${o}`),h=0);let y={S:0,V:0,F:0,P:0,C:0};if(a.includes("Simples"))y.S=getConst("TAR_Energia_Simples");else if(a.includes("Bi"))y.V=getConst("TAR_Energia_Bi_Vazio"),y.F=getConst("TAR_Energia_Bi_ForaVazio");else{let e=o>20.7?"TAR_Energia_Tri_27.6_":"TAR_Energia_Tri_";y.V=getConst(e+"Vazio"),y.P=getConst(e+"Ponta"),y.C=getConst(e+"Cheias")}let v={S:y.S-S,V:y.V-S,F:y.F-S,P:y.P-S,C:y.C-S};const T=f-A,b=document.getElementById("f_segmento").value,I=document.getElementById("f_fatura").value,C=document.getElementById("f_pagamento").value,B=Array.from(document.querySelectorAll(".chk-tipo:checked")).map(e=>e.value);let x=[];const F=(e,t,l)=>{e.forEach(e=>{if(Math.abs(getVal(e,"pot",l)-o)>.1)return;if(!(e[l.ciclo]||"").toLowerCase().includes(a.toLowerCase()))return;let p=e.nome||"";if(r&&p.includes("EDP - Eletricidade Indexada Hor√°ria"))return;const S=e[l.seg]||"";if("Residencial"===b&&"Dom√©stico"!==S&&"Dom√©stico e N√£o Dom√©stico"!==S)return;if("Empresarial"===b&&"N√£o Dom√©stico"!==S&&"Dom√©stico e N√£o Dom√©stico"!==S)return;const A=e[l.fat]||"";if("Fatura eletr√≥nica"===I&&!A.includes("Fatura eletr√≥nica"))return;if("Fatura em papel"===I&&!A.includes("Fatura em papel"))return;const F=e[l.pag]||"";if("D√©bito Direto"===C&&!F.includes("D√©bito Direto"))return;if("Multibanco"===C&&!F.includes("Multibanco"))return;if("Numer√°rio/Payshop/CTT"===C&&!F.includes("Numer√°rio")&&!F.includes("Payshop")&&!F.includes("CTT"))return;let D=e[l.tipo]||(t?"Indexado M√©dia":"Fixo");if(D=D.trim(),!B.includes(D))return;const P=e.comercializador||"";if("complete"===CURRENT_TAB&&STATE_ABA2.excludedProviders.includes(P))return;if("advanced"===CURRENT_TAB&&STATE_ABA3.excludedProviders.includes(P))return;let M=[];if(t&&"Indexado quarto-hor√°rio"===D&&g.perfil)M.push({suffix:" - Perfil",source:g.perfil,tipoExtra:" - Perfil"}),g.diagrama&&M.push({suffix:" - Diagrama",source:g.diagrama,tipoExtra:" - Diagrama"});else{let e=g.perfil?g.perfil:g;M.push({suffix:"",source:e,tipoExtra:""})}M.forEach(r=>{let g=p+r.suffix,S=D+r.tipoExtra;const A=e.comercializador||"";let b=getVal(e,"fixo",l),I=parseBool(e[l.tar_p_incl]);void 0===I&&(I=!t);let C=I?b-f:b,B=C+T,F=parseBool(e[l.tar_e_incl]);void 0===F&&(F=!t);let P=parseBool(e[l.tse_incl]);void 0===P&&(P=!0);let M=0,V=0,$=0,k=0,w=0,O={S:{},V:{},F:{},P:{},C:{}},L={S:OMIE_VALUES.S/1e3,V:OMIE_VALUES.V/1e3,F:OMIE_VALUES.F/1e3,P:OMIE_VALUES.P/1e3,C:OMIE_VALUES.C/1e3};const z=(e,o,i,n)=>{let l=e;if(t)if("Indexado quarto-hor√°rio"===D)r.source[p]&&(l=r.source[p][n]||0);else{let e=L[n],t=L.S,o="S";a.includes("Bi")?o=a.includes("Di√°rio")?"BD":"BS":a.includes("Tri")&&(o=a.includes("Di√°rio")?"TD":"TS");let i=1,s=1.16;if(a.includes("Simples")?(i=getPerdas("Perdas_Anual_S")||1,s=getPerdas("Perdas_M_S")||1.16):(i=getPerdas(`Perdas_Anual_${o}_${n}`)||1,s=getPerdas(`Perdas_M_${o}_${n}`)||1.16),p.includes("BTN SPOTDEF"))if(r.source[p]&&void 0!==r.source[p][n])l=r.source[p][n];else{l=(e+getConst("Luzboa_CGS"))*i*getConst("Luzboa_FA")+getConst("Luzboa_Kp")}else if(p.includes("Iberdrola"))l=e*getConst("Iberdrola_Perdas")+getConst("Iberdrola_Media_Q")+getConst("Iberdrola_mFRR");else if(p.includes("Goldenergy")){l=e*({1:1.29,2:1.18,3:1.18,4:1.15,5:1.11,6:1.1,7:1.15,8:1.13,9:1.1,10:1.1,11:1.16,12:1.25}[new Date(document.getElementById("d_inicio").value).getMonth()+1]||1.16)+getConst("GE_Q_Tarifa")+getConst("GE_CG")}else if(p.includes("Endesa")){l=e+getConst(`Endesa_A_${"F"===n?"FV":n}`)}else l=p.includes("LUZiG√ÅS - Energy 8.8")?(t+getConst("Luzigas_8_8_K")+getConst("Luzigas_CGS"))*i:p.includes("LUZiG√ÅS - Super Lig Index")?(t+getConst("Luzigas_K")+getConst("Luzigas_CGS"))*i:p.includes("Ibelectra - Solu√ß√£o Fam√≠lia")?(e+getConst("Ibelectra_CS"))*getConst("Ibelectra_Perdas")+getConst("Ibelectra_K"):p.includes("Ibelectra - Solu√ß√£o Amigo")?(e+getConst("Ibelectra_CS"))*getConst("Ibelectra_Perdas")+getConst("Ibelectra_K_a"):p.includes("G9 - Smart Index")?e*getConst("G9_FA")*s+getConst("G9_CGS")+getConst("G9_AC"):p.includes("EDP - Eletricidade Indexada M√©dia")?e*getConst("EDP_M_Perdas")*getConst("EDP_M_K1")+getConst("EDP_M_K2"):e+.02}let s=F?l-o:l,c=i,d=P?0:_,u=s+c+d;return O[n]={comercialSemTar:s,tarValue:c,tse:d,tarIncluded:F,tseIncluded:P},u};if(a.includes("Simples")){M=z(t?0:getVal(e,"pS",l),y.S,v.S,"S")}else if(a.includes("Bi")){let o=t?0:getVal(e,"pV_bi",l)||getVal(e,"pS",l),a=t?0:getVal(e,"pF",l)||getVal(e,"pS",l);V=z(o,y.V,v.V,"V"),$=z(a,y.F,v.F,"F")}else{let o=t?0:getVal(e,"pV_tri",l)||getVal(e,"pS",l),a=t?0:getVal(e,"pP",l)||getVal(e,"pF",l)||getVal(e,"pS",l),i=t?0:getVal(e,"pC",l)||getVal(e,"pF",l)||getVal(e,"pS",l);V=z(o,y.V,v.V,"V"),k=z(a,y.P,v.P,"P"),w=z(i,y.C,v.C,"C")}let R=C*i,U=T*i,N=0,H=0;o<=3.45?(N=U,H=R):H=R+U;let W=.06*N,q=.23*H,G=0;G=a.includes("Simples")?M*u.S:a.includes("Bi")?V*u.V+$*u.F:V*u.V+k*u.P+w*u.C;let K,Q=(n?300:200)/30*i,X=0,j=0,Y=0,Z=0;if(o<=6.9){if(a.includes("Simples")){let e=Math.min(m,Q),t=Math.max(0,m-Q),o=m?G/m:0;X=e*o,j=t*o}else{let e=a.includes("Bi")?{V:u.V,F:u.F}:{V:u.V,P:u.P,C:u.C},t=a.includes("Bi")?{V:V*u.V,F:$*u.F}:{V:V*u.V,P:k*u.P,C:w*u.C},o=0,i=0;for(let a in e){let n=Q*(m>0?e[a]/m:0),l=Math.min(e[a],n),s=Math.max(0,e[a]-n),r=e[a]>0?t[a]/e[a]:0;o+=l*r,i+=s*r}X=o,j=i}Y=.06*X,Z=.23*j}else j=G,Z=.23*j;K=CAV_FIXO_COMERCIALIZADORES.some(e=>A.includes(e))&&i>=28&&i<=32?c:12*c/365.25*i;let J=m*h,ee=i>=28&&i<=32?d:d*i/30,te=.23*J,oe=.23*ee,ae=.06*K,ie=N+H+W+q+(X+j+Y+Z)+(J+te+ee+oe+K+ae),ne=getVal(e,"desc_fat",l),le=getVal(e,"desc_limit",l),se=0;if(ne>0){let e=i>=28&&i<=32?ne:ne*i/30,t="";if(le&&le>0){se=(i>=28&&i<=32?1:i/30)>le?ne*le:e,t=` nos 1¬∫s ${le} meses`}else se=e;let o=ie;ie-=se,g+=` (INCLUI desc.${ne.toFixed(2)}‚Ç¨/m√™s${t}, s/ desc.=${o.toFixed(2)}‚Ç¨)`}let re=0;s&&p.startsWith("Goldenergy - ACP")&&(re=i>=28&&i<=32?E:E*i/30,ie+=re,g+=" (INCLUI Quota ACP)"),x.push({com:A,nome:g,tipo:S,total:ie,uS:M,uV:V,uF:$,uP:k,uC:w,uPot:B,breakdown:O,potDetails:{comercial:C,tarPotValue:T,tarIncluded:I},details:{costPot6:N,costPot23:H,costEn6:X,costEn23:j,taxPot6:W,taxPot23:q,taxEn6:Y,taxEn23:Z,iec:J,dgeg:ee,cav:K,taxIEC:te,taxDGEG:oe,taxCAV:ae,desc:se,quotaACP:re,site:e[l.site],notas:e[l.notas]}})})})};if(F(DATA.fixos,!1,COLS_FIXO),DATA.indexados&&DATA.indexados.length>0&&F(DATA.indexados,!0,COLS_INDEX),document.getElementById("meu_ativo")&&document.getElementById("meu_ativo").checked){const e=criarMeuTarifario(o,a,i,u,m,y,f,_,n,c,h,d,v,T);e&&x.push(e)}if(document.getElementById("pers_ativo")&&document.getElementById("pers_ativo").checked){const e=criarTarifarioPersonalizado(o,a,i,u,m,y,f,_,n,c,h,d,v,T);e&&x.push(e)}const D=document.getElementById("f_procura")?document.getElementById("f_procura").value.toLowerCase():"";D&&(x=x.filter(e=>{if("Utilizador"===e.tipo||"Personalizado"===e.tipo)return!0;const t=e.com?e.com.toLowerCase():"",o=e.nome?e.nome.toLowerCase():"";return t.includes(D)||o.includes(D)})),x.sort((e,t)=>SORT.asc?e[SORT.col]-t[SORT.col]:t[SORT.col]-e[SORT.col]),window.GLOBAL_RESULTS=x,document.getElementById("res-count").innerText=`${x.length} tarifas`,x.length>0&&(atualizarResumoSimulacao(),calcularMensagemPoupanca(x));const P=document.getElementById("modo_comparacao"),M=document.getElementById("titulo-tabela"),V=document.getElementById("btn-exportar"),$=document.getElementById("btn-partilhar");if(P&&P.checked){M&&(M.textContent="Tiago Fel√≠cia - Compara√ß√£o de Custos entre Op√ß√µes Tarif√°rias");const e=calcularModoComparacao(x,o,a,i,u,m,y,f,_,n,c,h,d,v,T);renderTableComparacao(e,a),LAST_EXPORT_DATA={mode:"comparacao",data:e,results:x,ciclo:a}}else{M&&(M.textContent="Tiago Fel√≠cia - Tarif√°rios de Eletricidade - Detalhado"),renderTable(x,a),LAST_EXPORT_DATA={mode:"detalhe",results:x,ciclo:a};const e=document.getElementById("comparacao-summary");e&&(e.innerHTML="")}if(V&&(V.style.display=x.length>0?"inline-block":"none"),$&&($.style.display=x.length>0&&"complete"===CURRENT_TAB?"inline-block":"none"),"advanced"===CURRENT_TAB&&DADOS_EREDES){atualizarAnalisePotencia();const e=document.getElementById("graficos-analise-content");e&&!e.classList.contains("collapsed")&&gerarGraficosAnaliseERedes()}if("complete"===CURRENT_TAB){const e=document.getElementById("grafico-omie-content");e&&!e.classList.contains("collapsed")&&gerarGraficoOMIEDiario()}atualizarLabelsOMIE()}function criarMeuTarifario(e,t,o,a,i,n,l,s,r,c,d,u,m,p){if(!document.getElementById("meu_pot"))return null;const g=parseFloat(document.getElementById("meu_pot").value)||0,f=document.getElementById("meu_tar_en_incl").checked,_=document.getElementById("meu_tar_pot_incl").checked,h=document.getElementById("meu_tse_incl").checked,E=parseFloat(document.getElementById("meu_desc_en").value)||0,S=parseFloat(document.getElementById("meu_desc_pot").value)||0,A=parseFloat(document.getElementById("meu_desc_fat").value)||0,y=parseFloat(document.getElementById("meu_acres_fat").value)||0;let v=0,T=0,b=0,I=0,C=0,B={S:{},V:{},F:{},P:{},C:{}};const x=(e,t,o,a)=>{let i=(f?e:e+t)*(1-E/100)-t,n=i+o+(h?0:s);return B[a]={comercialSemTar:i,tarValue:o,tse:h?0:s,tarIncluded:f,tseIncluded:h},n};t.includes("Simples")?v=x(parseFloat(document.getElementById("meu_S").value)||0,n.S,m.S,"S"):t.includes("Bi")?(T=x(parseFloat(document.getElementById("meu_V").value)||0,n.V,m.V,"V"),b=x(parseFloat(document.getElementById("meu_F").value)||0,n.F,m.F,"F")):(T=x(parseFloat(document.getElementById("meu_V").value)||0,n.V,m.V,"V"),I=x(parseFloat(document.getElementById("meu_P").value)||0,n.P,m.P,"P"),C=x(parseFloat(document.getElementById("meu_C").value)||0,n.C,m.C,"C"));let F=(_?g:g+l)*(1-S/100)-l,D=F+p,P=F*o,M=p*o,V=0,$=0,k=0,w=0;e<=3.45?(V=M,$=P):$=P+M,k=.06*V,w=.23*$;let O=0;O=t.includes("Simples")?v*a.S:t.includes("Bi")?T*a.V+b*a.F:T*a.V+I*a.P+C*a.C;let L=(r?300:200)/30*o,z=0,R=0,U=0,N=0;if(e<=6.9){let e=i?O/i:0;z=Math.min(i,L)*e,R=Math.max(0,i-L)*e,U=.06*z,N=.23*R}else R=O,N=.23*R;let H=12*c/365.25*o,W=i*d,q=o>=28&&o<=32?u:u*o/30,G=.23*W,K=.23*q,Q=.06*H,X=V+$+k+w+(z+R+U+N)+W+G+q+K+H+Q-A+y,j="O Meu Tarif√°rio",Y="",Z=parseFloat(A)||0,J=parseFloat(y)||0;if(Z>0&&J>0){let e=Z-J;if(e>0){let t=X+e;Y=` (Inclui desconto l√≠quido de ${e.toFixed(2)}‚Ç¨ no per√≠odo, s/ desc.=${t.toFixed(2)}‚Ç¨)`}else if(e<0){let t=Math.abs(e),o=X-t;Y=` (Inclui acr√©scimo l√≠quido de ${t.toFixed(2)}‚Ç¨ no per√≠odo, s/ acr√©sc.=${o.toFixed(2)}‚Ç¨)`}}else if(Z>0){let e=X+Z;Y=` (Inclui desconto de ${Z.toFixed(2)}‚Ç¨ no per√≠odo, s/ desc.=${e.toFixed(2)}‚Ç¨)`}else if(J>0){let e=X-J;Y=` (Inclui acr√©scimo de ${J.toFixed(2)}‚Ç¨ no per√≠odo, s/ acr√©sc.=${e.toFixed(2)}‚Ç¨)`}return j+=Y,{com:"Utilizador",nome:j,tipo:"Utilizador",total:X,uS:v,uV:T,uF:b,uP:I,uC:C,uPot:D,breakdown:B,potDetails:{comercial:F,tarPotValue:p,tarIncluded:_},details:{costPot6:V,costPot23:$,costEn6:z,costEn23:R,taxPot6:k,taxPot23:w,taxEn6:U,taxEn23:N,iec:W,dgeg:q,cav:H,taxIEC:G,taxDGEG:K,taxCAV:Q,desc:A,quotaACP:0,acrescimo:y,site:"",notas:""}}}function criarTarifarioPersonalizado(e,t,o,a,i,n,l,s,r,c,d,u,m,p){if(!document.getElementById("pers_ativo")||!document.getElementById("pers_ativo").checked)return null;const g=!document.getElementById("pers_tar_energia")||document.getElementById("pers_tar_energia").checked,f=!document.getElementById("pers_tar_potencia")||document.getElementById("pers_tar_potencia").checked,_=!document.getElementById("pers_tse_incluido")||document.getElementById("pers_tse_incluido").checked;let h=0,E=0,S=0,A=0,y=0,v={S:{},V:{},F:{},P:{},C:{}},T=0;const b=(e,t,o,a)=>{let i=g?e-t:e,n=i+o+(_?0:s);return v[a]={comercialSemTar:i,tarValue:o,tse:_?0:s,tarIncluded:g,tseIncluded:_},n};if(t.includes("Simples")){const e=document.getElementById("pers_energia_s");e&&(h=b(parseFloat(e.value)||0,n.S,m.S,"S"));const t=document.getElementById("pers_potencia_s");t&&(T=parseFloat(t.value)||0)}else if(t.includes("Bi")){const e=document.getElementById("pers_energia_v_bi"),t=document.getElementById("pers_energia_f_bi");e&&(E=b(parseFloat(e.value)||0,n.V,m.V,"V")),t&&(S=b(parseFloat(t.value)||0,n.F,m.F,"F"));const o=document.getElementById("pers_potencia_bi");o&&(T=parseFloat(o.value)||0)}else{const e=document.getElementById("pers_energia_v_tri"),t=document.getElementById("pers_energia_c_tri"),o=document.getElementById("pers_energia_p_tri");e&&(E=b(parseFloat(e.value)||0,n.V,m.V,"V")),t&&(y=b(parseFloat(t.value)||0,n.C,m.C,"C")),o&&(A=b(parseFloat(o.value)||0,n.P,m.P,"P"));const a=document.getElementById("pers_potencia_tri");a&&(T=parseFloat(a.value)||0)}let I=f?T-l:T,C=I+p,B=I*o,x=p*o,F=0,D=0,P=0,M=0;e<=3.45?(F=x,D=B):D=B+x,P=.06*F,M=.23*D;let V=0;V=t.includes("Simples")?h*a.S:t.includes("Bi")?E*a.V+S*a.F:E*a.V+A*a.P+y*a.C;let $=(r?300:200)/30*o,k=0,w=0,O=0,L=0;if(e<=6.9){let e=i?V/i:0;k=Math.min(i,$)*e,w=Math.max(0,i-$)*e,O=.06*k,L=.23*w}else w=V,L=.23*w;let z=12*c/365.25*o,R=i*d,U=o>=28&&o<=32?u:u*o/30,N=.23*R,H=.23*U,W=.06*z;return{com:"Personalizado",nome:"Tarif√°rio Personalizado",tipo:"Personalizado",total:F+D+P+M+(k+w+O+L)+R+N+U+H+z+W,uS:h,uV:E,uF:S,uP:A,uC:y,uPot:C,breakdown:v,potDetails:{comercial:I,tarPotValue:p,tarIncluded:f},details:{costPot6:F,costPot23:D,costEn6:k,costEn23:w,taxPot6:P,taxPot23:M,taxEn6:O,taxEn23:L,iec:R,dgeg:U,cav:z,taxIEC:N,taxDGEG:H,taxCAV:W,desc:0,quotaACP:0,acrescimo:0,site:"",notas:"Tarif√°rio configurado pelo utilizador."}}}function calcularModoComparacao(e,t,o,a,i,n,l,s,r,c,d,u,m,p,g){const f="advanced"===CURRENT_TAB&&DADOS_EREDES&&DADOS_EREDES.consumosAgregados,_=document.getElementById("tarifa_social").checked,h=document.getElementById("quota_acp").checked,E=document.getElementById("ocultar_edp_h").checked,S=document.getElementById("d_inicio").value,A=document.getElementById("d_fim").value,y=document.getElementById("f_segmento").value,v=document.getElementById("f_fatura").value,T=document.getElementById("f_pagamento").value,b=Array.from(document.querySelectorAll(".chk-tipo:checked")).map(e=>e.value);let I=[];if(f)I=t<=20.7?[{display:"Simples",dbName:"Simples"},{display:"Bi Di√°rio",dbName:"Bi-hor√°rio - Ciclo Di√°rio"},{display:"Bi Semanal",dbName:"Bi-hor√°rio - Ciclo Semanal"},{display:"Tri Di√°rio",dbName:"Tri-hor√°rio - Ciclo Di√°rio"},{display:"Tri Semanal",dbName:"Tri-hor√°rio - Ciclo Semanal"}]:[{display:"Simples",dbName:"Simples"},{display:"Tri Di√°rio >20.7",dbName:"Tri-hor√°rio > 20.7 kVA - Ciclo Di√°rio"},{display:"Tri Semanal >20.7",dbName:"Tri-hor√°rio > 20.7 kVA - Ciclo Semanal"}];else{const e=o.includes("Semanal")?"Semanal":"Di√°rio";t<=20.7?o.includes("Tri")?I=[{display:"Simples",dbName:"Simples"},{display:"Bi-hor√°rio",dbName:`Bi-hor√°rio - Ciclo ${e}`},{display:"Tri-hor√°rio",dbName:`Tri-hor√°rio - Ciclo ${e}`}]:o.includes("Bi")&&(I=[{display:"Simples",dbName:"Simples"},{display:"Bi-hor√°rio",dbName:`Bi-hor√°rio - Ciclo ${e}`}]):I=[{display:"Simples",dbName:"Simples"},{display:"Tri-hor√°rio >20.7",dbName:"Tri-hor√°rio > 20.7 kVA - Ciclo "+(o.includes("Semanal")?"Semanal":"Di√°rio")}]}if(I.length<=1)return{opcoes:I,resultados:[]};const C={};for(const e of I){const l=e.dbName;let r={S:0,V:0,F:0,P:0,C:0};if(l.includes("Simples"))r.S=getConst("TAR_Energia_Simples");else if(l.includes("Bi"))r.V=getConst("TAR_Energia_Bi_Vazio"),r.F=getConst("TAR_Energia_Bi_ForaVazio");else{let e=t>20.7?"TAR_Energia_Tri_27.6_":"TAR_Energia_Tri_";r.V=getConst(e+"Vazio"),r.P=getConst(e+"Ponta"),r.C=getConst(e+"Cheias")}let c=0,d=0;_&&t<=6.9&&(c=getConst("Desconto TS Energia"),d=getConst(`Desconto TS Potencia ${t}`));let u={S:r.S-c,V:r.V-c,F:r.F-c,P:r.P-c,C:r.C-c},m=s-d,p=_&&t<=6.9?0:getConst("IEC"),g={S:0,V:0,F:0,P:0,C:0};if(f){const e=DADOS_EREDES.consumosAgregados;if(l.includes("Simples"))g.S=e.Simples||0;else if(l.includes("Bi")){const t=l.includes("Di√°rio")?"BD":"BS";g.V=e[t]?.V||0,g.F=e[t]?.F||0}else{const t=l.includes("Di√°rio")?"TD":"TS";g.V=e[t]?.V||0,g.C=e[t]?.C||0,g.P=e[t]?.P||0}}else l.includes("Simples")?g.S=n:l.includes("Bi")?o.includes("Tri")?(g.V=i.V,g.F=i.C+i.P):o.includes("Bi")&&(g.V=i.V,g.F=i.F):l.includes("Tri")&&o.includes("Tri")&&(g.V=i.V,g.C=i.C,g.P=i.P);let h=g.S+g.V+g.F+g.P+g.C,E={S:0,V:0,F:0,P:0,C:0};{let e="Simp";l.includes("Bi")&&(e=l.includes("Di√°rio")?"BD":"BS"),l.includes("Tri")&&(e=l.includes("Di√°rio")?"TD":"TS"),E.S=getOmieAvg("Simp","S"),l.includes("Bi")?(E.V=getOmieAvg(e,"V"),E.F=getOmieAvg(e,"F")):l.includes("Tri")&&(E.V=getOmieAvg(e,"V"),E.P=getOmieAvg(e,"P"),E.C=getOmieAvg(e,"C"))}let y={},v={};if(DATA.indexados&&DATA.indexados.length>0){const e=obter_perfil(h,a,t),o=calculateDetailedQH(S,A,e,l);y=o.perfil||{},f&&o.diagrama&&(v=o.diagrama)}C[e.display]={dbName:l,tarEnBase:r,tarEnFinal:u,tarPotRegFinal:m,consumos:g,totalKwh:h,omie:E,qhResults:y,qhDiagramaResults:v,iecVal:p}}const B=(e,o,i,n,l)=>{const u=C[n];if(!u||0===u.totalKwh)return null;const p=u.dbName,g=e.nome||"",f=e.comercializador||"";let _=getVal(e,"fixo",i),E=parseBool(e[i.tar_p_incl]);void 0===E&&(E=!o);let A=E?_-s:_,y=A+u.tarPotRegFinal,v=parseBool(e[i.tar_e_incl]);void 0===v&&(v=!o);let T=parseBool(e[i.tse_incl]);void 0===T&&(T=!0);let b=(e[i.tipo]||(o?"Indexado M√©dia":"Fixo")).trim(),I={S:u.omie.S/1e3,V:u.omie.V/1e3,F:u.omie.F/1e3,P:u.omie.P/1e3,C:u.omie.C/1e3};const B=l||u.qhResults;let x={S:{},V:{},F:{},P:{},C:{}};const F=(e,t,a,i)=>{let n=e;if(o)if("Indexado quarto-hor√°rio"===b)B[g]&&(n=B[g][i]||0);else{let e=I[i],t=I.S,o="S";p.includes("Bi")?o=p.includes("Di√°rio")?"BD":"BS":p.includes("Tri")&&(o=p.includes("Di√°rio")?"TD":"TS");let a=1,l=1.16;if(p.includes("Simples")?(a=getPerdas("Perdas_Anual_S")||1,l=getPerdas("Perdas_M_S")||1.16):(a=getPerdas(`Perdas_Anual_${o}_${i}`)||1,l=getPerdas(`Perdas_M_${o}_${i}`)||1.16),g.includes("BTN SPOTDEF"))if(B[g]&&void 0!==B[g][i])n=B[g][i];else{n=(e+getConst("Luzboa_CGS"))*a*getConst("Luzboa_FA")+getConst("Luzboa_Kp")}else if(g.includes("Iberdrola"))n=e*getConst("Iberdrola_Perdas")+getConst("Iberdrola_Media_Q")+getConst("Iberdrola_mFRR");else if(g.includes("Goldenergy")){n=e*({1:1.29,2:1.18,3:1.18,4:1.15,5:1.11,6:1.1,7:1.15,8:1.13,9:1.1,10:1.1,11:1.16,12:1.25}[new Date(S).getMonth()+1]||1.16)+getConst("GE_Q_Tarifa")+getConst("GE_CG")}else n=g.includes("Endesa")?e+getConst(`Endesa_A_${"F"===i?"FV":i}`):g.includes("LUZiG√ÅS - Energy 8.8")?(t+getConst("Luzigas_8_8_K")+getConst("Luzigas_CGS"))*a:g.includes("LUZiG√ÅS - Super Lig Index")?(t+getConst("Luzigas_K")+getConst("Luzigas_CGS"))*a:g.includes("Ibelectra - Solu√ß√£o Fam√≠lia")?(e+getConst("Ibelectra_CS"))*getConst("Ibelectra_Perdas")+getConst("Ibelectra_K"):g.includes("Ibelectra - Solu√ß√£o Amigo")?(e+getConst("Ibelectra_CS"))*getConst("Ibelectra_Perdas")+getConst("Ibelectra_K_a"):g.includes("G9 - Smart Index")?e*getConst("G9_FA")*l+getConst("G9_CGS")+getConst("G9_AC"):g.includes("EDP - Eletricidade Indexada M√©dia")?e*getConst("EDP_M_Perdas")*getConst("EDP_M_K1")+getConst("EDP_M_K2"):e+.02}let l=v?n-t:n,s=l+a+(T?0:r);return x[i]={comercialSemTar:l,tarValue:a,tse:T?0:r,tarIncluded:v,tseIncluded:T},s};let D=0,P=0,M=0,V=0,$=0;if(p.includes("Simples")){D=F(o?0:getVal(e,"pS",i),u.tarEnBase.S,u.tarEnFinal.S,"S")}else if(p.includes("Bi")){let t=o?0:getVal(e,"pV_bi",i)||getVal(e,"pS",i),a=o?0:getVal(e,"pF",i)||getVal(e,"pS",i);P=F(t,u.tarEnBase.V,u.tarEnFinal.V,"V"),M=F(a,u.tarEnBase.F,u.tarEnFinal.F,"F")}else{let t=o?0:getVal(e,"pV_tri",i)||getVal(e,"pS",i),a=o?0:getVal(e,"pP",i)||getVal(e,"pF",i)||getVal(e,"pS",i),n=o?0:getVal(e,"pC",i)||getVal(e,"pF",i)||getVal(e,"pS",i);P=F(t,u.tarEnBase.V,u.tarEnFinal.V,"V"),V=F(a,u.tarEnBase.P,u.tarEnFinal.P,"P"),$=F(n,u.tarEnBase.C,u.tarEnFinal.C,"C")}let k=A*a,w=u.tarPotRegFinal*a,O=0,L=0;t<=3.45?(O=w,L=k):L=k+w;let z=.06*O,R=.23*L;const U=u.consumos;let N=0;N=p.includes("Simples")?D*U.S:p.includes("Bi")?P*U.V+M*U.F:P*U.V+V*U.P+$*U.C;let H,W=(c?300:200)/30*a,q=0,G=0,K=0,Q=0;if(t<=6.9){if(p.includes("Simples")){let e=Math.min(u.totalKwh,W),t=Math.max(0,u.totalKwh-W),o=u.totalKwh?N/u.totalKwh:0;q=e*o,G=t*o}else{let e=p.includes("Bi")?{V:U.V,F:U.F}:{V:U.V,P:U.P,C:U.C},t=p.includes("Bi")?{V:P*U.V,F:M*U.F}:{V:P*U.V,P:V*U.P,C:$*U.C},o=0,a=0;for(let i in e){let n=W*(u.totalKwh>0?e[i]/u.totalKwh:0),l=Math.min(e[i],n),s=Math.max(0,e[i]-n),r=e[i]>0?t[i]/e[i]:0;o+=l*r,a+=s*r}q=o,G=a}K=.06*q,Q=.23*G}else G=N,Q=.23*G;H=CAV_FIXO_COMERCIALIZADORES.some(e=>f.includes(e))&&a>=28&&a<=32?d:12*d/365.25*a;let X=u.totalKwh*u.iecVal,j=a>=28&&a<=32?m:m*a/30,Y=.23*X,Z=.23*j,J=.06*H,ee=O+L+z+R+(q+G+K+Q)+(X+Y+j+Z+H+J),te=getVal(e,"desc_fat",i),oe=getVal(e,"desc_limit",i),ae=0;if(te>0){let e=a>=28&&a<=32?te:te*a/30;if(oe&&oe>0){ae=(a>=28&&a<=32?1:a/30)>oe?te*oe:e}else ae=e;ee-=ae}let ie=0;return h&&g.startsWith("Goldenergy - ACP")&&(ie=a>=28&&a<=32?getConst("Quota_ACP"):getConst("Quota_ACP")*a/30,ee+=ie),{total:ee,uS:D,uV:P,uF:M,uP:V,uC:$,uPot:y,breakdown:x,potDetails:{comercial:A,tarPotValue:u.tarPotRegFinal,tarIncluded:E},details:{costPot6:O,costPot23:L,costEn6:q,costEn23:G,taxPot6:z,taxPot23:R,taxEn6:K,taxEn23:Q,iec:X,dgeg:j,cav:H,taxIEC:Y,taxDGEG:Z,taxCAV:J,desc:ae,quotaACP:ie,acrescimo:0,site:e[i.site],notas:e[i.notas]}}},x=new Map,F=(e,o,a)=>{e.forEach(e=>{const i=e.nome||"",n=e.comercializador||"",l=(e[a.tipo]||(o?"Indexado M√©dia":"Fixo")).trim();if((!E||!i.includes("EDP - Eletricidade Indexada Hor√°ria"))&&b.includes(l)&&((e,t)=>{const o=e[t.seg]||"";if("Residencial"===y&&"Dom√©stico"!==o&&"Dom√©stico e N√£o Dom√©stico"!==o)return!1;if("Empresarial"===y&&"N√£o Dom√©stico"!==o&&"Dom√©stico e N√£o Dom√©stico"!==o)return!1;const a=e[t.fat]||"";if("Fatura eletr√≥nica"===v&&!a.includes("Fatura eletr√≥nica"))return!1;if("Fatura em papel"===v&&!a.includes("Fatura em papel"))return!1;const i=e[t.pag]||"";if("D√©bito Direto"===T&&!i.includes("D√©bito Direto"))return!1;if("Multibanco"===T&&!i.includes("Multibanco"))return!1;if("Numer√°rio/Payshop/CTT"===T&&!i.includes("Numer√°rio")&&!i.includes("Payshop")&&!i.includes("CTT"))return!1;const n=e.comercializador||"";if("complete"===CURRENT_TAB&&STATE_ABA2.excludedProviders.includes(n))return!1;if("advanced"===CURRENT_TAB&&STATE_ABA3.excludedProviders.includes(n))return!1;const l=document.getElementById("f_procura")?document.getElementById("f_procura").value.toLowerCase():"";if(l){const t=(e.nome||"").toLowerCase(),o=(e.comercializador||"").toLowerCase();if(!t.includes(l)&&!o.includes(l))return!1}return!0})(e,a)&&!(Math.abs(getVal(e,"pot",a)-t)>.1))if(o&&"Indexado quarto-hor√°rio"===l&&f){const t=`${i} - Perfil|${n}`;x.has(t)||x.set(t,{nome:i,nomeDisplay:i+" - Perfil",com:n,tipo:"Indexado quarto-hor√°rio - Perfil",isIndexado:o,site:e[a.site],notas:e[a.notas],cols:a,qhVariant:"perfil"});if(I.some(e=>{const t=C[e.display];return t&&t.qhDiagramaResults&&Object.keys(t.qhDiagramaResults).length>0})){const t=`${i} - Diagrama|${n}`;x.has(t)||x.set(t,{nome:i,nomeDisplay:i+" - Diagrama",com:n,tipo:"Indexado quarto-hor√°rio - Diagrama",isIndexado:o,site:e[a.site],notas:e[a.notas],cols:a,qhVariant:"diagrama"})}}else{const t=`${i}|${n}`;x.has(t)||x.set(t,{nome:i,nomeDisplay:i,com:n,tipo:l,isIndexado:o,site:e[a.site],notas:e[a.notas],cols:a,qhVariant:null})}})};F(DATA.fixos,!1,COLS_FIXO),DATA.indexados&&DATA.indexados.length>0&&F(DATA.indexados,!0,COLS_INDEX);const D=[];for(const[e,o]of x){const e={nome:o.nomeDisplay,com:o.com,tipo:o.tipo,site:o.site,notas:o.notas,custos:{},detalhes:{},melhorOpcao:"",menorCusto:1/0};let a=!1;for(const i of I){const n=(o.isIndexado?DATA.indexados:DATA.fixos).find(e=>e.nome===o.nome&&e.comercializador===o.com&&Math.abs(getVal(e,"pot",o.cols)-t)<.1&&(e[o.cols.ciclo]||"").toLowerCase()===i.dbName.toLowerCase());if(n){const t="diagrama"===o.qhVariant?C[i.display]?.qhDiagramaResults:"perfil"===o.qhVariant?C[i.display]?.qhResults:null,l=B(n,o.isIndexado,o.cols,i.display,t);null===l||isNaN(l.total)||(e.custos[i.display]=l.total,e.detalhes[i.display]=l,a=!0,l.total<e.menorCusto&&(e.menorCusto=l.total,e.melhorOpcao=i.display))}}a&&D.push(e)}if(document.getElementById("meu_ativo")&&document.getElementById("meu_ativo").checked){const t=e.find(e=>e.nome&&e.nome.includes("O Meu Tarif√°rio"));if(t){const e={nome:t.nome,com:t.com||"Utilizador",tipo:"Utilizador",site:"",notas:"",custos:{},detalhes:{},melhorOpcao:"",menorCusto:1/0},a=I.find(e=>e.dbName.toLowerCase()===o.toLowerCase());a&&(e.custos[a.display]=t.total,e.menorCusto=t.total,e.melhorOpcao=a.display,e.detalhes[a.display]={total:t.total,uS:t.uS,uV:t.uV,uF:t.uF,uP:t.uP,uC:t.uC,uPot:t.uPot,breakdown:t.breakdown,potDetails:t.potDetails,details:t.details}),D.push(e)}}if(document.getElementById("pers_ativo")&&document.getElementById("pers_ativo").checked){const e={nome:"Tarif√°rio Personalizado",com:"Personalizado",tipo:"Personalizado",site:"",notas:"Tarif√°rio configurado pelo utilizador.",custos:{},detalhes:{},melhorOpcao:"",menorCusto:1/0};for(const o of I){const i=C[o.display];if(!i||0===i.totalKwh)continue;const n=calcularPersParaOpcaoComp(o.dbName,i,t,a,c,d,m,r,s);null===n||isNaN(n.total)||(e.custos[o.display]=n.total,e.detalhes[o.display]=n,n.total<e.menorCusto&&(e.menorCusto=n.total,e.melhorOpcao=o.display))}Object.keys(e.custos).length>0&&D.push(e)}if(SORT_COMPARACAO.col&&"nome"!==SORT_COMPARACAO.col)D.sort((e,t)=>{const o=e.custos[SORT_COMPARACAO.col]??1/0,a=t.custos[SORT_COMPARACAO.col]??1/0;return SORT_COMPARACAO.asc?o-a:a-o});else if("nome"===SORT_COMPARACAO.col)D.sort((e,t)=>SORT_COMPARACAO.asc?e.nome.localeCompare(t.nome):t.nome.localeCompare(e.nome));else{const e=I[0]?.display;e&&D.sort((t,o)=>(t.custos[e]??1/0)-(o.custos[e]??1/0))}return{opcoes:I,resultados:D}}function calcularPersParaOpcaoComp(e,t,o,a,i,n,l,s,r){const c=document.getElementById("pers_tar_potencia")?.checked??!0,d=document.getElementById("pers_tar_energia")?.checked??!0,u=document.getElementById("pers_tse_incluido")?.checked??!0;let m=0,p=0,g=0,f=0,_=0,h=0,E={S:{},V:{},F:{},P:{},C:{}};if(e.includes("Simples")){const e=document.getElementById("pers_energia_s");if(!e)return null;m=parseFloat(e.value)||0,h=parseFloat(document.getElementById("pers_potencia_s")?.value)||0}else if(e.includes("Bi")){const e=document.getElementById("pers_energia_v_bi"),t=document.getElementById("pers_energia_f_bi");if(!e||!t)return null;p=parseFloat(e.value)||0,g=parseFloat(t.value)||0,h=parseFloat(document.getElementById("pers_potencia_bi")?.value)||0}else{const e=document.getElementById("pers_energia_v_tri"),t=document.getElementById("pers_energia_c_tri"),o=document.getElementById("pers_energia_p_tri");if(!e||!t||!o)return null;p=parseFloat(e.value)||0,_=parseFloat(t.value)||0,f=parseFloat(o.value)||0,h=parseFloat(document.getElementById("pers_potencia_tri")?.value)||0}if(0===h&&0===m&&0===p&&0===g&&0===f&&0===_)return null;const S=(e,t,o,a)=>{let i=d?e-t:e,n=i+o+(u?0:s);return E[a]={comercialSemTar:i,tarValue:o,tse:u?0:s,tarIncluded:d,tseIncluded:u},n};e.includes("Simples")?m=S(m,t.tarEnBase.S,t.tarEnFinal.S,"S"):e.includes("Bi")?(p=S(p,t.tarEnBase.V,t.tarEnFinal.V,"V"),g=S(g,t.tarEnBase.F,t.tarEnFinal.F,"F")):(p=S(p,t.tarEnBase.V,t.tarEnFinal.V,"V"),f=S(f,t.tarEnBase.P,t.tarEnFinal.P,"P"),_=S(_,t.tarEnBase.C,t.tarEnFinal.C,"C"));let A=c?h-r:h,y=A+t.tarPotRegFinal,v=A*a,T=t.tarPotRegFinal*a,b=0,I=0;o<=3.45?(b=T,I=v):I=v+T;let C=.06*b,B=.23*I;const x=t.consumos;let F=0;F=e.includes("Simples")?m*x.S:e.includes("Bi")?p*x.V+g*x.F:p*x.V+f*x.P+_*x.C;let D=(i?300:200)/30*a,P=0,M=0,V=0,$=0;if(o<=6.9){let e=Math.min(t.totalKwh,D),o=Math.max(0,t.totalKwh-D),a=t.totalKwh?F/t.totalKwh:0;P=e*a,M=o*a,V=.06*P,$=.23*M}else M=F,$=.23*M;let k=12*n/365.25*a,w=t.totalKwh*t.iecVal,O=a>=28&&a<=32?l:l*a/30,L=.23*w,z=.23*O,R=.06*k;return{total:b+I+C+B+(P+M+V+$)+w+L+O+z+k+R,uS:m,uV:p,uF:g,uP:f,uC:_,uPot:y,breakdown:E,potDetails:{comercial:A,tarPotValue:t.tarPotRegFinal,tarIncluded:c},details:{costPot6:b,costPot23:I,costEn6:P,costEn23:M,taxPot6:C,taxPot23:B,taxEn6:V,taxEn23:$,iec:w,dgeg:O,cav:k,taxIEC:L,taxDGEG:z,taxCAV:R,desc:0,quotaACP:0,acrescimo:0,site:"",notas:"Tarif√°rio configurado pelo utilizador."}}}function toggleResumo(){const e=document.getElementById("resumo-content"),t=document.getElementById("resumo-icon");"none"===e.style.display?(e.style.display="block",t.className="fa-solid fa-chevron-down"):(e.style.display="none",t.className="fa-solid fa-chevron-right")}function toggleAnalise(){const e=document.getElementById("analise-content"),t=document.getElementById("analise-icon");"none"===e.style.display?(e.style.display="block",t.className="fa-solid fa-chevron-down"):(e.style.display="none",t.className="fa-solid fa-chevron-right")}function criarTabelaAnalise(e,t){const o={},a=e.Simples||0,i={S:["S"],BD:["V","F"],BS:["V","F"],TD:["V","C","P"],TS:["V","C","P"]};for(const[n,l]of Object.entries(i)){const i="S"===n?a:Object.values(e[n]||{}).reduce((e,t)=>e+t,0);for(const s of l){const l="S"===n?"S":`${n}_${s}`,r="S"===n?a:e[n]?.[s]||0,c=i>0?r/i*100:"S"===n?100:0;o[`${n}_${s}`]={omie:t[l]||0,kwh:r,perc:c}}}const n=(e,t,o=0,a="")=>`<td class="cell-${t}">${((e,t=0,o="")=>{try{return e.toLocaleString("pt-PT",{minimumFractionDigits:t,maximumFractionDigits:t})+o}catch{return"-"}})(e,o,a)}</td>`;return`\n            <style>\n                .analise-table { width: 100%; border-collapse: collapse; font-size: 11px; text-align: center; table-layout: fixed; margin-top:10px; }\n                .analise-table th, .analise-table td { padding: 4px 2px; border: 1px solid #ccc; word-wrap: break-word; overflow: hidden; }\n                .analise-table thead th { font-weight: bold; vertical-align: middle; height: 30px; }\n                \n                /* Estilo da primeira coluna (R√≥tulos) */\n                .row-label { font-weight: 600; text-align: left; padding-left: 8px !important; background-color: #f8fafc; }\n\n                /* Cores Cabe√ßalhos */\n                .header-S { background-color: #A6A6A6; color: #000; }\n                .header-BD { background-color: #A9D08E; color: #000; }\n                .header-BS { background-color: #8EA9DB; color: #000; }\n                .header-TD { background-color: #BF8F00; color: #FFF; }\n                .header-TS { background-color: #C65911; color: #FFF; }\n                \n                /* Cores C√©lulas */\n                .cell-S { background-color: #D9D9D9; } .cell-BD_V { background-color: #C6E0B4; } .cell-BD_F { background-color: #E2EFDA; }\n                .cell-BS_V { background-color: #B4C6E7; } .cell-BS_F { background-color: #D9E1F2; } .cell-TD_V { background-color: #FFD966; }\n                .cell-TD_C { background-color: #FFE699; } .cell-TD_P { background-color: #FFF2CC; } .cell-TS_V { background-color: #F4B084; }\n                .cell-TS_C { background-color: #F8CBAD; } .cell-TS_P { background-color: #FCE4D6; }\n            </style>\n            \n            <table class="analise-table">\n                <colgroup>\n                    <col style="width: 12%;"> <col style="width: 8%;">  <col style="width: 8%;"><col style="width: 8%;"> <col style="width: 8%;"><col style="width: 8%;"> <col style="width: 8%;"><col style="width: 8%;"><col style="width: 8%;"> <col style="width: 8%;"><col style="width: 8%;"><col style="width: 8%;"> </colgroup>\n                <thead>\n                    <tr>\n                        <th rowspan="2"></th>\n                        <th rowspan="2" class="header-S">Simples</th>\n                        <th colspan="2" class="header-BD">Bi-hor√°rio Di√°rio</th>\n                        <th colspan="2" class="header-BS">Bi-hor√°rio Semanal</th>\n                        <th colspan="3" class="header-TD">Tri-hor√°rio Di√°rio</th>\n                        <th colspan="3" class="header-TS">Tri-hor√°rio Semanal</th>\n                    </tr>\n                    <tr>\n                        <th class="cell-BD_V">Vazio</th><th class="cell-BD_F">F.Vazio</th>\n                        <th class="cell-BS_V">Vazio</th><th class="cell-BS_F">F.Vazio</th>\n                        <th class="cell-TD_V">Vazio</th><th class="cell-TD_C">Cheias</th><th class="cell-TD_P">Ponta</th>\n                        <th class="cell-TS_V">Vazio</th><th class="cell-TS_C">Cheias</th><th class="cell-TS_P">Ponta</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    <tr>\n                        <td class="row-label">M√©dia OMIE (‚Ç¨/MWh)</td>\n                        ${n(o.S_S.omie,"S",2)}\n                        ${n(o.BD_V.omie,"BD_V",2)}${n(o.BD_F.omie,"BD_F",2)}\n                        ${n(o.BS_V.omie,"BS_V",2)}${n(o.BS_F.omie,"BS_F",2)}\n                        ${n(o.TD_V.omie,"TD_V",2)}${n(o.TD_C.omie,"TD_C",2)}${n(o.TD_P.omie,"TD_P",2)}\n                        ${n(o.TS_V.omie,"TS_V",2)}${n(o.TS_C.omie,"TS_C",2)}${n(o.TS_P.omie,"TS_P",2)}\n                    </tr>\n                    <tr>\n                        <td class="row-label">Consumo (kWh)</td>\n                        ${n(o.S_S.kwh,"S",0)}\n                        ${n(o.BD_V.kwh,"BD_V",0)}${n(o.BD_F.kwh,"BD_F",0)}\n                        ${n(o.BS_V.kwh,"BS_V",0)}${n(o.BS_F.kwh,"BS_F",0)}\n                        ${n(o.TD_V.kwh,"TD_V",0)}${n(o.TD_C.kwh,"TD_C",0)}${n(o.TD_P.kwh,"TD_P",0)}\n                        ${n(o.TS_V.kwh,"TS_V",0)}${n(o.TS_C.kwh,"TS_C",0)}${n(o.TS_P.kwh,"TS_P",0)}\n                    </tr>\n                    <tr>\n                        <td class="row-label">Peso (%)</td>\n                        ${n(o.S_S.perc,"S",1,"%")}\n                        ${n(o.BD_V.perc,"BD_V",1,"%")}${n(o.BD_F.perc,"BD_F",1,"%")}\n                        ${n(o.BS_V.perc,"BS_V",1,"%")}${n(o.BS_F.perc,"BS_F",1,"%")}\n                        ${n(o.TD_V.perc,"TD_V",1,"%")}${n(o.TD_C.perc,"TD_C",1,"%")}${n(o.TD_P.perc,"TD_P",1,"%")}\n                        ${n(o.TS_V.perc,"TS_V",1,"%")}${n(o.TS_C.perc,"TS_C",1,"%")}${n(o.TS_P.perc,"TS_P",1,"%")}\n                    </tr>\n                </tbody>\n            </table>`}function getTarifarioStyle(e,t){if(t&&t.includes("O Meu Tarif√°rio"))return{cellClass:"cell-meu-tarif",tagClass:"meu-tarif",label:"O Meu Tarif√°rio"};if(t&&t.includes("Tarif√°rio Personalizado"))return{cellClass:"cell-perso",tagClass:"perso",label:"Personalizado"};switch(e){case"Indexado quarto-hor√°rio - Diagrama":return{cellClass:"cell-qh-diagrama",tagClass:"qh-diagrama",label:"Indexado quarto-hor√°rio - Diagrama"};case"Indexado quarto-hor√°rio":case"Indexado quarto-hor√°rio - Perfil":return{cellClass:"cell-qh-perfil",tagClass:"qh-perfil",label:"Indexado quarto-hor√°rio - Perfil"};case"Indexado M√©dia":return{cellClass:"cell-index-media",tagClass:"index-media",label:"Indexado M√©dia"};default:return{cellClass:"cell-fixo",tagClass:"fixo",label:"Fixo"}}}function atualizarResumoSimulacao(){try{const e=document.getElementById("potencia"),t=document.getElementById("ciclo"),o=document.getElementById("d_inicio"),a=document.getElementById("d_fim"),i=document.getElementById("num_dias");if(!(e&&t&&o&&a&&i))return console.log("Elementos do resumo ainda n√£o dispon√≠veis"),void(document.getElementById("resumo-simulacao").style.display="none");const n=parseFloat(e.value),l=t.value,s=o.value.split("-"),r=new Date(parseInt(s[0]),parseInt(s[1])-1,parseInt(s[2])),c=a.value.split("-"),d=new Date(parseInt(c[0]),parseInt(c[1])-1,parseInt(c[2])),u=parseInt(i.value);if(isNaN(r.getTime())||isNaN(d.getTime())||isNaN(u))return void(document.getElementById("resumo-simulacao").style.display="none");const m={S:0,V:0,F:0,P:0,C:0};document.getElementById("kwh_S")&&(m.S=parseFloat(document.getElementById("kwh_S").value)||0),document.getElementById("kwh_V")&&(m.V=parseFloat(document.getElementById("kwh_V").value)||0),document.getElementById("kwh_F")&&(m.F=parseFloat(document.getElementById("kwh_F").value)||0),document.getElementById("kwh_P")&&(m.P=parseFloat(document.getElementById("kwh_P").value)||0),document.getElementById("kwh_C")&&(m.C=parseFloat(document.getElementById("kwh_C").value)||0);const p=m.S+m.V+m.F+m.P+m.C,g=OMIE_VALUES.S,f=OMIE_VALUES.V,_=OMIE_VALUES.F,h=OMIE_VALUES.C,E=OMIE_VALUES.P,S=obter_perfil(p,u,n).replace(/^(perfil_|BTN_)/i,"Perfil ").toUpperCase(),A=document.getElementById("f_segmento"),y=document.getElementById("f_fatura"),v=document.getElementById("f_pagamento"),T=A?A.value:"Todos",b=y?y.value:"Todas",I=v?v.value:"Todos";let C=T;"Todos"===T&&(C="Residencial e Empresarial");let B=`\n                    <li style="margin-bottom:5px;"><b>Segmento:</b> ${C} &nbsp;&nbsp;|&nbsp;&nbsp; <b>Fatura√ß√£o:</b> ${b} &nbsp;&nbsp;|&nbsp;&nbsp; <b>Pagamento:</b> ${I}</li>\n                    <li style="margin-bottom:5px;"><b>${n} kVA</b> em <b>${l}</b></li>\n                `,x="";x=l.includes("Simples")?`Simples: ${m.S.toFixed(0)} kWh`:l.includes("Bi")?`Vazio: ${m.V.toFixed(0)} kWh, Fora Vazio: ${m.F.toFixed(0)} kWh`:`Vazio: ${m.V.toFixed(0)} kWh, Cheias: ${m.C.toFixed(0)} kWh, Ponta: ${m.P.toFixed(0)} kWh`,B+=`<li style="margin-bottom:5px;"><b>Consumos (${p.toFixed(0)} kWh Total):</b> ${x}</li>`;const F=e=>`${e.getDate().toString().padStart(2,"0")}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getFullYear()}`;B+=`<li style="margin-bottom:5px;"><b>Per√≠odo:</b> De ${F(r)} a ${F(d)} (${u} dias)</li>`;let D="";D=l.includes("Simples")?`Simples: ${g.toFixed(2)} ‚Ç¨/MWh`:l.includes("Bi")?`Vazio: ${f.toFixed(2)} ‚Ç¨/MWh, Fora Vazio: ${_.toFixed(2)} ‚Ç¨/MWh`:`Vazio: ${f.toFixed(2)} ‚Ç¨/MWh, Cheias: ${h.toFixed(2)} ‚Ç¨/MWh, Ponta: ${E.toFixed(2)} ‚Ç¨/MWh`;let P="OMIE (M√©dia Final)";if(OMIE_MANUAL)P="OMIE (manual)";else{P=verificarIncluiFuturosOMIP()?"OMIE / OMIP (M√©dia com Futuros)":"OMIE (M√©dia Final)"}B+=`<li style="margin-bottom:5px;"><b>${P}:</b> ${D}</li>`,B+=`<li style="margin-bottom:5px;"><b>Perfil de Consumo:</b> ${S}</li>`;const M=document.getElementById("resumo-list"),V=document.getElementById("resumo-simulacao");M&&V&&(M.innerHTML=B,V.style.display="block")}catch(e){console.error("Erro ao atualizar resumo:",e),document.getElementById("resumo-simulacao").style.display="none"}}function calcularMensagemPoupanca(e){try{const t=document.getElementById("mensagem-poupanca");if(!t)return void console.log("Elemento mensagem-poupanca n√£o encontrado");const o=e.find(e=>e.nome&&e.nome.includes("O Meu Tarif√°rio"));if(!o||!o.total||o.total<=0)return void(t.style.display="none");const a=e.filter(e=>"Utilizador"!==e.tipo&&e.total>0&&!e.nome.includes("O Meu Tarif√°rio"));if(0===a.length)return t.innerHTML=`<span style="color:black; font-weight:normal;">N√£o h√° outros tarif√°rios com custos v√°lidos para comparar com '${o.nome}' (${o.total.toFixed(2)}‚Ç¨).</span>`,void(t.style.display="block");const i=a.reduce((e,t)=>t.total<e.total?t:e),n=o.total,l=i.total;if(n>l){const e=n-l,a=e/n*100;t.innerHTML=`\n                        <span style="color:red; font-weight:bold;">\n                            Poupan√ßa entre '${o.nome}' (${n.toFixed(2)} ‚Ç¨) e o mais econ√≥mico da lista, \n                            ${i.nome} (${l.toFixed(2)} ‚Ç¨): \n                        </span>\n                        <span style="color:red; font-weight:bold;">${e.toFixed(2)} ‚Ç¨</span>\n                        <span style="color:red; font-weight:bold;"> (${a.toFixed(2)} %).</span>\n                    `}else t.innerHTML=`<span style="color:green; font-weight:bold;">Parab√©ns! O seu tarif√°rio ('${o.nome}' - ${n.toFixed(2)}‚Ç¨) j√° √© o mais econ√≥mico ou est√° entre os mais econ√≥micos da lista!</span>`;t.style.display="block"}catch(e){console.error("Erro ao calcular mensagem de poupan√ßa:",e);const t=document.getElementById("mensagem-poupanca");t&&(t.style.display="none")}}function gerarCorGradiente(e,t,o){try{if(isNaN(e)||null===t||null===o||void 0===t||void 0===o||o===t)return{bg:"#FFFFFF",text:"#000000"};const a=(t+o)/2;let i=255,n=255,l=255;const s=[90,138,198],r=[255,255,255],c=[247,150,70];if(e<=a){const o=(e-t)/(a-t);i=Math.round(s[0]*(1-o)+r[0]*o),n=Math.round(s[1]*(1-o)+r[1]*o),l=Math.round(s[2]*(1-o)+r[2]*o)}else{const t=(e-a)/(o-a);i=Math.round(r[0]*(1-t)+c[0]*t),n=Math.round(r[1]*(1-t)+c[1]*t),l=Math.round(r[2]*(1-t)+c[2]*t)}const d=.299*i+.587*n+.114*l>140?"#000000":"#FFFFFF";return{bg:"#"+[i,n,l].map(e=>e.toString(16).padStart(2,"0")).join("").toUpperCase(),text:d}}catch(e){return console.error("Erro ao gerar cor gradiente:",e),{bg:"#FFFFFF",text:"#000000"}}}function renderTable(e,t){const o=document.getElementById("thead"),a=document.getElementById("tbody");a.innerHTML="";let i="";t.includes("Simples")?i="ciclo-simples":t.includes("Bi-hor√°rio")&&t.includes("Di√°rio")?i="ciclo-bi-diario":t.includes("Bi-hor√°rio")&&t.includes("Semanal")?i="ciclo-bi-semanal":t.includes("Tri-hor√°rio")&&t.includes("Di√°rio")?i="ciclo-tri-diario":t.includes("Tri-hor√°rio")&&t.includes("Semanal")&&(i="ciclo-tri-semanal");let n=`<th class="${i}" onclick="setSort('nome')">Tarif√°rio <i class="fa-solid fa-sort"></i></th>\n                     <th class="${i}" onclick="setSort('total')">Total (‚Ç¨) <i class="fa-solid fa-sort"></i></th>`;const l=(e,t)=>`<th class="${i}" onclick="setSort('${t}')">${e} <i class="fa-solid fa-sort"></i></th>`;t.includes("Simples")?n+=l("Simples (‚Ç¨/kWh)","uS")+l("Pot√™ncia (‚Ç¨/dia)","uPot"):t.includes("Bi")?n+=l("Vazio (‚Ç¨/kWh)","uV")+l("Fora Vazio (‚Ç¨/kWh)","uF")+l("Pot√™ncia (‚Ç¨/dia)","uPot"):n+=l("Vazio (‚Ç¨/kWh)","uV")+l("Cheias (‚Ç¨/kWh)","uC")+l("Ponta (‚Ç¨/kWh)","uP")+l("Pot√™ncia (‚Ç¨/dia)","uPot"),n+=`<th class="${i}">Detalhes</th>`,o.innerHTML=`<tr>${n}</tr>`;const s=(e,t)=>{const o=e.map(e=>e[t]).filter(e=>null!=e&&!isNaN(e));return 0===o.length?{min:null,max:null}:{min:Math.min(...o),max:Math.max(...o)}},r=s(e,"total"),c=s(e,"uS"),d=s(e,"uV"),u=s(e,"uF"),m=s(e,"uP"),p=s(e,"uC"),g=s(e,"uPot"),f=e=>e.toFixed(4),_=e=>JSON.stringify(e).replace(/"/g,"&quot;");e.slice(0,150).forEach(e=>{const o=getTarifarioStyle(e.tipo,e.nome),i=gerarCorGradiente(e.total,r.min,r.max);let n=`\n                    <td class="${o.cellClass}">\n                        <div class="tariff-name" onclick="window.open('${e.details.site||"#"}', '_blank')" onmouseenter="showTooltipNome(event, ${_(e.nome)}, ${_(e.details.notas||"")})" onmouseleave="hideTooltip()">${e.com}</div>\n                        <div style="font-size:0.78rem; color:var(--text-light); margin-bottom:4px;">${e.nome}</div>\n                        <span class="tag ${o.tagClass}">${o.label}</span>\n                    </td>\n                    <td class="price-main" style="background-color:${i.bg}; color:${i.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipTotal(event, ${_(e.details)}, ${_(e.nome)})" onmouseleave="hideTooltip()">${e.total.toFixed(2)} ‚Ç¨</td>`;if(t.includes("Simples")){const t=gerarCorGradiente(e.uS,c.min,c.max),o=gerarCorGradiente(e.uPot,g.min,g.max);n+=`<td class="price-sub" style="background-color:${t.bg}; color:${t.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipEnergy(event, ${_(e.breakdown.S)}, 'S')" onmouseleave="hideTooltip()">${f(e.uS)}</td>`,n+=`<td class="price-sub" style="background-color:${o.bg}; color:${o.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipPot(event, ${_(e.potDetails)})" onmouseleave="hideTooltip()">${f(e.uPot)}</td>`}else if(t.includes("Bi")){const t=gerarCorGradiente(e.uV,d.min,d.max),o=gerarCorGradiente(e.uF,u.min,u.max),a=gerarCorGradiente(e.uPot,g.min,g.max);n+=`<td class="price-sub" style="background-color:${t.bg}; color:${t.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipEnergy(event, ${_(e.breakdown.V)}, 'V')" onmouseleave="hideTooltip()">${f(e.uV)}</td>`,n+=`<td class="price-sub" style="background-color:${o.bg}; color:${o.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipEnergy(event, ${_(e.breakdown.F)}, 'F')" onmouseleave="hideTooltip()">${f(e.uF)}</td>`,n+=`<td class="price-sub" style="background-color:${a.bg}; color:${a.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipPot(event, ${_(e.potDetails)})" onmouseleave="hideTooltip()">${f(e.uPot)}</td>`}else{const t=gerarCorGradiente(e.uV,d.min,d.max),o=gerarCorGradiente(e.uP,m.min,m.max),a=gerarCorGradiente(e.uC,p.min,p.max),i=gerarCorGradiente(e.uPot,g.min,g.max);n+=`<td class="price-sub" style="background-color:${t.bg}; color:${t.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipEnergy(event, ${_(e.breakdown.V)}, 'V')" onmouseleave="hideTooltip()">${f(e.uV)}</td>`,n+=`<td class="price-sub" style="background-color:${a.bg}; color:${a.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipEnergy(event, ${_(e.breakdown.C)}, 'C')" onmouseleave="hideTooltip()">${f(e.uC)}</td>`,n+=`<td class="price-sub" style="background-color:${o.bg}; color:${o.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipEnergy(event, ${_(e.breakdown.P)}, 'P')" onmouseleave="hideTooltip()">${f(e.uP)}</td>`,n+=`<td class="price-sub" style="background-color:${i.bg}; color:${i.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipPot(event, ${_(e.potDetails)})" onmouseleave="hideTooltip()">${f(e.uPot)}</td>`}let l="";e.details.site&&(l+=`<a href="${e.details.site}" target="_blank" title="Aderir" style="color:var(--primary); margin-right:8px;"><i class="fa-solid fa-link"></i></a>`),e.details.notas&&(l+=`<i class="fa-solid fa-circle-info" title="${e.details.notas}" style="color:var(--text-light); cursor:help"></i>`),n+=`<td style="font-size:1.1em">${l}</td>`,a.innerHTML+=`<tr>${n}</tr>`}),makeColumnsResizable()}function renderTableComparacao(e,t){const o=document.getElementById("thead"),a=document.getElementById("tbody");a.innerHTML="";const i=e.opcoes||[],n=e.resultados||[];if(i.length<=1||0===n.length)return void renderTable(n,t);const l=e=>e.includes("Simples")?"ciclo-simples":e.includes("Bi")&&e.includes("Semanal")?"ciclo-bi-semanal":e.includes("Bi")?"ciclo-bi-diario":e.includes("Tri")&&e.includes("Semanal")?"ciclo-tri-semanal":e.includes("Tri")?"ciclo-tri-diario":"";l(t);let s={};i.forEach(e=>{let t="",o=1/0;n.forEach(a=>{const i=a.custos[e.display];void 0!==i&&!isNaN(i)&&i<o&&"Utilizador"!==a.tipo&&(o=i,t=a.com+" - "+a.nome)}),t&&(s[e.display]={nome:t,custo:o})});const r=n.find(e=>"Utilizador"===e.tipo),c=r?Object.keys(r.custos)[0]:null,d=r&&c?r.custos[c]:null;let u='<div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #bae6fd; border-radius: 10px; padding: 14px 18px; margin-bottom: 14px; font-size: 0.85rem; line-height: 1.6;">';u+='<div style="font-weight: 700; margin-bottom: 6px; color: #0369a1;"><i class="fa-solid fa-trophy" style="margin-right:6px;"></i>Melhores Op√ß√µes por Ciclo</div>',i.forEach(e=>{const t=s[e.display];if(!t)return;let o=l(e.display),a="#e5e7eb";o.includes("simples")?a="#A6A6A6":o.includes("bi-semanal")?a="#8EA9DB":o.includes("bi-diario")?a="#A9D08E":o.includes("tri-semanal")?a="#C65911":o.includes("tri-diario")&&(a="#BF8F00");let i=o.includes("tri")?"#fff":"#000";if(u+='<div style="margin: 4px 0;">',u+=`<span style="display:inline-block; background:${a}; color:${i}; padding:2px 8px; border-radius:4px; font-weight:600; font-size:0.78rem; min-width:90px; text-align:center;">${e.display}</span> `,u+=`<strong>${t.nome}</strong> com <strong style="color:#16a34a;">${t.custo.toFixed(2)} ‚Ç¨</strong>`,null!==d){const e=d-t.custo;u+=e>.01?` <span style="color:#16a34a; font-size:0.8rem;">(poupa ${e.toFixed(2)} ‚Ç¨ vs O Meu Tarif√°rio)</span>`:e<-.01?` <span style="color:#dc2626; font-size:0.8rem;">(+${Math.abs(e).toFixed(2)} ‚Ç¨ vs O Meu Tarif√°rio)</span>`:' <span style="color:#6b7280; font-size:0.8rem;">(‚âà O Meu Tarif√°rio)</span>'}u+="</div>"}),u+="</div>";let m=document.getElementById("comparacao-summary");if(!m){m=document.createElement("div"),m.id="comparacao-summary";const e=document.getElementById("tabela");e.parentNode.insertBefore(m,e)}m.innerHTML=u;let p='<th onclick="setSortComparacao(\'nome\')">Tarif√°rio <i class="fa-solid fa-sort"></i></th>';i.forEach(e=>{let t=l(e.display);p+=`<th class="${t}" onclick="setSortComparacao('${e.display}')">${e.display} (‚Ç¨) <i class="fa-solid fa-sort"></i></th>`}),p+="<th>Detalhes</th>",o.innerHTML=`<tr>${p}</tr>`;const g={};i.forEach(e=>{const t=n.map(t=>t.custos[e.display]).filter(e=>null!=e&&!isNaN(e));t.length>0?g[e.display]={min:Math.min(...t),max:Math.max(...t)}:g[e.display]={min:null,max:null}});const f=e=>JSON.stringify(e).replace(/\"/g,"&quot;");n.slice(0,150).forEach(e=>{const t=getTarifarioStyle(e.tipo,e.nome);let o=`\n                    <td class="${t.cellClass}">\n                        <div class="tariff-name" ${e.site?`onclick="window.open('${e.site}', '_blank')"`:""}>${e.com}</div>\n                        <div style="font-size:0.78rem; color:var(--text-light); margin-bottom:4px;">${e.nome}</div>\n                        <span class="tag ${t.tagClass}">${t.label}</span>\n                    </td>`;i.forEach(t=>{const a=e.custos[t.display],i=e.detalhes?e.detalhes[t.display]:null;if(null==a||isNaN(a))o+='<td style="text-align:center; color:var(--text-light);">‚Äî</td>';else{const n=g[t.display],l=gerarCorGradiente(a,n.min,n.max),s=e.melhorOpcao===t.display&&Object.keys(e.custos).length>1,r=i?`onmouseenter="showTooltipComparacao(event, ${f(i)}, ${f(e.nome)}, ${f(t.display)})" onmouseleave="hideTooltip()"`:"";o+=`<td class="price-main" style="background-color:${l.bg}; color:${l.text}; text-align:center; border-radius:10px; cursor:default; ${s?"font-weight:bold; border:2px solid #16a34a;":""}" ${r}>${a.toFixed(2)} ‚Ç¨</td>`}});let n="";e.site&&(n+=`<a href="${e.site}" target="_blank" title="Aderir" style="color:var(--primary); margin-right:8px;"><i class="fa-solid fa-link"></i></a>`),e.notas&&(n+=`<i class="fa-solid fa-circle-info" title="${e.notas}" style="color:var(--text-light); cursor:help"></i>`),o+=`<td style="font-size:1.1em; text-align:center;">${n}</td>`,a.innerHTML+=`<tr>${o}</tr>`}),makeColumnsResizable()}window.onload=async()=>{const e=new Date,t=new Date(e);t.setDate(e.getDate()+1);const o=new Date(t),a=t.getDate();o.setMonth(o.getMonth()+1),o.getDate()!==a&&o.setDate(0),o.setDate(o.getDate()-1);const i=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,n=document.getElementById("d_inicio"),l=document.getElementById("d_fim"),s=e.getFullYear();n.min=`${s}-01-01`,n.max=`${s+2}-12-31`,l.min=`${s}-01-01`,l.max=`${s+2}-12-31`,n.value=i(t),l.value=i(o),atualizarDias();try{setLoaderMsg("");const e=await getCachedData();if(e)return setLoaderMsg("A carregar dados em cache..."),void loadData(e);setLoaderMsg("A atualizar...");const t=await fetch(FILENAME);if(!t.ok)throw new Error("Fetch falhou");const o=await t.arrayBuffer();setCachedData(o),setLoaderMsg("A processar dados..."),loadData(o)}catch(e){document.getElementById("loader").innerHTML='\n                    <div style="color:#d97706; margin-bottom:15px; font-family:sans-serif;">\n                        <i class="fa-solid fa-triangle-exclamation fa-2x"></i>\n                        <p style="margin:5px 0">N√£o foi poss√≠vel carregar automaticamente.</p>\n                        <p style="font-size:0.85rem; color:var(--text-light);">Verifique a liga√ß√£o ou carregue manualmente.</p>\n                    </div>\n                    <label style="background:#0066cc; color:white; padding:10px 20px; border-radius:5px; cursor:pointer; font-family:sans-serif; display:inline-block;">\n                        <i class="fa-solid fa-upload"></i> Carregar "Tarifarios.xlsx"\n                        <input type="file" style="display:none" accept=".xlsx" onchange="lerBaseDadosManual(this)">\n                    </label>\n                '}};let SORT_COMPARACAO={col:"",asc:!0};function setSortComparacao(e){SORT_COMPARACAO.col===e?SORT_COMPARACAO.asc=!SORT_COMPARACAO.asc:(SORT_COMPARACAO.col=e,SORT_COMPARACAO.asc=!0),calcular()}function makeColumnsResizable(){document.getElementById("tabela").querySelectorAll("th").forEach(e=>{if(e.querySelector(".resizer"))return;const t=document.createElement("div");let o,a;t.classList.add("resizer"),e.appendChild(t),t.addEventListener("mousedown",t=>{o=t.pageX,a=e.offsetWidth;const i=t=>{const i=a+(t.pageX-o);e.style.width=i+"px"},n=()=>{document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",n)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",n)})})}function setSort(e){SORT.col===e?SORT.asc=!SORT.asc:(SORT.col=e,SORT.asc=!0),calcular()}function showTooltipTotal(e,t,o){const a=document.getElementById("tooltip");let i='<div style="font-weight:700; margin-bottom:8px; font-size:0.9rem;">Decomposi√ß√£o Custo Total</div>';i+=`<div style="font-size:0.8rem; color:#cbd5e1; margin-bottom:8px;">${o||""}</div>`;let n=t.costPot6>0||t.taxPot6>0,l=t.costPot23>0||t.taxPot23>0;(n||l)&&(i+='<div style="font-weight:600; margin-top:8px; color:#cbd5e1; font-size:0.75rem;">POT√äNCIA</div>',n&&(i+=`<div class="tooltip-line"><span>Pot√™ncia (base s/ IVA 6%):</span><span>${t.costPot6.toFixed(2)} ‚Ç¨</span></div>`),l&&(i+=`<div class="tooltip-line"><span>Pot√™ncia (base s/ IVA 23%):</span><span>${t.costPot23.toFixed(2)} ‚Ç¨</span></div>`));let s=t.costEn6>0||t.taxEn6>0,r=t.costEn23>0||t.taxEn23>0;(s||r)&&(i+='<div style="font-weight:600; margin-top:8px; color:#cbd5e1; font-size:0.75rem;">ENERGIA</div>',s&&(i+=`<div class="tooltip-line"><span>Energia (base s/ IVA 6%):</span><span>${t.costEn6.toFixed(2)} ‚Ç¨</span></div>`),r&&(i+=`<div class="tooltip-line"><span>Energia (base s/ IVA 23%):</span><span>${t.costEn23.toFixed(2)} ‚Ç¨</span></div>`));let c=(t.costPot6||0)+(t.costPot23||0)+(t.costEn6||0)+(t.costEn23||0);i+=`<div class="tooltip-line subtotal"><span>Subtotal Pot√™ncia + Energia:</span><span>${c.toFixed(2)} ‚Ç¨</span></div>`,i+='<div style="font-weight:600; margin-top:8px; color:#cbd5e1; font-size:0.75rem;">TAXAS E CONTRIBUI√á√ïES</div>',i+=`<div class="tooltip-line"><span>CAV s/ IVA:</span><span>${t.cav.toFixed(2)} ‚Ç¨</span></div>`,i+=`<div class="tooltip-line"><span>DGEG s/ IVA:</span><span>${t.dgeg.toFixed(2)} ‚Ç¨</span></div>`,i+=`<div class="tooltip-line"><span>IEC s/ IVA:</span><span>${t.iec.toFixed(4)} ‚Ç¨</span></div>`;let d=t.cav+t.dgeg+t.iec;i+=`<div class="tooltip-line subtotal"><span>Subtotal Taxas:</span><span>${d.toFixed(2)} ‚Ç¨</span></div>`;let u=c+d;i+=`<div class="tooltip-line subtotal"><span><strong>Total s/ IVA:</strong></span><span><strong>${u.toFixed(2)} ‚Ç¨</strong></span></div>`,i+='<div class="tooltip-section"></div>',i+='<div style="font-weight:600; margin-top:6px; color:#cbd5e1; font-size:0.75rem;">IVA</div>';let m=(t.taxPot6||0)+(t.taxEn6||0)+(t.taxCAV||0),p=(t.taxPot23||0)+(t.taxEn23||0)+(t.taxIEC||0)+(t.taxDGEG||0);m>0&&(i+=`<div class="tooltip-line"><span>IVA 6%:</span><span>${m.toFixed(2)} ‚Ç¨</span></div>`),i+=`<div class="tooltip-line"><span>IVA 23%:</span><span>${p.toFixed(2)} ‚Ç¨</span></div>`;let g=u+m+p;(t.desc>0||t.quotaACP>0||t.acrescimo>0)&&(i+='<div class="tooltip-section"></div>',t.desc>0&&(i+=`<div class="tooltip-line"><span>Desconto Fatura:</span><span style="color:#4ade80">-${t.desc.toFixed(2)} ‚Ç¨</span></div>`),t.quotaACP>0&&(i+=`<div class="tooltip-line"><span>Quota ACP:</span><span style="color:#f87171">+${t.quotaACP.toFixed(2)} ‚Ç¨</span></div>`),t.acrescimo>0&&(i+=`<div class="tooltip-line"><span>Acr√©scimo Fatura:</span><span style="color:#f87171">+${t.acrescimo.toFixed(2)} ‚Ç¨</span></div>`)),i+=`<div class="tooltip-line total"><span>CUSTO TOTAL:</span><span>${(g-(t.desc||0)+(t.quotaACP||0)+(t.acrescimo||0)).toFixed(2)} ‚Ç¨</span></div>`,a.innerHTML=i,a.classList.remove("hidden"),positionTooltip(e,a)}function showTooltipComparacao(e,t,o,a){const i=document.getElementById("tooltip"),n=t.details;if(!n)return;let l='<div style="font-weight:700; margin-bottom:4px; font-size:0.9rem;">Decomposi√ß√£o Custo Total</div>';l+=`<div style="font-size:0.8rem; color:#cbd5e1; margin-bottom:6px;">${o||""}</div>`,l+=`<div style="font-size:0.78rem; color:#93c5fd; margin-bottom:8px; font-style:italic;">${a||""}</div>`,l+='<div style="font-weight:600; color:#fbbf24; font-size:0.75rem; margin-bottom:2px;">PRE√áOS UNIT√ÅRIOS (s/ IVA)</div>';const s=e=>void 0!==e&&0!==e?e.toFixed(4):null;let r=!1;s(t.uS)&&(l+=`<div class="tooltip-line"><span>Energia Simples:</span><span>${s(t.uS)} ‚Ç¨/kWh</span></div>`,r=!0),s(t.uV)&&(l+=`<div class="tooltip-line"><span>Energia Vazio:</span><span>${s(t.uV)} ‚Ç¨/kWh</span></div>`,r=!0),s(t.uF)&&(l+=`<div class="tooltip-line"><span>Energia Fora Vazio:</span><span>${s(t.uF)} ‚Ç¨/kWh</span></div>`,r=!0),s(t.uC)&&(l+=`<div class="tooltip-line"><span>Energia Cheias:</span><span>${s(t.uC)} ‚Ç¨/kWh</span></div>`,r=!0),s(t.uP)&&(l+=`<div class="tooltip-line"><span>Energia Ponta:</span><span>${s(t.uP)} ‚Ç¨/kWh</span></div>`,r=!0),s(t.uPot)&&(l+=`<div class="tooltip-line"><span>Pot√™ncia:</span><span>${s(t.uPot)} ‚Ç¨/dia</span></div>`,r=!0),r||(l+='<div class="tooltip-line" style="color:#94a3b8;"><span>‚Äî</span></div>'),l+='<div class="tooltip-section"></div>';let c=n.costPot6>0||n.taxPot6>0,d=n.costPot23>0||n.taxPot23>0;(c||d)&&(l+='<div style="font-weight:600; margin-top:4px; color:#cbd5e1; font-size:0.75rem;">POT√äNCIA</div>',c&&(l+=`<div class="tooltip-line"><span>Pot√™ncia (base s/ IVA 6%):</span><span>${n.costPot6.toFixed(2)} ‚Ç¨</span></div>`),d&&(l+=`<div class="tooltip-line"><span>Pot√™ncia (base s/ IVA 23%):</span><span>${n.costPot23.toFixed(2)} ‚Ç¨</span></div>`));let u=n.costEn6>0||n.taxEn6>0,m=n.costEn23>0||n.taxEn23>0;(u||m)&&(l+='<div style="font-weight:600; margin-top:4px; color:#cbd5e1; font-size:0.75rem;">ENERGIA</div>',u&&(l+=`<div class="tooltip-line"><span>Energia (base s/ IVA 6%):</span><span>${n.costEn6.toFixed(2)} ‚Ç¨</span></div>`),m&&(l+=`<div class="tooltip-line"><span>Energia (base s/ IVA 23%):</span><span>${n.costEn23.toFixed(2)} ‚Ç¨</span></div>`));let p=(n.costPot6||0)+(n.costPot23||0)+(n.costEn6||0)+(n.costEn23||0);l+=`<div class="tooltip-line subtotal"><span>Subtotal Pot√™ncia + Energia:</span><span>${p.toFixed(2)} ‚Ç¨</span></div>`,l+='<div style="font-weight:600; margin-top:4px; color:#cbd5e1; font-size:0.75rem;">TAXAS E CONTRIBUI√á√ïES</div>',l+=`<div class="tooltip-line"><span>CAV s/ IVA:</span><span>${n.cav.toFixed(2)} ‚Ç¨</span></div>`,l+=`<div class="tooltip-line"><span>DGEG s/ IVA:</span><span>${n.dgeg.toFixed(2)} ‚Ç¨</span></div>`,l+=`<div class="tooltip-line"><span>IEC s/ IVA:</span><span>${n.iec.toFixed(4)} ‚Ç¨</span></div>`;let g=n.cav+n.dgeg+n.iec;l+=`<div class="tooltip-line subtotal"><span>Subtotal Taxas:</span><span>${g.toFixed(2)} ‚Ç¨</span></div>`;let f=p+g;l+=`<div class="tooltip-line subtotal"><span><strong>Total s/ IVA:</strong></span><span><strong>${f.toFixed(2)} ‚Ç¨</strong></span></div>`,l+='<div class="tooltip-section"></div>',l+='<div style="font-weight:600; margin-top:4px; color:#cbd5e1; font-size:0.75rem;">IVA</div>';let _=(n.taxPot6||0)+(n.taxEn6||0)+(n.taxCAV||0),h=(n.taxPot23||0)+(n.taxEn23||0)+(n.taxIEC||0)+(n.taxDGEG||0);_>0&&(l+=`<div class="tooltip-line"><span>IVA 6%:</span><span>${_.toFixed(2)} ‚Ç¨</span></div>`),l+=`<div class="tooltip-line"><span>IVA 23%:</span><span>${h.toFixed(2)} ‚Ç¨</span></div>`;let E=f+_+h;(n.desc>0||n.quotaACP>0||n.acrescimo>0)&&(l+='<div class="tooltip-section"></div>',n.desc>0&&(l+=`<div class="tooltip-line"><span>Desconto Fatura:</span><span style="color:#4ade80">-${n.desc.toFixed(2)} ‚Ç¨</span></div>`),n.quotaACP>0&&(l+=`<div class="tooltip-line"><span>Quota ACP:</span><span style="color:#f87171">+${n.quotaACP.toFixed(2)} ‚Ç¨</span></div>`),n.acrescimo>0&&(l+=`<div class="tooltip-line"><span>Acr√©scimo Fatura:</span><span style="color:#f87171">+${n.acrescimo.toFixed(2)} ‚Ç¨</span></div>`)),l+=`<div class="tooltip-line total"><span>CUSTO TOTAL:</span><span>${(E-(n.desc||0)+(n.quotaACP||0)+(n.acrescimo||0)).toFixed(2)} ‚Ç¨</span></div>`,i.innerHTML=l,i.classList.remove("hidden"),positionTooltip(e,i)}function showTooltipEnergy(e,t,o){const a=document.getElementById("tooltip");let i=`<div style="font-weight:700; margin-bottom:6px; font-size:0.85rem;">Decomposi√ß√£o Pre√ßo ${{S:"Simples",V:"Vazio",F:"Fora Vazio",C:"Cheias",P:"Ponta"}[o]||"Energia"} s/IVA</div>`;i+=`<div class="tooltip-line"><span>Comercial (s/ TAR):</span><span>${t.comercialSemTar.toFixed(4)} ‚Ç¨</span></div>`,i+=`<div class="tooltip-line"><span>TAR (Acesso Redes):</span><span>${t.tarValue.toFixed(4)} ‚Ç¨</span></div>`,t.tseIncluded?i+='<div class="tooltip-line" style="background-color:#78350f20; padding:4px; border-radius:4px; color:#fbbf24;"><span>‚ÑπÔ∏è Financiamento TSE inclu√≠do no pre√ßo</span></div>':i+=`<div class="tooltip-line"><span>Financ. TSE:</span><span>${t.tse.toFixed(4)} ‚Ç¨</span></div>`,i+=`<div class="tooltip-line total"><span>TOTAL UNIT√ÅRIO:</span><span>${(t.comercialSemTar+t.tarValue+t.tse).toFixed(4)} ‚Ç¨</span></div>`,a.innerHTML=i,a.classList.remove("hidden"),positionTooltip(e,a)}function showTooltipNome(e,t,o){const a=document.getElementById("tooltip");let i=`<div style="font-weight:700; margin-bottom:8px; font-size:0.9rem;">${t}</div>`;o&&o.trim()&&(i+=`<div style="font-size:0.85rem; line-height:1.4;">${o}</div>`),a.innerHTML=i,a.classList.remove("hidden"),positionTooltip(e,a)}function showTooltipPot(e,t){const o=document.getElementById("tooltip");let a='<div style="font-weight:700; margin-bottom:6px; font-size:0.85rem;">Decomposi√ß√£o Pot√™ncia s/IVA</div>',i=parseFloat(document.getElementById("potencia").value)<=3.45?"IVA 6%":"IVA 23%";a+=`<div class="tooltip-line"><span>Comercial (IVA 23%):</span><span>${t.comercial.toFixed(4)} ‚Ç¨</span></div>`,a+=`<div class="tooltip-line"><span>TAR (${i}):</span><span>${t.tarPotValue.toFixed(4)} ‚Ç¨</span></div>`,a+=`<div class="tooltip-line total"><span>TOTAL UNIT√ÅRIO:</span><span>${(t.comercial+t.tarPotValue).toFixed(4)} ‚Ç¨</span></div>`,o.innerHTML=a,o.classList.remove("hidden"),positionTooltip(e,o)}function positionTooltip(e,t){let o=e.pageX+15,a=e.pageY+15;setTimeout(()=>{o+t.offsetWidth>window.innerWidth&&(o=e.pageX-t.offsetWidth-15),a+t.offsetHeight>window.innerHeight+window.scrollY&&(a=e.pageY-t.offsetHeight-15),t.style.left=o+"px",t.style.top=a+"px"},0)}function limparDadosERedes(){DADOS_EREDES=null,STATE_ABA3.ficheiroProcessado=!1,STATE_ABA3.dadosERedes=null,STATE_ABA3.dataInicio=null,STATE_ABA3.dataFim=null,STATE_ABA3.consumos={S:0,V:0,F:0,C:0,P:0},document.getElementById("d_inicio").disabled=!1,document.getElementById("d_fim").disabled=!1;["kwh_S","kwh_V","kwh_F","kwh_C","kwh_P"].forEach(e=>{const t=document.getElementById(e);t&&(t.disabled=!1)});const e=getDefaultDates(),t=(new Date).getFullYear();document.getElementById("d_inicio").min=`${t}-01-01`,document.getElementById("d_inicio").max=`${t+2}-12-31`,document.getElementById("d_fim").min=`${t}-01-01`,document.getElementById("d_fim").max=`${t+2}-12-31`,document.getElementById("d_inicio").value=e.start,document.getElementById("d_fim").value=e.end,document.getElementById("analise-consumos").style.display="none",document.getElementById("analise-content").innerHTML="";const o=document.getElementById("graficos-analise-eredes");o&&(o.style.display="none");const a=document.getElementById("analise-potencia");a&&(a.style.display="none"),document.getElementById("eredes-upload").style.display="block",document.getElementById("eredes-limpar").style.display="none",document.getElementById("eredes-status").innerHTML="",document.getElementById("eredes-info").innerHTML="",document.getElementById("file-eredes").value="";const i=document.getElementById("file-eredes-central");i&&(i.value="");const n=document.getElementById("eredes-status-central");n&&(n.innerHTML="");const l=document.getElementById("omie-panel");l&&l.classList.remove("hidden"),OMIE_MANUAL=!1,"advanced"===CURRENT_TAB?(document.getElementById("app").classList.add("hidden"),document.getElementById("eredes-upload-central").classList.remove("hidden")):construirInputsConsumo(),atualizarDias()}function hideTooltip(){document.getElementById("tooltip").classList.add("hidden")}function lerBaseDadosManual(e){const t=e.files[0];if(t){const e=new FileReader;e.onload=e=>loadData(e.target.result),e.readAsArrayBuffer(t)}}let DADOS_EREDES=null;async function processarFicheirosERedes(){const e=document.getElementById("file-eredes"),t=document.getElementById("eredes-status"),o=document.getElementById("eredes-info");if(e.files&&0!==e.files.length){t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> A processar ficheiros...',o.style.display="none";try{const o=[];for(let a=0;a<e.files.length;a++){const i=e.files[a];t.innerHTML=`<i class="fa-solid fa-spinner fa-spin"></i> A processar ${i.name} (${a+1}/${e.files.length})...`;const n=await processarFicheiroERedes(i);if(n.erro)return void(t.innerHTML=`<span style="color:red;">‚ùå Erro: ${n.erro}</span>`);o.push(n.dados)}const a=validarEJuntarFicheiros(o);if(a.erro)return void(t.innerHTML=`<span style="color:red;">‚ùå ${a.erro}</span>`);const i=agregarConsumosPorPeriodo(a.dados),n=calcularMediasOMIE(a.dados),l=a.dados[0],s=a.dados[a.dados.length-1],r=l.DataHora.split("T")[0],c=s.DataHora.split("T")[0],d=new Date(r),u=new Date(c),m=Math.abs(u-d),p=Math.ceil(m/864e5)+1;DADOS_EREDES={dadosBrutos:a.dados,consumosAgregados:i,mediasOMIE:n,periodo:{inicio:r,fim:c,dias:p}},aplicarDadosERedes(),n.S&&(OMIE_VALUES.S=n.S,n.BD_V&&(OMIE_VALUES.V=n.BD_V));const g=document.getElementById("ciclo").value;if(g.includes("Simples")){const e=document.getElementById("kwh_S");e&&(e.value=Math.round(i.Simples))}else if(g.includes("Bi")){const e=g.includes("Di√°rio")?"BD":"BS",t=document.getElementById("kwh_V"),o=document.getElementById("kwh_F");t&&(t.value=Math.round(i[e].V)),o&&(o.value=Math.round(i[e].F))}else{const e=g.includes("Di√°rio")?"TD":"TS",t=document.getElementById("kwh_V"),o=document.getElementById("kwh_P"),a=document.getElementById("kwh_C");t&&(t.value=Math.round(i[e].V)),o&&(o.value=Math.round(i[e].P)),a&&(a.value=Math.round(i[e].C))}const f=criarTabelaAnalise(i,n);document.getElementById("analise-content").innerHTML=f,document.getElementById("analise-consumos").style.display="block";const _=a.aviso||"";document.getElementById("eredes-upload").style.display="none",document.getElementById("eredes-limpar").style.display="block";const h=e.files.length,E=e=>e.split("-").reverse().join("/");document.getElementById("eredes-resumo").innerHTML=`\n                    <b>${h} ficheiro(s):</b> ${E(r)} a ${E(c)} (${p} dias)\n                    ${_?`<br><span style="color:#d97706;">${_}</span>`:""}\n                `,calcular()}catch(e){console.error("Erro ao processar ficheiros:",e),t.innerHTML=`<span style="color:red;">‚ùå Erro: ${e.message}</span>`}}else t.innerHTML='<span style="color:red;">‚ö†Ô∏è Selecione pelo menos um ficheiro Excel</span>'}async function processarFicheiroERedes(e){return new Promise((t,o)=>{const a=new FileReader;a.onload=function(o){try{const a=new Uint8Array(o.target.result),i=XLSX.read(a,{type:"array"}),n=i.SheetNames[0],l=i.Sheets[n],s=XLSX.utils.sheet_to_json(l,{header:1,defval:null}),r=detectarCabecalho(s);if(r.erro)return void t({erro:`${e.name}: ${r.erro}`});const c=processarDadosConsumo(s,r.headerRow,r.colunaConsumo);if(c.erro)return void t({erro:`${e.name}: ${c.erro}`});t({dados:c.registos})}catch(o){t({erro:`${e.name}: ${o.message}`})}},a.onerror=()=>t({erro:`${e.name}: Erro ao ler ficheiro`}),a.readAsArrayBuffer(e)})}function detectarCabecalho(e){const t=["Consumo Simulado (kW)","Consumo medido na IC, Ativa (kW)","Consumo registado (kW)","Consumo registado, Ativa (kW)"];for(let o=0;o<Math.min(20,e.length);o++){const a=e[o];if(a)for(const e of t){const t=a.indexOf(e);if(-1!==t)return{headerRow:o,colunaConsumo:e,colIndex:t}}}return{erro:"N√£o foi encontrada coluna de consumo conhecida"}}function processarDadosConsumo(e,t,o){try{const a=e[t].map(e=>e?e.toString().trim():""),i=a.indexOf(o),n=a.indexOf("Data"),l=a.indexOf("Hora");if(-1===i||-1===n||-1===l)return{erro:"Colunas Data, Hora ou Consumo em falta"};const s=[];for(let o=t+1;o<e.length;o++){const t=e[o];if(!t||0===t.length)continue;const a=parseFloat(t[i]);if(isNaN(a))continue;let r,c,d,u=0,m=0,p=t[n];if("number"==typeof p){const e=XLSX.SSF.parse_date_code(p);r=e.y,c=e.m,d=e.d}else if(p=String(p).trim(),p.includes("/")){const e=p.split("/");4===e[0].length?(r=parseInt(e[0]),c=parseInt(e[1]),d=parseInt(e[2])):(d=parseInt(e[0]),c=parseInt(e[1]),r=parseInt(e[2]))}else if(p.includes("-")){const e=p.split("-");4===e[0].length?(r=parseInt(e[0]),c=parseInt(e[1]),d=parseInt(e[2])):(d=parseInt(e[0]),c=parseInt(e[1]),r=parseInt(e[2]))}let g=t[l];if("number"==typeof g){const e=Math.round(1440*g);u=Math.floor(e/60),m=e%60}else if("string"==typeof g){const e=g.split(":");u=parseInt(e[0]),m=parseInt(e[1])}if(!r||!c||!d)continue;const f=new Date(r,c-1,d,u,m,0),_=new Date(f);0===u&&0===m&&_.setMinutes(_.getMinutes()-1);const h=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}T${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}:00`;s.push({DataHoraOriginal:h(f),DataHora:h(_),Ts:_.getTime(),"Consumo (kWh)":a/4,Potencia_kW:a})}return{registos:s}}catch(e){return{erro:e.message}}}function validarEJuntarFicheiros(e){if(!e||0===e.length)return{erro:"Nenhum ficheiro processado"};const t=new Date("2025-01-01");let o=!1,a=[];const i=[];for(const n of e){const e=n.length,l=n.filter(e=>new Date(e.DataHora)>=t);if(e>l.length&&(o=!0),0===l.length)continue;a=a.concat(l);const s=new Date(Math.min(...l.map(e=>new Date(e.DataHora)))),r=new Date(Math.max(...l.map(e=>new Date(e.DataHora))));i.push({min:s,max:r})}if(0===a.length)return{erro:"Nenhum dos ficheiros continha dados v√°lidos a partir de 01/01/2025"};if(i.length>1){const e=i.sort((e,t)=>e.min-t.min);for(let t=1;t<e.length;t++)if(e[t].min<e[t-1].max)return{erro:"Sobreposi√ß√£o de datas detetada entre ficheiros"}}a.sort((e,t)=>new Date(e.DataHora)-new Date(t.DataHora));const n=[],l=new Set;for(const e of a)l.has(e.DataHora)||(l.add(e.DataHora),n.push(e));return{dados:n,aviso:o?"Foram encontrados e ignorados dados anteriores a 01/01/2025":null}}function agregarConsumosPorPeriodo(e){const t={Simples:0,BD:{V:0,F:0},BS:{V:0,F:0},TD:{V:0,C:0,P:0},TS:{V:0,C:0,P:0}};if(!DATA.omieMap)return t;for(let o=0;o<e.length;o++){const a=e[o];t.Simples+=a["Consumo (kWh)"];const i=a.DataHora.split("T"),n=i[1].split(":"),l=`${i[0]}_${n[0]}:${n[1]}`;let s=DATA.omieMap.get(l);if(s||"00"===n[1]||(s=DATA.omieMap.get(`${i[0]}_${n[0]}:00`)),s){const e=a["Consumo (kWh)"];s.BD&&(t.BD[s.BD]+=e),s.BS&&(t.BS[s.BS]+=e),s.TD&&(t.TD[s.TD]+=e),s.TS&&(t.TS[s.TS]+=e)}}return t}function calcularMediasOMIE(e){const t=document.getElementById("d_inicio").value,o=document.getElementById("d_fim").value;if(!t||!o||!DATA.omie)return{};const a={S:{sum:0,n:0},BD:{V:{sum:0,n:0},F:{sum:0,n:0}},BS:{V:{sum:0,n:0},F:{sum:0,n:0}},TD:{V:{sum:0,n:0},P:{sum:0,n:0},C:{sum:0,n:0}},TS:{V:{sum:0,n:0},P:{sum:0,n:0},C:{sum:0,n:0}}};DATA.omie.forEach(e=>{const i=parseDateFromDB(e.Data);if(!i||i<t||i>o)return;const n=parseFloat(String(e.OMIE).replace(",","."))||0;a.S.sum+=n,a.S.n++,["BD","BS","TD","TS"].forEach(t=>{const o=e[t];o&&a[t][o]&&(a[t][o].sum+=n,a[t][o].n++)})});const i={};return a.S.n&&(i.S=a.S.sum/a.S.n),["BD","BS","TD","TS"].forEach(e=>{for(const[t,o]of Object.entries(a[e]))i[`${e}_${t}`]=o.n?o.sum/o.n:0}),i}function aplicarDadosERedes(){if(!DADOS_EREDES)return;const e=document.getElementById("d_inicio"),t=document.getElementById("d_fim"),o=document.getElementById("num_dias"),a=DADOS_EREDES.periodo.inicio,i=DADOS_EREDES.periodo.fim;e.min=a,e.max=i,t.min=a,t.max=i,(e.value<a||e.value>i)&&(e.value=a),(t.value<a||t.value>i)&&(t.value=i);const n=new Date(e.value),l=new Date(t.value);if(n&&l){const e=Math.floor((l-n)/864e5)+1;o.value=e>0?e:0}const s=document.getElementById("omie-panel");s&&s.classList.add("hidden")}async function exportarExcel(){try{const e=window.ExcelJS;if(!e)return void alert("Biblioteca ExcelJS n√£o carregada. Verifique a liga√ß√£o √† internet.");const t=document.getElementById("modo_comparacao")?.checked,o=document.getElementById("potencia")?.value||"",a=document.getElementById("ciclo")?.value||"",i=document.getElementById("num_dias")?.value||"",n=document.getElementById("d_inicio")?.value||"",l=document.getElementById("d_fim")?.value||"",s=e=>{const t=e.split("-");return 3===t.length?`${t[2]}/${t[1]}/${t[0]}`:e},r=s(n),c=s(l),d={S:parseFloat(document.getElementById("kwh_S")?.value)||0,V:parseFloat(document.getElementById("kwh_V")?.value)||0,F:parseFloat(document.getElementById("kwh_F")?.value)||0,P:parseFloat(document.getElementById("kwh_P")?.value)||0,C:parseFloat(document.getElementById("kwh_C")?.value)||0},u=d.S+d.V+d.F+d.P+d.C,m=document.getElementById("familia_numerosa")?.checked,p=document.getElementById("tarifa_social")?.checked,g=document.getElementById("f_segmento")?.value||"Todos",f=document.getElementById("f_fatura")?.value||"Todas",_=document.getElementById("f_pagamento")?.value||"Todos",h="Todos"===g?"Residencial":g;let E="";E=a.includes("Simples")?`Simples: ${OMIE_VALUES.S.toFixed(2)} ‚Ç¨/MWh`:a.includes("Bi")?`Vazio: ${OMIE_VALUES.V.toFixed(2)}, Fora Vazio: ${OMIE_VALUES.F.toFixed(2)} ‚Ç¨/MWh`:`Vazio: ${OMIE_VALUES.V.toFixed(2)}, Cheias: ${OMIE_VALUES.C.toFixed(2)}, Ponta: ${OMIE_VALUES.P.toFixed(2)} ‚Ç¨/MWh`;let S="";S=a.includes("Simples")?`Simples: ${d.S.toFixed(0)} kWh`:a.includes("Bi")?`Vazio: ${d.V.toFixed(0)}, Fora Vazio: ${d.F.toFixed(0)} kWh`:`Vazio: ${d.V.toFixed(0)}, Cheias: ${d.C.toFixed(0)}, Ponta: ${d.P.toFixed(0)} kWh`;const A="function"==typeof obter_perfil?obter_perfil(u,parseInt(i),parseFloat(o)).replace(/^(perfil_|BTN_)/i,"PERFIL ").toUpperCase():"N/A",y={Fixo:{bg:"F0F0F0",fg:"000000"},"Indexado M√©dia":{bg:"FFE699",fg:"000000"},"Indexado quarto-hor√°rio - Perfil":{bg:"90ABDC",fg:"000000"},"Indexado quarto-hor√°rio - Diagrama":{bg:"D6E4F0",fg:"000000"},Utilizador:{bg:"FF0000",fg:"FFFFFF"},Personalizado:{bg:"92D050",fg:"000000"}},v={Simples:{bg:"A6A6A6",fg:"000000"},"Bi-hor√°rio - Ciclo Di√°rio":{bg:"A9D08E",fg:"000000"},"Bi Di√°rio":{bg:"A9D08E",fg:"000000"},"Bi-hor√°rio":{bg:"A9D08E",fg:"000000"},"Bi-hor√°rio - Ciclo Semanal":{bg:"8EA9DB",fg:"000000"},"Bi Semanal":{bg:"8EA9DB",fg:"000000"},"Tri-hor√°rio - Ciclo Di√°rio":{bg:"BF8F00",fg:"FFFFFF"},"Tri Di√°rio":{bg:"BF8F00",fg:"FFFFFF"},"Tri-hor√°rio":{bg:"BF8F00",fg:"FFFFFF"},"Tri-hor√°rio - Ciclo Semanal":{bg:"C65911",fg:"FFFFFF"},"Tri Semanal":{bg:"C65911",fg:"FFFFFF"},"Tri Di√°rio >20.7":{bg:"BF8F00",fg:"FFFFFF"},"Tri-hor√°rio >20.7":{bg:"BF8F00",fg:"FFFFFF"},"Tri Semanal >20.7":{bg:"C65911",fg:"FFFFFF"},default:{bg:"A6A6A6",fg:"000000"}},T=(e,t)=>t&&t.includes("O Meu Tarif√°rio")?y.Utilizador:t&&t.includes("Tarif√°rio Personalizado")?y.Personalizado:e&&e.includes("Diagrama")?y["Indexado quarto-hor√°rio - Diagrama"]:e&&e.includes("quarto-hor√°rio")?y["Indexado quarto-hor√°rio - Perfil"]:e&&e.includes("M√©dia")?y["Indexado M√©dia"]:y.Fixo,b=e=>{if(v[e])return v[e];for(const t of Object.keys(v))if(e.includes(t)||t.includes(e))return v[t];return v.default},I=(e,t,o)=>{if(isNaN(e)||null===t||null===o||t===o)return{bg:"FFFFFF",fg:"000000"};const a=(t+o)/2,i=[90,138,198],n=[255,255,255],l=[247,150,70];let s,r,c;if(e<=a){const o=(e-t)/(a-t);s=Math.round(i[0]*(1-o)+n[0]*o),r=Math.round(i[1]*(1-o)+n[1]*o),c=Math.round(i[2]*(1-o)+n[2]*o)}else{const t=(e-a)/(o-a);s=Math.round(n[0]*(1-t)+l[0]*t),r=Math.round(n[1]*(1-t)+l[1]*t),c=Math.round(n[2]*(1-t)+l[2]*t)}const d=.299*s+.587*r+.114*c;return{bg:[s,r,c].map(e=>e.toString(16).padStart(2,"0")).join("").toUpperCase(),fg:d>140?"000000":"FFFFFF"}},C=new e.Workbook,B=C.addWorksheet("Simula√ß√£o"),x={type:"pattern",pattern:"solid",fgColor:{argb:"FFFFFF"}},F={top:{style:"thin",color:{argb:"000000"}},left:{style:"thin",color:{argb:"000000"}},bottom:{style:"thin",color:{argb:"000000"}},right:{style:"thin",color:{argb:"000000"}}};let D=1;const P=LAST_EXPORT_DATA;let M;M=t&&P&&"comparacao"===P.mode?1+(P.data.opcoes||[]).length:a.includes("Simples")?4:a.includes("Bi")?5:6;const V=Math.max(M,4),$=(e,t)=>{for(let o=1;o<=t;o++)B.getCell(e,o).fill=x};B.mergeCells(D,1,D,V),B.getCell(D,1).value="Resumo da Simula√ß√£o:",B.getCell(D,1).font={bold:!0,size:12},B.getCell(D,1).fill=x,D++;const k=(e,t)=>{const o=Math.max(2,Math.floor(V/2));B.mergeCells(D,1,D,o),B.getCell(D,1).value=e,B.getCell(D,1).font={bold:!0,size:11},B.getCell(D,1).fill=x,B.mergeCells(D,o+1,D,V),B.getCell(D,o+1).value=t,B.getCell(D,o+1).font={bold:!0,size:11},B.getCell(D,o+1).fill=x,D++};k(`Segmento: ${h}   |  Fatura√ß√£o: ${f}   |  Pagamento: ${_}`,`${o} kVA em ${a.replace("- Ciclo ","").replace("Bi-hor√°rio","Bi-Hor√°rio").replace("Tri-hor√°rio","Tri-Hor√°rio")}`),k(`Consumos (${u.toFixed(0)} kWh Total):`,S),k("Per√≠odo:",`De ${r} a ${c} (${i} dias)`);let w="OMIE (M√©dia Final)";if(OMIE_MANUAL)w="OMIE (Manual)";else{w=verificarIncluiFuturosOMIP()?"OMIE / OMIP (M√©dia com Futuros)":"OMIE (M√©dia Final)"}if(k(`${w}:`,E),k("Perfil de Consumo:",A),m||p){let e=[];m&&e.push("Fam√≠lia Numerosa"),p&&e.push("Tarifa Social"),k("Benef√≠cios:",e.join(", "))}$(D,V),D++;const O=document.getElementById("mensagem-poupanca");if(O&&"none"!==O.style.display&&O.innerText.trim()){B.mergeCells(D,1,D,Math.max(V,4));const e=B.getCell(D,1);e.value=O.innerText.trim(),e.font={bold:!0,color:{argb:"FF0000"},size:11},e.alignment={wrapText:!0},e.fill=x,D++}const L=document.getElementById("comparacao-summary");if(t&&L&&L.innerText.trim()){B.mergeCells(D,1,D,Math.max(V,4));const e=B.getCell(D,1);e.value=L.innerText.trim().replace(/\n+/g," | "),e.font={bold:!0,color:{argb:"0369A1"},size:11},e.alignment={wrapText:!0},e.fill=x,D++}$(D,V),D++;const z=new Date,R=`          Simula√ß√£o em ${`${z.getDate().toString().padStart(2,"0")}/${(z.getMonth()+1).toString().padStart(2,"0")}/${z.getFullYear()}`}                                                                      https://www.tiagofelicia.pt                                                                      Tiago Fel√≠cia`;B.mergeCells(D,1,D,Math.max(V,4));const U=B.getCell(D,1);if(U.value=R,U.font={bold:!0,size:11},U.alignment={horizontal:"center",vertical:"middle"},U.fill=x,D++,$(D,V),D++,!t&&P&&"detalhe"===P.mode){const e=P.results||[];let t=["Tarif√°rio","Total (‚Ç¨)"];a.includes("Simples")?t.push("Simples (‚Ç¨/kWh)","Pot√™ncia (‚Ç¨/dia)"):a.includes("Bi")?t.push("Vazio (‚Ç¨/kWh)","Fora Vazio (‚Ç¨/kWh)","Pot√™ncia (‚Ç¨/dia)"):t.push("Vazio (‚Ç¨/kWh)","Cheias (‚Ç¨/kWh)","Ponta (‚Ç¨/kWh)","Pot√™ncia (‚Ç¨/dia)");const o=t.length,i=b(a);t.forEach((e,t)=>{const o=B.getCell(D,t+1);o.value=e,o.font={bold:!0,color:{argb:i.fg},size:11},o.fill={type:"pattern",pattern:"solid",fgColor:{argb:i.bg}},o.alignment={horizontal:"center",vertical:"middle"},o.border=F}),D++;const n=(e,t)=>{const o=e.map(e=>e[t]).filter(e=>!isNaN(e)&&null!=e);return o.length?{min:Math.min(...o),max:Math.max(...o)}:{min:null,max:null}},l=n(e,"total"),s=n(e,"uS"),r=n(e,"uV"),c=n(e,"uF"),d=n(e,"uP"),u=n(e,"uC"),m=n(e,"uPot"),p=new Set;e.forEach(e=>{const t=T(e.tipo,e.nome);p.add(getTarifarioStyle(e.tipo,e.nome).label);const o=B.getCell(D,1);o.value=e.nome,o.fill={type:"pattern",pattern:"solid",fgColor:{argb:t.bg}},o.font={color:{argb:t.fg},size:11,bold:e.nome.includes("O Meu Tarif√°rio")||e.nome.includes("Tarif√°rio Personalizado")},o.alignment={horizontal:"center"};const i=B.getCell(D,2),n=I(e.total,l.min,l.max);i.value=e.total,i.numFmt="#,##0.00",i.fill={type:"pattern",pattern:"solid",fgColor:{argb:n.bg}},i.font={color:{argb:n.fg},size:11},i.alignment={horizontal:"center"};let g=3;const f=(e,t)=>{const o=B.getCell(D,g),a=I(e,t.min,t.max);o.value=e,o.numFmt="#,##0.0000",o.fill={type:"pattern",pattern:"solid",fgColor:{argb:a.bg}},o.font={color:{argb:a.fg},size:11},o.alignment={horizontal:"center"},g++};a.includes("Simples")?(f(e.uS,s),f(e.uPot,m)):a.includes("Bi")?(f(e.uV,r),f(e.uF,c),f(e.uPot,m)):(f(e.uV,r),f(e.uC,u),f(e.uP,d),f(e.uPot,m)),D++}),$(D,o),D++,$(D,o),D++,B.mergeCells(D,1,D,Math.min(o,3)),B.getCell(D,1).value="Tipos de Tarif√°rio:",B.getCell(D,1).font={bold:!0,size:11,underline:!0},B.getCell(D,1).alignment={horizontal:"center"},B.getCell(D,1).fill=x,D++;const g={"O Meu Tarif√°rio":"Tarif√°rio configurado pelo utilizador.",Personalizado:"Tarif√°rio personalizado pelo utilizador.","Indexado M√©dia":"Pre√ßo de energia baseado na m√©dia OMIE do per√≠odo.","Indexado quarto-hor√°rio - Perfil":"Pre√ßo de energia baseado nos valores OMIE hor√°rios/quarto-hor√°rios e perfil.","Indexado quarto-hor√°rio - Diagrama":"Pre√ßo baseado nos dados reais do diagrama de cargas E-REDES.",Fixo:"Pre√ßos de energia constantes."};["O Meu Tarif√°rio","Personalizado","Indexado M√©dia","Indexado quarto-hor√°rio - Perfil","Indexado quarto-hor√°rio - Diagrama","Fixo"].forEach(e=>{if(!p.has(e))return;let t;t="O Meu Tarif√°rio"===e?y.Utilizador:"Personalizado"===e?y.Personalizado:y[e]||y.Fixo;const a=B.getCell(D,1);a.value=e,a.fill={type:"pattern",pattern:"solid",fgColor:{argb:t.bg}},a.font={color:{argb:t.fg},size:11,bold:!0},a.alignment={horizontal:"center"},B.mergeCells(D,2,D,Math.min(o,4)),B.getCell(D,2).value=g[e]||"",B.getCell(D,2).font={size:11},B.getCell(D,2).fill=x,D++}),B.getColumn(1).width=95;for(let e=2;e<=o;e++)B.getColumn(e).width=25}else if(t&&P&&"comparacao"===P.mode){const e=P.data.opcoes||[],t=P.data.resultados||[],o=1+e.length,a=B.getCell(D,1);a.value="Tarif√°rio";const i=b("Simples");a.font={bold:!0,color:{argb:i.fg},size:11},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:i.bg}},a.alignment={horizontal:"center"},a.border=F,e.forEach((e,t)=>{const o=b(e.display),a=B.getCell(D,t+2);a.value=`${e.display} (‚Ç¨)`,a.font={bold:!0,color:{argb:o.fg},size:11},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:o.bg}},a.alignment={horizontal:"center"},a.border=F}),D++;const n={};e.forEach(e=>{const o=t.map(t=>t.custos[e.display]).filter(e=>!isNaN(e)&&null!=e);n[e.display]=o.length?{min:Math.min(...o),max:Math.max(...o)}:{min:null,max:null}});const l=new Set;t.forEach(t=>{const o=T(t.tipo,t.nome);l.add(getTarifarioStyle(t.tipo,t.nome).label);const a=B.getCell(D,1);a.value=t.nome,a.fill={type:"pattern",pattern:"solid",fgColor:{argb:o.bg}},a.font={color:{argb:o.fg},size:11,bold:t.nome.includes("O Meu Tarif√°rio")||t.nome.includes("Tarif√°rio Personalizado")},a.alignment={horizontal:"center"},e.forEach((e,o)=>{const a=B.getCell(D,o+2),i=t.custos[e.display];if(null==i||isNaN(i))a.value="‚Äî",a.font={color:{argb:"AAAAAA"},size:11},a.fill=x;else{const t=I(i,n[e.display].min,n[e.display].max);a.value=i,a.numFmt="#,##0.00",a.fill={type:"pattern",pattern:"solid",fgColor:{argb:t.bg}},a.font={color:{argb:t.fg},size:11}}a.alignment={horizontal:"center"}}),D++}),$(D,o),D++,$(D,o),D++,B.mergeCells(D,1,D,Math.min(o,3)),B.getCell(D,1).value="Tipos de Tarif√°rio:",B.getCell(D,1).font={bold:!0,size:11,underline:!0},B.getCell(D,1).alignment={horizontal:"center"},B.getCell(D,1).fill=x,D++;const s={"O Meu Tarif√°rio":"Tarif√°rio configurado pelo utilizador.",Personalizado:"Tarif√°rio personalizado pelo utilizador.","Indexado M√©dia":"Pre√ßo de energia baseado na m√©dia OMIE do per√≠odo.","Indexado quarto-hor√°rio - Perfil":"Pre√ßo de energia baseado nos valores OMIE hor√°rios/quarto-hor√°rios e perfil.","Indexado quarto-hor√°rio - Diagrama":"Pre√ßo baseado nos dados reais do diagrama de cargas E-REDES.",Fixo:"Pre√ßos de energia constantes."};["O Meu Tarif√°rio","Personalizado","Indexado M√©dia","Indexado quarto-hor√°rio - Perfil","Indexado quarto-hor√°rio - Diagrama","Fixo"].forEach(e=>{if(!l.has(e))return;let t;t="O Meu Tarif√°rio"===e?y.Utilizador:"Personalizado"===e?y.Personalizado:y[e]||y.Fixo;const a=B.getCell(D,1);a.value=e,a.fill={type:"pattern",pattern:"solid",fgColor:{argb:t.bg}},a.font={color:{argb:t.fg},size:11,bold:!0},a.alignment={horizontal:"center"},B.mergeCells(D,2,D,Math.min(o,4)),B.getCell(D,2).value=s[e]||"",B.getCell(D,2).font={size:11},B.getCell(D,2).fill=x,D++}),B.getColumn(1).width=95;for(let e=2;e<=o;e++)B.getColumn(e).width=25}else{const e=document.getElementById("thead"),t=document.getElementById("tbody");if(e){const t=[];e.querySelectorAll("th").forEach(e=>{const o=e.innerText.replace(/‚ñº|‚ñ≤/g,"").trim();o.toLowerCase().includes("detalhe")||t.push(o)}),t.forEach((e,t)=>{const o=B.getCell(D,t+1);o.value=e,o.font={bold:!0,size:11},o.fill=x}),D++}t&&t.querySelectorAll("tr").forEach(e=>{let t=0;e.querySelectorAll("td").forEach((o,a)=>{if(a===e.querySelectorAll("td").length-1)return;const i=B.getCell(D,t+1);i.value=o.innerText.trim(),i.font={size:11},i.fill=x,t++}),D++})}const N=new Date,H=`${N.getFullYear()}${(N.getMonth()+1).toString().padStart(2,"0")}${N.getDate().toString().padStart(2,"0")}_${N.getHours().toString().padStart(2,"0")}${N.getMinutes().toString().padStart(2,"0")}${N.getSeconds().toString().padStart(2,"0")}`,W=t?`Tiago_Felicia_Eletricidade_Comparacao_${H}.xlsx`:`Tiago_Felicia_Eletricidade_detalhe_${H}.xlsx`,q=await C.xlsx.writeBuffer(),G=new Blob([q],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),K=URL.createObjectURL(G),Q=document.createElement("a");Q.href=K,Q.download=W,Q.click(),URL.revokeObjectURL(K)}catch(e){console.error("Erro ao exportar:",e),alert("Erro ao exportar para Excel: "+e.message)}}const CICLO_CODES={Simples:"S","Bi-hor√°rio - Ciclo Di√°rio":"BD","Bi-hor√°rio - Ciclo Semanal":"BS","Tri-hor√°rio - Ciclo Di√°rio":"TD","Tri-hor√°rio - Ciclo Semanal":"TS","Tri-hor√°rio > 20.7 kVA - Ciclo Di√°rio":"XD","Tri-hor√°rio > 20.7 kVA - Ciclo Semanal":"XS"},CICLO_DECODE=Object.fromEntries(Object.entries(CICLO_CODES).map(([e,t])=>[t,e]));function gerarLinkPartilha(){try{const e=new URLSearchParams;e.set("p",document.getElementById("potencia")?.value||"");const t=document.getElementById("ciclo")?.value||"";e.set("c",CICLO_CODES[t]||t);const o=(document.getElementById("d_inicio")?.value||"").replace(/-/g,""),a=(document.getElementById("d_fim")?.value||"").replace(/-/g,"");o&&e.set("a",o),a&&e.set("b",a);[["kwh_S","s"],["kwh_V","v"],["kwh_F","f"],["kwh_P","t"],["kwh_C","k"]].forEach(([t,o])=>{const a=document.getElementById(t);a&&parseFloat(a.value)&&e.set(o,a.value)});let i="";document.getElementById("familia_numerosa")?.checked&&(i+="F"),document.getElementById("tarifa_social")?.checked&&(i+="T"),document.getElementById("ocultar_edp_h")?.checked&&(i+="E"),document.getElementById("quota_acp")?.checked&&(i+="A"),document.getElementById("modo_comparacao")?.checked&&(i+="C"),i&&e.set("fl",i);const n=document.getElementById("f_segmento")?.value;n&&"Todos"!==n&&e.set("sg",n.charAt(0));const l=document.getElementById("f_fatura")?.value;l&&"Todas"!==l&&e.set("ft",l.charAt(0));const s=document.getElementById("f_pagamento")?.value;s&&"Todos"!==s&&e.set("pg",s.charAt(0));const r=document.getElementById("cav_valor")?.value;r&&"2.85"!==r&&e.set("cv",r);const c=document.getElementById("dgeg_valor")?.value;c&&"0.07"!==c&&e.set("dg",c);const d=Array.from(document.querySelectorAll(".chk-tipo")).map(e=>e.checked?"1":"0").join("");if(d&&!d.match(/^1+$/)&&e.set("tp",parseInt(d,2).toString(36)),OMIE_MANUAL){const t=[];document.querySelectorAll('#omie-inputs input[type="number"]').forEach(e=>t.push(e.value)),e.set("om",t.join(","))}if(document.getElementById("meu_ativo")?.checked){const t=["meu_energia_s","meu_energia_v","meu_energia_f","meu_energia_p","meu_energia_c","meu_potencia","meu_desc_fat","meu_acres_fat"].map(e=>document.getElementById(e)?.value||"0").join(",");e.set("m",t);let o="";document.getElementById("meu_tar_energia")?.checked&&(o+="e"),document.getElementById("meu_tar_potencia")?.checked&&(o+="p"),document.getElementById("meu_tse_incluido")?.checked&&(o+="t"),o&&e.set("mf",o)}if(document.getElementById("pers_ativo")?.checked){const t=["pers_energia_s","pers_potencia_s","pers_energia_v_bi","pers_energia_f_bi","pers_potencia_bi","pers_energia_v_tri","pers_energia_c_tri","pers_energia_p_tri","pers_potencia_tri"].map(e=>document.getElementById(e)?.value||"0").join(",");e.set("x",t);let o="";document.getElementById("pers_tar_energia")?.checked&&(o+="e"),document.getElementById("pers_tar_potencia")?.checked&&(o+="p"),document.getElementById("pers_tse_incluido")?.checked&&(o+="t"),o&&e.set("xf",o)}const u=window.location.origin+window.location.pathname+"?z=2&"+e.toString();navigator.clipboard.writeText(u).then(()=>{const e=document.getElementById("btn-partilhar"),t=e.innerHTML;e.innerHTML='<i class="fa-solid fa-check"></i> Link Copiado!',e.style.background="#16a34a",e.style.color="white",e.style.borderColor="#16a34a",setTimeout(()=>{e.innerHTML=t,e.style.background="white",e.style.color="var(--primary)",e.style.borderColor="var(--primary)"},2500)}).catch(()=>{prompt("Copie o link abaixo:",u)})}catch(e){console.error("Erro ao gerar link:",e),alert("Erro ao gerar link de partilha.")}}function aplicarParametrosPartilha(){const e=new URLSearchParams(window.location.search);return!!(e.has("z")||e.has("pot")&&"complete"===e.get("tab"))&&(window._SHARED_PARAMS=e,!0)}function aplicarSharedParamsDepoisDeCarregar(){const e=window._SHARED_PARAMS;if(e){delete window._SHARED_PARAMS;try{"complete"!==CURRENT_TAB?(document.querySelector('[onclick*="switchTab"][onclick*="complete"]')?.click(),setTimeout(()=>aplicarSharedParamsAosInputs(e),300)):aplicarSharedParamsAosInputs(e)}catch(e){console.error("Erro ao aplicar params:",e)}}}function aplicarSharedParamsAosInputs(e){try{const t=(e,t)=>{const o=document.getElementById(e);o&&null!=t&&(o.value=t)},o=(e,t)=>{const o=document.getElementById(e);o&&(o.checked=!!t)};if(e.has("z")){t("potencia",e.get("p")),atualizarMenusCiclo();const a=e.get("c")||"";t("ciclo",CICLO_DECODE[a]||a),construirInputsConsumo();const i=e.get("a")||"",n=e.get("b")||"";8===i.length&&t("d_inicio",i.slice(0,4)+"-"+i.slice(4,6)+"-"+i.slice(6,8)),8===n.length&&t("d_fim",n.slice(0,4)+"-"+n.slice(4,6)+"-"+n.slice(6,8)),atualizarDias(),setTimeout(()=>{e.get("s")&&t("kwh_S",e.get("s")),e.get("v")&&t("kwh_V",e.get("v")),e.get("f")&&t("kwh_F",e.get("f")),e.get("t")&&t("kwh_P",e.get("t")),e.get("k")&&t("kwh_C",e.get("k"));const a=e.get("fl")||"";o("familia_numerosa",a.includes("F")),o("tarifa_social",a.includes("T")),o("ocultar_edp_h",a.includes("E")),o("quota_acp",a.includes("A")),o("modo_comparacao",a.includes("C"));e.get("sg")&&t("f_segmento",{R:"Residencial",E:"Empresarial"}[e.get("sg")]||e.get("sg"));e.get("ft")&&t("f_fatura",{E:"Eletr√≥nica",P:"Papel"}[e.get("ft")]||e.get("ft"));if(e.get("pg")&&t("f_pagamento",{D:"D√©bito Direto",M:"Multibanco",O:"Outros"}[e.get("pg")]||e.get("pg")),e.get("cv")&&t("cav_valor",e.get("cv")),e.get("dg")&&t("dgeg_valor",e.get("dg")),e.get("tp")){const t=parseInt(e.get("tp"),36).toString(2),o=document.querySelectorAll(".chk-tipo"),a=t.padStart(o.length,"0");o.forEach((e,t)=>{e.checked="1"===a[t]})}if(e.get("om")){OMIE_MANUAL=!0,construirInputsOMIE(CICLO_DECODE[e.get("c")]||e.get("c"));const t=e.get("om").split(",");document.querySelectorAll('#omie-inputs input[type="number"]').forEach((e,o)=>{t[o]&&(e.value=t[o])})}if(e.get("m")){o("meu_ativo",!0),toggleMeuTarifario();const a=e.get("m").split(",");["meu_energia_s","meu_energia_v","meu_energia_f","meu_energia_p","meu_energia_c","meu_potencia","meu_desc_fat","meu_acres_fat"].forEach((e,o)=>t(e,a[o]||"0"));const i=e.get("mf")||"";o("meu_tar_energia",i.includes("e")),o("meu_tar_potencia",i.includes("p")),o("meu_tse_incluido",i.includes("t"))}if(e.get("x")){o("pers_ativo",!0),toggleTarifarioPersonalizado();const a=e.get("x").split(",");["pers_energia_s","pers_potencia_s","pers_energia_v_bi","pers_energia_f_bi","pers_potencia_bi","pers_energia_v_tri","pers_energia_c_tri","pers_energia_p_tri","pers_potencia_tri"].forEach((e,o)=>t(e,a[o]||"0"));const i=e.get("xf")||"";o("pers_tar_energia",i.includes("e")),o("pers_tar_potencia",i.includes("p")),o("pers_tse_incluido",i.includes("t"))}calcular(),setTimeout(()=>{document.getElementById("titulo-tabela")?.scrollIntoView({behavior:"smooth",block:"start"})},500)},200)}else t("potencia",e.get("pot")),atualizarMenusCiclo(),t("ciclo",e.get("ciclo")),construirInputsConsumo(),t("d_inicio",e.get("d1")),t("d_fim",e.get("d2")),atualizarDias(),setTimeout(()=>{if(["kwh_S","kwh_V","kwh_F","kwh_P","kwh_C"].forEach(o=>{e.get(o)&&t(o,e.get(o))}),o("familia_numerosa","1"===e.get("fam")),o("tarifa_social","1"===e.get("ts")),e.get("seg")&&t("f_segmento",e.get("seg")),e.get("fat")&&t("f_fatura",e.get("fat")),e.get("pag")&&t("f_pagamento",e.get("pag")),e.get("cav")&&t("cav_valor",e.get("cav")),e.get("dgeg")&&t("dgeg_valor",e.get("dgeg")),o("ocultar_edp_h","1"===e.get("edp")),o("quota_acp","1"===e.get("acp")),o("modo_comparacao","1"===e.get("comp")),e.get("tipos")){const t=e.get("tipos");document.querySelectorAll(".chk-tipo").forEach((e,o)=>{e.checked="1"===t[o]})}"1"===e.get("meu")&&(o("meu_ativo",!0),toggleMeuTarifario(),["meu_energia_s","meu_energia_v","meu_energia_f","meu_energia_p","meu_energia_c","meu_potencia","meu_desc_fat","meu_acres_fat"].forEach(o=>{e.get(o)&&t(o,e.get(o))}),o("meu_tar_energia","1"===e.get("meu_te")),o("meu_tar_potencia","1"===e.get("meu_tp")),o("meu_tse_incluido","1"===e.get("meu_tse"))),"1"===e.get("pers")&&(o("pers_ativo",!0),toggleTarifarioPersonalizado(),["pers_energia_s","pers_potencia_s","pers_energia_v_bi","pers_energia_f_bi","pers_potencia_bi","pers_energia_v_tri","pers_energia_c_tri","pers_energia_p_tri","pers_potencia_tri"].forEach(o=>{e.get(o)&&t(o,e.get(o))}),o("pers_tar_energia","1"===e.get("pers_te")),o("pers_tar_potencia","1"===e.get("pers_tp")),o("pers_tse_incluido","1"===e.get("pers_tse"))),calcular(),setTimeout(()=>{document.getElementById("titulo-tabela")?.scrollIntoView({behavior:"smooth",block:"start"})},500)},200)}catch(e){console.error("Erro ao aplicar inputs:",e)}}    </script>

    <!-- === ABA 4: FAQ === -->
    <div id="tab-faq" class="tab-content hidden">
        <div style="max-width: 900px; margin: 40px auto; padding: 20px;">
            <!-- FAQ original -->
            <div id="datas-ref-faq"></div>
            <article class="content-support">

                    <h2>üìä Sobre o Simulador</h2>

                    <p><strong>O que √© este simulador?</strong></p>
                    <p>√â uma ferramenta gratuita que compara tarif√°rios de eletricidade em Portugal.</p>
                    
                    <h2>‚ö° Simula√ß√£o R√°pida</h2>
                    <p><strong>Para quem √©?</strong></p>
                    <p>Para quem quer uma resposta r√°pida. Basta indicar quanto paga ou consome.</p>
                    
                    <h2>üìù Simula√ß√£o Completa</h2>
                    <p><strong>Para quem √©?</strong></p>
                    <p>Para quem quer controlo total sobre os par√¢metros.</p>
                    
                    <h2>üìä An√°lise Avan√ßada</h2>
                    <p><strong>Para quem √©?</strong></p>
                    <p>Para quem tem o ficheiro de consumos da E-Redes. Aten√ß√£o que o ficheiro deve ser do tipo "Consumos/Diagrama de Carga" e n√£o do tipo "Leituras". Esta an√°lise permite comparar tarif√°rios com base nos seus dados reais de consumo passados e com os valores OMIE passados. Se quiser com dados OMIE/OMIP Futuros, ter√° de colocar os consumos em Simula√ß√£o Completa</p>



                <h2>Como Usar o Simulador de Tarif√°rios</h2>
                <details class="faq-item">
                    <summary><strong>Guia R√°pido</strong></summary>
                    <div class="faq-content">
                        <p>Bem-vindo! Esta ferramenta ajuda-o a descobrir o tarif√°rio de eletricidade mais econ√≥mico para si. Siga os passos abaixo para come√ßar a poupar.</p>

                        <h3><strong>Passo 1: Escolha o seu Ponto de Partida</strong></h3>
                        <ul>
                            <li style="margin-bottom: 15px;">
                                <p><strong><em>‚úçÔ∏è Simula√ß√£o R√°pida</em></strong></p>
                                <ol>
                                    <li><strong>Defina algumas op√ß√µes:</strong> Escolha <strong>"Quanto paga por m√™s?"</strong> ou <strong>"Quanto consome por m√™s"</strong>.</li>
                                    <li><strong>Altere o Consumo:</strong> Preencha o seu consumo mensal estimado (kWh) no campo que aparece.</li>
                                    <li><strong>Altere a Pot√™ncia:</strong> Selecione uma das pot√™ncias dispon√≠veis.</li>
                                    <li><strong>Vantagem:</strong> Ideal para simula√ß√µes imediatas e previs√µes de custos sem precisar de muito tempo.</li>
                                </ol>
                            </li>

                            <li style="margin-bottom: 15px;">
                                <p><strong><em>üìù Simula√ß√£o Completa</em></strong></p>
                                <p style="margin-top: 5px; margin-bottom: 5px;">Primeiro, defina a sua <strong>Pot√™ncia Contratada</strong> e <strong>Op√ß√£o Hor√°ria</strong>.</p>
                                <ol>
                                    <li><strong>Insira os Consumos:</strong> Preencha os seus consumos mensais estimados (kWh) nos campos (ex: Vazio, Fora de Vazio).</li>
                                    <li><strong>Defina o Per√≠odo:</strong> Escolha as <strong>datas</strong> para a simula√ß√£o.</li>
                                    <li><strong>Vantagem:</strong> Ideal para simula√ß√µes mais rigorosas e previs√µes de custos futuros.</li>
                                </ol>
                            </li>

                            <li>
                                <p><strong><em>üìä An√°lise Avan√ßada (com Ficheiro E-Redes)</em></strong></p>
                                <ol>
                                    <li><strong>Carregue o Ficheiro:</strong> Em "Clique para selecionar ficheiro(s)", envie o seu ficheiro <code>.xlsx</code> da E-Redes. Pode obt√™-lo em <a href="https://balcaodigital.e-redes.pt/consumptions/history" target="_blank" rel="noopener noreferrer">balcaodigital.e-redes.pt</a>.</li>
                                    <li><strong>Configure:</strong> Defina a sua <strong>Pot√™ncia Contratada</strong> e <strong>Op√ß√£o Hor√°ria</strong>.</li>
                                    <li><strong>Selecione o Per√≠odo:</strong> Escolha as datas que pretende analisar.</li>
                                    <li><strong>Vantagem:</strong> Esta √© a forma mais precisa. O simulador usa os seus consumos a cada 15 minutos para uma an√°lise exata, incluindo <strong>gr√°ficos detalhados</strong>.</li>
                                    <li><strong>Nota Importante:</strong> A an√°lise √© feita com os consumos e valores OMIE do passado. Se pretender verificar estimativas para o futuro, deve transpor os dados obtidos aqui para a <strong>üìù Simula√ß√£o Completa</strong>.</li>
                                </ol>
                            </li>
                        </ul>

                        <h3><strong>Passo 2: üèÜ Encontre a Melhor Tarifa</strong></h3>
                        <p>A tabela de resultados no final da p√°gina √© a sua ferramenta principal.</p>
                        <ul>
                            <li><strong>Ordenar por Custo:</strong> Clique no cabe√ßalho da coluna <strong>"Total (‚Ç¨)"</strong> para ordenar os tarif√°rios do mais barato para o mais caro.</li>
                            <li><strong>Explorar Detalhes:</strong> Passe o rato sobre os pre√ßos ou sobre o custo total para ver um <strong>resumo detalhado</strong> dos c√°lculos, incluindo todas as taxas e impostos.</li>
                            <li><strong>Filtrar Resultados:</strong> Use os filtros no topo da tabela para refinar a sua pesquisa por tipo de tarif√°rio (Fixo, Indexado), segmento, etc.</li>
                            <li><strong>Comparar Op√ß√µes Hor√°rias:</strong> Ative a op√ß√£o "<strong>Modo de Compara√ß√£o</strong>" para ver uma tabela especial que mostra quanto pagaria em cada tarif√°rio se tivesse um ciclo diferente (Simples, Bi-Hor√°rio, etc.).</li>
                        </ul>

                        <blockquote>
                            <p><strong>Dica Pro:</strong> Use a sec√ß√£o <strong>"üßæ O Meu Tarif√°rio"</strong> para introduzir os pre√ßos da sua fatura atual e compar√°-la diretamente com todas as ofertas do mercado. Assim, saber√° exatamente quanto pode poupar!</p>
                        </blockquote>
                    </div>
                </details>
            
            <h2>Perguntas Frequentes (FAQ)</h2>
            
            <details class="faq-item">
                <summary><strong>De onde v√™m os dados dos tarif√°rios e dos pre√ßos de mercado (OMIE)?</strong></summary>
                <div class="faq-content">
                    <p>Todos os dados dos tarif√°rios s√£o recolhidos a partir das informa√ß√µes p√∫blicas disponibilizadas pelos comercializadores nos seus websites. Os pre√ßos do mercado ib√©rico (OMIE) e os perfis de consumo da E-Redes s√£o obtidos de fontes oficiais para garantir a m√°xima precis√£o nos c√°lculos dos tarif√°rios indexados. Os dados s√£o atualizados regularmente para refletir as condi√ß√µes atuais do mercado.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Alguns tarif√°rios t√™m um custo de energia diferente do site institucional, porqu√™?</strong></summary>
                <div class="faq-content">
                    <p>Alguns comercializadores n√£o incluem o valor do financiamento da Tarifa Social de Eletricidade (TSE) no custo base da energia. Para que se possa comparar todos de forma igual, nesses casos, o custo da TSE √© adicionado ao custo base. Para confirmar, passe o rato por cima do valor da energia na tabela para ver a decomposi√ß√£o detalhada do pre√ßo.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>O meu tarif√°rio tem o mesmo nome, mas valores diferentes. Porqu√™?</strong></summary>
                <div class="faq-content">
                    <p>Muitos comercializadores alteram os valores nos seus tarif√°rios, mas mant√™m as mesmas denomina√ß√µes comerciais. Este simulador utiliza sempre os valores da vers√£o mais recente do tarif√°rio disponibilizada pelo comercializador.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>O simulador √© 100% preciso?</strong></summary>
                <div class="faq-content">
                    <p>O objetivo √© ser o mais preciso poss√≠vel. Para tarif√°rios <strong>fixos</strong>, a precis√£o √© muito elevada. Para tarif√°rios <strong>indexados</strong>, o custo final √© uma estimativa baseada em m√©dias e perfis de consumo (no caso de dados hist√≥ricos). A forma mais rigorosa de simula√ß√£o √© sempre atrav√©s do carregamento do seu <strong>diagrama de carga da E-Redes</strong>, pois utiliza o seu perfil de consumo real.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Porque √© que o modo "An√°lise Avan√ßada" (com ficheiro E-Redes) √© recomendado?</strong></summary>
                <div class="faq-content">
                    <p>Este modo utiliza o seu consumo real registado a cada 15 minutos. Isto permite um c√°lculo exato do custo para qualquer tipo de tarif√°rio, incluindo os <strong>indexados quarto-hor√°rios (din√¢micos)</strong>. Al√©m disso, s√≥ neste modo √© poss√≠vel fazer uma an√°lise precisa da sua <strong>pot√™ncia contratada</strong>.</p>
                </div>
            </details>
            
            <h3 class="faq-section-title">Dados e Per√≠odos</h3>
            
            <details class="faq-item">
                <summary><strong>Porque √© que a simula√ß√£o s√≥ est√° dispon√≠vel a partir de 01/01/2026?</strong></summary>
                <div class="faq-content">
                    <p>A simula√ß√£o est√° focada no ano de 2026 para garantir que os c√°lculos utilizam as Tarifas de Acesso √†s Redes (TAR) e outras taxas e impostos em vigor. O simulador ignora automaticamente quaisquer dados de consumo anteriores a esta data para garantir a relev√¢ncia dos resultados.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Como s√£o tratados os fins de semana e feriados nos ciclos hor√°rios?</strong></summary>
                <div class="faq-content">
                    <p>O simulador utiliza os ciclos hor√°rios oficiais definidos pela ERSE. Nos <strong>Ciclos Semanais</strong>, os fins de semana t√™m um tratamento espec√≠fico (geralmente com mais horas em "Vazio"). Nos <strong>Ciclos Di√°rios</strong>, a contagem das horas √© a mesma para todos os dias. Os feriados n√£o t√™m regras especificas em BTN, sendo tratados como dias 'normais'. O simulador aplica estas regras automaticamente com base nos dados oficiais.</p>
                </div>
            </details>
            
            <h3 class="faq-section-title">Funcionalidades do Simulador</h3>
            
            <details class="faq-item">
                <summary><strong>O que significa a op√ß√£o "Modo Compara√ß√£o"?</strong></summary>
                <div class="faq-content">
                    <p>Ao ativar esta op√ß√£o, o simulador recalcula o custo de cada tarif√°rio para diferentes ciclos hor√°rios (Simples, Bi-Hor√°rio, etc.), usando os seus consumos. √â √∫til para perceber se compensaria mudar de op√ß√£o hor√°ria.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Como funciona a sec√ß√£o "O Meu Tarif√°rio"?</strong></summary>
                <div class="faq-content">
                    <p>Esta sec√ß√£o permite-lhe introduzir os pre√ßos da sua fatura atual para comparar diretamente com todas as outras ofertas. √â fundamental verificar na sua fatura se os pre√ßos que insere j√° incluem as <strong>TAR (Tarifas de Acesso √†s Redes)</strong>.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Para que serve a sec√ß√£o "Tarif√°rio Personalizado?"</strong></summary>
                <div class="faq-content">
                    <p>Esta funcionalidade permite-lhe construir cen√°rios hipot√©ticos com os seus pr√≥prios pre√ßos. √â ideal para simular uma oferta que recebeu, testar o impacto de altera√ß√µes de pre√ßos ou perceber qual seria o custo se o seu comercializador oferecesse uma op√ß√£o hor√°ria diferente.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Os valores OMIE para datas futuras s√£o reais?</strong></summary>
                <div class="faq-content">
                    <p>N√£o. Os valores para datas futuras baseiam-se nos pre√ßos do mercado de futuros (OMIP), que representam a expectativa do mercado. Servem como a melhor estimativa dispon√≠vel, mas n√£o s√£o uma garantia. A data de atualiza√ß√£o destes valores est√° indicada no final da p√°gina.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Como s√£o tratados descontos especiais como os do ACP?</strong></summary>
                <div class="faq-content">
                    <p>Para a parceria <strong>Goldenergy/ACP</strong>, pode incluir a quota mensal no custo final. Pode gerir estas op√ß√µes em "Op√ß√µes Adicionais".</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>O que est√° inclu√≠do no "Total (‚Ç¨)"?</strong></summary>
                <div class="faq-content">
                    <p>Sim, o "Total (‚Ç¨)" √© a sua fatura final estimada. Inclui o custo da energia e da pot√™ncia, todas as taxas (CAV, DGEG, IEC), o IVA aplicado corretamente e quaisquer descontos ou acr√©scimos. Lembre-se que pode ver a decomposi√ß√£o detalhada de todos estes custos <strong>passando o rato por cima do valor na coluna 'Total (‚Ç¨)'</strong>.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Como posso encontrar rapidamente o que procuro na tabela?</strong></summary>
                <div class="faq-content">
                    <p>A tabela √© interativa! Pode:</p>
                    <ul>
                        <li><strong>Ordenar:</strong> Clique no cabe√ßalho de qualquer coluna (ex: "Total (‚Ç¨)") para ordenar os resultados.</li>
                        <li><strong>Filtrar:</strong> Use os filtros no topo da tabela para refinar a sua pesquisa.</li>
                        <li><strong>Pesquisar:</strong> Use a pesquisa dentro das colunas "Comercializador" e "Tarif√°rio" para encontrar uma oferta espec√≠fica.</li>
                    </ul>
                </div>
            </details>
            
            <h3 class="faq-section-title">Termos e Conceitos</h3>
            
            <details class="faq-item">
                <summary><strong>O que √© um tarif√°rio indexado? √â uma boa op√ß√£o?</strong></summary>
                <div class="faq-content">
                    <p>Um tarif√°rio indexado tem um pre√ßo de energia que varia com o mercado grossista (OMIE). Este tipo de tarif√°rio pode oferecer uma poupan√ßa significativa quando os pre√ßos de mercado est√£o baixos, mas tamb√©m implica um risco maior se os pre√ßos subirem. Pode ser:</p>
                    <ul>
                        <li><strong>Indexado √† M√©dia:</strong> O pre√ßo baseia-se na m√©dia do per√≠odo de fatura√ß√£o (ex. mensal) dos pre√ßos OMIE para os per√≠odos hor√°rios (Vazio, Fora de Vazio, etc.).</li>
                        <li><strong>Indexado Quarto-Hor√°rio (Din√¢mico):</strong> O pre√ßo varia a cada hora (ou 15 minutos). S√£o ideais para quem consegue adaptar o consumo √†s horas mais baratas.</li>
                    </ul>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>O que s√£o as TAR (Tarifas de Acesso √†s Redes)?</strong></summary>
                <div class="faq-content">
                    <p>As TAR s√£o tarifas reguladas pela ERSE que pagam pelo uso das infraestruturas el√©tricas. Todos os consumidores as pagam, independentemente do comercializador. O simulador lida com os casos em que as TAR est√£o inclu√≠das ou separadas do pre√ßo da energia para garantir uma compara√ß√£o justa.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>O que significa "Perfil de Consumo" (ex: Perfil A, B, C)?</strong></summary>
                <div class="faq-content">
                    <p>A ERSE agrupa os consumidores em perfis (A, B, C) que representam um padr√£o de consumo m√©dio. No <strong>Modo Manual</strong>, o simulador usa estes perfis para estimar o custo dos tarif√°rios indexados. No <strong>Modo Diagrama</strong>, este perfil n√£o √© necess√°rio para o c√°lculo principal, pois s√£o usados os seus dados reais.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Porque √© que o simulador pergunta se a minha instala√ß√£o √© trif√°sica?</strong></summary>
                <div class="faq-content">
                    <p>O ficheiro da E-Redes regista a pot√™ncia total da sua casa em m√©dias de 15 minutos. Numa instala√ß√£o <strong>trif√°sica</strong>, √© poss√≠vel que uma √∫nica fase tenha um pico de consumo muito elevado num curto espa√ßo de tempo, fazendo o disjuntor disparar, mesmo que a pot√™ncia total <em>m√©dia</em> nesses 15 minutos n√£o ultrapasse o valor contratado. Assinalar que a sua instala√ß√£o √© trif√°sica permite que a an√°lise de pot√™ncia o alerte para este risco.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Como sei se a minha instala√ß√£o √© monof√°sica ou trif√°sica?</strong></summary>
                <div class="faq-content">
                    <p>Geralmente, instala√ß√µes dom√©sticas com pot√™ncias contratadas at√© 6.9 kVA s√£o monof√°sicas. Pot√™ncias superiores s√£o quase sempre trif√°sicas. Esta informa√ß√£o est√° dispon√≠vel na sua fatura, no seu contador ou no balc√£o digital da E-Redes.</p>
                </div>
            </details>
            
            </article>
        </div>
    </div>

</main>

<!-- WATERMARK INFERIOR - IN√çCIO -->
<div style="margin-top: 40px; padding: 20px; background: #f8fafc; 
            border-top: 3px solid #0066cc; text-align: center;">
    <div style="max-width: 800px; margin: 0 auto;">
        <p style="font-size: 0.95rem; color: #0f172a; margin-bottom: 10px;">
            <strong>Simulador de Tarif√°rios de Eletricidade | Tiago Fel√≠cia</strong>
        </p>
        <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 8px;">
            Desenvolvido por <a href="https://www.tiagofelicia.pt" style="color: #0066cc; font-weight: 500;">Tiago Fel√≠cia</a>
        </p>
        <p style="font-size: 0.75rem; color: #94a3b8;">
            ¬© 2024-2026 Tiago Fel√≠cia. Todos os direitos reservados.<br>
            <i class="fa-solid fa-shield-halved"></i>
            Vers√£o oficial dispon√≠vel apenas em 
            <strong style="color: #0066cc;">www.tiagofelicia.pt</strong>
        </p>
    </div>
</div>
<!-- WATERMARK INFERIOR - FIM -->

<div id="footer-placeholder"></div>

<script>
// === Carregar menu.html e footer.html do site ===
(function() {
    fetch('menu.html')
        .then(r => r.ok ? r.text() : '')
        .then(html => { if(html) document.getElementById('menu-placeholder').innerHTML = html; })
        .catch(() => {});
    fetch('footer.html')
        .then(r => r.ok ? r.text() : '')
        .then(html => { if(html) document.getElementById('footer-placeholder').innerHTML = html; })
        .catch(() => {});
})();
</script>
<script src="script.js"></script>
</body>
</html>