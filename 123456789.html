<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Simulador de Tarif√°rios Eletricidade 2026: Poupe na Fatura | Tiago Fel√≠cia</title>
    <meta name="description" content="Compare tarif√°rios de eletricidade em Portugal para 2026. Use o nosso simulador gratuito, com ou sem ficheiro da E-Redes, e descubra quanto pode poupar na sua fatura da luz." />
    <link rel="canonical" href="https://www.tiagofelicia.pt/eletricidade-tiagofelicia.html" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Simulador Eletricidade 2026: Qual o mais barato?" />
    <meta property="og:description" content="Pare de pagar demais. Compare tarif√°rios fixos e indexados com o seu consumo real." />
    <meta property="og:url" content="https://www.tiagofelicia.pt/eletricidade-tiagofelicia.html" />
    <meta property="og:image" content="https://www.tiagofelicia.pt/images/social-share.jpg" />
    <meta property="og:locale" content="pt_PT" />

    <link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg" />
    <link rel="shortcut icon" href="/images/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" />
    <link rel="manifest" href="/images/site.webmanifest" />

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css" />

    <!-- Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J4NWP00S4F"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-J4NWP00S4F');
    </script>
    
    <style>
        :root { 
            --primary: #0066cc; --bg: #f8fafc; --surface: #ffffff; 
            --text-main: #0f172a; --text-light: #64748b; --border: #e2e8f0;
            --success: #16a34a; --warning: #d97706; --danger: #dc2626;
        }
        /* Site integration: content padding */
        #loader { margin: 0 20px; }
        .tabs-container { margin-left: 20px; margin-right: 20px; }
        .grid-container { padding: 0 20px; }
        #eredes-upload-central { margin-left: 20px; margin-right: 20px; }
        #tab-quick { padding: 0 20px; }
        #tab-faq > div { margin-left: auto; margin-right: auto; padding-left: 20px; padding-right: 20px; }
        #menu-placeholder { margin-bottom: 0; }
        #footer-placeholder { margin-top: 40px; }
        
        * { box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 0; font-size: 0.92rem; line-height: 1.5; }
        .hidden { display: none !important; }
        
        .grid-container { display: grid; grid-template-columns: 360px 1fr; gap: 20px; max-width: 1900px; margin: 0 auto; align-items: start; }
        @media (max-width: 1200px) { .grid-container { grid-template-columns: 1fr; } }

        .sidebar { background: var(--surface); padding: 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto; z-index: 10; }
        
        .section-title { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: var(--text-light); margin: 16px 0 8px 0; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); padding-bottom: 4px; cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center; }
        .section-title:hover { color: var(--primary); }
        .section-content { margin-bottom: 12px; }
        .section-content.collapsed { display: none; }

        /* === CORES POR SEC√á√ÉO DA SIDEBAR === */
        /* Contrato - Azul */
        .section-title[onclick*="contrato"] { 
            background: #1ca4e7 !important; 
            color: white !important; 
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="contrato"]:hover { 
            background: #0369a1 !important; 
            color: white !important; 
        }
        #content-contrato { 
            background: #e0f2fe; 
            border-left: 4px solid #0284c7; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* Consumo - Roxo */
        .section-title[onclick*="consumo"] { 
            background: #ae6ceb !important; 
            color: white !important; 
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="consumo"]:hover { 
            background: #7e22ce !important; 
            color: white !important; 
        }
        #content-consumo { 
            background: #f3e8ff; 
            border-left: 4px solid #9333ea; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* E-Redes - Laranja */
        .section-title[onclick*="eredes"] { 
            background: #e9783b !important; 
            color: white !important; 
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="eredes"]:hover { 
            background: #c2410c !important; 
            color: white !important; 
        }
        #content-eredes { 
            background: #ffedd5; 
            border-left: 4px solid #ea580c; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* Meu Tarif√°rio - Vermelho */
        .section-title[onclick*="meu"] { 
            background: #e25555 !important; 
            color: white !important; 
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="meu"]:hover { 
            background: #b91c1c !important; 
            color: white !important; 
        }
        #content-meu { 
            background: #fee2e2; 
            border-left: 4px solid #dc2626; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* Personalizado - Verde */
        .section-title[onclick*="personalizado"] { 
            background: #28c461 !important; 
            color: white !important; 
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="personalizado"]:hover { 
            background: #15803d !important; 
            color: white !important; 
        }
        #content-personalizado { 
            background: #dcfce7; 
            border-left: 4px solid #16a34a; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* Compara√ß√£o - Ciano */
        .section-title[onclick*="comparacao"] { 
            background: #55a5b9 !important; 
            color: white !important; 
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="comparacao"]:hover { 
            background: #0e7490 !important; 
            color: white !important; 
        }
        #content-comparacao { 
            background: #cffafe; 
            border-left: 4px solid #0891b2; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* Benef√≠cios Sociais - Amarelo/Dourado */
        .section-title[onclick*="beneficios"] { 
            background: #d6a53b !important; 
            color: white !important; 
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="beneficios"]:hover { 
            background: #a16207 !important; 
            color: white !important; 
        }
        #content-beneficios { 
            background: #fef9c3; 
            border-left: 4px solid #ca8a04; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* Op√ß√µes Adicionais - Rosa */
        .section-title[onclick*="opcoes"] { 
            background: #e24b8f !important; 
            color: white !important; 
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="opcoes"]:hover { 
            background: #be185d !important; 
            color: white !important; 
        }
        #content-opcoes { 
            background: #fce7f3; 
            border-left: 4px solid #db2777; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }

        /* Datas - Violeta */
        .section-title[onclick*="datas"] { 
            background: #905bec !important; 
            color: white !important; 
            padding: 10px 12px !important; 
            border-radius: 8px !important; 
            border-bottom: none !important;
            margin-top: 16px !important;
        }
        .section-title[onclick*="datas"]:hover { 
            background: #6d28d9 !important; 
            color: white !important; 
        }
        #content-datas { 
            background: #ede9fe; 
            border-left: 4px solid #7c3aed; 
            padding: 14px; 
            border-radius: 0 8px 8px 0; 
            margin-left: -2px;
        }        

        .input-group { margin-bottom: 10px; }
        label { display: block; font-weight: 500; margin-bottom: 4px; font-size: 0.85rem; }
        .label-units { font-family: 'Roboto Mono', monospace; font-weight: 400; color: var(--text-light); font-size: 0.8em; }
        
        input[type="number"], input[type="date"], select {
            width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px;
            font-size: 0.9rem; transition: 0.2s; background: #fff; font-family: 'Roboto Mono', monospace;
        }
        input:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(0,102,204,0.1); }
        
        .omie-box { background: #fff7ed; border: 1px solid #fed7aa; padding: 10px; border-radius: 6px; margin-bottom: 12px; }
        .omie-editable { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
        .omie-input { padding: 4px 6px; font-size: 0.8rem; font-family: 'Roboto Mono', monospace; }
        
        .custom-tariff { background: #f0f9ff; border: 1px solid #bae6fd; padding: 10px; border-radius: 8px; margin-top: 10px; }
        
        .main-content { min-width: 0; }
        
        .filters-bar { 
            background: var(--surface); padding: 12px 16px; border-radius: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px;
            display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end;
        }
        .filter-item { flex: 1; min-width: 130px; }
        .checkbox-group { display: flex; gap: 12px; margin-top: 4px; flex-wrap: wrap; }
        .checkbox-label { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; cursor: pointer; user-select: none; font-weight: 400; }
        .checkbox-label input { accent-color: var(--primary); width: 16px; height: 16px; }

        .table-wrap { background: var(--surface); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow-x: auto; border: 1px solid var(--border); }
        table { 
            width: 100%; 
            border-collapse: separate;
            border-spacing: 2px 2px; /* Espa√ßamento horizontal (2px) e vertical (2px) entre c√©lulas */
            table-layout: fixed;
            min-width: 800px; 
        }
        
        th { 
            background: #f8fafc; padding: 10px 12px; text-align: center; font-weight: 600; font-size: 0.85rem;
            color: var(--text-light); border-bottom: 1px solid var(--border);
            cursor: pointer; white-space: nowrap; user-select: none; position: sticky; top: 0; z-index: 10;
            position: relative; 
        }
        td:first-child {
            text-align: left;
        }
        th:hover { background: #f1f5f9; color: var(--primary); }
        
        /* Cores do cabe√ßalho por tipo de ciclo */
        th.ciclo-simples { background: #A6A6A6; color: #000; }
        th.ciclo-bi-diario { background: #A9D08E; color: #000; }
        th.ciclo-bi-semanal { background: #8EA9DB; color: #000; }
        th.ciclo-tri-diario { background: #BF8F00; color: #fff; }
        th.ciclo-tri-semanal { background: #C65911; color: #fff; }
        
        th.ciclo-simples:hover, 
        th.ciclo-bi-diario:hover, 
        th.ciclo-bi-semanal:hover { background: #8c8c8c; }
        th.ciclo-tri-diario:hover,
        th.ciclo-tri-semanal:hover { background: #a07600; }
        
        /* Larguras m√≠nimas uniformizadas */
        th:nth-child(2), td:nth-child(2) { min-width: 110px; } /* Total */
        th:nth-child(3), td:nth-child(3) { min-width: 140px; } /* Primeira energia */
        th:nth-child(4), td:nth-child(4) { min-width: 140px; } /* Segunda energia/Pot√™ncia */
        th:nth-child(5), td:nth-child(5) { min-width: 140px; } /* Terceira energia/Pot√™ncia */
        th:nth-child(6), td:nth-child(6) { min-width: 140px; } /* Quarta energia/Pot√™ncia */
        th:last-child, td:last-child { width: 85px; min-width: 85px; max-width: 85px; text-align: center; } /* Detalhes */
        
        .resizer {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 5px;
            background: rgba(0,0,0,0.05);
            cursor: col-resize;
            user-select: none;
        }
        
        .resizer:hover {
            background: var(--primary);
        }
        
        td { padding: 8px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; font-size: 0.88rem; }
        tr:hover { background: #f8fafc; }
        
        /* Largura inicial da coluna Tarif√°rio */
        th:first-child, td:first-child { 
            width: 28%; 
        }
        
        /* Molduras coloridas para c√©lulas de tarif√°rio */
        .cell-qh-diagrama { border: 2px solid #BDD7EE !important; background-color: #f0f7ff; border-radius: 10px; }
        .cell-qh-perfil   { border: 2px solid #4D79BC !important; background-color: #dce8f5; border-radius: 10px; } /* Azul ainda mais escuro para contraste */
        .cell-index-media { border: 2px solid #FFE699 !important; background-color: #fffdf5; border-radius: 10px; }
        .cell-fixo        { border: 2px solid #d0d0d0 !important; background-color: #ffffff; border-radius: 10px; } /* Branco puro */
        .cell-meu-tarif   { border: 2px solid #FF0000 !important; background-color: #fff5f5; border-radius: 10px; }
        .cell-perso       { border: 2px solid #92D050 !important; background-color: #f9fff2; border-radius: 10px; }
        
        .price-main { font-family: 'Roboto Mono', monospace; font-weight: 700; color: var(--success); font-size: 0.95rem; cursor: help; text-align: center; vertical-align: middle; }
        .price-sub { font-family: 'Roboto Mono', monospace; color: var(--text-light); font-size: 0.82rem; cursor: help; text-align: center; vertical-align: middle; }
        .tariff-name { cursor: help; color: var(--primary); font-weight: 600; }
        
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; display: inline-block; margin-right: 4px; letter-spacing: 0.05em; }
        .tag.qh-diagrama { background: #BDD7EE; color: #000; }
        .tag.qh-perfil   { background: #4D79BC; color: #fff; }
        .tag.index-media { background: #FFE699; color: #000; }
        .tag.fixo        { background: #d0d0d0; color: #000; }
        .tag.meu-tarif   { background: #FF0000; color: #fff; }
        .tag.perso       { background: #92D050; color: #fff; }
        
        .tooltip { 
            position: absolute; background: #1e293b; color: white; padding: 12px; border-radius: 8px; 
            font-size: 0.8rem; z-index: 1000; box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            max-width: 380px; pointer-events: none; line-height: 1.4;
        }
        .tooltip-line { display: flex; justify-content: space-between; margin: 3px 0; gap: 16px; }
        .tooltip-line.subtotal { border-top: 1px solid rgba(255,255,255,0.2); margin-top: 6px; padding-top: 6px; font-weight: 600; }
        .tooltip-line.total { border-top: 2px solid rgba(255,255,255,0.4); margin-top: 8px; padding-top: 8px; font-weight: 700; font-size: 0.9rem; }
        .tooltip-section { margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.15); }

        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        @media (max-width: 768px) {
            body { padding: 0; font-size: 0.85rem; }
            .grid-container { grid-template-columns: 1fr; padding: 0 10px; }
            .sidebar { 
                position: fixed; top: 0; left: 0; width: 85vw; max-width: 360px; height: 100vh; max-height: 100vh;
                border-radius: 0; z-index: 1000; transform: translateX(-100%); 
                transition: transform 0.3s ease; box-shadow: none;
                overflow-y: auto;
            }
            .sidebar.open { transform: translateX(0); box-shadow: 4px 0 20px rgba(0,0,0,0.3); }
            .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 999; }
            .sidebar-overlay.active { display: block; }
            .sidebar-toggle { 
                display: flex; align-items: center; gap: 8px; background: var(--primary); color: white; 
                border: none; padding: 10px 16px; border-radius: 8px; font-size: 0.9rem; font-weight: 600;
                cursor: pointer; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            }
            .sidebar-toggle:active { transform: scale(0.97); }
            .sidebar-close { 
                display: flex; position: absolute; top: 12px; right: 12px; background: none; border: none; 
                font-size: 1.4rem; color: var(--text-light); cursor: pointer; padding: 4px 8px; z-index: 1001;
            }
            .filters-bar { padding: 10px; }
            .filter-item { min-width: 100%; }
            th, td { padding: 6px 8px; font-size: 0.8rem; }
            .tabs-container { margin-left: 10px; margin-right: 10px; }
            #tab-quick { padding: 0 10px; }
        }
        @media (min-width: 769px) {
            .sidebar-toggle { display: none; }
            .sidebar-close { display: none; }
            .sidebar-overlay { display: none !important; }
        }
        
        /* === TABS CSS === */
        .tabs-container {
            max-width: 1900px;
            margin: 0 auto 20px auto;
        }
        
        .tabs-header {
            display: flex;
            gap: 0;
            background: var(--surface);
            border-radius: 12px 12px 0 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tab-button {
            flex: 1;
            padding: 16px 24px;
            background: #f1f5f9;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-button:hover {
            background: #e2e8f0;
            color: var(--text-main);
        }
        
        .tab-button.active {
            background: var(--surface);
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* === ABA 1 - SIMULA√á√ÉO R√ÅPIDA === */
        .quick-sim-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .quick-card {
            background: var(--surface);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .quick-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .power-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 10px;
            margin-top: 12px;
        }
        
        .power-button {
            padding: 12px;
            background: #f8fafc;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Roboto Mono', monospace;
            transition: all 0.2s;
            text-align: center;
        }
        
        .power-button:hover {
            border-color: var(--primary);
            background: #f0f9ff;
        }
        
        .power-button.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .quick-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 12px;
        }
        
        .quick-option {
            padding: 14px 16px;
            background: #f8fafc;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quick-option:hover {
            border-color: var(--primary);
            background: #f0f9ff;
        }
        
        .quick-option.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .quick-option input[type="radio"] {
            accent-color: white;
        }
        
        .collapsible-header {
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .collapsible-header:hover {
            background: #f1f5f9;
        }
        
        .collapsible-content {
            padding: 16px;
            background: #fafafa;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .collapsible-content.collapsed {
            display: none;
        }
        
        /* Regra gen√©rica para qualquer elemento com classe collapsed */
        .collapsed {
            display: none !important;
        }
        
        .provider-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }
        
        .provider-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }
        
        .provider-checkbox:hover {
            background: #f8fafc;
        }
        
        .simulate-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
        }
        
        .simulate-btn:hover {
            background: #0052a3;
            box-shadow: 0 4px 12px rgba(0,102,204,0.3);
        }
        
        .update-notice {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 8px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .podium-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin: 24px 0;
        }
        
        .podium-item {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .podium-item.first {
            order: 2;
            border: 3px solid #ffd700;
        }
        
        .podium-item.second {
            order: 1;
        }
        
        .podium-item.third {
            order: 3;
        }
        
        .podium-medal {
            font-size: 3rem;
            margin-bottom: 12px;
        }
        
        .podium-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        
        .podium-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Roboto Mono', monospace;
        }
        
        .podium-savings {
            color: var(--success);
            font-weight: 600;
            margin-top: 8px;
        }
        
        @media (max-width: 768px) {
            .podium-container {
                grid-template-columns: 1fr;
            }
            .podium-item.first,
            .podium-item.second,
            .podium-item.third {
                order: initial;
            }
        }
        /* === TABS CSS === */
        .tabs-container {
            max-width: 1900px;
            margin: 0 auto 20px auto;
        }

        .tabs-header {
            display: flex;
            gap: 0;
            background: var(--surface);
            border-radius: 12px 12px 0 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab-button {
            flex: 1;
            padding: 12px 20px;
            background: #f1f5f9;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s;
        }

        .tab-button:hover {
            background: #e2e8f0;
            color: var(--text-main);
        }

        .tab-button.active {
            background: var(--surface);
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* === ABA 1 - SIMULA√á√ÉO R√ÅPIDA (COMPACTA) === */
        .quick-sim-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .quick-card {
            background: var(--surface);
            padding: 12px 16px; /* Compacto */
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 10px; /* Compacto */
        }

        .quick-title {
            font-size: 0.9rem; /* Compacto */
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .price-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .price-button, .power-button {
            padding: 8px; /* Compacto */
            background: #f8fafc;
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Roboto Mono', monospace;
            transition: all 0.2s;
            text-align: center;
            font-size: 0.85rem; /* Compacto */
        }

        .price-button.selected, .power-button.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .power-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(65px, 1fr)); /* Compacto */
            gap: 6px; /* Compacto */
        }

        .quick-option {
            padding: 10px 12px; /* Compacto */
            background: #f8fafc;
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem; /* Compacto */
        }

        .quick-option.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* P√≥dio */
        .podium-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 16px 0;
        }

        .podium-item {
            background: var(--surface);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .podium-item.first {
            order: 2;
            border: 3px solid #ffd700;
        }

        .podium-item.second { order: 1; }
        .podium-item.third { order: 3; }

        .podium-medal {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .podium-name {
            font-weight: 700;
            font-size: 0.95rem;
            margin-bottom: 6px;
        }

        .podium-price {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Roboto Mono', monospace;
        }

        @media (max-width: 768px) {
            .podium-container {
                grid-template-columns: 1fr;
            }
            .podium-item.first,
            .podium-item.second,
            .podium-item.third {
                order: initial;
            }
        }
    </style>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [{
        "@type": "Question",
        "name": "De onde v√™m os dados dos tarif√°rios e dos pre√ßos de mercado (OMIE)?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Todos os dados dos tarif√°rios s√£o recolhidos a partir das informa√ß√µes p√∫blicas disponibilizadas pelos comercializadores nos seus websites. Os pre√ßos do mercado ib√©rico (OMIE) e os perfis de consumo da ERSE s√£o obtidos de fontes oficiais para garantir a m√°xima precis√£o nos c√°lculos dos tarif√°rios indexados. Os dados s√£o atualizados regularmente para refletir as condi√ß√µes atuais do mercado."
        }
      },{
        "@type": "Question",
        "name": "Alguns tarif√°rios t√™m custo na energia diferentes do que t√™m no seu site institucional, porqu√™?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Alguns comercializadores n√£o incluem o valor do financiamento da Tarifa Social de Eletricidade (TSE) no custo base da energia. Para que se possa comparar entre todos de forma igual, nesses casos junto o custo de financiamento da TSE ao custo base. Para confirmar, passe o rato por cima do valor da energia na tabela para ver a decomposi√ß√£o detalhada do pre√ßo."
        }
      },{
        "@type": "Question",
        "name": "Tenho um tarif√°rio com o mesmo nome que o do simulador, mas tem valores diferentes na energia e/ou pot√™ncia, porqu√™?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Muitos comercializadores alteram os valores nos seus tarif√°rios mas mant√™m as denomina√ß√µes dos mesmos. Este simulador s√≥ tem os valores para a √∫ltima vers√£o do tarif√°rio."
        }
      },{
        "@type": "Question",
        "name": "O simulador √© 100% preciso?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "O objetivo √© ser o mais preciso poss√≠vel. Para tarif√°rios fixos, a precis√£o √© muito elevada. Para tarif√°rios indexados, o custo final √© uma estimativa baseada em m√©dias e perfis de consumo. A forma mais rigorosa de simula√ß√£o √© sempre atrav√©s do carregamento do seu diagrama de carga da E-Redes, pois utiliza o seu perfil de consumo real (neste caso, apenas dados hist√≥ricos)."
        }
      },{
        "@type": "Question",
        "name": "Porque √© que o modo 'An√°lise Detalhada' com o ficheiro da E-Redes √© recomendado?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Este modo utiliza o seu consumo real registado a cada 15 minutos. Isto permite um c√°lculo exato do custo para qualquer tipo de tarif√°rio, incluindo os indexados quarto-hor√°rios (din√¢micos). Al√©m disso, s√≥ neste modo √© poss√≠vel fazer uma an√°lise precisa da sua pot√™ncia contratada e simular o impacto do autoconsumo com pain√©is solares fotovoltaicos."
        }
      },{
        "@type": "Question",
        "name": "Porque √© que a simula√ß√£o s√≥ est√° dispon√≠vel a partir de 01/01/2026?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "A simula√ß√£o est√° focada no ano de 2026 para garantir que os c√°lculos utilizam as Tarifas de Acesso √†s Redes (TAR) e outras taxas e impostos que est√£o em vigor. Utilizar dados de consumo de anos anteriores com as tarifas atuais poderia levar a resultados imprecisos, uma vez que as condi√ß√µes do mercado e a regula√ß√£o mudam anualmente. O simulador ignora automaticamente quaisquer dados anteriores a esta data para garantir a relev√¢ncia dos resultados."
        }
      },{
        "@type": "Question",
        "name": "Qual a diferen√ßa entre escolher um M√™s e um Per√≠odo de Datas manual?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Escolher um M√™s: √â a forma mais simples e r√°pida. O simulador seleciona automaticamente o primeiro e o √∫ltimo dia desse m√™s e usa o n√∫mero de dias correto. Selecionar Datas: Oferece total flexibilidade para analisar um per√≠odo espec√≠fico (ex: uma semana, uma quinzena). O n√∫mero de dias √© calculado com base no intervalo que definir."
        }
      },{
        "@type": "Question",
        "name": "Como s√£o tratados os fins de semana e feriados nos ciclos Bi e Tri-Hor√°rio?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "O simulador utiliza os ciclos hor√°rios oficiais definidos pela ERSE. Nos Ciclos Semanais (ex: Bi-Hor√°rio Semanal), os fins de semana t√™m um tratamento espec√≠fico, geralmente com mais horas a contar como 'Vazio'. Nos Ciclos Di√°rios, a contagem das horas √© a mesma para todos os dias da semana. Os feriados n√£o t√™m regras especificas em BTN, sendo tratados como dias 'normais'. O simulador aplica estas regras automaticamente com base nos dados oficiais."
        }
      },{
        "@type": "Question",
        "name": "O que significa a op√ß√£o 'Comparar custos entre diferentes Op√ß√µes Hor√°rias'?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Ao ativar esta op√ß√£o, o simulador recalcula o custo de cada tarif√°rio para diferentes ciclos hor√°rios (Simples, Bi-Hor√°rio, etc.), assumindo os mesmos consumos totais que inseriu. Isto √© √∫til para perceber se, com o seu padr√£o de consumo atual, compensaria mudar de op√ß√£o hor√°ria."
        }
      },{
        "@type": "Question",
        "name": "Como funciona a sec√ß√£o 'O Meu Tarif√°rio'?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Esta sec√ß√£o permite-lhe introduzir os pre√ßos da sua fatura atual (energia em ‚Ç¨/kWh e pot√™ncia em ‚Ç¨/dia) para comparar diretamente com todas as outras ofertas do mercado. √â fundamental verificar na sua fatura se os pre√ßos que insere j√° incluem as TAR (Tarifas de Acesso √†s Redes) para que a compara√ß√£o seja correta."
        }
      },{
        "@type": "Question",
        "name": "Para que serve a sec√ß√£o 'Comparar outro Tarif√°rio Personalizado?'",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Esta funcionalidade √© uma ferramenta poderosa para criar cen√°rios hipot√©ticos. Permite-lhe construir at√© tr√™s estruturas tarif√°rias com os seus pr√≥prios pre√ßos. √â ideal para simular uma oferta que recebeu, perceber qual seria o custo se o seu comercializador oferecesse uma op√ß√£o hor√°ria diferente, ou testar o impacto de futuras subidas ou descidas de pre√ßos."
        }
      },{
        "@type": "Question",
        "name": "Como funciona a simula√ß√£o de Autoconsumo com pain√©is solares fotovoltaicos?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Ao ativar esta op√ß√£o (dispon√≠vel no modo de diagrama de carga), o simulador estima a produ√ß√£o de energia de um sistema fotovoltaico com base na pot√™ncia, localiza√ß√£o e orienta√ß√£o que definir. Essa produ√ß√£o √© depois subtra√≠da do seu consumo a cada 15 minutos. O resultado √© um novo perfil de 'consumo da rede', que mostra quanta energia realmente precisou de comprar. Os c√°lculos dos tarif√°rios podem ent√£o ser feitos com base neste novo consumo, mostrando a poupan√ßa real que o autoconsumo pode gerar."
        }
      },{
        "@type": "Question",
        "name": "A simula√ß√£o de autoconsumo tem em conta os dias de chuva ou de sol?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "A simula√ß√£o utiliza perfis de produ√ß√£o solar m√©dios mensais para cada distrito, baseados em dados hist√≥ricos do PVGIS. Isto significa que a produ√ß√£o estimada para um dia de Julho, por exemplo, representa um 'dia m√©dio' de Julho, j√° tendo em conta a m√©dia de horas de sol e de nebulosidade para esse m√™s nessa regi√£o. N√£o simula a produ√ß√£o para um dia espec√≠fico com as suas condi√ß√µes meteorol√≥gicas reais, mas oferece uma estimativa muito realista para um per√≠odo de an√°lise mais longo."
        }
      },{
        "@type": "Question",
        "name": "Os valores OMIE para datas futuras s√£o reais?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "N√£o. Os valores OMIE apresentados para datas futuras baseiam-se nos pre√ßos do mercado de futuros (OMIP). Estes valores representam a expectativa do mercado para os pre√ßos da eletricidade, mas n√£o s√£o uma garantia. Servem como a melhor estimativa dispon√≠vel para simular custos em tarif√°rios indexados para per√≠odos que ainda n√£o ocorreram. A data de atualiza√ß√£o destes valores est√° indicada no final da p√°gina."
        }
      },{
        "@type": "Question",
        "name": "Como s√£o tratados descontos especiais como os do ACP ou Continente?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "O simulador tenta replicar as condi√ß√µes comerciais o mais fielmente poss√≠vel. Para a parceria Goldenergy/ACP, pode optar por incluir o valor da quota mensal no custo final. Para os tarif√°rios Galp/Continente, o simulador calcula o valor do desconto em Cart√£o Continente e subtrai-o ao custo total, refletindo a poupan√ßa real na sua carteira. Pode ativar ou desativar estas op√ß√µes na sec√ß√£o 'Op√ß√µes Adicionais de Simula√ß√£o'."
        }
      },{
        "@type": "Question",
        "name": "O que s√£o as colunas 'Custo com o seu Perfil Real (‚Ç¨)' e 'Custo com Perfil Padr√£o ERSE (‚Ç¨)'?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Esta an√°lise, dispon√≠vel no modo de diagrama de carga, compara duas coisas: o custo exato do seu consumo (Perfil Real) e o custo que teria se o seu consumo seguisse um perfil m√©dio definido pela ERSE (Perfil Padr√£o). Uma diferen√ßa negativa (a verde) significa que o seu padr√£o de consumo pessoal √© mais econ√≥mico que a m√©dia, o que √© √≥timo!"
        }
      },{
        "@type": "Question",
        "name": "O que est√° inclu√≠do no 'Total (‚Ç¨)'? √â o valor final da fatura?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Sim, o valor 'Total (‚Ç¨)' representa a sua fatura final estimada. Ele inclui o Custo da Energia, Custo da Pot√™ncia, Taxas e Impostos (CAV, DGEG, IEC), IVA aplicado conforme as regras, e quaisquer Descontos ou Acr√©scimos. Pode ver a decomposi√ß√£o detalhada de todos estes custos passando o rato por cima do valor na coluna 'Total (‚Ç¨)'."
        }
      },{
        "@type": "Question",
        "name": "A tabela de resultados tem muitas op√ß√µes. Como posso encontrar rapidamente o que procuro?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "A tabela √© interativa! Pode: Ordenar (clique no cabe√ßalho de qualquer coluna), Filtrar (use os filtros no topo da tabela para refinar a sua pesquisa), e Pesquisar (na vista detalhada, pode usar a pesquisa dentro das colunas 'Comercializador' e 'Tarif√°rio')."
        }
      },{
        "@type": "Question",
        "name": "O que √© um tarif√°rio indexado? √â uma boa op√ß√£o para mim?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Um tarif√°rio indexado tem um pre√ßo de energia que varia de acordo com o pre√ßo do mercado grossista (OMIE). Este tipo de tarif√°rio pode oferecer uma poupan√ßa significativa quando os pre√ßos de mercado est√£o baixos, mas tamb√©m implica um risco maior se os pre√ßos subirem. Pode ser 'Indexado √† M√©dia' ou 'Indexado Quarto-Hor√°rio (Din√¢mico)'. S√£o ideais para quem consegue adaptar o seu consumo √†s horas mais baratas do dia."
        }
      },{
        "@type": "Question",
        "name": "O que s√£o as TAR (Tarifas de Acesso √†s Redes)?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "As TAR s√£o tarifas reguladas pela ERSE que pagam pelo uso das infraestruturas el√©tricas (transporte e distribui√ß√£o). Todos os consumidores as pagam, independentemente do comercializador. O simulador lida com ambas as situa√ß√µes para garantir uma compara√ß√£o justa."
        }
      },{
        "@type": "Question",
        "name": "O que significa 'Perfil de Consumo' (ex: Perfil A, B, C)?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "A ERSE agrupa os consumidores em perfis (A, B ou C) com base no seu consumo anual e pot√™ncia, representando um padr√£o de consumo m√©dio. No Modo Manual, o simulador usa estes perfis para estimar o custo dos tarif√°rios indexados. No Modo Diagrama, este perfil n√£o √© necess√°rio, pois o simulador usa os seus dados de consumo reais."
        }
      },{
        "@type": "Question",
        "name": "Porque √© que o simulador pergunta se a minha instala√ß√£o √© trif√°sica?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "O ficheiro da E-Redes regista a pot√™ncia total da sua casa em m√©dias de 15 minutos. Numa instala√ß√£o trif√°sica, o consumo total pode distribuir-se pelas tr√™s fases. √â poss√≠vel que uma √∫nica fase tenha um pico de consumo muito elevado num curto espa√ßo de tempo, fazendo o disjuntor disparar, mesmo que a pot√™ncia total m√©dia nesses 15 minutos n√£o ultrapasse o valor contratado."
        }
      },{
        "@type": "Question",
        "name": "Como sei se a minha instala√ß√£o √© monof√°sica ou trif√°sica?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Geralmente, instala√ß√µes dom√©sticas com pot√™ncias contratadas at√© 6.9 kVA s√£o monof√°sicas. Pot√™ncias superiores s√£o quase sempre trif√°sicas. Esta informa√ß√£o est√° dispon√≠vel no seu contador ou no balc√£o digital da E-Redes. A an√°lise de pot√™ncia m√°xima no simulador tem em conta esta diferen√ßa."
        }
      }]
    }
    </script>
</head>
<body>
<header>
    <div class="header-content">
        <div class="header-title-container">
            <a href="index.html">
                <img src="images/Logo_Tiago_Felicia.png" alt="Log√≥tipo Tiago Fel√≠cia - P√°gina Inicial" class="logo">
            </a>
            <div class="brand-name">Tiago Fel√≠cia</div>
        </div>
        <p>Simuladores de tarif√°rios de Eletricidade, G√°s Natural e Autoconsumo</p>
    </div>
</header>

<div id="menu-placeholder"></div>

<main style="max-width: 1900px; margin: 0 auto;">

    <div id="loader" style="text-align:center; padding:60px 20px;">
        <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 2.5rem; color: var(--primary); margin-bottom: 16px;"></i>
        <p id="loader-msg" style="color: var(--text-light); font-size: 0.95rem; margin-top: 12px;">A carregar tarif√°rios...</p>
    </div>

    <!-- === LOGO E T√çTULO DO SIMULADOR === -->
    <div id="simulador-header" style="padding: 30px 20px 20px 20px;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 16px;">
            <img src="https://huggingface.co/spaces/tiagofelicia/simulador-tarifarios-eletricidade/resolve/main/Logo_Tiago_Felicia.png" 
                 alt="Logo Tiago Fel√≠cia" 
                 style="width: 120px; height: auto; flex-shrink: 0;">
            <h1>
                üîå Simulador de Tarif√°rios de Eletricidade 2026 em Portugal | Tiago Fel√≠cia
            </h1>
        </div>
        <p>
            Bem-vindo ao simulador de eletricidade mais completo de Portugal üòä. Com esta ferramenta pode comparar tarif√°rios de eletricidade, fixos e indexados, para encontrar a op√ß√£o mais econ√≥mica para si. Descubra quanto pode poupar na sua fatura da luz, quer use a Simula√ß√£o Completa ou carregue o seu ficheiro de consumo da E-Redes para uma An√°lise Avan√ßada.
        </p>
    </div>

    <!-- === TABS === -->
    <div id="tabs-wrapper" class="tabs-container hidden">
        <div class="tabs-header">
            <button class="tab-button active" onclick="switchTab('quick')">
                üîé Simula√ß√£o R√°pida
            </button>
            <button class="tab-button" onclick="switchTab('complete')">
                ‚öôÔ∏è Simula√ß√£o Completa
            </button>
            <button class="tab-button" onclick="switchTab('advanced')">
                üìä An√°lise Avan√ßada (E-Redes)
            </button>
            <button class="tab-button" onclick="switchTab('faq')">
                ‚ùì FAQ
            </button>
        </div>
    </div>

    <!-- === √ÅREA DE UPLOAD CENTRAL ABA 3 (E-REDES) === -->
    <div id="eredes-upload-central" class="hidden" style="max-width: 800px; margin: 40px auto; padding: 20px;">
        <div style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); padding: 32px; border-radius: 16px; box-shadow: 0 8px 32px rgba(14, 165, 233, 0.3); text-align: center; color: white;">
            <div style="margin-bottom: 24px;">
                <i class="fa-solid fa-chart-line" style="font-size: 4rem; opacity: 0.9;"></i>
            </div>
            <h1 style="margin: 0 0 12px 0; font-size: 2rem;">üìä An√°lise Avan√ßada E-Redes</h1>
            <p style="margin: 0 0 24px 0; opacity: 0.9; font-size: 1.1rem;">
                Carregue o(s) seu(s) ficheiro(s) de consumo da E-Redes para uma an√°lise detalhada hora-a-hora
            </p>
        </div>
        
        <div style="background: white; padding: 32px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: -20px; border: 2px dashed #0ea5e9;">
            <div style="text-align: center;">
                <label style="display: block; cursor: pointer; padding: 40px 20px; border-radius: 12px; background: #f0f9ff; transition: all 0.3s;" 
                       onmouseover="this.style.background='#e0f2fe'" onmouseout="this.style.background='#f0f9ff'">
                    <i class="fa-solid fa-cloud-arrow-up" style="font-size: 3rem; color: #0ea5e9; margin-bottom: 16px; display: block;"></i>
                    <span style="font-size: 1.2rem; font-weight: 600; color: #0369a1; display: block; margin-bottom: 8px;">
                        Clique para selecionar ficheiro(s)
                    </span>
                    <span style="font-size: 0.9rem; color: #64748b;">
                        Formato Excel (.xlsx ou .xls) exportado da E-Redes
                    </span>
                    <input type="file" id="file-eredes-central" accept=".xlsx,.xls" multiple style="display: none;" onchange="processarFicheirosERedesCentral()">
                </label>
                
                <div id="eredes-status-central" style="margin-top: 16px; font-size: 0.9rem; color: #64748b;"></div>
            </div>
            
            <div style="margin-top: 24px; padding: 16px; background: #fef3c7; border: 1px solid #fde047; border-radius: 8px;">
                <h4 style="margin: 0 0 8px 0; color: #92400e; font-size: 0.95rem;">
                    <i class="fa-solid fa-lightbulb"></i> Como obter o ficheiro da E-Redes?
                </h4>
                <ol style="margin: 0; padding-left: 20px; color: #78350f; font-size: 0.85rem; line-height: 1.6;">
                    <li>Aceda a <a href="https://balcaodigital.e-redes.pt" target="_blank" style="color: #0369a1;">balcaodigital.e-redes.pt</a></li>
                    <li>V√° a "Consumos" ‚Üí "Consultar consumos detalhados"</li>
                    <li>Selecione o per√≠odo desejado e exporte para Excel</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- === ABA 1: SIMULA√á√ÉO R√ÅPIDA === -->
    <div id="tab-quick" class="tab-content active hidden">
        <div class="quick-sim-container">
            
            <!-- Cabe√ßalho -->
            <div class="quick-card" style="background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%); color: white; text-align: center; padding: 16px;">
                <h1 style="margin: 0 0 4px 0; font-size: 1.5rem; color: white !important;">üîé Simula√ß√£o R√°pida</h1>
                <p style="margin: 0; opacity: 0.9; font-size: 0.85rem;">Descubra quanto pode poupar em segundos</p>
            </div>

            <!-- 1. PRE√áO -->
            <div class="quick-card">
                <div class="quick-title">üí∂ Quanto paga por m√™s?</div>
                <div class="price-grid">
                    <div class="price-button selected" onclick="selectPrice(40)" id="price-40">
                        <div style="font-size: 1.2rem;">40‚Ç¨</div>
                        <div style="font-size: 0.65rem; opacity: 0.7;">~158 kWh | 3.45 kVA</div>
                    </div>
                    <div class="price-button" onclick="selectPrice(100)" id="price-100">
                        <div style="font-size: 1.2rem;">100‚Ç¨</div>
                        <div style="font-size: 0.65rem; opacity: 0.7;">~333 kWh | 6.90 kVA</div>
                    </div>
                    <div class="price-button" onclick="selectPrice(200)" id="price-200">
                        <div style="font-size: 1.2rem;">200‚Ç¨</div>
                        <div style="font-size: 0.65rem; opacity: 0.7;">~908 kWh | 13.80 kVA</div>
                    </div>
                </div>
                
                <p style="text-align: center; color: var(--text-light); margin: 10px 0 8px 0; font-size: 0.85rem;">ou</p>
                
                <div class="quick-title">‚ö° Quanto consome por m√™s?</div>
                <input type="number" id="quick-kwh" placeholder="158" value="158" 
                       oninput="autoCalculate()" 
                       style="width: 100%; font-size: 1rem; text-align: center; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                <div style="text-align: center; margin-top: 4px; color: var(--text-light); font-size: 0.75rem;">kWh/m√™s</div>
            </div>

            <!-- 2. POT√äNCIA -->
            <div class="quick-card">
                <div class="quick-title">‚ö° Qual √© a sua pot√™ncia contratada?</div>
                <div class="power-grid">
                    <div class="power-button" onclick="selectPower(1.15)">1.15</div>
                    <div class="power-button" onclick="selectPower(2.30)">2.30</div>
                    <div class="power-button selected" onclick="selectPower(3.45)" id="power-default">3.45</div>
                    <div class="power-button" onclick="selectPower(4.60)">4.60</div>
                    <div class="power-button" onclick="selectPower(5.75)">5.75</div>
                    <div class="power-button" onclick="selectPower(6.90)">6.90</div>
                    <div class="power-button" onclick="selectPower(10.35)">10.35</div>
                    <div class="power-button" onclick="selectPower(13.80)">13.80</div>
                    <div class="power-button" onclick="selectPower(17.25)">17.25</div>
                    <div class="power-button" onclick="selectPower(20.70)">20.70</div>
                </div>
                <div style="text-align: center; margin-top: 4px; color: var(--text-light); font-size: 0.75rem;">kVA</div>
            </div>

            <!-- 3. PERFIL -->
            <div class="quick-card">
                <div class="quick-title">üïê Como utiliza mais eletricidade?</div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div class="quick-option selected" onclick="selectUsagePattern('balanced')" id="usage-balanced">
                        <input type="radio" name="usage" checked> Uso equilibrado ao longo do dia
                    </div>
                    <div class="quick-option" onclick="selectUsagePattern('night')" id="usage-night">
                        <input type="radio" name="usage"> Maior consumo √† noite (ap√≥s as 22h)
                    </div>
                </div>
            </div>

            <!-- 4. TIPO -->
            <div class="quick-card">
                <div class="quick-title">üéØ O que procura?</div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div class="quick-option selected" onclick="selectTariffType('all')" id="tariff-all">
                        <input type="radio" name="tariff-type" checked> A mais barata agora (Todas as op√ß√µes)
                    </div>
                    <div class="quick-option" onclick="selectTariffType('fixed')" id="tariff-fixed">
                        <input type="radio" name="tariff-type"> S√≥ Pre√ßo Fixo (Sem oscila√ß√µes)
                    </div>
                </div>
            </div>

            <!-- 5. AJUSTES -->
            <div class="quick-card">
                <div style="cursor: pointer; padding: 8px; background: #f1f5f9; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;" onclick="toggleQuickSettings()">
                    <span style="font-weight: 600; font-size: 0.9rem;">‚öôÔ∏è Ajustes r√°pidos</span>
                    <i class="fa-solid fa-chevron-down" id="quick-settings-icon"></i>
                </div>
                <div class="hidden" id="quick-settings-content" style="margin-top: 10px;">
                    <div style="margin-bottom: 12px;">
                        <label style="font-weight: 600; margin-bottom: 6px; display: block; font-size: 0.85rem;">Prefere:</label>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <div class="quick-option selected" onclick="selectCycle('simples')" id="cycle-simples">
                                <input type="radio" name="cycle" checked> Tarifa simples
                            </div>
                            <div class="quick-option" onclick="selectCycle('bi')" id="cycle-bi">
                                <input type="radio" name="cycle"> Bi-hor√°rio
                            </div>
                            <div class="quick-option" onclick="selectCycle('tri')" id="cycle-tri">
                                <input type="radio" name="cycle"> Tri-hor√°rio
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label style="font-weight: 600; margin-bottom: 6px; display: block; font-size: 0.85rem;">N√£o mostrar estes comercializadores:</label>
                        <div id="provider-filters" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; font-size: 0.8rem;">
                            <!-- Preenchido dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- RESULTADOS - P√ìDIO -->
            <div id="quick-results" style="display: block;">
                <div class="quick-card">
                    <h2 style="text-align: center; margin-bottom: 16px; font-size: 1.2rem;">
                        üèÜ Melhores Solu√ß√µes
                    </h2>
                    <div class="podium-container" id="podium">
                        <div class="podium-item" style="opacity: 0.3;">
                            <div class="podium-medal">ü•á</div>
                            <div class="podium-name">...</div>
                            <div class="podium-price">-</div>
                        </div>
                        <div class="podium-item" style="opacity: 0.3;">
                            <div class="podium-medal">ü•à</div>
                            <div class="podium-name">...</div>
                            <div class="podium-price">-</div>
                        </div>
                        <div class="podium-item" style="opacity: 0.3;">
                            <div class="podium-medal">ü•â</div>
                            <div class="podium-name">...</div>
                            <div class="podium-price">-</div>
                        </div>
                    </div>
                    
                    <p style="text-align: center; color: var(--text-light); margin: 12px 0 8px 0; font-size: 0.85rem;">
                        Quer ver mais detalhes ou todos os comercializadores?
                    </p>
                    <button style="width: 100%; padding: 12px; background: white; border: 2px solid var(--primary); color: var(--primary); border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem;" onclick="switchTab('complete')">
                        üìã Ver Tabela Completa
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- === ABA 2 & 3: SIMULA√á√ÉO COMPLETA E AN√ÅLISE AVAN√áADA === -->
    <div id="app" class="grid-container hidden">
        
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
        <div class="sidebar" id="sidebar-panel">
            <button class="sidebar-close" onclick="toggleSidebar()" aria-label="Fechar">&times;</button>
            <h2 style="color:var(--primary); margin-top:0; font-size:1.4rem; display:flex; align-items:center; gap:10px;">
                <i class="fa-solid fa-bolt"></i> Simulador Tiago Fel√≠cia <span style="font-size:0.4em; background:var(--text-main); color:white; padding:2px 4px; border-radius:4px;">v2</span>
            </h2>
            
            <div class="section-title" onclick="toggleSection('contrato')">Contrato <i class="fa-solid fa-chevron-down" id="icon-contrato"></i></div>
            <div class="section-content" id="content-contrato">
                <div class="input-group">
                    <label>Pot√™ncia <span class="label-units">(kVA)</span></label>
                    <select id="potencia" onchange="atualizarMenusCiclo(); autoCollapse('contrato')">
                        <option value="1.15">1.15 kVA</option><option value="2.3">2.30 kVA</option>
                        <option value="3.45" selected>3.45 kVA</option><option value="4.6">4.60 kVA</option>
                        <option value="5.75">5.75 kVA</option><option value="6.9">6.90 kVA</option>
                        <option value="10.35">10.35 kVA</option><option value="13.8">13.80 kVA</option>
                        <option value="17.25">17.25 kVA</option><option value="20.7">20.70 kVA</option>
                        <option value="27.6">27.60 kVA</option><option value="34.5">34.50 kVA</option>
                        <option value="41.4">41.40 kVA</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Op√ß√£o Hor√°ria</label>
                    <select id="ciclo" onchange="construirInputsConsumo(); autoCollapse('contrato')"></select>
                </div>
            </div>

            <div class="section-title" onclick="toggleSection('consumo')">Consumo <span class="label-units">(kWh)</span> <i class="fa-solid fa-chevron-down" id="icon-consumo"></i></div>
            <div class="section-content" id="content-consumo"></div>

            <div id="eredes-section-wrapper">
                <div class="section-title" onclick="toggleSection('eredes')">Diagrama de Cargas E-Redes <i class="fa-solid fa-chevron-right" id="icon-eredes"></i></div>
                <div class="section-content collapsed" id="content-eredes">
                <!-- √Årea de Upload (vis√≠vel inicialmente) -->
                <div id="eredes-upload" style="background:#e0f2fe; border:1px solid #0ea5e9; padding:12px; border-radius:8px; margin-bottom:12px;">
                    <div style="font-size:0.85rem; margin-bottom:8px; font-weight:600; color:#0369a1;">
                        <i class="fa-solid fa-file-excel"></i> Upload Ficheiro(s) Excel
                    </div>
                    <input type="file" id="file-eredes" accept=".xlsx,.xls" multiple style="font-size:0.8rem; padding:6px;" onchange="processarFicheirosERedes()">
                    <div id="eredes-status" style="margin-top:8px; font-size:0.75rem; color:#64748b;"></div>
                    <div id="eredes-info" style="margin-top:8px; font-size:0.75rem; background:#fef3c7; border:1px solid #fde047; padding:6px; border-radius:4px; display:none;"></div>
                </div>
                
                <!-- √Årea de Limpar (oculta inicialmente) -->
                <div id="eredes-limpar" style="display:none; background:#d1fae5; border:1px solid #10b981; padding:12px; border-radius:8px; margin-bottom:12px;">
                    <div style="font-size:0.85rem; margin-bottom:8px; font-weight:600; color:#059669;">
                        <i class="fa-solid fa-check-circle"></i> Ficheiro(s) Processado(s)
                    </div>
                    <div id="eredes-resumo" style="font-size:0.75rem; margin-bottom:8px; color:#064e3b;"></div>
                    <button onclick="limparDadosERedes()" style="width:100%; padding:8px; background:#dc2626; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">
                        <i class="fa-solid fa-trash"></i> Limpar Dados e Reiniciar
                    </button>
                </div>
                
                <div style="font-size:0.7rem; color:var(--text-light); line-height:1.4;">
                    ‚ÑπÔ∏è Carregue ficheiros de consumos da E-Redes (formato Excel). Os consumos ser√£o calculados automaticamente hora-a-hora.
                </div>
            </div>
            </div> <!-- Fim eredes-section-wrapper -->

            <div class="section-title" onclick="toggleSection('meu')">O Meu Tarif√°rio <i class="fa-solid fa-chevron-right" id="icon-meu"></i></div>
            <div class="section-content collapsed" id="content-meu">
                <div class="custom-tariff">
                    <div class="input-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="meu_ativo" onchange="toggleMeuTarifario()"> Ativar compara√ß√£o
                        </label>
                    </div>
                    <div id="meu-inputs" class="hidden" style="margin-top:8px;"></div>
                </div>
            </div>

            <div class="section-title" onclick="toggleSection('personalizado')">Tarif√°rio Personalizado <i class="fa-solid fa-chevron-right" id="icon-personalizado"></i></div>
            <div class="section-content collapsed" id="content-personalizado">
                <div class="custom-tariff">
                    <div class="input-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="pers_ativo" onchange="toggleTarifarioPersonalizado()"> Ativar compara√ß√£o
                        </label>
                    </div>
                    <small style="color:var(--text-light); display:block; margin-top:4px; font-size:0.7rem;">
                        Ideal para comparar diferentes op√ß√µes tarif√°rias/hor√°rias. N√£o permite descontos e acr√©scimos.
                    </small>
                    <div id="pers-inputs" class="hidden" style="margin-top:12px;">
                    </div>
                </div>
            </div>

            <div class="section-title" onclick="toggleSection('comparacao')">Modo de Compara√ß√£o <i class="fa-solid fa-chevron-right" id="icon-comparacao"></i></div>
            <div class="section-content collapsed" id="content-comparacao">
                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="modo_comparacao" onchange="calcular()"> Comparar Op√ß√µes Hor√°rias
                    </label>
                </div>
                <small style="color:var(--text-light); display:block; margin-top:4px; font-size:0.7rem;">
                    Compare o custo de cada tarif√°rio em diferentes op√ß√µes hor√°rias (Simples, Bi-Hor√°rio, Tri-Hor√°rio) usando os seus consumos.
                </small>
            </div>

            <div class="section-title" onclick="toggleSection('beneficios')">Benef√≠cios Sociais <i class="fa-solid fa-chevron-right" id="icon-beneficios"></i></div>
            <div class="section-content collapsed" id="content-beneficios">
                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="familia_numerosa" onchange="calcular()"> Fam√≠lia Numerosa
                    </label>
                    <small style="color:var(--text-light); margin-left:22px; display:block; font-size:0.75rem;">Limite IVA 6%: 300 <span class="label-units">kWh</span> (‚â§6.9 <span class="label-units">kVA</span>)</small>
                </div>
                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="tarifa_social" onchange="calcular()"> Tarifa Social
                    </label>
                    <small style="color:var(--text-light); margin-left:22px; display:block; font-size:0.75rem;">Descontos TAR (‚â§6.9 <span class="label-units">kVA</span>)</small>
                </div>
            </div>

            <div class="section-title" onclick="toggleSection('opcoes')">Op√ß√µes Adicionais <i class="fa-solid fa-chevron-right" id="icon-opcoes"></i></div>
            <div class="section-content collapsed" id="content-opcoes">
                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="ocultar_edp_h" checked onchange="calcular()"> Ocultar EDP Hor√°ria
                    </label>
                </div>
                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="quota_acp" checked onchange="calcular()"> Incluir Quota ACP
                    </label>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="input-group">
                        <label>CAV <span class="label-units">(‚Ç¨/m√™s)</span></label>
                        <input type="number" id="cav_valor" value="2.85" step="0.01" oninput="calcular()">
                    </div>
                    <div class="input-group">
                        <label>DGEG <span class="label-units">(‚Ç¨/m√™s)</span></label>
                        <input type="number" id="dgeg_valor" value="0.07" step="0.01" oninput="calcular()">
                    </div>
                </div>
            </div>

            <div class="section-title" onclick="toggleSection('datas')">Datas de Fatura√ß√£o <i class="fa-solid fa-chevron-right" id="icon-datas"></i></div>
            <div class="section-content collapsed" id="content-datas">
                <div class="input-group">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                        <div><label>In√≠cio</label><input type="date" id="d_inicio" value="2025-01-01" min="2025-01-01" max="2026-12-31" onchange="atualizarDias()"></div>
                        <div><label>Fim</label><input type="date" id="d_fim" value="2025-12-31" min="2025-01-01" max="2026-12-31" onchange="atualizarDias()"></div>
                    </div>
                </div>
                <div class="input-group">
                    <label>Dias de Fatura√ß√£o</label>
                    <input type="number" id="num_dias" readonly style="background:#f1f5f9; font-weight:bold;">
                </div>
            </div>

            <div id="omie-panel" class="omie-box hidden">
                <div style="font-size:0.75rem; text-transform:uppercase; font-weight:700; color:#9a3412; margin-bottom:6px;">
                    <i class="fa-solid fa-chart-line"></i> M√©dia OMIE <span class="label-units">(‚Ç¨/MWh)</span>
                </div>
                <div id="omie-display" style="font-size:0.85rem; margin-bottom:8px; font-family: 'Roboto Mono', monospace;"></div>
                <div id="omie-inputs" class="omie-editable"></div>
                <div style="font-size:0.7rem; color:var(--text-light); margin-top:4px;">*Edi√ß√£o manual fixa o valor para todo o c√°lculo.</div>
            </div>
        </div>

        <div class="main-content">
            <button class="sidebar-toggle" id="sidebar-toggle-btn" onclick="toggleSidebar()"><i class="fa-solid fa-sliders"></i> Par√¢metros</button>
            
            <div class="filters-bar">
                <div class="filter-item">
                    <label>Segmento</label>
                    <select id="f_segmento" onchange="calcular()">
                        <option value="Ambos">Ambos</option>
                        <option value="Residencial" selected>Residencial</option>
                        <option value="Empresarial">Empresarial</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>Fatura√ß√£o</label>
                    <select id="f_fatura" onchange="calcular()">
                        <option value="Todas">Todas</option>
                        <option value="Fatura eletr√≥nica">Eletr√≥nica</option>
                        <option value="Fatura em papel">Papel</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>Pagamento</label>
                    <select id="f_pagamento" onchange="calcular()">
                        <option value="Todos">Todos</option>
                        <option value="D√©bito Direto">D√©bito Direto</option>
                        <option value="Multibanco">Multibanco</option>
                        <option value="Numer√°rio/Payshop/CTT">Outros (Num/CTT)</option>
                    </select>
                </div>
                <div class="filter-item" style="flex: 2;">
                    <label>Tipo Tarif√°rio</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label"><input type="checkbox" class="chk-tipo" value="Fixo" checked onchange="calcular()"> Fixo</label>
                        <label class="checkbox-label"><input type="checkbox" class="chk-tipo" value="Indexado M√©dia" checked onchange="calcular()"> Indexado M√©dia</label>
                        <label class="checkbox-label"><input type="checkbox" class="chk-tipo" value="Indexado quarto-hor√°rio" checked onchange="calcular()"> Indexado QH</label>
                    </div>
                </div>
                <div class="filter-item" style="flex: 2;">
                    <label>Pesquisar Comercializador/Tarif√°rio</label>
                    <input type="text" id="f_procura" placeholder="Ex: Galp, Goldenergy, BTN..." oninput="calcular()" style="width:100%;">
                </div>
            </div>
            
            <!-- Filtro de Comercializadores Aba 2 -->
            <div id="filter-providers-aba2" style="background: var(--surface); padding: 12px 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px;">
                <div style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleProviderFilterAba2()">
                    <label style="font-weight: 600; cursor: pointer;"><i class="fa-solid fa-filter"></i> N√£o mostrar estes comercializadores:</label>
                    <i class="fa-solid fa-chevron-down" id="icon-filter-providers-aba2"></i>
                </div>
                <div id="content-filter-providers-aba2" class="collapsed" style="margin-top: 12px;">
                    <div id="provider-filters-aba2" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px;">
                    </div>
                </div>
            </div>
            
            <!-- Filtro de Comercializadores Aba 3 -->
            <div id="filter-providers-aba3" style="background: var(--surface); padding: 12px 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px; display: none;">
                <div style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleProviderFilterAba3()">
                    <label style="font-weight: 600; cursor: pointer;"><i class="fa-solid fa-filter"></i> N√£o mostrar estes comercializadores:</label>
                    <i class="fa-solid fa-chevron-down" id="icon-filter-providers-aba3"></i>
                </div>
                <div id="content-filter-providers-aba3" class="collapsed" style="margin-top: 12px;">
                    <div id="provider-filters-aba3" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px;">
                    </div>
                </div>
            </div>
            
            <!-- Gr√°fico Evolu√ß√£o OMIE (Aba 2) -->
            <div id="grafico-omie-container" style="margin-bottom: 16px;">
                <div style="cursor: pointer; padding: 15px; background: #fff7ed; border: 1px solid #fed7aa; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;" onclick="toggleGraficoOmie()">
                    <h5 style="margin: 0; color: #9a3412; font-size: 1rem;">
                        <i class="fa-solid fa-chart-line"></i> Gr√°fico de Evolu√ß√£o dos Pre√ßos M√©dios Di√°rios OMIE PT no Per√≠odo
                    </h5>
                    <i id="grafico-omie-icon" class="fa-solid fa-chevron-down" style="color: #9a3412;"></i>
                </div>
                <div id="grafico-omie-content" class="collapsed" style="margin-top: 15px;">
                    <div id="chart-omie-diario" style="height: 350px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
                </div>
            </div>

            <!-- Tabela de An√°lise de Consumos (s√≥ aparece com ficheiros E-Redes) -->
            <div id="analise-consumos" style="display:none; margin-bottom:25px;">
                <div style="cursor:pointer; padding:15px; background:#f0f9ff; border:1px solid #0ea5e9; border-radius:10px; display:flex; justify-content:space-between; align-items:center;" onclick="toggleAnalise()">
                    <h5 style="margin:0; color:#0369a1; font-size:1rem;">
                        <i class="fa-solid fa-chart-pie"></i> An√°lise de Consumos e M√©dias OMIE (do(s) ficheiro(s))
                    </h5>
                    <i id="analise-icon" class="fa-solid fa-chevron-down" style="color:#0369a1;"></i>
                </div>
                <div id="analise-content" style="margin-top:15px; overflow-x:auto;">
                </div>
            </div>
            
            <!-- Gr√°ficos de An√°lise E-Redes (Aba 3) -->
            <div id="graficos-analise-eredes" style="display:none; margin-bottom:25px;">
                <div style="cursor:pointer; padding:15px; background:#f0fdf4; border:1px solid #22c55e; border-radius:10px; display:flex; justify-content:space-between; align-items:center;" onclick="toggleGraficosAnalise()">
                    <h5 style="margin:0; color:#15803d; font-size:1rem;">
                        <i class="fa-solid fa-chart-area"></i> Gr√°ficos de An√°lise (Consumo vs. OMIE)
                    </h5>
                    <i id="graficos-analise-icon" class="fa-solid fa-chevron-down" style="color:#15803d;"></i>
                </div>
                <div id="graficos-analise-content" class="collapsed" style="margin-top:15px;">
                    <!-- Gr√°fico Hor√°rio -->
                    <div style="margin-bottom: 20px;">
                        <h6 style="margin: 0 0 10px 0; color: #374151;">Consumo e Pre√ßo M√©dio OMIE por Hora</h6>
                        <div id="chart-horario" style="height: 400px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
                    </div>
                    <!-- Gr√°fico Di√°rio -->
                    <div style="margin-bottom: 20px;">
                        <h6 style="margin: 0 0 10px 0; color: #374151;">Consumo e Pre√ßo M√©dio OMIE Di√°rio</h6>
                        <div id="chart-diario" style="height: 400px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
                    </div>
                    <!-- Gr√°fico por Dia da Semana -->
                    <div style="margin-bottom: 20px;">
                        <h6 style="margin: 0 0 10px 0; color: #374151;">Consumo e Pre√ßo M√©dio OMIE por Dia da Semana</h6>
                        <div id="chart-semana" style="height: 400px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
                    </div>
                    <!-- Gr√°fico Mensal -->
                    <div style="margin-bottom: 20px;">
                        <h6 style="margin: 0 0 10px 0; color: #374151;">Consumo e Pre√ßo M√©dio OMIE Mensal</h6>
                        <div id="chart-mensal" style="height: 400px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;"></div>
                    </div>
                </div>
            </div>
            
            <!-- An√°lise da Pot√™ncia Contratada (Aba 3) -->
            <div id="analise-potencia" style="display:none; margin-bottom:25px;">
                <div style="cursor:pointer; padding:15px; background:#fef3c7; border:1px solid #fde047; border-radius:10px; display:flex; justify-content:space-between; align-items:center;" onclick="toggleAnalisePotencia()">
                    <h5 style="margin:0; color:#92400e; font-size:1rem;">
                        <i class="fa-solid fa-bolt"></i> An√°lise da Pot√™ncia Contratada
                    </h5>
                    <i id="analise-potencia-icon" class="fa-solid fa-chevron-down" style="color:#92400e;"></i>
                </div>
                <div id="analise-potencia-content" style="margin-top:15px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
                        <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 4px;">Pot√™ncia Contratada</div>
                            <div id="potencia-contratada-display" style="font-size: 1.5rem; font-weight: 700; color: #0f172a;">-- kVA</div>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 4px;">Pot√™ncia M√°xima Registada</div>
                            <div id="potencia-maxima-display" style="font-size: 1.5rem; font-weight: 700; color: #0f172a;">-- kW</div>
                            <div style="font-size: 0.75rem; color: #94a3b8;">(M√©dias de 15 min)</div>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 4px;">Utiliza√ß√£o da Pot√™ncia</div>
                            <div id="potencia-utilizacao-display" style="font-size: 1.5rem; font-weight: 700; color: #0f172a;">-- %</div>
                        </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" id="chk-trifasico" onchange="atualizarAnalisePotencia()">
                            <span>A minha instala√ß√£o √© Trif√°sica</span>
                        </label>
                    </div>
                    <div id="potencia-recomendacao" style="padding: 12px; border-radius: 8px; background: #f1f5f9;">
                    </div>
                </div>
            </div>

            <!-- Resumo da Simula√ß√£o -->
            <div id="resumo-simulacao" style="background-color:#f9f9f9; border:1px solid #ddd; border-radius:10px; margin-bottom:25px; color:#333; display:none;">
                <div style="cursor:pointer; padding:15px; display:flex; justify-content:space-between; align-items:center;" onclick="toggleResumo()">
                    <h5 style="margin:0; color:#333;">Resumo da Simula√ß√£o</h5>
                    <i id="resumo-icon" class="fa-solid fa-chevron-down" style="color:#333;"></i>
                </div>
                <div id="resumo-content" style="padding:0 15px 15px 15px;">
                    <ul style="list-style-type:none; padding-left:0;" id="resumo-list"></ul>
                </div>
            </div>

            <!-- Subt√≠tulo e Descri√ß√µes -->
            <div style="margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
                    <h4 id="titulo-tabela" style="margin-bottom:0; color:var(--text-main);">Tiago Fel√≠cia - Tarif√°rios de Eletricidade - Detalhado</h4>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button id="btn-partilhar" onclick="gerarLinkPartilha()" style="display:none; padding:6px 14px; border:1px solid var(--primary); background:white; color:var(--primary); border-radius:8px; cursor:pointer; font-size:0.8rem; font-weight:600; transition:all 0.2s;" onmouseover="this.style.background='var(--primary)';this.style.color='white'" onmouseout="this.style.background='white';this.style.color='var(--primary)'">
                            <i class="fa-solid fa-link"></i> Partilhar Simula√ß√£o
                        </button>
                        <button id="btn-exportar" onclick="exportarExcel()" style="display:none; padding:6px 14px; border:1px solid #16a34a; background:white; color:#16a34a; border-radius:8px; cursor:pointer; font-size:0.8rem; font-weight:600; transition:all 0.2s;" onmouseover="this.style.background='#16a34a';this.style.color='white'" onmouseout="this.style.background='white';this.style.color='#16a34a'">
                            <i class="fa-solid fa-file-excel"></i> Exportar Excel
                        </button>
                    </div>
                </div>
                <div style="font-size:0.9rem; color:var(--text-light); line-height:1.5;">
                </div>
            </div>

            <!-- Mensagem de Poupan√ßa -->
            <div id="mensagem-poupanca" style="margin-bottom:15px; display:none;"></div>

            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:10px;">
                <div id="res-count" style="font-weight:600; color:var(--text-light);">0 tarifas</div>
                <div style="font-size:0.75rem; color:var(--text-light)">Total com Valores Finais (todos os componentes, taxas e impostos). Valores unit√°rios de Energia e Pot√™ncia sem IVA.</div>
            </div>

            <div class="table-wrap">
                <table id="tabela">
                    <thead id="thead"></thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tooltip" class="tooltip hidden"></div>

    <script>
        // Link direto para o ficheiro no Hugging Face
        const FILENAME = "https://huggingface.co/spaces/tiagofelicia/simulador-tarifarios-eletricidade/resolve/main/Tarifarios_%F0%9F%94%8C_Eletricidade_Tiago_Felicia.xlsx";
        let DATA = { fixos: [], indexados: [], omie: [], constantes: {}, perdas: {} };
        let SORT = { col: 'total', asc: true };
        let OMIE_VALUES = { S:0, V:0, F:0, P:0, C:0 };
        let OMIE_MANUAL = false;

        // === VARI√ÅVEIS GLOBAIS DAS ABAS ===
        let CURRENT_TAB = 'quick';
        let LAST_EXPORT_DATA = null;

        // === VARI√ÅVEIS DA SIMULA√á√ÉO R√ÅPIDA ===        
        let QUICK_PARAMS = {
            kwh: 158,
            power: 3.45,
            usagePattern: 'balanced', // 'balanced' ou 'night'
            tariffType: 'all', // 'all' ou 'fixed'
            cycle: 'simples',// 'simples', 'bi', 'tri'
            excludedProviders: []
        };

        let SNAPSHOT_ABA2 = {
            hasData: false,
            consumos: {},
            periodo: {},
            origem: 'manual'
        };
        
        // === ESTADO INDEPENDENTE ABA 2 (Simula√ß√£o Completa) ===
        let STATE_ABA2 = {
            potencia: 3.45,
            ciclo: 'Simples',
            dataInicio: null,
            dataFim: null,
            consumos: { S: 158, V: 63, F: 95, C: 68, P: 27 },
            omieValues: { S: 0, V: 0, F: 0, P: 0, C: 0 },
            omieManual: false,
            excludedProviders: [],
            meuTarifario: { ativo: false, collapsed: true },
            tarifarioPersonalizado: { 
                ativo: false, 
                collapsed: true,
                valores: {} // Guardar valores individuais dos campos
            },
            modoComparacao: false
        };
        
        // === ESTADO INDEPENDENTE ABA 3 (An√°lise Avan√ßada E-Redes) ===
        let STATE_ABA3 = {
            potencia: 3.45,
            ciclo: 'Simples',
            dataInicio: null,
            dataFim: null,
            consumos: { S: 0, V: 0, F: 0, C: 0, P: 0 },
            omieValues: { S: 0, V: 0, F: 0, P: 0, C: 0 },
            omieManual: false,
            excludedProviders: [],
            dadosERedes: null,
            ficheiroProcessado: false,
            meuTarifario: { ativo: false, collapsed: true },
            tarifarioPersonalizado: { 
                ativo: false, 
                collapsed: true,
                valores: {} // Guardar valores individuais dos campos
            },
            modoComparacao: false
        };
        
        const CAV_FIXO_COMERCIALIZADORES = ["CUR", "EDP", "Galp", "Goldenergy", "Ibelectra", "Iberdrola", "Luzig√°s", "Plenitude", "YesEnergy"];

        // Fun√ß√£o para converter data da Constante (Excel Serial ou Texto) para Objeto Date JS
        function getDataReferencia(chave) {
            const val = DATA.constantes[chave];
            if (!val) return null;

            // Caso 1: N√∫mero de s√©rie do Excel (ex: 45330)
            if (typeof val === 'number') {
                const dateInfo = XLSX.SSF.parse_date_code(val);
                // Cria data (M√™s em JS √© 0-indexado)
                return new Date(dateInfo.y, dateInfo.m - 1, dateInfo.d);
            }

            // Caso 2: String (YYYY-MM-DD ou DD/MM/YYYY)
            if (typeof val === 'string') {
                const d = parseDateFromDB(val); // Reutiliza a tua fun√ß√£o existente
                if (d) return new Date(d);
            }

            return null;
        }

    function atualizarDatasReferencia() {
        // Tenta obter as datas
        const dOmie = getDataReferencia('Data_Valores_OMIE');
        const dOmip = getDataReferencia('Data_Valores_OMIP');
        
        const faqContainer = document.getElementById('datas-ref-faq');
        if (!faqContainer) return;

        // Fun√ß√£o auxiliar para formatar a data ou mostrar aviso
        const fmt = (d) => d ? d.toLocaleDateString('pt-PT') : '<span style="color:#d9534f;">(N√£o encontrado)</span>';
        
        // Constr√≥i o HTML SEMPRE, mesmo que as datas sejam null
        const html = `
            <div style="background-color: #d9edf7; padding: 15px; border-left: 5px solid #31708f; border-radius: 4px; color: #31708f; font-size: 0.95rem; margin-top: 20px; margin-bottom: 20px;">
                <div style="font-weight:bold; margin-bottom:8px; font-size: 1rem;">
                    <i class="fa-solid fa-calendar-days"></i> Datas de Refer√™ncia dos Valores de Mercado
                </div>
                <div style="margin-bottom: 4px;">‚Ä¢ Valores OMIE (SPOT) reais at√©: <b>${fmt(dOmie)}</b></div>
                <div>‚Ä¢ Valores OMIP (Futuros) atualizados em: <b>${fmt(dOmip)}</b></div>
            </div>
        `;

        faqContainer.innerHTML = html;
    }

        // === CONTROLE DE ABAS ===
        function switchTab(tabName) {
            const previousTab = CURRENT_TAB;
            
            // GUARDAR estado da aba atual antes de sair
            if (previousTab === 'complete') guardarEstadoAba2();
            if (previousTab === 'advanced') guardarEstadoAba3();
            
            CURRENT_TAB = tabName;
            
            // Esconder todas
            document.getElementById('tab-quick').classList.remove('active');
            document.getElementById('app').classList.add('hidden');
            document.getElementById('tab-faq').classList.add('hidden');
            
            // Esconder √°rea central de upload Aba 3
            const uploadCentral = document.getElementById('eredes-upload-central');
            if(uploadCentral) uploadCentral.classList.add('hidden');
            
            // Remover active dos bot√µes
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            if (tabName === 'quick') {
                document.getElementById('tab-quick').classList.add('active');
                document.querySelectorAll('.tab-button')[0].classList.add('active');
            } else if (tabName === 'complete') {
                // Se vem da Aba 1 (quick), sincronizar os par√¢metros atuais para STATE_ABA2
                if (previousTab === 'quick') {
                    STATE_ABA2.potencia = QUICK_PARAMS.power;
                    if (QUICK_PARAMS.cycle === 'simples') STATE_ABA2.ciclo = 'Simples';
                    else if (QUICK_PARAMS.cycle === 'bi') STATE_ABA2.ciclo = 'Bi-hor√°rio - Ciclo Di√°rio';
                    else if (QUICK_PARAMS.cycle === 'tri') STATE_ABA2.ciclo = 'Tri-hor√°rio - Ciclo Di√°rio';
                    STATE_ABA2.dataInicio = document.getElementById('d_inicio').value;
                    STATE_ABA2.dataFim = document.getElementById('d_fim').value;
                    STATE_ABA2.omieValues = {...OMIE_VALUES};
                    STATE_ABA2.omieManual = OMIE_MANUAL;
                    // Converter consumo da Aba 1 para Aba 2 baseado no ciclo
                    const totalKwh = QUICK_PARAMS.kwh;
                    if (QUICK_PARAMS.cycle === 'simples') {
                        STATE_ABA2.consumos = { S: totalKwh, V: 0, F: 0, C: 0, P: 0 };
                    } else if (QUICK_PARAMS.cycle === 'bi') {
                        const pctV = QUICK_PARAMS.usagePattern === 'night' ? 0.50 : 0.40;
                        STATE_ABA2.consumos = { S: 0, V: Math.round(totalKwh * pctV), F: Math.round(totalKwh * (1-pctV)), C: 0, P: 0 };
                    } else if (QUICK_PARAMS.cycle === 'tri') {
                        const pctV = QUICK_PARAMS.usagePattern === 'night' ? 0.45 : 0.35;
                        const pctP = 0.20;
                        const pctC = 1 - pctV - pctP;
                        STATE_ABA2.consumos = { S: 0, V: Math.round(totalKwh * pctV), F: 0, C: Math.round(totalKwh * pctC), P: Math.round(totalKwh * pctP) };
                    }
                }
                
                document.getElementById('app').classList.remove('hidden');
                document.querySelectorAll('.tab-button')[1].classList.add('active');
                
                // === ABA 2: Configurar estado independente ===
                // Esconder tabela de An√°lise na Aba 2
                const analise = document.getElementById('analise-consumos');
                if (analise) analise.style.display = 'none';
                
                // Esconder gr√°ficos de an√°lise na Aba 2
                const graficosAnalise = document.getElementById('graficos-analise-eredes');
                if (graficosAnalise) graficosAnalise.style.display = 'none';
                
                // Esconder an√°lise de pot√™ncia na Aba 2
                const analisePotencia = document.getElementById('analise-potencia');
                if (analisePotencia) analisePotencia.style.display = 'none';
                
                // Mostrar gr√°fico OMIE na Aba 2
                const graficoOmie = document.getElementById('grafico-omie-container');
                if (graficoOmie) graficoOmie.style.display = 'block';
                
                // ESCONDER sec√ß√£o E-Redes da sidebar na Aba 2
                const eredesSectionWrapper = document.getElementById('eredes-section-wrapper');
                if (eredesSectionWrapper) eredesSectionWrapper.style.display = 'none';
                
                // MOSTRAR sec√ß√£o de consumos edit√°veis
                const consumoSection = document.getElementById('content-consumo');
                if (consumoSection) {
                    consumoSection.classList.remove('hidden');
                    const parentTitle = document.querySelector('[onclick="toggleSection(\'consumo\')"]');
                    if(parentTitle) parentTitle.style.display = 'block';
                }
                
                // DESBLOQUEAR inputs na Aba 2
                document.getElementById('d_inicio').disabled = false;
                document.getElementById('d_fim').disabled = false;
                document.getElementById('d_inicio').min = '2025-01-01';
                document.getElementById('d_inicio').max = '2026-12-31';
                document.getElementById('d_fim').min = '2025-01-01';
                document.getElementById('d_fim').max = '2026-12-31';
                ['kwh_S', 'kwh_V', 'kwh_F', 'kwh_C', 'kwh_P'].forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.disabled = false;
                });
                
                // Mostrar filtro de comercializadores da Aba 2
                const filtroAba2 = document.getElementById('filter-providers-aba2');
                if(filtroAba2) filtroAba2.style.display = 'block';
                const filtroAba3 = document.getElementById('filter-providers-aba3');
                if(filtroAba3) filtroAba3.style.display = 'none';
                
                // Restaurar estado Meu Tarif√°rio para Aba 2
                restaurarMeuTarifarioAba(2);
                
                // Restaurar estado Tarif√°rio Personalizado para Aba 2
                restaurarTarifarioPersonalizadoAba(2);
                
                // Restaurar estado Modo Compara√ß√£o para Aba 2
                restaurarModoComparacaoAba(2);
                
                // Restaurar estado da Aba 2
                restaurarEstadoAba2();
                
            } else if (tabName === 'advanced') {
                // === ABA 3: An√°lise Avan√ßada E-Redes ===
                document.querySelectorAll('.tab-button')[2].classList.add('active');
                
                // Verificar se h√° dados E-Redes processados
                if (!STATE_ABA3.ficheiroProcessado) {
                    // Mostrar apenas √°rea de upload central
                    const uploadCentral = document.getElementById('eredes-upload-central');
                    if(uploadCentral) uploadCentral.classList.remove('hidden');
                    document.getElementById('app').classList.add('hidden');
                } else {
                    // Ficheiro processado - mostrar interface completa
                    document.getElementById('app').classList.remove('hidden');
                    
                    // MOSTRAR tabela de An√°lise na Aba 3
                    const analise = document.getElementById('analise-consumos');
                    if (analise && DADOS_EREDES) analise.style.display = 'block';
                    
                    // MOSTRAR gr√°ficos de an√°lise na Aba 3
                    const graficosAnalise = document.getElementById('graficos-analise-eredes');
                    if (graficosAnalise) graficosAnalise.style.display = 'block';
                    
                    // MOSTRAR an√°lise de pot√™ncia na Aba 3
                    const analisePotencia = document.getElementById('analise-potencia');
                    if (analisePotencia) analisePotencia.style.display = 'block';
                    
                    // Esconder gr√°fico OMIE na Aba 3
                    const graficoOmie = document.getElementById('grafico-omie-container');
                    if (graficoOmie) graficoOmie.style.display = 'none';
                    
                    // MOSTRAR sec√ß√£o E-Redes da sidebar (apenas bot√£o limpar)
                    const eredesSectionWrapper = document.getElementById('eredes-section-wrapper');
                    if (eredesSectionWrapper) eredesSectionWrapper.style.display = 'block';
                    
                    // ESCONDER sec√ß√£o de consumos edit√°veis na Aba 3
                    const consumoTitle = document.querySelector('[onclick="toggleSection(\'consumo\')"]');
                    if(consumoTitle) consumoTitle.style.display = 'none';
                    const consumoContent = document.getElementById('content-consumo');
                    if(consumoContent) consumoContent.classList.add('hidden');
                    
                    // Mostrar filtro de comercializadores da Aba 3
                    const filtroAba2 = document.getElementById('filter-providers-aba2');
                    if(filtroAba2) filtroAba2.style.display = 'none';
                    const filtroAba3 = document.getElementById('filter-providers-aba3');
                    if(filtroAba3) filtroAba3.style.display = 'block';
                    
                    // Restaurar estado Meu Tarif√°rio para Aba 3
                    restaurarMeuTarifarioAba(3);
                    
                    // Restaurar estado Tarif√°rio Personalizado para Aba 3
                    restaurarTarifarioPersonalizadoAba(3);
                    
                    // Restaurar estado Modo Compara√ß√£o para Aba 3
                    restaurarModoComparacaoAba(3);
                    
                    // Restaurar estado da Aba 3
                    restaurarEstadoAba3();
                }
            } else if (tabName === 'faq') {
                    const faqTab = document.getElementById('tab-faq');
                    faqTab.classList.remove('hidden');
                    faqTab.classList.add('active');
                    
                    document.querySelectorAll('.tab-button')[3].classList.add('active');
                }
            }
        
        // === FUN√á√ïES PARA GUARDAR/RESTAURAR ESTADO DAS ABAS ===
        function guardarEstadoAba2() {
            STATE_ABA2.potencia = parseFloat(document.getElementById('potencia').value);
            STATE_ABA2.ciclo = document.getElementById('ciclo').value;
            STATE_ABA2.dataInicio = document.getElementById('d_inicio').value;
            STATE_ABA2.dataFim = document.getElementById('d_fim').value;
            STATE_ABA2.omieValues = {...OMIE_VALUES};
            STATE_ABA2.omieManual = OMIE_MANUAL;
            
            // Guardar consumos
            ['S', 'V', 'F', 'C', 'P'].forEach(p => {
                const elem = document.getElementById('kwh_' + p);
                if(elem) STATE_ABA2.consumos[p] = parseFloat(elem.value) || 0;
            });
            
            // Guardar estado Meu Tarif√°rio
            const meuAtivo = document.getElementById('meu_ativo');
            if(meuAtivo) {
                STATE_ABA2.meuTarifario.ativo = meuAtivo.checked;
                // Guardar o HTML dos inputs e estado do collapse
                const meuInputs = document.getElementById('meu-inputs');
                if(meuInputs) STATE_ABA2.meuTarifario.html = meuInputs.innerHTML;
                STATE_ABA2.meuTarifario.collapsed = document.getElementById('content-meu').classList.contains('collapsed');
            }
            
            // Guardar estado Tarif√°rio Personalizado
            const persAtivo = document.getElementById('pers_ativo');
            if(persAtivo) {
                STATE_ABA2.tarifarioPersonalizado.ativo = persAtivo.checked;
                STATE_ABA2.tarifarioPersonalizado.collapsed = document.getElementById('content-personalizado').classList.contains('collapsed');
                
                // Guardar valores individuais dos campos
                STATE_ABA2.tarifarioPersonalizado.valores = {};
                
                // Campos Simples
                const persEnergiaS = document.getElementById('pers_energia_s');
                const persPotenciaS = document.getElementById('pers_potencia_s');
                if(persEnergiaS) STATE_ABA2.tarifarioPersonalizado.valores.energia_s = parseFloat(persEnergiaS.value) || 0;
                if(persPotenciaS) STATE_ABA2.tarifarioPersonalizado.valores.potencia_s = parseFloat(persPotenciaS.value) || 0;
                
                // Campos Bi-hor√°rio
                const persEnergiaVBi = document.getElementById('pers_energia_v_bi');
                const persEnergiaFBi = document.getElementById('pers_energia_f_bi');
                const persPotenciaBi = document.getElementById('pers_potencia_bi');
                if(persEnergiaVBi) STATE_ABA2.tarifarioPersonalizado.valores.energia_v_bi = parseFloat(persEnergiaVBi.value) || 0;
                if(persEnergiaFBi) STATE_ABA2.tarifarioPersonalizado.valores.energia_f_bi = parseFloat(persEnergiaFBi.value) || 0;
                if(persPotenciaBi) STATE_ABA2.tarifarioPersonalizado.valores.potencia_bi = parseFloat(persPotenciaBi.value) || 0;
                
                // Campos Tri-hor√°rio
                const persEnergiaVTri = document.getElementById('pers_energia_v_tri');
                const persenergiaC = document.getElementById('pers_energia_c_tri');
                const persEnergiaP = document.getElementById('pers_energia_p_tri');
                const persPotenciaTri = document.getElementById('pers_potencia_tri');
                if(persEnergiaVTri) STATE_ABA2.tarifarioPersonalizado.valores.energia_v_tri = parseFloat(persEnergiaVTri.value) || 0;
                if(persenergiaC) STATE_ABA2.tarifarioPersonalizado.valores.energia_c_tri = parseFloat(persenergiaC.value) || 0;
                if(persEnergiaP) STATE_ABA2.tarifarioPersonalizado.valores.energia_p_tri = parseFloat(persEnergiaP.value) || 0;
                if(persPotenciaTri) STATE_ABA2.tarifarioPersonalizado.valores.potencia_tri = parseFloat(persPotenciaTri.value) || 0;
                
                // Checkboxes
                const persTarEnergia = document.getElementById('pers_tar_energia');
                const persTarPotencia = document.getElementById('pers_tar_potencia');
                const persTseIncl = document.getElementById('pers_tse_incluido');
                if(persTarEnergia) STATE_ABA2.tarifarioPersonalizado.valores.tar_energia = persTarEnergia.checked;
                if(persTarPotencia) STATE_ABA2.tarifarioPersonalizado.valores.tar_potencia = persTarPotencia.checked;
                if(persTseIncl) STATE_ABA2.tarifarioPersonalizado.valores.tse_incluido = persTseIncl.checked;
            }
            
            // Guardar estado Modo Compara√ß√£o
            const modoComp = document.getElementById('modo_comparacao');
            if(modoComp) {
                STATE_ABA2.modoComparacao = modoComp.checked;
            }
        }
        
        function restaurarEstadoAba2() {
            if(STATE_ABA2.dataInicio) {
                document.getElementById('potencia').value = STATE_ABA2.potencia;
                document.getElementById('ciclo').value = STATE_ABA2.ciclo;
                document.getElementById('d_inicio').value = STATE_ABA2.dataInicio;
                document.getElementById('d_fim').value = STATE_ABA2.dataFim;
                OMIE_VALUES = {...STATE_ABA2.omieValues};
                OMIE_MANUAL = STATE_ABA2.omieManual;
                atualizarDias();
                construirInputsConsumo();
                // IMPORTANTE: Restaurar consumos DEPOIS de construirInputsConsumo (que p√µe defaults)
                const c = STATE_ABA2.ciclo;
                if(c.includes("Simples")) {
                    const el = document.getElementById('kwh_S');
                    if(el && STATE_ABA2.consumos.S) el.value = STATE_ABA2.consumos.S;
                } else if(c.includes("Bi")) {
                    const elV = document.getElementById('kwh_V');
                    const elF = document.getElementById('kwh_F');
                    if(elV && STATE_ABA2.consumos.V) elV.value = STATE_ABA2.consumos.V;
                    if(elF && STATE_ABA2.consumos.F) elF.value = STATE_ABA2.consumos.F;
                } else {
                    const elV = document.getElementById('kwh_V');
                    const elP = document.getElementById('kwh_P');
                    const elC = document.getElementById('kwh_C');
                    if(elV && STATE_ABA2.consumos.V) elV.value = STATE_ABA2.consumos.V;
                    if(elP && STATE_ABA2.consumos.P) elP.value = STATE_ABA2.consumos.P;
                    if(elC && STATE_ABA2.consumos.C) elC.value = STATE_ABA2.consumos.C;
                }
                calcular();
            }
        }
        
        function guardarEstadoAba3() {
            STATE_ABA3.potencia = parseFloat(document.getElementById('potencia').value);
            STATE_ABA3.ciclo = document.getElementById('ciclo').value;
            STATE_ABA3.dataInicio = document.getElementById('d_inicio').value;
            STATE_ABA3.dataFim = document.getElementById('d_fim').value;
            STATE_ABA3.omieValues = {...OMIE_VALUES};
            STATE_ABA3.omieManual = OMIE_MANUAL;
            
            // Guardar estado Meu Tarif√°rio
            const meuAtivo = document.getElementById('meu_ativo');
            if(meuAtivo) {
                STATE_ABA3.meuTarifario.ativo = meuAtivo.checked;
                const meuInputs = document.getElementById('meu-inputs');
                if(meuInputs) STATE_ABA3.meuTarifario.html = meuInputs.innerHTML;
                STATE_ABA3.meuTarifario.collapsed = document.getElementById('content-meu').classList.contains('collapsed');
            }
            
            // Guardar estado Tarif√°rio Personalizado
            const persAtivo = document.getElementById('pers_ativo');
            if(persAtivo) {
                STATE_ABA3.tarifarioPersonalizado.ativo = persAtivo.checked;
                STATE_ABA3.tarifarioPersonalizado.collapsed = document.getElementById('content-personalizado').classList.contains('collapsed');
                
                // Guardar valores individuais dos campos
                STATE_ABA3.tarifarioPersonalizado.valores = {};
                
                // Campos Simples
                const persEnergiaS = document.getElementById('pers_energia_s');
                const persPotenciaS = document.getElementById('pers_potencia_s');
                if(persEnergiaS) STATE_ABA3.tarifarioPersonalizado.valores.energia_s = parseFloat(persEnergiaS.value) || 0;
                if(persPotenciaS) STATE_ABA3.tarifarioPersonalizado.valores.potencia_s = parseFloat(persPotenciaS.value) || 0;
                
                // Campos Bi-hor√°rio
                const persEnergiaVBi = document.getElementById('pers_energia_v_bi');
                const persEnergiaFBi = document.getElementById('pers_energia_f_bi');
                const persPotenciaBi = document.getElementById('pers_potencia_bi');
                if(persEnergiaVBi) STATE_ABA3.tarifarioPersonalizado.valores.energia_v_bi = parseFloat(persEnergiaVBi.value) || 0;
                if(persEnergiaFBi) STATE_ABA3.tarifarioPersonalizado.valores.energia_f_bi = parseFloat(persEnergiaFBi.value) || 0;
                if(persPotenciaBi) STATE_ABA3.tarifarioPersonalizado.valores.potencia_bi = parseFloat(persPotenciaBi.value) || 0;
                
                // Campos Tri-hor√°rio
                const persEnergiaVTri = document.getElementById('pers_energia_v_tri');
                const persenergiaC = document.getElementById('pers_energia_c_tri');
                const persEnergiaP = document.getElementById('pers_energia_p_tri');
                const persPotenciaTri = document.getElementById('pers_potencia_tri');
                if(persEnergiaVTri) STATE_ABA3.tarifarioPersonalizado.valores.energia_v_tri = parseFloat(persEnergiaVTri.value) || 0;
                if(persenergiaC) STATE_ABA3.tarifarioPersonalizado.valores.energia_c_tri = parseFloat(persenergiaC.value) || 0;
                if(persEnergiaP) STATE_ABA3.tarifarioPersonalizado.valores.energia_p_tri = parseFloat(persEnergiaP.value) || 0;
                if(persPotenciaTri) STATE_ABA3.tarifarioPersonalizado.valores.potencia_tri = parseFloat(persPotenciaTri.value) || 0;
                
                // Checkboxes
                const persTarEnergia = document.getElementById('pers_tar_energia');
                const persTarPotencia = document.getElementById('pers_tar_potencia');
                const persTseIncl = document.getElementById('pers_tse_incluido');
                if(persTarEnergia) STATE_ABA3.tarifarioPersonalizado.valores.tar_energia = persTarEnergia.checked;
                if(persTarPotencia) STATE_ABA3.tarifarioPersonalizado.valores.tar_potencia = persTarPotencia.checked;
                if(persTseIncl) STATE_ABA3.tarifarioPersonalizado.valores.tse_incluido = persTseIncl.checked;
            }
            
            // Guardar estado Modo Compara√ß√£o
            const modoComp = document.getElementById('modo_comparacao');
            if(modoComp) {
                STATE_ABA3.modoComparacao = modoComp.checked;
            }
        }
        
        function restaurarEstadoAba3() {
            if(STATE_ABA3.dataInicio) {
                document.getElementById('potencia').value = STATE_ABA3.potencia;
                document.getElementById('ciclo').value = STATE_ABA3.ciclo;
                
                // Aplicar restri√ß√µes de data do ficheiro E-Redes
                if(DADOS_EREDES && DADOS_EREDES.periodo) {
                    const absInicio = DADOS_EREDES.periodo.inicio;
                    const absFim = DADOS_EREDES.periodo.fim;
                    const d1Input = document.getElementById('d_inicio');
                    const d2Input = document.getElementById('d_fim');
                    d1Input.min = absInicio;
                    d1Input.max = absFim;
                    d2Input.min = absInicio;
                    d2Input.max = absFim;
                    // Garantir que as datas est√£o dentro dos limites do ficheiro
                    d1Input.value = STATE_ABA3.dataInicio < absInicio ? absInicio : (STATE_ABA3.dataInicio > absFim ? absInicio : STATE_ABA3.dataInicio);
                    d2Input.value = STATE_ABA3.dataFim > absFim ? absFim : (STATE_ABA3.dataFim < absInicio ? absFim : STATE_ABA3.dataFim);
                } else {
                    document.getElementById('d_inicio').value = STATE_ABA3.dataInicio;
                    document.getElementById('d_fim').value = STATE_ABA3.dataFim;
                }
                
                OMIE_VALUES = {...STATE_ABA3.omieValues};
                OMIE_MANUAL = STATE_ABA3.omieManual;
                atualizarDias();
                
                construirInputsConsumo();
            }
        }
        
        // === GUARDAR/RESTAURAR "MEU TARIF√ÅRIO" POR ABA ===
        function restaurarMeuTarifarioAba(abaNum) {
            const state = abaNum === 2 ? STATE_ABA2 : STATE_ABA3;
            const meuAtivo = document.getElementById('meu_ativo');
            const meuInputs = document.getElementById('meu-inputs');
            const contentMeu = document.getElementById('content-meu');
            
            if(meuAtivo) {
                meuAtivo.checked = state.meuTarifario.ativo;
                if(state.meuTarifario.ativo && state.meuTarifario.html) {
                    meuInputs.innerHTML = state.meuTarifario.html;
                    meuInputs.classList.remove('hidden');
                } else {
                    meuInputs.classList.add('hidden');
                }
            }
            
            // Restaurar collapse state
            if(contentMeu) {
                if(state.meuTarifario.collapsed) {
                    contentMeu.classList.add('collapsed');
                } else {
                    contentMeu.classList.remove('collapsed');
                }
            }
        }
        
        // === RESTAURAR "TARIF√ÅRIO PERSONALIZADO" POR ABA ===
        function restaurarTarifarioPersonalizadoAba(abaNum) {
            const state = abaNum === 2 ? STATE_ABA2 : STATE_ABA3;
            const persAtivo = document.getElementById('pers_ativo');
            const contentPers = document.getElementById('content-personalizado');
            
            if(persAtivo) {
                persAtivo.checked = state.tarifarioPersonalizado.ativo;
                
                if(state.tarifarioPersonalizado.ativo) {
                    // Reconstruir o HTML dos campos primeiro (baseado no ciclo atual)
                    toggleTarifarioPersonalizado();
                    
                    // Agora restaurar os valores guardados
                    const valores = state.tarifarioPersonalizado.valores;
                    if(valores) {
                        // Restaurar campos Simples
                        const persEnergiaS = document.getElementById('pers_energia_s');
                        const persPotenciaS = document.getElementById('pers_potencia_s');
                        if(persEnergiaS && valores.energia_s !== undefined) persEnergiaS.value = valores.energia_s;
                        if(persPotenciaS && valores.potencia_s !== undefined) persPotenciaS.value = valores.potencia_s;
                        
                        // Restaurar campos Bi-hor√°rio
                        const persEnergiaVBi = document.getElementById('pers_energia_v_bi');
                        const persEnergiaFBi = document.getElementById('pers_energia_f_bi');
                        const persPotenciaBi = document.getElementById('pers_potencia_bi');
                        if(persEnergiaVBi && valores.energia_v_bi !== undefined) persEnergiaVBi.value = valores.energia_v_bi;
                        if(persEnergiaFBi && valores.energia_f_bi !== undefined) persEnergiaFBi.value = valores.energia_f_bi;
                        if(persPotenciaBi && valores.potencia_bi !== undefined) persPotenciaBi.value = valores.potencia_bi;
                        
                        // Restaurar campos Tri-hor√°rio
                        const persEnergiaVTri = document.getElementById('pers_energia_v_tri');
                        const persEnergiaC = document.getElementById('pers_energia_c_tri');
                        const persEnergiaP = document.getElementById('pers_energia_p_tri');
                        const persPotenciaTri = document.getElementById('pers_potencia_tri');
                        if(persEnergiaVTri && valores.energia_v_tri !== undefined) persEnergiaVTri.value = valores.energia_v_tri;
                        if(persEnergiaC && valores.energia_c_tri !== undefined) persEnergiaC.value = valores.energia_c_tri;
                        if(persEnergiaP && valores.energia_p_tri !== undefined) persEnergiaP.value = valores.energia_p_tri;
                        if(persPotenciaTri && valores.potencia_tri !== undefined) persPotenciaTri.value = valores.potencia_tri;
                        
                        // Restaurar checkboxes
                        const persTarEnergia = document.getElementById('pers_tar_energia');
                        const persTarPotencia = document.getElementById('pers_tar_potencia');
                        const persTseIncl = document.getElementById('pers_tse_incluido');
                        if(persTarEnergia && valores.tar_energia !== undefined) persTarEnergia.checked = valores.tar_energia;
                        if(persTarPotencia && valores.tar_potencia !== undefined) persTarPotencia.checked = valores.tar_potencia;
                        if(persTseIncl && valores.tse_incluido !== undefined) persTseIncl.checked = valores.tse_incluido;
                    }
                }
            }
            
            // Restaurar collapse state
            if(contentPers) {
                if(state.tarifarioPersonalizado.collapsed) {
                    contentPers.classList.add('collapsed');
                } else {
                    contentPers.classList.remove('collapsed');
                }
            }
        }
        
        // === RESTAURAR "MODO COMPARA√á√ÉO" POR ABA ===
        function restaurarModoComparacaoAba(abaNum) {
            const state = abaNum === 2 ? STATE_ABA2 : STATE_ABA3;
            const modoComp = document.getElementById('modo_comparacao');
            
            if(modoComp) {
                modoComp.checked = state.modoComparacao;
            }
        }
        
        
        // === ABA 1: C√ÅLCULO AUTOM√ÅTICO ===
        function autoCalculate() {
            // Atualizar kWh
            QUICK_PARAMS.kwh = parseFloat(document.getElementById('quick-kwh').value) || 158;
            
            // Deselecionar bot√µes de pre√ßo
            document.querySelectorAll('.price-button').forEach(btn => btn.classList.remove('selected'));
            
            // Executar simula√ß√£o
            runQuickSimulation();
        }

        function selectPrice(price) {
            // Desselecionar outros
            document.querySelectorAll('.price-button').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(`price-${price}`).classList.add('selected');
            
            // Associar kWh E pot√™ncia espec√≠fica
            let kwh, power;
            if (price === 40) {
                kwh = 158;
                power = 3.45;
            } else if (price === 100) {
                kwh = 333;
                power = 6.90;
            } else if (price === 200) {
                kwh = 908;
                power = 13.80;
            }
            
            QUICK_PARAMS.kwh = kwh;
            QUICK_PARAMS.power = power;
            document.getElementById('quick-kwh').value = kwh;
            
            // Atualizar visualiza√ß√£o da pot√™ncia
            document.querySelectorAll('.power-button').forEach(btn => btn.classList.remove('selected'));
            const powerBtn = Array.from(document.querySelectorAll('.power-button')).find(btn => 
                parseFloat(btn.textContent) === power
            );
            if (powerBtn) powerBtn.classList.add('selected');
            
            runQuickSimulation();
        }

        function selectPower(power) {
            document.querySelectorAll('.power-button').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            QUICK_PARAMS.power = power;
            
            // Desselecionar bot√µes de pre√ßo quando muda pot√™ncia manualmente
            document.querySelectorAll('.price-button').forEach(btn => btn.classList.remove('selected'));
            
            runQuickSimulation();
        }

        function selectUsagePattern(pattern) {
            document.querySelectorAll('#usage-balanced, #usage-night').forEach(opt => opt.classList.remove('selected'));
            document.getElementById(`usage-${pattern}`).classList.add('selected');
            QUICK_PARAMS.usagePattern = pattern;
            
            // Auto-atualizar ciclo
            if (QUICK_PARAMS.cycle === 'simples' || QUICK_PARAMS.cycle === 'bi') {
                QUICK_PARAMS.cycle = pattern === 'balanced' ? 'simples' : 'bi';
                updateCycleButtons();
            }
            
            runQuickSimulation();
        }

        function selectTariffType(type) {
            document.querySelectorAll('#tariff-all, #tariff-fixed').forEach(opt => opt.classList.remove('selected'));
            document.getElementById(`tariff-${type}`).classList.add('selected');
            QUICK_PARAMS.tariffType = type;
            runQuickSimulation();
        }

        function selectCycle(cycle) {
            QUICK_PARAMS.cycle = cycle;
            updateCycleButtons();
            runQuickSimulation();
        }

        function updateCycleButtons() {
            document.querySelectorAll('#cycle-simples, #cycle-bi, #cycle-tri').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(`cycle-${QUICK_PARAMS.cycle}`).classList.add('selected');
        }

        function toggleQuickSettings() {
            const content = document.getElementById('quick-settings-content');
            const icon = document.getElementById('quick-settings-icon');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.className = 'fa-solid fa-chevron-up';
            } else {
                content.classList.add('hidden');
                icon.className = 'fa-solid fa-chevron-down';
            }
        }
        
        function showUpdateNotice() {
            const notice = document.createElement('div');
            notice.className = 'update-notice';
            notice.innerHTML = '<i class="fa-solid fa-check"></i> Par√¢metros atualizados';
            notice.style.display = 'flex';
            document.body.appendChild(notice);
            
            setTimeout(() => {
                notice.style.opacity = '0';
                setTimeout(() => notice.remove(), 300);
            }, 1500);
        }
        
        function runQuickSimulation() {
            // Configurar sidebar
            document.getElementById('potencia').value = QUICK_PARAMS.power;
            
            // Configurar ciclo
            const cicloSelect = document.getElementById('ciclo');
            if (QUICK_PARAMS.cycle === 'simples') {
                cicloSelect.value = 'Simples';
            } else if (QUICK_PARAMS.cycle === 'bi') {
                cicloSelect.value = 'Bi-hor√°rio - Ciclo Di√°rio';
            } else if (QUICK_PARAMS.cycle === 'tri') {
                cicloSelect.value = 'Tri-hor√°rio - Ciclo Di√°rio';
            }
            
            // Configurar consumos
            construirInputsConsumo();
            
            if (QUICK_PARAMS.cycle === 'simples') {
                document.getElementById('kwh_S').value = QUICK_PARAMS.kwh;
            } else if (QUICK_PARAMS.cycle === 'bi') {
                document.getElementById('kwh_V').value = Math.round(QUICK_PARAMS.kwh * 0.4);
                document.getElementById('kwh_F').value = Math.round(QUICK_PARAMS.kwh * 0.6);
            } else if (QUICK_PARAMS.cycle === 'tri') {
                document.getElementById('kwh_V').value = Math.round(QUICK_PARAMS.kwh * 0.4);
                document.getElementById('kwh_C').value = Math.round(QUICK_PARAMS.kwh * 0.45);
                document.getElementById('kwh_P').value = Math.round(QUICK_PARAMS.kwh * 0.15);
            }
            
            // Executar c√°lculo
            calcular();
            
            // Aguardar e mostrar p√≥dio
            setTimeout(() => {
                displayPodium();
            }, 200);
        }       
         
        function displayPodium() {
            // Verifica se existem resultados calculados
            if (!window.GLOBAL_RESULTS || window.GLOBAL_RESULTS.length === 0) {
                renderEmptyPodium();
                return;
            }
            
            // FILTRAR RESULTADOS com base nas op√ß√µes da Aba R√°pida
            let filtered = window.GLOBAL_RESULTS.filter(r => {
                // 1. Ignorar "O Meu Tarif√°rio" e "Personalizados" no p√≥dio
                if (r.tipo === 'Utilizador' || r.com === 'Personalizado') return false;

                // 2. Filtro de Tipo (Fixo vs Indexado)
                // Se o utilizador escolheu "S√≥ Pre√ßo Fixo", ignoramos Indexados
                if (QUICK_PARAMS.tariffType === 'fixed') {
                    // Verifica se o tipo inclui "Indexado"
                    if (r.tipo.toLowerCase().includes('indexado')) return false;
                }

                // 3. Filtro de Comercializadores Exclu√≠dos (Checkbox)
                // Se o nome do comercializador estiver na lista de exclu√≠dos
                if (QUICK_PARAMS.excludedProviders.some(p => r.com === p)) return false;
                
                return true;
            });
            
            // Se n√£o sobrar nada ap√≥s filtros
            if (filtered.length === 0) {
                renderEmptyPodium();
                return;
            }
            
            // Ordenar por pre√ßo (Menor para Maior)
            filtered.sort((a, b) => a.total - b.total);
            
            // Pegar no Top 3
            const top3 = filtered.slice(0, 3);
            
            // Construir HTML do P√≥dio
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            const positions = ['first', 'second', 'third']; // Classes CSS para altura/ordem
            // Array para mapear a ordem visual: 2¬∫ (Esq), 1¬∫ (Meio), 3¬∫ (Dir)
            // No grid CSS: second (order 1), first (order 2), third (order 3)
            
            let html = '';
            
            // Iterar 3 vezes (mesmo que haja menos resultados, para manter layout)
            for (let i = 0; i < 3; i++) {
                if (i < top3.length) {
                    const r = top3[i];
                    // Calcular poupan√ßa anual face ao 1¬∫ (para o 2¬∫ e 3¬∫)
                    const savings = i === 0 ? 0 : (r.total - top3[0].total);
                    
                    // Badge de Tipo
                    const isFixo = !r.tipo.toLowerCase().includes('indexado');
                    const badge = isFixo 
                        ? '<span style="font-size:0.65rem; background:#dcfce7; color:#166534; padding:2px 6px; border-radius:4px;">Fixo</span>'
                        : '<span style="font-size:0.65rem; background:#dbeafe; color:#1e40af; padding:2px 6px; border-radius:4px;">Indexado</span>';

                    html += `
                        <div class="podium-item ${positions[i]}">
                            <div class="podium-medal">${medals[i]}</div>
                            <div class="podium-name">${r.com}</div>
                            <div style="font-size:0.8rem; color:#64748b; margin-bottom:5px; height:34px; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">${r.nome}</div>
                            ${badge}
                            <div class="podium-price">${r.total.toFixed(2)}‚Ç¨<span style="font-size: 0.5em; color:#64748b; font-weight:400;">/m√™s</span></div>
                            ${i === 0 
                                ? '<div style="color: var(--success); font-size: 0.75rem; margin-top: 4px; font-weight:600;">‚úì Melhor oferta</div>' 
                                : `<div style="color: #dc2626; font-size: 0.75rem; margin-top: 4px;">+${savings.toFixed(0)}‚Ç¨ / m√™s</div>`
                            }
                        </div>
                    `;
                } else {
                    // Placeholder vazio se tivermos menos de 3 resultados
                    html += `
                        <div class="podium-item ${positions[i]}" style="opacity: 0.5; background:#f1f5f9;">
                            <div class="podium-medal" style="filter:grayscale(1);">${medals[i]}</div>
                            <div class="podium-name" style="color:#94a3b8;">---</div>
                            <div class="podium-price" style="color:#cbd5e1;">-</div>
                        </div>
                    `;
                }
            }
            
            document.getElementById('podium').innerHTML = html;
        }

        function renderEmptyPodium() {
            document.getElementById('podium').innerHTML = `
                <div class="podium-item second" style="opacity: 0.3;"><div class="podium-medal">ü•à</div><div class="podium-name">...</div><div class="podium-price">-</div></div>
                <div class="podium-item first" style="opacity: 0.3;"><div class="podium-medal">ü•á</div><div class="podium-name">...</div><div class="podium-price">-</div></div>
                <div class="podium-item third" style="opacity: 0.3;"><div class="podium-medal">ü•â</div><div class="podium-name">...</div><div class="podium-price">-</div></div>
            `;
        }

        // === POPULAR FILTROS DE COMERCIALIZADORES (ABA 1) ===
        function populateProviderFilters() {
            try {
                // 1. Verifica√ß√µes de Seguran√ßa B√°sicas
                const container = document.getElementById('provider-filters');
                
                // Se o contentor n√£o existe ou os dados (DATA) ainda n√£o carregaram, sai sem fazer nada (n√£o estraga o resto)
                if (!container) return;
                if (typeof DATA === 'undefined' || !DATA.fixos || !DATA.indexados) {
                    console.warn("Aguardando dados para filtros...");
                    return; 
                }
                
                // Se a vari√°vel global 'excludedProviders' n√£o existir, cria-a para evitar erros
                if (typeof excludedProviders === 'undefined') {
                    window.excludedProviders = [];
                }

                // 2. Preparar Dados
                // Usa arrays vazios como fallback caso algo falhe na leitura dos dados
                const fixos = DATA.fixos || [];
                const indexados = DATA.indexados || [];
                const allTariffs = fixos.concat(indexados);
                
                // Extrai comercializadores √∫nicos
                const uniqueProviders = [...new Set(allTariffs
                    .filter(t => t && t.comercializador)
                    .map(t => t.comercializador)
                )].sort();

                container.innerHTML = '';

                // 3. Renderizar cada comercializador
                uniqueProviders.forEach(provider => {
                    const label = document.createElement('label');
                    label.style.cssText = 'display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; transition: background 0.2s;';
                    
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.style.width = '14px';
                    cb.style.height = '14px';
                    cb.checked = excludedProviders.indexOf(provider) !== -1;
                    
                    cb.onchange = function() {
                        if (this.checked) {
                            if (excludedProviders.indexOf(provider) === -1) {
                                excludedProviders.push(provider);
                            }
                        } else {
                            const idx = excludedProviders.indexOf(provider);
                            if (idx > -1) {
                                excludedProviders.splice(idx, 1);
                            }
                        }
                        // Atualiza estado do bot√£o "Selecionar Todos"
                        const allBtn = document.getElementById('provider-filters_ALL');
                        if (allBtn) {
                            allBtn.checked = (uniqueProviders.length > 0 && excludedProviders.length === uniqueProviders.length);
                        }
                        calcular();
                    };
                    
                    const text = document.createElement('span');
                    text.textContent = provider;
                    
                    label.appendChild(cb);
                    label.appendChild(text);
                    
                    // Hover simples via JS para garantir compatibilidade
                    label.onmouseenter = function() { this.style.background = '#f1f5f9'; };
                    label.onmouseleave = function() { this.style.background = 'white'; };
                    
                    container.appendChild(label);
                });

                // 4. Adicionar "Selecionar Todos" (Inline e Seguro)
                const labelAll = document.createElement('label');
                // Estilo vermelho e negrito
                labelAll.style.cssText = 'display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: #fff5f5; border: 1px solid #fecaca; border-radius: 6px; font-size: 0.85rem; color: #dc2626; font-weight: bold; transition: background 0.2s;';
                
                const cbAll = document.createElement('input');
                cbAll.type = 'checkbox';
                cbAll.id = 'provider-filters_ALL';
                cbAll.style.width = '14px';
                cbAll.style.height = '14px';
                cbAll.style.accentColor = '#dc2626';
                
                // Verifica estado inicial
                cbAll.checked = (uniqueProviders.length > 0 && excludedProviders.length === uniqueProviders.length);
                
                cbAll.onchange = function() {
                    if (this.checked) {
                        // Adicionar todos (sem substituir o array, usando push um a um para seguran√ßa)
                        uniqueProviders.forEach(p => {
                            if (excludedProviders.indexOf(p) === -1) excludedProviders.push(p);
                        });
                    } else {
                        // Remover todos (esvaziando o array manualmente)
                        while(excludedProviders.length > 0) {
                            excludedProviders.pop();
                        }
                    }
                    // Re-renderizar para atualizar os vistos visuais
                    populateProviderFilters();
                    calcular();
                };
                
                const textAll = document.createElement('span');
                textAll.textContent = "Selecionar Todos";
                
                labelAll.appendChild(cbAll);
                labelAll.appendChild(textAll);
                
                labelAll.onmouseenter = function() { this.style.background = '#fee2e2'; };
                labelAll.onmouseleave = function() { this.style.background = '#fff5f5'; };

                container.appendChild(labelAll);

            } catch (error) {
                console.error("Erro ao gerar filtros:", error);
                // O try/catch impede que um erro aqui pare o resto do simulador
            }
        }
        
        function toggleProvider(provider) {
            const index = QUICK_PARAMS.excludedProviders.indexOf(provider);
            if (index > -1) {
                QUICK_PARAMS.excludedProviders.splice(index, 1);
            } else {
                QUICK_PARAMS.excludedProviders.push(provider);
            }
            runQuickSimulation();
        }

        // === SNAPSHOT: COPIAR DADOS E-REDES PARA ABA 2 ===
        function copyToSnapshotAba2() {
            if (!DADOS_EREDES) return;
            
            SNAPSHOT_ABA2 = {
                hasData: true,
                consumos: {...DADOS_EREDES.consumosAgregados},
                periodo: {...DADOS_EREDES.periodo},
                origem: 'eredes'
            };
        }

        const COLS_FIXO = {
            pot: "potencia_kva", ciclo: "opcao_horaria_e_ciclo", tipo: "tipo",
            fixo: "preco_potencia_dia",
            pS: "preco_energia_simples",
            pV_bi: "preco_energia_vazio_bi",
            pF: "preco_energia_fora_vazio",
            pV_tri: "preco_energia_vazio_tri",
            pP: "preco_energia_ponta",
            pC: "preco_energia_cheias",
            tar_e_incl: "tar_incluida_energia", tar_p_incl: "tar_incluida_potencia",
            tse_incl: "financiamento_tse_incluido", desc_fat: "desconto_fatura_mes", desc_limit: "desconto_meses_limite",
            seg: "segmento", fat: "faturacao", pag: "pagamento",
            site: "site_adesao", notas: "notas"
        };
        
        const COLS_INDEX = {
            pot: "potencia_kva", ciclo: "opcao_horaria_e_ciclo", tipo: "tipo",
            fixo: "preco_potencia_dia",
            tar_e_incl: "tar_incluida_energia", tar_p_incl: "tar_incluida_potencia",
            tse_incl: "financiamento_tse_incluido", desc_fat: "desconto_fatura_mes", desc_limit: "desconto_meses_limite",
            seg: "segmento", fat: "faturacao", pag: "pagamento",
            site: "site_adesao", notas: "notas"
        };

        // --- For√ßa leitura de datas no formato M√™s/Dia/Ano (Base de Dados) ---
        function parseDateFromDB(val) {
            if (val === undefined || val === null) return null;

            // Caso 1: O Excel devolve um n√∫mero de s√©rie (ex: 45150)
            if (typeof val === 'number') {
                const dateInfo = XLSX.SSF.parse_date_code(val);
                // Retorna YYYY-MM-DD
                return `${dateInfo.y}-${String(dateInfo.m).padStart(2, '0')}-${String(dateInfo.d).padStart(2, '0')}`;
            }

            // Caso 2: O Excel devolve texto
            let str = String(val).trim().split(' ')[0]; // Remove horas se existirem
            
            if (str.includes('/')) {
                const parts = str.split('/');
                // Se temos 3 partes (ex: 10/25/2025)
                if (parts.length === 3) {
                    // Verifica onde est√° o ano (4 d√≠gitos)
                    if (parts[2].length === 4) {
                        // Formato MM/DD/YYYY (M√™s primeiro)
                        const mes = parts[0].padStart(2,'0');
                        const dia = parts[1].padStart(2,'0');
                        const ano = parts[2];
                        return `${ano}-${mes}-${dia}`;
                    }
                    // Formato YYYY/MM/DD (Ano primeiro - fallback)
                    if (parts[0].length === 4) {
                        return `${parts[0]}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`;
                    }
                }
            }
            return null;
        }

        // --- HELPER PARA DATAS LOCAL (CORRE√á√ÉO DE FUSO HOR√ÅRIO) ---
        // Evita o uso de toISOString() que converte para UTC e causa o erro "dia anterior"
        function getYMD(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function toggleSection(id) {
            const content = document.getElementById('content-' + id);
            const icon = document.getElementById('icon-' + id);
            const isClosed = content.classList.contains('collapsed');
            
            content.classList.toggle('collapsed');
            icon.className = isClosed ? 'fa-solid fa-chevron-down' : 'fa-solid fa-chevron-right';
        }
        function toggleSidebar() {
            const panel = document.getElementById('sidebar-panel');
            const overlay = document.getElementById('sidebar-overlay');
            if(panel && overlay) {
                panel.classList.toggle('open');
                overlay.classList.toggle('active');
                document.body.style.overflow = panel.classList.contains('open') ? 'hidden' : '';
            }
        }

        
        // === FUN√á√ïES DE TOGGLE PARA NOVOS ELEMENTOS ===
        function toggleProviderFilterAba2() {
            const content = document.getElementById('content-filter-providers-aba2');
            const icon = document.getElementById('icon-filter-providers-aba2');
            content.classList.toggle('collapsed');
            icon.className = content.classList.contains('collapsed') ? 'fa-solid fa-chevron-down' : 'fa-solid fa-chevron-up';
        }
        
        function toggleProviderFilterAba3() {
            const content = document.getElementById('content-filter-providers-aba3');
            const icon = document.getElementById('icon-filter-providers-aba3');
            content.classList.toggle('collapsed');
            icon.className = content.classList.contains('collapsed') ? 'fa-solid fa-chevron-down' : 'fa-solid fa-chevron-up';
        }
        
        function toggleGraficoOmie() {
            const content = document.getElementById('grafico-omie-content');
            const icon = document.getElementById('grafico-omie-icon');
            const wasCollapsed = content.classList.contains('collapsed');
            content.classList.toggle('collapsed');
            icon.className = content.classList.contains('collapsed') ? 'fa-solid fa-chevron-down' : 'fa-solid fa-chevron-up';
            
            // Gerar/regenerar gr√°fico quando expandir
            if(wasCollapsed) {
                gerarGraficoOMIEDiario();
            }
        }
        
        function toggleGraficosAnalise() {
            const content = document.getElementById('graficos-analise-content');
            const icon = document.getElementById('graficos-analise-icon');
            const wasCollapsed = content.classList.contains('collapsed');
            content.classList.toggle('collapsed');
            icon.className = content.classList.contains('collapsed') ? 'fa-solid fa-chevron-down' : 'fa-solid fa-chevron-up';
            
            // Gerar/regenerar gr√°ficos quando expandir
            if(wasCollapsed && DADOS_EREDES) {
                gerarGraficosAnaliseERedes();
            }
        }
        
        function toggleAnalisePotencia() {
            const content = document.getElementById('analise-potencia-content');
            const icon = document.getElementById('analise-potencia-icon');
            content.classList.toggle('collapsed');
            icon.className = content.classList.contains('collapsed') ? 'fa-solid fa-chevron-down' : 'fa-solid fa-chevron-up';
        }
        
        // === POPULAR FILTROS DE COMERCIALIZADORES PARA ABAS 2 E 3 ===
        function populateProviderFiltersAbas() {
            // Obter lista √∫nica de comercializadores
            const providers = new Set();
            DATA.fixos.forEach(t => { if(t.comercializador) providers.add(t.comercializador); });
            DATA.indexados.forEach(t => { if(t.comercializador) providers.add(t.comercializador); });
            
            // Ordenar alfabeticamente
            const uniqueProviders = Array.from(providers).sort();
            
            // Fun√ß√£o auxiliar interna para renderizar a lista
            const renderList = (containerId, stateObj, tabName) => {
                const container = document.getElementById(containerId);
                if(!container) return;
                
                container.innerHTML = '';
                
                // 1. Renderizar cada comercializador individualmente
                uniqueProviders.forEach(provider => {
                    const label = document.createElement('label');
                    label.style.cssText = 'display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; transition: background 0.2s;';
                    
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.style.width = '14px';
                    cb.style.height = '14px';
                    cb.checked = stateObj.excludedProviders.includes(provider);
                    
                    cb.onchange = () => {
                        if(cb.checked) {
                            if(!stateObj.excludedProviders.includes(provider)) stateObj.excludedProviders.push(provider);
                        } else {
                            stateObj.excludedProviders = stateObj.excludedProviders.filter(p => p !== provider);
                        }
                        
                        // Atualizar visualmente o bot√£o "Selecionar Todos" sem re-renderizar tudo
                        const allBtn = document.getElementById(containerId + '_ALL');
                        if(allBtn) allBtn.checked = (stateObj.excludedProviders.length === uniqueProviders.length);
                        
                        if(CURRENT_TAB === tabName) calcular();
                    };
                    
                    const text = document.createElement('span');
                    text.textContent = provider;
                    
                    label.appendChild(cb);
                    label.appendChild(text);
                    
                    // Efeito hover
                    label.onmouseover = () => label.style.background = '#f1f5f9';
                    label.onmouseout = () => label.style.background = 'white';
                    
                    container.appendChild(label);
                });
                
                // 2. Adicionar Op√ß√£o "Selecionar Todos" (Como se fosse o pr√≥ximo item da lista)
                const labelAll = document.createElement('label');
                // Estilo destacado: Borda vermelha suave, fundo avermelhado muito claro, texto vermelho e negrito
                labelAll.style.cssText = 'display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: #fff5f5; border: 1px solid #fecaca; border-radius: 6px; font-size: 0.85rem; color: #dc2626; font-weight: bold; transition: background 0.2s;';
                
                const cbAll = document.createElement('input');
                cbAll.type = 'checkbox';
                cbAll.id = containerId + '_ALL';
                cbAll.style.width = '14px';
                cbAll.style.height = '14px';
                cbAll.style.accentColor = '#dc2626'; // Checkbox vermelha
                
                // Estado inicial
                cbAll.checked = (uniqueProviders.length > 0 && stateObj.excludedProviders.length === uniqueProviders.length);
                
                cbAll.onchange = () => {
                    if(cbAll.checked) {
                        stateObj.excludedProviders = [...uniqueProviders];
                    } else {
                        stateObj.excludedProviders = [];
                    }
                    // Re-renderizar a lista para atualizar todas as checkboxes
                    renderList(containerId, stateObj, tabName);
                    
                    if(CURRENT_TAB === tabName) calcular();
                };
                
                const textAll = document.createElement('span');
                textAll.textContent = "Selecionar Todos";
                
                labelAll.appendChild(cbAll);
                labelAll.appendChild(textAll);
                
                // Hover espec√≠fico para o bot√£o vermelho
                labelAll.onmouseover = () => labelAll.style.background = '#fee2e2';
                labelAll.onmouseout = () => labelAll.style.background = '#fff5f5';

                container.appendChild(labelAll);
            };
            
            // Renderizar lista da Aba 2 (Simula√ß√£o Completa)
            renderList('provider-filters-aba2', STATE_ABA2, 'complete');
            
            // Renderizar lista da Aba 3 (An√°lise Avan√ßada)
            renderList('provider-filters-aba3', STATE_ABA3, 'advanced');
        }

        function toggleProviderAba2(provider) {
            const index = STATE_ABA2.excludedProviders.indexOf(provider);
            if(index > -1) {
                STATE_ABA2.excludedProviders.splice(index, 1);
            } else {
                STATE_ABA2.excludedProviders.push(provider);
            }
            if(CURRENT_TAB === 'complete') calcular();
        }
        
        function toggleProviderAba3(provider) {
            const index = STATE_ABA3.excludedProviders.indexOf(provider);
            if(index > -1) {
                STATE_ABA3.excludedProviders.splice(index, 1);
            } else {
                STATE_ABA3.excludedProviders.push(provider);
            }
            if(CURRENT_TAB === 'advanced') calcular();
        }
        
        // === PROCESSAR FICHEIROS E-REDES DA √ÅREA CENTRAL ===
        async function processarFicheirosERedesCentral() {
            const fileInput = document.getElementById('file-eredes-central');
            const status = document.getElementById('eredes-status-central');
            
            if(!fileInput.files || fileInput.files.length === 0) {
                status.innerHTML = '<span style="color:red;">‚ö†Ô∏è Selecione pelo menos um ficheiro Excel</span>';
                return;
            }
            
            status.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> A processar ficheiros...';
            
            try {
                const ficheirosProcessados = [];
                for(let i = 0; i < fileInput.files.length; i++) {
                    const file = fileInput.files[i];
                    status.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> A processar ${file.name} (${i+1}/${fileInput.files.length})...`;
                    
                    const resultado = await processarFicheiroERedes(file);
                    if(resultado.erro) {
                        status.innerHTML = `<span style="color:red;">‚ùå Erro: ${resultado.erro}</span>`;
                        return;
                    }
                    ficheirosProcessados.push(resultado.dados);
                }
                
                const resultado = validarEJuntarFicheiros(ficheirosProcessados);
                if(resultado.erro) {
                    status.innerHTML = `<span style="color:red;">‚ùå ${resultado.erro}</span>`;
                    return;
                }
                
                const consumosAgregados = agregarConsumosPorPeriodo(resultado.dados);
                const mediasOMIE = calcularMediasOMIE(resultado.dados);
                
                const primeiroRegisto = resultado.dados[0];
                const ultimoRegisto = resultado.dados[resultado.dados.length - 1];
                
                const dataInicioStr = primeiroRegisto.DataHora.split('T')[0];
                const dataFimStr = ultimoRegisto.DataHora.split('T')[0];
                
                const d1 = new Date(dataInicioStr);
                const d2 = new Date(dataFimStr);
                const dias = Math.floor((d2 - d1) / 86400000) + 1;
                
                let msg = resultado.avisoAntigos ? '‚ö†Ô∏è Dados anteriores a 2025 foram descartados (sem dados OMIE)' : '';
                
                // Guardar dados globais
                DADOS_EREDES = {
                    dadosBrutos: resultado.dados,
                    consumosAgregados: consumosAgregados,
                    mediasOMIE: mediasOMIE,
                    periodo: { inicio: dataInicioStr, fim: dataFimStr, dias: dias }
                };
                
                // Marcar como processado na Aba 3
                STATE_ABA3.ficheiroProcessado = true;
                STATE_ABA3.dataInicio = dataInicioStr;
                STATE_ABA3.dataFim = dataFimStr;
                STATE_ABA3.dadosERedes = DADOS_EREDES;
                
                // Calcular pot√™ncia m√°xima para an√°lise
                calcularPotenciaMaxima();
                
                // Esconder √°rea central e mostrar interface completa
                document.getElementById('eredes-upload-central').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                
                // Configurar interface da Aba 3
                switchTab('advanced');
                
                // Aplicar dados aos inputs
                aplicarDadosERedes();
                
                // Mostrar √°rea de resumo na sidebar
                document.getElementById('eredes-upload').style.display = 'none';
                document.getElementById('eredes-limpar').style.display = 'block';
                
                const fmtData = (s) => s.split('-').reverse().join('/');
                document.getElementById('eredes-resumo').innerHTML = `
                    <b>${fileInput.files.length} ficheiro(s):</b> ${fmtData(dataInicioStr)} a ${fmtData(dataFimStr)} (${dias} dias)
                    ${msg ? `<br><span style="color:#d97706;">${msg}</span>` : ''}
                `;
                
                // Gerar tabela de an√°lise
                mostrarTabelaAnaliseERedes();
                
                calcular();
                
            } catch(error) {
                console.error('Erro ao processar ficheiros:', error);
                status.innerHTML = `<span style="color:red;">‚ùå Erro: ${error.message}</span>`;
            }
        }
        
        // === CALCULAR POT√äNCIA M√ÅXIMA ===
        function calcularPotenciaMaxima() {
            if(!DADOS_EREDES || !DADOS_EREDES.dadosBrutos) return;
            
            let potenciaMax = 0;
            DADOS_EREDES.dadosBrutos.forEach(r => {
                if(r.Potencia_kW && r.Potencia_kW > potenciaMax) {
                    potenciaMax = r.Potencia_kW;
                }
            });
            
            DADOS_EREDES.potenciaMaxima = potenciaMax;
        }
        
        // === ATUALIZAR AN√ÅLISE DE POT√äNCIA ===
        function atualizarAnalisePotencia() {
            if(!DADOS_EREDES || !DADOS_EREDES.potenciaMaxima) return;
            
            const potContratada = parseFloat(document.getElementById('potencia').value) || 3.45;
            let potMaxima = DADOS_EREDES.potenciaMaxima;
            const isTrifasico = document.getElementById('chk-trifasico')?.checked || false;
            
            // Para trif√°sico, o valor registado j√° √© a soma das 3 fases
            // mas a nota informativa muda
            let notaTrifasico = '';
            if(isTrifasico) {
                notaTrifasico = ' (trif√°sico)';
            }
            
            const percentagem = potContratada > 0 ? (potMaxima / potContratada) * 100 : 0;
            
            // Atualizar displays
            document.getElementById('potencia-contratada-display').textContent = `${potContratada} kVA`;
            document.getElementById('potencia-maxima-display').innerHTML = `${potMaxima.toFixed(3)} kW<span style="font-size: 0.75rem; color: #94a3b8;">${notaTrifasico}</span>`;
            document.getElementById('potencia-utilizacao-display').textContent = `${percentagem.toFixed(1)} %`;
            
            // Gerar recomenda√ß√£o
            let recomendacao = '';
            let corFundo = '#f1f5f9';
            
            if(percentagem > 100) {
                recomendacao = `üî¥ <strong>Aten√ß√£o:</strong> A sua Pot√™ncia M√°xima Registada (${potMaxima.toFixed(2)} kW) ultrapassa a sua pot√™ncia contratada. Considere aumentar a pot√™ncia.`;
                corFundo = '#fef2f2';
            } else if(percentagem > 85) {
                recomendacao = `‚úÖ <strong>Adequado:</strong> A sua pot√™ncia contratada parece bem dimensionada.`;
                corFundo = '#f0fdf4';
            } else if(percentagem > 60) {
                recomendacao = `üí° <strong>Oportunidade de Poupan√ßa:</strong> A sua Pot√™ncia M√°xima Registada utiliza entre 60% e 85% da pot√™ncia contratada. Pode ser poss√≠vel reduzir a pot√™ncia.`;
                corFundo = '#fffbeb';
            } else {
                recomendacao = `üí∞ <strong>Forte Oportunidade de Poupan√ßa:</strong> A sua Pot√™ncia M√°xima Registada utiliza menos de 60% da sua pot√™ncia contratada. √â muito prov√°vel que possa reduzir a pot√™ncia e poupar na fatura.`;
                corFundo = '#fef3c7';
            }
            
            document.getElementById('potencia-recomendacao').style.background = corFundo;
            document.getElementById('potencia-recomendacao').innerHTML = recomendacao;
        }
        
        // === GERAR GR√ÅFICO OMIE DI√ÅRIO (ABA 2) (SPOT vs FUTURO) ===
        function gerarGraficoOMIEDiario() {
            const d1Str = document.getElementById('d_inicio').value;
            const d2Str = document.getElementById('d_fim').value;
            const ciclo = document.getElementById('ciclo').value;
            
            if(!DATA.omie || DATA.omie.length === 0) return;
            
            // 1. Obter Data de Corte do Excel e zerar horas para compara√ß√£o segura
            let dataCorte = getDataReferencia('Data_Valores_OMIE');
            if (!dataCorte) {
                dataCorte = new Date();
                dataCorte.setHours(0,0,0,0);
            } else {
                dataCorte.setHours(0,0,0,0);
            }

            // 2. Cores Oficiais do Python
            const pythonColors = {
                S: '#FF0000', // Vermelho
                V: '#000000', // Preto
                F: '#FFC000', // Amarelo/Laranja
                C: '#2F5597', // Azul Escuro
                P: '#00B050'  // Verde
            };

            // 3. S√≠mbolos (markers) para cada per√≠odo
            const pythonMarkers = {
                S: 'circle',
                V: 'diamond',
                F: 'square',
                C: 'triangle',
                P: 'triangle-down'
            };

            // Determinar ciclo e per√≠odos
            let colCiclo = "Simp";
            let periodos = ['S'];
            let periodLabels = { S: 'Simples' };
            
            if(ciclo.includes("Bi")) {
                colCiclo = ciclo.includes("Di√°rio") ? "BD" : "BS";
                periodos = ['V', 'F'];
                periodLabels = { V: 'Vazio', F: 'Fora Vazio' };
            } else if(ciclo.includes("Tri")) {
                colCiclo = ciclo.includes("Di√°rio") ? "TD" : "TS";
                periodos = ['V', 'C', 'P'];
                periodLabels = { V: 'Vazio', C: 'Cheias', P: 'Ponta' };
            }
            
            // Agrupar dados
            const dadosPorDia = {};
            
            DATA.omie.forEach(row => {
                const rowDateStr = parseDateFromDB(row['Data']);
                if(!rowDateStr || rowDateStr < d1Str || rowDateStr > d2Str) return;
                
                const omieVal = parseFloat(String(row['OMIE']).replace(',', '.')) || 0;
                
                if(!dadosPorDia[rowDateStr]) {
                    dadosPorDia[rowDateStr] = { S: { sum: 0, count: 0 } };
                    periodos.forEach(p => { dadosPorDia[rowDateStr][p] = { sum: 0, count: 0 }; });
                }
                
                dadosPorDia[rowDateStr].S.sum += omieVal;
                dadosPorDia[rowDateStr].S.count++;
                
                if(colCiclo !== "Simp") {
                    const periodo = row[colCiclo];
                    if(periodo && dadosPorDia[rowDateStr][periodo]) {
                        dadosPorDia[rowDateStr][periodo].sum += omieVal;
                        dadosPorDia[rowDateStr][periodo].count++;
                    }
                }
            });
            
            const datasOrdenadas = Object.keys(dadosPorDia).sort();
            const categorias = datasOrdenadas.map(d => d.split('-').reverse().slice(0, 2).join('/'));
            
            let series = [];
            const periodsToRender = (colCiclo === "Simp") ? ['S'] : periodos;

            periodsToRender.forEach(p => {
                const dataReal = [];
                const dataPrevisto = [];
                
                datasOrdenadas.forEach(d => {
                    const dataPonto = new Date(d);
                    dataPonto.setHours(0,0,0,0);
                    
                    const dataInfo = dadosPorDia[d][p];
                    const valor = (dataInfo && dataInfo.count > 0) ? Math.round(dataInfo.sum / dataInfo.count * 100) / 100 : null;
                    
                    // Separa√ß√£o Spot vs Futuros
                    if (dataPonto <= dataCorte) {
                        dataReal.push(valor);
                        dataPrevisto.push(null);
                    } else {
                        dataReal.push(null);
                        dataPrevisto.push(valor);
                    }
                });

                const corSerie = pythonColors[p] || '#333';
                const markerSerie = pythonMarkers[p] || 'circle';

                // S√©rie REAL (Spot) - S√≥lida com marcadores
                series.push({
                    name: periodLabels[p] + ' Spot', 
                    data: dataReal,
                    color: corSerie,
                    type: 'line',
                    lineWidth: 2,
                    marker: { 
                        enabled: true,
                        symbol: markerSerie,
                        radius: 4,
                        lineWidth: 1,
                        lineColor: corSerie,
                        fillColor: corSerie
                    },
                    connectNulls: false
                });

                // S√©rie PREVISTA (Futuros) - Tracejada com marcadores vazios
                series.push({
                    name: periodLabels[p] + ' Futuros',
                    data: dataPrevisto,
                    color: corSerie,
                    dashStyle: 'Dot',
                    type: 'line',
                    lineWidth: 2,
                    marker: { 
                        enabled: true,
                        symbol: markerSerie,
                        radius: 4,
                        lineWidth: 2,
                        lineColor: corSerie,
                        fillColor: 'white'  // Marcadores vazios para Futuros
                    },
                    connectNulls: false,
                    showInLegend: true
                });
            });
            
            if(typeof Highcharts !== 'undefined') {
                Highcharts.chart('chart-omie-diario', {
                    chart: { 
                        zoomType: 'x',
                        height: 350
                    },
                    title: { 
                        text: `Evolu√ß√£o Di√°ria OMIE/OMIP - ${ciclo}`,
                        align: 'center'
                    },
                    subtitle: { 
                        text: 'Linha cont√≠nua: Spot (OMIE) | Linha tracejada: Futuros (OMIP)', 
                        align: 'center', 
                        style: { fontSize: '0.85rem', color: '#666' } 
                    },
                    xAxis: { 
                        categories: categorias, 
                        crosshair: true 
                    },
                    yAxis: { 
                        title: { text: 'Pre√ßo M√©dio (‚Ç¨/MWh)' },
                        plotLines: [{
                            value: 0,
                            width: 1,
                            color: '#cccccc'
                        }]
                    },
                    legend: { 
                        enabled: true,
                        layout: 'horizontal',
                        align: 'center',
                        verticalAlign: 'bottom',
                        symbolRadius: 0  // Mant√©m os s√≠mbolos quadrados/losangos na legenda
                    },
                    tooltip: { 
                        shared: true,
                        valueSuffix: ' ‚Ç¨/MWh',
                        crosshairs: true
                    },
                    plotOptions: { 
                        line: { 
                            connectNulls: false,
                            states: {
                                hover: {
                                    lineWidthPlus: 0
                                }
                            }
                        } 
                    },
                    series: series
                });
            }
        }

        // === GERAR GR√ÅFICOS DE AN√ÅLISE E-REDES (ABA 3) ===
        // Helper: Obter informa√ß√£o de ciclo hor√°rio (cores, per√≠odos, nomes) de acordo com o Python
        function getCicloInfo(ciclo) {
            const ohLower = ciclo.toLowerCase();
            const nomesPeriodos = { V: 'Vazio', F: 'Fora Vazio', C: 'Cheias', P: 'Ponta' };
            const coresDiario = { V_bi: '#A9D18E', V_tri: '#BF9000', F: '#E2EFDA', C: '#FFE699', P: '#FFF2CC' };
            const coresSemanal = { V_bi: '#8FAADC', V_tri: '#C55A11', F: '#DAE3F3', C: '#F4B183', P: '#FBE5D6' };
            const coresOmie = { S: '#FF0000', V: '#000000', F: '#FFC000', C: '#2F5597', P: '#00B050' };
            
            let colCiclo = null, periodos = [], tituloCiclo = 'Simples', isDiario = true;
            
            if(ohLower.includes('bi')) {
                isDiario = ohLower.includes('di√°rio');
                colCiclo = isDiario ? 'BD' : 'BS';
                periodos = ['V', 'F'];
                tituloCiclo = isDiario ? 'Bi-Hor√°rio - Ciclo Di√°rio' : 'Bi-Hor√°rio - Ciclo Semanal';
            } else if(ohLower.includes('tri')) {
                isDiario = ohLower.includes('di√°rio');
                colCiclo = isDiario ? 'TD' : 'TS';
                periodos = ['V', 'C', 'P'];
                tituloCiclo = isDiario ? 'Tri-Hor√°rio - Ciclo Di√°rio' : 'Tri-Hor√°rio - Ciclo Semanal';
            }
            
            const coresConsumo = isDiario ? coresDiario : coresSemanal;
            
            return { colCiclo, periodos, tituloCiclo, nomesPeriodos, coresConsumo, coresOmie, isDiario, ohLower };
        }
        
        // Classificar per√≠odo hor√°rio de um timestamp
        function classificarPeriodo(ts, colCiclo) {
            if(!colCiclo || !DATA.omieMap) return null;
            const y = ts.getFullYear(), m = String(ts.getMonth()+1).padStart(2,'0'), d = String(ts.getDate()).padStart(2,'0');
            const hh = String(ts.getHours()).padStart(2,'0'), mm = String(ts.getMinutes()).padStart(2,'0');
            let omieRow = DATA.omieMap.get(`${y}-${m}-${d}_${hh}:${mm}`);
            if(!omieRow && mm !== '00') omieRow = DATA.omieMap.get(`${y}-${m}-${d}_${hh}:00`);
            if(omieRow && omieRow[colCiclo]) return omieRow[colCiclo];
            return null;
        }
        
        function gerarGraficosAnaliseERedes() {
            if(!DADOS_EREDES || !DADOS_EREDES.dadosBrutos) return;
            
            const ciclo = document.getElementById('ciclo').value;
            const d1Str = document.getElementById('d_inicio').value;
            const d2Str = document.getElementById('d_fim').value;
            
            // Preparar dados filtrados
            const dadosFiltrados = DADOS_EREDES.dadosBrutos.filter(r => {
                const dataStr = r.DataHora.split('T')[0];
                return dataStr >= d1Str && dataStr <= d2Str;
            });
            
            if(dadosFiltrados.length === 0) return;
            
            // Gerar gr√°ficos com base no ciclo selecionado
            gerarGraficoHorario(dadosFiltrados, ciclo);
            gerarGraficoDiario(dadosFiltrados, ciclo);
            gerarGraficoSemana(dadosFiltrados, ciclo);
            gerarGraficoMensal(dadosFiltrados, ciclo);
        }
        
        function gerarGraficoHorario(dados, ciclo) {
            const info = getCicloInfo(ciclo);
            
            // Inicializar as 24 horas (0 a 23)
            const porHora = {};
            for(let h = 0; h < 24; h++) {
                porHora[h] = { consumo: 0, omieSum: 0, omieCount: 0 };
                if(info.colCiclo) {
                    info.periodos.forEach(p => {
                        porHora[h][p] = { consumo: 0, omieSum: 0, omieCount: 0 };
                    });
                }
            }
            
            dados.forEach(r => {
                const ts = new Date(r.DataHora);
                let horaBucket = ts.getHours();
                const minutos = ts.getMinutes();

                // === AGRUPAMENTO ===
                // Se for hora cheia (ex: 10:00), pertence ao intervalo anterior (09:00-10:00)
                // Logo, colocamos no bucket 9.
                if (minutos === 0) {
                    horaBucket = horaBucket - 1;
                }

                // Se era 00:00, subtra√≠mos 1 e ficou -1. Devemos passar para 23.
                // (Isto representa o consumo das 23:00 √†s 00:00)
                if (horaBucket < 0) {
                    horaBucket = 23; 
                }

                const consumo = r['Consumo (kWh)'];
                porHora[horaBucket].consumo += consumo;
                
                // === LOOKUP OMIE (Baseado na Hora Original) ===
                // A hora original (ts) est√° correta para procurar no mapa OMIE.
                // Ex: Registo 10:00 procura chave "...10:00"
                // Ex: Registo 00:00 procura chave "...00:00" (ou 23:59 dependendo do ficheiro)
                
                const y = ts.getFullYear();
                const m = String(ts.getMonth()+1).padStart(2,'0');
                const d = String(ts.getDate()).padStart(2,'0');
                const hh = String(ts.getHours()).padStart(2, '0');
                const mm = String(ts.getMinutes()).padStart(2, '0');
                
                let key = `${y}-${m}-${d}_${hh}:${mm}`;
                let omieRow = DATA.omieMap?.get(key);

                // Fallback espec√≠fico para a meia-noite se o ficheiro OMIE usar 23:59
                if (!omieRow && hh === '00' && mm === '00') {
                    // Tenta buscar o dia anterior √†s 23:59
                    const tsAnt = new Date(ts);
                    tsAnt.setMinutes(tsAnt.getMinutes() - 1); // 23:59 do dia anterior
                    const yA = tsAnt.getFullYear();
                    const mA = String(tsAnt.getMonth()+1).padStart(2,'0');
                    const dA = String(tsAnt.getDate()).padStart(2,'0');
                    const keyAnt = `${yA}-${mA}-${dA}_23:59`;
                    omieRow = DATA.omieMap?.get(keyAnt);
                }

                const omie = omieRow ? (parseFloat(String(omieRow.OMIE).replace(',', '.')) || 0) : 0;
                
                // Adicionar valores ao bucket calculado
                if(omieRow) { 
                    porHora[horaBucket].omieSum += omie; 
                    porHora[horaBucket].omieCount++; 
                }
                
                if(info.colCiclo && omieRow) {
                    const periodo = omieRow[info.colCiclo];
                    if(periodo && porHora[horaBucket][periodo]) {
                        porHora[horaBucket][periodo].consumo += consumo;
                        porHora[horaBucket][periodo].omieSum += omie;
                        porHora[horaBucket][periodo].omieCount++;
                    }
                }
            });
            
            const categorias = Array.from({length: 24}, (_, i) => `${i}h-${i+1}h`);
            const series = [];
            
            if(info.colCiclo) {
                [...info.periodos].reverse().forEach(p => {
                    const corKey = p === 'V' && info.ohLower.startsWith('tri') ? 'V_tri' : (p === 'V' ? 'V_bi' : p);
                    const data = Object.values(porHora).map(v => {
                        const total = v[p] ? Math.round(v[p].consumo * 100) / 100 : 0;
                        // C√°lculo da m√©dia corrigido (por n√∫mero de dias reais)
                        const nDias = v[p] && v[p].omieCount > 0 ? v[p].omieCount : 1; 
                        return { y: total, media: Math.round(total / nDias * 100) / 100 };
                    });
                    series.push({
                        name: `Consumo ${info.nomesPeriodos[p]} (kWh)`, type: 'column',
                        data: data, yAxis: 0, color: info.coresConsumo[corKey]
                    });
                });
            } else {
                // Estimar nDias baseando no total de dados se n√£o houver ciclo
                const nDias = dados.length > 0 ? new Set(dados.map(r => r.DataHora.split('T')[0])).size : 1;
                
                const data = Object.values(porHora).map(v => ({
                    y: Math.round(v.consumo * 100) / 100,
                    media: Math.round(v.consumo / Math.max(nDias, 1) * 100) / 100
                }));
                series.push({ name: 'Consumo Total (kWh)', type: 'column', data: data, yAxis: 0, color: '#BFBFBF' });
            }
            
            series.push({
                name: 'M√©dia OMIE (‚Ç¨/MWh)', type: 'line',
                data: Object.values(porHora).map(v => v.omieCount > 0 ? Math.round(v.omieSum / v.omieCount * 100) / 100 : null),
                yAxis: 1, color: info.coresOmie.S, tooltip: { valueSuffix: ' ‚Ç¨/MWh' }
            });
            
            if(info.colCiclo) {
                info.periodos.forEach(p => {
                    series.push({
                        name: `M√©dia OMIE ${info.nomesPeriodos[p]} (‚Ç¨/MWh)`, type: 'line',
                        data: Object.values(porHora).map(v => v[p] && v[p].omieCount > 0 ? Math.round(v[p].omieSum / v[p].omieCount * 100) / 100 : null),
                        yAxis: 1, color: info.coresOmie[p], visible: false, tooltip: { valueSuffix: ' ‚Ç¨/MWh' }
                    });
                });
            }
            
            if(typeof Highcharts !== 'undefined') {
                Highcharts.chart('chart-horario', {
                    chart: { zoomType: 'xy' },
                    title: { text: `Consumo e Pre√ßo M√©dio OMIE por Hora (${info.tituloCiclo})`, align: 'left' },
                    xAxis: [{ categories: categorias, crosshair: true }],
                    yAxis: [
                        { labels: { format: '{value} kWh' }, title: { text: 'Consumo (kWh)' } },
                        { title: { text: 'Pre√ßo OMIE (‚Ç¨/MWh)' }, labels: { format: '{value} ‚Ç¨/MWh' }, opposite: true }
                    ],
                    legend: { align: 'left', verticalAlign: 'top', y: 40, floating: true, backgroundColor: 'white' },
                    plotOptions: { column: { stacking: 'normal' } },
                    tooltip: {
                        shared: true,
                        formatter: function() {
                            let s = '<b>' + this.x + '</b>';
                            let isStacked = false;
                            this.points.forEach(function(point) {
                                if(point.y > 0) {
                                    s += '<br/>' + point.series.name + ': <b>' + point.y.toFixed(2) + '</b>';
                                    if(typeof point.point.options.media !== 'undefined') {
                                        s += ' <span style="font-size:0.9em">(M√©dia: ' + point.point.options.media.toFixed(2) + ')</span>';
                                    }
                                }
                                if(point.series.type === 'column' && point.series.options.stacking === 'normal') isStacked = true;
                            });
                            if(isStacked && typeof this.total !== 'undefined' && this.total > 0) {
                                s += '<br/>--------------------';
                                s += '<br/><b>Total Consumo: ' + this.total.toFixed(2) + ' kWh</b>';
                            }
                            return s;
                        }
                    },
                    series: series
                });
            }
        }        
        function gerarGraficoDiario(dados, ciclo) {
            const info = getCicloInfo(ciclo);
            
            // Agregar por dia
            const porDia = {};
            
            dados.forEach(r => {
                const dataStr = r.DataHora.split('T')[0];
                if(!porDia[dataStr]) {
                    porDia[dataStr] = { consumo: 0, omieSum: 0, omieCount: 0 };
                    if(info.colCiclo) info.periodos.forEach(p => { porDia[dataStr][p] = { consumo: 0, omieSum: 0, omieCount: 0 }; });
                }
                
                const consumo = r['Consumo (kWh)'];
                porDia[dataStr].consumo += consumo;
                
                // OMIE
                const ts = new Date(r.DataHora);
                const hh = String(ts.getHours()).padStart(2, '0');
                const mm = String(ts.getMinutes()).padStart(2, '0');
                const omieRow = DATA.omieMap?.get(`${dataStr}_${hh}:${mm}`) || DATA.omieMap?.get(`${dataStr}_${hh}:00`);
                if(omieRow) {
                    const omie = parseFloat(String(omieRow.OMIE).replace(',', '.')) || 0;
                    porDia[dataStr].omieSum += omie;
                    porDia[dataStr].omieCount++;
                    
                    if(info.colCiclo) {
                        const periodo = omieRow[info.colCiclo];
                        if(periodo && porDia[dataStr][periodo]) {
                            porDia[dataStr][periodo].consumo += consumo;
                            porDia[dataStr][periodo].omieSum += omie;
                            porDia[dataStr][periodo].omieCount++;
                        }
                    }
                }
            });
            
            const datasOrdenadas = Object.keys(porDia).sort();
            const categorias = datasOrdenadas.map(d => d.split('-').reverse().slice(0, 2).join('/'));
            const series = [];
            
            if(info.colCiclo) {
                [...info.periodos].reverse().forEach(p => {
                    const corKey = p === 'V' && info.ohLower.startsWith('tri') ? 'V_tri' : (p === 'V' ? 'V_bi' : p);
                    const data = datasOrdenadas.map(d => {
                        const total = porDia[d][p] ? Math.round(porDia[d][p].consumo * 100) / 100 : 0;
                        return { y: total, media: total };
                    });
                    series.push({
                        name: `Consumo ${info.nomesPeriodos[p]} (kWh)`, type: 'column',
                        data: data, yAxis: 0, color: info.coresConsumo[corKey]
                    });
                });
            } else {
                series.push({
                    name: 'Consumo Total (kWh)', type: 'column',
                    data: datasOrdenadas.map(d => ({
                        y: Math.round(porDia[d].consumo * 100) / 100,
                        media: Math.round(porDia[d].consumo * 100) / 100
                    })),
                    yAxis: 0, color: '#BFBFBF'
                });
            }
            
            // Linha OMIE simples
            series.push({
                name: 'M√©dia OMIE (‚Ç¨/MWh)', type: 'line',
                data: datasOrdenadas.map(d => porDia[d].omieCount > 0 ? Math.round(porDia[d].omieSum / porDia[d].omieCount * 100) / 100 : null),
                yAxis: 1, color: info.coresOmie.S, tooltip: { valueSuffix: ' ‚Ç¨/MWh' }
            });
            
            // Linhas OMIE por per√≠odo (escondidas)
            if(info.colCiclo) {
                info.periodos.forEach(p => {
                    series.push({
                        name: `M√©dia OMIE ${info.nomesPeriodos[p]} (‚Ç¨/MWh)`, type: 'line',
                        data: datasOrdenadas.map(d => porDia[d][p] && porDia[d][p].omieCount > 0 ? Math.round(porDia[d][p].omieSum / porDia[d][p].omieCount * 100) / 100 : null),
                        yAxis: 1, color: info.coresOmie[p], visible: false, tooltip: { valueSuffix: ' ‚Ç¨/MWh' }
                    });
                });
            }
            
            if(typeof Highcharts !== 'undefined') {
                Highcharts.chart('chart-diario', {
                    chart: { zoomType: 'xy' },
                    title: { text: `Consumo e Pre√ßo M√©dio OMIE Di√°rio (${info.tituloCiclo})`, align: 'left' },
                    xAxis: [{ categories: categorias, crosshair: true }],
                    yAxis: [
                        { labels: { format: '{value} kWh' }, title: { text: 'Consumo (kWh)' } },
                        { title: { text: 'M√©dia OMIE (‚Ç¨/MWh)' }, labels: { format: '{value} ‚Ç¨/MWh' }, opposite: true }
                    ],
                    legend: { align: 'left', verticalAlign: 'top', y: 40, floating: true, backgroundColor: 'white' },
                    plotOptions: { column: { stacking: 'normal' } },
                    tooltip: {
                        shared: true,
                        formatter: function() {
                            let s = '<b>' + this.x + '</b>';
                            let isStacked = false;
                            this.points.forEach(function(point) {
                                if(point.y > 0) {
                                    s += '<br/>' + point.series.name + ': <b>' + point.y.toFixed(2) + '</b>';
                                    if(typeof point.point.options.media !== 'undefined') {
                                        s += ' <span style="font-size:0.9em">(M√©dia: ' + point.point.options.media.toFixed(2) + ')</span>';
                                    }
                                }
                                if(point.series.type === 'column' && point.series.options.stacking === 'normal') isStacked = true;
                            });
                            if(isStacked && typeof this.total !== 'undefined' && this.total > 0) {
                                s += '<br/>--------------------';
                                s += '<br/><b>Total Consumo: ' + this.total.toFixed(2) + ' kWh</b>';
                            }
                            return s;
                        }
                    },
                    series: series
                });
            }
        }
        
        function gerarGraficoSemana(dados, ciclo) {
            const info = getCicloInfo(ciclo);
            
            // Agregar por dia da semana (0=Segunda..6=Domingo)
            const porDiaSemana = {};
            for(let d = 0; d < 7; d++) {
                porDiaSemana[d] = { consumo: 0, omieSum: 0, omieCount: 0, dias: new Set() };
                if(info.colCiclo) info.periodos.forEach(p => { porDiaSemana[d][p] = { consumo: 0, omieSum: 0, omieCount: 0 }; });
            }
            
            dados.forEach(r => {
                const ts = new Date(r.DataHora);
                const diaSemana = ts.getDay();
                const ajustado = (diaSemana + 6) % 7; // 0=Segunda
                const dataStr = r.DataHora.split('T')[0];
                const consumo = r['Consumo (kWh)'];
                
                porDiaSemana[ajustado].consumo += consumo;
                porDiaSemana[ajustado].dias.add(dataStr);
                
                // OMIE
                const hh = String(ts.getHours()).padStart(2, '0');
                const mm = String(ts.getMinutes()).padStart(2, '0');
                const omieRow = DATA.omieMap?.get(`${dataStr}_${hh}:${mm}`) || DATA.omieMap?.get(`${dataStr}_${hh}:00`);
                if(omieRow) {
                    const omie = parseFloat(String(omieRow.OMIE).replace(',', '.')) || 0;
                    porDiaSemana[ajustado].omieSum += omie;
                    porDiaSemana[ajustado].omieCount++;
                    
                    if(info.colCiclo) {
                        const periodo = omieRow[info.colCiclo];
                        if(periodo && porDiaSemana[ajustado][periodo]) {
                            porDiaSemana[ajustado][periodo].consumo += consumo;
                            porDiaSemana[ajustado][periodo].omieSum += omie;
                            porDiaSemana[ajustado][periodo].omieCount++;
                        }
                    }
                }
            });
            
            const categorias = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'];
            const series = [];
            
            if(info.colCiclo) {
                [...info.periodos].reverse().forEach(p => {
                    const corKey = p === 'V' && info.ohLower.startsWith('tri') ? 'V_tri' : (p === 'V' ? 'V_bi' : p);
                    const data = [];
                    for(let i = 0; i < 7; i++) {
                        const total = porDiaSemana[i][p] ? Math.round(porDiaSemana[i][p].consumo * 100) / 100 : 0;
                        const nDias = porDiaSemana[i].dias.size || 1;
                        data.push({ y: total, media: Math.round(total / nDias * 100) / 100 });
                    }
                    series.push({
                        name: `Consumo ${info.nomesPeriodos[p]} (kWh)`, type: 'column',
                        data: data, yAxis: 0, color: info.coresConsumo[corKey]
                    });
                });
            } else {
                const data = [];
                for(let i = 0; i < 7; i++) {
                    const total = Math.round(porDiaSemana[i].consumo * 100) / 100;
                    const nDias = porDiaSemana[i].dias.size || 1;
                    data.push({ y: total, media: Math.round(total / nDias * 100) / 100 });
                }
                series.push({ name: 'Consumo Total (kWh)', type: 'column', data: data, yAxis: 0, color: '#BFBFBF' });
            }
            
            // Linha OMIE simples
            series.push({
                name: 'M√©dia OMIE (‚Ç¨/MWh)', type: 'line',
                data: Array.from({length: 7}, (_, i) => porDiaSemana[i].omieCount > 0 ? Math.round(porDiaSemana[i].omieSum / porDiaSemana[i].omieCount * 100) / 100 : null),
                yAxis: 1, color: info.coresOmie.S, tooltip: { valueSuffix: ' ‚Ç¨/MWh' }
            });
            
            // Linhas OMIE por per√≠odo (escondidas)
            if(info.colCiclo) {
                info.periodos.forEach(p => {
                    series.push({
                        name: `M√©dia OMIE ${info.nomesPeriodos[p]} (‚Ç¨/MWh)`, type: 'line',
                        data: Array.from({length: 7}, (_, i) => porDiaSemana[i][p] && porDiaSemana[i][p].omieCount > 0 ? Math.round(porDiaSemana[i][p].omieSum / porDiaSemana[i][p].omieCount * 100) / 100 : null),
                        yAxis: 1, color: info.coresOmie[p], visible: false, tooltip: { valueSuffix: ' ‚Ç¨/MWh' }
                    });
                });
            }
            
            if(typeof Highcharts !== 'undefined') {
                Highcharts.chart('chart-semana', {
                    chart: { zoomType: 'xy' },
                    title: { text: `Consumo e Pre√ßo M√©dio OMIE por Dia da Semana (${info.tituloCiclo})`, align: 'left' },
                    xAxis: [{ categories: categorias, crosshair: true }],
                    yAxis: [
                        { labels: { format: '{value} kWh' }, title: { text: 'Consumo Total (kWh)' } },
                        { title: { text: 'M√©dia OMIE (‚Ç¨/MWh)' }, labels: { format: '{value} ‚Ç¨/MWh' }, opposite: true }
                    ],
                    legend: { align: 'left', verticalAlign: 'top', y: 40, floating: true, backgroundColor: 'white' },
                    plotOptions: { column: { stacking: 'normal' } },
                    tooltip: {
                        shared: true,
                        formatter: function() {
                            let s = '<b>' + this.x + '</b>';
                            let isStacked = false;
                            this.points.forEach(function(point) {
                                if(point.y > 0) {
                                    s += '<br/>' + point.series.name + ': <b>' + point.y.toFixed(2) + '</b>';
                                    if(typeof point.point.options.media !== 'undefined') {
                                        s += ' <span style="font-size:0.9em">(M√©dia: ' + point.point.options.media.toFixed(2) + ')</span>';
                                    }
                                }
                                if(point.series.type === 'column' && point.series.options.stacking === 'normal') isStacked = true;
                            });
                            if(isStacked && typeof this.total !== 'undefined' && this.total > 0) {
                                s += '<br/>--------------------';
                                s += '<br/><b>Total Consumo: ' + this.total.toFixed(2) + ' kWh</b>';
                            }
                            return s;
                        }
                    },
                    series: series
                });
            }
        }
        function gerarGraficoMensal(dados, ciclo) {
            const info = getCicloInfo(ciclo);
            
            // Agregar por M√™s (YYYY-MM)
            const porMes = {};
            
            dados.forEach(r => {
                // Extrair YYYY-MM
                const dataParts = r.DataHora.split('T')[0].split('-'); // [YYYY, MM, DD]
                const mesStr = `${dataParts[0]}-${dataParts[1]}`; // YYYY-MM
                
                if(!porMes[mesStr]) {
                    porMes[mesStr] = { consumo: 0, omieSum: 0, omieCount: 0 };
                    if(info.colCiclo) info.periodos.forEach(p => { porMes[mesStr][p] = { consumo: 0, omieSum: 0, omieCount: 0 }; });
                }
                
                const consumo = r['Consumo (kWh)'];
                porMes[mesStr].consumo += consumo;
                
                // OMIE
                const ts = new Date(r.DataHora);
                const hh = String(ts.getHours()).padStart(2, '0');
                const mm = String(ts.getMinutes()).padStart(2, '0');
                const dataDia = r.DataHora.split('T')[0];
                
                const omieRow = DATA.omieMap?.get(`${dataDia}_${hh}:${mm}`) || DATA.omieMap?.get(`${dataDia}_${hh}:00`);
                
                if(omieRow) {
                    const omie = parseFloat(String(omieRow.OMIE).replace(',', '.')) || 0;
                    // M√©dia Simples Mensal
                    porMes[mesStr].omieSum += omie;
                    porMes[mesStr].omieCount++;
                    
                    // M√©dia Por Per√≠odo Mensal
                    if(info.colCiclo) {
                        const periodo = omieRow[info.colCiclo];
                        if(periodo && porMes[mesStr][periodo]) {
                            porMes[mesStr][periodo].consumo += consumo;
                            porMes[mesStr][periodo].omieSum += omie;
                            porMes[mesStr][periodo].omieCount++;
                        }
                    }
                }
            });
            
            const mesesOrdenados = Object.keys(porMes).sort();
            
            const nomesMeses = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
                
            const categorias = mesesOrdenados.map(m => {
                // m vem no formato "2025-01"
                const partes = m.split('-'); 
                const ano = partes[0];
                const mesIndex = parseInt(partes[1]) - 1; // 0 para Jan, 1 para Fev...
                
                return `${nomesMeses[mesIndex]} ${ano}`;
            });
            
            const series = [];
            
            // 1. S√©ries de Consumo (Barras Empilhadas)
            if(info.colCiclo) {
                [...info.periodos].reverse().forEach(p => {
                    const corKey = p === 'V' && info.ohLower.startsWith('tri') ? 'V_tri' : (p === 'V' ? 'V_bi' : p);
                    const data = mesesOrdenados.map(m => {
                        const total = porMes[m][p] ? Math.round(porMes[m][p].consumo * 100) / 100 : 0;
                        return { y: total, media: total }; // No mensal, a m√©dia √© o total do m√™s (visualiza√ß√£o macro)
                    });
                    series.push({
                        name: `Consumo ${info.nomesPeriodos[p]} (kWh)`, type: 'column',
                        data: data, yAxis: 0, color: info.coresConsumo[corKey]
                    });
                });
            } else {
                series.push({
                    name: 'Consumo Total (kWh)', type: 'column',
                    data: mesesOrdenados.map(m => ({
                        y: Math.round(porMes[m].consumo * 100) / 100,
                        media: Math.round(porMes[m].consumo * 100) / 100
                    })),
                    yAxis: 0, color: '#BFBFBF'
                });
            }
            
            // 2. Linha OMIE Simples (Sempre vis√≠vel)
            series.push({
                name: 'M√©dia OMIE (‚Ç¨/MWh)', type: 'line',
                data: mesesOrdenados.map(m => porMes[m].omieCount > 0 ? Math.round(porMes[m].omieSum / porMes[m].omieCount * 100) / 100 : null),
                yAxis: 1, color: info.coresOmie.S, tooltip: { valueSuffix: ' ‚Ç¨/MWh' }
            });
            
            // 3. Linhas OMIE por Per√≠odo (Ocultas por defeito
            if(info.colCiclo) {
                info.periodos.forEach(p => {
                    series.push({
                        name: `M√©dia OMIE ${info.nomesPeriodos[p]} (‚Ç¨/MWh)`, type: 'line',
                        data: mesesOrdenados.map(m => porMes[m][p] && porMes[m][p].omieCount > 0 ? Math.round(porMes[m][p].omieSum / porMes[m][p].omieCount * 100) / 100 : null),
                        yAxis: 1, color: info.coresOmie[p], visible: false, tooltip: { valueSuffix: ' ‚Ç¨/MWh' }
                    });
                });
            }
            
            if(typeof Highcharts !== 'undefined') {
                Highcharts.chart('chart-mensal', {
                    chart: { zoomType: 'xy' },
                    title: { text: `Consumo Mensal vs. Pre√ßo M√©dio OMIE (${info.tituloCiclo})`, align: 'left' },
                    xAxis: [{ categories: categorias, crosshair: true }],
                    yAxis: [
                        { labels: { format: '{value} kWh' }, title: { text: 'Consumo Total (kWh)' } },
                        { title: { text: 'M√©dia Mensal OMIE (‚Ç¨/MWh)' }, labels: { format: '{value} ‚Ç¨/MWh' }, opposite: true }
                    ],
                    legend: { align: 'left', verticalAlign: 'top', y: 40, floating: true, backgroundColor: 'white' },
                    plotOptions: { column: { stacking: 'normal' } },
                    tooltip: {
                        shared: true,
                        formatter: function() {
                            let s = '<b>' + this.x + '</b>';
                            let isStacked = false;
                            this.points.forEach(function(point) {
                                if(point.y > 0) {
                                    s += '<br/>' + point.series.name + ': <b>' + point.y.toFixed(2) + '</b>';
                                    // No mensal n√£o mostramos "M√©dia" extra no tooltip pois o valor Y j√° √© o total mensal
                                }
                                if(point.series.type === 'column' && point.series.options.stacking === 'normal') isStacked = true;
                            });
                            if(isStacked && typeof this.total !== 'undefined' && this.total > 0) {
                                s += '<br/>--------------------';
                                s += '<br/><b>Total Consumo: ' + this.total.toFixed(2) + ' kWh</b>';
                            }
                            return s;
                        }
                    },
                    series: series
                });
            }
        }        
        // === MOSTRAR TABELA DE AN√ÅLISE E-REDES ===
        function mostrarTabelaAnaliseERedes() {
            if(!DADOS_EREDES) return;
            
            const container = document.getElementById('analise-content');
            const analiseDiv = document.getElementById('analise-consumos');
            
            if(!container || !analiseDiv) return;
            
            analiseDiv.style.display = 'block';
            
            // Gerar HTML da tabela
            const consumos = DADOS_EREDES.consumosAgregados;
            const medias = DADOS_EREDES.mediasOMIE || {};
            
            let html = `
            <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                <thead>
                    <tr style="background: #f8fafc;">
                        <th style="padding: 10px; border: 1px solid #e2e8f0; text-align: left;">Per√≠odo</th>
                        <th style="padding: 10px; border: 1px solid #e2e8f0; text-align: right;">Consumo (kWh)</th>
                        <th style="padding: 10px; border: 1px solid #e2e8f0; text-align: right;">% Total</th>
                        <th style="padding: 10px; border: 1px solid #e2e8f0; text-align: right;">M√©dia OMIE (‚Ç¨/MWh)</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            const total = consumos.Simples || 0;
            
            // Linha Simples
            html += `<tr style="background: #f9f9f9; font-weight: 600;">
                <td style="padding: 8px; border: 1px solid #e2e8f0;">Total (Simples)</td>
                <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${total.toFixed(2)}</td>
                <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">100%</td>
                <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${(medias.S || 0).toFixed(2)}</td>
            </tr>`;
            
            // Bi-hor√°rio
            if(consumos.BD && (consumos.BD.V || consumos.BD.F)) {
                const vazio = consumos.BD.V || 0;
                const foraVazio = consumos.BD.F || 0;
                html += `
                <tr><td colspan="4" style="padding: 8px; border: 1px solid #e2e8f0; background: #A9D08E; font-weight: 600;">Bi-Hor√°rio Di√°rio</td></tr>
                <tr>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; padding-left: 20px;">Vazio</td>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${vazio.toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${total > 0 ? ((vazio/total)*100).toFixed(1) : 0}%</td>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${(medias.BD_V || 0).toFixed(2)}</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; padding-left: 20px;">Fora Vazio</td>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${foraVazio.toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${total > 0 ? ((foraVazio/total)*100).toFixed(1) : 0}%</td>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${(medias.BD_F || 0).toFixed(2)}</td>
                </tr>`;
            }
            
            // Tri-hor√°rio
            if(consumos.TD && (consumos.TD.V || consumos.TD.C || consumos.TD.P)) {
                const vazio = consumos.TD.V || 0;
                const cheias = consumos.TD.C || 0;
                const ponta = consumos.TD.P || 0;
                html += `
                <tr><td colspan="4" style="padding: 8px; border: 1px solid #e2e8f0; background: #BF8F00; color: white; font-weight: 600;">Tri-Hor√°rio Di√°rio</td></tr>
                <tr>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; padding-left: 20px;">Vazio</td>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${vazio.toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${total > 0 ? ((vazio/total)*100).toFixed(1) : 0}%</td>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${(medias.TD_V || 0).toFixed(2)}</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; padding-left: 20px;">Cheias</td>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${cheias.toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${total > 0 ? ((cheias/total)*100).toFixed(1) : 0}%</td>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${(medias.TD_C || 0).toFixed(2)}</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; padding-left: 20px;">Ponta</td>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${ponta.toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${total > 0 ? ((ponta/total)*100).toFixed(1) : 0}%</td>
                    <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: right;">${(medias.TD_P || 0).toFixed(2)}</td>
                </tr>`;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function autoCollapse(id) {
            setTimeout(() => {
                const content = document.getElementById('content-' + id);
                const icon = document.getElementById('icon-' + id);
                if(!content.classList.contains('collapsed')) {
                    content.classList.add('collapsed');
                    icon.className = 'fa-solid fa-chevron-right';
                }
            }, 800);
        }

        // --- FUN√á√ÉO: Calcular datas padr√£o (In√≠cio = Amanh√£, Fim = +1 M√™s - 1 Dia) ---
        function getDefaultDates() {
            const today = new Date();
            const start = new Date(today);
            start.setDate(today.getDate() + 1); // Amanh√£
            
            // Calcular Data Fim: Ciclo de 1 m√™s - 1 dia
            const end = new Date(start);
            const currentDay = start.getDate();
            
            // Adicionar 1 m√™s
            end.setMonth(end.getMonth() + 1);
            
            // Corre√ß√£o para meses mais curtos (ex: 31 Jan -> 28 Fev)
            // Se o dia mudou (ex: era 31, virou 1 ou 2 de Mar√ßo), volta para o √∫ltimo dia do m√™s anterior
            if (end.getDate() !== currentDay) {
                end.setDate(0); 
            }
            
            // Subtrair 1 dia para fechar o ciclo
            end.setDate(end.getDate() - 1);
            
            return { start: getYMD(start), end: getYMD(end) };
        }

        // === CACHE IndexedDB (24h) para a Base de Dados ===
        const DB_NAME = 'SimuladorTarifarios';
        const DB_STORE = 'cache';
        const CACHE_KEY = 'tarifarios_xlsx';
        const CACHE_DURATION = 12 * 60 * 60 * 1000; // 12 horas

        function openCacheDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, 1);
                req.onupgradeneeded = e => e.target.result.createObjectStore(DB_STORE);
                req.onsuccess = e => resolve(e.target.result);
                req.onerror = () => reject();
            });
        }

        async function getCachedData() {
            try {
                const db = await openCacheDB();
                return new Promise((resolve) => {
                    const tx = db.transaction(DB_STORE, 'readonly');
                    const req = tx.objectStore(DB_STORE).get(CACHE_KEY);
                    req.onsuccess = () => {
                        const entry = req.result;
                        if (entry && entry.timestamp && (Date.now() - entry.timestamp < CACHE_DURATION)) {
                            resolve(entry.data);
                        } else {
                            resolve(null);
                        }
                    };
                    req.onerror = () => resolve(null);
                });
            } catch(e) { return null; }
        }

        async function setCachedData(buffer) {
            try {
                const db = await openCacheDB();
                const tx = db.transaction(DB_STORE, 'readwrite');
                tx.objectStore(DB_STORE).put({ data: buffer, timestamp: Date.now() }, CACHE_KEY);
            } catch(e) { /* silencioso */ }
        }

        function setLoaderMsg(msg) {
            const el = document.getElementById('loader-msg');
            if(el) el.textContent = msg;
        }

        window.onload = async () => {
            const today = new Date();
            const start = new Date(today);
            start.setDate(today.getDate() + 1);
            const end = new Date(start);
            const currentDay = start.getDate();
            end.setMonth(end.getMonth() + 1);
            if (end.getDate() !== currentDay) end.setDate(0);
            end.setDate(end.getDate() - 1);
            
            const fmt = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            const d1 = document.getElementById('d_inicio');
            const d2 = document.getElementById('d_fim');
            const y = today.getFullYear();
            d1.min = `${y}-01-01`; d1.max = `${y+2}-12-31`;
            d2.min = `${y}-01-01`; d2.max = `${y+2}-12-31`;
            d1.value = fmt(start);
            d2.value = fmt(end);
            atualizarDias();

            // Carregar BD: cache 24h ‚Üí fetch ‚Üí fallback manual
            try {
                setLoaderMsg('A carregar dados...');
                const cached = await getCachedData();
                if (cached) {
                    setLoaderMsg('A carregar dados em cache...');
                    loadData(cached);
                    return;
                }
                setLoaderMsg('A descarregar tarif√°rios...');
                const response = await fetch(FILENAME);
                if (!response.ok) throw new Error('Fetch falhou');
                const buffer = await response.arrayBuffer();
                setCachedData(buffer);
                setLoaderMsg('A processar dados...');
                loadData(buffer);
            } catch(err) {
                const loader = document.getElementById('loader');
                loader.innerHTML = `
                    <div style="color:#d97706; margin-bottom:15px; font-family:sans-serif;">
                        <i class="fa-solid fa-triangle-exclamation fa-2x"></i>
                        <p style="margin:5px 0">N√£o foi poss√≠vel carregar automaticamente.</p>
                        <p style="font-size:0.85rem; color:var(--text-light);">Verifique a liga√ß√£o ou carregue manualmente.</p>
                    </div>
                    <label style="background:#0066cc; color:white; padding:10px 20px; border-radius:5px; cursor:pointer; font-family:sans-serif; display:inline-block;">
                        <i class="fa-solid fa-upload"></i> Carregar "Tarifarios.xlsx"
                        <input type="file" style="display:none" accept=".xlsx" onchange="lerBaseDadosManual(this)">
                    </label>
                `;
            }
        };

        function lerArquivoManual(input) {
            const f = input.files[0];
            if(f) { const r = new FileReader(); r.onload = e => loadData(e.target.result); r.readAsArrayBuffer(f); }
        }
        
        // --- FUN√á√ïES DE NORMALIZA√á√ÉO DE CHAVES (UNIVERSAIS) ---
        function getKeyDate(raw) {
            // Garante formato YYYY-MM-DD a partir de qualquer input do Excel (N√∫mero ou String)
            const dateStr = parseDateFromDB(raw); // A sua fun√ß√£o j√° existente que devolve YYYY-MM-DD
            return dateStr || "INVALID";
        }

        function getKeyTime(raw) {
            // Garante formato HH:MM (com zeros √† esquerda)
            if (raw === undefined || raw === null) return "00:00";
            
            // Se for n√∫mero (fra√ß√£o de dia Excel, ex: 0.0104...)
            if (typeof raw === 'number') {
                const totalMinutes = Math.round(raw * 24 * 60);
                const h = Math.floor(totalMinutes / 60);
                const m = totalMinutes % 60;
                return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            }
            
            // Se for string (ex: "0:15", "00:15:00", "10:30")
            const str = String(raw).trim();
            const parts = str.split(':');
            if (parts.length >= 2) {
                const h = parts[0].padStart(2, '0');
                const m = parts[1].padStart(2, '0');
                return `${h}:${m}`;
            }
            return "00:00"; // Fallback
        }

        function loadData(buffer) {
            const wb = XLSX.read(buffer, {type: 'array'});
            
            if(wb.Sheets["Constantes"]) {
                XLSX.utils.sheet_to_json(wb.Sheets["Constantes"]).forEach(r => {
                    DATA.constantes[r.constante] = r.valor_unit√°rio;
                });
            }

            DATA.fixos = XLSX.utils.sheet_to_json(wb.Sheets["Tarifarios_Fixos"] || wb.Sheets[wb.SheetNames[0]]);
            
            if(wb.Sheets["Indexados"]) {
                DATA.indexados = XLSX.utils.sheet_to_json(wb.Sheets["Indexados"]);
            }
            
            if(wb.Sheets["OMIE_PERDAS_CICLOS"]) {
                DATA.omie = XLSX.utils.sheet_to_json(wb.Sheets["OMIE_PERDAS_CICLOS"], {raw: false});
                
                // --- OTIMIZA√á√ÉO: Criar √çndice R√°pido para Performance Extrema ---
                DATA.omieMap = new Map();
                DATA.omie.forEach(row => {
                    // Normalizar Data (YYYY-MM-DD) e Hora (HH:MM) para chave √∫nica
                    const d = parseDateFromDB(row.Data);
                    let h = "00:00";
                    
                    // Normalizar hora (tratar n√∫meros e strings)
                    if (typeof row.Hora === 'number') {
                        const mins = Math.round(row.Hora * 1440);
                        const hh = Math.floor(mins / 60).toString().padStart(2,'0');
                        const mm = (mins % 60).toString().padStart(2,'0');
                        h = `${hh}:${mm}`;
                    } else if (row.Hora) {
                        const parts = String(row.Hora).trim().split(':');
                        if (parts.length >= 2) h = `${parts[0].padStart(2,'0')}:${parts[1].padStart(2,'0')}`;
                    }
                    
                    if (d) DATA.omieMap.set(`${d}_${h}`, row);
                });
            }
            
            if(wb.Sheets["Perdas"]) {
                XLSX.utils.sheet_to_json(wb.Sheets["Perdas"]).forEach(r => {
                    DATA.perdas[r.coluna] = r.valor;
                });
            }

            document.getElementById('loader').classList.add('hidden');
            document.getElementById('tabs-wrapper').classList.remove('hidden');
            document.getElementById('tab-quick').classList.remove('hidden');
            atualizarMenusCiclo();
            
            // Popular filtros de comercializadores na Simula√ß√£o R√°pida
            populateProviderFilters();
            
            // Popular filtros de comercializadores nas Abas 2 e 3
            populateProviderFiltersAbas();
            
            // Inicializar estado da Aba 2 com datas default
            const defaults = getDefaultDates();
            STATE_ABA2.dataInicio = defaults.start;
            STATE_ABA2.dataFim = defaults.end;
            
            // --- Inicia o p√≥dio com valores default ---
            runQuickSimulation();
            atualizarDatasReferencia();
            
            // --- Verificar se h√° par√¢metros de partilha na URL ---
            if(aplicarParametrosPartilha()) {
                setTimeout(() => aplicarSharedParamsDepoisDeCarregar(), 500);
            }
        }
        
        function atualizarDias() {
            const d1 = new Date(document.getElementById('d_inicio').value);
            const d2 = new Date(document.getElementById('d_fim').value);
            if(d1 && d2) {
                const diff = Math.floor((d2 - d1) / (86400000)) + 1;
                document.getElementById('num_dias').value = diff > 0 ? diff : 0;
                // OMIE_MANUAL = false; // Mantemos o manual se o user tiver mexido
                if(DATA.fixos.length > 0) calcular();
            }
        }

        // Usar compara√ß√£o de strings para evitar problemas de Hor√°rio de Ver√£o/Fuso Hor√°rio
        function getOmieAvg(cicloCol, letter) {
            const d1Str = document.getElementById('d_inicio').value;
            const d2Str = document.getElementById('d_fim').value;
            
            let sum = 0, count = 0;
            DATA.omie.forEach(r => {
                const rowDateStr = parseDateFromDB(r['Data']); 
                
                if(!rowDateStr) return;
                
                // Compara√ß√£o de texto (YYYY-MM-DD) funciona perfeitamente
                if(rowDateStr >= d1Str && rowDateStr <= d2Str && r[cicloCol] == letter) {
                    const val = parseFloat(String(r['OMIE']).replace(',','.'));
                    if(!isNaN(val)) { sum += val; count++; }
                }
            });
            return count ? sum/count : 0;
        }

        function atualizarMenusCiclo() {
            const pot = parseFloat(document.getElementById('potencia').value);
            const sel = document.getElementById('ciclo');
            sel.innerHTML = "";
            const ops = pot <= 20.7 
                ? ["Simples", "Bi-hor√°rio - Ciclo Di√°rio", "Bi-hor√°rio - Ciclo Semanal", "Tri-hor√°rio - Ciclo Di√°rio", "Tri-hor√°rio - Ciclo Semanal"]
                : ["Tri-hor√°rio > 20.7 kVA - Ciclo Di√°rio", "Tri-hor√°rio > 20.7 kVA - Ciclo Semanal"];
            ops.forEach(o => sel.add(new Option(o, o)));
            construirInputsConsumo();
        }

        function construirInputsConsumo() {
            const c = document.getElementById('ciclo').value;
            const div = document.getElementById('content-consumo');
            
            if(c.includes("Simples")) {
                div.innerHTML = `<div class="input-group"><label>Simples</label><input type="number" id="kwh_S" value="158" oninput="calcular()"></div>`;
            } else if(c.includes("Bi")) {
                div.innerHTML = `<div class="input-group"><label>Vazio</label><input type="number" id="kwh_V" value="63" oninput="calcular()"></div>
                                 <div class="input-group"><label>Fora Vazio</label><input type="number" id="kwh_F" value="95" oninput="calcular()"></div>`;
            } else {
                div.innerHTML = `<div class="input-group"><label>Vazio</label><input type="number" id="kwh_V" value="63" oninput="calcular()"></div>
                                 <div class="input-group"><label>Ponta</label><input type="number" id="kwh_P" value="27" oninput="calcular()"></div>
                                 <div class="input-group"><label>Cheias</label><input type="number" id="kwh_C" value="68" oninput="calcular()"></div>`;
            }
            
            // Se existem dados E-Redes E estamos na Aba 3, aplic√°-los automaticamente
            if(CURRENT_TAB === 'advanced' && DADOS_EREDES && DADOS_EREDES.consumosAgregados) {
                aplicarDadosERedes();
                
                // Atualizar OMIE_VALUES para o ciclo atual
                const medias = DADOS_EREDES.mediasOMIE;
                if(c.includes("Bi-hor√°rio") && c.includes("Di√°rio")) {
                    OMIE_VALUES.V = medias.BD_V || medias.S;
                    OMIE_VALUES.F = medias.BD_F || medias.S;
                } else if(c.includes("Bi-hor√°rio") && c.includes("Semanal")) {
                    OMIE_VALUES.V = medias.BS_V || medias.S;
                    OMIE_VALUES.F = medias.BS_F || medias.S;
                } else if(c.includes("Tri-hor√°rio") && c.includes("Di√°rio")) {
                    OMIE_VALUES.V = medias.TD_V || medias.S;
                    OMIE_VALUES.C = medias.TD_C || medias.S;
                    OMIE_VALUES.P = medias.TD_P || medias.S;
                } else if(c.includes("Tri-hor√°rio") && c.includes("Semanal")) {
                    OMIE_VALUES.V = medias.TS_V || medias.S;
                    OMIE_VALUES.C = medias.TS_C || medias.S;
                    OMIE_VALUES.P = medias.TS_P || medias.S;
                }
            }
            
            toggleMeuTarifario();
            
            // Reconstruir tamb√©m o Tarif√°rio Personalizado se estiver ativo
            const persAtivo = document.getElementById('pers_ativo');
            if(persAtivo && persAtivo.checked) {
                toggleTarifarioPersonalizado();
            }
            
            // Controlar visibilidade do Modo de Compara√ß√£o
            controlarVisibilidadeModoComparacao();
            
            calcular();
        }
        
        // Controlar visibilidade da sec√ß√£o Modo de Compara√ß√£o
        function controlarVisibilidadeModoComparacao() {
            const c = document.getElementById('ciclo').value;
            const contentComparacao = document.getElementById('content-comparacao');
            
            // Encontrar o section-title correspondente (irm√£o anterior)
            const titleComparacao = contentComparacao ? contentComparacao.previousElementSibling : null;
            
            // Na Aba 3, mostrar SEMPRE (temos dados E-REDES para todos os ciclos)
            if(CURRENT_TAB === 'advanced') {
                if(contentComparacao) contentComparacao.style.display = 'block';
                if(titleComparacao) titleComparacao.style.display = 'block';
                return;
            }
            
            // Na Aba 2: Se for Simples, esconder completamente a sec√ß√£o
            if(c.includes("Simples")) {
                if(contentComparacao) contentComparacao.style.display = 'none';
                if(titleComparacao) titleComparacao.style.display = 'none';
                // Desmarcar checkbox se estava marcada
                const modoComp = document.getElementById('modo_comparacao');
                if(modoComp) modoComp.checked = false;
            } else {
                // Se for Bi ou Tri, mostrar a sec√ß√£o
                if(contentComparacao) contentComparacao.style.display = 'block';
                if(titleComparacao) titleComparacao.style.display = 'block';
            }
        }

        // --- FUN√á√ÉO PARA CALCULAR PERDAS DINAMICAMENTE ---
        function calcularPerdasDinamicas(d1, d2, ciclo) {
            DATA.perdas = {}; // Limpar perdas anteriores
            
            if(!DATA.omie || DATA.omie.length === 0) return;
            
            // Converter datas para formato YYYY-MM-DD para compara√ß√£o
            const formatDateYYYYMMDD = (date) => {
                const y = date.getFullYear();
                const m = (date.getMonth() + 1).toString().padStart(2, '0');
                const d = date.getDate().toString().padStart(2, '0');
                return `${y}-${m}-${d}`;
            };
            
            const dataInicioStr = formatDateYYYYMMDD(d1);
            const dataFimStr = formatDateYYYYMMDD(d2);
            
            // Filtrar dados do per√≠odo selecionado (mensal)
            let dadosMensais = DATA.omie.filter(row => {
                const dateStr = String(row['Data']);
                const parts = dateStr.includes('/') ? dateStr.split('/') : null;
                if(!parts || parts.length !== 3) return false;
                
                // Converter MM/DD/YYYY para YYYY-MM-DD
                const ano = parts[2];
                const mes = parts[0].padStart(2, '0');
                const dia = parts[1].padStart(2, '0');
                const dataRowStr = `${ano}-${mes}-${dia}`;
                
                // Compara√ß√£o de strings (funciona sempre)
                return dataRowStr >= dataInicioStr && dataRowStr <= dataFimStr;
            });
            
            // Filtrar dados do ano inteiro
            const anoInicio = d1.getFullYear();
            const anoFim = d2.getFullYear();
            let dadosAnuais = DATA.omie.filter(row => {
                const dateStr = String(row['Data']);
                const parts = dateStr.includes('/') ? dateStr.split('/') : null;
                if(!parts || parts.length !== 3) return false;
                const ano = parseInt(parts[2]);
                return ano >= anoInicio && ano <= anoFim;
            });
            
            // Calcular perdas mensais
            if(dadosMensais.length > 0) {
                // Perdas_M_S (Simples Mensal)
                let sumS = 0, countS = 0;
                dadosMensais.forEach(row => {
                    let val = parseFloat(String(row['Perdas'] || '0').replace(',', '.'));
                    if(!isNaN(val) && val > 0) {
                        sumS += val;
                        countS++;
                    }
                });
                if(countS > 0) DATA.perdas['Perdas_M_S'] = sumS / countS;
                
                // Perdas por ciclo (BD, BS, TD, TS)
                ['BD', 'BS', 'TD', 'TS'].forEach(cicloCol => {
                    const periodos = (cicloCol === 'BD' || cicloCol === 'BS') ? ['V', 'F'] : ['V', 'C', 'P'];
                    
                    periodos.forEach(periodo => {
                        let sum = 0, count = 0;
                        dadosMensais.forEach(row => {
                            if(row[cicloCol] === periodo) {
                                let val = parseFloat(String(row['Perdas'] || '0').replace(',', '.'));
                                if(!isNaN(val) && val > 0) {
                                    sum += val;
                                    count++;
                                }
                            }
                        });
                        if(count > 0) {
                            DATA.perdas[`Perdas_M_${cicloCol}_${periodo}`] = sum / count;
                        } else {
                            // Fallback para m√©dia simples
                            DATA.perdas[`Perdas_M_${cicloCol}_${periodo}`] = DATA.perdas['Perdas_M_S'] || 1.16;
                        }
                    });
                });
            }
            
            // Calcular perdas anuais
            if(dadosAnuais.length > 0) {
                // Perdas_Anual_S (Simples Anual)
                let sumS = 0, countS = 0;
                dadosAnuais.forEach(row => {
                    let val = parseFloat(String(row['Perdas'] || '0').replace(',', '.'));
                    if(!isNaN(val) && val > 0) {
                        sumS += val;
                        countS++;
                    }
                });
                if(countS > 0) DATA.perdas['Perdas_Anual_S'] = sumS / countS;
                
                // Perdas por ciclo (BD, BS, TD, TS)
                ['BD', 'BS', 'TD', 'TS'].forEach(cicloCol => {
                    const periodos = (cicloCol === 'BD' || cicloCol === 'BS') ? ['V', 'F'] : ['V', 'C', 'P'];
                    
                    periodos.forEach(periodo => {
                        let sum = 0, count = 0;
                        dadosAnuais.forEach(row => {
                            if(row[cicloCol] === periodo) {
                                let val = parseFloat(String(row['Perdas'] || '0').replace(',', '.'));
                                if(!isNaN(val) && val > 0) {
                                    sum += val;
                                    count++;
                                }
                            }
                        });
                        if(count > 0) {
                            DATA.perdas[`Perdas_Anual_${cicloCol}_${periodo}`] = sum / count;
                        } else {
                            // Fallback para m√©dia simples
                            DATA.perdas[`Perdas_Anual_${cicloCol}_${periodo}`] = DATA.perdas['Perdas_Anual_S'] || 1.0;
                        }
                    });
                });
            }
        }

        function construirInputsOMIE(ciclo) {
            const div = document.getElementById('omie-inputs');
            let html = '';
            
            if(ciclo.includes("Simples")) {
                html = `<div><label style="font-size:0.7rem;">Simples</label><input type="number" class="omie-input" id="omie_S" value="${OMIE_VALUES.S.toFixed(2)}" step="0.01" oninput="atualizarOMIE()"></div>`;
            } else if(ciclo.includes("Bi")) {
                html = `<div><label style="font-size:0.7rem;">Vazio</label><input type="number" class="omie-input" id="omie_V" value="${OMIE_VALUES.V.toFixed(2)}" step="0.01" oninput="atualizarOMIE()"></div>
                        <div><label style="font-size:0.7rem;">F. Vazio</label><input type="number" class="omie-input" id="omie_F" value="${OMIE_VALUES.F.toFixed(2)}" step="0.01" oninput="atualizarOMIE()"></div>`;
            } else {
                html = `<div><label style="font-size:0.7rem;">Vazio</label><input type="number" class="omie-input" id="omie_V" value="${OMIE_VALUES.V.toFixed(2)}" step="0.01" oninput="atualizarOMIE()"></div>
                        <div><label style="font-size:0.7rem;">Ponta</label><input type="number" class="omie-input" id="omie_P" value="${OMIE_VALUES.P.toFixed(2)}" step="0.01" oninput="atualizarOMIE()"></div>
                        <div><label style="font-size:0.7rem;">Cheias</label><input type="number" class="omie-input" id="omie_C" value="${OMIE_VALUES.C.toFixed(2)}" step="0.01" oninput="atualizarOMIE()"></div>`;
            }
            div.innerHTML = html;
        }

        function atualizarOMIE() {
            OMIE_MANUAL = true;
            if(document.getElementById('omie_S')) OMIE_VALUES.S = parseFloat(document.getElementById('omie_S').value) || 0;
            if(document.getElementById('omie_V')) OMIE_VALUES.V = parseFloat(document.getElementById('omie_V').value) || 0;
            if(document.getElementById('omie_F')) OMIE_VALUES.F = parseFloat(document.getElementById('omie_F').value) || 0;
            if(document.getElementById('omie_P')) OMIE_VALUES.P = parseFloat(document.getElementById('omie_P').value) || 0;
            if(document.getElementById('omie_C')) OMIE_VALUES.C = parseFloat(document.getElementById('omie_C').value) || 0;
            
            // Atualizar o texto de display tamb√©m
            let ciclo = document.getElementById('ciclo').value;
            let omieHtml = "";
            if(ciclo.includes("Simples")) omieHtml = `S: ${OMIE_VALUES.S.toFixed(2)}`;
            else if(ciclo.includes("Bi")) omieHtml = `V: ${OMIE_VALUES.V.toFixed(2)} | F: ${OMIE_VALUES.F.toFixed(2)}`;
            else omieHtml = `V: ${OMIE_VALUES.V.toFixed(2)} | P: ${OMIE_VALUES.P.toFixed(2)} | C: ${OMIE_VALUES.C.toFixed(2)}`;
            document.getElementById('omie-display').innerText = omieHtml;

            calcular();
        }

        function toggleMeuTarifario() {
            const ativo = document.getElementById('meu_ativo').checked;
            const div = document.getElementById('meu-inputs');
            const c = document.getElementById('ciclo').value;
            
            if(!ativo) { div.classList.add('hidden'); calcular(); return; }
            div.classList.remove('hidden');
            let html = '';
            
            if(c.includes("Simples")) {
                html = `<div class="input-group"><label>Pre√ßo Simples <span class="label-units">(‚Ç¨/kWh)</span></label><input type="number" id="meu_S" value="0.15" step="0.0001" oninput="calcular()"></div>`;
            } else if(c.includes("Bi")) {
                html = `<div class="input-group"><label>Vazio <span class="label-units">(‚Ç¨/kWh)</span></label><input type="number" id="meu_V" value="0.10" step="0.0001" oninput="calcular()"></div>
                        <div class="input-group"><label>Fora Vazio <span class="label-units">(‚Ç¨/kWh)</span></label><input type="number" id="meu_F" value="0.18" step="0.0001" oninput="calcular()"></div>`;
            } else {
                html = `<div class="input-group"><label>Vazio <span class="label-units">(‚Ç¨/kWh)</span></label><input type="number" id="meu_V" value="0.10" step="0.0001" oninput="calcular()"></div>
                        <div class="input-group"><label>Cheias <span class="label-units">(‚Ç¨/kWh)</span></label><input type="number" id="meu_C" value="0.15" step="0.0001" oninput="calcular()"></div>
                        <div class="input-group"><label>Ponta <span class="label-units">(‚Ç¨/kWh)</span></label><input type="number" id="meu_P" value="0.25" step="0.0001" oninput="calcular()"></div>`;
            }
            html += `<div class="input-group"><label>Pot√™ncia <span class="label-units">(‚Ç¨/dia)</span></label><input type="number" id="meu_pot" value="0.20" step="0.0001" oninput="calcular()"></div>
                     <div class="input-group"><label class="checkbox-label"><input type="checkbox" id="meu_tar_en_incl" checked onchange="calcular()"> TAR Energia inclu√≠da</label></div>
                     <div class="input-group"><label class="checkbox-label"><input type="checkbox" id="meu_tar_pot_incl" checked onchange="calcular()"> TAR Pot√™ncia inclu√≠da</label></div>
                     <div class="input-group"><label class="checkbox-label"><input type="checkbox" id="meu_tse_incl" checked onchange="calcular()"> TSE inclu√≠do</label></div>
                     <div class="input-group"><label>Desc. Energia (%)</label><input type="number" id="meu_desc_en" value="0" step="0.1" oninput="calcular()"></div>
                     <div class="input-group"><label>Desc. Pot√™ncia (%)</label><input type="number" id="meu_desc_pot" value="0" step="0.1" oninput="calcular()"></div>
                     <div class="input-group"><label>Desc. Fatura (‚Ç¨)</label><input type="number" id="meu_desc_fat" value="0" step="0.01" oninput="calcular()"></div>
                     <div class="input-group"><label>Acr√©s. Fatura (‚Ç¨)</label><input type="number" id="meu_acres_fat" value="0" step="0.01" oninput="calcular()"></div>`;
            
            div.innerHTML = html;
            calcular();
        }

        function toggleTarifarioPersonalizado() {
            const ativo = document.getElementById('pers_ativo').checked;
            const div = document.getElementById('pers-inputs');
            const c = document.getElementById('ciclo').value;
            const potencia = parseFloat(document.getElementById('potencia').value);
            
            if(!ativo) { 
                div.classList.add('hidden'); 
                calcular(); 
                return; 
            }
            
            div.classList.remove('hidden');
            let html = '';
            
            // Determinar quais sec√ß√µes mostrar baseado na op√ß√£o hor√°ria
            const mostrarSimples = c.includes("Simples") || c.includes("Bi") || (c.includes("Tri") && potencia <= 20.7);
            const mostrarBi = c.includes("Bi") || (c.includes("Tri") && potencia <= 20.7);
            const mostrarTri = c.includes("Tri");
            
            // Estrutura Simples Personalizada
            if(mostrarSimples) {
                html += `
                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #dee2e6;">
                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.85rem; color: #495057;">Estrutura Simples Personalizada</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div class="input-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.75rem;">Pre√ßo Energia Simples <span class="label-units">(‚Ç¨/kWh)</span></label>
                            <input type="number" id="pers_energia_s" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.75rem;">Pre√ßo Pot√™ncia Simples <span class="label-units">(‚Ç¨/dia)</span></label>
                            <input type="number" id="pers_potencia_s" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">
                        </div>
                    </div>
                </div>`;
            }
            
            // Estrutura Bi-Hor√°ria Personalizada
            if(mostrarBi) {
                html += `
                <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #a5d6a7;">
                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.85rem; color: #2e7d32;">Estrutura Bi-Hor√°ria Personalizada</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                        <div class="input-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.75rem;">Pre√ßo Vazio Bi-Hor√°rio <span class="label-units">(‚Ç¨/kWh)</span></label>
                            <input type="number" id="pers_energia_v_bi" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.75rem;">Pre√ßo Fora Vazio Bi-Hor√°rio <span class="label-units">(‚Ç¨/kWh)</span></label>
                            <input type="number" id="pers_energia_f_bi" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.75rem;">Pre√ßo Pot√™ncia Bi-Hor√°rio <span class="label-units">(‚Ç¨/dia)</span></label>
                            <input type="number" id="pers_potencia_bi" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">
                        </div>
                    </div>
                </div>`;
            }
            
            // Estrutura Tri-Hor√°ria Personalizada
            if(mostrarTri) {
                html += `
                <div style="background: #fff3e0; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ffb74d;">
                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.85rem; color: #e65100;">Estrutura Tri-Hor√°ria Personalizada</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div class="input-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.75rem;">Pre√ßo Vazio Tri-Hor√°rio <span class="label-units">(‚Ç¨/kWh)</span></label>
                            <input type="number" id="pers_energia_v_tri" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.75rem;">Pre√ßo Cheias Tri-Hor√°rio <span class="label-units">(‚Ç¨/kWh)</span></label>
                            <input type="number" id="pers_energia_c_tri" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.75rem;">Pre√ßo Ponta Tri-Hor√°rio <span class="label-units">(‚Ç¨/kWh)</span></label>
                            <input type="number" id="pers_energia_p_tri" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.75rem;">Pre√ßo Pot√™ncia Tri-Hor√°rio <span class="label-units">(‚Ç¨/dia)</span></label>
                            <input type="number" id="pers_potencia_tri" value="0" step="0.0001" oninput="calcular()" style="padding: 6px;">
                        </div>
                    </div>
                </div>`;
            }
            
            // Op√ß√µes comuns
            html += `
            <div style="background: #f0f4ff; padding: 10px; border-radius: 8px; border: 1px solid #c5d9f7;">
                <div style="font-weight: 600; margin-bottom: 6px; font-size: 0.8rem; color: #1e40af;">Op√ß√µes Comuns</div>
                <div class="input-group" style="margin-bottom: 4px;">
                    <label class="checkbox-label" style="font-size: 0.75rem;">
                        <input type="checkbox" id="pers_tar_energia" checked onchange="calcular()"> TAR inclu√≠da na Energia?
                    </label>
                </div>
                <div class="input-group" style="margin-bottom: 4px;">
                    <label class="checkbox-label" style="font-size: 0.75rem;">
                        <input type="checkbox" id="pers_tar_potencia" checked onchange="calcular()"> TAR inclu√≠da na Pot√™ncia?
                    </label>
                </div>
                <div class="input-group" style="margin-bottom: 0;">
                    <label class="checkbox-label" style="font-size: 0.75rem;">
                        <input type="checkbox" id="pers_tse_incluido" checked onchange="calcular()"> Inclui Financiamento TSE?
                    </label>
                </div>
            </div>`;
            
            div.innerHTML = html;
            calcular();
        }

        function getVal(row, key, cols) {
            if(Array.isArray(key)) { for(let k of key) if(row[k] !== undefined) return parse(row[k]); return 0; }
            return parse(row[cols[key]] || row[key]);
        }
        
        function parse(v) {
            if(v === undefined || v === null) return 0;
            if(typeof v === 'string') return parseFloat(v.replace(',','.').replace('‚Ç¨','').trim()) || 0;
            return typeof v === 'number' ? v : 0;
        }
        
        function parseBool(v) {
            if(v === undefined || v === null) return undefined;
            if(typeof v === 'boolean') return v;
            if(typeof v === 'string') {
                const lower = v.toLowerCase().trim();
                if(lower === 'true' || lower === 'sim' || lower === 'yes' || lower === '1') return true;
                if(lower === 'false' || lower === 'n√£o' || lower === 'nao' || lower === 'no' || lower === '0') return false;
            }
            return undefined;
        }
        
        function getConst(k) { return parseFloat(DATA.constantes[k]) || 0; }
        function getPerdas(k) { return parseFloat(DATA.perdas[k]) || 1.0; }

        function obter_perfil(consumo_total_kwh, dias, potencia_kva) {
            if (dias <= 0) return 'BTN_C'; 
            const consumo_anual_estimado = consumo_total_kwh * 365 / dias;
            if (potencia_kva > 13.8) return 'BTN_A';
            else if (consumo_anual_estimado > 7140) return 'BTN_B';
            else return 'BTN_C';
        }

        // --- MOTOR DE C√ÅLCULO PARA INDEXADOS QH ---
        // Calcula o pre√ßo final ponderado para cada per√≠odo do ciclo selecionado
        function calculateDetailedQH(d1, d2, perfilBTN, ciclo) {
            let colCiclo = "Simp";
            if(ciclo.includes("Bi")) colCiclo = ciclo.includes("Di√°rio") ? "BD" : "BS";
            if(ciclo.includes("Tri")) colCiclo = ciclo.includes("Di√°rio") ? "TD" : "TS";

            let resPerfil = {}; 
            let resDiagrama = {};
            
            if(!DATA.indexados || DATA.indexados.length === 0) return { perfil: {}, diagrama: null };

            const tarifs = DATA.indexados.filter(t => t['tipo'] === 'Indexado quarto-hor√°rio' || (t['nome'] && t['nome'].includes('BTN SPOTDEF')));
            
            tarifs.forEach(t => {
                resPerfil[t['nome']] = { S:{c:0,w:0}, V:{c:0,w:0}, F:{c:0,w:0}, P:{c:0,w:0}, C:{c:0,w:0} };
                resDiagrama[t['nome']] = { S:{c:0,w:0}, V:{c:0,w:0}, F:{c:0,w:0}, P:{c:0,w:0}, C:{c:0,w:0} };
            });

            const calcPrice = (nomeT, omieVal, perdasVal) => {
                if(nomeT.includes("Coop√©rnico Base 2.0")) return (omieVal + getConst('Coop_CS_CR') + getConst('Coop_K')) * perdasVal;
                if(nomeT.includes("Repsol - Leve Sem Mais")) return (omieVal * perdasVal * getConst('Repsol_FA') + getConst('Repsol_Q_Tarifa'));
                if(nomeT.includes("Repsol - Leve PRO Sem Mais")) return (omieVal * perdasVal * getConst('Repsol_FA') + getConst('Repsol_Q_Tarifa_Pro'));
                if(nomeT.includes("Galp - Plano Flex√≠vel")) return (omieVal + getConst('Galp_Ci')) * perdasVal;
                if(nomeT.includes("Alfa Energia - ALFA POWER")) return ((omieVal + getConst('Alfa_CGS')) * perdasVal + getConst('Alfa_K'));
                if(nomeT.includes("Plenitude - Tend√™ncia")) return (((omieVal + getConst('Plenitude_CGS') + getConst('Plenitude_GDOs'))) * perdasVal + getConst('Plenitude_Fee'));
                if(nomeT.includes("Meo Energia - Tarifa Vari√°vel")) return (omieVal + getConst('Meo_K')) * perdasVal;
                if(nomeT.includes("EDP - Eletricidade Indexada Hor√°ria")) return (omieVal * perdasVal * getConst('EDP_H_K1') + getConst('EDP_H_K2'));
                if(nomeT.includes("EZU - Indexada")) return (omieVal + getConst('EZU_K') + getConst('EZU_CGS')) * perdasVal;
                if(nomeT.includes("G9 - Smart Dynamic")) return (omieVal * getConst('G9_FA') * perdasVal + getConst('G9_CGS') + getConst('G9_AC'));
                if(nomeT.includes("Iberdrola - Simples Indexado Din√¢mico")) return (omieVal * perdasVal + getConst('Iberdrola_Dinamico_Q') + getConst('Iberdrola_mFRR'));
                if(nomeT.includes("BTN SPOTDEF")) {
                    let cgs = getConst('Luzboa_CGS'), fa = getConst('Luzboa_FA'), kp = getConst('Luzboa_Kp');
                    return (omieVal + cgs) * perdasVal * fa + kp;
                }
                return omieVal * perdasVal + 0.01; 
            };

            // 1. C√ÅLCULO DIAGRAMA (S√≥ se houver dados E se estivermos na Aba Avan√ßada!)
            // AQUI EST√Å A CHAVE DA MUDAN√áA: && CURRENT_TAB === 'advanced'
            const temDadosDiagrama = (DADOS_EREDES && DADOS_EREDES.dadosBrutos && DATA.omieMap && CURRENT_TAB === 'advanced');
            
            if (temDadosDiagrama) {
                const d1Ts = new Date(d1).getTime();
                const d2Ts = new Date(d2).getTime() + 86399999;

                for (const r of DADOS_EREDES.dadosBrutos) {
                    if (r.Ts < d1Ts || r.Ts > d2Ts) continue;

                    const ts = new Date(r.DataHora);
                    const y = ts.getFullYear(), m = String(ts.getMonth()+1).padStart(2,'0'), d = String(ts.getDate()).padStart(2,'0');
                    const hh = String(ts.getHours()).padStart(2,'0'), mm = String(ts.getMinutes()).padStart(2,'0');
                    
                    let omieRow = DATA.omieMap.get(`${y}-${m}-${d}_${hh}:${mm}`);
                    if (!omieRow && mm !== "00") omieRow = DATA.omieMap.get(`${y}-${m}-${d}_${hh}:00`);
                    
                    if (!omieRow) continue;

                    let omieVal = parseFloat(String(omieRow.OMIE).replace(',','.')) / 1000;
                    let perdasVal = parseFloat(String(omieRow.Perdas).replace(',','.'));
                    let weight = r['Consumo (kWh)'];
                    let period = omieRow[colCiclo];

                    if (!period && colCiclo !== "Simp") continue;

                    for (let nomeT in resDiagrama) {
                        let price = calcPrice(nomeT, omieVal, perdasVal);
                        resDiagrama[nomeT]['S'].c += price * weight; resDiagrama[nomeT]['S'].w += weight;
                        if (colCiclo !== "Simp" && period) {
                            resDiagrama[nomeT][period].c += price * weight; resDiagrama[nomeT][period].w += weight;
                        }
                    }
                }
            }

            // 2. C√ÅLCULO PERFIL (Sempre executado, serve de base para a Aba 2)
            if(DATA.omie) {
                DATA.omie.forEach(row => {
                    const rowDateStr = parseDateFromDB(row['Data']);
                    if(!rowDateStr || rowDateStr < d1 || rowDateStr > d2) return;

                    let omieVal = parseFloat(String(row['OMIE']).replace(',','.')) / 1000;
                    let perdasVal = parseFloat(String(row['Perdas']).replace(',','.'));
                    let weight = parseFloat(String(row[perfilBTN] || 0).replace(',','.'));
                    let period = row[colCiclo]; 

                    if (!period && colCiclo !== "Simp") return;

                    for (let nomeT in resPerfil) {
                        let price = calcPrice(nomeT, omieVal, perdasVal);
                        if(nomeT.includes("BTN SPOTDEF")) {
                            if(colCiclo === "Simp") { resPerfil[nomeT]['S'].c += price; resPerfil[nomeT]['S'].w += 1; }
                            else if(period) { resPerfil[nomeT][period].c += price; resPerfil[nomeT][period].w += 1; }
                        } 
                        else if(nomeT.includes("Repsol")) {
                            resPerfil[nomeT]['S'].c += price * weight; resPerfil[nomeT]['S'].w += weight;
                        }
                        else {
                            if(colCiclo === "Simp") { resPerfil[nomeT]['S'].c += price * weight; resPerfil[nomeT]['S'].w += weight; }
                            else if(period) { resPerfil[nomeT][period].c += price * weight; resPerfil[nomeT][period].w += weight; }
                        }
                    }
                });
            }

            const fecharMedias = (mapa) => {
                let final = {};
                for (let nomeT in mapa) {
                    final[nomeT] = {};
                    if(nomeT.includes("Repsol")) {
                        let p = mapa[nomeT]['S'].w > 0 ? mapa[nomeT]['S'].c / mapa[nomeT]['S'].w : 0;
                        ['S','V','F','P','C'].forEach(k => final[nomeT][k] = p);
                    } else {
                        ['S','V','F','P','C'].forEach(k => {
                            let d = mapa[nomeT][k];
                            final[nomeT][k] = d.w > 0 ? d.c / d.w : 0;
                        });
                    }
                }
                return final;
            };

            return {
                perfil: fecharMedias(resPerfil),
                diagrama: temDadosDiagrama ? fecharMedias(resDiagrama) : null
            };
        }
        // --- FUN√á√ÉO PARA MODO MANUAL QH (Usa compara√ß√£o de String para evitar erro de fuso hor√°rio) ---
        function calculateManualQH(omieValues, ciclo) {
            let colCiclo = "Simp";
            if(ciclo.includes("Bi")) colCiclo = ciclo.includes("Di√°rio") ? "BD" : "BS";
            if(ciclo.includes("Tri")) colCiclo = ciclo.includes("Di√°rio") ? "TD" : "TS";
            
            let mapResults = {}; 
            DATA.indexados.forEach(t => {
                if (t['tipo'] === 'Indexado quarto-hor√°rio' || (t['nome'] && t['nome'].includes('BTN SPOTDEF'))) {
                    mapResults[t['nome']] = { S:{c:0,w:0}, V:{c:0,w:0}, F:{c:0,w:0}, P:{c:0,w:0}, C:{c:0,w:0} };
                }
            });
            
            // Usar strings YYYY-MM-DD em vez de objetos Date
            const d1Str = document.getElementById('d_inicio').value;
            const d2Str = document.getElementById('d_fim').value;
            
            const dias = parseInt(document.getElementById('num_dias').value);
            const pot = parseFloat(document.getElementById('potencia').value);
            const kwh = { 
                S: parseFloat(document.getElementById('kwh_S')?document.getElementById('kwh_S').value:0)||0,
                V: parseFloat(document.getElementById('kwh_V')?document.getElementById('kwh_V').value:0)||0,
                F: parseFloat(document.getElementById('kwh_F')?document.getElementById('kwh_F').value:0)||0,
                P: parseFloat(document.getElementById('kwh_P')?document.getElementById('kwh_P').value:0)||0,
                C: parseFloat(document.getElementById('kwh_C')?document.getElementById('kwh_C').value:0)||0
            };
            const totalKwh = kwh.S+kwh.V+kwh.F+kwh.P+kwh.C;
            const perfilBTN = obter_perfil(totalKwh, dias, pot);
            
            DATA.omie.forEach(row => {
                // Usar a fun√ß√£o parseDateFromDB para ler corretamente MM/DD/YYYY da base de dados
                const rowDateStr = parseDateFromDB(row['Data']);
                if(!rowDateStr) return;
                
                // Compara√ß√£o robusta de strings (evita o bug do dia 1)
                if(rowDateStr < d1Str || rowDateStr > d2Str) return;

                let period = null;
                if(colCiclo !== "Simp") {
                    period = row[colCiclo];
                    if (!period) return;
                }
                
                let omieValManual = 0;
                if(ciclo.includes("Simples")) omieValManual = omieValues['S'] || 0;
                else if(period === 'V') omieValManual = omieValues['V'] || 0;
                else if(period === 'F') omieValManual = omieValues['F'] || 0;
                else if(period === 'C') omieValManual = omieValues['C'] || 0;
                else if(period === 'P') omieValManual = omieValues['P'] || 0;
                else omieValManual = omieValues['S'] || 0;
                
                let omieVal = omieValManual / 1000;
                let perdasVal = parseFloat(String(row['Perdas']).replace(',','.'));
                let perfilWeight = parseFloat(String(row[perfilBTN] || 0).replace(',','.'));

                for (let nomeT in mapResults) {
                     let price = 0;
                    if(nomeT.includes("Coop√©rnico Base 2.0")) price = (omieVal + getConst('Coop_CS_CR') + getConst('Coop_K')) * perdasVal;
                    else if(nomeT.includes("Repsol - Leve Sem Mais")) price = (omieVal * perdasVal * getConst('Repsol_FA') + getConst('Repsol_Q_Tarifa'));
                    else if(nomeT.includes("Repsol - Leve PRO Sem Mais")) price = (omieVal * perdasVal * getConst('Repsol_FA') + getConst('Repsol_Q_Tarifa_Pro'));
                    else if(nomeT.includes("Galp - Plano Flex√≠vel")) price = (omieVal + getConst('Galp_Ci')) * perdasVal;
                    else if(nomeT.includes("Alfa Energia - ALFA POWER")) price = ((omieVal + getConst('Alfa_CGS')) * perdasVal + getConst('Alfa_K'));
                    else if(nomeT.includes("Plenitude - Tend√™ncia")) price = (((omieVal + getConst('Plenitude_CGS') + getConst('Plenitude_GDOs'))) * perdasVal + getConst('Plenitude_Fee'));
                    else if(nomeT.includes("Meo Energia - Tarifa Vari√°vel")) price = (omieVal + getConst('Meo_K')) * perdasVal;
                    else if(nomeT.includes("EDP - Eletricidade Indexada Hor√°ria")) price = (omieVal * perdasVal * getConst('EDP_H_K1') + getConst('EDP_H_K2'));
                    else if(nomeT.includes("EZU - Indexada")) price = (omieVal + getConst('EZU_K') + getConst('EZU_CGS')) * perdasVal;
                    else if(nomeT.includes("G9 - Smart Dynamic")) price = (omieVal * getConst('G9_FA') * perdasVal + getConst('G9_CGS') + getConst('G9_AC'));
                    else if(nomeT.includes("Iberdrola - Simples Indexado Din√¢mico")) price = (omieVal * perdasVal + getConst('Iberdrola_Dinamico_Q') + getConst('Iberdrola_mFRR'));
                    else if(nomeT.includes("BTN SPOTDEF")) {
                        let cgs = getConst('Luzboa_CGS'), fa = getConst('Luzboa_FA'), kp = getConst('Luzboa_Kp');
                        price = (omieVal + cgs) * perdasVal * fa + kp;
                    }
                    else price = omieVal * perdasVal + 0.01;

                    if(nomeT.includes("BTN SPOTDEF")) {
                        if(colCiclo === "Simp") { mapResults[nomeT]['S'].c += price; mapResults[nomeT]['S'].w += 1; }
                        else if(period) { mapResults[nomeT][period].c += price; mapResults[nomeT][period].w += 1; }
                    }
                    else if(nomeT.includes("Repsol")) {
                        mapResults[nomeT]['S'].c += price * perfilWeight; mapResults[nomeT]['S'].w += perfilWeight;
                    } else {
                        if(colCiclo === "Simp") { mapResults[nomeT]['S'].c += price * perfilWeight; mapResults[nomeT]['S'].w += perfilWeight; }
                        else if(period) { mapResults[nomeT][period].c += price * perfilWeight; mapResults[nomeT][period].w += perfilWeight; }
                    }
                }
            });
            
            let finalPrices = {};
            for (let nomeT in mapResults) {
                finalPrices[nomeT] = {};
                if(nomeT.includes("Repsol")) {
                    let p = mapResults[nomeT]['S'].w > 0 ? mapResults[nomeT]['S'].c / mapResults[nomeT]['S'].w : 0;
                    ['S','V','F','P','C'].forEach(k => finalPrices[nomeT][k] = p);
                } else {
                    ['S','V','F','P','C'].forEach(k => {
                        let d = mapResults[nomeT][k];
                        finalPrices[nomeT][k] = d.w > 0 ? d.c / d.w : 0;
                    });
                }
            }
            return finalPrices;
        }
        
        function calcular() {
            if(!DATA.fixos.length) return;

            // 1. GEST√ÉO DE DADOS E-REDES (S√ì NA ABA AVAN√áADA)
            // Se estiver na Aba 2 (Complete), este bloco √© saltado, permitindo simula√ß√£o livre.
            if (CURRENT_TAB === 'advanced' && DADOS_EREDES && DADOS_EREDES.dadosBrutos) {
                
                // Na aba avan√ßada, as datas s√£o controladas pelo ficheiro, mas o user pode filtrar dentro dele
                const d1Val = new Date(document.getElementById('d_inicio').value);
                const d2Val = new Date(document.getElementById('d_fim').value);
                const tsInicio = d1Val.getTime(); 
                const tsFim = d2Val.getTime() + 86399999; 
                
                const dadosFiltrados = DADOS_EREDES.dadosBrutos.filter(r => r.Ts >= tsInicio && r.Ts <= tsFim);

                if (dadosFiltrados.length > 0) {
                    const novosConsumos = agregarConsumosPorPeriodo(dadosFiltrados);
                    const novasMedias = calcularMediasOMIE(null); 
                    
                    // Atualizar campos de consumo DOM com valores do FICHEIRO
                    const cicloAtual = document.getElementById('ciclo').value;
                    if(cicloAtual.includes("Simples")) {
                        const el = document.getElementById('kwh_S');
                        if(el) el.value = Math.round(novosConsumos.Simples * 100) / 100;
                    } else if(cicloAtual.includes("Bi")) {
                        const colCons = cicloAtual.includes("Di√°rio") ? novosConsumos.BD : novosConsumos.BS;
                        const elV = document.getElementById('kwh_V');
                        const elF = document.getElementById('kwh_F');
                        if(elV) elV.value = Math.round(colCons.V * 100) / 100;
                        if(elF) elF.value = Math.round(colCons.F * 100) / 100;
                    } else {
                        const colCons = cicloAtual.includes("Di√°rio") ? novosConsumos.TD : novosConsumos.TS;
                        const elV = document.getElementById('kwh_V');
                        const elP = document.getElementById('kwh_P');
                        const elC = document.getElementById('kwh_C');
                        if(elV) elV.value = Math.round(colCons.V * 100) / 100;
                        if(elP) elP.value = Math.round(colCons.P * 100) / 100;
                        if(elC) elC.value = Math.round(colCons.C * 100) / 100;
                    }
                    
                    // Atualizar OMIE_VALUES com base no FICHEIRO REAL
                    if(novasMedias.S) {
                        OMIE_VALUES.S = novasMedias.S;
                        OMIE_VALUES.BD_V = novasMedias.BD_V || novasMedias.S; OMIE_VALUES.BD_F = novasMedias.BD_F || novasMedias.S;
                        OMIE_VALUES.BS_V = novasMedias.BS_V || novasMedias.S; OMIE_VALUES.BS_F = novasMedias.BS_F || novasMedias.S;
                        OMIE_VALUES.TD_V = novasMedias.TD_V || novasMedias.S; OMIE_VALUES.TD_C = novasMedias.TD_C || novasMedias.S; OMIE_VALUES.TD_P = novasMedias.TD_P || novasMedias.S;
                        OMIE_VALUES.TS_V = novasMedias.TS_V || novasMedias.S; OMIE_VALUES.TS_C = novasMedias.TS_C || novasMedias.S; OMIE_VALUES.TS_P = novasMedias.TS_P || novasMedias.S;
                        
                        OMIE_MANUAL = false; 
                        const omiePanel = document.getElementById('omie-panel');
                        if(omiePanel) omiePanel.classList.add('hidden');
                    }
                    
                    // Mostrar tabela de an√°lise
                    const tabelaHTML = criarTabelaAnalise(novosConsumos, novasMedias);
                    const divAnalise = document.getElementById('analise-content');
                    if(divAnalise) divAnalise.innerHTML = tabelaHTML;
                }
            } else {
                // ABA 2 (OU R√ÅPIDA): Recalcular OMIE com base nas datas dos inputs (Simula√ß√£o)
                // Se n√£o estivermos a usar dados E-Redes diretos, o OMIE tem de vir do calend√°rio
                if(!OMIE_MANUAL) {
                    // Reseta para calcular via fun√ß√£o getOmieAvg que olha para d_inicio/d_fim
                    // Isto permite mudar para 2026 e obter a m√©dia de 2026 (se existir na BD)
                    let colExcel = "Simp";
                    const c = document.getElementById('ciclo').value;
                    if(c.includes("Bi")) colExcel = c.includes("Di√°rio") ? "BD" : "BS";
                    if(c.includes("Tri")) colExcel = c.includes("Di√°rio") ? "TD" : "TS";

                    OMIE_VALUES.S = getOmieAvg("Simp", "S");
                    if(c.includes("Bi")) { 
                        OMIE_VALUES.V = getOmieAvg(colExcel, "V"); OMIE_VALUES.F = getOmieAvg(colExcel, "F"); 
                    } else if(c.includes("Tri")) { 
                        OMIE_VALUES.V = getOmieAvg(colExcel, "V"); OMIE_VALUES.P = getOmieAvg(colExcel, "P"); OMIE_VALUES.C = getOmieAvg(colExcel, "C"); 
                    }
                    
                    // Atualiza texto visual
                    let omieHtml = "";
                    if(c.includes("Simples")) omieHtml = `S: ${OMIE_VALUES.S.toFixed(2)}`;
                    else if(c.includes("Bi")) omieHtml = `V: ${OMIE_VALUES.V.toFixed(2)} | F: ${OMIE_VALUES.F.toFixed(2)}`;
                    else omieHtml = `V: ${OMIE_VALUES.V.toFixed(2)} | P: ${OMIE_VALUES.P.toFixed(2)} | C: ${OMIE_VALUES.C.toFixed(2)}`;
                    
                    const disp = document.getElementById('omie-display');
                    if(disp) disp.innerText = omieHtml;
                }
            }

            // 2. PERDAS E INPUTS
            const d1Str = document.getElementById('d_inicio').value;
            const d2Str = document.getElementById('d_fim').value;
            calcularPerdasDinamicas(new Date(d1Str), new Date(d2Str), document.getElementById('ciclo').value);

            const pot = parseFloat(document.getElementById('potencia').value);
            const ciclo = document.getElementById('ciclo').value;
            const dias = parseInt(document.getElementById('num_dias').value);
            const famNum = document.getElementById('familia_numerosa').checked;
            const tarifaSocial = document.getElementById('tarifa_social').checked;
            const incluirACP = document.getElementById('quota_acp').checked;
            const ocultarEDP = document.getElementById('ocultar_edp_h').checked;
            const cavUser = parseFloat(document.getElementById('cav_valor').value) || 2.85;
            const dgegUser = parseFloat(document.getElementById('dgeg_valor').value) || 0.07;
            
            const kwh = { 
                S: parseFloat(document.getElementById('kwh_S')?.value)||0,
                V: parseFloat(document.getElementById('kwh_V')?.value)||0,
                F: parseFloat(document.getElementById('kwh_F')?.value)||0,
                P: parseFloat(document.getElementById('kwh_P')?.value)||0,
                C: parseFloat(document.getElementById('kwh_C')?.value)||0
            };
            const totalKwh = kwh.S+kwh.V+kwh.F+kwh.P+kwh.C;

            // 3. OMIE (MANUAL OU AUTOM√ÅTICO)
            let colExcel = "Simp";
            if(ciclo.includes("Bi")) colExcel = ciclo.includes("Di√°rio") ? "BD" : "BS";
            if(ciclo.includes("Tri")) colExcel = ciclo.includes("Di√°rio") ? "TD" : "TS";

            if(!OMIE_MANUAL) {
                OMIE_VALUES.S = getOmieAvg("Simp", "S");
                if(ciclo.includes("Simples")) {
                } else if(ciclo.includes("Bi")) { 
                    OMIE_VALUES.V = getOmieAvg(colExcel, "V"); OMIE_VALUES.F = getOmieAvg(colExcel, "F"); 
                } else { 
                    OMIE_VALUES.V = getOmieAvg(colExcel, "V"); OMIE_VALUES.P = getOmieAvg(colExcel, "P"); OMIE_VALUES.C = getOmieAvg(colExcel, "C"); 
                }
                
                let omieHtml = "";
                if(ciclo.includes("Simples")) omieHtml = `S: ${OMIE_VALUES.S.toFixed(2)}`;
                else if(ciclo.includes("Bi")) omieHtml = `V: ${OMIE_VALUES.V.toFixed(2)} | F: ${OMIE_VALUES.F.toFixed(2)}`;
                else omieHtml = `V: ${OMIE_VALUES.V.toFixed(2)} | P: ${OMIE_VALUES.P.toFixed(2)} | C: ${OMIE_VALUES.C.toFixed(2)}`;
                
                document.getElementById('omie-display').innerText = omieHtml;
                const omiePanel = document.getElementById('omie-panel');
                if(omiePanel && CURRENT_TAB !== 'advanced') omiePanel.classList.remove('hidden');
                else if(omiePanel) omiePanel.classList.add('hidden');
                
                construirInputsOMIE(ciclo);
            }

            // 4. C√ÅLCULO PRE√áOS QH
            let detailedQHResults = {};
            if(!OMIE_MANUAL) {
                const perfilBTN = obter_perfil(totalKwh, dias, pot);
                detailedQHResults = calculateDetailedQH(d1Str, d2Str, perfilBTN, ciclo);
            } else {
                // Modo manual n√£o tem diagrama, retorna estrutura simples
                detailedQHResults = calculateManualQH(OMIE_VALUES, ciclo);
            }

            // 5. C√ÅLCULO FINAL DE CUSTOS
            const tarPotRegBase = getConst(`TAR_Potencia ${pot}`);
            const tseVal = getConst("Financiamento_TSE");
            let iecVal = getConst("IEC");
            const quotaACP = getConst("Quota_ACP");
            
            let descTarifaSocialEn = 0;
            let descTarifaSocialPot = 0;
            if(tarifaSocial && pot <= 6.9) {
                descTarifaSocialEn = getConst("Desconto TS Energia");
                descTarifaSocialPot = getConst(`Desconto TS Potencia ${pot}`);
                iecVal = 0; 
            }
            
            let tarEnBase = { S:0, V:0, F:0, P:0, C:0 };
            if(ciclo.includes("Simples")) tarEnBase.S = getConst("TAR_Energia_Simples");
            else if(ciclo.includes("Bi")) { tarEnBase.V = getConst("TAR_Energia_Bi_Vazio"); tarEnBase.F = getConst("TAR_Energia_Bi_ForaVazio"); }
            else { 
                let pfx = pot > 20.7 ? "TAR_Energia_Tri_27.6_" : "TAR_Energia_Tri_";
                tarEnBase.V = getConst(pfx+"Vazio"); tarEnBase.P = getConst(pfx+"Ponta"); tarEnBase.C = getConst(pfx+"Cheias");
            }

            let tarEnFinal = { 
                S: tarEnBase.S - descTarifaSocialEn, V: tarEnBase.V - descTarifaSocialEn, 
                F: tarEnBase.F - descTarifaSocialEn, P: tarEnBase.P - descTarifaSocialEn, 
                C: tarEnBase.C - descTarifaSocialEn 
            };
            const tarPotRegFinal = tarPotRegBase - descTarifaSocialPot;

            const fSeg = document.getElementById('f_segmento').value;
            const fFat = document.getElementById('f_fatura').value;
            const fPag = document.getElementById('f_pagamento').value;
            const selTypes = Array.from(document.querySelectorAll('.chk-tipo:checked')).map(c=>c.value);

            let results = [];

            const processTarifarios = (list, isIndexado, cols) => {
                list.forEach(r => {
                    if(Math.abs(getVal(r, 'pot', cols) - pot) > 0.1) return;
                    if(!(r[cols.ciclo]||"").toLowerCase().includes(ciclo.toLowerCase())) return;
                    
                    let nomeOriginal = r['nome'] || "";
                    if(ocultarEDP && nomeOriginal.includes("EDP - Eletricidade Indexada Hor√°ria")) return;

                    const segExcel = r[cols.seg] || "";
                    if(fSeg === "Residencial" && segExcel !== "Dom√©stico" && segExcel !== "Dom√©stico e N√£o Dom√©stico") return;
                    if(fSeg === "Empresarial" && segExcel !== "N√£o Dom√©stico" && segExcel !== "Dom√©stico e N√£o Dom√©stico") return;

                    const fatExcel = r[cols.fat] || "";
                    if(fFat === "Fatura eletr√≥nica" && !fatExcel.includes("Fatura eletr√≥nica")) return;
                    if(fFat === "Fatura em papel" && !fatExcel.includes("Fatura em papel")) return;

                    const pagExcel = r[cols.pag] || "";
                    if(fPag === "D√©bito Direto" && !pagExcel.includes("D√©bito Direto")) return;
                    if(fPag === "Multibanco" && !pagExcel.includes("Multibanco")) return;
                    if(fPag === "Numer√°rio/Payshop/CTT" && !pagExcel.includes("Numer√°rio") && !pagExcel.includes("Payshop") && !pagExcel.includes("CTT")) return;

                    let tipo = r[cols.tipo] || (isIndexado ? "Indexado M√©dia" : "Fixo");
                    tipo = tipo.trim();
                    if(!selTypes.includes(tipo)) return;
                    
                    // === FILTRO DE COMERCIALIZADORES EXCLU√çDOS (ABA 2 e ABA 3) ===
                    const comercializadorFiltro = r['comercializador'] || "";
                    if(CURRENT_TAB === 'complete' && STATE_ABA2.excludedProviders.includes(comercializadorFiltro)) return;
                    if(CURRENT_TAB === 'advanced' && STATE_ABA3.excludedProviders.includes(comercializadorFiltro)) return;

                    // --- VARIANTES (PERFIL vs DIAGRAMA) ---
                    let variantes = [];
                    // Se for Indexado QH e tivermos a estrutura {perfil:..., diagrama:...}
                    if (isIndexado && tipo === "Indexado quarto-hor√°rio" && detailedQHResults.perfil) {
                        variantes.push({ suffix: " - Perfil", source: detailedQHResults.perfil, tipoExtra: " - Perfil" });
                        if (detailedQHResults.diagrama) {
                            variantes.push({ suffix: " - Diagrama", source: detailedQHResults.diagrama, tipoExtra: " - Diagrama" });
                        }
                    } else {
                        // Caso contr√°rio (Fixo, Manual ou estrutura simples), usa o objeto direto
                        let source = detailedQHResults.perfil ? detailedQHResults.perfil : detailedQHResults; 
                        variantes.push({ suffix: "", source: source, tipoExtra: "" });
                    }

                    variantes.forEach(variant => {
                        let nomeT = nomeOriginal + variant.suffix;
                        let tipoDisplay = tipo + variant.tipoExtra;
                        const comercializador = r['comercializador'] || "";

                        let precoPotExcel = getVal(r, 'fixo', cols); 
                        let tarPIncl = parseBool(r[cols.tar_p_incl]);
                        if(tarPIncl === undefined) tarPIncl = !isIndexado;
                        
                        let potComercial = tarPIncl ? precoPotExcel - tarPotRegBase : precoPotExcel;
                        let potFinalDia = potComercial + tarPotRegFinal;
                        
                        let tarEIncl = parseBool(r[cols.tar_e_incl]);
                        if(tarEIncl === undefined) tarEIncl = !isIndexado;
                        let tseIncl = parseBool(r[cols.tse_incl]);
                        if(tseIncl === undefined) tseIncl = true;

                        let uS=0, uV=0, uF=0, uP=0, uC=0;
                        let breakdown = { S:{}, V:{}, F:{}, P:{}, C:{} };
                        
                        let omieKwh = { S: OMIE_VALUES.S/1000, V: OMIE_VALUES.V/1000, F: OMIE_VALUES.F/1000, P: OMIE_VALUES.P/1000, C: OMIE_VALUES.C/1000 };

                        const calcPeriod = (baseInput, tarRegBase, tarRegFinal, period) => {
                            let precoBase = baseInput;
                            if(isIndexado) {
                                if(tipo === "Indexado quarto-hor√°rio") {
                                    // Buscar pre√ßo na fonte correta (variant.source)
                                    if(variant.source[nomeOriginal]) precoBase = variant.source[nomeOriginal][period] || 0;
                                } else {
                                    // Indexado M√©dia
                                    let omieVal = omieKwh[period];
                                    let omieSimples = omieKwh['S'];
                                    let colCiclo = "S";
                                    if(ciclo.includes("Bi")) colCiclo = ciclo.includes("Di√°rio") ? "BD" : "BS";
                                    else if(ciclo.includes("Tri")) colCiclo = ciclo.includes("Di√°rio") ? "TD" : "TS";
                                    
                                    let perdasAnual = 1.0;
                                    let perdasMensal = 1.16;
                                    
                                    if(ciclo.includes("Simples")) {
                                        perdasAnual = getPerdas('Perdas_Anual_S') || 1.0; perdasMensal = getPerdas('Perdas_M_S') || 1.16;
                                    } else {
                                        perdasAnual = getPerdas(`Perdas_Anual_${colCiclo}_${period}`) || 1.0;
                                        perdasMensal = getPerdas(`Perdas_M_${colCiclo}_${period}`) || 1.16;
                                    }
                                    
                                    if(nomeOriginal.includes("BTN SPOTDEF")) {
                                        if(variant.source[nomeOriginal] && variant.source[nomeOriginal][period] !== undefined) precoBase = variant.source[nomeOriginal][period];
                                        else {
                                            let cgs = getConst('Luzboa_CGS'), fa = getConst('Luzboa_FA'), kp = getConst('Luzboa_Kp');
                                            precoBase = (omieVal + cgs) * perdasAnual * fa + kp;
                                        }
                                    } else if(nomeOriginal.includes("Iberdrola")) {
                                        precoBase = omieVal * getConst('Iberdrola_Perdas') + getConst("Iberdrola_Media_Q") + getConst('Iberdrola_mFRR');
                                    } else if(nomeOriginal.includes("Goldenergy")) {
                                        const perdasMensaisGE = {1: 1.29, 2: 1.18, 3: 1.18, 4: 1.15, 5: 1.11, 6: 1.10, 7: 1.15, 8: 1.13, 9: 1.10, 10: 1.10, 11: 1.16, 12: 1.25};
                                        const d1 = new Date(document.getElementById('d_inicio').value);
                                        const perdasMes = perdasMensaisGE[d1.getMonth() + 1] || 1.16;
                                        precoBase = omieVal * perdasMes + getConst('GE_Q_Tarifa') + getConst('GE_CG');
                                    } else if(nomeOriginal.includes("Endesa")) {
                                        let periodoEndesa = period === 'F' ? 'FV' : period;
                                        precoBase = omieVal + getConst(`Endesa_A_${periodoEndesa}`);
                                    } else if(nomeOriginal.includes("LUZiG√ÅS - Energy 8.8")) {
                                        precoBase = (omieSimples + getConst('Luzigas_8_8_K') + getConst('Luzigas_CGS')) * perdasAnual;
                                    } else if(nomeOriginal.includes("LUZiG√ÅS - Super Lig Index")) {
                                        precoBase = (omieSimples + getConst('Luzigas_K') + getConst('Luzigas_CGS')) * perdasAnual;
                                    } else if(nomeOriginal.includes("Ibelectra - Solu√ß√£o Fam√≠lia")) {
                                        precoBase = (omieVal + getConst('Ibelectra_CS')) * perdasAnual + getConst('Ibelectra_K');
                                    } else if(nomeOriginal.includes("Ibelectra - Solu√ß√£o Amigo")) {
                                        precoBase = (omieVal + getConst('Ibelectra_CS')) * perdasAnual + getConst('Ibelectra_K_a');                
                                    } else if(nomeOriginal.includes("G9 - Smart Index")) {
                                        precoBase = (omieVal * getConst('G9_FA') * perdasMensal) + getConst('G9_CGS') + getConst('G9_AC');
                                    } else if(nomeOriginal.includes("EDP - Eletricidade Indexada M√©dia")) {
                                        precoBase = omieVal * getConst('EDP_M_Perdas') * getConst('EDP_M_K1') + getConst('EDP_M_K2');
                                    } else {
                                        precoBase = omieVal + 0.02; 
                                    }
                                }
                            }

                            let comSemTar = tarEIncl ? precoBase - tarRegBase : precoBase;
                            let tarVal = tarRegFinal;
                            let tseValFinal = tseIncl ? 0 : tseVal;
                            
                            let finalPrice = comSemTar + tarVal + tseValFinal;
                            breakdown[period] = { comercialSemTar: comSemTar, tarValue: tarVal, tse: tseValFinal, tarIncluded: tarEIncl, tseIncluded: tseIncl };
                            return finalPrice;
                        };

                        if(ciclo.includes("Simples")) {
                            let p = isIndexado ? 0 : getVal(r, 'pS', cols);
                            uS = calcPeriod(p, tarEnBase.S, tarEnFinal.S, 'S');
                        } else if(ciclo.includes("Bi")) {
                            let pV = isIndexado ? 0 : (getVal(r, 'pV_bi', cols) || getVal(r, 'pS', cols));
                            let pF = isIndexado ? 0 : (getVal(r, 'pF', cols) || getVal(r, 'pS', cols));
                            uV = calcPeriod(pV, tarEnBase.V, tarEnFinal.V, 'V');
                            uF = calcPeriod(pF, tarEnBase.F, tarEnFinal.F, 'F');
                        } else {
                            let pV = isIndexado ? 0 : (getVal(r, 'pV_tri', cols) || getVal(r, 'pS', cols));
                            let pP = isIndexado ? 0 : (getVal(r, 'pP', cols) || getVal(r, 'pF', cols) || getVal(r, 'pS', cols));
                            let pC = isIndexado ? 0 : (getVal(r, 'pC', cols) || getVal(r, 'pF', cols) || getVal(r, 'pS', cols));
                            uV = calcPeriod(pV, tarEnBase.V, tarEnFinal.V, 'V');
                            uP = calcPeriod(pP, tarEnBase.P, tarEnFinal.P, 'P');
                            uC = calcPeriod(pC, tarEnBase.C, tarEnFinal.C, 'C');
                        }

                        let costPotComercial = potComercial * dias;
                        let costPotTar = tarPotRegFinal * dias;
                        let costPot6 = 0, costPot23 = 0;
                        if(pot <= 3.45) { costPot6 = costPotTar; costPot23 = costPotComercial; } 
                        else { costPot23 = costPotComercial + costPotTar; }
                        let taxPot6 = costPot6 * 0.06; let taxPot23 = costPot23 * 0.23;
                        
                        let costEn = 0;
                        if(ciclo.includes("Simples")) costEn = uS * kwh.S;
                        else if(ciclo.includes("Bi")) costEn = uV*kwh.V + uF*kwh.F;
                        else costEn = uV*kwh.V + uP*kwh.P + uC*kwh.C;

                        let limit6 = famNum ? 300 : 200;
                        let dailyLim = (limit6 / 30) * dias;
                        let costEn6 = 0, costEn23 = 0, taxEn6 = 0, taxEn23 = 0;
                        
                        if(pot <= 6.9) {
                            if(ciclo.includes("Simples")) {
                                let kwhRed = Math.min(totalKwh, dailyLim);
                                let kwhNorm = Math.max(0, totalKwh - dailyLim);
                                let avgPrice = totalKwh ? costEn/totalKwh : 0;
                                costEn6 = kwhRed * avgPrice; costEn23 = kwhNorm * avgPrice;
                            } else {
                                let consumos = ciclo.includes("Bi") ? { V: kwh.V, F: kwh.F } : { V: kwh.V, P: kwh.P, C: kwh.C };
                                let custos = ciclo.includes("Bi") ? { V: uV * kwh.V, F: uF * kwh.F } : { V: uV * kwh.V, P: uP * kwh.P, C: uC * kwh.C };
                                let costEn6Total = 0, costEn23Total = 0;
                                for(let p in consumos) {
                                    let prop = totalKwh > 0 ? consumos[p] / totalKwh : 0;
                                    let lim = dailyLim * prop;
                                    let cred = Math.min(consumos[p], lim);
                                    let cnorm = Math.max(0, consumos[p] - lim);
                                    let unit = consumos[p] > 0 ? custos[p] / consumos[p] : 0;
                                    costEn6Total += cred * unit; costEn23Total += cnorm * unit;
                                }
                                costEn6 = costEn6Total; costEn23 = costEn23Total;
                            }
                            taxEn6 = costEn6 * 0.06; taxEn23 = costEn23 * 0.23;
                        } else {
                            costEn23 = costEn; taxEn23 = costEn23 * 0.23;
                        }
                        
                        let cavVal;
                        if(CAV_FIXO_COMERCIALIZADORES.some(c => comercializador.includes(c))) {
                            if (dias >= 28 && dias <= 32) cavVal = cavUser;
                            else cavVal = (cavUser * 12 / 365.25) * dias;
                        } else { cavVal = (cavUser * 12 / 365.25) * dias; }

                        let iec = totalKwh * iecVal;
                        let dgeg = (dias >= 28 && dias <= 32) ? dgegUser : (dgegUser * dias / 30);
                        let taxIEC = iec * 0.23; let taxDGEG = dgeg * 0.23; let taxCAV = cavVal * 0.06;

                        let total = (costPot6 + costPot23 + taxPot6 + taxPot23) + (costEn6 + costEn23 + taxEn6 + taxEn23) + (iec + taxIEC + dgeg + taxDGEG + cavVal + taxCAV);

                        let desc = getVal(r, 'desc_fat', cols);
                        let descLimit = getVal(r, 'desc_limit', cols); 
                        let descFinal = 0;
                        
                        if(desc > 0) {
                            let descontoBase = (dias >= 28 && dias <= 32) ? desc : (desc * dias / 30);
                            let descTxt = "";
                            if(descLimit && descLimit > 0) {
                                let meses = (dias >= 28 && dias <= 32) ? 1 : (dias / 30);
                                if(meses > descLimit) descFinal = desc * descLimit; else descFinal = descontoBase;
                                descTxt = ` nos 1¬∫s ${descLimit} meses`;
                            } else { descFinal = descontoBase; }
                            
                            let totalSemDesconto = total;
                            total -= descFinal;
                            nomeT += ` (INCLUI desc.${desc.toFixed(2)}‚Ç¨/m√™s${descTxt}, s/ desc.=${totalSemDesconto.toFixed(2)}‚Ç¨)`;
                        }
                        
                        let quotaACPVal = 0;
                        if(incluirACP && nomeOriginal.startsWith("Goldenergy - ACP")) {
                            quotaACPVal = (dias >= 28 && dias <= 32) ? quotaACP : (quotaACP * dias / 30);
                            total += quotaACPVal;
                            nomeT += ` (INCLUI Quota ACP)`;
                        }
                        
                        results.push({
                            com: comercializador, nome: nomeT, tipo: tipoDisplay,
                            total: total, uS, uV, uF, uP, uC, uPot: potFinalDia,
                            breakdown: breakdown,
                            potDetails: { comercial: potComercial, tarPotValue: tarPotRegFinal, tarIncluded: tarPIncl },
                            details: {
                                costPot6, costPot23, costEn6, costEn23,
                                taxPot6, taxPot23, taxEn6, taxEn23,
                                iec, dgeg, cav: cavVal, taxIEC, taxDGEG, taxCAV,
                                desc: descFinal, quotaACP: quotaACPVal,
                                site: r[cols.site], notas: r[cols.notas]
                            }
                        });
                    });
                });
            };

            processTarifarios(DATA.fixos, false, COLS_FIXO);
            if(DATA.indexados && DATA.indexados.length > 0) processTarifarios(DATA.indexados, true, COLS_INDEX);
            
            if(document.getElementById('meu_ativo') && document.getElementById('meu_ativo').checked) {
                const meuTar = criarMeuTarifario(pot, ciclo, dias, kwh, totalKwh, tarEnBase, tarPotRegBase, tseVal, famNum, cavUser, iecVal, dgegUser, tarEnFinal, tarPotRegFinal);
                if(meuTar) results.push(meuTar);
            }
            
            if(document.getElementById('pers_ativo') && document.getElementById('pers_ativo').checked) {
                const persTar = criarTarifarioPersonalizado(pot, ciclo, dias, kwh, totalKwh, tarEnBase, tarPotRegBase, tseVal, famNum, cavUser, iecVal, dgegUser, tarEnFinal, tarPotRegFinal);
                if(persTar) results.push(persTar);
            }

            const fProcura = document.getElementById('f_procura') ? document.getElementById('f_procura').value.toLowerCase() : '';
            
            if (fProcura) {
                results = results.filter(r => {
                    // REGRA 1: Se for "O Meu Tarif√°rio" (Utilizador) ou "Personalizado", MANT√âM SEMPRE
                    if (r.tipo === 'Utilizador' || r.tipo === 'Personalizado') {
                        return true;
                    }
                    
                    // REGRA 2: Para os outros, aplica o filtro de texto normal
                    const textoCom = r.com ? r.com.toLowerCase() : '';
                    const textoNome = r.nome ? r.nome.toLowerCase() : '';
                    
                    return textoCom.includes(fProcura) || textoNome.includes(fProcura);
                });
            }
            results.sort((a,b) => SORT.asc ? a[SORT.col]-b[SORT.col] : b[SORT.col]-a[SORT.col]);

            window.GLOBAL_RESULTS = results;
            
            document.getElementById('res-count').innerText = `${results.length} tarifas`;
            if(results.length > 0) {
                atualizarResumoSimulacao();
                calcularMensagemPoupanca(results);
            }
            
            // === MODO DE COMPARA√á√ÉO ENTRE OP√á√ïES HOR√ÅRIAS ===
            const modoComparacao = document.getElementById('modo_comparacao');
            const tituloTabela = document.getElementById('titulo-tabela');
            const btnExportar = document.getElementById('btn-exportar');
            const btnPartilhar = document.getElementById('btn-partilhar');
            if(modoComparacao && modoComparacao.checked) {
                if(tituloTabela) tituloTabela.textContent = 'Tiago Fel√≠cia - Compara√ß√£o de Custos entre Op√ß√µes Tarif√°rias';
                // Calcular e renderizar em modo compara√ß√£o
                const resultsComparacao = calcularModoComparacao(results, pot, ciclo, dias, kwh, totalKwh, tarEnBase, tarPotRegBase, tseVal, famNum, cavUser, iecVal, dgegUser, tarEnFinal, tarPotRegFinal);
                renderTableComparacao(resultsComparacao, ciclo);
                LAST_EXPORT_DATA = { mode: 'comparacao', data: resultsComparacao, results: results, ciclo: ciclo };
            } else {
                if(tituloTabela) tituloTabela.textContent = 'Tiago Fel√≠cia - Tarif√°rios de Eletricidade - Detalhado';
                // Renderiza√ß√£o normal
                renderTable(results, ciclo);
                LAST_EXPORT_DATA = { mode: 'detalhe', results: results, ciclo: ciclo };
                // Limpar sum√°rio de compara√ß√£o se existir
                const summaryDiv = document.getElementById('comparacao-summary');
                if(summaryDiv) summaryDiv.innerHTML = '';
            }
            // Mostrar bot√µes se h√° resultados
            if(btnExportar) btnExportar.style.display = results.length > 0 ? 'inline-block' : 'none';
            if(btnPartilhar) btnPartilhar.style.display = (results.length > 0 && CURRENT_TAB === 'complete') ? 'inline-block' : 'none';
            
            // === ATUALIZAR ELEMENTOS ESPEC√çFICOS DA ABA 3 ===
            if(CURRENT_TAB === 'advanced' && DADOS_EREDES) {
                atualizarAnalisePotencia();
                // Auto-regenerar gr√°ficos quando o ciclo/op√ß√£o muda
                const graficosContent = document.getElementById('graficos-analise-content');
                if(graficosContent && !graficosContent.classList.contains('collapsed')) {
                    gerarGraficosAnaliseERedes();
                }
            }
            
            // === ATUALIZAR GR√ÅFICO OMIE NA ABA 2 ===
            if(CURRENT_TAB === 'complete') {
                const omieContent = document.getElementById('grafico-omie-content');
                if(omieContent && !omieContent.classList.contains('collapsed')) {
                    gerarGraficoOMIEDiario();
                }
            }
        }        

        function criarMeuTarifario(pot, ciclo, dias, kwh, totalKwh, tarEnBase, tarPotRegBase, tseVal, famNum, cavUser, iecVal, dgegUser, tarEnFinal, tarPotRegFinal) {
            if(!document.getElementById('meu_pot')) return null;
            
            const meuPotInput = parseFloat(document.getElementById('meu_pot').value) || 0;
            const tarEnIncl = document.getElementById('meu_tar_en_incl').checked;
            const tarPotIncl = document.getElementById('meu_tar_pot_incl').checked;
            const tseIncl = document.getElementById('meu_tse_incl').checked;
            const descEn = parseFloat(document.getElementById('meu_desc_en').value) || 0;
            const descPot = parseFloat(document.getElementById('meu_desc_pot').value) || 0;
            const descFat = parseFloat(document.getElementById('meu_desc_fat').value) || 0;
            const acresFat = parseFloat(document.getElementById('meu_acres_fat').value) || 0;
            
            let uS = 0, uV = 0, uF = 0, uP = 0, uC = 0;
            let breakdown = { S:{}, V:{}, F:{}, P:{}, C:{} };
            
            const calcMeu = (precoInput, tarBase, tarFinal, period) => {
                // Se TAR inclu√≠da: desconto aplica-se sobre precoInput (que j√° tem TAR)
                // Se TAR N√ÉO inclu√≠da: desconto aplica-se sobre (precoInput + tarBase)
                let precoTotal = tarEnIncl ? precoInput : (precoInput + tarBase);
                let precoComDesconto = precoTotal * (1 - descEn/100);
                let comSemTar = precoComDesconto - tarBase;
                let final = comSemTar + tarFinal + (tseIncl ? 0 : tseVal);
                breakdown[period] = {
                    comercialSemTar: comSemTar, tarValue: tarFinal,
                    tse: (tseIncl ? 0 : tseVal), tarIncluded: tarEnIncl, tseIncluded: tseIncl
                };
                return final;
            };
            
            if(ciclo.includes("Simples")) {
                uS = calcMeu(parseFloat(document.getElementById('meu_S').value)||0, tarEnBase.S, tarEnFinal.S, 'S');
            } else if(ciclo.includes("Bi")) {
                uV = calcMeu(parseFloat(document.getElementById('meu_V').value)||0, tarEnBase.V, tarEnFinal.V, 'V');
                uF = calcMeu(parseFloat(document.getElementById('meu_F').value)||0, tarEnBase.F, tarEnFinal.F, 'F');
            } else {
                uV = calcMeu(parseFloat(document.getElementById('meu_V').value)||0, tarEnBase.V, tarEnFinal.V, 'V');
                uP = calcMeu(parseFloat(document.getElementById('meu_P').value)||0, tarEnBase.P, tarEnFinal.P, 'P');
                uC = calcMeu(parseFloat(document.getElementById('meu_C').value)||0, tarEnBase.C, tarEnFinal.C, 'C');
            }
            
            // Se TAR inclu√≠da: desconto aplica-se sobre meuPotInput (que j√° tem TAR)
            // Se TAR N√ÉO inclu√≠da: desconto aplica-se sobre (meuPotInput + tarPotRegBase)
            let potenciaTotal = tarPotIncl ? meuPotInput : (meuPotInput + tarPotRegBase);
            let pPotComDesconto = potenciaTotal * (1 - descPot/100);
            let pPotComercial = pPotComDesconto - tarPotRegBase;
            let potFinalDia = pPotComercial + tarPotRegFinal;
            
            let costPotComercial = pPotComercial * dias;
            let costPotTar = tarPotRegFinal * dias;
            let costPot6 = 0, costPot23 = 0, taxPot6 = 0, taxPot23 = 0;
            
            if(pot <= 3.45) {
                costPot6 = costPotTar; costPot23 = costPotComercial;
            } else {
                costPot23 = costPotComercial + costPotTar;
            }
            taxPot6 = costPot6 * 0.06; taxPot23 = costPot23 * 0.23;
            
            let costEn = 0;
            if(ciclo.includes("Simples")) costEn = uS * kwh.S;
            else if(ciclo.includes("Bi")) costEn = uV*kwh.V + uF*kwh.F;
            else costEn = uV*kwh.V + uP*kwh.P + uC*kwh.C;
            
            let limit6 = famNum ? 300 : 200;
            let dailyLim = (limit6 / 30) * dias;
            let costEn6 = 0, costEn23 = 0, taxEn6 = 0, taxEn23 = 0;
            
            if(pot <= 6.9) {
                let kwhRed = Math.min(totalKwh, dailyLim);
                let kwhNorm = Math.max(0, totalKwh - dailyLim);
                let avgPrice = totalKwh ? costEn/totalKwh : 0;
                costEn6 = kwhRed * avgPrice; costEn23 = kwhNorm * avgPrice;
                taxEn6 = costEn6 * 0.06; taxEn23 = costEn23 * 0.23;
            } else {
                costEn23 = costEn; taxEn23 = costEn23 * 0.23;
            }
            
            let cavVal = (cavUser * 12 / 365.25) * dias;
            let iec = totalKwh * iecVal;
            let dgeg = (dias >= 28 && dias <= 32) ? dgegUser : (dgegUser * dias / 30);
            let taxIEC = iec * 0.23; let taxDGEG = dgeg * 0.23; let taxCAV = cavVal * 0.06;
            
            let total = (costPot6+costPot23+taxPot6+taxPot23) + (costEn6+costEn23+taxEn6+taxEn23) + iec + taxIEC + dgeg + taxDGEG + cavVal + taxCAV - descFat + acresFat;
            
            // Construir nome com sufixo conforme l√≥gica Python
            let nomeMeuTarifario = "O Meu Tarif√°rio";
            let sufixoNome = "";
            
            // Converter para float, tratando valores nulos
            let desconto = parseFloat(descFat) || 0.0;
            let acrescimo = parseFloat(acresFat) || 0.0;
            
            if(desconto > 0 && acrescimo > 0) {
                // Cen√°rio 1: Ambos existem, calcular o valor l√≠quido
                let valorLiquido = desconto - acrescimo;
                
                if(valorLiquido > 0) {
                    // O desconto √© maior que o acr√©scimo -> Resultado final √© um Desconto
                    let custoSemAjuste = total + valorLiquido;
                    sufixoNome = ` (Inclui desconto l√≠quido de ${valorLiquido.toFixed(2)}‚Ç¨ no per√≠odo, s/ desc.=${custoSemAjuste.toFixed(2)}‚Ç¨)`;
                } else if(valorLiquido < 0) {
                    // O acr√©scimo √© maior que o desconto -> Resultado final √© um Acr√©scimo
                    let valorAcrescAbs = Math.abs(valorLiquido);
                    let custoSemAjuste = total - valorAcrescAbs;
                    sufixoNome = ` (Inclui acr√©scimo l√≠quido de ${valorAcrescAbs.toFixed(2)}‚Ç¨ no per√≠odo, s/ acr√©sc.=${custoSemAjuste.toFixed(2)}‚Ç¨)`;
                }
                // Se valorLiquido for 0, n√£o adicionamos sufixo
            } else if(desconto > 0) {
                // Cen√°rio 2: Apenas desconto existe
                let custoSemAjuste = total + desconto;
                sufixoNome = ` (Inclui desconto de ${desconto.toFixed(2)}‚Ç¨ no per√≠odo, s/ desc.=${custoSemAjuste.toFixed(2)}‚Ç¨)`;
            } else if(acrescimo > 0) {
                // Cen√°rio 3: Apenas acr√©scimo existe
                let custoSemAjuste = total - acrescimo;
                sufixoNome = ` (Inclui acr√©scimo de ${acrescimo.toFixed(2)}‚Ç¨ no per√≠odo, s/ acr√©sc.=${custoSemAjuste.toFixed(2)}‚Ç¨)`;
            }
            
            // Adicionar o sufixo calculado ao nome final
            nomeMeuTarifario += sufixoNome;
            
            return {
                com: "Utilizador", nome: nomeMeuTarifario, tipo: "Utilizador",
                total: total, uS, uV, uF, uP, uC, uPot: potFinalDia,
                breakdown: breakdown,
                potDetails: { comercial: pPotComercial, tarPotValue: tarPotRegFinal, tarIncluded: tarPotIncl },
                details: {
                    costPot6, costPot23, costEn6, costEn23,
                    taxPot6, taxPot23, taxEn6, taxEn23,
                    iec, dgeg, cav: cavVal, taxIEC, taxDGEG, taxCAV,
                    desc: descFat, quotaACP: 0, acrescimo: acresFat,
                    site: "", notas: ""
                }
            };
        }

        function criarTarifarioPersonalizado(pot, ciclo, dias, kwh, totalKwh, tarEnBase, tarPotRegBase, tseVal, famNum, cavUser, iecVal, dgegUser, tarEnFinal, tarPotRegFinal) {
            // Verificar se o tarif√°rio personalizado est√° ativo
            if(!document.getElementById('pers_ativo') || !document.getElementById('pers_ativo').checked) return null;
            
            // Obter as op√ß√µes comuns
            const tarEnIncl = document.getElementById('pers_tar_energia') ? document.getElementById('pers_tar_energia').checked : true;
            const tarPotIncl = document.getElementById('pers_tar_potencia') ? document.getElementById('pers_tar_potencia').checked : true;
            const tseIncl = document.getElementById('pers_tse_incluido') ? document.getElementById('pers_tse_incluido').checked : true;
            
            let uS = 0, uV = 0, uF = 0, uP = 0, uC = 0;
            let breakdown = { S:{}, V:{}, F:{}, P:{}, C:{} };
            let persPotInput = 0;
            
            const calcPers = (precoInput, tarBase, tarFinal, period) => {
                let comSemTar = tarEnIncl ? precoInput - tarBase : precoInput;
                let final = comSemTar + tarFinal + (tseIncl ? 0 : tseVal);
                breakdown[period] = {
                    comercialSemTar: comSemTar, tarValue: tarFinal,
                    tse: (tseIncl ? 0 : tseVal), tarIncluded: tarEnIncl, tseIncluded: tseIncl
                };
                return final;
            };
            
            // Obter os pre√ßos conforme a op√ß√£o hor√°ria
            if(ciclo.includes("Simples")) {
                const el = document.getElementById('pers_energia_s');
                if(el) {
                    uS = calcPers(parseFloat(el.value)||0, tarEnBase.S, tarEnFinal.S, 'S');
                }
                const potEl = document.getElementById('pers_potencia_s');
                if(potEl) persPotInput = parseFloat(potEl.value) || 0;
            } else if(ciclo.includes("Bi")) {
                const elV = document.getElementById('pers_energia_v_bi');
                const elF = document.getElementById('pers_energia_f_bi');
                if(elV) uV = calcPers(parseFloat(elV.value)||0, tarEnBase.V, tarEnFinal.V, 'V');
                if(elF) uF = calcPers(parseFloat(elF.value)||0, tarEnBase.F, tarEnFinal.F, 'F');
                const potEl = document.getElementById('pers_potencia_bi');
                if(potEl) persPotInput = parseFloat(potEl.value) || 0;
            } else {
                const elV = document.getElementById('pers_energia_v_tri');
                const elC = document.getElementById('pers_energia_c_tri');
                const elP = document.getElementById('pers_energia_p_tri');
                if(elV) uV = calcPers(parseFloat(elV.value)||0, tarEnBase.V, tarEnFinal.V, 'V');
                if(elC) uC = calcPers(parseFloat(elC.value)||0, tarEnBase.C, tarEnFinal.C, 'C');
                if(elP) uP = calcPers(parseFloat(elP.value)||0, tarEnBase.P, tarEnFinal.P, 'P');
                const potEl = document.getElementById('pers_potencia_tri');
                if(potEl) persPotInput = parseFloat(potEl.value) || 0;
            }
            
            // Calcular custo da pot√™ncia
            let pPotComercial = tarPotIncl ? persPotInput - tarPotRegBase : persPotInput;
            let potFinalDia = pPotComercial + tarPotRegFinal;
            
            let costPotComercial = pPotComercial * dias;
            let costPotTar = tarPotRegFinal * dias;
            let costPot6 = 0, costPot23 = 0, taxPot6 = 0, taxPot23 = 0;
            
            if(pot <= 3.45) {
                costPot6 = costPotTar; costPot23 = costPotComercial;
            } else {
                costPot23 = costPotComercial + costPotTar;
            }
            taxPot6 = costPot6 * 0.06; taxPot23 = costPot23 * 0.23;
            
            // Calcular custo da energia
            let costEn = 0;
            if(ciclo.includes("Simples")) costEn = uS * kwh.S;
            else if(ciclo.includes("Bi")) costEn = uV*kwh.V + uF*kwh.F;
            else costEn = uV*kwh.V + uP*kwh.P + uC*kwh.C;
            
            let limit6 = famNum ? 300 : 200;
            let dailyLim = (limit6 / 30) * dias;
            let costEn6 = 0, costEn23 = 0, taxEn6 = 0, taxEn23 = 0;
            
            if(pot <= 6.9) {
                let kwhRed = Math.min(totalKwh, dailyLim);
                let kwhNorm = Math.max(0, totalKwh - dailyLim);
                let avgPrice = totalKwh ? costEn/totalKwh : 0;
                costEn6 = kwhRed * avgPrice; costEn23 = kwhNorm * avgPrice;
                taxEn6 = costEn6 * 0.06; taxEn23 = costEn23 * 0.23;
            } else {
                costEn23 = costEn; taxEn23 = costEn23 * 0.23;
            }
            
            let cavVal = (cavUser * 12 / 365.25) * dias;
            let iec = totalKwh * iecVal;
            let dgeg = (dias >= 28 && dias <= 32) ? dgegUser : (dgegUser * dias / 30);
            let taxIEC = iec * 0.23; let taxDGEG = dgeg * 0.23; let taxCAV = cavVal * 0.06;
            
            let total = (costPot6+costPot23+taxPot6+taxPot23) + (costEn6+costEn23+taxEn6+taxEn23) + iec + taxIEC + dgeg + taxDGEG + cavVal + taxCAV;
            
            return {
                com: "Personalizado", nome: "Tarif√°rio Personalizado", tipo: "Personalizado",
                total: total, uS, uV, uF, uP, uC, uPot: potFinalDia,
                breakdown: breakdown,
                potDetails: { comercial: pPotComercial, tarPotValue: tarPotRegFinal, tarIncluded: tarPotIncl },
                details: {
                    costPot6, costPot23, costEn6, costEn23,
                    taxPot6, taxPot23, taxEn6, taxEn23,
                    iec, dgeg, cav: cavVal, taxIEC, taxDGEG, taxCAV,
                    desc: 0, quotaACP: 0, acrescimo: 0,
                    site: "", notas: "Tarif√°rio configurado pelo utilizador."
                }
            };
        }

        // ===== MODO DE COMPARA√á√ÉO ENTRE OP√á√ïES HOR√ÅRIAS =====
        function calcularModoComparacao(results, pot, cicloAtual, dias, kwhOriginal, totalKwhOriginal, tarEnBaseAtual, tarPotRegBase, tseVal, famNum, cavUser, iecValAtual, dgegUser, tarEnFinalAtual, tarPotRegFinal) {
            const isAba3 = (CURRENT_TAB === 'advanced' && DADOS_EREDES && DADOS_EREDES.consumosAgregados);
            const tarifaSocial = document.getElementById('tarifa_social').checked;
            const incluirACP = document.getElementById('quota_acp').checked;
            const ocultarEDP = document.getElementById('ocultar_edp_h').checked;
            const d1Str = document.getElementById('d_inicio').value;
            const d2Str = document.getElementById('d_fim').value;
            const fSeg = document.getElementById('f_segmento').value;
            const fFat = document.getElementById('f_fatura').value;
            const fPag = document.getElementById('f_pagamento').value;
            const selTypes = Array.from(document.querySelectorAll('.chk-tipo:checked')).map(c=>c.value);

            // 1. DETERMINAR OP√á√ïES DE DESTINO (ordem: Simples, Bi Di√°rio, Bi Semanal, Tri Di√°rio, Tri Semanal)
            let opcoesDestino = []; // {display, dbName}
            if(isAba3) {
                if(pot <= 20.7) {
                    opcoesDestino = [
                        {display: "Simples", dbName: "Simples"},
                        {display: "Bi Di√°rio", dbName: "Bi-hor√°rio - Ciclo Di√°rio"},
                        {display: "Bi Semanal", dbName: "Bi-hor√°rio - Ciclo Semanal"},
                        {display: "Tri Di√°rio", dbName: "Tri-hor√°rio - Ciclo Di√°rio"},
                        {display: "Tri Semanal", dbName: "Tri-hor√°rio - Ciclo Semanal"}
                    ];
                } else {
                    opcoesDestino = [
                        {display: "Simples", dbName: "Simples"},
                        {display: "Tri Di√°rio >20.7", dbName: "Tri-hor√°rio > 20.7 kVA - Ciclo Di√°rio"},
                        {display: "Tri Semanal >20.7", dbName: "Tri-hor√°rio > 20.7 kVA - Ciclo Semanal"}
                    ];
                }
            } else {
                const cicloTipo = cicloAtual.includes("Semanal") ? "Semanal" : "Di√°rio";
                if(pot <= 20.7) {
                    if(cicloAtual.includes("Tri")) {
                        opcoesDestino = [
                            {display: "Simples", dbName: "Simples"},
                            {display: "Bi-hor√°rio", dbName: `Bi-hor√°rio - Ciclo ${cicloTipo}`},
                            {display: "Tri-hor√°rio", dbName: `Tri-hor√°rio - Ciclo ${cicloTipo}`}
                        ];
                    } else if(cicloAtual.includes("Bi")) {
                        opcoesDestino = [
                            {display: "Simples", dbName: "Simples"},
                            {display: "Bi-hor√°rio", dbName: `Bi-hor√°rio - Ciclo ${cicloTipo}`}
                        ];
                    }
                } else {
                    opcoesDestino = [
                        {display: "Simples", dbName: "Simples"},
                        {display: "Tri-hor√°rio >20.7", dbName: `Tri-hor√°rio > 20.7 kVA - Ciclo ${cicloAtual.includes("Semanal") ? "Semanal" : "Di√°rio"}`}
                    ];
                }
            }
            if(opcoesDestino.length <= 1) return { opcoes: opcoesDestino, resultados: [] };

            // 2. PREPARAR DADOS POR OP√á√ÉO DE DESTINO
            const perOptionData = {};
            for(const opc of opcoesDestino) {
                const dbN = opc.dbName;
                // TAR Energia para esta op√ß√£o
                let tarEn = {S:0, V:0, F:0, P:0, C:0};
                if(dbN.includes("Simples")) { tarEn.S = getConst("TAR_Energia_Simples"); }
                else if(dbN.includes("Bi")) { tarEn.V = getConst("TAR_Energia_Bi_Vazio"); tarEn.F = getConst("TAR_Energia_Bi_ForaVazio"); }
                else { let pfx = pot > 20.7 ? "TAR_Energia_Tri_27.6_" : "TAR_Energia_Tri_"; tarEn.V = getConst(pfx+"Vazio"); tarEn.P = getConst(pfx+"Ponta"); tarEn.C = getConst(pfx+"Cheias"); }
                // TAR Final com desconto tarifa social
                let descTSEn = 0, descTSPot = 0;
                if(tarifaSocial && pot <= 6.9) { descTSEn = getConst("Desconto TS Energia"); descTSPot = getConst(`Desconto TS Potencia ${pot}`); }
                let tarEnFin = { S: tarEn.S-descTSEn, V: tarEn.V-descTSEn, F: tarEn.F-descTSEn, P: tarEn.P-descTSEn, C: tarEn.C-descTSEn };
                let tarPotFin = tarPotRegBase - descTSPot;
                let iecValOpc = (tarifaSocial && pot <= 6.9) ? 0 : getConst("IEC");
                // Consumos para esta op√ß√£o
                let consumos = {S:0, V:0, F:0, P:0, C:0};
                if(isAba3) {
                    const ag = DADOS_EREDES.consumosAgregados;
                    if(dbN.includes("Simples")) { consumos.S = ag.Simples || 0; }
                    else if(dbN.includes("Bi")) { const k = dbN.includes("Di√°rio") ? "BD" : "BS"; consumos.V = ag[k]?.V || 0; consumos.F = ag[k]?.F || 0; }
                    else { const k = dbN.includes("Di√°rio") ? "TD" : "TS"; consumos.V = ag[k]?.V || 0; consumos.C = ag[k]?.C || 0; consumos.P = ag[k]?.P || 0; }
                } else {
                    if(dbN.includes("Simples")) { consumos.S = totalKwhOriginal; }
                    else if(dbN.includes("Bi")) {
                        if(cicloAtual.includes("Tri")) { consumos.V = kwhOriginal.V; consumos.F = kwhOriginal.C + kwhOriginal.P; }
                        else if(cicloAtual.includes("Bi")) { consumos.V = kwhOriginal.V; consumos.F = kwhOriginal.F; }
                    } else if(dbN.includes("Tri")) {
                        if(cicloAtual.includes("Tri")) { consumos.V = kwhOriginal.V; consumos.C = kwhOriginal.C; consumos.P = kwhOriginal.P; }
                    }
                }
                let totalKwhOpc = consumos.S + consumos.V + consumos.F + consumos.P + consumos.C;
                // OMIE para esta op√ß√£o (sempre via getOmieAvg, tal como no modo normal)
                let omieOpc = {S:0, V:0, F:0, P:0, C:0};
                {
                    let colCiclo = "Simp";
                    if(dbN.includes("Bi")) colCiclo = dbN.includes("Di√°rio") ? "BD" : "BS";
                    if(dbN.includes("Tri")) colCiclo = dbN.includes("Di√°rio") ? "TD" : "TS";
                    omieOpc.S = getOmieAvg("Simp", "S");
                    if(dbN.includes("Bi")) { omieOpc.V = getOmieAvg(colCiclo, "V"); omieOpc.F = getOmieAvg(colCiclo, "F"); }
                    else if(dbN.includes("Tri")) { omieOpc.V = getOmieAvg(colCiclo, "V"); omieOpc.P = getOmieAvg(colCiclo, "P"); omieOpc.C = getOmieAvg(colCiclo, "C"); }
                }
                // QH para esta op√ß√£o
                let qhResults = {};
                let qhDiagramaResults = {};
                if(DATA.indexados && DATA.indexados.length > 0) {
                    const perfilBTN = obter_perfil(totalKwhOpc, dias, pot);
                    const qhFull = calculateDetailedQH(d1Str, d2Str, perfilBTN, dbN);
                    qhResults = qhFull.perfil || {};
                    if(isAba3 && qhFull.diagrama) qhDiagramaResults = qhFull.diagrama;
                }
                perOptionData[opc.display] = { dbName: dbN, tarEnBase: tarEn, tarEnFinal: tarEnFin, tarPotRegFinal: tarPotFin, consumos, totalKwh: totalKwhOpc, omie: omieOpc, qhResults, qhDiagramaResults, iecVal: iecValOpc };
            }

            // 3. FUN√á√ÉO AUXILIAR: Calcular custo desde uma row do Excel
            const calcCostForRow = (r, isIndexado, cols, opcDisplay, qhSourceOverride) => {
                const opc = perOptionData[opcDisplay];
                if(!opc || opc.totalKwh === 0) return null;
                const dbN = opc.dbName;
                const nomeOriginal = r['nome'] || "";
                const comercializador = r['comercializador'] || "";
                // Pot√™ncia
                let precoPotExcel = getVal(r, 'fixo', cols);
                let tarPIncl = parseBool(r[cols.tar_p_incl]); if(tarPIncl === undefined) tarPIncl = !isIndexado;
                let potComercial = tarPIncl ? precoPotExcel - tarPotRegBase : precoPotExcel;
                let potFinalDia = potComercial + opc.tarPotRegFinal;
                // Energia
                let tarEIncl = parseBool(r[cols.tar_e_incl]); if(tarEIncl === undefined) tarEIncl = !isIndexado;
                let tseIncl = parseBool(r[cols.tse_incl]); if(tseIncl === undefined) tseIncl = true;
                let tipo = (r[cols.tipo] || (isIndexado ? "Indexado M√©dia" : "Fixo")).trim();
                let omieKwh = {S: opc.omie.S/1000, V: opc.omie.V/1000, F: opc.omie.F/1000, P: opc.omie.P/1000, C: opc.omie.C/1000};
                const qhSrc = qhSourceOverride || opc.qhResults;
                let breakdown = { S:{}, V:{}, F:{}, P:{}, C:{} };
                const calcPeriod = (baseInput, tarRegBase, tarRegFinal, period) => {
                    let precoBase = baseInput;
                    if(isIndexado) {
                        if(tipo === "Indexado quarto-hor√°rio") {
                            if(qhSrc[nomeOriginal]) precoBase = qhSrc[nomeOriginal][period] || 0;
                        } else {
                            let omieVal = omieKwh[period], omieSimples = omieKwh['S'];
                            let colCiclo = "S";
                            if(dbN.includes("Bi")) colCiclo = dbN.includes("Di√°rio") ? "BD" : "BS";
                            else if(dbN.includes("Tri")) colCiclo = dbN.includes("Di√°rio") ? "TD" : "TS";
                            let perdasAnual = 1.0, perdasMensal = 1.16;
                            if(dbN.includes("Simples")) { perdasAnual = getPerdas('Perdas_Anual_S') || 1.0; perdasMensal = getPerdas('Perdas_M_S') || 1.16; }
                            else { perdasAnual = getPerdas(`Perdas_Anual_${colCiclo}_${period}`) || 1.0; perdasMensal = getPerdas(`Perdas_M_${colCiclo}_${period}`) || 1.16; }
                            if(nomeOriginal.includes("BTN SPOTDEF")) { if(qhSrc[nomeOriginal] && qhSrc[nomeOriginal][period] !== undefined) precoBase = qhSrc[nomeOriginal][period]; else { let cgs=getConst('Luzboa_CGS'),fa=getConst('Luzboa_FA'),kp=getConst('Luzboa_Kp'); precoBase=(omieVal+cgs)*perdasAnual*fa+kp; } }
                            else if(nomeOriginal.includes("Iberdrola")) { precoBase = omieVal*getConst('Iberdrola_Perdas')+getConst("Iberdrola_Media_Q")+getConst('Iberdrola_mFRR'); }
                            else if(nomeOriginal.includes("Goldenergy")) { const pg={1:1.29,2:1.18,3:1.18,4:1.15,5:1.11,6:1.10,7:1.15,8:1.13,9:1.10,10:1.10,11:1.16,12:1.25}; precoBase=omieVal*(pg[new Date(d1Str).getMonth()+1]||1.16)+getConst('GE_Q_Tarifa')+getConst('GE_CG'); }
                            else if(nomeOriginal.includes("Endesa")) { precoBase = omieVal+getConst(`Endesa_A_${period==='F'?'FV':period}`); }
                            else if(nomeOriginal.includes("LUZiG√ÅS - Energy 8.8")) { precoBase=(omieSimples+getConst('Luzigas_8_8_K')+getConst('Luzigas_CGS'))*perdasAnual; }
                            else if(nomeOriginal.includes("LUZiG√ÅS - Super Lig Index")) { precoBase=(omieSimples+getConst('Luzigas_K')+getConst('Luzigas_CGS'))*perdasAnual; }
                            else if(nomeOriginal.includes("Ibelectra - Solu√ß√£o Fam√≠lia")) { precoBase=(omieVal+getConst('Ibelectra_CS'))*perdasAnual+getConst('Ibelectra_K'); }
                            else if(nomeOriginal.includes("Ibelectra - Solu√ß√£o Amigo")) { precoBase=(omieVal+getConst('Ibelectra_CS'))*perdasAnual+getConst('Ibelectra_K_a'); }
                            else if(nomeOriginal.includes("G9 - Smart Index")) { precoBase=(omieVal*getConst('G9_FA')*perdasMensal)+getConst('G9_CGS')+getConst('G9_AC'); }
                            else if(nomeOriginal.includes("EDP - Eletricidade Indexada M√©dia")) { precoBase=omieVal*getConst('EDP_M_Perdas')*getConst('EDP_M_K1')+getConst('EDP_M_K2'); }
                            else { precoBase = omieVal + 0.02; }
                        }
                    }
                    let comSemTar = tarEIncl ? precoBase - tarRegBase : precoBase;
                    let finalPrice = comSemTar + tarRegFinal + (tseIncl ? 0 : tseVal);
                    breakdown[period] = { comercialSemTar: comSemTar, tarValue: tarRegFinal, tse: (tseIncl ? 0 : tseVal), tarIncluded: tarEIncl, tseIncluded: tseIncl };
                    return finalPrice;
                };
                let uS=0,uV=0,uF=0,uP=0,uC=0;
                if(dbN.includes("Simples")) { let p=isIndexado?0:getVal(r,'pS',cols); uS=calcPeriod(p,opc.tarEnBase.S,opc.tarEnFinal.S,'S'); }
                else if(dbN.includes("Bi")) { let pV=isIndexado?0:(getVal(r,'pV_bi',cols)||getVal(r,'pS',cols)); let pF=isIndexado?0:(getVal(r,'pF',cols)||getVal(r,'pS',cols)); uV=calcPeriod(pV,opc.tarEnBase.V,opc.tarEnFinal.V,'V'); uF=calcPeriod(pF,opc.tarEnBase.F,opc.tarEnFinal.F,'F'); }
                else { let pV=isIndexado?0:(getVal(r,'pV_tri',cols)||getVal(r,'pS',cols)); let pP=isIndexado?0:(getVal(r,'pP',cols)||getVal(r,'pF',cols)||getVal(r,'pS',cols)); let pC=isIndexado?0:(getVal(r,'pC',cols)||getVal(r,'pF',cols)||getVal(r,'pS',cols)); uV=calcPeriod(pV,opc.tarEnBase.V,opc.tarEnFinal.V,'V'); uP=calcPeriod(pP,opc.tarEnBase.P,opc.tarEnFinal.P,'P'); uC=calcPeriod(pC,opc.tarEnBase.C,opc.tarEnFinal.C,'C'); }
                // Custo pot√™ncia
                let costPotComercial = potComercial * dias;
                let costPotTar = opc.tarPotRegFinal * dias;
                let costPot6=0,costPot23=0;
                if(pot<=3.45){costPot6=costPotTar;costPot23=costPotComercial;}else{costPot23=costPotComercial+costPotTar;}
                let taxPot6=costPot6*0.06,taxPot23=costPot23*0.23;
                // Custo energia
                const kwh = opc.consumos;
                let costEn=0;
                if(dbN.includes("Simples")) costEn=uS*kwh.S;
                else if(dbN.includes("Bi")) costEn=uV*kwh.V+uF*kwh.F;
                else costEn=uV*kwh.V+uP*kwh.P+uC*kwh.C;
                // IVA reduzido
                let limit6=famNum?300:200, dailyLim=(limit6/30)*dias;
                let costEn6=0,costEn23=0,taxEn6=0,taxEn23=0;
                if(pot<=6.9){
                    if(dbN.includes("Simples")){let kr=Math.min(opc.totalKwh,dailyLim),kn=Math.max(0,opc.totalKwh-dailyLim),ap=opc.totalKwh?costEn/opc.totalKwh:0;costEn6=kr*ap;costEn23=kn*ap;}
                    else{let cl=dbN.includes("Bi")?{V:kwh.V,F:kwh.F}:{V:kwh.V,P:kwh.P,C:kwh.C};let cu=dbN.includes("Bi")?{V:uV*kwh.V,F:uF*kwh.F}:{V:uV*kwh.V,P:uP*kwh.P,C:uC*kwh.C};let e6=0,e23=0;for(let p in cl){let pr=opc.totalKwh>0?cl[p]/opc.totalKwh:0;let lm=dailyLim*pr;let cr=Math.min(cl[p],lm);let cn=Math.max(0,cl[p]-lm);let un=cl[p]>0?cu[p]/cl[p]:0;e6+=cr*un;e23+=cn*un;}costEn6=e6;costEn23=e23;}
                    taxEn6=costEn6*0.06;taxEn23=costEn23*0.23;
                }else{costEn23=costEn;taxEn23=costEn23*0.23;}
                // Outros custos
                let cavVal;
                if(CAV_FIXO_COMERCIALIZADORES.some(c=>comercializador.includes(c))){cavVal=(dias>=28&&dias<=32)?cavUser:(cavUser*12/365.25)*dias;}else{cavVal=(cavUser*12/365.25)*dias;}
                let iec=opc.totalKwh*opc.iecVal;
                let dgeg=(dias>=28&&dias<=32)?dgegUser:(dgegUser*dias/30);
                let taxIEC=iec*0.23,taxDGEG=dgeg*0.23,taxCAV=cavVal*0.06;
                let total=(costPot6+costPot23+taxPot6+taxPot23)+(costEn6+costEn23+taxEn6+taxEn23)+(iec+taxIEC+dgeg+taxDGEG+cavVal+taxCAV);
                // Desconto
                let desc=getVal(r,'desc_fat',cols),descLimit=getVal(r,'desc_limit',cols),descFinal=0;
                if(desc>0){let db=(dias>=28&&dias<=32)?desc:(desc*dias/30);if(descLimit&&descLimit>0){let ms=(dias>=28&&dias<=32)?1:(dias/30);descFinal=ms>descLimit?desc*descLimit:db;}else{descFinal=db;}total-=descFinal;}
                // Quota ACP
                let quotaACPVal=0;
                if(incluirACP&&nomeOriginal.startsWith("Goldenergy - ACP")){quotaACPVal=(dias>=28&&dias<=32)?getConst("Quota_ACP"):(getConst("Quota_ACP")*dias/30);total+=quotaACPVal;}
                return {
                    total: total,
                    uS, uV, uF, uP, uC, uPot: potFinalDia,
                    breakdown: breakdown,
                    potDetails: { comercial: potComercial, tarPotValue: opc.tarPotRegFinal, tarIncluded: tarPIncl },
                    details: {
                        costPot6, costPot23, costEn6, costEn23,
                        taxPot6, taxPot23, taxEn6, taxEn23,
                        iec, dgeg, cav: cavVal, taxIEC, taxDGEG, taxCAV,
                        desc: descFinal, quotaACP: quotaACPVal, acrescimo: 0,
                        site: r[cols.site], notas: r[cols.notas]
                    }
                };
            };

            // 4. FILTROS (mesmos que tabela normal)
            const filterRow = (r, cols) => {
                const seg=r[cols.seg]||"";
                if(fSeg==="Residencial"&&seg!=="Dom√©stico"&&seg!=="Dom√©stico e N√£o Dom√©stico")return false;
                if(fSeg==="Empresarial"&&seg!=="N√£o Dom√©stico"&&seg!=="Dom√©stico e N√£o Dom√©stico")return false;
                const fat=r[cols.fat]||"";
                if(fFat==="Fatura eletr√≥nica"&&!fat.includes("Fatura eletr√≥nica"))return false;
                if(fFat==="Fatura em papel"&&!fat.includes("Fatura em papel"))return false;
                const pag=r[cols.pag]||"";
                if(fPag==="D√©bito Direto"&&!pag.includes("D√©bito Direto"))return false;
                if(fPag==="Multibanco"&&!pag.includes("Multibanco"))return false;
                if(fPag==="Numer√°rio/Payshop/CTT"&&!pag.includes("Numer√°rio")&&!pag.includes("Payshop")&&!pag.includes("CTT"))return false;
                const com=r['comercializador']||"";
                if(CURRENT_TAB==='complete'&&STATE_ABA2.excludedProviders.includes(com))return false;
                if(CURRENT_TAB==='advanced'&&STATE_ABA3.excludedProviders.includes(com))return false;
                const fProcura = document.getElementById('f_procura') ? document.getElementById('f_procura').value.toLowerCase() : '';
                if (fProcura) {
                    const nome = (r['nome'] || "").toLowerCase();
                    const comercializador = (r['comercializador'] || "").toLowerCase();
                    // Se n√£o encontrar o texto nem no nome nem no comercializador, esconde a linha
                    if (!nome.includes(fProcura) && !comercializador.includes(fProcura)) return false;
                }
                // --------------------------------

                return true;
            };

            // 5. ENCONTRAR TARIF√ÅRIOS √öNICOS E CALCULAR
            const tarifasUnicas = new Map();
            const processSource = (list, isIndexado, cols) => {
                list.forEach(r => {
                    const nome=r['nome']||"", com=r['comercializador']||"";
                    const tipo=(r[cols.tipo]||(isIndexado?"Indexado M√©dia":"Fixo")).trim();
                    if(ocultarEDP&&nome.includes("EDP - Eletricidade Indexada Hor√°ria"))return;
                    if(!selTypes.includes(tipo))return;
                    if(!filterRow(r,cols))return;
                    if(Math.abs(getVal(r,'pot',cols)-pot)>0.1)return;
                    // Para QH em Aba 3, criar variantes Perfil e Diagrama
                    if(isIndexado && tipo === "Indexado quarto-hor√°rio" && isAba3) {
                        const keyP=`${nome} - Perfil|${com}`;
                        if(!tarifasUnicas.has(keyP)){
                            tarifasUnicas.set(keyP,{nome:nome,nomeDisplay:nome+" - Perfil",com,tipo:"Indexado quarto-hor√°rio - Perfil",isIndexado,site:r[cols.site],notas:r[cols.notas],cols,qhVariant:'perfil'});
                        }
                        // Diagrama s√≥ se houver dados E-REDES
                        const hasDiagrama = opcoesDestino.some(o => {
                            const od = perOptionData[o.display];
                            return od && od.qhDiagramaResults && Object.keys(od.qhDiagramaResults).length > 0;
                        });
                        if(hasDiagrama) {
                            const keyD=`${nome} - Diagrama|${com}`;
                            if(!tarifasUnicas.has(keyD)){
                                tarifasUnicas.set(keyD,{nome:nome,nomeDisplay:nome+" - Diagrama",com,tipo:"Indexado quarto-hor√°rio - Diagrama",isIndexado,site:r[cols.site],notas:r[cols.notas],cols,qhVariant:'diagrama'});
                            }
                        }
                    } else {
                        const key=`${nome}|${com}`;
                        if(!tarifasUnicas.has(key)){
                            tarifasUnicas.set(key,{nome,nomeDisplay:nome,com,tipo,isIndexado,site:r[cols.site],notas:r[cols.notas],cols,qhVariant:null});
                        }
                    }
                });
            };
            processSource(DATA.fixos, false, COLS_FIXO);
            if(DATA.indexados&&DATA.indexados.length>0) processSource(DATA.indexados, true, COLS_INDEX);

            const resultsComparacao = [];
            for(const [key, info] of tarifasUnicas) {
                const resultado = { nome:info.nomeDisplay, com:info.com, tipo:info.tipo, site:info.site, notas:info.notas, custos:{}, detalhes:{}, melhorOpcao:'', menorCusto:Infinity };
                let temCalculo = false;
                for(const opc of opcoesDestino) {
                    const dataSource = info.isIndexado ? DATA.indexados : DATA.fixos;
                    const matchRow = dataSource.find(r =>
                        r['nome']===info.nome && r['comercializador']===info.com &&
                        Math.abs(getVal(r,'pot',info.cols)-pot)<0.1 &&
                        (r[info.cols.ciclo]||"").toLowerCase()===opc.dbName.toLowerCase()
                    );
                    if(matchRow) {
                        const qhSrc = info.qhVariant === 'diagrama' ? perOptionData[opc.display]?.qhDiagramaResults : 
                                       info.qhVariant === 'perfil' ? perOptionData[opc.display]?.qhResults : null;
                        const resultObj = calcCostForRow(matchRow, info.isIndexado, info.cols, opc.display, qhSrc);
                        if(resultObj!==null&&!isNaN(resultObj.total)) {
                            resultado.custos[opc.display]=resultObj.total;
                            resultado.detalhes[opc.display]=resultObj;
                            temCalculo=true;
                            if(resultObj.total<resultado.menorCusto){resultado.menorCusto=resultObj.total;resultado.melhorOpcao=opc.display;}
                        }
                    }
                }
                if(temCalculo) resultsComparacao.push(resultado);
            }

            // 6. ADICIONAR "O MEU TARIF√ÅRIO"
            if(document.getElementById('meu_ativo')&&document.getElementById('meu_ativo').checked) {
                const meuTar = results.find(r=>r.nome&&r.nome.includes("O Meu Tarif√°rio"));
                if(meuTar) {
                    const res = {nome:meuTar.nome,com:meuTar.com||"Utilizador",tipo:"Utilizador",site:"",notas:"",custos:{},detalhes:{},melhorOpcao:'',menorCusto:Infinity};
                    const matchOpc = opcoesDestino.find(o=>o.dbName.toLowerCase()===cicloAtual.toLowerCase());
                    if(matchOpc){
                        res.custos[matchOpc.display]=meuTar.total;res.menorCusto=meuTar.total;res.melhorOpcao=matchOpc.display;
                        res.detalhes[matchOpc.display]={ total:meuTar.total, uS:meuTar.uS, uV:meuTar.uV, uF:meuTar.uF, uP:meuTar.uP, uC:meuTar.uC, uPot:meuTar.uPot, breakdown:meuTar.breakdown, potDetails:meuTar.potDetails, details:meuTar.details };
                    }
                    resultsComparacao.push(res);
                }
            }

            // 7. ADICIONAR "TARIF√ÅRIO PERSONALIZADO"
            if(document.getElementById('pers_ativo')&&document.getElementById('pers_ativo').checked) {
                const res = {nome:"Tarif√°rio Personalizado",com:"Personalizado",tipo:"Personalizado",site:"",notas:"Tarif√°rio configurado pelo utilizador.",custos:{},detalhes:{},melhorOpcao:'',menorCusto:Infinity};
                for(const opc of opcoesDestino) {
                    const oData = perOptionData[opc.display];
                    if(!oData||oData.totalKwh===0) continue;
                    const resultObj = calcularPersParaOpcaoComp(opc.dbName, oData, pot, dias, famNum, cavUser, dgegUser, tseVal, tarPotRegBase);
                    if(resultObj!==null&&!isNaN(resultObj.total)){
                        res.custos[opc.display]=resultObj.total;
                        res.detalhes[opc.display]=resultObj;
                        if(resultObj.total<res.menorCusto){res.menorCusto=resultObj.total;res.melhorOpcao=opc.display;}
                    }
                }
                if(Object.keys(res.custos).length>0) resultsComparacao.push(res);
            }

            // 8. ORDENAR
            if(SORT_COMPARACAO.col&&SORT_COMPARACAO.col!=='nome') {
                resultsComparacao.sort((a,b)=>{const va=a.custos[SORT_COMPARACAO.col]??Infinity;const vb=b.custos[SORT_COMPARACAO.col]??Infinity;return SORT_COMPARACAO.asc?va-vb:vb-va;});
            } else if(SORT_COMPARACAO.col==='nome') {
                resultsComparacao.sort((a,b)=>SORT_COMPARACAO.asc?a.nome.localeCompare(b.nome):b.nome.localeCompare(a.nome));
            } else {
                const first=opcoesDestino[0]?.display;
                if(first) resultsComparacao.sort((a,b)=>(a.custos[first]??Infinity)-(b.custos[first]??Infinity));
            }
            return { opcoes: opcoesDestino, resultados: resultsComparacao };
        }

        // Helper: Calcular Tarif√°rio Personalizado para uma op√ß√£o de destino na compara√ß√£o
        function calcularPersParaOpcaoComp(dbName, opcData, pot, dias, famNum, cavUser, dgegUser, tseVal, tarPotRegBase) {
            const tarPotIncl = document.getElementById('pers_tar_potencia')?.checked ?? true;
            const tarEnIncl = document.getElementById('pers_tar_energia')?.checked ?? true;
            const tseIncl = document.getElementById('pers_tse_incluido')?.checked ?? true;
            let uS=0,uV=0,uF=0,uP=0,uC=0,persPot=0;
            let breakdown = { S:{}, V:{}, F:{}, P:{}, C:{} };
            if(dbName.includes("Simples")){
                const el=document.getElementById('pers_energia_s'); if(!el)return null;
                uS=parseFloat(el.value)||0; persPot=parseFloat(document.getElementById('pers_potencia_s')?.value)||0;
            } else if(dbName.includes("Bi")){
                const eV=document.getElementById('pers_energia_v_bi'),eF=document.getElementById('pers_energia_f_bi'); if(!eV||!eF)return null;
                uV=parseFloat(eV.value)||0; uF=parseFloat(eF.value)||0; persPot=parseFloat(document.getElementById('pers_potencia_bi')?.value)||0;
            } else {
                const eV=document.getElementById('pers_energia_v_tri'),eC=document.getElementById('pers_energia_c_tri'),eP=document.getElementById('pers_energia_p_tri'); if(!eV||!eC||!eP)return null;
                uV=parseFloat(eV.value)||0;uC=parseFloat(eC.value)||0;uP=parseFloat(eP.value)||0; persPot=parseFloat(document.getElementById('pers_potencia_tri')?.value)||0;
            }
            if(persPot===0&&uS===0&&uV===0&&uF===0&&uP===0&&uC===0) return null;
            const proc=(pi,tb,tf,period)=>{
                let comSemTar = tarEnIncl?pi-tb:pi;
                let finalP = comSemTar+tf+(tseIncl?0:tseVal);
                breakdown[period] = { comercialSemTar: comSemTar, tarValue: tf, tse: (tseIncl?0:tseVal), tarIncluded: tarEnIncl, tseIncluded: tseIncl };
                return finalP;
            };
            if(dbName.includes("Simples")){uS=proc(uS,opcData.tarEnBase.S,opcData.tarEnFinal.S,'S');}
            else if(dbName.includes("Bi")){uV=proc(uV,opcData.tarEnBase.V,opcData.tarEnFinal.V,'V');uF=proc(uF,opcData.tarEnBase.F,opcData.tarEnFinal.F,'F');}
            else{uV=proc(uV,opcData.tarEnBase.V,opcData.tarEnFinal.V,'V');uP=proc(uP,opcData.tarEnBase.P,opcData.tarEnFinal.P,'P');uC=proc(uC,opcData.tarEnBase.C,opcData.tarEnFinal.C,'C');}
            let pPotCom=tarPotIncl?persPot-tarPotRegBase:persPot;
            let potFinalDia=pPotCom+opcData.tarPotRegFinal;
            let costPotCom=pPotCom*dias,costPotTar=opcData.tarPotRegFinal*dias;
            let costPot6=0,costPot23=0;
            if(pot<=3.45){costPot6=costPotTar;costPot23=costPotCom;}else{costPot23=costPotCom+costPotTar;}
            let taxPot6=costPot6*0.06,taxPot23=costPot23*0.23;
            const kwh=opcData.consumos;let costEn=0;
            if(dbName.includes("Simples"))costEn=uS*kwh.S;else if(dbName.includes("Bi"))costEn=uV*kwh.V+uF*kwh.F;else costEn=uV*kwh.V+uP*kwh.P+uC*kwh.C;
            let limit6=famNum?300:200,dailyLim=(limit6/30)*dias;let costEn6=0,costEn23=0,taxEn6=0,taxEn23=0;
            if(pot<=6.9){let kr=Math.min(opcData.totalKwh,dailyLim),kn=Math.max(0,opcData.totalKwh-dailyLim),ap=opcData.totalKwh?costEn/opcData.totalKwh:0;costEn6=kr*ap;costEn23=kn*ap;taxEn6=costEn6*0.06;taxEn23=costEn23*0.23;}
            else{costEn23=costEn;taxEn23=costEn23*0.23;}
            let cavVal=(cavUser*12/365.25)*dias;let iec=opcData.totalKwh*opcData.iecVal;
            let dgeg=(dias>=28&&dias<=32)?dgegUser:(dgegUser*dias/30);
            let taxIEC=iec*0.23,taxDGEG=dgeg*0.23,taxCAV=cavVal*0.06;
            let total=(costPot6+costPot23+taxPot6+taxPot23)+(costEn6+costEn23+taxEn6+taxEn23)+iec+taxIEC+dgeg+taxDGEG+cavVal+taxCAV;
            return {
                total: total,
                uS, uV, uF, uP, uC, uPot: potFinalDia,
                breakdown: breakdown,
                potDetails: { comercial: pPotCom, tarPotValue: opcData.tarPotRegFinal, tarIncluded: tarPotIncl },
                details: {
                    costPot6, costPot23, costEn6, costEn23,
                    taxPot6, taxPot23, taxEn6, taxEn23,
                    iec, dgeg, cav: cavVal, taxIEC, taxDGEG, taxCAV,
                    desc: 0, quotaACP: 0, acrescimo: 0,
                    site: "", notas: "Tarif√°rio configurado pelo utilizador."
                }
            };
        }

        // ===== FUN√á√ïES AUXILIARES PARA RESUMO E POUPAN√áA =====
        
        function toggleResumo() {
            const content = document.getElementById('resumo-content');
            const icon = document.getElementById('resumo-icon');
            
            if(content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fa-solid fa-chevron-down';
            } else {
                content.style.display = 'none';
                icon.className = 'fa-solid fa-chevron-right';
            }
        }
        
        function toggleAnalise() {
            const content = document.getElementById('analise-content');
            const icon = document.getElementById('analise-icon');
            
            if(content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fa-solid fa-chevron-down';
            } else {
                content.style.display = 'none';
                icon.className = 'fa-solid fa-chevron-right';
            }
        }
        
        function criarTabelaAnalise(consumosAgregados, mediasOMIE) {
            // Extrair dados
            const data = {};
            const totalKwh = consumosAgregados.Simples || 0;
            
            const ciclosInfo = {
                'S': ['S'],
                'BD': ['V', 'F'],
                'BS': ['V', 'F'],
                'TD': ['V', 'C', 'P'],
                'TS': ['V', 'C', 'P']
            };
            
            for(const [ciclo, periodos] of Object.entries(ciclosInfo)) {
                const totalCiclo = ciclo === 'S' ? totalKwh : 
                    Object.values(consumosAgregados[ciclo] || {}).reduce((a, b) => a + b, 0);
                
                for(const periodo of periodos) {
                    // Chave OMIE correta por ciclo
                    const chaveOMIE = ciclo === 'S' ? 'S' : `${ciclo}_${periodo}`;
                    const kwh = ciclo === 'S' ? totalKwh : (consumosAgregados[ciclo]?.[periodo] || 0);
                    const perc = totalCiclo > 0 ? (kwh / totalCiclo * 100) : (ciclo === 'S' ? 100 : 0);
                    
                    data[`${ciclo}_${periodo}`] = {
                        omie: mediasOMIE[chaveOMIE] || 0,
                        kwh: kwh,
                        perc: perc
                    };
                }
            }
            
            // Auxiliares de formata√ß√£o
            const fnum = (n, d = 0, s = '') => {
                try { return n.toLocaleString('pt-PT', {minimumFractionDigits: d, maximumFractionDigits: d}) + s; } catch { return '-'; }
            };
            const cel = (valor, classe, d = 0, s = '') => `<td class="cell-${classe}">${fnum(valor, d, s)}</td>`;
            
            // HTML com COLGROUP para larguras perfeitas
            let html = `
            <style>
                .analise-table { width: 100%; border-collapse: collapse; font-size: 11px; text-align: center; table-layout: fixed; margin-top:10px; }
                .analise-table th, .analise-table td { padding: 4px 2px; border: 1px solid #ccc; word-wrap: break-word; overflow: hidden; }
                .analise-table thead th { font-weight: bold; vertical-align: middle; height: 30px; }
                
                /* Estilo da primeira coluna (R√≥tulos) */
                .row-label { font-weight: 600; text-align: left; padding-left: 8px !important; background-color: #f8fafc; }

                /* Cores Cabe√ßalhos */
                .header-S { background-color: #A6A6A6; color: #000; }
                .header-BD { background-color: #A9D08E; color: #000; }
                .header-BS { background-color: #8EA9DB; color: #000; }
                .header-TD { background-color: #BF8F00; color: #FFF; }
                .header-TS { background-color: #C65911; color: #FFF; }
                
                /* Cores C√©lulas */
                .cell-S { background-color: #D9D9D9; } .cell-BD_V { background-color: #C6E0B4; } .cell-BD_F { background-color: #E2EFDA; }
                .cell-BS_V { background-color: #B4C6E7; } .cell-BS_F { background-color: #D9E1F2; } .cell-TD_V { background-color: #FFD966; }
                .cell-TD_C { background-color: #FFE699; } .cell-TD_P { background-color: #FFF2CC; } .cell-TS_V { background-color: #F4B084; }
                .cell-TS_C { background-color: #F8CBAD; } .cell-TS_P { background-color: #FCE4D6; }
            </style>
            
            <table class="analise-table">
                <colgroup>
                    <col style="width: 12%;"> <col style="width: 8%;">  <col style="width: 8%;"><col style="width: 8%;"> <col style="width: 8%;"><col style="width: 8%;"> <col style="width: 8%;"><col style="width: 8%;"><col style="width: 8%;"> <col style="width: 8%;"><col style="width: 8%;"><col style="width: 8%;"> </colgroup>
                <thead>
                    <tr>
                        <th rowspan="2"></th>
                        <th rowspan="2" class="header-S">Simples</th>
                        <th colspan="2" class="header-BD">Bi-hor√°rio Di√°rio</th>
                        <th colspan="2" class="header-BS">Bi-hor√°rio Semanal</th>
                        <th colspan="3" class="header-TD">Tri-hor√°rio Di√°rio</th>
                        <th colspan="3" class="header-TS">Tri-hor√°rio Semanal</th>
                    </tr>
                    <tr>
                        <th class="cell-BD_V">Vazio</th><th class="cell-BD_F">F.Vazio</th>
                        <th class="cell-BS_V">Vazio</th><th class="cell-BS_F">F.Vazio</th>
                        <th class="cell-TD_V">Vazio</th><th class="cell-TD_C">Cheias</th><th class="cell-TD_P">Ponta</th>
                        <th class="cell-TS_V">Vazio</th><th class="cell-TS_C">Cheias</th><th class="cell-TS_P">Ponta</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="row-label">M√©dia OMIE (‚Ç¨/MWh)</td>
                        ${cel(data.S_S.omie, 'S', 2)}
                        ${cel(data.BD_V.omie, 'BD_V', 2)}${cel(data.BD_F.omie, 'BD_F', 2)}
                        ${cel(data.BS_V.omie, 'BS_V', 2)}${cel(data.BS_F.omie, 'BS_F', 2)}
                        ${cel(data.TD_V.omie, 'TD_V', 2)}${cel(data.TD_C.omie, 'TD_C', 2)}${cel(data.TD_P.omie, 'TD_P', 2)}
                        ${cel(data.TS_V.omie, 'TS_V', 2)}${cel(data.TS_C.omie, 'TS_C', 2)}${cel(data.TS_P.omie, 'TS_P', 2)}
                    </tr>
                    <tr>
                        <td class="row-label">Consumo (kWh)</td>
                        ${cel(data.S_S.kwh, 'S', 0)}
                        ${cel(data.BD_V.kwh, 'BD_V', 0)}${cel(data.BD_F.kwh, 'BD_F', 0)}
                        ${cel(data.BS_V.kwh, 'BS_V', 0)}${cel(data.BS_F.kwh, 'BS_F', 0)}
                        ${cel(data.TD_V.kwh, 'TD_V', 0)}${cel(data.TD_C.kwh, 'TD_C', 0)}${cel(data.TD_P.kwh, 'TD_P', 0)}
                        ${cel(data.TS_V.kwh, 'TS_V', 0)}${cel(data.TS_C.kwh, 'TS_C', 0)}${cel(data.TS_P.kwh, 'TS_P', 0)}
                    </tr>
                    <tr>
                        <td class="row-label">Peso (%)</td>
                        ${cel(data.S_S.perc, 'S', 1, '%')}
                        ${cel(data.BD_V.perc, 'BD_V', 1, '%')}${cel(data.BD_F.perc, 'BD_F', 1, '%')}
                        ${cel(data.BS_V.perc, 'BS_V', 1, '%')}${cel(data.BS_F.perc, 'BS_F', 1, '%')}
                        ${cel(data.TD_V.perc, 'TD_V', 1, '%')}${cel(data.TD_C.perc, 'TD_C', 1, '%')}${cel(data.TD_P.perc, 'TD_P', 1, '%')}
                        ${cel(data.TS_V.perc, 'TS_V', 1, '%')}${cel(data.TS_C.perc, 'TS_C', 1, '%')}${cel(data.TS_P.perc, 'TS_P', 1, '%')}
                    </tr>
                </tbody>
            </table>`;
            
            return html;
        }        
        function getTarifarioStyle(tipo, nome) {
            if (nome && nome.includes("O Meu Tarif√°rio")) 
                return { cellClass: 'cell-meu-tarif', tagClass: 'meu-tarif', label: 'O Meu Tarif√°rio' };
            if (nome && nome.includes("Tarif√°rio Personalizado")) 
                return { cellClass: 'cell-perso', tagClass: 'perso', label: 'Personalizado' };
            
            switch (tipo) {
                case 'Indexado quarto-hor√°rio - Diagrama':
                    return { cellClass: 'cell-qh-diagrama', tagClass: 'qh-diagrama', label: 'Indexado quarto-hor√°rio - Diagrama' };
                case 'Indexado quarto-hor√°rio':
                case 'Indexado quarto-hor√°rio - Perfil':
                    return { cellClass: 'cell-qh-perfil', tagClass: 'qh-perfil', label: 'Indexado quarto-hor√°rio - Perfil' };
                case 'Indexado M√©dia':
                    return { cellClass: 'cell-index-media', tagClass: 'index-media', label: 'Indexado M√©dia' };
                default:
                    return { cellClass: 'cell-fixo', tagClass: 'fixo', label: 'Fixo' };
            }
        }
        
        function atualizarResumoSimulacao() {
            try {
                const potEl = document.getElementById('potencia');
                const cicloEl = document.getElementById('ciclo');
                const d1El = document.getElementById('d_inicio');
                const d2El = document.getElementById('d_fim');
                const diasEl = document.getElementById('num_dias');
                
                // Verificar se todos os elementos essenciais existem
                if(!potEl || !cicloEl || !d1El || !d2El || !diasEl) {
                    console.log('Elementos do resumo ainda n√£o dispon√≠veis');
                    document.getElementById('resumo-simulacao').style.display = 'none';
                    return;
                }
                
                const pot = parseFloat(potEl.value);
                const ciclo = cicloEl.value;
                
                // Criar datas de forma local (evitar timezone issues)
                const d1Parts = d1El.value.split('-');
                const d1 = new Date(parseInt(d1Parts[0]), parseInt(d1Parts[1])-1, parseInt(d1Parts[2]));
                
                const d2Parts = d2El.value.split('-');
                const d2 = new Date(parseInt(d2Parts[0]), parseInt(d2Parts[1])-1, parseInt(d2Parts[2]));
                
                const dias = parseInt(diasEl.value);
                
                // Verificar se as datas s√£o v√°lidas
                if(isNaN(d1.getTime()) || isNaN(d2.getTime()) || isNaN(dias)) {
                    document.getElementById('resumo-simulacao').style.display = 'none';
                    return;
                }
                
                // Obter consumos
                const kwh = { S:0, V:0, F:0, P:0, C:0 };
                if(document.getElementById('kwh_S')) kwh.S = parseFloat(document.getElementById('kwh_S').value)||0;
                if(document.getElementById('kwh_V')) kwh.V = parseFloat(document.getElementById('kwh_V').value)||0;
                if(document.getElementById('kwh_F')) kwh.F = parseFloat(document.getElementById('kwh_F').value)||0;
                if(document.getElementById('kwh_P')) kwh.P = parseFloat(document.getElementById('kwh_P').value)||0;
                if(document.getElementById('kwh_C')) kwh.C = parseFloat(document.getElementById('kwh_C').value)||0;
                const totalKwh = kwh.S + kwh.V + kwh.F + kwh.P + kwh.C;
                
                // Obter valores OMIE atuais
                const omieS = OMIE_VALUES.S;
                const omieV = OMIE_VALUES.V;
                const omieF = OMIE_VALUES.F;
                const omieC = OMIE_VALUES.C;
                const omieP = OMIE_VALUES.P;
                
                // Obter perfil
                const perfil = obter_perfil(totalKwh, dias, pot);
                // Remover "perfil_" ou "BTN_" e formatar como "Perfil X"
                const perfilTexto = perfil.replace(/^(perfil_|BTN_)/i, 'Perfil ').toUpperCase();
                
                // Obter filtros (com fallback)
                const segEl = document.getElementById('f_segmento');
                const fatEl = document.getElementById('f_fatura');
                const pagEl = document.getElementById('f_pagamento');
                
                const segSel = segEl ? segEl.value : 'Todos';
                const fatSel = fatEl ? fatEl.value : 'Todas';
                const pagSel = pagEl ? pagEl.value : 'Todos';
                
                let segTexto = segSel;
                if(segSel === "Todos") segTexto = "Residencial e Empresarial";
                
                // Construir HTML do resumo
                let html = `
                    <li style="margin-bottom:5px;"><b>Segmento:</b> ${segTexto} &nbsp;&nbsp;|&nbsp;&nbsp; <b>Fatura√ß√£o:</b> ${fatSel} &nbsp;&nbsp;|&nbsp;&nbsp; <b>Pagamento:</b> ${pagSel}</li>
                    <li style="margin-bottom:5px;"><b>${pot} kVA</b> em <b>${ciclo}</b></li>
                `;
                
                // Detalhe dos consumos
                let consumoDetalhe = "";
                if(ciclo.includes("Simples")) {
                    consumoDetalhe = `Simples: ${kwh.S.toFixed(0)} kWh`;
                } else if(ciclo.includes("Bi")) {
                    consumoDetalhe = `Vazio: ${kwh.V.toFixed(0)} kWh, Fora Vazio: ${kwh.F.toFixed(0)} kWh`;
                } else {
                    consumoDetalhe = `Vazio: ${kwh.V.toFixed(0)} kWh, Cheias: ${kwh.C.toFixed(0)} kWh, Ponta: ${kwh.P.toFixed(0)} kWh`;
                }
                html += `<li style="margin-bottom:5px;"><b>Consumos (${totalKwh.toFixed(0)} kWh Total):</b> ${consumoDetalhe}</li>`;
                
                // Per√≠odo
                const formatDate = (date) => {
                    const d = date.getDate().toString().padStart(2, '0');
                    const m = (date.getMonth() + 1).toString().padStart(2, '0');
                    const y = date.getFullYear();
                    return `${d}/${m}/${y}`;
                };
                html += `<li style="margin-bottom:5px;"><b>Per√≠odo:</b> De ${formatDate(d1)} a ${formatDate(d2)} (${dias} dias)</li>`;
                
                // Valores OMIE
                let omieDetalhe = "";
                if(ciclo.includes("Simples")) {
                    omieDetalhe = `Simples: ${omieS.toFixed(2)} ‚Ç¨/MWh`;
                } else if(ciclo.includes("Bi")) {
                    omieDetalhe = `Vazio: ${omieV.toFixed(2)} ‚Ç¨/MWh, Fora Vazio: ${omieF.toFixed(2)} ‚Ç¨/MWh`;
                } else {
                    omieDetalhe = `Vazio: ${omieV.toFixed(2)} ‚Ç¨/MWh, Cheias: ${omieC.toFixed(2)} ‚Ç¨/MWh, Ponta: ${omieP.toFixed(2)} ‚Ç¨/MWh`;
                }
                html += `<li style="margin-bottom:5px;"><b>OMIE ${!OMIE_MANUAL ? '(per√≠odo selecionado)' : '(manual)'}:</b> ${omieDetalhe}</li>`;
                
                // Perfil de consumo
                html += `<li style="margin-bottom:5px;"><b>Perfil de Consumo:</b> ${perfilTexto}</li>`;
                
                // Atualizar DOM
                const resumoList = document.getElementById('resumo-list');
                const resumoDiv = document.getElementById('resumo-simulacao');
                
                if(resumoList && resumoDiv) {
                    resumoList.innerHTML = html;
                    resumoDiv.style.display = 'block';
                }
            } catch(error) {
                console.error('Erro ao atualizar resumo:', error);
                document.getElementById('resumo-simulacao').style.display = 'none';
            }
        }
        
        function calcularMensagemPoupanca(results) {
            try {
                const mensagemDiv = document.getElementById('mensagem-poupanca');
                if(!mensagemDiv) {
                    console.log('Elemento mensagem-poupanca n√£o encontrado');
                    return;
                }
                
                // Procurar "O Meu Tarif√°rio" nos resultados
                const meuTar = results.find(r => r.nome && r.nome.includes("O Meu Tarif√°rio"));
                
                if(!meuTar || !meuTar.total || meuTar.total <= 0) {
                    mensagemDiv.style.display = 'none';
                    return;
                }
                
                // Filtrar outros tarif√°rios (excluir "O Meu Tarif√°rio" e "Utilizador")
                const outrosTarifarios = results.filter(r => 
                    r.tipo !== 'Utilizador' && 
                    r.total > 0 && 
                    !r.nome.includes("O Meu Tarif√°rio")
                );
                
                if(outrosTarifarios.length === 0) {
                    mensagemDiv.innerHTML = `<span style="color:black; font-weight:normal;">N√£o h√° outros tarif√°rios com custos v√°lidos para comparar com '${meuTar.nome}' (${meuTar.total.toFixed(2)}‚Ç¨).</span>`;
                    mensagemDiv.style.display = 'block';
                    return;
                }
                
                // Encontrar o mais barato
                const maisBarato = outrosTarifarios.reduce((min, r) => r.total < min.total ? r : min);
                
                const custoMeuTar = meuTar.total;
                const custoMaisBarato = maisBarato.total;
                
                if(custoMeuTar > custoMaisBarato) {
                    const poupancaAbs = custoMeuTar - custoMaisBarato;
                    const poupancaRel = (poupancaAbs / custoMeuTar) * 100;
                    
                    mensagemDiv.innerHTML = `
                        <span style="color:red; font-weight:bold;">
                            Poupan√ßa entre '${meuTar.nome}' (${custoMeuTar.toFixed(2)} ‚Ç¨) e o mais econ√≥mico da lista, 
                            ${maisBarato.nome} (${custoMaisBarato.toFixed(2)} ‚Ç¨): 
                        </span>
                        <span style="color:red; font-weight:bold;">${poupancaAbs.toFixed(2)} ‚Ç¨</span>
                        <span style="color:red; font-weight:bold;"> (${poupancaRel.toFixed(2)} %).</span>
                    `;
                } else {
                    mensagemDiv.innerHTML = `<span style="color:green; font-weight:bold;">Parab√©ns! O seu tarif√°rio ('${meuTar.nome}' - ${custoMeuTar.toFixed(2)}‚Ç¨) j√° √© o mais econ√≥mico ou est√° entre os mais econ√≥micos da lista!</span>`;
                }
                
                mensagemDiv.style.display = 'block';
            } catch(error) {
                console.error('Erro ao calcular mensagem de poupan√ßa:', error);
                const mensagemDiv = document.getElementById('mensagem-poupanca');
                if(mensagemDiv) mensagemDiv.style.display = 'none';
            }
        }
        
        function gerarCorGradiente(valor, minimo, maximo) {
            try {
                if(isNaN(valor) || minimo === null || maximo === null || minimo === undefined || maximo === undefined || maximo === minimo) {
                    return { bg: '#FFFFFF', text: '#000000' };
                }
                
                const midpoint = (minimo + maximo) / 2;
                let r = 255, g = 255, b = 255;
                
                // Cores: Azul (90,138,198) -> Branco (255,255,255) -> Vermelho (247,150,70)
                const verde = [90, 138, 198];
                const branco = [255, 255, 255];
                const vermelho = [247, 150, 70];
                
                if(valor <= midpoint) {
                    const ratio = (valor - minimo) / (midpoint - minimo);
                    r = Math.round(verde[0] * (1 - ratio) + branco[0] * ratio);
                    g = Math.round(verde[1] * (1 - ratio) + branco[1] * ratio);
                    b = Math.round(verde[2] * (1 - ratio) + branco[2] * ratio);
                } else {
                    const ratio = (valor - midpoint) / (maximo - midpoint);
                    r = Math.round(branco[0] * (1 - ratio) + vermelho[0] * ratio);
                    g = Math.round(branco[1] * (1 - ratio) + vermelho[1] * ratio);
                    b = Math.round(branco[2] * (1 - ratio) + vermelho[2] * ratio);
                }
                
                const luminancia = (0.299 * r + 0.587 * g + 0.114 * b);
                const corTexto = luminancia > 140 ? '#000000' : '#FFFFFF';
                
                const bgHex = '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('').toUpperCase();
                
                return { bg: bgHex, text: corTexto };
            } catch(error) {
                console.error('Erro ao gerar cor gradiente:', error);
                return { bg: '#FFFFFF', text: '#000000' };
            }
        }

        function renderTable(list, ciclo) {
            const th = document.getElementById('thead');
            const tb = document.getElementById('tbody');
            tb.innerHTML = "";
            
            // Determinar classe de cor do cabe√ßalho baseado no ciclo
            let classCiclo = '';
            if(ciclo.includes("Simples")) {
                classCiclo = 'ciclo-simples';
            } else if(ciclo.includes("Bi-hor√°rio") && ciclo.includes("Di√°rio")) {
                classCiclo = 'ciclo-bi-diario';
            } else if(ciclo.includes("Bi-hor√°rio") && ciclo.includes("Semanal")) {
                classCiclo = 'ciclo-bi-semanal';
            } else if(ciclo.includes("Tri-hor√°rio") && ciclo.includes("Di√°rio")) {
                classCiclo = 'ciclo-tri-diario';
            } else if(ciclo.includes("Tri-hor√°rio") && ciclo.includes("Semanal")) {
                classCiclo = 'ciclo-tri-semanal';
            }

            let h = `<th class="${classCiclo}" onclick="setSort('nome')">Tarif√°rio <i class="fa-solid fa-sort"></i></th>
                     <th class="${classCiclo}" onclick="setSort('total')">Total (‚Ç¨) <i class="fa-solid fa-sort"></i></th>`;
            
            const fmtH = (t, c) => `<th class="${classCiclo}" onclick="setSort('${c}')">${t} <i class="fa-solid fa-sort"></i></th>`;
            
            if(ciclo.includes("Simples")) h += fmtH("Simples (‚Ç¨/kWh)", "uS") + fmtH("Pot√™ncia (‚Ç¨/dia)", "uPot");
            else if(ciclo.includes("Bi")) h += fmtH("Vazio (‚Ç¨/kWh)", "uV") + fmtH("Fora Vazio (‚Ç¨/kWh)", "uF") + fmtH("Pot√™ncia (‚Ç¨/dia)", "uPot");
            else h += fmtH("Vazio (‚Ç¨/kWh)", "uV") + fmtH("Cheias (‚Ç¨/kWh)", "uC") + fmtH("Ponta (‚Ç¨/kWh)", "uP") + fmtH("Pot√™ncia (‚Ç¨/dia)", "uPot");
            
            h += `<th class="${classCiclo}">Detalhes</th>`;
            th.innerHTML = `<tr>${h}</tr>`;

            // Calcular min/max para cada coluna (para formata√ß√£o de cores)
            const calcMinMax = (arr, key) => {
                const vals = arr.map(i => i[key]).filter(v => v !== undefined && v !== null && !isNaN(v));
                if(vals.length === 0) return { min: null, max: null };
                return { min: Math.min(...vals), max: Math.max(...vals) };
            };
            
            const minMaxTotal = calcMinMax(list, 'total');
            const minMaxS = calcMinMax(list, 'uS');
            const minMaxV = calcMinMax(list, 'uV');
            const minMaxF = calcMinMax(list, 'uF');
            const minMaxP = calcMinMax(list, 'uP');
            const minMaxC = calcMinMax(list, 'uC');
            const minMaxPot = calcMinMax(list, 'uPot');

            const fmt = n => n.toFixed(4);
            const esc = obj => JSON.stringify(obj).replace(/"/g, '&quot;');

            list.slice(0, 150).forEach(i => {
                // Usar getTarifarioStyle para molduras e tags
                const style = getTarifarioStyle(i.tipo, i.nome);
                
                // Aplicar cores ao Total
                const coresTotal = gerarCorGradiente(i.total, minMaxTotal.min, minMaxTotal.max);
                
                let row = `
                    <td class="${style.cellClass}">
                        <div class="tariff-name" onclick="window.open('${i.details.site||'#'}', '_blank')" onmouseenter="showTooltipNome(event, ${esc(i.nome)}, ${esc(i.details.notas || '')})" onmouseleave="hideTooltip()">${i.com}</div>
                        <div style="font-size:0.78rem; color:var(--text-light); margin-bottom:4px;">${i.nome}</div>
                        <span class="tag ${style.tagClass}">${style.label}</span>
                    </td>
                    <td class="price-main" style="background-color:${coresTotal.bg}; color:${coresTotal.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipTotal(event, ${esc(i.details)}, ${esc(i.nome)})" onmouseleave="hideTooltip()">${i.total.toFixed(2)} ‚Ç¨</td>`;
                
                if(ciclo.includes("Simples")) {
                    const coresS = gerarCorGradiente(i.uS, minMaxS.min, minMaxS.max);
                    const coresPot = gerarCorGradiente(i.uPot, minMaxPot.min, minMaxPot.max);
                    row += `<td class="price-sub" style="background-color:${coresS.bg}; color:${coresS.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipEnergy(event, ${esc(i.breakdown.S)}, 'S')" onmouseleave="hideTooltip()">${fmt(i.uS)}</td>`;
                    row += `<td class="price-sub" style="background-color:${coresPot.bg}; color:${coresPot.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipPot(event, ${esc(i.potDetails)})" onmouseleave="hideTooltip()">${fmt(i.uPot)}</td>`;
                } else if(ciclo.includes("Bi")) {
                    const coresV = gerarCorGradiente(i.uV, minMaxV.min, minMaxV.max);
                    const coresF = gerarCorGradiente(i.uF, minMaxF.min, minMaxF.max);
                    const coresPot = gerarCorGradiente(i.uPot, minMaxPot.min, minMaxPot.max);
                    row += `<td class="price-sub" style="background-color:${coresV.bg}; color:${coresV.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipEnergy(event, ${esc(i.breakdown.V)}, 'V')" onmouseleave="hideTooltip()">${fmt(i.uV)}</td>`;
                    row += `<td class="price-sub" style="background-color:${coresF.bg}; color:${coresF.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipEnergy(event, ${esc(i.breakdown.F)}, 'F')" onmouseleave="hideTooltip()">${fmt(i.uF)}</td>`;
                    row += `<td class="price-sub" style="background-color:${coresPot.bg}; color:${coresPot.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipPot(event, ${esc(i.potDetails)})" onmouseleave="hideTooltip()">${fmt(i.uPot)}</td>`;
                } else {
                    const coresV = gerarCorGradiente(i.uV, minMaxV.min, minMaxV.max);
                    const coresP = gerarCorGradiente(i.uP, minMaxP.min, minMaxP.max);
                    const coresC = gerarCorGradiente(i.uC, minMaxC.min, minMaxC.max);
                    const coresPot = gerarCorGradiente(i.uPot, minMaxPot.min, minMaxPot.max);
                    row += `<td class="price-sub" style="background-color:${coresV.bg}; color:${coresV.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipEnergy(event, ${esc(i.breakdown.V)}, 'V')" onmouseleave="hideTooltip()">${fmt(i.uV)}</td>`;
                    row += `<td class="price-sub" style="background-color:${coresC.bg}; color:${coresC.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipEnergy(event, ${esc(i.breakdown.C)}, 'C')" onmouseleave="hideTooltip()">${fmt(i.uC)}</td>`;
                    row += `<td class="price-sub" style="background-color:${coresP.bg}; color:${coresP.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipEnergy(event, ${esc(i.breakdown.P)}, 'P')" onmouseleave="hideTooltip()">${fmt(i.uP)}</td>`;
                    row += `<td class="price-sub" style="background-color:${coresPot.bg}; color:${coresPot.text}; text-align:center; vertical-align:middle; border-radius:10px;" onmouseenter="showTooltipPot(event, ${esc(i.potDetails)})" onmouseleave="hideTooltip()">${fmt(i.uPot)}</td>`;
                }

                let det = "";
                if(i.details.site) det += `<a href="${i.details.site}" target="_blank" title="Aderir" style="color:var(--primary); margin-right:8px;"><i class="fa-solid fa-link"></i></a>`;
                if(i.details.notas) det += `<i class="fa-solid fa-circle-info" title="${i.details.notas}" style="color:var(--text-light); cursor:help"></i>`;
                
                row += `<td style="font-size:1.1em">${det}</td>`;

                tb.innerHTML += `<tr>${row}</tr>`;
            });
            
            // Tornar colunas redimension√°veis
            makeColumnsResizable();
        }
        
        // === RENDERIZA√á√ÉO DE TABELA EM MODO COMPARA√á√ÉO ===
        function renderTableComparacao(data, cicloOriginal) {
            const th = document.getElementById('thead');
            const tb = document.getElementById('tbody');
            tb.innerHTML = "";
            
            // data √© agora {opcoes: [...], resultados: [...]}
            const opcoes = data.opcoes || [];
            const list = data.resultados || [];
            
            if(opcoes.length <= 1 || list.length === 0) {
                renderTable(list, cicloOriginal);
                return;
            }

            // Fun√ß√£o para obter a classe de ciclo correta (distinguindo Di√°rio/Semanal)
            const getCicloClass = (d) => {
                if(d.includes('Simples')) return 'ciclo-simples';
                if(d.includes('Bi') && d.includes('Semanal')) return 'ciclo-bi-semanal';
                if(d.includes('Bi')) return 'ciclo-bi-diario';
                if(d.includes('Tri') && d.includes('Semanal')) return 'ciclo-tri-semanal';
                if(d.includes('Tri')) return 'ciclo-tri-diario';
                return '';
            };

            // Classe do ciclo original selecionado pelo utilizador
            const cicloOrigClass = getCicloClass(cicloOriginal);
            
            // --- SUM√ÅRIO: melhor por coluna ---
            let melhorPorOpcao = {};
            opcoes.forEach(opc => {
                let melhorNome = '', melhorCusto = Infinity;
                list.forEach(i => {
                    const c = i.custos[opc.display];
                    if(c !== undefined && !isNaN(c) && c < melhorCusto && i.tipo !== 'Utilizador') {
                        melhorCusto = c; melhorNome = i.com + ' - ' + i.nome;
                    }
                });
                if(melhorNome) melhorPorOpcao[opc.display] = { nome: melhorNome, custo: melhorCusto };
            });

            // Verificar se "Meu Tarif√°rio" est√° ativo e tem valor
            const meuTar = list.find(i => i.tipo === 'Utilizador');
            const meuTarOpc = meuTar ? Object.keys(meuTar.custos)[0] : null;
            const meuTarCusto = meuTar && meuTarOpc ? meuTar.custos[meuTarOpc] : null;

            let summaryHtml = '<div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #bae6fd; border-radius: 10px; padding: 14px 18px; margin-bottom: 14px; font-size: 0.85rem; line-height: 1.6;">';
            summaryHtml += '<div style="font-weight: 700; margin-bottom: 6px; color: #0369a1;"><i class="fa-solid fa-trophy" style="margin-right:6px;"></i>Melhores Op√ß√µes por Ciclo</div>';
            
            opcoes.forEach(opc => {
                const best = melhorPorOpcao[opc.display];
                if(!best) return;
                let classColor = getCicloClass(opc.display);
                let bgColor = '#e5e7eb';
                if(classColor.includes('simples')) bgColor = '#A6A6A6';
                else if(classColor.includes('bi-semanal')) bgColor = '#8EA9DB';
                else if(classColor.includes('bi-diario')) bgColor = '#A9D08E';
                else if(classColor.includes('tri-semanal')) bgColor = '#C65911';
                else if(classColor.includes('tri-diario')) bgColor = '#BF8F00';
                let textColor = (classColor.includes('tri')) ? '#fff' : '#000';
                
                summaryHtml += `<div style="margin: 4px 0;">`;
                summaryHtml += `<span style="display:inline-block; background:${bgColor}; color:${textColor}; padding:2px 8px; border-radius:4px; font-weight:600; font-size:0.78rem; min-width:90px; text-align:center;">${opc.display}</span> `;
                summaryHtml += `<strong>${best.nome}</strong> com <strong style="color:#16a34a;">${best.custo.toFixed(2)} ‚Ç¨</strong>`;
                
                // Comparar com Meu Tarif√°rio se existir
                if(meuTarCusto !== null) {
                    const diff = meuTarCusto - best.custo;
                    if(diff > 0.01) {
                        summaryHtml += ` <span style="color:#16a34a; font-size:0.8rem;">(poupa ${diff.toFixed(2)} ‚Ç¨ vs O Meu Tarif√°rio)</span>`;
                    } else if(diff < -0.01) {
                        summaryHtml += ` <span style="color:#dc2626; font-size:0.8rem;">(+${Math.abs(diff).toFixed(2)} ‚Ç¨ vs O Meu Tarif√°rio)</span>`;
                    } else {
                        summaryHtml += ` <span style="color:#6b7280; font-size:0.8rem;">(‚âà O Meu Tarif√°rio)</span>`;
                    }
                }
                summaryHtml += `</div>`;
            });
            
            summaryHtml += '</div>';
            
            // Inserir sum√°rio antes da tabela
            let summaryDiv = document.getElementById('comparacao-summary');
            if(!summaryDiv) {
                summaryDiv = document.createElement('div');
                summaryDiv.id = 'comparacao-summary';
                const tabela = document.getElementById('tabela');
                tabela.parentNode.insertBefore(summaryDiv, tabela);
            }
            summaryDiv.innerHTML = summaryHtml;
            
            // Construir cabe√ßalho (sem coluna "Melhor Op√ß√£o")
            let h = `<th onclick="setSortComparacao('nome')">Tarif√°rio <i class="fa-solid fa-sort"></i></th>`;
            
            opcoes.forEach(opc => {
                let classCiclo = getCicloClass(opc.display);
                h += `<th class="${classCiclo}" onclick="setSortComparacao('${opc.display}')">${opc.display} (‚Ç¨) <i class="fa-solid fa-sort"></i></th>`;
            });
            
            h += `<th>Detalhes</th>`;
            
            th.innerHTML = `<tr>${h}</tr>`;
            
            // Calcular min/max para cores por coluna
            const minMaxPorOpcao = {};
            opcoes.forEach(opc => {
                const vals = list.map(i => i.custos[opc.display]).filter(v => v !== undefined && v !== null && !isNaN(v));
                if(vals.length > 0) minMaxPorOpcao[opc.display] = { min: Math.min(...vals), max: Math.max(...vals) };
                else minMaxPorOpcao[opc.display] = { min: null, max: null };
            });

            const esc = obj => JSON.stringify(obj).replace(/\"/g, '&quot;');
            
            // Renderizar linhas
            list.slice(0, 150).forEach(i => {
                const style = getTarifarioStyle(i.tipo, i.nome);
                
                let row = `
                    <td class="${style.cellClass}">
                        <div class="tariff-name" ${i.site ? `onclick="window.open('${i.site}', '_blank')"` : ''}>${i.com}</div>
                        <div style="font-size:0.78rem; color:var(--text-light); margin-bottom:4px;">${i.nome}</div>
                        <span class="tag ${style.tagClass}">${style.label}</span>
                    </td>`;
                
                // Colunas de custos com tooltip
                opcoes.forEach(opc => {
                    const custo = i.custos[opc.display];
                    const detalhe = i.detalhes ? i.detalhes[opc.display] : null;
                    if(custo !== undefined && custo !== null && !isNaN(custo)) {
                        const minMax = minMaxPorOpcao[opc.display];
                        const cores = gerarCorGradiente(custo, minMax.min, minMax.max);
                        const melhor = i.melhorOpcao === opc.display && Object.keys(i.custos).length > 1;
                        const tooltipHandler = detalhe ? `onmouseenter="showTooltipComparacao(event, ${esc(detalhe)}, ${esc(i.nome)}, ${esc(opc.display)})" onmouseleave="hideTooltip()"` : '';
                        row += `<td class="price-main" style="background-color:${cores.bg}; color:${cores.text}; text-align:center; border-radius:10px; cursor:default; ${melhor ? 'font-weight:bold; border:2px solid #16a34a;' : ''}" ${tooltipHandler}>${custo.toFixed(2)} ‚Ç¨</td>`;
                    } else {
                        row += `<td style="text-align:center; color:var(--text-light);">‚Äî</td>`;
                    }
                });
                
                // Detalhes
                let det = "";
                if(i.site) det += `<a href="${i.site}" target="_blank" title="Aderir" style="color:var(--primary); margin-right:8px;"><i class="fa-solid fa-link"></i></a>`;
                if(i.notas) det += `<i class="fa-solid fa-circle-info" title="${i.notas}" style="color:var(--text-light); cursor:help"></i>`;
                row += `<td style="font-size:1.1em; text-align:center;">${det}</td>`;
                
                tb.innerHTML += `<tr>${row}</tr>`;
            });
            
            makeColumnsResizable();
        }
        
        // Fun√ß√£o de ordena√ß√£o para modo compara√ß√£o
        let SORT_COMPARACAO = { col: '', asc: true };
        function setSortComparacao(col) {
            if(SORT_COMPARACAO.col === col) {
                SORT_COMPARACAO.asc = !SORT_COMPARACAO.asc;
            } else {
                SORT_COMPARACAO.col = col;
                SORT_COMPARACAO.asc = true;
            }
            
            // Re-calcular para aplicar nova ordena√ß√£o
            calcular();
        }
        
        function makeColumnsResizable() {
            const table = document.getElementById('tabela');
            const cols = table.querySelectorAll('th');
            
            cols.forEach(col => {
                // Evita duplicar resizers se a fun√ß√£o for chamada v√°rias vezes
                if (col.querySelector('.resizer')) return;

                const resizer = document.createElement('div');
                resizer.classList.add('resizer');
                col.appendChild(resizer);

                let startX, startWidth;

                resizer.addEventListener('mousedown', e => {
                    startX = e.pageX;
                    startWidth = col.offsetWidth;
                    
                    const onMouseMove = e => {
                        const width = startWidth + (e.pageX - startX);
                        col.style.width = width + 'px';
                    };

                    const onMouseUp = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    };

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            });
        }

        function setSort(col) {
            if(SORT.col === col) SORT.asc = !SORT.asc;
            else { SORT.col = col; SORT.asc = true; }
            calcular();
        }

        // TOOLTIPS
        function showTooltipTotal(e, details, nomeTarifario) {
            const tt = document.getElementById('tooltip');
            let html = `<div style="font-weight:700; margin-bottom:8px; font-size:0.9rem;">Decomposi√ß√£o Custo Total</div>`;
            html += `<div style="font-size:0.8rem; color:#cbd5e1; margin-bottom:8px;">${nomeTarifario || ''}</div>`;
            
            let hasPot6 = details.costPot6 > 0 || details.taxPot6 > 0;
            let hasPot23 = details.costPot23 > 0 || details.taxPot23 > 0;
            
            if(hasPot6 || hasPot23) {
                html += '<div style="font-weight:600; margin-top:8px; color:#cbd5e1; font-size:0.75rem;">POT√äNCIA</div>';
                if(hasPot6) html += `<div class="tooltip-line"><span>Pot√™ncia (base s/ IVA 6%):</span><span>${details.costPot6.toFixed(2)} ‚Ç¨</span></div>`;
                if(hasPot23) html += `<div class="tooltip-line"><span>Pot√™ncia (base s/ IVA 23%):</span><span>${details.costPot23.toFixed(2)} ‚Ç¨</span></div>`;
            }
            
            let hasEn6 = details.costEn6 > 0 || details.taxEn6 > 0;
            let hasEn23 = details.costEn23 > 0 || details.taxEn23 > 0;
            
            if(hasEn6 || hasEn23) {
                html += '<div style="font-weight:600; margin-top:8px; color:#cbd5e1; font-size:0.75rem;">ENERGIA</div>';
                if(hasEn6) html += `<div class="tooltip-line"><span>Energia (base s/ IVA 6%):</span><span>${details.costEn6.toFixed(2)} ‚Ç¨</span></div>`;
                if(hasEn23) html += `<div class="tooltip-line"><span>Energia (base s/ IVA 23%):</span><span>${details.costEn23.toFixed(2)} ‚Ç¨</span></div>`;
            }
            
            let subtotalPotEn = (details.costPot6||0) + (details.costPot23||0) + (details.costEn6||0) + (details.costEn23||0);
            html += `<div class="tooltip-line subtotal"><span>Subtotal Pot√™ncia + Energia:</span><span>${subtotalPotEn.toFixed(2)} ‚Ç¨</span></div>`;
            
            html += '<div style="font-weight:600; margin-top:8px; color:#cbd5e1; font-size:0.75rem;">TAXAS E CONTRIBUI√á√ïES</div>';
            html += `<div class="tooltip-line"><span>CAV s/ IVA:</span><span>${details.cav.toFixed(2)} ‚Ç¨</span></div>`;
            html += `<div class="tooltip-line"><span>DGEG s/ IVA:</span><span>${details.dgeg.toFixed(2)} ‚Ç¨</span></div>`;
            html += `<div class="tooltip-line"><span>IEC s/ IVA:</span><span>${details.iec.toFixed(4)} ‚Ç¨</span></div>`;
            
            let subtotalTaxas = details.cav + details.dgeg + details.iec;
            html += `<div class="tooltip-line subtotal"><span>Subtotal Taxas:</span><span>${subtotalTaxas.toFixed(2)} ‚Ç¨</span></div>`;
            
            let totalSemIVA = subtotalPotEn + subtotalTaxas;
            html += `<div class="tooltip-line subtotal"><span><strong>Total s/ IVA:</strong></span><span><strong>${totalSemIVA.toFixed(2)} ‚Ç¨</strong></span></div>`;
            
            html += '<div class="tooltip-section"></div>';
            html += '<div style="font-weight:600; margin-top:6px; color:#cbd5e1; font-size:0.75rem;">IVA</div>';
            let totalIVA6 = (details.taxPot6||0) + (details.taxEn6||0) + (details.taxCAV||0);
            let totalIVA23 = (details.taxPot23||0) + (details.taxEn23||0) + (details.taxIEC||0) + (details.taxDGEG||0);
            
            if(totalIVA6 > 0) html += `<div class="tooltip-line"><span>IVA 6%:</span><span>${totalIVA6.toFixed(2)} ‚Ç¨</span></div>`;
            html += `<div class="tooltip-line"><span>IVA 23%:</span><span>${totalIVA23.toFixed(2)} ‚Ç¨</span></div>`;
            
            let totalComIVA = totalSemIVA + totalIVA6 + totalIVA23;
            
            let extras = (details.desc > 0) || (details.quotaACP > 0) || (details.acrescimo > 0);
            if(extras) {
                html += '<div class="tooltip-section"></div>';
                if(details.desc > 0) html += `<div class="tooltip-line"><span>Desconto Fatura:</span><span style="color:#4ade80">-${details.desc.toFixed(2)} ‚Ç¨</span></div>`;
                if(details.quotaACP > 0) html += `<div class="tooltip-line"><span>Quota ACP:</span><span style="color:#f87171">+${details.quotaACP.toFixed(2)} ‚Ç¨</span></div>`;
                if(details.acrescimo > 0) html += `<div class="tooltip-line"><span>Acr√©scimo Fatura:</span><span style="color:#f87171">+${details.acrescimo.toFixed(2)} ‚Ç¨</span></div>`;
            }
            
            let total = totalComIVA - (details.desc||0) + (details.quotaACP||0) + (details.acrescimo||0);
            html += `<div class="tooltip-line total"><span>CUSTO TOTAL:</span><span>${total.toFixed(2)} ‚Ç¨</span></div>`;
            
            tt.innerHTML = html;
            tt.classList.remove('hidden');
            positionTooltip(e, tt);
        }

        function showTooltipComparacao(e, resultObj, nomeTarifario, opcDisplay) {
            const tt = document.getElementById('tooltip');
            const details = resultObj.details;
            if(!details) return;
            
            let html = `<div style="font-weight:700; margin-bottom:4px; font-size:0.9rem;">Decomposi√ß√£o Custo Total</div>`;
            html += `<div style="font-size:0.8rem; color:#cbd5e1; margin-bottom:6px;">${nomeTarifario || ''}</div>`;
            html += `<div style="font-size:0.78rem; color:#93c5fd; margin-bottom:8px; font-style:italic;">${opcDisplay || ''}</div>`;
            
            // Pre√ßos unit√°rios (s/IVA)
            html += '<div style="font-weight:600; color:#fbbf24; font-size:0.75rem; margin-bottom:2px;">PRE√áOS UNIT√ÅRIOS (s/ IVA)</div>';
            const fmt4 = (v) => v !== undefined && v !== 0 ? v.toFixed(4) : null;
            let temPrecos = false;
            if(fmt4(resultObj.uS)) { html += `<div class="tooltip-line"><span>Energia Simples:</span><span>${fmt4(resultObj.uS)} ‚Ç¨/kWh</span></div>`; temPrecos=true; }
            if(fmt4(resultObj.uV)) { html += `<div class="tooltip-line"><span>Energia Vazio:</span><span>${fmt4(resultObj.uV)} ‚Ç¨/kWh</span></div>`; temPrecos=true; }
            if(fmt4(resultObj.uF)) { html += `<div class="tooltip-line"><span>Energia Fora Vazio:</span><span>${fmt4(resultObj.uF)} ‚Ç¨/kWh</span></div>`; temPrecos=true; }
            if(fmt4(resultObj.uC)) { html += `<div class="tooltip-line"><span>Energia Cheias:</span><span>${fmt4(resultObj.uC)} ‚Ç¨/kWh</span></div>`; temPrecos=true; }
            if(fmt4(resultObj.uP)) { html += `<div class="tooltip-line"><span>Energia Ponta:</span><span>${fmt4(resultObj.uP)} ‚Ç¨/kWh</span></div>`; temPrecos=true; }
            if(fmt4(resultObj.uPot)) { html += `<div class="tooltip-line"><span>Pot√™ncia:</span><span>${fmt4(resultObj.uPot)} ‚Ç¨/dia</span></div>`; temPrecos=true; }
            if(!temPrecos) html += `<div class="tooltip-line" style="color:#94a3b8;"><span>‚Äî</span></div>`;
            
            html += '<div class="tooltip-section"></div>';
            
            // Decomposi√ß√£o (igual ao tooltip Total normal)
            let hasPot6 = details.costPot6 > 0 || details.taxPot6 > 0;
            let hasPot23 = details.costPot23 > 0 || details.taxPot23 > 0;
            if(hasPot6 || hasPot23) {
                html += '<div style="font-weight:600; margin-top:4px; color:#cbd5e1; font-size:0.75rem;">POT√äNCIA</div>';
                if(hasPot6) html += `<div class="tooltip-line"><span>Pot√™ncia (base s/ IVA 6%):</span><span>${details.costPot6.toFixed(2)} ‚Ç¨</span></div>`;
                if(hasPot23) html += `<div class="tooltip-line"><span>Pot√™ncia (base s/ IVA 23%):</span><span>${details.costPot23.toFixed(2)} ‚Ç¨</span></div>`;
            }
            let hasEn6 = details.costEn6 > 0 || details.taxEn6 > 0;
            let hasEn23 = details.costEn23 > 0 || details.taxEn23 > 0;
            if(hasEn6 || hasEn23) {
                html += '<div style="font-weight:600; margin-top:4px; color:#cbd5e1; font-size:0.75rem;">ENERGIA</div>';
                if(hasEn6) html += `<div class="tooltip-line"><span>Energia (base s/ IVA 6%):</span><span>${details.costEn6.toFixed(2)} ‚Ç¨</span></div>`;
                if(hasEn23) html += `<div class="tooltip-line"><span>Energia (base s/ IVA 23%):</span><span>${details.costEn23.toFixed(2)} ‚Ç¨</span></div>`;
            }
            let subtotalPotEn = (details.costPot6||0) + (details.costPot23||0) + (details.costEn6||0) + (details.costEn23||0);
            html += `<div class="tooltip-line subtotal"><span>Subtotal Pot√™ncia + Energia:</span><span>${subtotalPotEn.toFixed(2)} ‚Ç¨</span></div>`;
            
            html += '<div style="font-weight:600; margin-top:4px; color:#cbd5e1; font-size:0.75rem;">TAXAS E CONTRIBUI√á√ïES</div>';
            html += `<div class="tooltip-line"><span>CAV s/ IVA:</span><span>${details.cav.toFixed(2)} ‚Ç¨</span></div>`;
            html += `<div class="tooltip-line"><span>DGEG s/ IVA:</span><span>${details.dgeg.toFixed(2)} ‚Ç¨</span></div>`;
            html += `<div class="tooltip-line"><span>IEC s/ IVA:</span><span>${details.iec.toFixed(4)} ‚Ç¨</span></div>`;
            let subtotalTaxas = details.cav + details.dgeg + details.iec;
            html += `<div class="tooltip-line subtotal"><span>Subtotal Taxas:</span><span>${subtotalTaxas.toFixed(2)} ‚Ç¨</span></div>`;
            let totalSemIVA = subtotalPotEn + subtotalTaxas;
            html += `<div class="tooltip-line subtotal"><span><strong>Total s/ IVA:</strong></span><span><strong>${totalSemIVA.toFixed(2)} ‚Ç¨</strong></span></div>`;
            
            html += '<div class="tooltip-section"></div>';
            html += '<div style="font-weight:600; margin-top:4px; color:#cbd5e1; font-size:0.75rem;">IVA</div>';
            let totalIVA6 = (details.taxPot6||0) + (details.taxEn6||0) + (details.taxCAV||0);
            let totalIVA23 = (details.taxPot23||0) + (details.taxEn23||0) + (details.taxIEC||0) + (details.taxDGEG||0);
            if(totalIVA6 > 0) html += `<div class="tooltip-line"><span>IVA 6%:</span><span>${totalIVA6.toFixed(2)} ‚Ç¨</span></div>`;
            html += `<div class="tooltip-line"><span>IVA 23%:</span><span>${totalIVA23.toFixed(2)} ‚Ç¨</span></div>`;
            let totalComIVA = totalSemIVA + totalIVA6 + totalIVA23;
            
            let extras = (details.desc > 0) || (details.quotaACP > 0) || (details.acrescimo > 0);
            if(extras) {
                html += '<div class="tooltip-section"></div>';
                if(details.desc > 0) html += `<div class="tooltip-line"><span>Desconto Fatura:</span><span style="color:#4ade80">-${details.desc.toFixed(2)} ‚Ç¨</span></div>`;
                if(details.quotaACP > 0) html += `<div class="tooltip-line"><span>Quota ACP:</span><span style="color:#f87171">+${details.quotaACP.toFixed(2)} ‚Ç¨</span></div>`;
                if(details.acrescimo > 0) html += `<div class="tooltip-line"><span>Acr√©scimo Fatura:</span><span style="color:#f87171">+${details.acrescimo.toFixed(2)} ‚Ç¨</span></div>`;
            }
            
            let total = totalComIVA - (details.desc||0) + (details.quotaACP||0) + (details.acrescimo||0);
            html += `<div class="tooltip-line total"><span>CUSTO TOTAL:</span><span>${total.toFixed(2)} ‚Ç¨</span></div>`;
            
            tt.innerHTML = html;
            tt.classList.remove('hidden');
            positionTooltip(e, tt);
        }

        function showTooltipEnergy(e, breakdown, periodo) {
            const tt = document.getElementById('tooltip');
            
            // Mapa de nomes de per√≠odos
            const nomesPeriodos = {
                'S': 'Simples',
                'V': 'Vazio',
                'F': 'Fora Vazio',
                'C': 'Cheias',
                'P': 'Ponta'
            };
            
            const nomePeriodo = nomesPeriodos[periodo] || 'Energia';
            
            let html = `<div style="font-weight:700; margin-bottom:6px; font-size:0.85rem;">Decomposi√ß√£o Pre√ßo ${nomePeriodo} s/IVA</div>`;
            
            html += `<div class="tooltip-line"><span>Comercial (s/ TAR):</span><span>${breakdown.comercialSemTar.toFixed(4)} ‚Ç¨</span></div>`;
            html += `<div class="tooltip-line"><span>TAR (Acesso Redes):</span><span>${breakdown.tarValue.toFixed(4)} ‚Ç¨</span></div>`;
            
            if(!breakdown.tseIncluded) {
                html += `<div class="tooltip-line"><span>Financ. TSE:</span><span>${breakdown.tse.toFixed(4)} ‚Ç¨</span></div>`;
            } else {
                html += `<div class="tooltip-line" style="background-color:#78350f20; padding:4px; border-radius:4px; color:#fbbf24;"><span>‚ÑπÔ∏è Financiamento TSE inclu√≠do no pre√ßo</span></div>`;
            }
            
            let total = breakdown.comercialSemTar + breakdown.tarValue + breakdown.tse;
            html += `<div class="tooltip-line total"><span>TOTAL UNIT√ÅRIO:</span><span>${total.toFixed(4)} ‚Ç¨</span></div>`;
            
            tt.innerHTML = html;
            tt.classList.remove('hidden');
            positionTooltip(e, tt);
        }

        function showTooltipNome(e, nomeTarifario, notas) {
            const tt = document.getElementById('tooltip');
            let html = `<div style="font-weight:700; margin-bottom:8px; font-size:0.9rem;">${nomeTarifario}</div>`;
            
            if(notas && notas.trim()) {
                html += `<div style="font-size:0.85rem; line-height:1.4;">${notas}</div>`;
            }
            
            tt.innerHTML = html;
            tt.classList.remove('hidden');
            positionTooltip(e, tt);
        }

        function showTooltipPot(e, potDetails) {
            const tt = document.getElementById('tooltip');
            let html = '<div style="font-weight:700; margin-bottom:6px; font-size:0.85rem;">Decomposi√ß√£o Pot√™ncia s/IVA</div>';
            
            let potVal = parseFloat(document.getElementById('potencia').value);
            let ivaTarTxt = potVal <= 3.45 ? 'IVA 6%' : 'IVA 23%';
            
            html += `<div class="tooltip-line"><span>Comercial (IVA 23%):</span><span>${potDetails.comercial.toFixed(4)} ‚Ç¨</span></div>`;
            html += `<div class="tooltip-line"><span>TAR (${ivaTarTxt}):</span><span>${potDetails.tarPotValue.toFixed(4)} ‚Ç¨</span></div>`;
            
            let total = potDetails.comercial + potDetails.tarPotValue;
            html += `<div class="tooltip-line total"><span>TOTAL UNIT√ÅRIO:</span><span>${total.toFixed(4)} ‚Ç¨</span></div>`;
            
            tt.innerHTML = html;
            tt.classList.remove('hidden');
            positionTooltip(e, tt);
        }

        function positionTooltip(e, tt) {
            let x = e.pageX + 15;
            let y = e.pageY + 15;
            
            setTimeout(() => {
                if(x + tt.offsetWidth > window.innerWidth) x = e.pageX - tt.offsetWidth - 15;
                if(y + tt.offsetHeight > window.innerHeight + window.scrollY) {
                     y = e.pageY - tt.offsetHeight - 15;
                }
                
                tt.style.left = x + 'px';
                tt.style.top = y + 'px';
            }, 0);
        }

        function limparDadosERedes() {
            // Limpar dados globais
            DADOS_EREDES = null;
            
            // Limpar estado da Aba 3
            STATE_ABA3.ficheiroProcessado = false;
            STATE_ABA3.dadosERedes = null;
            STATE_ABA3.dataInicio = null;
            STATE_ABA3.dataFim = null;
            STATE_ABA3.consumos = { S: 0, V: 0, F: 0, C: 0, P: 0 };
            
            // Reativar inputs
            document.getElementById('d_inicio').disabled = false;
            document.getElementById('d_fim').disabled = false;
            
            const consumoInputs = ['kwh_S', 'kwh_V', 'kwh_F', 'kwh_C', 'kwh_P'];
            consumoInputs.forEach(id => {
                const elem = document.getElementById(id);
                if(elem) elem.disabled = false;
            });
            
            // Repor datas default (Ciclo de fatura√ß√£o correto)
            const defaults = getDefaultDates();
            
            // Resetar limites para permitir escolha livre
            const year = new Date().getFullYear();
            document.getElementById('d_inicio').min = `${year}-01-01`;
            document.getElementById('d_inicio').max = `${year+2}-12-31`;
            document.getElementById('d_fim').min = `${year}-01-01`;
            document.getElementById('d_fim').max = `${year+2}-12-31`;
            
            document.getElementById('d_inicio').value = defaults.start;
            document.getElementById('d_fim').value = defaults.end;
            
            // Ocultar tabela de an√°lise
            document.getElementById('analise-consumos').style.display = 'none';
            document.getElementById('analise-content').innerHTML = '';
            
            // Ocultar gr√°ficos de an√°lise
            const graficosAnalise = document.getElementById('graficos-analise-eredes');
            if(graficosAnalise) graficosAnalise.style.display = 'none';
            
            // Ocultar an√°lise de pot√™ncia
            const analisePotencia = document.getElementById('analise-potencia');
            if(analisePotencia) analisePotencia.style.display = 'none';
            
            // Mostrar √°rea de upload na sidebar
            document.getElementById('eredes-upload').style.display = 'block';
            document.getElementById('eredes-limpar').style.display = 'none';
            
            // Limpar textos de status
            document.getElementById('eredes-status').innerHTML = '';
            document.getElementById('eredes-info').innerHTML = '';
            document.getElementById('file-eredes').value = ''; 
            
            // Limpar input da √°rea central tamb√©m
            const fileCentral = document.getElementById('file-eredes-central');
            if(fileCentral) fileCentral.value = '';
            const statusCentral = document.getElementById('eredes-status-central');
            if(statusCentral) statusCentral.innerHTML = '';
            
            // Reexibir e limpar √°rea de OMIE
            const omiePanel = document.getElementById('omie-panel');
            if(omiePanel) omiePanel.classList.remove('hidden');
            
            OMIE_MANUAL = false;
            
            // Se estiver na Aba 3, voltar a mostrar √°rea de upload central
            if(CURRENT_TAB === 'advanced') {
                document.getElementById('app').classList.add('hidden');
                document.getElementById('eredes-upload-central').classList.remove('hidden');
            } else {
                construirInputsConsumo(); // Reseta os valores dos inputs para os defaults (158, 63, etc.)
            }
            
            // For√ßar atualiza√ß√£o dos dias e recalcular
            atualizarDias();
        }
        
        function hideTooltip() {
            document.getElementById('tooltip').classList.add('hidden');
        }

        // --- FUN√á√ÉO PARA CARREGAR BASE DE DADOS MANUALMENTE (MODO LOCAL) ---
        function lerBaseDadosManual(input) {
            const f = input.files[0];
            if(f) { 
                const r = new FileReader(); 
                r.onload = e => loadData(e.target.result); 
                r.readAsArrayBuffer(f); 
            }
        }

        // ===== PROCESSAMENTO DE FICHEIROS E-REDES =====
        
        let DADOS_EREDES = null; // Armazena dados processados dos ficheiros E-Redes
        
        async function processarFicheirosERedes() {
            const fileInput = document.getElementById('file-eredes');
            const status = document.getElementById('eredes-status');
            const info = document.getElementById('eredes-info');
            
            if(!fileInput.files || fileInput.files.length === 0) {
                status.innerHTML = '<span style="color:red;">‚ö†Ô∏è Selecione pelo menos um ficheiro Excel</span>';
                return;
            }
            
            status.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> A processar ficheiros...';
            info.style.display = 'none';
            
            try {
                const ficheirosProcessados = [];
                for(let i = 0; i < fileInput.files.length; i++) {
                    const file = fileInput.files[i];
                    status.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> A processar ${file.name} (${i+1}/${fileInput.files.length})...`;
                    
                    const resultado = await processarFicheiroERedes(file);
                    if(resultado.erro) {
                        status.innerHTML = `<span style="color:red;">‚ùå Erro: ${resultado.erro}</span>`;
                        return;
                    }
                    ficheirosProcessados.push(resultado.dados);
                }
                
                const resultado = validarEJuntarFicheiros(ficheirosProcessados);
                if(resultado.erro) {
                    status.innerHTML = `<span style="color:red;">‚ùå ${resultado.erro}</span>`;
                    return;
                }
                
                const consumosAgregados = agregarConsumosPorPeriodo(resultado.dados);
                const mediasOMIE = calcularMediasOMIE(resultado.dados);
                
                // Calcular intervalo de datas
                const primeiroRegisto = resultado.dados[0];
                const ultimoRegisto = resultado.dados[resultado.dados.length - 1];
                
                const dataInicioStr = primeiroRegisto.DataHora.split('T')[0];
                const dataFimStr = ultimoRegisto.DataHora.split('T')[0];
                
                const d1 = new Date(dataInicioStr);
                const d2 = new Date(dataFimStr);
                const diffTime = Math.abs(d2 - d1);
                const dias = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                
                DADOS_EREDES = {
                    dadosBrutos: resultado.dados,
                    consumosAgregados: consumosAgregados,
                    mediasOMIE: mediasOMIE,
                    periodo: {
                        inicio: dataInicioStr,
                        fim: dataFimStr,
                        dias: dias
                    }
                };
                
                aplicarDadosERedes(); // Atualiza datas e limites da Aba 3

                // --- Preencher Inputs da Aba 2 (Simula√ß√£o Completa) ---
                // 1. Atualizar OMIE Values com o hist√≥rico real para come√ßar com base realista
                if(mediasOMIE.S) {
                    OMIE_VALUES.S = mediasOMIE.S;
                    // Mapear restantes m√©dias se existirem
                    if(mediasOMIE.BD_V) OMIE_VALUES.V = mediasOMIE.BD_V; // Exemplo para Vazio
                    // (A l√≥gica completa de mapeamento √© feita no calcular() se necess√°rio, 
                    // mas aqui garantimos que o valor base S est√° alinhado com o ficheiro)
                }

                // 2. INJETAR TOTAIS NOS INPUTS DA ABA 2
                // Isto permite que a Aba 2 funcione em modo "Perfil" com os volumes reais
                // O utilizador pode depois alterar estes valores livremente.
                const cicloAtual = document.getElementById('ciclo').value;
                
                if(cicloAtual.includes('Simples')) {
                    const el = document.getElementById('kwh_S'); 
                    if(el) el.value = Math.round(consumosAgregados.Simples);
                } else if(cicloAtual.includes('Bi')) {
                    // Detecta se √© Di√°rio ou Semanal para ir buscar a chave certa ao objeto consumosAgregados
                    const tipo = cicloAtual.includes('Di√°rio') ? 'BD' : 'BS';
                    const elV = document.getElementById('kwh_V'); 
                    const elF = document.getElementById('kwh_F');
                    
                    if(elV) elV.value = Math.round(consumosAgregados[tipo].V);
                    if(elF) elF.value = Math.round(consumosAgregados[tipo].F);
                } else {
                    const tipo = cicloAtual.includes('Di√°rio') ? 'TD' : 'TS';
                    const elV = document.getElementById('kwh_V');
                    const elP = document.getElementById('kwh_P');
                    const elC = document.getElementById('kwh_C');
                    
                    if(elV) elV.value = Math.round(consumosAgregados[tipo].V);
                    if(elP) elP.value = Math.round(consumosAgregados[tipo].P);
                    if(elC) elC.value = Math.round(consumosAgregados[tipo].C);
                }
                // ------------------------------------------------------------------

                const tabelaHTML = criarTabelaAnalise(consumosAgregados, mediasOMIE);
                document.getElementById('analise-content').innerHTML = tabelaHTML;
                document.getElementById('analise-consumos').style.display = 'block';
                
                const msg = resultado.aviso || '';
                
                document.getElementById('eredes-upload').style.display = 'none';
                document.getElementById('eredes-limpar').style.display = 'block';
                
                const numFicheiros = fileInput.files.length;
                const fmtData = (s) => s.split('-').reverse().join('/');
                
                document.getElementById('eredes-resumo').innerHTML = `
                    <b>${numFicheiros} ficheiro(s):</b> ${fmtData(dataInicioStr)} a ${fmtData(dataFimStr)} (${dias} dias)
                    ${msg ? `<br><span style="color:#d97706;">${msg}</span>` : ''}
                `;
                
                calcular();
                
            } catch(error) {
                console.error('Erro ao processar ficheiros:', error);
                status.innerHTML = `<span style="color:red;">‚ùå Erro: ${error.message}</span>`;
            }
        }

        async function processarFicheiroERedes(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        // Assumir primeira sheet
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        // Converter para JSON (sem header ainda)
                        const rawData = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: null});
                        
                        // Detectar cabe√ßalho
                        const resultado = detectarCabecalho(rawData);
                        if(resultado.erro) {
                            resolve({erro: `${file.name}: ${resultado.erro}`});
                            return;
                        }
                        
                        // Processar dados
                        const dadosProcessados = processarDadosConsumo(rawData, resultado.headerRow, resultado.colunaConsumo);
                        if(dadosProcessados.erro) {
                            resolve({erro: `${file.name}: ${dadosProcessados.erro}`});
                            return;
                        }
                        
                        resolve({dados: dadosProcessados.registos});
                        
                    } catch(error) {
                        resolve({erro: `${file.name}: ${error.message}`});
                    }
                };
                
                reader.onerror = () => resolve({erro: `${file.name}: Erro ao ler ficheiro`});
                reader.readAsArrayBuffer(file);
            });
        }
        
        function detectarCabecalho(rawData) {
            const colunasConsumo = [
                'Consumo Simulado (kW)',
                'Consumo medido na IC, Ativa (kW)',
                'Consumo registado (kW)',
                'Consumo registado, Ativa (kW)'
            ];
            
            for(let i = 0; i < Math.min(20, rawData.length); i++) {
                const row = rawData[i];
                if(!row) continue;
                
                for(const nomeColuna of colunasConsumo) {
                    const idx = row.indexOf(nomeColuna);
                    if(idx !== -1) {
                        return {
                            headerRow: i,
                            colunaConsumo: nomeColuna,
                            colIndex: idx
                        };
                    }
                }
            }
            
            return {erro: 'N√£o foi encontrada coluna de consumo conhecida'};
        }
        
        function processarDadosConsumo(rawData, headerRow, colunaConsumo) {
            try {
                const headers = rawData[headerRow].map(h => h ? h.toString().trim() : '');
                const idxConsumo = headers.indexOf(colunaConsumo);
                const idxData = headers.indexOf('Data');
                const idxHora = headers.indexOf('Hora');
                
                if(idxConsumo === -1 || idxData === -1 || idxHora === -1) return {erro: 'Colunas Data, Hora ou Consumo em falta'};
                
                const registos = [];
                for(let i = headerRow + 1; i < rawData.length; i++) {
                    const row = rawData[i];
                    if(!row || row.length === 0) continue;
                    
                    const consumoKW = parseFloat(row[idxConsumo]);
                    if(isNaN(consumoKW)) continue;
                    
                    // --- L√ìGICA R√çGIDA PARA E-REDES (YYYY/MM/DD) ---
                    let ano, mes, dia, horas = 0, minutos = 0;
                    
                    let dataStr = row[idxData];
                    if(typeof dataStr === 'number') {
                        const ed = XLSX.SSF.parse_date_code(dataStr);
                        ano = ed.y; mes = ed.m; dia = ed.d;
                    } else {
                        dataStr = String(dataStr).trim();
                        if(dataStr.includes('/')) {
                            const parts = dataStr.split('/');
                            if(parts[0].length === 4) { ano=parseInt(parts[0]); mes=parseInt(parts[1]); dia=parseInt(parts[2]); }
                            else { dia=parseInt(parts[0]); mes=parseInt(parts[1]); ano=parseInt(parts[2]); }
                        } else if(dataStr.includes('-')) {
                            const parts = dataStr.split('-');
                            if(parts[0].length === 4) { ano=parseInt(parts[0]); mes=parseInt(parts[1]); dia=parseInt(parts[2]); }
                            else { dia=parseInt(parts[0]); mes=parseInt(parts[1]); ano=parseInt(parts[2]); }
                        }
                    }

                    let horaStr = row[idxHora];
                    if(typeof horaStr === 'number') {
                        const tm = Math.round(horaStr * 1440);
                        horas = Math.floor(tm / 60); minutos = tm % 60;
                    } else if (typeof horaStr === 'string') {
                        const parts = horaStr.split(':');
                        horas = parseInt(parts[0]); minutos = parseInt(parts[1]);
                    }

                    if(!ano || !mes || !dia) continue;

                    const dataObj = new Date(ano, mes - 1, dia, horas, minutos, 0);
                    
                    // AJUSTE: 00:00 conta como 23:59 do dia anterior
                    const dataAjustada = new Date(dataObj);
                    if(horas === 0 && minutos === 0) {
                        dataAjustada.setMinutes(dataAjustada.getMinutes() - 1);
                    }
                    
                    const toISO = (dt) => {
                        return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}T${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}:00`;
                    };

                    registos.push({
                        DataHoraOriginal: toISO(dataObj),
                        DataHora: toISO(dataAjustada),
                        // --- Guardar timestamp num√©rico para filtros r√°pidos ---
                        Ts: dataAjustada.getTime(),
                        'Consumo (kWh)': consumoKW / 4.0,
                        Potencia_kW: consumoKW
                    });
                }
                return {registos};
            } catch(error) { return {erro: error.message}; }
        }

        function validarEJuntarFicheiros(ficheirosProcessados) {
            if(!ficheirosProcessados || ficheirosProcessados.length === 0) {
                return {erro: 'Nenhum ficheiro processado'};
            }
            
            const dataLimite = new Date('2025-01-01');
            let dadosAntigosEncontrados = false;
            let todosRegistos = [];
            const intervalos = [];
            
            for(const dados of ficheirosProcessados) {
                const linhasAntes = dados.length;
                
                // Filtrar por data >= 01/01/2025
                const dadosFiltrados = dados.filter(r => new Date(r.DataHora) >= dataLimite);
                
                const linhasDepois = dadosFiltrados.length;
                if(linhasAntes > linhasDepois) {
                    dadosAntigosEncontrados = true;
                }
                
                if(dadosFiltrados.length === 0) continue;
                
                todosRegistos = todosRegistos.concat(dadosFiltrados);
                
                const min = new Date(Math.min(...dadosFiltrados.map(r => new Date(r.DataHora))));
                const max = new Date(Math.max(...dadosFiltrados.map(r => new Date(r.DataHora))));
                intervalos.push({min, max});
            }
            
            if(todosRegistos.length === 0) {
                return {erro: 'Nenhum dos ficheiros continha dados v√°lidos a partir de 01/01/2025'};
            }
            
            // Verificar sobreposi√ß√µes
            if(intervalos.length > 1) {
                const ordenados = intervalos.sort((a, b) => a.min - b.min);
                for(let i = 1; i < ordenados.length; i++) {
                    if(ordenados[i].min < ordenados[i-1].max) {
                        return {erro: 'Sobreposi√ß√£o de datas detetada entre ficheiros'};
                    }
                }
            }
            
            // Ordenar por data
            todosRegistos.sort((a, b) => new Date(a.DataHora) - new Date(b.DataHora));
            
            // Remover duplicados
            const registosUnicos = [];
            const timestamps = new Set();
            for(const r of todosRegistos) {
                if(!timestamps.has(r.DataHora)) {
                    timestamps.add(r.DataHora);
                    registosUnicos.push(r);
                }
            }
            
            return {
                dados: registosUnicos,
                aviso: dadosAntigosEncontrados ? 'Foram encontrados e ignorados dados anteriores a 01/01/2025' : null
            };
        }
        
        function agregarConsumosPorPeriodo(dadosConsumo) {
            const ag = { Simples: 0, BD: {V:0, F:0}, BS: {V:0, F:0}, TD: {V:0, C:0, P:0}, TS: {V:0, C:0, P:0} };
            
            if (!DATA.omieMap) return ag;

            // Loop de alta performance usando o Mapa
            for(let i = 0; i < dadosConsumo.length; i++) {
                const r = dadosConsumo[i];
                ag.Simples += r['Consumo (kWh)'];
                
                // Construir chave de pesquisa (YYYY-MM-DD_HH:MM) a partir da string DataHora original
                // Formato esperado em r.DataHora: "YYYY-MM-DDTHH:mm:ss"
                const parts = r.DataHora.split('T'); // ["2025-01-01", "00:15:00"]
                const timeParts = parts[1].split(':'); // ["00", "15", "00"]
                const key = `${parts[0]}_${timeParts[0]}:${timeParts[1]}`; // "2025-01-01_00:15"
                
                let omie = DATA.omieMap.get(key);
                
                // Fallback: se n√£o encontrar 00:15, tenta 00:00 (hora cheia)
                if (!omie && timeParts[1] !== "00") {
                    omie = DATA.omieMap.get(`${parts[0]}_${timeParts[0]}:00`);
                }

                if (omie) {
                    const c = r['Consumo (kWh)'];
                    if (omie.BD) ag.BD[omie.BD] += c;
                    if (omie.BS) ag.BS[omie.BS] += c;
                    if (omie.TD) ag.TD[omie.TD] += c;
                    if (omie.TS) ag.TS[omie.TS] += c;
                }
            }
            return ag;
        }

        function calcularMediasOMIE(dadosConsumoIgnored) { 
            // NOTA: Ignoramos 'dadosConsumo' para o c√°lculo da m√©dia de PRE√áO.
            // Usamos o intervalo de datas selecionado para calcular a m√©dia do MERCADO (OMIE),
            // tal como √© feito no c√°lculo dos tarif√°rios.
            
            const d1Str = document.getElementById('d_inicio').value;
            const d2Str = document.getElementById('d_fim').value;
            
            if (!d1Str || !d2Str || !DATA.omie) return {};

            const acc = {
                S: {sum:0, n:0},
                BD: {V:{sum:0, n:0}, F:{sum:0, n:0}},
                BS: {V:{sum:0, n:0}, F:{sum:0, n:0}},
                TD: {V:{sum:0, n:0}, P:{sum:0, n:0}, C:{sum:0, n:0}},
                TS: {V:{sum:0, n:0}, P:{sum:0, n:0}, C:{sum:0, n:0}}
            };

            // Percorrer a Base de Dados OMIE (filtro de datas string √© r√°pido e seguro)
            DATA.omie.forEach(row => {
                const rDate = parseDateFromDB(row.Data);
                if (!rDate || rDate < d1Str || rDate > d2Str) return;

                const val = parseFloat(String(row.OMIE).replace(',','.')) || 0;

                // M√©dia Simples
                acc.S.sum += val; acc.S.n++;

                // M√©dias por Ciclo
                ['BD', 'BS', 'TD', 'TS'].forEach(ciclo => {
                    const p = row[ciclo]; // V, F, P, C
                    if (p && acc[ciclo][p]) {
                        acc[ciclo][p].sum += val;
                        acc[ciclo][p].n++;
                    }
                });
            });

            const result = {};
            if (acc.S.n) result.S = acc.S.sum / acc.S.n;

            ['BD', 'BS', 'TD', 'TS'].forEach(ciclo => {
                for (const [p, obj] of Object.entries(acc[ciclo])) {
                    result[`${ciclo}_${p}`] = obj.n ? obj.sum / obj.n : 0;
                }
            });

            return result;
        }
        function aplicarDadosERedes() {
            if(!DADOS_EREDES) return;
            
            const d1Input = document.getElementById('d_inicio');
            const d2Input = document.getElementById('d_fim');
            const diasInput = document.getElementById('num_dias');
            
            const absInicio = DADOS_EREDES.periodo.inicio; 
            const absFim = DADOS_EREDES.periodo.fim;       
            
            d1Input.min = absInicio;
            d1Input.max = absFim;
            d2Input.min = absInicio;
            d2Input.max = absFim;
            
            // Definir datas nos inputs
            if(d1Input.value < absInicio || d1Input.value > absFim) d1Input.value = absInicio;
            if(d2Input.value < absInicio || d2Input.value > absFim) d2Input.value = absFim;
            
            // --- Calcular e atualizar o campo num_dias IMEDIATAMENTE ---
            const d1 = new Date(d1Input.value);
            const d2 = new Date(d2Input.value);
            if(d1 && d2) {
                const diff = Math.floor((d2 - d1) / (86400000)) + 1;
                diasInput.value = diff > 0 ? diff : 0;
            }
            
            const omiePanel = document.getElementById('omie-panel');
            if(omiePanel) omiePanel.classList.add('hidden');
        }

        // ===== EXPORTAR PARA EXCEL (ExcelJS com formata√ß√£o completa) =====
        async function exportarExcel() {
            try {
                const EJ = window.ExcelJS;
                if(!EJ) { alert('Biblioteca ExcelJS n√£o carregada. Verifique a liga√ß√£o √† internet.'); return; }

                const modoComp = document.getElementById('modo_comparacao')?.checked;
                const pot = document.getElementById('potencia')?.value || '';
                const ciclo = document.getElementById('ciclo')?.value || '';
                const dias = document.getElementById('num_dias')?.value || '';
                const d1Raw = document.getElementById('d_inicio')?.value || '';
                const d2Raw = document.getElementById('d_fim')?.value || '';

                const fmtDatePT = (iso) => { const p=iso.split('-'); return p.length===3 ? `${p[2]}/${p[1]}/${p[0]}` : iso; };
                const d1 = fmtDatePT(d1Raw);
                const d2 = fmtDatePT(d2Raw);

                const kwh = { S: parseFloat(document.getElementById('kwh_S')?.value)||0, V: parseFloat(document.getElementById('kwh_V')?.value)||0, F: parseFloat(document.getElementById('kwh_F')?.value)||0, P: parseFloat(document.getElementById('kwh_P')?.value)||0, C: parseFloat(document.getElementById('kwh_C')?.value)||0 };
                const totalKwh = kwh.S + kwh.V + kwh.F + kwh.P + kwh.C;
                const famNum = document.getElementById('familia_numerosa')?.checked;
                const tarSoc = document.getElementById('tarifa_social')?.checked;
                const seg = document.getElementById('f_segmento')?.value || 'Todos';
                const fat = document.getElementById('f_fatura')?.value || 'Todas';
                const pag = document.getElementById('f_pagamento')?.value || 'Todos';
                const segTexto = seg === 'Todos' ? 'Residencial' : seg;

                let omieText = '';
                if(ciclo.includes('Simples')) omieText = `Simples: ${OMIE_VALUES.S.toFixed(2)} ‚Ç¨/MWh`;
                else if(ciclo.includes('Bi')) omieText = `Vazio: ${OMIE_VALUES.V.toFixed(2)}, Fora Vazio: ${OMIE_VALUES.F.toFixed(2)} ‚Ç¨/MWh`;
                else omieText = `Vazio: ${OMIE_VALUES.V.toFixed(2)}, Cheias: ${OMIE_VALUES.C.toFixed(2)}, Ponta: ${OMIE_VALUES.P.toFixed(2)} ‚Ç¨/MWh`;

                let consumoText = '';
                if(ciclo.includes('Simples')) consumoText = `Simples: ${kwh.S.toFixed(0)} kWh`;
                else if(ciclo.includes('Bi')) consumoText = `Vazio: ${kwh.V.toFixed(0)}, Fora Vazio: ${kwh.F.toFixed(0)} kWh`;
                else consumoText = `Vazio: ${kwh.V.toFixed(0)}, Cheias: ${kwh.C.toFixed(0)}, Ponta: ${kwh.P.toFixed(0)} kWh`;

                const perfilText = (typeof obter_perfil === 'function') ? obter_perfil(totalKwh, parseInt(dias), parseFloat(pot)).replace(/^(perfil_|BTN_)/i, 'PERFIL ').toUpperCase() : 'N/A';

                // Cores
                const TIPO_CORES = {
                    'Fixo':            { bg: 'F0F0F0', fg: '000000' },
                    'Indexado M√©dia':   { bg: 'FFE699', fg: '000000' },
                    'Indexado quarto-hor√°rio - Perfil': { bg: '90ABDC', fg: '000000' },
                    'Indexado quarto-hor√°rio - Diagrama': { bg: 'D6E4F0', fg: '000000' },
                    'Utilizador':      { bg: 'FF0000', fg: 'FFFFFF' },
                    'Personalizado':   { bg: '92D050', fg: '000000' }
                };
                // Cores dos cabe√ßalhos = CSS HTML
                const CICLO_CORES = {
                    'Simples': { bg: 'A6A6A6', fg: '000000' },
                    'Bi-hor√°rio - Ciclo Di√°rio': { bg: 'A9D08E', fg: '000000' },
                    'Bi Di√°rio': { bg: 'A9D08E', fg: '000000' },
                    'Bi-hor√°rio': { bg: 'A9D08E', fg: '000000' },
                    'Bi-hor√°rio - Ciclo Semanal': { bg: '8EA9DB', fg: '000000' },
                    'Bi Semanal': { bg: '8EA9DB', fg: '000000' },
                    'Tri-hor√°rio - Ciclo Di√°rio': { bg: 'BF8F00', fg: 'FFFFFF' },
                    'Tri Di√°rio': { bg: 'BF8F00', fg: 'FFFFFF' },
                    'Tri-hor√°rio': { bg: 'BF8F00', fg: 'FFFFFF' },
                    'Tri-hor√°rio - Ciclo Semanal': { bg: 'C65911', fg: 'FFFFFF' },
                    'Tri Semanal': { bg: 'C65911', fg: 'FFFFFF' },
                    'Tri Di√°rio >20.7': { bg: 'BF8F00', fg: 'FFFFFF' },
                    'Tri-hor√°rio >20.7': { bg: 'BF8F00', fg: 'FFFFFF' },
                    'Tri Semanal >20.7': { bg: 'C65911', fg: 'FFFFFF' },
                    'default': { bg: 'A6A6A6', fg: '000000' }
                };

                const getTipoCor = (tipo, nome) => {
                    if(nome && nome.includes('O Meu Tarif√°rio')) return TIPO_CORES['Utilizador'];
                    if(nome && nome.includes('Tarif√°rio Personalizado')) return TIPO_CORES['Personalizado'];
                    if(tipo && tipo.includes('Diagrama')) return TIPO_CORES['Indexado quarto-hor√°rio - Diagrama'];
                    if(tipo && tipo.includes('quarto-hor√°rio')) return TIPO_CORES['Indexado quarto-hor√°rio - Perfil'];
                    if(tipo && tipo.includes('M√©dia')) return TIPO_CORES['Indexado M√©dia'];
                    return TIPO_CORES['Fixo'];
                };

                const getCicloCor = (display) => {
                    if(CICLO_CORES[display]) return CICLO_CORES[display];
                    for(const k of Object.keys(CICLO_CORES)) {
                        if(display.includes(k) || k.includes(display)) return CICLO_CORES[k];
                    }
                    return CICLO_CORES['default'];
                };

                const gradColor = (val, min, max) => {
                    if(isNaN(val)||min===null||max===null||min===max) return {bg:'FFFFFF',fg:'000000'};
                    const mid=(min+max)/2;
                    const verde=[90,138,198], branco=[255,255,255], vermelho=[247,150,70];
                    let r,g,b;
                    if(val<=mid){const t=(val-min)/(mid-min);r=Math.round(verde[0]*(1-t)+branco[0]*t);g=Math.round(verde[1]*(1-t)+branco[1]*t);b=Math.round(verde[2]*(1-t)+branco[2]*t);}
                    else{const t=(val-mid)/(max-mid);r=Math.round(branco[0]*(1-t)+vermelho[0]*t);g=Math.round(branco[1]*(1-t)+vermelho[1]*t);b=Math.round(branco[2]*(1-t)+vermelho[2]*t);}
                    const lum=0.299*r+0.587*g+0.114*b;
                    return {bg:[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('').toUpperCase(),fg:lum>140?'000000':'FFFFFF'};
                };

                // --- ExcelJS Workbook ---
                const wb = new EJ.Workbook();
                const ws = wb.addWorksheet('Simula√ß√£o');

                // Fundo branco default
                const wFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF' } };
                // Borders s√≥ no cabe√ßalho
                const hdrBorder = { top: {style:'thin',color:{argb:'000000'}}, left: {style:'thin',color:{argb:'000000'}}, bottom: {style:'thin',color:{argb:'000000'}}, right: {style:'thin',color:{argb:'000000'}} };

                let row = 1;
                const expData = LAST_EXPORT_DATA;
                let numCols;
                if(modoComp && expData && expData.mode === 'comparacao') {
                    numCols = 1 + (expData.data.opcoes || []).length;
                } else {
                    if(ciclo.includes('Simples')) numCols = 4;
                    else if(ciclo.includes('Bi')) numCols = 5;
                    else numCols = 6;
                }
                const lastCol = Math.max(numCols, 4);

                const wRow = (r, n) => { for(let c=1;c<=n;c++) ws.getCell(r,c).fill = wFill; };

                // --- RESUMO (sem borders, negrito) ---
                ws.mergeCells(row, 1, row, lastCol);
                ws.getCell(row, 1).value = 'Resumo da Simula√ß√£o:';
                ws.getCell(row, 1).font = { bold: true, size: 12 };
                ws.getCell(row, 1).fill = wFill;
                row++;

                const addRL = (label, val) => {
                    const mc = Math.max(2, Math.floor(lastCol/2));
                    ws.mergeCells(row, 1, row, mc);
                    ws.getCell(row, 1).value = label;
                    ws.getCell(row, 1).font = { bold: true, size: 11 };
                    ws.getCell(row, 1).fill = wFill;
                    ws.mergeCells(row, mc+1, row, lastCol);
                    ws.getCell(row, mc+1).value = val;
                    ws.getCell(row, mc+1).font = { bold: true, size: 11 };
                    ws.getCell(row, mc+1).fill = wFill;
                    row++;
                };

                addRL(`Segmento: ${segTexto}   |  Fatura√ß√£o: ${fat}   |  Pagamento: ${pag}`, `${pot} kVA em ${ciclo.replace('- Ciclo ','').replace('Bi-hor√°rio','Bi-Hor√°rio').replace('Tri-hor√°rio','Tri-Hor√°rio')}`);
                addRL(`Consumos (${totalKwh.toFixed(0)} kWh Total):`, consumoText);
                addRL('Per√≠odo:', `De ${d1} a ${d2} (${dias} dias)`);
                addRL(`OMIE  ${!OMIE_MANUAL ? '(M√©dia com Futuros)' : '(Manual)'}:`, omieText);
                addRL('Perfil de Consumo:', perfilText);
                if(famNum || tarSoc) {
                    let benef = [];
                    if(famNum) benef.push('Fam√≠lia Numerosa');
                    if(tarSoc) benef.push('Tarifa Social');
                    addRL('Benef√≠cios:', benef.join(', '));
                }

                wRow(row, lastCol); row++;

                // Poupan√ßa unida at√© col D
                const msgPoup = document.getElementById('mensagem-poupanca');
                if(msgPoup && msgPoup.style.display !== 'none' && msgPoup.innerText.trim()) {
                    ws.mergeCells(row, 1, row, Math.max(lastCol, 4));
                    const cp = ws.getCell(row, 1);
                    cp.value = msgPoup.innerText.trim();
                    cp.font = { bold: true, color: { argb: 'FF0000' }, size: 11 };
                    cp.alignment = { wrapText: true };
                    cp.fill = wFill;
                    row++;
                }

                const sumDiv = document.getElementById('comparacao-summary');
                if(modoComp && sumDiv && sumDiv.innerText.trim()) {
                    ws.mergeCells(row, 1, row, Math.max(lastCol, 4));
                    const cs = ws.getCell(row, 1);
                    cs.value = sumDiv.innerText.trim().replace(/\n+/g, ' | ');
                    cs.font = { bold: true, color: { argb: '0369A1' }, size: 11 };
                    cs.alignment = { wrapText: true };
                    cs.fill = wFill;
                    row++;
                }

                wRow(row, lastCol); row++;

                // "Simula√ß√£o em..." unida, centrada, negrito
                const dh = new Date();
                const dataStr = `${dh.getDate().toString().padStart(2,'0')}/${(dh.getMonth()+1).toString().padStart(2,'0')}/${dh.getFullYear()}`;
                const simulLine = `          Simula√ß√£o em ${dataStr}                                                                      https://www.tiagofelicia.pt                                                                      Tiago Fel√≠cia`;
                ws.mergeCells(row, 1, row, Math.max(lastCol, 4));
                const cSim = ws.getCell(row, 1);
                cSim.value = simulLine;
                cSim.font = { bold: true, size: 11 };
                cSim.alignment = { horizontal: 'center', vertical: 'middle' };
                cSim.fill = wFill;
                row++;
                wRow(row, lastCol); row++;

                // --- TABELA DETALHE ---
                if(!modoComp && expData && expData.mode === 'detalhe') {
                    const list = expData.results || [];
                    let headers = ['Tarif√°rio', 'Total (‚Ç¨)'];
                    if(ciclo.includes('Simples')) { headers.push('Simples (‚Ç¨/kWh)', 'Pot√™ncia (‚Ç¨/dia)'); }
                    else if(ciclo.includes('Bi')) { headers.push('Vazio (‚Ç¨/kWh)', 'Fora Vazio (‚Ç¨/kWh)', 'Pot√™ncia (‚Ç¨/dia)'); }
                    else { headers.push('Vazio (‚Ç¨/kWh)', 'Cheias (‚Ç¨/kWh)', 'Ponta (‚Ç¨/kWh)', 'Pot√™ncia (‚Ç¨/dia)'); }
                    const hLen = headers.length;

                    // Cabe√ßalho (cores, borders s√≥ aqui)
                    const cicloCor = getCicloCor(ciclo);
                    headers.forEach((h, ci) => {
                        const c = ws.getCell(row, ci+1);
                        c.value = h;
                        c.font = { bold: true, color: { argb: cicloCor.fg }, size: 11 };
                        c.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: cicloCor.bg } };
                        c.alignment = { horizontal: 'center', vertical: 'middle' };
                        c.border = hdrBorder;
                    });
                    row++;

                    const calcMM = (arr, key) => { const v=arr.map(i=>i[key]).filter(x=>!isNaN(x)&&x!=null); return v.length?{min:Math.min(...v),max:Math.max(...v)}:{min:null,max:null}; };
                    const mmT = calcMM(list,'total'), mmS = calcMM(list,'uS'), mmV = calcMM(list,'uV');
                    const mmF = calcMM(list,'uF'), mmP = calcMM(list,'uP'), mmC = calcMM(list,'uC'), mmPt = calcMM(list,'uPot');
                    const tipos = new Set();

                    list.forEach(i => {
                        const tc = getTipoCor(i.tipo, i.nome);
                        tipos.add(getTarifarioStyle(i.tipo, i.nome).label);

                        const cN = ws.getCell(row, 1);
                        cN.value = i.nome;
                        cN.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: tc.bg } };
                        cN.font = { color: { argb: tc.fg }, size: 11, bold: i.nome.includes('O Meu Tarif√°rio') || i.nome.includes('Tarif√°rio Personalizado') };
                        cN.alignment = { horizontal: 'center' };

                        // N√∫meros como n√∫meros
                        const cTot = ws.getCell(row, 2);
                        const gcTot = gradColor(i.total, mmT.min, mmT.max);
                        cTot.value = i.total;
                        cTot.numFmt = '#,##0.00';
                        cTot.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: gcTot.bg } };
                        cTot.font = { color: { argb: gcTot.fg }, size: 11 };
                        cTot.alignment = { horizontal: 'center' };

                        let ci = 3;
                        const addV = (val, mm) => {
                            const c = ws.getCell(row, ci);
                            const gc = gradColor(val, mm.min, mm.max);
                            c.value = val;
                            c.numFmt = '#,##0.0000';
                            c.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: gc.bg } };
                            c.font = { color: { argb: gc.fg }, size: 11 };
                            c.alignment = { horizontal: 'center' };
                            ci++;
                        };

                        if(ciclo.includes('Simples')) { addV(i.uS, mmS); addV(i.uPot, mmPt); }
                        else if(ciclo.includes('Bi')) { addV(i.uV, mmV); addV(i.uF, mmF); addV(i.uPot, mmPt); }
                        else { addV(i.uV, mmV); addV(i.uC, mmC); addV(i.uP, mmP); addV(i.uPot, mmPt); }
                        row++;
                    });

                    // LEGENDA (sem borders)
                    wRow(row, hLen); row++; wRow(row, hLen); row++;
                    ws.mergeCells(row, 1, row, Math.min(hLen, 3));
                    ws.getCell(row, 1).value = 'Tipos de Tarif√°rio:';
                    ws.getCell(row, 1).font = { bold: true, size: 11, underline: true };
                    ws.getCell(row, 1).alignment = { horizontal: 'center' };
                    ws.getCell(row, 1).fill = wFill;
                    row++;

                    const legD = {
                        'O Meu Tarif√°rio': 'Tarif√°rio configurado pelo utilizador.',
                        'Personalizado': 'Tarif√°rio personalizado pelo utilizador.',
                        'Indexado M√©dia': 'Pre√ßo de energia baseado na m√©dia OMIE do per√≠odo.',
                        'Indexado quarto-hor√°rio - Perfil': 'Pre√ßo de energia baseado nos valores OMIE hor√°rios/quarto-hor√°rios e perfil.',
                        'Indexado quarto-hor√°rio - Diagrama': 'Pre√ßo baseado nos dados reais do diagrama de cargas E-REDES.',
                        'Fixo': 'Pre√ßos de energia constantes.'
                    };
                    const legO = ['O Meu Tarif√°rio','Personalizado','Indexado M√©dia','Indexado quarto-hor√°rio - Perfil','Indexado quarto-hor√°rio - Diagrama','Fixo'];
                    legO.forEach(tipo => {
                        if(!tipos.has(tipo)) return;
                        let tc;
                        if(tipo === 'O Meu Tarif√°rio') tc = TIPO_CORES['Utilizador'];
                        else if(tipo === 'Personalizado') tc = TIPO_CORES['Personalizado'];
                        else tc = TIPO_CORES[tipo] || TIPO_CORES['Fixo'];
                        const cT = ws.getCell(row, 1);
                        cT.value = tipo;
                        cT.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: tc.bg } };
                        cT.font = { color: { argb: tc.fg }, size: 11, bold: true };
                        cT.alignment = { horizontal: 'center' };
                        ws.mergeCells(row, 2, row, Math.min(hLen, 4));
                        ws.getCell(row, 2).value = legD[tipo] || '';
                        ws.getCell(row, 2).font = { size: 11 };
                        ws.getCell(row, 2).fill = wFill;
                        row++;
                    });

                    // Larguras
                    ws.getColumn(1).width = 95;
                    for(let c=2;c<=hLen;c++) ws.getColumn(c).width = 25;

                } else if(modoComp && expData && expData.mode === 'comparacao') {
                    // --- TABELA COMPARA√á√ÉO ---
                    const opcoes = expData.data.opcoes || [];
                    const list = expData.data.resultados || [];
                    const hLen = 1 + opcoes.length;

                    const cTar = ws.getCell(row, 1);
                    cTar.value = 'Tarif√°rio';
                    const tarC = getCicloCor('Simples');
                    cTar.font = { bold: true, color: { argb: tarC.fg }, size: 11 };
                    cTar.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: tarC.bg } };
                    cTar.alignment = { horizontal: 'center' };
                    cTar.border = hdrBorder;

                    opcoes.forEach((opc, oi) => {
                        const cc = getCicloCor(opc.display);
                        const c = ws.getCell(row, oi+2);
                        c.value = `${opc.display} (‚Ç¨)`;
                        c.font = { bold: true, color: { argb: cc.fg }, size: 11 };
                        c.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: cc.bg } };
                        c.alignment = { horizontal: 'center' };
                        c.border = hdrBorder;
                    });
                    row++;

                    const mmO = {};
                    opcoes.forEach(opc => {
                        const v = list.map(i=>i.custos[opc.display]).filter(x=>!isNaN(x)&&x!=null);
                        mmO[opc.display] = v.length ? {min:Math.min(...v),max:Math.max(...v)} : {min:null,max:null};
                    });
                    const tipos = new Set();

                    list.forEach(i => {
                        const tc = getTipoCor(i.tipo, i.nome);
                        tipos.add(getTarifarioStyle(i.tipo, i.nome).label);

                        const cN = ws.getCell(row, 1);
                        cN.value = i.nome;
                        cN.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: tc.bg } };
                        cN.font = { color: { argb: tc.fg }, size: 11, bold: i.nome.includes('O Meu Tarif√°rio') || i.nome.includes('Tarif√°rio Personalizado') };
                        cN.alignment = { horizontal: 'center' };

                        opcoes.forEach((opc, oi) => {
                            const c = ws.getCell(row, oi+2);
                            const custo = i.custos[opc.display];
                            if(custo !== undefined && custo !== null && !isNaN(custo)) {
                                const gc = gradColor(custo, mmO[opc.display].min, mmO[opc.display].max);
                                c.value = custo;
                                c.numFmt = '#,##0.00';
                                c.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: gc.bg } };
                                c.font = { color: { argb: gc.fg }, size: 11 };
                            } else {
                                c.value = '‚Äî';
                                c.font = { color: { argb: 'AAAAAA' }, size: 11 };
                                c.fill = wFill;
                            }
                            c.alignment = { horizontal: 'center' };
                        });
                        row++;
                    });

                    wRow(row, hLen); row++; wRow(row, hLen); row++;
                    ws.mergeCells(row, 1, row, Math.min(hLen, 3));
                    ws.getCell(row, 1).value = 'Tipos de Tarif√°rio:';
                    ws.getCell(row, 1).font = { bold: true, size: 11, underline: true };
                    ws.getCell(row, 1).alignment = { horizontal: 'center' };
                    ws.getCell(row, 1).fill = wFill;
                    row++;

                    const legD = {
                        'O Meu Tarif√°rio': 'Tarif√°rio configurado pelo utilizador.',
                        'Personalizado': 'Tarif√°rio personalizado pelo utilizador.',
                        'Indexado M√©dia': 'Pre√ßo de energia baseado na m√©dia OMIE do per√≠odo.',
                        'Indexado quarto-hor√°rio - Perfil': 'Pre√ßo de energia baseado nos valores OMIE hor√°rios/quarto-hor√°rios e perfil.',
                        'Indexado quarto-hor√°rio - Diagrama': 'Pre√ßo baseado nos dados reais do diagrama de cargas E-REDES.',
                        'Fixo': 'Pre√ßos de energia constantes.'
                    };
                    const legO = ['O Meu Tarif√°rio','Personalizado','Indexado M√©dia','Indexado quarto-hor√°rio - Perfil','Indexado quarto-hor√°rio - Diagrama','Fixo'];
                    legO.forEach(tipo => {
                        if(!tipos.has(tipo)) return;
                        let tc;
                        if(tipo === 'O Meu Tarif√°rio') tc = TIPO_CORES['Utilizador'];
                        else if(tipo === 'Personalizado') tc = TIPO_CORES['Personalizado'];
                        else tc = TIPO_CORES[tipo] || TIPO_CORES['Fixo'];
                        const cT = ws.getCell(row, 1);
                        cT.value = tipo;
                        cT.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: tc.bg } };
                        cT.font = { color: { argb: tc.fg }, size: 11, bold: true };
                        cT.alignment = { horizontal: 'center' };
                        ws.mergeCells(row, 2, row, Math.min(hLen, 4));
                        ws.getCell(row, 2).value = legD[tipo] || '';
                        ws.getCell(row, 2).font = { size: 11 };
                        ws.getCell(row, 2).fill = wFill;
                        row++;
                    });

                    ws.getColumn(1).width = 95;
                    for(let c=2;c<=hLen;c++) ws.getColumn(c).width = 25;

                } else {
                    // Fallback: DOM scrape
                    const thead = document.getElementById('thead');
                    const tbody = document.getElementById('tbody');
                    if(thead) { const hr=[]; thead.querySelectorAll('th').forEach(th=>{const t=th.innerText.replace(/‚ñº|‚ñ≤/g,'').trim(); if(!t.toLowerCase().includes('detalhe'))hr.push(t);}); hr.forEach((h,ci)=>{const c=ws.getCell(row,ci+1);c.value=h;c.font={bold:true,size:11};c.fill=wFill;}); row++; }
                    if(tbody) { tbody.querySelectorAll('tr').forEach(tr=>{ let ci=0; tr.querySelectorAll('td').forEach((td,tdi)=>{if(tdi===tr.querySelectorAll('td').length-1)return; const c=ws.getCell(row,ci+1); c.value=td.innerText.trim(); c.font={size:11}; c.fill=wFill; ci++;}); row++; }); }
                }

                // --- GERAR FICHEIRO ---
                const now = new Date();
                const ts = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}${now.getSeconds().toString().padStart(2,'0')}`;
                const filename = modoComp ? `Tiago_Felicia_Eletricidade_Comparacao_${ts}.xlsx` : `Tiago_Felicia_Eletricidade_detalhe_${ts}.xlsx`;

                const buffer = await wb.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename; a.click();
                URL.revokeObjectURL(url);

            } catch(err) {
                console.error('Erro ao exportar:', err);
                alert('Erro ao exportar para Excel: ' + err.message);
            }
        }

        // ===== PARTILHAR SIMULA√á√ÉO (APENAS ABA 2) =====
        // Mapeamento de ciclos curtos para reduzir URL
        const CICLO_CODES = {
            'Simples': 'S',
            'Bi-hor√°rio - Ciclo Di√°rio': 'BD',
            'Bi-hor√°rio - Ciclo Semanal': 'BS',
            'Tri-hor√°rio - Ciclo Di√°rio': 'TD',
            'Tri-hor√°rio - Ciclo Semanal': 'TS',
            'Tri-hor√°rio > 20.7 kVA - Ciclo Di√°rio': 'XD',
            'Tri-hor√°rio > 20.7 kVA - Ciclo Semanal': 'XS'
        };
        const CICLO_DECODE = Object.fromEntries(Object.entries(CICLO_CODES).map(([k,v])=>[v,k]));

        function gerarLinkPartilha() {
            try {
                const p = new URLSearchParams();
                p.set('p', document.getElementById('potencia')?.value || '');
                const cicloVal = document.getElementById('ciclo')?.value || '';
                p.set('c', CICLO_CODES[cicloVal] || cicloVal);
                // Datas compactas (sem h√≠fens): 20260113 -> 8 chars vs 10
                const d1 = (document.getElementById('d_inicio')?.value||'').replace(/-/g,'');
                const d2 = (document.getElementById('d_fim')?.value||'').replace(/-/g,'');
                if(d1) p.set('a', d1);
                if(d2) p.set('b', d2);
                // Consumos (s√≥ os n√£o-zero)
                const ids = [['kwh_S','s'],['kwh_V','v'],['kwh_F','f'],['kwh_P','t'],['kwh_C','k']];
                ids.forEach(([id,key])=>{ const el=document.getElementById(id); if(el && parseFloat(el.value)) p.set(key, el.value); });
                // Flags compactas: 1 char cada
                let flags = '';
                if(document.getElementById('familia_numerosa')?.checked) flags += 'F';
                if(document.getElementById('tarifa_social')?.checked) flags += 'T';
                if(document.getElementById('ocultar_edp_h')?.checked) flags += 'E';
                if(document.getElementById('quota_acp')?.checked) flags += 'A';
                if(document.getElementById('modo_comparacao')?.checked) flags += 'C';
                if(flags) p.set('fl', flags);
                // Filtros (s√≥ se n√£o default)
                const seg = document.getElementById('f_segmento')?.value; if(seg && seg !== 'Todos') p.set('sg', seg.charAt(0));
                const fat = document.getElementById('f_fatura')?.value; if(fat && fat !== 'Todas') p.set('ft', fat.charAt(0));
                const pag = document.getElementById('f_pagamento')?.value; if(pag && pag !== 'Todos') p.set('pg', pag.charAt(0));
                const cav = document.getElementById('cav_valor')?.value; if(cav && cav !== '2.85') p.set('cv', cav);
                const dgeg = document.getElementById('dgeg_valor')?.value; if(dgeg && dgeg !== '0.07') p.set('dg', dgeg);
                // Tipos (bitmap compacto)
                const tipos = Array.from(document.querySelectorAll('.chk-tipo')).map(c=>c.checked?'1':'0').join('');
                if(tipos && !tipos.match(/^1+$/)) p.set('tp', parseInt(tipos,2).toString(36));
                // OMIE manual
                if(OMIE_MANUAL) {
                    const vals = []; document.querySelectorAll('#omie-inputs input[type="number"]').forEach(inp=>vals.push(inp.value));
                    p.set('om', vals.join(','));
                }
                // Meu Tarif√°rio (compacto)
                if(document.getElementById('meu_ativo')?.checked) {
                    const mv = ['meu_energia_s','meu_energia_v','meu_energia_f','meu_energia_p','meu_energia_c','meu_potencia','meu_desc_fat','meu_acres_fat'].map(id=>document.getElementById(id)?.value||'0').join(',');
                    p.set('m', mv);
                    let mf = '';
                    if(document.getElementById('meu_tar_energia')?.checked) mf += 'e';
                    if(document.getElementById('meu_tar_potencia')?.checked) mf += 'p';
                    if(document.getElementById('meu_tse_incluido')?.checked) mf += 't';
                    if(mf) p.set('mf', mf);
                }
                // Personalizado (compacto)
                if(document.getElementById('pers_ativo')?.checked) {
                    const pv = ['pers_energia_s','pers_potencia_s','pers_energia_v_bi','pers_energia_f_bi','pers_potencia_bi','pers_energia_v_tri','pers_energia_c_tri','pers_energia_p_tri','pers_potencia_tri'].map(id=>document.getElementById(id)?.value||'0').join(',');
                    p.set('x', pv);
                    let xf = '';
                    if(document.getElementById('pers_tar_energia')?.checked) xf += 'e';
                    if(document.getElementById('pers_tar_potencia')?.checked) xf += 'p';
                    if(document.getElementById('pers_tse_incluido')?.checked) xf += 't';
                    if(xf) p.set('xf', xf);
                }
                // URL
                const baseUrl = window.location.origin + window.location.pathname;
                const url = baseUrl + '?z=2&' + p.toString();
                navigator.clipboard.writeText(url).then(() => {
                    const btn = document.getElementById('btn-partilhar');
                    const orig = btn.innerHTML;
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Link Copiado!';
                    btn.style.background = '#16a34a'; btn.style.color = 'white'; btn.style.borderColor = '#16a34a';
                    setTimeout(() => { btn.innerHTML = orig; btn.style.background = 'white'; btn.style.color = 'var(--primary)'; btn.style.borderColor = 'var(--primary)'; }, 2500);
                }).catch(() => { prompt('Copie o link abaixo:', url); });
            } catch(err) { console.error('Erro ao gerar link:', err); alert('Erro ao gerar link de partilha.'); }
        }

        // Aplicar par√¢metros de partilha ao carregar
        function aplicarParametrosPartilha() {
            const params = new URLSearchParams(window.location.search);
            // Suportar formato curto (z=2) e formato antigo (tab=complete)
            if(params.has('z') || (params.has('pot') && params.get('tab') === 'complete')) {
                window._SHARED_PARAMS = params;
                return true;
            }
            return false;
        }

        function aplicarSharedParamsDepoisDeCarregar() {
            const params = window._SHARED_PARAMS;
            if(!params) return;
            delete window._SHARED_PARAMS;
            try {
                if(CURRENT_TAB !== 'complete') {
                    document.querySelector('[onclick*="switchTab"][onclick*="complete"]')?.click();
                    setTimeout(() => aplicarSharedParamsAosInputs(params), 300);
                } else { aplicarSharedParamsAosInputs(params); }
            } catch(e) { console.error('Erro ao aplicar params:', e); }
        }

        function aplicarSharedParamsAosInputs(params) {
            try {
                const setVal = (id, val) => { const el=document.getElementById(id); if(el && val!==null && val!==undefined) el.value=val; };
                const setCheck = (id, val) => { const el=document.getElementById(id); if(el) el.checked=!!val; };

                // Formato curto (z=2) ou antigo (tab=complete)
                const isShort = params.has('z');

                if(isShort) {
                    // Pot√™ncia e ciclo
                    setVal('potencia', params.get('p'));
                    atualizarMenusCiclo();
                    const cicloCode = params.get('c') || '';
                    setVal('ciclo', CICLO_DECODE[cicloCode] || cicloCode);
                    construirInputsConsumo();
                    // Datas (formato compacto YYYYMMDD)
                    const a = params.get('a')||'';
                    const b = params.get('b')||'';
                    if(a.length===8) setVal('d_inicio', a.slice(0,4)+'-'+a.slice(4,6)+'-'+a.slice(6,8));
                    if(b.length===8) setVal('d_fim', b.slice(0,4)+'-'+b.slice(4,6)+'-'+b.slice(6,8));
                    atualizarDias();
                    setTimeout(() => {
                        // Consumos
                        if(params.get('s')) setVal('kwh_S', params.get('s'));
                        if(params.get('v')) setVal('kwh_V', params.get('v'));
                        if(params.get('f')) setVal('kwh_F', params.get('f'));
                        if(params.get('t')) setVal('kwh_P', params.get('t'));
                        if(params.get('k')) setVal('kwh_C', params.get('k'));
                        // Flags
                        const fl = params.get('fl') || '';
                        setCheck('familia_numerosa', fl.includes('F'));
                        setCheck('tarifa_social', fl.includes('T'));
                        setCheck('ocultar_edp_h', fl.includes('E'));
                        setCheck('quota_acp', fl.includes('A'));
                        setCheck('modo_comparacao', fl.includes('C'));
                        // Filtros
                        const sgMap = {'R':'Residencial','E':'Empresarial'}; if(params.get('sg')) setVal('f_segmento', sgMap[params.get('sg')]||params.get('sg'));
                        const ftMap = {'E':'Eletr√≥nica','P':'Papel'}; if(params.get('ft')) setVal('f_fatura', ftMap[params.get('ft')]||params.get('ft'));
                        const pgMap = {'D':'D√©bito Direto','M':'Multibanco','O':'Outros'}; if(params.get('pg')) setVal('f_pagamento', pgMap[params.get('pg')]||params.get('pg'));
                        if(params.get('cv')) setVal('cav_valor', params.get('cv'));
                        if(params.get('dg')) setVal('dgeg_valor', params.get('dg'));
                        // Tipos (bitmap)
                        if(params.get('tp')) {
                            const bin = parseInt(params.get('tp'), 36).toString(2);
                            const chks = document.querySelectorAll('.chk-tipo');
                            const padded = bin.padStart(chks.length, '0');
                            chks.forEach((c,i) => { c.checked = padded[i] === '1'; });
                        }
                        // OMIE manual
                        if(params.get('om')) {
                            OMIE_MANUAL = true;
                            construirInputsOMIE(CICLO_DECODE[params.get('c')]||params.get('c'));
                            const vals = params.get('om').split(',');
                            document.querySelectorAll('#omie-inputs input[type="number"]').forEach((inp,i)=>{if(vals[i])inp.value=vals[i];});
                        }
                        // Meu Tarif√°rio
                        if(params.get('m')) {
                            setCheck('meu_ativo', true); toggleMeuTarifario();
                            const mv = params.get('m').split(',');
                            ['meu_energia_s','meu_energia_v','meu_energia_f','meu_energia_p','meu_energia_c','meu_potencia','meu_desc_fat','meu_acres_fat'].forEach((id,i)=>setVal(id, mv[i]||'0'));
                            const mf = params.get('mf')||'';
                            setCheck('meu_tar_energia', mf.includes('e'));
                            setCheck('meu_tar_potencia', mf.includes('p'));
                            setCheck('meu_tse_incluido', mf.includes('t'));
                        }
                        // Personalizado
                        if(params.get('x')) {
                            setCheck('pers_ativo', true); toggleTarifarioPersonalizado();
                            const pv = params.get('x').split(',');
                            ['pers_energia_s','pers_potencia_s','pers_energia_v_bi','pers_energia_f_bi','pers_potencia_bi','pers_energia_v_tri','pers_energia_c_tri','pers_energia_p_tri','pers_potencia_tri'].forEach((id,i)=>setVal(id, pv[i]||'0'));
                            const xf = params.get('xf')||'';
                            setCheck('pers_tar_energia', xf.includes('e'));
                            setCheck('pers_tar_potencia', xf.includes('p'));
                            setCheck('pers_tse_incluido', xf.includes('t'));
                        }
                        calcular();
                        setTimeout(() => { document.getElementById('titulo-tabela')?.scrollIntoView({behavior:'smooth',block:'start'}); }, 500);
                    }, 200);
                } else {
                    // Formato antigo (compatibilidade)
                    setVal('potencia', params.get('pot'));
                    atualizarMenusCiclo();
                    setVal('ciclo', params.get('ciclo'));
                    construirInputsConsumo();
                    setVal('d_inicio', params.get('d1'));
                    setVal('d_fim', params.get('d2'));
                    atualizarDias();
                    setTimeout(() => {
                        ['kwh_S','kwh_V','kwh_F','kwh_P','kwh_C'].forEach(id => { if(params.get(id)) setVal(id, params.get(id)); });
                        setCheck('familia_numerosa', params.get('fam')==='1');
                        setCheck('tarifa_social', params.get('ts')==='1');
                        if(params.get('seg')) setVal('f_segmento', params.get('seg'));
                        if(params.get('fat')) setVal('f_fatura', params.get('fat'));
                        if(params.get('pag')) setVal('f_pagamento', params.get('pag'));
                        if(params.get('cav')) setVal('cav_valor', params.get('cav'));
                        if(params.get('dgeg')) setVal('dgeg_valor', params.get('dgeg'));
                        setCheck('ocultar_edp_h', params.get('edp')==='1');
                        setCheck('quota_acp', params.get('acp')==='1');
                        setCheck('modo_comparacao', params.get('comp')==='1');
                        if(params.get('tipos')) { const t=params.get('tipos'); document.querySelectorAll('.chk-tipo').forEach((c,i)=>{c.checked=t[i]==='1';}); }
                        if(params.get('meu')==='1') {
                            setCheck('meu_ativo', true); toggleMeuTarifario();
                            ['meu_energia_s','meu_energia_v','meu_energia_f','meu_energia_p','meu_energia_c','meu_potencia','meu_desc_fat','meu_acres_fat'].forEach(id=>{if(params.get(id))setVal(id,params.get(id));});
                            setCheck('meu_tar_energia',params.get('meu_te')==='1'); setCheck('meu_tar_potencia',params.get('meu_tp')==='1'); setCheck('meu_tse_incluido',params.get('meu_tse')==='1');
                        }
                        if(params.get('pers')==='1') {
                            setCheck('pers_ativo', true); toggleTarifarioPersonalizado();
                            ['pers_energia_s','pers_potencia_s','pers_energia_v_bi','pers_energia_f_bi','pers_potencia_bi','pers_energia_v_tri','pers_energia_c_tri','pers_energia_p_tri','pers_potencia_tri'].forEach(id=>{if(params.get(id))setVal(id,params.get(id));});
                            setCheck('pers_tar_energia',params.get('pers_te')==='1'); setCheck('pers_tar_potencia',params.get('pers_tp')==='1'); setCheck('pers_tse_incluido',params.get('pers_tse')==='1');
                        }
                        calcular();
                        setTimeout(() => { document.getElementById('titulo-tabela')?.scrollIntoView({behavior:'smooth',block:'start'}); }, 500);
                    }, 200);
                }
            } catch(e) { console.error('Erro ao aplicar inputs:', e); }
        }
    </script>

    <!-- === ABA 4: FAQ === -->
    <div id="tab-faq" class="tab-content hidden">
        <div style="max-width: 900px; margin: 40px auto; padding: 20px;">
            <div style="background: var(--surface); padding: 32px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div id="datas-ref-faq"></div>
                <h1 style="color: var(--primary); margin: 0 0 24px 0; font-size: 2rem;">
                    <i class="fa-solid fa-circle-question"></i> Perguntas Frequentes (FAQ)
                </h1>
                
                <div style="color: var(--text-main); line-height: 1.8;">


                    <h2 style="color: var(--primary); font-size: 1.3rem; margin-top: 32px; margin-bottom: 16px;">üìä Sobre o Simulador</h2>

                    <p><strong>O que √© este simulador?</strong></p>
                    <p>√â uma ferramenta gratuita que compara tarif√°rios de eletricidade em Portugal.</p>
                    
                    <h2 style="color: var(--primary); font-size: 1.3rem; margin-top: 32px; margin-bottom: 16px;">üîé Simula√ß√£o R√°pida (Aba 1)</h2>
                    <p><strong>Para quem √©?</strong></p>
                    <p>Para quem quer uma resposta r√°pida. Basta indicar quanto paga ou consome.</p>
                    
                    <h2 style="color: var(--primary); font-size: 1.3rem; margin-top: 32px; margin-bottom: 16px;">‚öôÔ∏è Simula√ß√£o Completa (Aba 2)</h2>
                    <p><strong>Para quem √©?</strong></p>
                    <p>Para quem quer controlo total sobre os par√¢metros.</p>
                    
                    <h2 style="color: var(--primary); font-size: 1.3rem; margin-top: 32px; margin-bottom: 16px;">üìä An√°lise Avan√ßada (Aba 3)</h2>
                    <p><strong>Para quem √©?</strong></p>
                    <p>Para quem tem o ficheiro de consumos da E-Redes. Aten√ß√£o que o ficheiro deve ser do tipo "Diagrama de Carga" e n√£o do tipo "Leituras". Esta an√°lise permite comparar tarif√°rios com base nos seus dados reais de consumo passados e com os valores OMIE passados. Se quiser com dados OMIE/OMIP Futuros, ter√° de colocar os consumos em Simula√ß√£o Completa</p>
                    
                </div>
            </div>

            <!-- FAQ original -->
            <article class="content-support">
              <h2>Como Usar o Simulador de Tarif√°rios</h2>
              <details class="faq-item">
                  <summary><strong>Guia R√°pido</strong></summary>
                  <div class="faq-content">
                      <p>Bem-vindo! Esta ferramenta ajuda-o a descobrir o tarif√°rio de eletricidade mais econ√≥mico para si. Siga os passos abaixo para come√ßar a poupar.</p>
              
                      <h3><strong>Passo 1: Escolha o seu Ponto de Partida</strong></h3>
                      <p>Primeiro, defina a sua <strong>Pot√™ncia Contratada</strong> e <strong>Op√ß√£o Hor√°ria</strong>. Depois, escolha como quer fornecer os seus dados de consumo.</p>
                      <ul>
                          <li>
                              <p><strong><em>üìä An√°lise Detalhada (com Ficheiro E-Redes) - Recomendado</em></strong></p>
                              <ol>
                                  <li><strong>Carregue o Ficheiro:</strong> Na sec√ß√£o "üìÇ Carregar Diagrama de Carga", envie o seu ficheiro <code>.xlsx</code> da E-Redes. Pode obt√™-lo em <a href="https://balcaodigital.e-redes.pt/consumptions/history" target="_blank" rel="noopener noreferrer">balcaodigital.e-redes.pt</a>.</li>
                                  <li><strong>Selecione o Per√≠odo:</strong> Escolha as datas que pretende analisar.</li>
                                  <li><strong>Vantagem:</strong> Esta √© a forma mais precisa. O simulador usa os seus consumos a cada 15 minutos para uma an√°lise exata, incluindo <strong>gr√°ficos detalhados</strong> e uma an√°lise da sua pot√™ncia contratada.</li>
                              </ol>
                          </li>
                          <li>
                              <p><strong><em>‚úçÔ∏è Estimativa R√°pida (Modo Manual)</em></strong></p>
                              <ol>
                                  <li><strong>Defina o Per√≠odo:</strong> Escolha o <strong>m√™s</strong> ou as <strong>datas</strong> para a simula√ß√£o.</li>
                                  <li><strong>Insira os Consumos:</strong> Preencha os seus consumos mensais estimados (kWh) nos campos que aparecem (ex: Vazio, Fora de Vazio).</li>
                                  <li><strong>Vantagem:</strong> Ideal para simula√ß√µes r√°pidas e previs√µes de custos sem precisar do ficheiro da E-Redes.</li>
                              </ol>
                          </li>
                      </ul>
              
                      <h3><strong>Passo 2: ‚öôÔ∏è Configure a Simula√ß√£o</strong></h3>
                      <p>Depois de inserir os seus consumos, pode refinar a simula√ß√£o.</p>
                      <ul>
                          <li>
                              <p><strong><em>‚òÄÔ∏è Simular Autoconsumo (Opcional - Modo Diagrama)</em></strong></p>
                              <ol>
                                  <li><strong>Configure o Sistema:</strong> Defina a pot√™ncia dos pain√©is (kWp), a localiza√ß√£o (distrito), inclina√ß√£o e orienta√ß√£o.</li>
                                  <li>Para uma simula√ß√£o de paineis fotovoltaicos mais detalhada e com baterias, consulte o <a href="https://www.tiagofelicia.pt/autoconsumo-tiagofelicia.html" target="_blank" rel="noopener noreferrer">Simulador de Autoconsumo</a>.</li>
                                  <li><strong>Selecione o Perfil:</strong> Ap√≥s a simula√ß√£o, na sec√ß√£o <strong>"‚öôÔ∏è Selecione os consumos a usar..."</strong>, escolha se os c√°lculos finais devem usar o seu consumo original ou o novo consumo j√° com o abate da produ√ß√£o solar.</li>
                              </ol>
                          </li>
                          <li>
                              <p><strong><em>‚ûï Op√ß√µes Adicionais</em></strong></p>
                              <p style="margin-top: 0;">No <em>expander</em> de "Op√ß√µes Adicionais", pode ativar benef√≠cios como a <strong>Tarifa Social</strong> ou incluir descontos espec√≠ficos (ACP, Continente).</p>
                          </li>
                      </ul>
              
                      <h3><strong>Passo 3: üèÜ Encontre a Melhor Tarifa</strong></h3>
                      <p>A tabela de resultados no final da p√°gina √© a sua ferramenta principal.</p>
                      <ul>
                          <li><strong>Ordenar por Custo:</strong> Clique no cabe√ßalho da coluna <strong>"Total (‚Ç¨)"</strong> para ordenar os tarif√°rios do mais barato para o mais caro.</li>
                          <li><strong>Explorar Detalhes:</strong> Passe o rato sobre os pre√ßos ou sobre o custo total para ver um <strong>resumo detalhado</strong> dos c√°lculos, incluindo todas as taxas e impostos.</li>
                          <li><strong>Filtrar Resultados:</strong> Use os filtros no topo da tabela para refinar a sua pesquisa por tipo de tarif√°rio (Fixo, Indexado), segmento, etc.</li>
                          <li><strong>O Seu P√≥dio:</strong> No final, a sec√ß√£o <strong>"üèÜ O Seu P√≥dio da Poupan√ßa"</strong> destaca as 3 op√ß√µes mais econ√≥micas para si.</li>
                          <li><strong>Comparar Op√ß√µes Hor√°rias:</strong> Ative a op√ß√£o "üî¨ <strong>Comparar custos entre diferentes Op√ß√µes Hor√°rias</strong>" para ver uma tabela especial que mostra quanto pagaria em cada tarif√°rio se tivesse um ciclo diferente (Simples, Bi-Hor√°rio, etc.).</li>
                      </ul>
              
                      <blockquote>
                          <p><strong>Dica Pro:</strong> Use a sec√ß√£o <strong>"üßæ O Meu Tarif√°rio"</strong> para introduzir os pre√ßos da sua fatura atual e compar√°-la diretamente com todas as ofertas do mercado. Assim, saber√° exatamente quanto pode poupar!</p>
                      </blockquote>
                  </div>
              </details>
            
            <h2>Perguntas Frequentes (FAQ)</h2>
            
            <details class="faq-item">
                <summary><strong>De onde v√™m os dados dos tarif√°rios e dos pre√ßos de mercado (OMIE)?</strong></summary>
                <div class="faq-content">
                    <p>Todos os dados dos tarif√°rios s√£o recolhidos a partir das informa√ß√µes p√∫blicas disponibilizadas pelos comercializadores nos seus websites. Os pre√ßos do mercado ib√©rico (OMIE) e os perfis de consumo da E-Redes s√£o obtidos de fontes oficiais para garantir a m√°xima precis√£o nos c√°lculos dos tarif√°rios indexados. Os dados s√£o atualizados regularmente para refletir as condi√ß√µes atuais do mercado.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Alguns tarif√°rios t√™m um custo de energia diferente do site institucional, porqu√™?</strong></summary>
                <div class="faq-content">
                    <p>Alguns comercializadores n√£o incluem o valor do financiamento da Tarifa Social de Eletricidade (TSE) no custo base da energia. Para que se possa comparar todos de forma igual, nesses casos, o custo da TSE √© adicionado ao custo base. Para confirmar, passe o rato por cima do valor da energia na tabela para ver a decomposi√ß√£o detalhada do pre√ßo.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>O meu tarif√°rio tem o mesmo nome, mas valores diferentes. Porqu√™?</strong></summary>
                <div class="faq-content">
                    <p>Muitos comercializadores alteram os valores nos seus tarif√°rios, mas mant√™m as mesmas denomina√ß√µes comerciais. Este simulador utiliza sempre os valores da vers√£o mais recente do tarif√°rio disponibilizada pelo comercializador.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>O simulador √© 100% preciso?</strong></summary>
                <div class="faq-content">
                    <p>O objetivo √© ser o mais preciso poss√≠vel. Para tarif√°rios <strong>fixos</strong>, a precis√£o √© muito elevada. Para tarif√°rios <strong>indexados</strong>, o custo final √© uma estimativa baseada em m√©dias e perfis de consumo (no caso de dados hist√≥ricos). A forma mais rigorosa de simula√ß√£o √© sempre atrav√©s do carregamento do seu <strong>diagrama de carga da E-Redes</strong>, pois utiliza o seu perfil de consumo real.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Porque √© que o modo "An√°lise Detalhada" (com ficheiro E-Redes) √© recomendado?</strong></summary>
                <div class="faq-content">
                    <p>Este modo utiliza o seu consumo real registado a cada 15 minutos. Isto permite um c√°lculo exato do custo para qualquer tipo de tarif√°rio, incluindo os <strong>indexados quarto-hor√°rios (din√¢micos)</strong>. Al√©m disso, s√≥ neste modo √© poss√≠vel fazer uma an√°lise precisa da sua <strong>pot√™ncia contratada</strong> e simular o impacto do <strong>autoconsumo</strong> com pain√©is solares fotovoltaicos.</p>
                </div>
            </details>
            
            <h3 class="faq-section-title">Dados e Per√≠odos</h3>
            
            <details class="faq-item">
                <summary><strong>Porque √© que a simula√ß√£o s√≥ est√° dispon√≠vel a partir de 01/01/2026?</strong></summary>
                <div class="faq-content">
                    <p>A simula√ß√£o est√° focada no ano de 2026 para garantir que os c√°lculos utilizam as Tarifas de Acesso √†s Redes (TAR) e outras taxas e impostos em vigor. O simulador ignora automaticamente quaisquer dados de consumo anteriores a esta data para garantir a relev√¢ncia dos resultados.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Qual a diferen√ßa entre escolher um M√™s e um Per√≠odo de Datas manual?</strong></summary>
                <div class="faq-content">
                    <ul>
                        <li><strong>Escolher um M√™s:</strong> √â a forma mais simples. O simulador seleciona automaticamente o primeiro e o √∫ltimo dia desse m√™s.</li>
                        <li><strong>Selecionar Datas:</strong> Oferece total flexibilidade para analisar um per√≠odo espec√≠fico (uma semana, uma quinzena, etc.).</li>
                    </ul>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Como s√£o tratados os fins de semana e feriados nos ciclos hor√°rios?</strong></summary>
                <div class="faq-content">
                    <p>O simulador utiliza os ciclos hor√°rios oficiais definidos pela ERSE. Nos <strong>Ciclos Semanais</strong>, os fins de semana t√™m um tratamento espec√≠fico (geralmente com mais horas em "Vazio"). Nos <strong>Ciclos Di√°rios</strong>, a contagem das horas √© a mesma para todos os dias. Os feriados n√£o t√™m regras especificas em BTN, sendo tratados como dias 'normais'. O simulador aplica estas regras automaticamente com base nos dados oficiais.</p>
                </div>
            </details>
            
            <h3 class="faq-section-title">Funcionalidades do Simulador</h3>
            
            <details class="faq-item">
                <summary><strong>O que significa a op√ß√£o "Comparar custos entre diferentes Op√ß√µes Hor√°rias"?</strong></summary>
                <div class="faq-content">
                    <p>Ao ativar esta op√ß√£o, o simulador recalcula o custo de cada tarif√°rio para diferentes ciclos hor√°rios (Simples, Bi-Hor√°rio, etc.), usando os seus consumos. √â √∫til para perceber se compensaria mudar de op√ß√£o hor√°ria.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Como funciona a sec√ß√£o "O Meu Tarif√°rio"?</strong></summary>
                <div class="faq-content">
                    <p>Esta sec√ß√£o permite-lhe introduzir os pre√ßos da sua fatura atual para comparar diretamente com todas as outras ofertas. √â fundamental verificar na sua fatura se os pre√ßos que insere j√° incluem as <strong>TAR (Tarifas de Acesso √†s Redes)</strong>.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Para que serve a sec√ß√£o "Comparar outro Tarif√°rio Personalizado?"</strong></summary>
                <div class="faq-content">
                    <p>Esta funcionalidade permite-lhe construir cen√°rios hipot√©ticos com os seus pr√≥prios pre√ßos. √â ideal para simular uma oferta que recebeu, testar o impacto de altera√ß√µes de pre√ßos ou perceber qual seria o custo se o seu comercializador oferecesse uma op√ß√£o hor√°ria diferente.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Como funciona a simula√ß√£o de Autoconsumo?</strong></summary>
                <div class="faq-content">
                    <p>Ao ativar esta op√ß√£o (no modo de diagrama de carga), o simulador estima a produ√ß√£o de um sistema fotovoltaico e subtrai-a do seu consumo. O resultado √© um novo "consumo da rede", que mostra a poupan√ßa real que o autoconsumo pode gerar.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>A simula√ß√£o de autoconsumo tem em conta os dias de chuva ou de sol?</strong></summary>
                <div class="faq-content">
                    <p>A simula√ß√£o utiliza <strong>perfis de produ√ß√£o solar m√©dios mensais</strong> para cada distrito, baseados em dados hist√≥ricos do PVGIS. A produ√ß√£o estimada para um dia representa um "dia m√©dio" para esse m√™s e regi√£o, j√° considerando a m√©dia de horas de sol e de nebulosidade.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Os valores OMIE para datas futuras s√£o reais?</strong></summary>
                <div class="faq-content">
                    <p>N√£o. Os valores para datas futuras baseiam-se nos pre√ßos do mercado de futuros (OMIP), que representam a expectativa do mercado. Servem como a melhor estimativa dispon√≠vel, mas n√£o s√£o uma garantia. A data de atualiza√ß√£o destes valores est√° indicada no final da p√°gina.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Como s√£o tratados descontos especiais como os do ACP ou Continente?</strong></summary>
                <div class="faq-content">
                    <p>Para a parceria <strong>Goldenergy/ACP</strong>, pode incluir a quota mensal no custo final. Para os tarif√°rios <strong>Galp/Continente</strong>, o simulador calcula o desconto em Cart√£o Continente e subtrai-o ao custo total. Pode gerir estas op√ß√µes em "Op√ß√µes Adicionais de Simula√ß√£o".</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>O que s√£o as colunas "Custo com o seu Perfil Real (‚Ç¨)" e "Custo com Perfil Padr√£o ERSE (‚Ç¨)"?</strong></summary>
                <div class="faq-content">
                    <p>Esta an√°lise compara o custo exato do seu consumo (Perfil Real) com o custo que teria se o seu consumo seguisse um perfil m√©dio definido pela ERSE (Perfil Padr√£o). Uma diferen√ßa negativa (a verde) significa que o seu padr√£o de consumo √© mais econ√≥mico que a m√©dia.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>O que est√° inclu√≠do no "Total (‚Ç¨)"?</strong></summary>
                <div class="faq-content">
                    <p>Sim, o "Total (‚Ç¨)" √© a sua fatura final estimada. Inclui o custo da energia e da pot√™ncia, todas as taxas (CAV, DGEG, IEC), o IVA aplicado corretamente e quaisquer descontos ou acr√©scimos. Lembre-se que pode ver a decomposi√ß√£o detalhada de todos estes custos <strong>passando o rato por cima do valor na coluna 'Total (‚Ç¨)'</strong>.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Como posso encontrar rapidamente o que procuro na tabela?</strong></summary>
                <div class="faq-content">
                    <p>A tabela √© interativa! Pode:</p>
                    <ul>
                        <li><strong>Ordenar:</strong> Clique no cabe√ßalho de qualquer coluna (ex: "Total (‚Ç¨)") para ordenar os resultados.</li>
                        <li><strong>Filtrar:</strong> Use os filtros no topo da tabela para refinar a sua pesquisa.</li>
                        <li><strong>Pesquisar:</strong> Use a pesquisa dentro das colunas "Comercializador" e "Tarif√°rio" para encontrar uma oferta espec√≠fica.</li>
                    </ul>
                </div>
            </details>
            
            <h3 class="faq-section-title">Termos e Conceitos</h3>
            
            <details class="faq-item">
                <summary><strong>O que √© um tarif√°rio indexado? √â uma boa op√ß√£o?</strong></summary>
                <div class="faq-content">
                    <p>Um tarif√°rio indexado tem um pre√ßo de energia que varia com o mercado grossista (OMIE). Este tipo de tarif√°rio pode oferecer uma poupan√ßa significativa quando os pre√ßos de mercado est√£o baixos, mas tamb√©m implica um risco maior se os pre√ßos subirem. Pode ser:</p>
                    <ul>
                        <li><strong>Indexado √† M√©dia:</strong> O pre√ßo baseia-se na m√©dia do per√≠odo de fatura√ß√£o (ex. mensal) dos pre√ßos OMIE para os per√≠odos hor√°rios (Vazio, Fora de Vazio, etc.).</li>
                        <li><strong>Indexado Quarto-Hor√°rio (Din√¢mico):</strong> O pre√ßo varia a cada hora (ou 15 minutos). S√£o ideais para quem consegue adaptar o consumo √†s horas mais baratas.</li>
                    </ul>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>O que s√£o as TAR (Tarifas de Acesso √†s Redes)?</strong></summary>
                <div class="faq-content">
                    <p>As TAR s√£o tarifas reguladas pela ERSE que pagam pelo uso das infraestruturas el√©tricas. Todos os consumidores as pagam, independentemente do comercializador. O simulador lida com os casos em que as TAR est√£o inclu√≠das ou separadas do pre√ßo da energia para garantir uma compara√ß√£o justa.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>O que significa "Perfil de Consumo" (ex: Perfil A, B, C)?</strong></summary>
                <div class="faq-content">
                    <p>A ERSE agrupa os consumidores em perfis (A, B, C) que representam um padr√£o de consumo m√©dio. No <strong>Modo Manual</strong>, o simulador usa estes perfis para estimar o custo dos tarif√°rios indexados. No <strong>Modo Diagrama</strong>, este perfil n√£o √© necess√°rio para o c√°lculo principal, pois s√£o usados os seus dados reais.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Porque √© que o simulador pergunta se a minha instala√ß√£o √© trif√°sica?</strong></summary>
                <div class="faq-content">
                    <p>O ficheiro da E-Redes regista a pot√™ncia total da sua casa em m√©dias de 15 minutos. Numa instala√ß√£o <strong>trif√°sica</strong>, √© poss√≠vel que uma √∫nica fase tenha um pico de consumo muito elevado num curto espa√ßo de tempo, fazendo o disjuntor disparar, mesmo que a pot√™ncia total <em>m√©dia</em> nesses 15 minutos n√£o ultrapasse o valor contratado. Assinalar que a sua instala√ß√£o √© trif√°sica permite que a an√°lise de pot√™ncia o alerte para este risco.</p>
                </div>
            </details>
            
            <details class="faq-item">
                <summary><strong>Como sei se a minha instala√ß√£o √© monof√°sica ou trif√°sica?</strong></summary>
                <div class="faq-content">
                    <p>Geralmente, instala√ß√µes dom√©sticas com pot√™ncias contratadas at√© 6.9 kVA s√£o monof√°sicas. Pot√™ncias superiores s√£o quase sempre trif√°sicas. Esta informa√ß√£o est√° dispon√≠vel na sua fatura, no seu contador ou no balc√£o digital da E-Redes.</p>
                </div>
            </details>
            
            </article>
        </div>
    </div>

</main>

<div id="footer-placeholder"></div>

<script>
// === Carregar menu.html e footer.html do site ===
(function() {
    fetch('menu.html')
        .then(r => r.ok ? r.text() : '')
        .then(html => { if(html) document.getElementById('menu-placeholder').innerHTML = html; })
        .catch(() => {});
    fetch('footer.html')
        .then(r => r.ok ? r.text() : '')
        .then(html => { if(html) document.getElementById('footer-placeholder').innerHTML = html; })
        .catch(() => {});
})();
</script>
<script src="script.js"></script>
</body>
</html>