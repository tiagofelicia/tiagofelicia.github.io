<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>F√≥rmulas de C√°lculo de Tarif√°rios Indexados ao OMIE | Tiago Fel√≠cia</title>
    <meta name="description" content="Consulte as f√≥rmulas de c√°lculo do pre√ßo de energia de tarif√°rios din√¢micos e de m√©dia indexados ao OMIE em Portugal." />

    <link rel="canonical" href="https://www.tiagofelicia.pt/formulas-tarifarios-indexados.html" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="F√≥rmulas dos Tarif√°rios Indexados ao OMIE" />
    <meta property="og:description" content="Como √© calculado o pre√ßo de energia em cada tarif√°rio indexado? Consulte as f√≥rmulas de cada comercializador." />
    <meta property="og:url" content="https://www.tiagofelicia.pt/formulas-tarifarios-indexados.html" />
    <meta property="og:image" content="https://www.tiagofelicia.pt/images/social-share.jpg" />
    <meta property="og:locale" content="pt_PT" />

    <link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg" />
    <link rel="shortcut icon" href="/images/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" />
    <link rel="manifest" href="/images/site.webmanifest" />
    <link rel="stylesheet" href="style.css" />

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Article",
      "headline": "F√≥rmulas de C√°lculo de Tarif√°rios Indexados ao OMIE",
      "description": "F√≥rmulas de c√°lculo do pre√ßo de energia de tarif√°rios din√¢micos e de m√©dia indexados ao OMIE em Portugal.",
      "author": { "@type": "Person", "name": "Tiago Fel√≠cia" },
      "publisher": {
        "@type": "Organization",
        "name": "Tiago Fel√≠cia Simuladores",
        "logo": { "@type": "ImageObject", "url": "https://www.tiagofelicia.pt/images/favicon-96x96.png" }
      }
    }
    </script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J4NWP00S4F"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-J4NWP00S4F');
    </script>

    <style>
        /* ‚îÄ‚îÄ Tags de tipo ‚îÄ‚îÄ */
        .tag {
            padding: 2px 7px;
            border-radius: 4px;
            font-size: 0.68rem;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
            letter-spacing: 0.05em;
            vertical-align: middle;
            white-space: nowrap;
        }
        .tag.qh    { background: #BDD7EE; color: #000; }
        .tag.media { background: #FFE699; color: #000; }

        /* ‚îÄ‚îÄ Cabe√ßalhos de grupo ‚îÄ‚îÄ */
        .grupo-header {
            margin: 28px 0 10px 0;
            padding: 8px 14px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 9px;
        }
        .grupo-header.qh    { background: #dce8f5; color: #1a3a5c; border-left: 4px solid #4D79BC; }
        .grupo-header.media { background: #fffbe6; color: #5a4000; border-left: 4px solid #BF8F00; }

        /* ‚îÄ‚îÄ Acorde√£o ‚îÄ‚îÄ */
        .tarifario-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 7px;
            overflow: hidden;
        }
        .tarifario-item summary {
            list-style: none;
            cursor: pointer;
            padding: 11px 16px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            gap: 10px;
            user-select: none;
        }
        .tarifario-item summary::-webkit-details-marker { display: none; }
        .tarifario-item.qh    summary { border-left: 4px solid #4D79BC; }
        .tarifario-item.media summary { border-left: 4px solid #BF8F00; }
        .tarifario-item.qh[open]    summary { background: #dce8f5; }
        .tarifario-item.media[open] summary { background: #fffbe6; }
        .tarifario-nome           { font-weight: bold; font-size: 0.97em; }
        .tarifario-sub            { font-size: 0.8em; color: #666; display: flex; gap: 8px; align-items: center; margin-top: 2px; }
        .seta { margin-left: auto; font-size: 0.8em; color: #999; transition: transform 0.2s; flex-shrink: 0; }
        .tarifario-item[open] .seta { transform: rotate(180deg); }

        /* ‚îÄ‚îÄ Corpo ‚îÄ‚îÄ */
        .tarifario-body { padding: 14px 18px; background: white; }
        .formula-meta {
            display: flex; flex-wrap: wrap; align-items: center;
            gap: 10px; margin-bottom: 12px; font-size: 0.84em;
        }
        .formula-meta a { color: #0d6efd; text-decoration: none; }
        .formula-meta a:hover { text-decoration: underline; }
        .formula-nota {
            background: #fff3cd; border: 1px solid #ffc107;
            border-radius: 4px; padding: 2px 9px; color: #856404; font-size: 0.82em;
        }
        .formula-expr {
            font-family: 'Georgia', serif;
            font-size: 1.03em;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 9px 13px;
            margin-bottom: 10px;
            display: block;
            line-height: 2;
        }
        .tarifario-item.qh    .formula-expr { border-left: 4px solid #4D79BC; }
        .tarifario-item.media .formula-expr { border-left: 4px solid #BF8F00; }
        .formula-legenda { font-size: 0.87em; color: #444; line-height: 2; }
        .formula-legenda span { display: inline-block; min-width: 90px; font-weight: bold; color: #222; }
        .formula-sem-dados { color: #888; font-style: italic; padding: 6px 0; font-size: 0.9em; }

        @media (max-width: 520px) {
            .formula-legenda span { display: block; min-width: unset; margin-bottom: 0; }
            .formula-legenda br { display: block; margin-bottom: 8px; }
            .formula-expr { font-size: 0.93em; padding: 8px 10px; }
            .tipo-box { min-width: unset; }
            .formula-meta { flex-direction: column; align-items: flex-start; gap: 5px; }
            .tarifario-nome { font-size: 0.93em; }
            .tarifario-sub { flex-wrap: wrap; }
        }

        /* ‚îÄ‚îÄ Estado carregamento ‚îÄ‚îÄ */
        #estado-carregamento { text-align: center; padding: 28px; color: #666; font-style: italic; }

        /* ‚îÄ‚îÄ Bot√µes expandir/recolher ‚îÄ‚îÄ */
        .grupo-controles {
            display: flex;
            gap: 6px;
            margin-left: auto;
        }
        .btn-grupo {
            font-size: 0.75em;
            padding: 2px 9px;
            border-radius: 4px;
            border: 1px solid currentColor;
            cursor: pointer;
            background: transparent;
            font-weight: 600;
            opacity: 0.7;
            transition: opacity 0.15s;
        }
        .btn-grupo:hover { opacity: 1; }
        .grupo-header.qh    .btn-grupo { color: #1a3a5c; }
        .grupo-header.media .btn-grupo { color: #5a4000; }

        /* ‚îÄ‚îÄ Caixas explicativas do topo ‚îÄ‚îÄ */
        .tipo-box {
            background: #f8f9fa; border-radius: 7px; padding: 11px 16px;
            flex: 1; min-width: 200px;
        }
        .tipo-box p { margin: 5px 0 0 0; font-size: 0.87em; }
        .tipo-box.qh    { border-left: 4px solid #4D79BC; }
        .tipo-box.media { border-left: 4px solid #BF8F00; }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <div class="header-title-container">
            <a href="index.html">
                <img src="images/Logo_Tiago_Felicia.png" alt="Log√≥tipo Tiago Fel√≠cia - P√°gina Inicial" class="logo">
            </a>
            <div class="brand-name">Tiago Fel√≠cia</div>
        </div>
        <p>Simuladores de tarif√°rios de Eletricidade, G√°s Natural e Autoconsumo</p>
    </div>
</header>

<div id="menu-placeholder">
    <nav style="display:none;">
        <a href="eletricidade-tiagofelicia.html">Eletricidade</a>
        <a href="gas-natural-tiagofelicia.html">G√°s</a>
        <a href="autoconsumo-tiagofelicia.html">Solar</a>
    </nav>
</div>

<main>
    <section class="content-section">
        <h1>F√≥rmulas de C√°lculo de Tarif√°rios Indexados ao OMIE</h1>

        <p>Os tarif√°rios indexados calculam o pre√ßo de energia com base no pre√ßo de mercado grossista (OMIE), acrescido de margens, perdas de rede e tarifas reguladas. Existem dois tipos:</p>

        <div style="display:flex; flex-wrap:wrap; gap:12px; margin: 14px 0 24px 0;">
            <div class="tipo-box qh">
                <span class="tag qh">Indexado Quarto-Hor√°rio</span>
                <p>O pre√ßo varia <strong>a cada 15 minutos</strong>, acompanhando o mercado OMIE em tempo real. Tamb√©m chamados <em>din√¢micos</em>. Permitem poupar consumindo nas horas mais baratas do dia.</p>
            </div>
            <div class="tipo-box media">
                <span class="tag media">Indexado M√©dia</span>
                <p>O pre√ßo baseia-se na <strong>m√©dia do OMIE</strong> para o per√≠odo de fatura√ß√£o. Menor variabilidade, mas sem benef√≠cio direto de deslocar consumo para horas baratas.</p>
            </div>
        </div>

        <p style="font-size:0.88em; color:#666; margin-bottom:22px;">
            Se encontrar algum erro nos valores das constantes (margens, fatores de adequa√ß√£o, etc.) ou na f√≥rmula, n√£o exite em contactar-me.
        </p>
        <p style="font-size:0.88em; color:#666; margin-bottom:22px;">
            As TAR s√£o publicadas pela <a href="https://www.erse.pt" target="_blank" rel="noopener">ERSE</a> e variam conforme a op√ß√£o hor√°ria e o ciclo, podem ser consultadas no site da ERSE ou em <a href="https://www.tiagofelicia.pt/tarifas-acesso-redes.html" target="_blank" rel="noopener">Tarifas de Acesso √†s Redes (TAR) 2026</a>.
        </p>

        <div id="estado-carregamento">‚è≥ A carregar constantes...</div>
        <div id="lista-tarifarios"></div>

        <div class="link-section" style="margin-top:28px;">
            <p>https://www.tiagofelicia.pt/formulas-tarifarios-indexados.html</p>
        </div>

        <article class="content-support" style="margin-top:28px;">
            <h2>O que s√£o as TAR e por que variam?</h2>
            <p>As Tarifas de Acesso √†s Redes (TAR) s√£o valores regulados pela ERSE que remuneram o transporte e distribui√ß√£o de eletricidade. O valor varia consoante o ciclo (Di√°rio ou Semanal) e a op√ß√£o hor√°ria: a op√ß√£o Simples tem uma tarifa √∫nica; a Bi-hor√°ria distingue Vazio e Fora de Vazio; e a Tri-hor√°ria divide-se em Vazio, Cheias e Ponta.</p>
        </article>
    </section>
</main>

<div id="footer-placeholder"></div>
<script src="script.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {

    let constantes = {};

    // ‚îÄ‚îÄ Parser do Constantes.csv (formato direto: constante,valor_unit√°rio) ‚îÄ‚îÄ
    function parseConstantesCSV(csv) {
        constantes = {};
        const linhas = csv.split('\n');
        for (let i = 1; i < linhas.length; i++) {
            const linha = linhas[i].trim();
            if (!linha) continue;
            const idx = linha.indexOf(',');
            if (idx === -1) continue;
            const chave = linha.substring(0, idx).trim().replace(/^"|"$/g, '');
            const valor = linha.substring(idx + 1).trim().replace(/^"|"$/g, '');
            if (chave && valor !== '') {
                const num = parseFloat(valor.replace(',', '.'));
                if (!isNaN(num)) constantes[chave] = num;
            }
        }
    }

    // ‚îÄ‚îÄ Helper: l√™ constante e formata ‚îÄ‚îÄ
    function c(key, unit = '‚Ç¨/kWh', decimais = 4) {
        const val = constantes[key];
        if (val === undefined || isNaN(val)) return `<em title="${key}">${key}</em>`;
        return `<strong>${val.toFixed(decimais).replace('.', ',')} ${unit}</strong>`;
    }

    // ‚îÄ‚îÄ Textos reutiliz√°veis ‚îÄ‚îÄ
    const TAR  = "Custo das Tarifas de Acesso √†s Redes - TAR (Energia) regulado pela ERSE (‚Ç¨/kWh), vari√°vel conforme a op√ß√£o hor√°ria.";
    const TAR_S   = "Tarifa de Acesso √†s Redes (ERSE): tarifa √∫nica, aplic√°vel apenas √† op√ß√£o Simples.";
    const TSE     = () => `Financiamento Tarifa Social de Eletricidade: ${c('Financiamento_TSE', '‚Ç¨/kWh', 7)}`;
    const PERDAS_QH  = "Perdas da rede fixadas pela ERSE, vari√°veis a cada quarto de hora (%).";
    const PERDAS_MED = "M√©dias para cada per√≠odo, dos coeficientes de perdas publicados pela ERSE (%).";

    // ‚îÄ‚îÄ Defini√ß√£o dos tarif√°rios ‚îÄ‚îÄ
    function definirTarifarios() {
        return [

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // INDEXADOS QUARTO-HOR√ÅRIOS (DIN√ÇMICOS)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            {
                tipo: 'qh',
                nome: "Alfa Power Index BTN",
                comercializador: "Alfa Energia",
                url: "https://www.alfaenergia.pt",
                notaLimitacao: null,
                expr: `Pre√ßo = (OMIE + CGS) √ó (1 + Perdas) + k + TAR + TSE`,
                legenda: [
                    ["OMIE", "Pre√ßo de energia por hora no mercado OMIE (‚Ç¨/kWh)"],
                    ["CGS", () => `Custos de gest√£o geral do sistema ‚Äî Na aus√™ncia de um valor fixo, utiliza-se o valor m√©dio de ERC do m√™s atual: ${c('Alfa_CGS', '‚Ç¨/kWh', 5)}. Valor atualizado semanalmente.`],
                    ["Perdas", PERDAS_QH],
                    ["k", () => `Gastos operacionais Alfa Energia: ${c('Alfa_K', '‚Ç¨/kWh', 3)}`],
                    ["TAR", TAR],
                    ["TSE", TSE],
                ]
            },
            {
                tipo: 'qh',
                nome: "Coop√©rnico Base",
                comercializador: "Coop√©rnico",
                url: "https://www.coopernico.org",
                notaLimitacao: null,
                expr: `P<sub>Energia</sub> = (OMIE + k) √ó (1 + FP) + (CS + CR) √ó (1 + FP) + TAR + TSE`,
                legenda: [
                    ["OMIE", "Pre√ßo de mercado grossista para cada quarto de hora (‚Ç¨/kWh)"],
                    ["k", () => `Margem Coop√©rnico: ${c('Coop_K', '‚Ç¨/kWh', 3)}`],
                    ["FP", "Perfil de Perda (vari√°vel)"],
                    ["CS + CR", () => `Custos de Sistema + Regula√ß√£o ‚Äî Na aus√™ncia de um valor fixo, utiliza-se o valor m√©dio de ERC do m√™s atual: ${c('Coop_CS_CR', '‚Ç¨/kWh', 5)}. Valor atualizado semanalmente.`],
                    ["TAR", TAR],
                    ["TSE", TSE],
                ]
            },
            {
                tipo: 'qh',
                nome: "Coop√©rnico GO",
                comercializador: "Coop√©rnico",
                url: "https://www.coopernico.org",
                notaLimitacao: null,
                expr: `P<sub>Energia</sub> = (OMIE + k) √ó (1 + FP) + (CS + CR) √ó (1 + FP) + GO + TAR + TSE`,
                legenda: [
                    ["OMIE", "Pre√ßo de mercado grossista para cada quarto de hora (‚Ç¨/kWh)"],
                    ["k", () => `Margem Coop√©rnico: ${c('Coop_K', '‚Ç¨/kWh', 3)}`],
                    ["GO", () => `Garantias de Origem: ${c('Coop_GO', '‚Ç¨/kWh', 3)}`],
                    ["FP", "Perfil de Perda (vari√°vel)"],
                    ["CS + CR", () => `Custos de Sistema + Regula√ß√£o ‚Äî Na aus√™ncia de um valor fixo, utiliza-se o valor m√©dio de ERC do m√™s atual: ${c('Coop_CS_CR', '‚Ç¨/kWh', 5)}. Valor atualizado semanalmente.`],
                    ["TAR", TAR],
                    ["TSE", TSE],
                ]
            },
            {
                tipo: 'qh',
                nome: "EDP Indexada Hor√°ria",
                comercializador: "EDP Comercial",
                url: "https://www.edp.pt/particulares/energia/gas-eletricidade-oferta-indexada/",
                notaLimitacao: null,
                expr: `P<sub>i</sub> = Œ£<sub>i</sub> [(P<sub>OMIE i</sub> √ó (1 + Perdas<sub>i</sub>) √ó K<sub>1</sub> + K<sub>2</sub> + TAR<sub>Energia i</sub>]`,
                legenda: [
                    ["OMIE", "Pre√ßo de mercado grossista para cada quarto de hora (‚Ç¨/kWh)"],
                    ["Perdas<sub>i</sub>", "Coeficiente de ajustamento para perdas na rede (vari√°vel)"],
                    ["K<sub>1</sub>", () => c('EDP_H_K1', '(adimensional)', 2)],
                    ["K<sub>2</sub>", () => c('EDP_H_K2')],
                    ["TAR", TAR],
                ]
            },
            {
                tipo: 'qh',
                nome: "EZU Tarifa Indexada",
                comercializador: "EZU Energia",
                url: "https://ezu.pt/tarifas",
                notaLimitacao: null,
                expr: `P<sub>p</sub> = Œ£ (OMIE<sub>h</sub> + CGS<sub>h</sub> + k<sub>p</sub>) √ó (1 + Perda<sub>ERSE</sub>) + TAR + TSE`,
                legenda: [
                    ["OMIE", "Pre√ßo de energia por hora no mercado OMIE (‚Ç¨/kWh)"],
                    ["CGS", () => `Custos de gest√£o geral do sistema ‚Äî Na aus√™ncia de um valor fixo, utiliza-se o valor m√©dio de ERC do m√™s atual: ${c('EZU_CGS', '‚Ç¨/kWh', 5)}. Valor atualizado semanalmente.`],
                    ["Perda<sub>ERSE</sub>", PERDAS_QH],
                    ["k", () => { const mwh = constantes['EZU_K'] !== undefined ? ` (${(constantes['EZU_K']*1000).toFixed(2).replace('.',',')} ‚Ç¨/MWh)` : ''; return `Gastos operacionais EZU Energia: ${c('EZU_K')}${mwh}`; }],
                    ["TAR", TAR],
                    ["TSE", TSE],
                ]
            },
            {
                tipo: 'qh',
                nome: "G9 Smart Dynamic",
                comercializador: "G9 Energia",
                url: "https://g9.pt/energia/",
                notaLimitacao: null,
                expr: `PE<sub>(15m)</sub> = OMIE<sub>(15m)</sub> √ó F<sub>adeq</sub> √ó (1 + Perdas<sub>(15m)</sub>) + GGS + AC + TAR`,
                legenda: [
                    ["OMIE", "Pre√ßo de mercado grossista para cada quarto de hora (‚Ç¨/kWh)"],
                    ["F<sub>adeq</sub>", () => `Fator de adequa√ß√£o: ${c('G9_FA', '(adimensional)', 2)}`],
                    ["Perdas", PERDAS_QH],
                    ["GGS", () => `Garantia de Gest√£o e Servi√ßo: ${c('G9_CGS')}`],
                    ["AC", () => `Ajuste Comercial: ${c('G9_AC')}`],
                    ["TAR", TAR],
                ]
            },
            {
                tipo: 'qh',
                nome: "Galp Plano Din√¢mico",
                comercializador: "Galp",
                url: "https://www.galp.com/pt/casa/planos-eletricidade-e-gas/eletricidade-indexada",
                notaLimitacao: null,
                expr: `Pre√ßo = ENERGIA<sub>GALP</sub> + TAR<sub>ENERGIA</sub><br>ENERGIA<sub>GALP</sub> = Œ£[(PMi + Ci) √ó (1 + Li)]`,
                legenda: [
                    ["PMi", "Pre√ßo hor√°rio OMIE Portugal (‚Ç¨/kWh), vigente em cada 15 minutos"],
                    ["Ci", () => `Componente de Comercializador (margem, desvios, garantias de origem, etc.): ${c('Galp_Ci')}`],
                    ["Li", "Perdas em percentagem para cada 15 minutos, publicadas pela ERSE (%)"],
                    ["TAR<sub>ENERGIA</sub>", TAR],
                ]
            },
            {
                tipo: 'qh',
                nome: "Iberdrola - Simples Indexado Din√¢mico",
                comercializador: "Iberdrola",
                url: "https://www.iberdrola.pt/casa/energia/plano-indexado-simples-dinamico",
                notaLimitacao: "Dispon√≠vel apenas na op√ß√£o tarif√°ria Simples.",
                expr: `Pre√ßo Energia<sub>IBERDROLA</sub> = POMIE<sub>P</sub> √ó (1 + Perdas) + Q + Banda mFRR + TAR + TSE`,
                legenda: [
                    ["POMIE<sub>P</sub>", "Custo da eletricidade no mercado ib√©rico em Portugal (‚Ç¨/kWh), em intervalos de 15 minutos"],
                    ["Perdas", PERDAS_QH],
                    ["Q", () => `Custo de opera√ß√£o e gest√£o do sistema + componente de comercializa√ß√£o da Iberdrola: ${c('Iberdrola_Dinamico_Q', '‚Ç¨/kWh', 3)}`],
                    ["Banda mFRR", () => `Sobrecusto associado ao leil√£o da Banda de Reserva de Restabelecimento de Frequ√™ncia com Ativa√ß√£o Manual: ${c('Iberdrola_mFRR', '‚Ç¨/kWh', 5)}`],
                    ["TAR", TAR_S],
                    ["TSE", TSE],
                ]
            },
            {
                tipo: 'qh',
                nome: "MeoEnergia Tarifa Vari√°vel",
                comercializador: "MeoEnergia",
                url: "https://www.meoenergia.pt/eletricidade/tarifa-dinamica",
                notaLimitacao: null,
                expr: `P<sub>ENERGIA</sub> = (P<sub>OMIE</sub> + K) √ó (1 + FP) + TAR`,
                legenda: [
                    ["P<sub>OMIE</sub>", "Custo da eletricidade no mercado ib√©rico em Portugal (‚Ç¨/kWh), em intervalos de 15 minutos"],
                    ["K", () => `Inclui Gest√£o do sistema, desvios e margem: ${c('Meo_K')}`],
                    ["FP", "Fator de Perdas ‚Äî ajustamento para perdas na rede de Baixa Tens√£o (vari√°vel, ERSE)"],
                    ["TAR", TAR],
                ]
            },
            {
                tipo: 'qh',
                nome: "Plenitude - Tend√™ncia",
                comercializador: "Plenitude",
                url: "https://eniplenitude.pt/eletricidade/tendencia/",
                notaLimitacao: "Dispon√≠vel apenas na op√ß√£o tarif√°ria Simples.",
                expr: `(OMIE + CGS + GDOs) √ó Perdas + Fee + TAR`,
                legenda: [
                    ["OMIE", "Pre√ßo do mercado di√°rio OMIE (‚Ç¨/kWh)"],
                    ["CGS", () => `Custos de gest√£o do sistema da REN + custos de desvio ‚Äî Na aus√™ncia de um valor fixo, utiliza-se o valor m√©dio de ERC do m√™s atual: ${c('Plenitude_CGS', '‚Ç¨/kWh', 5)}. Valor atualizado semanalmente.`],
                    ["GDOs", () => `Custo das garantias de origem: ${c('Plenitude_GDOs', '‚Ç¨/kWh', 5)}`],
                    ["Perdas", "Perfil de perdas da rede de distribui√ß√£o, com base no perfil de perdas regulado pela ERSE."],
                    ["Fee", () => `Margem comercial da Plenitude: ${c('Plenitude_Fee', '‚Ç¨/kWh', 3)}`],
                    ["TAR", TAR_S],
                ]
            },
            {
                tipo: 'qh',
                nome: "Repsol Leve Sem Mais",
                comercializador: "Repsol",
                url: "https://www.repsol.pt/particulares/casa/eletricidade-gas/planos-eletricidade-e-gas/plano-leve-sem-mais/",
                notaLimitacao: null,
                expr: `Pre√ßo = Œ£ (P<sub>OMIE</sub> √ó (1 + Perdas) √ó FA + QTarifa + FinTS) + TAR`,
                legenda: [
                    ["P<sub>OMIE 15min</sub>", "Pre√ßo marginal no sistema Portugu√™s por quarto de hora, publicado pelo OMIE (‚Ç¨/MWh)"],
                    ["Perdas<sub>15min</sub>", "Coeficientes de perdas por quarto de hora, conforme legisla√ß√£o em vigor (%)"],
                    ["FA", () => `Fator de adequa√ß√£o: ${c('Repsol_FA', '(adimensional)', 2)}`],
                    ["QTarifa", () => `Servi√ßos Complementares, Encargos, Desvios e Margem Repsol: ${c('Repsol_Q_Tarifa', '‚Ç¨/kWh', 5)}`],
                    ["FinTS", () => `Financiamento Tarifa Social de Eletricidade: ${c('Financiamento_TSE', '‚Ç¨/kWh', 7)}`],
                    ["TAR", TAR],
                ]
            },

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // INDEXADOS M√âDIA
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            {
                tipo: 'media',
                nome: "EDP - Eletricidade Indexada M√©dia",
                comercializador: "EDP Comercial",
                url: "https://www.edp.pt/particulares/energia/gas-eletricidade-oferta-indexada/",
                notaLimitacao: null,
                expr: `P<sub>i</sub> = Œ£<sub>i</sub> [(P<sub>OMIE i</sub> √ó (1 + Perdas<sub>i</sub>) √ó K<sub>1</sub> + K<sub>2</sub> + TAR<sub>Energia i</sub>]`,
                legenda: [
                    ["OMIE", "Pre√ßo m√©dio do mercado grossista para o per√≠odo de fatura√ß√£o (‚Ç¨/kWh)"],
                    ["Perdas<sub>i</sub>", "Coeficiente de ajustamento para perdas na rede (vari√°vel)"],
                    ["K<sub>1</sub>", () => c('EDP_M_K1', '(adimensional)', 2)],
                    ["K<sub>2</sub>", () => c('EDP_M_K2')],
                    ["TAR", TAR],
                ]
            },
            {
                tipo: 'media',
                nome: "Endesa - Tarifa Indexada",
                comercializador: "Endesa",
                url: "https://www.endesa.pt/particulares/planos/luz/tarifa-indexada",
                notaLimitacao: null,
                expr: `Pre√ßo = A + B`,
                legenda: [
                    ["A", () => `Outros custos: Pre√ßo de tarifas de acesso, custos de servi√ßo de sistemas estimados, perdas estimadas e margem do comercializador. Simples: ${c('Endesa_A_S', '‚Ç¨/kWh', 5)}, Fora Vazio: ${c('Endesa_A_FV', '‚Ç¨/kWh', 5)},Vazio: ${c('Endesa_A_V', '‚Ç¨/kWh', 5)}`],
                    ["B", "Custos de Energia Indexada: Pre√ßo m√©dio di√°rio do OMIE em Portugal para o per√≠odo de fatura√ß√£o (‚Ç¨/kWh)"],
                ]
            },
            {
                tipo: 'media',
                nome: "G9 - Smart Index",
                comercializador: "G9 Energia",
                url: "https://g9.pt/energia/",
                notaLimitacao: null,
                expr: `PE = OMIE √ó F<sub>adeq</sub> √ó (1 + Perdas) + GGS + AC + TAR`,
                legenda: [
                    ["OMIE", "Pre√ßo m√©dio do mercado grossista para o per√≠odo de fatura√ß√£o (‚Ç¨/kWh)"],
                    ["F<sub>adeq</sub>", () => `Fator de adequa√ß√£o: ${c('G9_FA', '(adimensional)', 2)}`],
                    ["Perdas", PERDAS_MED],
                    ["GGS", () => `Garantia de Gest√£o e Servi√ßo: ${c('G9_CGS')}`],
                    ["AC", () => `Ajuste Comercial: ${c('G9_AC')}`],
                    ["TAR", TAR],
                ]
            },
            {
                tipo: 'media',
                nome: "Goldenergy - Tarif√°rio Indexado 100%",
                comercializador: "Goldenergy",
                url: "https://www.goldenergy.pt",
                notaLimitacao: null,
                expr: `CE = (P<sub>OMIE</sub> √ó (1 + Perdas) + QTarifa + CG) + TEPA<sub>i</sub>`,
                legenda: [
                    ["CE", "Custo da energia (‚Ç¨)"],
                    ["P<sub>OMIE</sub>", "Valor m√©dio do per√≠odo de fatura√ß√£o, do mercado di√°rio publicado pelo Operador do Mercado Ib√©rico de Energia (‚Ç¨/kWh)"],
                    ["Perdas", "Coeficientes de perdas correspondentes ao consumo (%)"],
                    ["QTarifa", () => `Servi√ßos complementares, encargos desvios, garantias de origem e riscos: ${c('GE_Q_Tarifa', '‚Ç¨/kWh', 5)}`],
                    ["CG", () => `Custo de gest√£o por cada kWh consumido: ${c('GE_CG', '‚Ç¨/kWh', 3)}`],
                    ["TEPA<sub>i</sub>", "Custo de acesso √†s redes (Energia) regulado pela ERSE (‚Ç¨/kWh)"],
                ]
            },
            {
                tipo: 'media',
                nome: "Ibelectra - Solu√ß√£o Amigo",
                comercializador: "Ibelectra",
                url: "https://www.ibelectra.pt",
                notaLimitacao: null,
                expr: `Pre√ßo = (PM<sub>OMIE</sub> + CS) √ó (1 + Perd) + K + TAR + TSE`,
                legenda: [
                    ["PM<sub>OMIE</sub>", "Pre√ßo m√©dio do mercado OMIE para o per√≠odo de fatura√ß√£o (‚Ç¨/kWh)"],
                    ["CS", () => `Custos de Sistema (gest√£o, desvios): ${c('Ibelectra_CS', '‚Ç¨/kWh', 5)}`],
                    ["Perd", PERDAS_MED],
                    ["K", () => `Margem comercial Ibelectra: ${c('Ibelectra_K_a', '‚Ç¨/kWh', 4)}`],
                    ["TAR", TAR],
                    ["TSE", TSE],
                ]
            },
            {
                tipo: 'media',
                nome: "Ibelectra - Solu√ß√£o Fam√≠lia",
                comercializador: "Ibelectra",
                url: "https://www.ibelectra.pt",
                notaLimitacao: null,
                expr: `Pre√ßo = (PM<sub>OMIE</sub> + CS) √ó (1 + Perd) + K + TAR + TSE`,
                legenda: [
                    ["PM<sub>OMIE</sub>", "Pre√ßo m√©dio do mercado OMIE para o per√≠odo de fatura√ß√£o (‚Ç¨/kWh)"],
                    ["CS", () => `Custos de Sistema (gest√£o, desvios): ${c('Ibelectra_CS', '‚Ç¨/kWh', 5)}`],
                    ["Perd", PERDAS_MED],
                    ["K", () => `Margem comercial Ibelectra: ${c('Ibelectra_K', '‚Ç¨/kWh', 4)}`],
                    ["TAR", TAR],
                    ["TSE", TSE],
                ]
            },
            {
                tipo: 'media',
                nome: "Iberdrola - Simples Indexado",
                comercializador: "Iberdrola",
                url: "https://www.iberdrola.pt/casa/energia/plano-indexado-simples",
                notaLimitacao: "Dispon√≠vel apenas na op√ß√£o tarif√°ria Simples.",
                expr: `Pre√ßo Energia<sub>IBERDROLA</sub> = POMIE<sub>P</sub> √ó (1 + Perdas) + Q + Banda mFRR + TAR + TSE`,
                legenda: [
                    ["POMIE<sub>P</sub>", "Pre√ßo m√©dio do mercado ib√©rico em Portugal para o per√≠odo de fatura√ß√£o (‚Ç¨/kWh)"],
                    ["Perdas", PERDAS_MED],
                    ["Q", () => `Custo de opera√ß√£o e gest√£o do sistema + componente de comercializa√ß√£o da Iberdrola: ${c('Iberdrola_Media_Q', '‚Ç¨/kWh', 3)}`],
                    ["Banda mFRR", () => `Sobrecusto associado ao leil√£o da Banda de Reserva de Restabelecimento de Frequ√™ncia com Ativa√ß√£o Manual: ${c('Iberdrola_mFRR', '‚Ç¨/kWh', 5)}`],
                    ["TAR", TAR_S],
                    ["TSE", TSE],
                ]
            },
            {
                tipo: 'media',
                nome: "LUZiG√ÅS - Super Lig Index",
                comercializador: "LUZiG√ÅS",
                url: "https://www.luzigas.pt/luzifix-campanhas-novos-clientes/",
                notaLimitacao: null,
                expr: `PE = (P<sub>OMIE</sub> + K + CGS) √ó (1 + Perdas)`,
                legenda: [
                    ["P<sub>OMIE</sub>", "Custo da energia hor√°ria no Mercado Di√°rio OMIE ‚Äî Portugal (‚Ç¨/kWh)"],
                    ["K", () => `Margem fixa LUZiG√ÅS: ${c('Luzigas_K', '‚Ç¨/kWh', 3)}`],
                    ["CGS", () => `Custos do Gestor do Sistema ‚Äî Na aus√™ncia de um valor fixo, utiliza-se o valor m√©dio de ERC do m√™s atual: ${c('Luzigas_CGS', '‚Ç¨/kWh', 5)}`],
                    ["Perdas", PERDAS_MED],
                ]
            },
            {
                tipo: 'media',
                nome: "Luzboa - BTN SPOTDEF",
                comercializador: "Luzboa",
                url: "https://www.luzboa.pt/tarifas/domestico/1",
                notaLimitacao: null,
                expr: `P<sub>p</sub> = (OMIE<sub>h</sub> + CGS<sub>h</sub>) √ó (1 + Perdas<sub>ERSE</sub>) √ó FA + K<sub>p</sub>`,
                legenda: [
                    ["P<sub>p</sub>", "Pre√ßo de energia ativa a pagar (‚Ç¨/kWh)"],
                    ["OMIE<sub>h</sub>", "Pre√ßo hor√°rio m√©dio mensal, no per√≠odo faturado, no mercado OMIE (‚Ç¨/kWh)"],
                    ["CGS<sub>h</sub>", () => `Custos de opera√ß√£o e gest√£o do sistema ‚Äî Na aus√™ncia de um valor fixo, utiliza-se o valor m√©dio de ERC do m√™s atual: ${c('Luzboa_CGS', '‚Ç¨/kWh', 5)}`],
                    ["Perdas<sub>ERSE</sub>", "Perdas da rede fixadas pela ERSE ‚Äî Entidade Reguladora dos Servi√ßos Energ√©ticos (%)"],
                    ["FA", () => `Fator de adequa√ß√£o: ${c('Luzboa_FA', '(adimensional)', 2)}`],
                    ["K<sub>p</sub>", () => `Gastos operacionais da Luzboa: ${c('Luzboa_Kp', '‚Ç¨/kWh', 3)}`],
                ]
            },
        ];
    }

    // ‚îÄ‚îÄ Slug para √¢ncoras ‚îÄ‚îÄ
    function slug(nome) {
        return nome.toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '');
    }

    // ‚îÄ‚îÄ Renderizar ‚îÄ‚îÄ
    function renderizar() {
        const tarifarios = definirTarifarios();
        const lista = document.getElementById('lista-tarifarios');
        let html = '';

        [
            { tipo: 'qh',    label: 'Indexados Quarto-Hor√°rios (Din√¢micos)' },
            { tipo: 'media', label: 'Indexados M√©dia' },
        ].forEach(({ tipo, label }) => {

            const grupoId = `grupo-${tipo}`;
            html += `<div class="grupo-header ${tipo}" id="${grupoId}">
                        <span class="tag ${tipo}">${tipo === 'qh' ? 'Quarto-Hor√°rio' : 'M√©dia'}</span>
                        ${label}
                        <div class="grupo-controles">
                            <button class="btn-grupo" onclick="expandirGrupo('${grupoId}', true)">Expandir todos</button>
                            <button class="btn-grupo" onclick="expandirGrupo('${grupoId}', false)">Recolher todos</button>
                        </div>
                     </div>`;

            tarifarios.filter(t => t.tipo === tipo).forEach(t => {
                const id = slug(t.nome);
                const legendaHTML = t.legenda.map(([sigla, desc]) => {
                    const texto = typeof desc === 'function' ? desc() : desc;
                    return `<span>${sigla}</span> ‚Äî ${texto}`;
                }).join('<br>');

                const bodyHTML = (!t.expr)
                    ? `<div class="formula-sem-dados">F√≥rmula ainda n√£o dispon√≠vel.</div>`
                    : `<div class="formula-expr">${t.expr}</div>
                       ${legendaHTML ? `<div class="formula-legenda">${legendaHTML}</div>` : ''}`;

                html += `
                <details class="tarifario-item ${tipo}" id="${id}" data-grupo="${grupoId}">
                    <summary>
                        <div>
                            <div class="tarifario-nome">${t.nome}</div>
                            <div class="tarifario-sub">
                                <span>${t.comercializador}</span>
                                <span class="tag ${tipo}">${tipo === 'qh' ? 'Quarto-Hor√°rio' : 'M√©dia'}</span>
                            </div>
                        </div>
                        <span class="seta">‚ñº</span>
                    </summary>
                    <div class="tarifario-body">
                        <div class="formula-meta">
                            <span>üè¢ <strong>${t.comercializador}</strong></span>
                            <a href="${t.url}" target="_blank" rel="noopener">üîó ${t.url.replace('https://','')}</a>
                            ${t.notaLimitacao ? `<span class="formula-nota">‚ö†Ô∏è ${t.notaLimitacao}</span>` : ''}
                        </div>
                        ${bodyHTML}
                    </div>
                </details>`;
            });
        });

        lista.innerHTML = html;
        document.getElementById('estado-carregamento').style.display = 'none';

        // Abrir acorde√£o se a URL tiver hash correspondente
        if (window.location.hash) {
            const alvo = document.querySelector(window.location.hash);
            if (alvo && alvo.tagName === 'DETAILS') {
                alvo.open = true;
                setTimeout(() => alvo.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
            }
        }
    }

    // ‚îÄ‚îÄ Expandir/recolher grupo (acess√≠vel globalmente) ‚îÄ‚îÄ
    window.expandirGrupo = function(grupoId, abrir) {
        document.querySelectorAll(`[data-grupo="${grupoId}"]`).forEach(d => d.open = abrir);
    };

    // ‚îÄ‚îÄ Carregar CSV e iniciar ‚îÄ‚îÄ
    const CSV_URL = "https://huggingface.co/spaces/tiagofelicia/simulador-tarifarios-eletricidade/resolve/main/data/csv/Constantes.csv"
                  + "?cache_bust=" + new Date().getTime();

    fetch(CSV_URL)
        .then(res => {
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.text();
        })
        .then(csv => {
            parseConstantesCSV(csv);
            renderizar();
        })
        .catch(err => {
            console.warn("N√£o foi poss√≠vel carregar constantes:", err);
            document.getElementById('estado-carregamento').textContent =
                '‚ö†Ô∏è N√£o foi poss√≠vel carregar os valores das constantes. As f√≥rmulas s√£o apresentadas sem valores num√©ricos.';
            renderizar();
        });
});
</script>
</body>
</html>
